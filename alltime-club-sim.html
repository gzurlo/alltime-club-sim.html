<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ALL-TIME CLUB SIMULATOR</title>
  <style>
    :root {
      color-scheme: dark;
      /* Stadium / pitch themed */
      --bg: #020712;
      --panel: #050a16;
      --accent: #00ff87;   /* neon pitch green */
      --accent2: #00b4ff;  /* sky blue */
      --accent3: #ff3366;  /* scoreboard red */
      --text: #f5f7ff;
      --sub: #8c92ac;
      --border-subtle: #1b2030;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 20px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        Roboto, "Helvetica Neue", Arial, sans-serif;
      background:
        radial-gradient(1200px 800px at 20% -10%, rgba(0, 255, 135, 0.06), transparent),
        radial-gradient(1000px 700px at 120% 20%, rgba(0, 180, 255, 0.06), transparent),
        var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    .app-shell {
      max-width: 1180px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      margin-bottom: 18px;
    }

    header .title {
      font-size: 30px;
      font-weight: 900;
      color: var(--accent);
      letter-spacing: 0.08em;
    }

    header .subtitle {
      font-size: 12px;
      color: var(--sub);
      margin-top: 4px;
    }

    .card {
      background: var(--panel);
      border: 1px solid rgba(0, 255, 135, 0.15);
      border-radius: 12px;
      padding: 16px;
    }

    .card + .card {
      margin-top: 10px;
    }

    .btn,
    .btn-ghost,
    .tab-btn {
      border-radius: 10px;
      padding: 8px 12px;
      font-weight: 700;
      font-size: 0.85rem;
      cursor: pointer;
      border: 1px solid transparent;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: transparent;
    }

    .btn {
      background: var(--accent);
      border-color: var(--accent);
      color: #000;
    }

    .btn-ghost {
      background: transparent;
      color: var(--accent);
      border-color: rgba(0, 255, 135, 0.5);
    }

    .btn-danger {
      background: var(--accent3);
      border-color: var(--accent3);
      color: #fff;
    }

    .btn:hover,
    .btn-ghost:hover,
    .tab-btn:hover {
      filter: brightness(1.08);
    }

    .tab-nav {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .tab-btn {
      border-radius: 999px;
      padding: 8px 12px;
      border-color: rgba(0, 255, 135, 0.4);
      color: var(--accent);
    }

    .tab-btn.tab-active {
      background: var(--accent);
      color: #000;
      border-color: var(--accent);
    }

    .tab-toggle {
      margin-left: auto;
      display: flex;
      gap: 8px;
    }

    input[type="text"],
    input[type="number"],
    select {
      background: #050817;
      color: var(--text);
      border-radius: 8px;
      border: 1px solid rgba(0, 255, 135, 0.4);
      padding: 8px;
      font-size: 0.85rem;
      width: 100%;
      outline: none;
    }

    input[type="text"]:focus,
    select:focus {
      border-color: var(--accent2);
      box-shadow: 0 0 0 1px rgba(0, 180, 255, 0.4);
    }

    input[type="range"] {
      width: 100%;
    }

    .controls-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 10px;
      align-items: flex-end;
    }

    .label-sm {
      font-size: 12px;
      color: var(--sub);
      margin-bottom: 4px;
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 700;
      background: var(--accent);
      color: #000;
    }

    .badge-cyan {
      background: var(--accent2);
      color: #000;
    }

    .badge-red {
      background: var(--accent3);
      color: #fff;
    }

    .tab-panel {
      display: none;
    }

    .tab-panel.active {
      display: block;
    }

    /* Groups */
    .groups-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
      gap: 12px;
    }

    .group-title {
      font-weight: 800;
      margin-bottom: 8px;
      color: var(--accent2);
    }

    .group-list {
      margin: 0;
      padding-left: 18px;
      list-style: decimal;
    }

    .group-list li {
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
    }

    .star-btn {
      border-radius: 999px;
      border: 1px solid rgba(0, 255, 135, 0.5);
      background: transparent;
      color: var(--accent);
      padding: 2px 8px;
      font-size: 11px;
      cursor: pointer;
    }

    .star-btn.active {
      background: var(--accent);
      color: #000;
    }

    /* Matches */
    .matches-grid {
      display: grid;
      gap: 12px;
    }

    .round-card {
      border-radius: 12px;
    }

    .round-title {
      font-weight: 800;
      margin-bottom: 8px;
      color: var(--accent2);
    }

    .match-list {
      display: grid;
      gap: 8px;
    }

    .match-card {
      border-radius: 10px;
      border: 1px solid rgba(0, 255, 135, 0.2);
      background: #050817;
      padding: 10px;
    }

    .match-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
      font-weight: 700;
    }

    .match-summary {
      color: var(--sub);
      font-size: 0.85rem;
      margin-top: 4px;
    }

    .star-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 6px;
      margin-top: 6px;
    }

    .star-chip {
      background: #020914;
      border-radius: 8px;
      border: 1px solid rgba(0, 255, 135, 0.18);
      padding: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.8rem;
    }

    /* Awards */
    .awards-grid {
      display: grid;
      gap: 12px;
    }

    .award-section-title {
      font-weight: 800;
      margin-bottom: 8px;
      color: var(--accent2);
    }

    .round-awards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 10px;
    }

    .round-award-card {
      border-radius: 10px;
      border: 1px solid rgba(0, 255, 135, 0.2);
      padding: 10px;
      font-size: 0.85rem;
    }

    .round-award-title {
      font-weight: 700;
      margin-bottom: 6px;
    }

    .simple-list {
      margin: 0;
      padding-left: 18px;
      font-size: 0.85rem;
    }

    .simple-list li {
      margin-bottom: 4px;
    }

    /* Dashboard */
    .leaders-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.82rem;
    }

    .leaders-table th,
    .leaders-table td {
      border-bottom: 1px solid #151a26;
      padding: 6px 6px;
      text-align: left;
    }

    .leaders-table th {
      color: var(--accent2);
      font-weight: 700;
      border-bottom: 1px solid rgba(0, 180, 255, 0.6);
    }

    .bar-cell {
      position: relative;
      min-width: 120px;
    }

    .bar-bg {
      position: absolute;
      inset: 0;
      background: #0b101c;
      border-radius: 999px;
    }

    .bar-fill {
      position: absolute;
      top: 1px;
      bottom: 1px;
      left: 1px;
      border-radius: 999px;
      background: linear-gradient(90deg, var(--accent2), var(--accent));
    }

    .bar-label {
      position: relative;
      z-index: 1;
      padding: 0 6px;
    }

    /* Manual sim */
    .manual-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
    }

    .manual-row select {
      max-width: 260px;
    }

    .manual-score-card {
      border-radius: 10px;
      border: 1px solid rgba(0, 255, 135, 0.25);
      padding: 10px;
      font-size: 0.9rem;
    }

    /* Bracket */
    .bracket-card {
      display: flex;
      gap: 12px;
      overflow-x: auto;
    }

    .bracket-col {
      flex: 1;
      min-width: 220px;
    }

    .bracket-title {
      font-weight: 800;
      margin-bottom: 8px;
      color: var(--accent2);
    }

    .bracket-ties {
      display: grid;
      gap: 8px;
    }

    .tie-card {
      border-radius: 10px;
      border: 1px solid rgba(0, 255, 135, 0.2);
      padding: 10px;
      font-size: 0.82rem;
    }

    .tie-row {
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }

    .tie-winner {
      margin-top: 6px;
      font-size: 0.78rem;
      color: var(--sub);
    }

    footer {
      text-align: center;
      color: var(--sub);
      font-size: 0.8rem;
      margin-top: 24px;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header>
      <div class="title">ALL-TIME CLUB SIMULATOR</div>
      <div class="subtitle">R to re-roll ‚Ä¢ S to sim ‚Ä¢ Group + Knockout ‚Ä¢ Penalty drama included</div>
    </header>

    <!-- CONTROL PANEL -->
    <section class="card" style="margin-bottom: 12px;">
      <div class="controls-grid">
        <div>
          <div class="label-sm">Seed (visual only)</div>
          <input type="text" id="seed-input" />
        </div>
        <div>
          <div class="label-sm">Goal Environment: <span id="goal-env-label"></span></div>
          <input type="range" id="goal-env-range" min="0.8" max="2" step="0.1" />
        </div>
        <div>
          <div class="label-sm">Home Advantage: <span id="home-adv-label"></span></div>
          <input type="range" id="home-adv-range" min="0" max="0.3" step="0.05" />
        </div>
        <div class="btn-row">
          <button class="btn-ghost" id="quick-resim-btn">Quick Re-Sim</button>
          <button class="btn" id="randomize-groups-btn">üé≤ Randomize Groups</button>
          <button class="btn btn-danger" id="run-tournament-btn">‚ñ∂Ô∏è Run Tournament</button>
        </div>
        <div class="btn-row">
          <button class="btn-ghost" id="export-matches-btn">‚¨áÔ∏è Matches CSV</button>
          <button class="btn-ghost" id="export-leaders-btn">‚¨áÔ∏è Players CSV</button>
        </div>
        <div class="btn-row">
          <button class="btn-ghost" id="sound-btn">üîä Sound On</button>
          <button class="btn-ghost" id="export-save-btn">üíæ Export Save</button>
          <button class="btn-ghost" id="import-save-btn">üìÇ Import Save</button>
        </div>
      </div>
    </section>

    <!-- TABS -->
    <nav class="tab-nav">
      <button class="tab-btn tab-active" data-tab="groups">GROUPS</button>
      <button class="tab-btn" data-tab="matches">MATCHES</button>
      <button class="tab-btn" data-tab="awards">AWARDS</button>
      <button class="tab-btn" data-tab="dashboard">DASHBOARD</button>
      <button class="tab-btn" data-tab="manual">MANUAL</button>
      <button class="tab-btn" data-tab="bracket">BRACKET</button>
      <button class="tab-btn" data-tab="summary">SUMMARY</button>

      <div class="tab-toggle">
        <button class="btn-ghost" id="ui-mode-btn">üß≠ Classic Tabs</button>
      </div>
    </nav>

    <!-- GROUPS TAB -->
    <section id="tab-groups" class="tab-panel active">
      <div id="groups-container" class="groups-grid">
        <!-- Filled by JS -->
      </div>
    </section>

    <!-- MATCHES TAB -->
    <section id="tab-matches" class="tab-panel">
      <div id="matches-container" class="matches-grid">
        <!-- Filled by JS -->
      </div>
    </section>

    <!-- AWARDS TAB -->
    <section id="tab-awards" class="tab-panel">
      <div class="awards-grid">
        <div class="card">
          <div class="award-section-title">Top Goal Scorers</div>
          <div id="top-scorers-container" class="round-awards-grid"></div>
        </div>
        <div class="card">
          <div class="award-section-title">Top Assisters</div>
          <div id="top-assisters-container" class="round-awards-grid"></div>
        </div>
        <div class="card">
          <div class="award-section-title">Top Goalkeepers (Clean Sheets)</div>
          <div id="top-keepers-container" class="round-awards-grid"></div>
        </div>
        <div class="card">
          <div class="award-section-title">Best Overall Players</div>
          <div id="best-overall-container" class="round-awards-grid"></div>
        </div>
      </div>
    </section>

    <!-- DASHBOARD TAB -->
    <section id="tab-dashboard" class="tab-panel">
      <div class="card">
        <div class="award-section-title">Performance Dashboard</div>
        <div style="margin-bottom:6px;font-size:0.8rem;color:var(--sub);">
          Top 15 players by average rating. Bars show combined impact (Goals + Assists + Avg).
        </div>
        <div style="overflow-x:auto;">
          <table class="leaders-table" id="leaders-table">
            <!-- Filled by JS -->
          </table>
        </div>
      </div>
    </section>

    <!-- MANUAL TAB -->
    <section id="tab-manual" class="tab-panel">
      <div class="card">
        <div class="award-section-title">Manual Match Simulator</div>
        <div class="manual-row">
          <select id="manual-home-select"></select>
          <span style="color:var(--accent);font-weight:700;">vs</span>
          <select id="manual-away-select"></select>
          <button class="btn" id="manual-sim-btn">Simulate</button>
        </div>
        <div id="manual-result-container"></div>
      </div>
    </section>

    <!-- BRACKET TAB -->
    <section id="tab-bracket" class="tab-panel">
      <div class="card">
        <div id="bracket-container" class="bracket-card"></div>
      </div>
    </section>

    <!-- SUMMARY TAB -->
    <section id="tab-summary" class="tab-panel">
      <div class="card" style="margin-bottom:12px;">
        <div class="award-section-title">Tournament Overview</div>
        <div id="summary-overview"></div>
      </div>
      <div class="card">
        <div class="award-section-title">Team of the Tournament (Best XI)</div>
        <div id="summary-bestxi"></div>
      </div>
    </section>

    <footer>
      ¬© Retro Football Sim ‚Äî 32-club tournament ‚Ä¢ full squads ‚Ä¢ penalties ‚Ä¢ stats ‚Ä¢ Best XI
    </footer>
  </div>

  <script>
    const THEME = {
      bg: "#020712",
      panel: "#050a16",
      accent: "#00ff87",
      accent2: "#00b4ff",
      accent3: "#ff3366",
      text: "#f5f7ff",
      sub: "#8c92ac"
    };

    const saveLocal = (k, v) => localStorage.setItem(k, JSON.stringify(v));
    const loadLocal = (k, fb) => {
      try {
        const raw = localStorage.getItem(k);
        return raw ? JSON.parse(raw) : fb;
      } catch {
        return fb;
      }
    };
    const clamp = (x, lo, hi) => Math.max(lo, Math.min(hi, x));
    const normal = (mu = 0, sigma = 1) => {
      let u = 0, v = 0;
      while (!u) u = Math.random();
      while (!v) v = Math.random();
      const z = Math.sqrt(-2 * Math.log(u)) * Math.cos(2 * Math.PI * v);
      return z * sigma + mu;
    };
    const fact = n => (n <= 1 ? 1 : n * fact(n - 1));
    const poisson = (lambda, cap = 7) => {
      const probs = Array.from({ length: cap + 1 }, (_, k) =>
        Math.exp(-lambda) * (lambda ** k) / fact(k)
      );
      const tot = probs.reduce((a, b) => a + b, 0);
      let r = Math.random(), c = 0;
      for (let k = 0; k <= cap; k++) {
        c += probs[k] / tot;
        if (r <= c) return k;
      }
      return cap;
    };

    const DEFAULT_TEAMS = [
      { name: "2015 Barcelona", stars: [
        { name: "Lionel Messi", quality: 100 }, { name: "Andr√©s Iniesta", quality: 95 },
        { name: "Xavi", quality: 94 }, { name: "Neymar", quality: 95 }, { name: "Luis Su√°rez", quality: 96 }
      ], teamStrength: 96, goalie: { name: "Claudio Bravo" } },
      { name: "2017 Real Madrid", stars: [
        { name: "Cristiano Ronaldo", quality: 98 }, { name: "Luka Modriƒá", quality: 94 },
        { name: "Sergio Ramos", quality: 91 }, { name: "Toni Kroos", quality: 93 }, { name: "Marcelo", quality: 90 }
      ], teamStrength: 95, goalie: { name: "Keylor Navas" } },
      { name: "2013 Bayern Munich", stars: [
        { name: "Arjen Robben", quality: 92 }, { name: "Franck Rib√©ry", quality: 91 },
        { name: "Thomas M√ºller", quality: 90 }, { name: "Bastian Schweinsteiger", quality: 90 },
        { name: "Philipp Lahm", quality: 91 }
      ], teamStrength: 94, goalie: { name: "Manuel Neuer" } },
      { name: "2023 Manchester City", stars: [
        { name: "Erling Haaland", quality: 95 }, { name: "Kevin De Bruyne", quality: 94 },
        { name: "Bernardo Silva", quality: 90 }, { name: "Rodri", quality: 93 }, { name: "R√∫ben Dias", quality: 90 }
      ], teamStrength: 95, goalie: { name: "Ederson" } },
      { name: "1989 AC Milan", stars: [
        { name: "Marco van Basten", quality: 96 }, { name: "Ruud Gullit", quality: 94 },
        { name: "Franco Baresi", quality: 92 }, { name: "Paolo Maldini", quality: 92 },
        { name: "Frank Rijkaard", quality: 93 }
      ], teamStrength: 94, goalie: { name: "Giovanni Galli" } },
      { name: "2010 Inter Milan", stars: [
        { name: "Diego Milito", quality: 90 }, { name: "Wesley Sneijder", quality: 92 },
        { name: "Samuel Eto'o", quality: 93 }, { name: "Javier Zanetti", quality: 90 },
        { name: "Esteban Cambiasso", quality: 89 }
      ], teamStrength: 90, goalie: { name: "Julio Cesar" } },
      { name: "2004 Arsenal", stars: [
        { name: "Thierry Henry", quality: 96 }, { name: "Dennis Bergkamp", quality: 93 },
        { name: "Patrick Vieira", quality: 92 }, { name: "Robert Pires", quality: 90 },
        { name: "Sol Campbell", quality: 89 }
      ], teamStrength: 90, goalie: { name: "Jens Lehmann" } },
      { name: "1984 Liverpool", stars: [
        { name: "Kenny Dalglish", quality: 91 }, { name: "Ian Rush", quality: 92 },
        { name: "Graeme Souness", quality: 90 }, { name: "Alan Hansen", quality: 88 },
        { name: "Phil Neal", quality: 86 }
      ], teamStrength: 90, goalie: { name: "Bruce Grobbelaar" } },
      { name: "1971 Ajax", stars: [
        { name: "Johan Cruyff", quality: 97 }, { name: "Johan Neeskens", quality: 92 },
        { name: "Arie Haan", quality: 88 }, { name: "Ruud Krol", quality: 90 },
        { name: "Sjaak Swart", quality: 86 }
      ], teamStrength: 92, goalie: { name: "Heinz Stuy" } },
      { name: "2012 Chelsea", stars: [
        { name: "Didier Drogba", quality: 92 }, { name: "Frank Lampard", quality: 91 },
        { name: "John Terry", quality: 88 }, { name: "Eden Hazard", quality: 90 },
        { name: "Ashley Cole", quality: 88 }
      ], teamStrength: 88, goalie: { name: "Petr ƒåech" } },
      { name: "1997 Borussia Dortmund", stars: [
        { name: "Karl-Heinz Riedle", quality: 88 }, { name: "Andreas M√∂ller", quality: 90 },
        { name: "Lars Ricken", quality: 86 }, { name: "Matthias Sammer", quality: 90 },
        { name: "J√ºrgen Kohler", quality: 88 }
      ], teamStrength: 88, goalie: { name: "Stefan Klos" } },
      { name: "1996 Juventus", stars: [
        { name: "Zinedine Zidane", quality: 95 }, { name: "Didier Deschamps", quality: 89 },
        { name: "Alessandro Del Piero", quality: 93 }, { name: "Antonio Conte", quality: 87 },
        { name: "Ciro Ferrara", quality: 87 }
      ], teamStrength: 92, goalie: { name: "Angelo Peruzzi" } },
      { name: "2014 Atl√©tico Madrid", stars: [
        { name: "Diego God√≠n", quality: 89 }, { name: "Antoine Griezmann", quality: 90 },
        { name: "Koke", quality: 89 }, { name: "Gabi", quality: 87 },
        { name: "Felipe Luis", quality: 86 }
      ], teamStrength: 90, goalie: { name: "Jan Oblak" } },
      { name: "1963 Santos", stars: [
        { name: "Pel√©", quality: 99 }, { name: "Coutinho", quality: 92 },
        { name: "Pepe", quality: 92 }, { name: "Zito", quality: 90 },
        { name: "Carlos Alberto", quality: 92 }
      ], teamStrength: 93, goalie: { name: "Gilmar" } },
      { name: "1962 Benfica", stars: [
        { name: "Eus√©bio", quality: 96 }, { name: "M√°rio Coluna", quality: 92 },
        { name: "Jos√© √Åguas", quality: 90 }, { name: "Germano", quality: 88 },
        { name: "√Åntonio Sim√µes", quality: 88 }
      ], teamStrength: 92, goalie: { name: "Costa Pereira" } },
      { name: "1979 Nottingham Forest", stars: [
        { name: "Trevor Francis", quality: 88 }, { name: "John Robertson", quality: 87 },
        { name: "Peter Shilton", quality: 89 }, { name: "Viv Anderson", quality: 87 },
        { name: "Kenny Burns", quality: 86 }
      ], teamStrength: 87, goalie: { name: "Peter Shilton" } },
      { name: "1988 PSV Eindhoven", stars: [
        { name: "Rom√°rio", quality: 96 }, { name: "Eric Gerets", quality: 88 },
        { name: "Gerald Vanenburg", quality: 88 }, { name: "Ronald Koeman", quality: 90 },
        { name: "Hans Gillhaus", quality: 87 }
      ], teamStrength: 89, goalie: { name: "Hans van Breukelen" } },
      { name: "2019 Flamengo", stars: [
        { name: "Gabigol", quality: 89 }, { name: "Bruno Henrique", quality: 88 },
        { name: "Gerson", quality: 86 }, { name: "Arrascaeta", quality: 88 },
        { name: "Rafinha", quality: 86 }
      ], teamStrength: 88, goalie: { name: "Diego Alves" } },
      { name: "2012 Corinthians", stars: [
        { name: "Paulinho", quality: 86 }, { name: "C√°ssio", quality: 88 },
        { name: "Emerson", quality: 85 }, { name: "Danilo", quality: 85 },
        { name: "Ralf", quality: 85 }
      ], teamStrength: 86, goalie: { name: "C√°ssio" } },
      { name: "1992 S√£o Paulo", stars: [
        { name: "Ra√≠", quality: 90 }, { name: "Cafu", quality: 90 },
        { name: "Toninho Cerezo", quality: 88 }, { name: "M√ºller", quality: 87 },
        { name: "Leonardo", quality: 86 }
      ], teamStrength: 89, goalie: { name: "Zetti" } },
      { name: "1986 Steaua Bucure»ôti", stars: [
        { name: "Gheorghe Hagi", quality: 92 }, { name: "Helmuth Duckadam", quality: 88 },
        { name: "LƒÉcƒÉtu»ô", quality: 88 }, { name: "Marius LƒÉcƒÉtu»ô", quality: 88 },
        { name: "Victor Pi»õurcƒÉ", quality: 87 }
      ], teamStrength: 87, goalie: { name: "Helmuth Duckadam" } },
      { name: "1991 Red Star Belgrade", stars: [
        { name: "Dejan Saviƒáeviƒá", quality: 90 }, { name: "Robert Prosineƒçki", quality: 90 },
        { name: "Darko Panƒçev", quality: 90 }, { name: "Vladimir Jugoviƒá", quality: 88 },
        { name: "Miodrag Belodedici", quality: 88 }
      ], teamStrength: 88, goalie: { name: "Stevan Stojanoviƒá" } },
      { name: "1966 Pe√±arol", stars: [
        { name: "Alberto Spencer", quality: 92 }, { name: "Pedro Rocha", quality: 90 },
        { name: "Ladislao Mazurkiewicz", quality: 90 }, { name: "Luis Cubilla", quality: 88 },
        { name: "Roque M√°spoli", quality: 87 }
      ], teamStrength: 88, goalie: { name: "Ladislao Mazurkiewicz" } },
      { name: "1973 Independiente", stars: [
        { name: "Ricardo Bochini", quality: 90 }, { name: "Daniel Bertoni", quality: 88 },
        { name: "Miguel Santoro", quality: 86 }, { name: "Jorge Burruchaga", quality: 88 },
        { name: "Ricardo Pavoni", quality: 87 }
      ], teamStrength: 90, goalie: { name: "Miguel Santoro" } },
      { name: "1968 Estudiantes", stars: [
        { name: "Juan Ram√≥n Ver√≥n", quality: 88 }, { name: "Carlos Bilardo", quality: 86 },
        { name: "Oscar Malbernat", quality: 85 }, { name: "Ra√∫l Madero", quality: 85 },
        { name: "Juan Echecopar", quality: 84 }
      ], teamStrength: 87, goalie: { name: "Alberto Poletti" } },
      { name: "2018 River Plate", stars: [
        { name: "Pity Mart√≠nez", quality: 86 }, { name: "Juanfer Quintero", quality: 87 },
        { name: "Franco Armani", quality: 86 }, { name: "Gonzalo Mart√≠nez", quality: 86 },
        { name: "Lucas Pratto", quality: 86 }
      ], teamStrength: 88, goalie: { name: "Franco Armani" } },
      { name: "2003 Boca Juniors", stars: [
        { name: "Juan Rom√°n Riquelme", quality: 93 }, { name: "Carlos Tevez", quality: 90 },
        { name: "Roberto Abbondanzieri", quality: 87 }, { name: "Mart√≠n Palermo", quality: 89 },
        { name: "Clemente Rodr√≠guez", quality: 86 }
      ], teamStrength: 90, goalie: { name: "Roberto Abbondanzieri" } },
      { name: "1991 Sampdoria", stars: [
        { name: "Gianluca Vialli", quality: 90 }, { name: "Roberto Mancini", quality: 90 },
        { name: "Attilio Lombardo", quality: 88 }, { name: "Pietro Vierchowod", quality: 88 },
        { name: "Toninho Cerezo", quality: 88 }
      ], teamStrength: 85, goalie: { name: "Gianluca Pagliuca" } },
      { name: "1971 Celtic", stars: [
        { name: "Jimmy Johnstone", quality: 89 }, { name: "Billy McNeill", quality: 88 },
        { name: "Bobby Lennox", quality: 88 }, { name: "Tommy Gemmell", quality: 88 },
        { name: "Bertie Auld", quality: 87 }
      ], teamStrength: 86, goalie: { name: "Evan Williams" } },
      { name: "1972 Derby County", stars: [
        { name: "Kevin Hector", quality: 85 }, { name: "Roy McFarland", quality: 86 },
        { name: "Colin Todd", quality: 86 }, { name: "Alan Hinton", quality: 85 },
        { name: "Archie Gemmill", quality: 86 }
      ], teamStrength: 84, goalie: { name: "Colin Boulton" } },
      { name: "1978 Club Brugge", stars: [
        { name: "Jan Ceulemans", quality: 88 }, { name: "Birger Jensen", quality: 86 },
        { name: "Robbie Rensenbrink", quality: 88 }, { name: "Raoul Lambert", quality: 86 },
        { name: "Franky Van der Elst", quality: 86 }
      ], teamStrength: 85, goalie: { name: "Birger Jensen" } },
      { name: "1995 Ajax", stars: [
        { name: "Patrick Kluivert", quality: 90 }, { name: "Clarence Seedorf", quality: 90 },
        { name: "Edgar Davids", quality: 89 }, { name: "Marc Overmars", quality: 89 },
        { name: "Frank de Boer", quality: 89 }
      ], teamStrength: 92, goalie: { name: "Edwin van der Sar" } },
      { name: "1999 Manchester United", stars: [
        { name: "Ryan Giggs", quality: 90 }, { name: "Paul Scholes", quality: 90 },
        { name: "David Beckham", quality: 90 }, { name: "Roy Keane", quality: 91 },
        { name: "Jaap Stam", quality: 90 }
      ], teamStrength: 92, goalie: { name: "Peter Schmeichel" } },
      { name: "1994 AC Milan", stars: [
        { name: "George Weah", quality: 92 }, { name: "Dejan Saviƒáeviƒá", quality: 90 },
        { name: "Paolo Maldini", quality: 93 }, { name: "Franco Baresi", quality: 94 },
        { name: "Roberto Donadoni", quality: 88 }
      ], teamStrength: 94, goalie: { name: "Sebastiano Rossi" } },
      { name: "1993 Marseille", stars: [
        { name: "Didier Deschamps", quality: 89 }, { name: "Marcel Desailly", quality: 90 },
        { name: "Abedi Pel√©", quality: 90 }, { name: "Rudi V√∂ller", quality: 89 },
        { name: "Fabien Barthez", quality: 90 }
      ], teamStrength: 90, goalie: { name: "Fabien Barthez" } },

      /* extra legendary/current squads (pool bigger than 32, tournament still uses 32) */
      { name: "2019 Liverpool", stars: [
        { name: "Mohamed Salah", quality: 95 }, { name: "Sadio Man√©", quality: 94 },
        { name: "Roberto Firmino", quality: 92 }, { name: "Virgil van Dijk", quality: 96 },
        { name: "Trent Alexander-Arnold", quality: 92 }
      ], teamStrength: 95, goalie: { name: "Alisson" } },
      { name: "2020 Bayern Munich", stars: [
        { name: "Robert Lewandowski", quality: 98 }, { name: "Thomas M√ºller", quality: 94 },
        { name: "Joshua Kimmich", quality: 94 }, { name: "Alphonso Davies", quality: 91 },
        { name: "Serge Gnabry", quality: 92 }
      ], teamStrength: 96, goalie: { name: "Manuel Neuer" } },
      { name: "2008 Manchester United", stars: [
        { name: "Cristiano Ronaldo", quality: 97 }, { name: "Wayne Rooney", quality: 94 },
        { name: "Carlos Tevez", quality: 93 }, { name: "Nemanja Vidiƒá", quality: 93 },
        { name: "Rio Ferdinand", quality: 93 }
      ], teamStrength: 95, goalie: { name: "Edwin van der Sar" } },
      { name: "2000 Real Madrid", stars: [
        { name: "Ra√∫l", quality: 94 }, { name: "Luis Figo", quality: 95 },
        { name: "Roberto Carlos", quality: 93 }, { name: "Fernando Hierro", quality: 92 },
        { name: "Claude Mak√©l√©l√©", quality: 92 }
      ], teamStrength: 94, goalie: { name: "Iker Casillas" } }
    ];

    function buildSquad(team) {
      if (team.players && team.players.length === 11) return team;

      const base = (team.stars || []).slice();
      const outfield = [];
      for (let i = 0; i < base.length && outfield.length < 10; i++) {
        outfield.push({ name: base[i].name, quality: base[i].quality });
      }
      while (outfield.length < 10) {
        outfield.push({
          name: `${team.name} #${outfield.length + 1}`,
          quality: clamp(team.teamStrength - 5 + Math.round(normal(0, 3)), 78, 95)
        });
      }
      const gkName = (team.goalie && team.goalie.name) || `${team.name} GK`;
      const gkQuality = clamp(team.teamStrength - 2 + Math.round(normal(0, 3)), 80, 96);

      const squad = outfield.map((p, idx) => {
        let position;
        if (idx <= 2) position = "FW";
        else if (idx <= 5) position = "MF";
        else position = "DF";
        return { name: p.name, quality: p.quality, position, isGK: false };
      });
      squad.push({ name: gkName, quality: gkQuality, position: "GK", isGK: true });

      return { ...team, players: squad };
    }

    // ----- STATE -----
    let teams = (loadLocal("teams", DEFAULT_TEAMS) || DEFAULT_TEAMS).map(buildSquad);
    let favorites = loadLocal("favorites", []);
    let seed = loadLocal("seed", "42");
    let goalEnv = typeof loadLocal("goalEnv", null) === "number" ? loadLocal("goalEnv", 1.2) : 1.2;
    let homeAdv = typeof loadLocal("homeAdv", null) === "number" ? loadLocal("homeAdv", 0.1) : 0.1;
    let soundOn = loadLocal("soundOn", true);

    let groups = {};
    let matches = [];
    let bracket = { r16: [], qf: [], sf: [], final: [] };
    let leaders = [];
    let manualHome = "2015 Barcelona";
    let manualAway = "2017 Real Madrid";
    let manualResult = null;
    let uiMode = "tabs";

    let tournamentStats = {};
    let tournamentOverview = null;
    let bestXI = null;

    const teamMap = () => Object.fromEntries(teams.map(t => [t.name, t]));

    // ----- DOM REFS -----
    const seedInput = document.getElementById("seed-input");
    const goalEnvRange = document.getElementById("goal-env-range");
    const goalEnvLabel = document.getElementById("goal-env-label");
    const homeAdvRange = document.getElementById("home-adv-range");
    const homeAdvLabel = document.getElementById("home-adv-label");
    const quickResimBtn = document.getElementById("quick-resim-btn");
    const randomizeGroupsBtn = document.getElementById("randomize-groups-btn");
    const runTournamentBtn = document.getElementById("run-tournament-btn");
    const exportMatchesBtn = document.getElementById("export-matches-btn");
    const exportLeadersBtn = document.getElementById("export-leaders-btn");
    const soundBtn = document.getElementById("sound-btn");
    const exportSaveBtn = document.getElementById("export-save-btn");
    const importSaveBtn = document.getElementById("import-save-btn");
    const uiModeBtn = document.getElementById("ui-mode-btn");

    const groupsContainer = document.getElementById("groups-container");
    const matchesContainer = document.getElementById("matches-container");

    const topScorersContainer = document.getElementById("top-scorers-container");
    const topAssistersContainer = document.getElementById("top-assisters-container");
    const topKeepersContainer = document.getElementById("top-keepers-container");
    const bestOverallContainer = document.getElementById("best-overall-container");

    const leadersTable = document.getElementById("leaders-table");
    const manualHomeSelect = document.getElementById("manual-home-select");
    const manualAwaySelect = document.getElementById("manual-away-select");
    const manualSimBtn = document.getElementById("manual-sim-btn");
    const manualResultContainer = document.getElementById("manual-result-container");
    const bracketContainer = document.getElementById("bracket-container");
    const summaryOverview = document.getElementById("summary-overview");
    const summaryBestXI = document.getElementById("summary-bestxi");

    // Initial inputs
    seedInput.value = seed;
    goalEnvRange.value = goalEnv;
    homeAdvRange.value = homeAdv;
    goalEnvLabel.textContent = goalEnv.toFixed(2);
    homeAdvLabel.textContent = homeAdv.toFixed(2);
    soundBtn.textContent = soundOn ? "üîä Sound On" : "üîá Sound Off";

    // ----- TABS -----
    const tabButtons = document.querySelectorAll(".tab-btn");
    const tabPanels = document.querySelectorAll(".tab-panel");

    function switchTab(tabName) {
      tabButtons.forEach(btn => {
        btn.classList.toggle("tab-active", btn.dataset.tab === tabName);
      });
      tabPanels.forEach(panel => {
        panel.classList.toggle("active", panel.id === "tab-" + tabName);
      });
      if (tabName === "matches" && uiMode === "bracket") {
        document.getElementById("tab-matches").style.display = "none";
      } else {
        document.getElementById("tab-matches").style.display = "";
      }
    }

    tabButtons.forEach(btn => {
      btn.addEventListener("click", () => switchTab(btn.dataset.tab));
    });

    uiModeBtn.addEventListener("click", () => {
      uiMode = uiMode === "tabs" ? "bracket" : "tabs";
      uiModeBtn.textContent = uiMode === "tabs" ? "üß≠ Classic Tabs" : "üß© Bracket Focus";
      if (uiMode === "bracket" && matches.length) {
        switchTab("bracket");
      }
    });

    // ----- CORE MATCH SIMULATION -----

    function simulateScore(a, b, gEnv, hAdv) {
      if (!a || !b) return [0, 0];
      const sA = a.teamStrength, sB = b.teamStrength;
      const lamA = Math.max(0.2, gEnv * ((sA / (sA + sB)) * 2 + hAdv));
      const lamB = Math.max(0.2, gEnv * ((sB / (sA + sB)) * 2));
      return [poisson(lamA), poisson(lamB)];
    }

    function weightedChoice(indices, arr) {
      let total = 0;
      for (const i of indices) {
        total += Math.max(1, arr[i].quality - 75);
      }
      let r = Math.random() * total;
      for (const i of indices) {
        const w = Math.max(1, arr[i].quality - 75);
        if (r < w) return i;
        r -= w;
      }
      return indices[indices.length - 1];
    }

    function simulateTeamPerformance(team, goalsFor, goalsAgainst) {
      const players = team.players || [];
      const stats = players.map(p => ({
        name: p.name,
        quality: p.quality,
        position: p.position,
        isGK: p.isGK,
        goals: 0,
        assists: 0,
        rating: 6.0
      }));

      const outfieldIdxs = stats.map((p, i) => (!p.isGK ? i : null)).filter(i => i !== null);
      const gkIdx = stats.findIndex(p => p.isGK);

      // distribute goals and assists
      for (let i = 0; i < goalsFor; i++) {
        if (!outfieldIdxs.length) break;
        const scorerIdx = weightedChoice(outfieldIdxs, stats);
        stats[scorerIdx].goals += 1;

        if (Math.random() < 0.65) {
          const assistCandidates = outfieldIdxs.filter(j => j !== scorerIdx);
          if (assistCandidates.length) {
            const aIdx = weightedChoice(assistCandidates, stats);
            stats[aIdx].assists += 1;
          }
        }
      }

      // ratings
      stats.forEach(s => {
        if (!s.isGK) {
          const base = 6.0 + (s.quality - 80) / 12;
          const r = base + 0.8 * s.goals + 0.5 * s.assists - 0.03 * goalsAgainst;
          s.rating = clamp(r, 5.0, 10.0);
        } else {
          const base = 6.2 + (s.quality - 80) / 14;
          const penalty = 0.08 * goalsAgainst;
          const bonus = goalsAgainst === 0 ? 0.8 : 0;
          const r = base + bonus - penalty;
          s.rating = clamp(r, 5.0, 10.0);
        }
      });

      let featured = stats[0];
      stats.forEach(s => {
        if (!s.isGK && s.rating > featured.rating) featured = s;
      });
      if (!featured || featured.isGK) {
        featured = stats[gkIdx >= 0 ? gkIdx : 0];
      }

      return { playerStats: stats, featured };
    }

    function recordPlayerStat(team, playerStat, conceded) {
      const id = `${playerStat.name}|${team.name}`;
      let rec = tournamentStats[id];
      if (!rec) {
        rec = {
          name: playerStat.name,
          team: team.name,
          isGK: playerStat.isGK,
          position: playerStat.position,
          matches: 0,
          goals: 0,
          assists: 0,
          ratingSum: 0,
          cleanSheets: 0,
          goalsAgainst: 0
        };
        tournamentStats[id] = rec;
      }
      rec.matches++;
      rec.goals += playerStat.goals;
      rec.assists += playerStat.assists;
      rec.ratingSum += playerStat.rating;
      if (playerStat.isGK) {
        rec.goalsAgainst += conceded;
        if (conceded === 0) rec.cleanSheets++;
      }
    }

    function penaltyChance(team) {
      return clamp(0.74 + (team.teamStrength - 92) / 120, 0.65, 0.88);
    }

    function penaltyShootout(A, B) {
      const pA = penaltyChance(A);
      const pB = penaltyChance(B);
      let scoreA = 0, scoreB = 0;

      for (let i = 0; i < 5; i++) {
        if (Math.random() < pA) scoreA++;
        if (Math.random() < pB) scoreB++;
      }
      let rounds = 5;
      while (scoreA === scoreB) {
        if (Math.random() < pA) scoreA++;
        if (Math.random() < pB) scoreB++;
        rounds++;
        if (rounds > 10) break; // sanity cap
      }
      const winner = scoreA > scoreB ? A.name : B.name;
      return { a: A.name, b: B.name, scoreA, scoreB, winner };
    }

    function makeSummary(a, b, gA, gB, leg, keys, pen) {
      const tone = gA === gB
        ? "couldn‚Äôt be separated in normal time"
        : Math.abs(gA - gB) === 1
        ? "won it by a single goal"
        : gA > gB
        ? "ran away with it"
        : "dominated large phases";

      const leader = gA > gB ? a.name : gB > gA ? b.name : "Neither side";
      const legTxt = leg ? ` (Leg ${leg})` : "";
      const total = gA + gB;

      let tempo;
      if (total >= 5) tempo = "It turned into a basketball score with chances at both ends.";
      else if (total === 0) tempo = "It was a tight tactical chess match with very few clear chances.";
      else if (total === 1) tempo = "One moment of quality separated the teams.";
      else tempo = "The game swung back and forth with spells of pressure for both sides.";

      const keyStr = keys && keys.length ? ` Standout figures: ${keys.join(", ")}.` : "";
      let penStr = "";
      if (pen) {
        penStr = ` ${pen.winner} held their nerve in the shoot-out, winning ${pen.scoreA}-${pen.scoreB} on penalties.`;
      }

      return `${a.name} vs ${b.name}${legTxt} finished ${gA}-${gB}. ${leader} ${tone}. ${tempo}${keyStr}${penStr}`;
    }

    function groupSchedule(ts) {
      if (!ts || ts.length < 4) return [];
      const [A, B, C, D] = ts;
      return [
        [{ home: A, away: B }, { home: C, away: D }],
        [{ home: A, away: C }, { home: B, away: D }],
        [{ home: A, away: D }, { home: B, away: C }]
      ];
    }

    function shuffle(arr) {
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function twoLeg(all, A, B, roundName) {
      const [l1A, l1B] = simulateScore(A, B, goalEnv, homeAdv);
      const perf1A = simulateTeamPerformance(A, l1A, l1B);
      const perf1B = simulateTeamPerformance(B, l1B, l1A);

      perf1A.playerStats.forEach(p => recordPlayerStat(A, p, l1B));
      perf1B.playerStats.forEach(p => recordPlayerStat(B, p, l1A));

      const sum1 = makeSummary(
        A, B, l1A, l1B, 1,
        [`${perf1A.featured.name} ${perf1A.featured.goals}G/${perf1A.featured.assists}A`,
         `${perf1B.featured.name} ${perf1B.featured.goals}G/${perf1B.featured.assists}A`],
        null
      );

      all.push({
        id: `${roundName}-${A.name}-${B.name}-L1`,
        round: roundName,
        leg: 1,
        week: 0,
        home: A.name,
        away: B.name,
        homeGoals: l1A,
        awayGoals: l1B,
        summary: sum1,
        starInvolvement: {
          [perf1A.featured.name]: {
            team: A.name,
            goals: perf1A.featured.goals,
            assists: perf1A.featured.assists,
            rating: perf1A.featured.rating
          },
          [perf1B.featured.name]: {
            team: B.name,
            goals: perf1B.featured.goals,
            assists: perf1B.featured.assists,
            rating: perf1B.featured.rating
          }
        }
      });

      const [l2A, l2B] = simulateScore(B, A, goalEnv, homeAdv);
      const perf2B = simulateTeamPerformance(A, l2B, l2A); // away second leg
      const perf2A = simulateTeamPerformance(B, l2A, l2B); // home second leg

      perf2A.playerStats.forEach(p => recordPlayerStat(B, p, l2B));
      perf2B.playerStats.forEach(p => recordPlayerStat(A, p, l2A));

      const aggA = l1A + l2B;
      const aggB = l1B + l2A;

      let pen = null;
      let winner;
      if (aggA === aggB) {
        pen = penaltyShootout(A, B);
        winner = pen.winner;
      } else {
        winner = aggA > aggB ? A.name : B.name;
      }

      const sum2 = makeSummary(
        B, A, l2A, l2B, 2,
        [`${perf2A.featured.name} ${perf2A.featured.goals}G/${perf2A.featured.assists}A`,
         `${perf2B.featured.name} ${perf2B.featured.goals}G/${perf2B.featured.assists}A`],
        pen
      );

      const leg2 = {
        id: `${roundName}-${A.name}-${B.name}-L2`,
        round: roundName,
        leg: 2,
        week: 0,
        home: B.name,
        away: A.name,
        homeGoals: l2A,
        awayGoals: l2B,
        summary: sum2,
        starInvolvement: {
          [perf2A.featured.name]: {
            team: B.name,
            goals: perf2A.featured.goals,
            assists: perf2A.featured.assists,
            rating: perf2A.featured.rating
          },
          [perf2B.featured.name]: {
            team: A.name,
            goals: perf2B.featured.goals,
            assists: perf2B.featured.assists,
            rating: perf2B.featured.rating
          }
        },
        penShootout: pen || null
      };
      all.push(leg2);

      return { winner, aggA, aggB, pen };
    }

    // ----- TOURNAMENT -----

    function randomizeGroups() {
      const favs = new Set(favorites);
      const favTeams = teams.filter(t => favs.has(t.name));
      const others = teams.filter(t => !favs.has(t.name));
      const shuffled = shuffle(others);
      const selected = favTeams.concat(shuffled).slice(0, 32);
      while (selected.length < 32) {
        const pool = shuffled.length ? shuffled : teams;
        selected.push(pool[Math.floor(Math.random() * pool.length)]);
      }
      const out = {};
      for (let i = 0; i < 8; i++) {
        out[String.fromCharCode(65 + i)] = selected
          .slice(i * 4, (i + 1) * 4)
          .map(t => t.name);
      }
      groups = out;
      matches = [];
      bracket = { r16: [], qf: [], sf: [], final: [] };
      tournamentStats = {};
      tournamentOverview = null;
      bestXI = null;
      leaders = [];
      renderGroups();
      renderMatches();
      renderAwards();
      renderDashboard();
      renderBracket();
      renderSummary();
    }

    function runTournament() {
      const tMap = teamMap();
      if (Object.keys(groups).length !== 8) return;
      for (const g of Object.keys(groups)) {
        if ((groups[g] || []).length !== 4) return;
      }

      const all = [];
      tournamentStats = {};
      tournamentOverview = null;
      bestXI = null;

      let week = 1;
      const standings = {};

      for (const g of Object.keys(groups)) {
        const gt = groups[g];
        const sched = groupSchedule(gt);
        standings[g] = Object.fromEntries(
          gt.map(t => [t, { pts: 0, gf: 0, ga: 0, gd: 0 }])
        );
        for (let w = 0; w < sched.length; w++) {
          for (const p of sched[w]) {
            const A = tMap[p.home], B = tMap[p.away];
            if (!A || !B) continue;
            const [gA, gB] = simulateScore(A, B, goalEnv, homeAdv);
            const perfA = simulateTeamPerformance(A, gA, gB);
            const perfB = simulateTeamPerformance(B, gB, gA);

            perfA.playerStats.forEach(ps => recordPlayerStat(A, ps, gB));
            perfB.playerStats.forEach(ps => recordPlayerStat(B, ps, gA));

            const recA = standings[g][A.name];
            const recB = standings[g][B.name];
            recA.gf += gA; recA.ga += gB; recA.gd = recA.gf - recA.ga;
            recB.gf += gB; recB.ga += gA; recB.gd = recB.gf - recB.ga;
            if (gA > gB) recA.pts += 3;
            else if (gB > gA) recB.pts += 3;
            else { recA.pts++; recB.pts++; } // group games can draw

            const summary = makeSummary(
              A, B, gA, gB, undefined,
              [
                `${perfA.featured.name} ${perfA.featured.goals}G/${perfA.featured.assists}A`,
                `${perfB.featured.name} ${perfB.featured.goals}G/${perfB.featured.assists}A`
              ],
              null
            );

            all.push({
              id: `G-${g}-${w}-${A.name}-${B.name}`,
              round: `Group ${g}`,
              week,
              home: A.name,
              away: B.name,
              homeGoals: gA,
              awayGoals: gB,
              summary,
              starInvolvement: {
                [perfA.featured.name]: {
                  team: A.name,
                  goals: perfA.featured.goals,
                  assists: perfA.featured.assists,
                  rating: perfA.featured.rating
                },
                [perfB.featured.name]: {
                  team: B.name,
                  goals: perfB.featured.goals,
                  assists: perfB.featured.assists,
                  rating: perfB.featured.rating
                }
              },
              penShootout: null
            });
            week++;
          }
        }
      }

      function rankGroup(g) {
        const arr = Object.entries(standings[g]);
        arr.sort((a, b) =>
          b[1].pts - a[1].pts ||
          b[1].gd - a[1].gd ||
          b[1].gf - a[1].gf ||
          (Math.random() < 0.5 ? -1 : 1)
        );
        return arr.map(x => x[0]);
      }

      const order = Object.keys(groups).sort();
      const ranks = {};
      for (const g of order) ranks[g] = rankGroup(g);

      // Round of 16 pairings
      const r16Pairs = [];
      for (let i = 0; i < 8; i += 2) {
        const g1 = order[i], g2 = order[i + 1];
        r16Pairs.push([ranks[g1][0], ranks[g2][1]]);
        r16Pairs.push([ranks[g2][0], ranks[g1][1]]);
      }

      const r16Ties = [];
      const winnersR16 = r16Pairs.map(([a, b]) => {
        const t = twoLeg(all, tMap[a], tMap[b], "Round of 16");
        r16Ties.push({ a, b, aggA: t.aggA, aggB: t.aggB, winner: t.winner, pen: t.pen });
        return t.winner;
      });

      const qfPool = shuffle(winnersR16);
      const qfPairs = [];
      for (let i = 0; i < 8; i += 2) qfPairs.push([qfPool[i], qfPool[i + 1]]);
      const qfTies = [];
      const winnersQF = qfPairs.map(([a, b]) => {
        const t = twoLeg(all, tMap[a], tMap[b], "Quarterfinals");
        qfTies.push({ a, b, aggA: t.aggA, aggB: t.aggB, winner: t.winner, pen: t.pen });
        return t.winner;
      });

      const sfPool = shuffle(winnersQF);
      const sfPairs = [[sfPool[0], sfPool[1]], [sfPool[2], sfPool[3]]];
      const sfTies = [];
      const winnersSF = sfPairs.map(([a, b]) => {
        const t = twoLeg(all, tMap[a], tMap[b], "Semifinals");
        sfTies.push({ a, b, aggA: t.aggA, aggB: t.aggB, winner: t.winner, pen: t.pen });
        return t.winner;
      });

      const [fa, fb] = winnersSF;
      const A = tMap[fa], B = tMap[fb];
      let [gA, gB] = simulateScore(A, B, goalEnv, 0);
      const perfA = simulateTeamPerformance(A, gA, gB);
      const perfB = simulateTeamPerformance(B, gB, gA);

      perfA.playerStats.forEach(ps => recordPlayerStat(A, ps, gB));
      perfB.playerStats.forEach(ps => recordPlayerStat(B, ps, gA));

      let pen = null;
      let finalWinner;
      if (gA === gB) {
        pen = penaltyShootout(A, B);
        finalWinner = pen.winner;
      } else {
        finalWinner = gA > gB ? A.name : B.name;
      }

      const finalSummary = makeSummary(
        A, B, gA, gB, undefined,
        [
          `${perfA.featured.name} ${perfA.featured.goals}G/${perfA.featured.assists}A`,
          `${perfB.featured.name} ${perfB.featured.goals}G/${perfB.featured.assists}A`
        ],
        pen
      );

      all.push({
        id: `Final-${A.name}-${B.name}`,
        round: "Final",
        week,
        home: A.name,
        away: B.name,
        homeGoals: gA,
        awayGoals: gB,
        summary: finalSummary,
        starInvolvement: {
          [perfA.featured.name]: {
            team: A.name,
            goals: perfA.featured.goals,
            assists: perfA.featured.assists,
            rating: perfA.featured.rating
          },
          [perfB.featured.name]: {
            team: B.name,
            goals: perfB.featured.goals,
            assists: perfB.featured.assists,
            rating: perfB.featured.rating
          }
        },
        penShootout: pen
      });

      const finalTie = {
        a: A.name,
        b: B.name,
        aggA: gA,
        aggB: gB,
        winner: finalWinner,
        pen
      };

      matches = all;
      bracket = { r16: r16Ties, qf: qfTies, sf: sfTies, final: [finalTie] };

      // build leaders from tournamentStats
      const statArr = Object.values(tournamentStats).map(rec => ({
        ...rec,
        avg: rec.matches ? +(rec.ratingSum / rec.matches).toFixed(2) : 0
      }));
      statArr.sort((a, b) => b.avg - a.avg || b.goals - a.goals);
      leaders = statArr;

      // overview
      let totalGoals = 0;
      let totalMatches = matches.length;
      let biggestMargin = -1, biggestMatch = null;
      let highestTotal = -1, highestMatch = null;
      let pensCount = 0;

      for (const m of matches) {
        const goals = m.homeGoals + m.awayGoals;
        totalGoals += goals;
        const margin = Math.abs(m.homeGoals - m.awayGoals);
        if (margin > biggestMargin) { biggestMargin = margin; biggestMatch = m; }
        if (goals > highestTotal) { highestTotal = goals; highestMatch = m; }
        if (m.penShootout) pensCount++;
      }

      tournamentOverview = {
        totalGoals,
        totalMatches,
        avgGoals: totalMatches ? totalGoals / totalMatches : 0,
        biggestWin: { margin: biggestMargin, matchId: biggestMatch && biggestMatch.id },
        highestScoring: { goals: highestTotal, matchId: highestMatch && highestMatch.id },
        penaltyShootouts: pensCount
      };

      bestXI = computeBestXI();

      renderMatches();
      renderAwards();
      renderDashboard();
      renderBracket();
      renderSummary();
    }

    // ----- RENDERING -----

    function renderGroups() {
      groupsContainer.innerHTML = "";
      const groupKeys = Object.keys(groups);
      if (!groupKeys.length) {
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = 'Click <strong>Randomize Groups</strong> to generate eight historic groups.';
        groupsContainer.appendChild(div);
        return;
      }
      groupKeys.sort().forEach(g => {
        const card = document.createElement("div");
        card.className = "card";
        const title = document.createElement("div");
        title.className = "group-title";
        title.textContent = "Group " + g;
        card.appendChild(title);

        const ol = document.createElement("ol");
        ol.className = "group-list";
        groups[g].forEach(tname => {
          const li = document.createElement("li");
          const span = document.createElement("span");
          span.textContent = tname;
          const btn = document.createElement("button");
          btn.className = "star-btn" + (favorites.includes(tname) ? " active" : "");
          btn.textContent = favorites.includes(tname) ? "‚òÖ" : "‚òÜ";
          btn.addEventListener("click", () => {
            if (favorites.includes(tname)) {
              favorites = favorites.filter(x => x !== tname);
            } else {
              favorites.push(tname);
            }
            saveLocal("favorites", favorites);
            renderGroups();
          });
          li.appendChild(span);
          li.appendChild(btn);
          ol.appendChild(li);
        });
        card.appendChild(ol);
        groupsContainer.appendChild(card);
      });
    }

    function groupedMatches() {
      const m = {};
      for (const x of matches) {
        (m[x.round] ||= []).push(x);
      }
      for (const k of Object.keys(m)) {
        m[k].sort((a, b) => a.week - b.week || (a.leg || 0) - (b.leg || 0));
      }
      return m;
    }

    function renderMatches() {
      matchesContainer.innerHTML = "";
      if (!matches.length) {
        const div = document.createElement("div");
        div.className = "card";
        div.textContent = "No matches yet ‚Äî run the tournament.";
        matchesContainer.appendChild(div);
        return;
      }

      const grouped = groupedMatches();
      Object.keys(grouped).forEach(round => {
        const roundCard = document.createElement("div");
        roundCard.className = "card round-card";
        const title = document.createElement("div");
        title.className = "round-title";
        title.textContent = round;
        roundCard.appendChild(title);

        const list = document.createElement("div");
        list.className = "match-list";

        grouped[round].forEach(m => {
          const mc = document.createElement("div");
          mc.className = "match-card";

          const head = document.createElement("div");
          head.className = "match-header";
          const main = document.createElement("div");
          let line = `${m.home} ${m.homeGoals}‚Äì${m.awayGoals} ${m.away}`;
          if (m.penShootout) {
            line += ` (pens ${m.penShootout.scoreA}-${m.penShootout.scoreB})`;
          }
          main.textContent = line;
          head.appendChild(main);
          if (m.leg) {
            const legBadge = document.createElement("span");
            legBadge.className = "badge badge-cyan";
            legBadge.textContent = "Leg " + m.leg;
            head.appendChild(legBadge);
          }
          mc.appendChild(head);

          const summary = document.createElement("div");
          summary.className = "match-summary";
          summary.textContent = m.summary;
          mc.appendChild(summary);

          const starGrid = document.createElement("div");
          starGrid.className = "star-grid";
          Object.entries(m.starInvolvement).forEach(([player, s]) => {
            const chip = document.createElement("div");
            chip.className = "star-chip";
            const left = document.createElement("div");
            left.innerHTML = `<strong>${player}</strong> ‚Äî ${s.team}`;
            const right = document.createElement("div");
            const gSpan = document.createElement("span");
            gSpan.className = "badge";
            gSpan.textContent = `${s.goals}G`;
            const aSpan = document.createElement("span");
            aSpan.className = "badge badge-cyan";
            aSpan.textContent = `${s.assists}A`;
            const rSpan = document.createElement("span");
            rSpan.className = "badge badge-red";
            rSpan.textContent = s.rating.toFixed(2);
            right.appendChild(gSpan);
            right.appendChild(aSpan);
            right.appendChild(rSpan);
            chip.appendChild(left);
            chip.appendChild(right);
            starGrid.appendChild(chip);
          });
          mc.appendChild(starGrid);

          list.appendChild(mc);
        });

        roundCard.appendChild(list);
        matchesContainer.appendChild(roundCard);
      });
    }

    function getStatsArray() {
      return Object.values(tournamentStats).map(rec => ({
        ...rec,
        avg: rec.matches ? rec.ratingSum / rec.matches : 0
      }));
    }

    function renderAwards() {
      topScorersContainer.innerHTML = "";
      topAssistersContainer.innerHTML = "";
      topKeepersContainer.innerHTML = "";
      bestOverallContainer.innerHTML = "";

      const arr = getStatsArray();
      if (!arr.length) {
        const msg = "No stats yet ‚Äî run a tournament.";
        [topScorersContainer, topAssistersContainer, topKeepersContainer, bestOverallContainer].forEach(c => {
          c.textContent = msg;
        });
        return;
      }

      const scorers = arr
        .filter(p => p.goals > 0)
        .sort((a, b) => b.goals - a.goals || b.assists - a.assists || b.avg - a.avg)
        .slice(0, 15);
      const assisters = arr
        .filter(p => p.assists > 0)
        .sort((a, b) => b.assists - a.assists || b.goals - a.goals || b.avg - a.avg)
        .slice(0, 15);
      const keepers = arr
        .filter(p => p.isGK)
        .sort((a, b) =>
          b.cleanSheets - a.cleanSheets ||
          a.goalsAgainst - b.goalsAgainst ||
          b.avg - a.avg
        ).slice(0, 10);
      const best = arr
        .filter(p => !p.isGK)
        .sort((a, b) => b.avg - a.avg || b.goals - a.goals || b.assists - a.assists)
        .slice(0, 15);

      function listToCard(container, title, list, formatter) {
        if (!list.length) {
          container.textContent = "No data.";
          return;
        }
        const card = document.createElement("div");
        card.className = "round-award-card";
        const t = document.createElement("div");
        t.className = "round-award-title";
        t.textContent = title;
        card.appendChild(t);

        const ol = document.createElement("ol");
        ol.className = "simple-list";
        list.forEach(item => {
          const li = document.createElement("li");
          li.innerHTML = formatter(item);
          ol.appendChild(li);
        });
        card.appendChild(ol);
        container.appendChild(card);
      }

      listToCard(
        topScorersContainer,
        "Golden Boot Race",
        scorers,
        p => `<strong>${p.name}</strong> ‚Äî ${p.team} (${p.goals} goals, ${p.assists} assists, avg ${p.avg.toFixed(2)})`
      );
      listToCard(
        topAssistersContainer,
        "Playmakers",
        assisters,
        p => `<strong>${p.name}</strong> ‚Äî ${p.team} (${p.assists} assists, ${p.goals} goals, avg ${p.avg.toFixed(2)})`
      );
      listToCard(
        topKeepersContainer,
        "Golden Glove Contenders",
        keepers,
        p => `<strong>${p.name}</strong> ‚Äî ${p.team} (${p.cleanSheets} clean sheets, ${p.goalsAgainst} GA, avg ${p.avg.toFixed(2)})`
      );
      listToCard(
        bestOverallContainer,
        "Best Performers by Rating",
        best,
        p => `<strong>${p.name}</strong> ‚Äî ${p.team} (${p.position}, ${p.goals}G/${p.assists}A, avg ${p.avg.toFixed(2)})`
      );
    }

    function renderDashboard() {
      leadersTable.innerHTML = "";
      const headerRow = document.createElement("tr");
      headerRow.innerHTML = `
        <th>#</th>
        <th>Player</th>
        <th>Team</th>
        <th>Pos</th>
        <th>M</th>
        <th>G</th>
        <th>A</th>
        <th>Avg</th>
        <th>Impact</th>
      `;
      leadersTable.appendChild(headerRow);

      if (!leaders.length) {
        const row = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 9;
        td.textContent = "No leader data yet ‚Äî run the tournament.";
        row.appendChild(td);
        leadersTable.appendChild(row);
        return;
      }

      const top = leaders.slice(0, 15);
      const maxImpact = Math.max(
        ...top.map(l => l.goals + l.assists + (l.avg || 0))
      );

      top.forEach((l, idx) => {
        const tr = document.createElement("tr");
        const impact = l.goals + l.assists + (l.avg || 0);
        const width = maxImpact ? (impact / maxImpact) * 100 : 0;

        tr.innerHTML = `
          <td>${idx + 1}</td>
          <td>${l.name}</td>
          <td>${l.team}</td>
          <td>${l.isGK ? "GK" : l.position}</td>
          <td>${l.matches}</td>
          <td>${l.goals}</td>
          <td>${l.assists}</td>
          <td>${(l.avg || 0).toFixed(2)}</td>
        `;

        const impactTd = document.createElement("td");
        impactTd.className = "bar-cell";
        const bg = document.createElement("div");
        bg.className = "bar-bg";
        const fill = document.createElement("div");
        fill.className = "bar-fill";
        fill.style.width = width.toFixed(1) + "%";
        const label = document.createElement("div");
        label.className = "bar-label";
        label.textContent = impact.toFixed(1);
        impactTd.appendChild(bg);
        impactTd.appendChild(fill);
        impactTd.appendChild(label);
        tr.appendChild(impactTd);

        leadersTable.appendChild(tr);
      });
    }

    function renderManual() {
      manualHomeSelect.innerHTML = "";
      manualAwaySelect.innerHTML = "";
      teams.forEach(t => {
        const opt1 = document.createElement("option");
        opt1.value = t.name;
        opt1.textContent = t.name;
        const opt2 = document.createElement("option");
        opt2.value = t.name;
        opt2.textContent = t.name;
        manualHomeSelect.appendChild(opt1);
        manualAwaySelect.appendChild(opt2);
      });
      manualHomeSelect.value = manualHome;
      manualAwaySelect.value = manualAway;
      renderManualResult();
    }

    function renderManualResult() {
      manualResultContainer.innerHTML = "";
      if (!manualResult) return;
      const div = document.createElement("div");
      div.className = "manual-score-card";
      const score = document.createElement("div");
      score.style.fontWeight = "700";
      score.textContent = manualResult.score;
      const sum = document.createElement("div");
      sum.style.color = THEME.sub;
      sum.style.fontSize = "14px";
      sum.style.marginTop = "4px";
      sum.textContent = manualResult.summary;
      div.appendChild(score);
      div.appendChild(sum);
      manualResultContainer.appendChild(div);
    }

    function renderBracket() {
      bracketContainer.innerHTML = "";
      const colTitles = ["Round of 16", "Quarterfinals", "Semifinals", "Final"];
      const cols = [bracket.r16, bracket.qf, bracket.sf, bracket.final];

      colTitles.forEach((title, idx) => {
        const ties = cols[idx] || [];
        const col = document.createElement("div");
        col.className = "bracket-col";
        const tTitle = document.createElement("div");
        tTitle.className = "bracket-title";
        tTitle.textContent = title;
        col.appendChild(tTitle);

        const wrap = document.createElement("div");
        wrap.className = "bracket-ties";

        ties.forEach((t, i) => {
          const tieCard = document.createElement("div");
          tieCard.className = "tie-card";

          const rowA = document.createElement("div");
          rowA.className = "tie-row";
          rowA.innerHTML = `<div style="font-weight:700;">${t.a}</div>
            <div class="badge">${t.aggA}</div>`;
          const rowB = document.createElement("div");
          rowB.className = "tie-row";
          rowB.innerHTML = `<div style="font-weight:700;">${t.b}</div>
            <div class="badge">${t.aggB}</div>`;
          const winner = document.createElement("div");
          winner.className = "tie-winner";

          let penText = "";
          if (t.pen) {
            penText = ` (pens ${t.pen.scoreA}-${t.pen.scoreB})`;
          }

          winner.innerHTML = `Winner: <span style="font-weight:800;color:${THEME.accent};">${t.winner}</span>${penText}`;

          tieCard.appendChild(rowA);
          tieCard.appendChild(rowB);
          tieCard.appendChild(winner);
          wrap.appendChild(tieCard);
        });

        col.appendChild(wrap);
        bracketContainer.appendChild(col);
      });
    }

    function computeBestXI() {
      const arr = getStatsArray();
      if (!arr.length) return null;

      const withAvg = arr.map(p => ({ ...p, avg: p.avg || (p.matches ? p.ratingSum / p.matches : 0) }));
      const gks = withAvg.filter(p => p.isGK);
      const dfs = withAvg.filter(p => !p.isGK && p.position === "DF");
      const mfs = withAvg.filter(p => !p.isGK && p.position === "MF");
      const fws = withAvg.filter(p => !p.isGK && p.position === "FW");

      const score = p => p.avg + 0.3 * p.goals + 0.15 * p.assists;

      gks.sort((a, b) =>
        b.cleanSheets - a.cleanSheets ||
        b.avg - a.avg
      );
      dfs.sort((a, b) => score(b) - score(a));
      mfs.sort((a, b) => score(b) - score(a));
      fws.sort((a, b) => score(b) - score(a));

      const bestGK = gks[0] || null;
      const bestDF = dfs.slice(0, 4);
      const bestMF = mfs.slice(0, 3);
      const bestFW = fws.slice(0, 3);

      return {
        formation: "4-3-3",
        goalkeeper: bestGK,
        defenders: bestDF,
        midfielders: bestMF,
        forwards: bestFW
      };
    }

    function renderSummary() {
      summaryOverview.innerHTML = "";
      summaryBestXI.innerHTML = "";

      if (!tournamentOverview || !matches.length) {
        summaryOverview.textContent = "Run a tournament to see the full recap.";
        summaryBestXI.textContent = "Best XI will appear once a tournament has been played.";
        return;
      }

      const ov = tournamentOverview;
      const overviewList = document.createElement("ul");
      overviewList.className = "simple-list";

      overviewList.innerHTML = `
        <li>Total matches: <strong>${ov.totalMatches}</strong></li>
        <li>Total goals: <strong>${ov.totalGoals}</strong></li>
        <li>Average goals per match: <strong>${ov.avgGoals.toFixed(2)}</strong></li>
        <li>Penalty shootouts: <strong>${ov.penaltyShootouts}</strong></li>
      `;

      function matchLineById(id) {
        const m = matches.find(x => x.id === id);
        if (!m) return "Data unavailable.";
        let extra = "";
        if (m.penShootout) {
          extra = ` (pens ${m.penShootout.scoreA}-${m.penShootout.scoreB})`;
        }
        return `${m.round}: ${m.home} ${m.homeGoals}‚Äì${m.awayGoals} ${m.away}${extra}`;
      }

      const extra = document.createElement("div");
      extra.style.marginTop = "6px";
      extra.style.fontSize = "0.85rem";
      extra.style.color = THEME.sub;
      extra.innerHTML = `
        <div>Biggest winning margin: <strong>${ov.biggestWin.margin}</strong> ‚Äî ${matchLineById(ov.biggestWin.matchId)}</div>
        <div>Highest-scoring match: <strong>${ov.highestScoring.goals} goals</strong> ‚Äî ${matchLineById(ov.highestScoring.matchId)}</div>
      `;

      summaryOverview.appendChild(overviewList);
      summaryOverview.appendChild(extra);

      if (!bestXI) {
        summaryBestXI.textContent = "Best XI will appear once a tournament has been played.";
        return;
      }

      const xi = bestXI;

      function lineFor(p) {
        if (!p) return "";
        const avg = p.avg || (p.matches ? p.ratingSum / p.matches : 0);
        return `<strong>${p.name}</strong> ‚Äî ${p.team} (${p.position}, ${p.goals}G/${p.assists}A, avg ${avg.toFixed(2)})`;
      }

      const gkHtml = xi.goalkeeper ? lineFor(xi.goalkeeper) : "No goalkeeper recorded.";
      const dfHtml = xi.defenders.map(lineFor).map(l => `<li>${l}</li>`).join("");
      const mfHtml = xi.midfielders.map(lineFor).map(l => `<li>${l}</li>`).join("");
      const fwHtml = xi.forwards.map(lineFor).map(l => `<li>${l}</li>`).join("");

      summaryBestXI.innerHTML = `
        <div style="margin-bottom:6px;font-size:0.85rem;color:${THEME.sub};">
          Formation: <strong>${xi.formation}</strong>
        </div>
        <div style="margin-bottom:6px;">
          <div style="font-weight:700;color:${THEME.accent2};margin-bottom:4px;">Goalkeeper</div>
          <div>${gkHtml}</div>
        </div>
        <div style="margin-bottom:6px;">
          <div style="font-weight:700;color:${THEME.accent2};margin-bottom:4px;">Defenders</div>
          <ol class="simple-list">${dfHtml || "<li>No defenders recorded.</li>"}</ol>
        </div>
        <div style="margin-bottom:6px;">
          <div style="font-weight:700;color:${THEME.accent2};margin-bottom:4px;">Midfielders</div>
          <ol class="simple-list">${mfHtml || "<li>No midfielders recorded.</li>"}</ol>
        </div>
        <div>
          <div style="font-weight:700;color:${THEME.accent2};margin-bottom:4px;">Forwards</div>
          <ol class="simple-list">${fwHtml || "<li>No forwards recorded.</li>"}</ol>
        </div>
      `;
    }

    // ----- CSV EXPORTS -----

    function downloadCSV(text, filename) {
      const blob = new Blob([text], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function exportMatchesCSV() {
      if (!matches.length) return;
      const rows = matches.map(m =>
        [
          m.round,
          m.leg || "",
          m.week,
          m.home,
          m.homeGoals,
          m.awayGoals,
          m.away,
          m.penShootout ? `pens ${m.penShootout.scoreA}-${m.penShootout.scoreB}` : "",
          `"${(m.summary || "").replace(/"/g, '""')}"`
        ].join(",")
      );
      const csv =
        "round,leg,week,home,homeGoals,awayGoals,away,penalties,summary\n" +
        rows.join("\n");
      downloadCSV(csv, "matches.csv");
    }

    function exportLeadersCSV() {
      const arr = getStatsArray();
      if (!arr.length) return;
      const rows = arr.map(l =>
        [
          l.name,
          l.team,
          l.position,
          l.matches,
          l.goals,
          l.assists,
          l.isGK ? l.cleanSheets : "",
          l.isGK ? l.goalsAgainst : "",
          (l.avg || 0).toFixed(2)
        ].join(",")
      );
      const csv =
        "Player,Team,Position,Matches,Goals,Assists,CleanSheets,GoalsAgainst,AvgRating\n" +
        rows.join("\n");
      downloadCSV(csv, "players.csv");
    }

    // ----- MANUAL SIM -----

    function simulateManual() {
      const tMap = teamMap();
      const A = tMap[manualHome];
      const B = tMap[manualAway];
      if (!A || !B) return;
      const [gA, gB] = simulateScore(A, B, goalEnv, homeAdv);
      const perfA = simulateTeamPerformance(A, gA, gB);
      const perfB = simulateTeamPerformance(B, gB, gA);
      const summary = makeSummary(
        A, B, gA, gB, undefined,
        [
          `${perfA.featured.name} ${perfA.featured.goals}G/${perfA.featured.assists}A`,
          `${perfB.featured.name} ${perfB.featured.goals}G/${perfB.featured.assists}A`
        ],
        null
      );
      manualResult = {
        score: `${A.name} ${gA}-${gB} ${B.name}`,
        summary
      };
      renderManualResult();
    }

    // ----- SAVE / LOAD -----

    function exportSave() {
      saveLocal("saveData", { teams, favorites, seed, goalEnv, homeAdv });
      alert("Save exported to localStorage.");
    }

    function importSave() {
      const s = loadLocal("saveData", null);
      if (!s) return alert("No saved data.");
      teams = (s.teams || teams).map(buildSquad);
      favorites = s.favorites || [];
      seed = s.seed || "42";
      if (typeof s.goalEnv === "number") goalEnv = s.goalEnv;
      if (typeof s.homeAdv === "number") homeAdv = s.homeAdv;
      seedInput.value = seed;
      goalEnvRange.value = goalEnv;
      homeAdvRange.value = homeAdv;
      goalEnvLabel.textContent = goalEnv.toFixed(2);
      homeAdvLabel.textContent = homeAdv.toFixed(2);
      renderGroups();
      renderManual();
      alert("Save imported.");
    }

    // ----- EVENT LISTENERS -----

    seedInput.addEventListener("input", () => {
      seed = seedInput.value;
      saveLocal("seed", seed);
    });

    goalEnvRange.addEventListener("input", () => {
      goalEnv = parseFloat(goalEnvRange.value);
      goalEnvLabel.textContent = goalEnv.toFixed(2);
      saveLocal("goalEnv", goalEnv);
    });

    homeAdvRange.addEventListener("input", () => {
      homeAdv = parseFloat(homeAdvRange.value);
      homeAdvLabel.textContent = homeAdv.toFixed(2);
      saveLocal("homeAdv", homeAdv);
    });

    quickResimBtn.addEventListener("click", () => {
      randomizeGroups();
      runTournament();
    });

    randomizeGroupsBtn.addEventListener("click", () => {
      randomizeGroups();
    });

    runTournamentBtn.addEventListener("click", () => {
      runTournament();
    });

    exportMatchesBtn.addEventListener("click", exportMatchesCSV);
    exportLeadersBtn.addEventListener("click", exportLeadersCSV);

    soundBtn.addEventListener("click", () => {
      soundOn = !soundOn;
      saveLocal("soundOn", soundOn);
      soundBtn.textContent = soundOn ? "üîä Sound On" : "üîá Sound Off";
    });

    exportSaveBtn.addEventListener("click", exportSave);
    importSaveBtn.addEventListener("click", importSave);

    manualHomeSelect.addEventListener("change", () => {
      manualHome = manualHomeSelect.value;
    });
    manualAwaySelect.addEventListener("change", () => {
      manualAway = manualAwaySelect.value;
    });
    manualSimBtn.addEventListener("click", simulateManual);

    window.addEventListener("keydown", e => {
      const key = e.key.toLowerCase();
      if (key === "r") {
        randomizeGroups();
        runTournament();
      } else if (key === "s") {
        runTournament();
      }
    });

    // ----- INITIAL BOOT -----
    randomizeGroups();
    renderManual();
    renderDashboard();
    renderBracket();
    renderAwards();
    renderSummary();
  </script>
</body>
</html>
