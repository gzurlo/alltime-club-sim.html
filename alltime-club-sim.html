<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚽</text></svg>">
  <meta charset="UTF-8">
  <title>All-Time Football Simulator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Simulate epic football tournaments with all-time great teams. Create custom tournaments, track statistics, and crown champions in this comprehensive football simulator.">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>
  <style>
    :root {
      /* Primary Actions */
      --color-primary: #10b981;
      --color-secondary: #3b82f6;
      --color-accent: #f59e0b;
      --color-danger: #ef4444;
      --color-purple: #a855f7;

      /* Tournament Stage Colors */
      --color-groups: #3b82f6;
      --color-knockout: #f59e0b;
      --color-final: #fbbf24;

      /* Status Colors */
      --color-win: #10b981;
      --color-draw: #94a3b8;
      --color-loss: #ef4444;

      /* Background Layers */
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-tertiary: #334155;

      /* Text Colors */
      --text-primary: #f7fafc;
      --text-secondary: #d1d5db;
      --text-muted: #9ca3af;
    }

    *, *::before, *::after {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      min-height: 100%;
    }

    body {
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: linear-gradient(135deg, #0a1628 0%, #0f1419 50%, #050a0f 100%);
      background-attachment: fixed;
      color: #f7fafc;
      transition: background 0.3s ease, color 0.3s ease;
      position: relative;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background:
        radial-gradient(circle at 20% 50%, rgba(16, 185, 129, 0.08) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(59, 130, 246, 0.08) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
    }

    .page {
      max-width: 1600px;
      margin: 0 auto;
      padding: 20px 16px 24px;
      position: relative;
      z-index: 1;
      box-sizing: border-box;
    }

    @media (max-width: 640px) {
      .page {
        padding: 12px 8px 16px;
      }

      header {
        padding: 16px;
        flex-direction: column;
        gap: 12px;
      }
    }

    header {
      padding: 20px 24px;
      border-radius: 16px;
      background: linear-gradient(135deg, rgba(17, 24, 39, 0.98), rgba(31, 41, 55, 0.95));
      /* backdrop-filter removed for performance */
      border: 1px solid rgba(16, 185, 129, 0.4);
      box-shadow:
        0 4px 24px rgba(0, 0, 0, 0.4),
        0 0 0 1px rgba(16, 185, 129, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
      margin-bottom: 24px;
      display: flex;
      justify-content: space-between;
      gap: 20px;
      align-items: center;
      position: relative;
      overflow: hidden;
    }

    header::before {
      content: '⚽';
      position: absolute;
      right: -20px;
      top: -20px;
      font-size: 140px;
      opacity: 0.03;
      transform: rotate(-15deg);
      pointer-events: none;
    }

    .title-block {
      display: flex;
      flex-direction: column;
      gap: 6px;
      position: relative;
      z-index: 1;
    }

    h1 {
      font-size: clamp(1.5rem, 4vw, 2rem);
      letter-spacing: 0.5px;
      font-weight: 800;
      background: linear-gradient(135deg, #10b981 0%, #34d399 50%, #6ee7b7 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: none;
      position: relative;
    }

    h1::after {
      content: '';
      position: absolute;
      bottom: -4px;
      left: 0;
      width: 60px;
      height: 3px;
      background: linear-gradient(90deg, #10b981, transparent);
      border-radius: 2px;
    }

    .subtitle {
      font-size: 0.875rem;
      color: #94a3b8;
      font-weight: 500;
    }

    .tagline-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }

    .chip {
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 0.7rem;
      font-weight: 600;
      letter-spacing: 0.03em;
      border: 1px solid rgba(16, 185, 129, 0.3);
      background: rgba(16, 185, 129, 0.1);
      color: #6ee7b7;
      /* backdrop-filter removed for performance */
      transition: all 0.2s ease;
    }

    .chip:hover {
      border-color: rgba(16, 185, 129, 0.5);
      background: rgba(16, 185, 129, 0.15);
      transform: translateY(-1px);
    }

    .right-header {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 8px;
    }

    .theme-toggle-btn {
      padding: 10px 18px;
      border-radius: 12px;
      font-size: 0.875rem;
      border: 1px solid rgba(16, 185, 129, 0.3);
      cursor: pointer;
      font-weight: 600;
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(6, 78, 59, 0.2));
      /* backdrop-filter removed for performance */
      color: #10b981;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
    }

    .theme-toggle-btn:hover {
      border-color: rgba(16, 185, 129, 0.5);
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.3), rgba(6, 78, 59, 0.3));
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(16, 185, 129, 0.2);
    }

    .rng-mini {
      font-size: 0.75rem;
      color: #bee3f8;
    }

    /* .page styling defined above at lines 78-85 - removed duplicate */

    .layout {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 20px;
      align-items: start;
    }

    /* SIDEBAR */

    .sidebar {
      background: linear-gradient(135deg, rgba(17, 24, 39, 0.95), rgba(31, 41, 55, 0.9));
      /* backdrop-filter removed for performance */
      border-radius: 16px;
      padding: 20px;
      border: 1px solid rgba(59, 130, 246, 0.3);
      box-shadow:
        0 4px 24px rgba(0, 0, 0, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
      position: sticky;
      top: 20px;
      max-height: calc(100vh - 40px);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    .sidebar::-webkit-scrollbar {
      width: 6px;
    }

    .sidebar::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 3px;
    }

    .sidebar::-webkit-scrollbar-thumb {
      background: rgba(59, 130, 246, 0.3);
      border-radius: 3px;
    }

    .sidebar::-webkit-scrollbar-thumb:hover {
      background: rgba(59, 130, 246, 0.5);
    }

    /* Accessibility: Focus styles */
    button:focus-visible,
    a:focus-visible,
    select:focus-visible,
    input:focus-visible {
      outline: 2px solid var(--color-primary);
      outline-offset: 2px;
    }

    /* Error Display System */
    .error-banner {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(239, 68, 68, 0.95);
      color: white;
      padding: 16px 24px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      z-index: 10005;
      animation: slideInRight 0.3s ease;
      max-width: 400px;
    }

    @keyframes slideInRight {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .error-banner button {
      background: none;
      border: none;
      color: white;
      font-size: 1.5em;
      cursor: pointer;
      padding: 0 8px;
    }

    /* Loading States */
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid rgba(59, 130, 246, 0.2);
      flex-shrink: 0;
    }

    .sidebar-header-title {
      font-size: 0.95rem;
      font-weight: 700;
      letter-spacing: 0.03em;
      color: #e0e7ff;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .sidebar-header-title::before {
      content: '⚽';
      font-size: 1.1rem;
    }

    .teams-pill {
      padding: 4px 12px;
      border-radius: 999px;
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(37, 99, 235, 0.2));
      color: #93c5fd;
      font-size: 0.75rem;
      font-weight: 600;
      border: 1px solid rgba(59, 130, 246, 0.3);
    }

    /* MANAGER PROFILE CARD */
    .manager-profile-card {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(6, 78, 59, 0.1));
      border: 1px solid rgba(16, 185, 129, 0.3);
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      flex-shrink: 0;
    }

    .manager-profile-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .manager-profile-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.3), rgba(6, 78, 59, 0.3));
      border: 2px solid rgba(16, 185, 129, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
      flex-shrink: 0;
    }

    .manager-profile-info {
      flex: 1;
      min-width: 0;
    }

    .manager-profile-name {
      font-size: 0.9rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 3px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .mini-btn {
      padding: 3px 8px;
      font-size: 0.7rem;
      background: rgba(59, 130, 246, 0.2);
      border: 1px solid rgba(59, 130, 246, 0.3);
      border-radius: 4px;
      color: #3b82f6;
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: 600;
    }

    .mini-btn:hover {
      background: rgba(59, 130, 246, 0.3);
      border-color: rgba(59, 130, 246, 0.5);
      transform: translateY(-1px);
    }

    .manager-profile-level {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.7rem;
    }

    .manager-level-badge {
      padding: 2px 6px;
      border-radius: 3px;
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.3), rgba(6, 78, 59, 0.3));
      border: 1px solid rgba(16, 185, 129, 0.5);
      color: #10b981;
      font-weight: 600;
      font-size: 0.7rem;
    }

    .manager-level-xp {
      color: var(--text-secondary);
      font-size: 0.65rem;
    }

    .manager-xp-bar {
      width: 100%;
      height: 4px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 2px;
      overflow: hidden;
      margin-bottom: 8px;
    }

    .manager-xp-fill {
      height: 100%;
      background: linear-gradient(90deg, #10b981, #059669);
      border-radius: 2px;
      transition: width 0.5s ease;
      box-shadow: 0 0 6px rgba(16, 185, 129, 0.5);
    }

    .manager-profile-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
    }

    .manager-stat {
      text-align: center;
      padding: 6px 4px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 6px;
      border: 1px solid rgba(16, 185, 129, 0.2);
    }

    .manager-stat-value {
      font-size: 0.95rem;
      font-weight: 700;
      color: #10b981;
      margin-bottom: 2px;
      line-height: 1;
    }

    .manager-stat-label {
      font-size: 0.6rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.3px;
      line-height: 1.2;
    }

    /* PROFILE TAB STYLES */
    .profile-section {
      background: rgba(0, 0, 0, 0.2);
      border: 1px solid rgba(59, 130, 246, 0.2);
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 10px;
      flex-shrink: 0;
    }

    .profile-section-header {
      display: flex;
      align-items: center;
      gap: 5px;
      margin-bottom: 8px;
      padding-bottom: 5px;
      border-bottom: 1px solid rgba(59, 130, 246, 0.2);
    }

    .profile-section-icon {
      font-size: 1rem;
    }

    .profile-section-title {
      font-size: 0.8rem;
      font-weight: 700;
      color: var(--text-primary);
      letter-spacing: 0.3px;
    }

    .profile-stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
    }

    .profile-stat-card {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(37, 99, 235, 0.05));
      border: 1px solid rgba(59, 130, 246, 0.3);
      border-radius: 10px;
      padding: 14px;
      display: flex;
      align-items: center;
      gap: 12px;
      transition: all 0.2s ease;
    }

    .profile-stat-card:hover {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(37, 99, 235, 0.1));
      border-color: rgba(59, 130, 246, 0.5);
      transform: translateY(-2px);
    }

    .profile-stat-icon {
      font-size: 1.4rem;
      flex-shrink: 0;
    }

    .profile-stat-content {
      flex: 1;
      min-width: 0;
    }

    .profile-stat-value {
      font-size: 1.4rem;
      font-weight: 700;
      color: var(--color-primary);
      line-height: 1.1;
    }

    .profile-stat-label {
      font-size: 0.95rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.3px;
      margin-top: 1px;
      opacity: 0.9;
    }

    .profile-best-tournament {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 6px;
      padding: 10px;
    }

    .profile-empty-state {
      text-align: center;
      padding: 16px;
    }

    .profile-empty-icon {
      font-size: 2rem;
      margin-bottom: 6px;
      opacity: 0.5;
    }

    .profile-empty-text {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .profile-achievements {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .profile-achievement-card {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(6, 78, 59, 0.05));
      border: 1px solid rgba(16, 185, 129, 0.3);
      border-radius: 6px;
      padding: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s ease;
    }

    .profile-achievement-card.locked {
      background: rgba(0, 0, 0, 0.2);
      border-color: rgba(100, 100, 100, 0.3);
      opacity: 0.6;
    }

    .profile-achievement-card:not(.locked):hover {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(6, 78, 59, 0.1));
      transform: translateX(4px);
    }

    .profile-achievement-icon {
      font-size: 1.5rem;
      flex-shrink: 0;
      filter: grayscale(0);
    }

    .profile-achievement-card.locked .profile-achievement-icon {
      filter: grayscale(1);
      opacity: 0.5;
    }

    .profile-achievement-info {
      flex: 1;
      min-width: 0;
    }

    .profile-achievement-name {
      font-size: 0.8rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 2px;
    }

    .profile-achievement-card.locked .profile-achievement-name {
      color: var(--text-muted);
    }

    .profile-achievement-desc {
      font-size: 0.7rem;
      color: var(--text-secondary);
      line-height: 1.3;
    }

    .profile-achievement-progress {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 4px;
    }

    .profile-achievement-progress-bar {
      flex: 1;
      height: 4px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 2px;
      overflow: hidden;
    }

    .profile-achievement-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #10b981, #059669);
      border-radius: 2px;
      transition: width 0.3s ease;
    }

    .profile-achievement-progress-text {
      font-size: 0.65rem;
      color: var(--text-muted);
      white-space: nowrap;
    }

    .profile-achievement-badge {
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.65rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .profile-achievement-badge.common {
      background: rgba(156, 163, 175, 0.2);
      color: #9ca3af;
      border: 1px solid rgba(156, 163, 175, 0.3);
    }

    .profile-achievement-badge.uncommon {
      background: rgba(16, 185, 129, 0.2);
      color: #10b981;
      border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .profile-achievement-badge.rare {
      background: rgba(59, 130, 246, 0.2);
      color: #3b82f6;
      border: 1px solid rgba(59, 130, 246, 0.3);
    }

    .profile-achievement-badge.epic {
      background: rgba(168, 85, 247, 0.2);
      color: #a855f7;
      border: 1px solid rgba(168, 85, 247, 0.3);
    }

    .profile-achievement-badge.legendary {
      background: rgba(251, 191, 36, 0.2);
      color: #fbbf24;
      border: 1px solid rgba(251, 191, 36, 0.3);
    }

    /* TAB NAVIGATION */
    .sidebar-tabs {
      display: flex;
      gap: 6px;
      margin-bottom: 10px;
      padding: 6px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
      border: 1px solid rgba(59, 130, 246, 0.15);
      flex-shrink: 0;
      flex-wrap: wrap;
    }

    .sidebar-tab {
      flex: 1;
      min-width: 48%;
      padding: 10px 8px;
      border: none;
      background: transparent;
      color: #94a3b8;
      font-size: 0.9rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      border-radius: 7px;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
    }

    .sidebar-tab:hover {
      background: rgba(59, 130, 246, 0.1);
      color: #cbd5e1;
    }

    .sidebar-tab.active {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(37, 99, 235, 0.3));
      color: #e0f2fe;
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
      border: 1px solid rgba(59, 130, 246, 0.4);
    }

    .sidebar-tab.active::after {
      content: '';
      position: absolute;
      bottom: -4px;
      left: 50%;
      transform: translateX(-50%);
      width: 20px;
      height: 2px;
      background: #3b82f6;
      border-radius: 2px;
    }

    .sidebar-tabs {
      flex-shrink: 0;
    }

    .tab-content {
      display: none;
      overflow-y: auto;
      overflow-x: hidden;
      flex: 1;
      min-height: 0;
      padding-right: 4px;
      padding-bottom: 8px;
    }

    .tab-content.active {
      display: flex;
      flex-direction: column;
    }

    .tab-content::-webkit-scrollbar {
      width: 6px;
    }

    .tab-content::-webkit-scrollbar-track {
      background: rgba(15, 23, 42, 0.3);
      border-radius: 3px;
    }

    .tab-content::-webkit-scrollbar-thumb {
      background: rgba(59, 130, 246, 0.5);
      border-radius: 3px;
    }

    .tab-content::-webkit-scrollbar-thumb:hover {
      background: rgba(59, 130, 246, 0.7);
    }

    .control-column {
      display: flex;
      flex-direction: column;
      gap: 12px;
      width: 100%;
      overflow-x: hidden;
      padding-bottom: 12px;
      min-height: min-content;
    }

    .ctrl-btn {
      width: 100%;
      text-align: left;
      padding: 16px 16px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.875rem;
      font-weight: 600;
      color: #f1f5f9;
      box-shadow:
        0 2px 8px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
      position: relative;
      overflow: hidden;
      transition: all 0.2s ease;
      /* backdrop-filter removed for performance */
    }

    .ctrl-btn-main {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .ctrl-btn-title {
      font-size: 1.05rem;
      font-weight: 700;
    }

    .ctrl-btn-subtitle {
      font-size: 0.9rem;
      opacity: 0.9;
      font-weight: 400;
    }

    .ctrl-btn-tag {
      font-size: 0.65rem;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(0, 0, 0, 0.3);
      /* backdrop-filter removed for performance */
      font-weight: 600;
    }

    .ctrl-btn::before {
      content: "";
      position: absolute;
      top: 50%;
      left: -30%;
      width: 40%;
      height: 220%;
      background: linear-gradient(115deg, rgba(255, 255, 255, 0.4), transparent 60%);
      transform: translateY(-50%) skewX(-20deg);
      opacity: 0;
      transition: opacity 0.25s ease, transform 0.25s ease;
    }

    .ctrl-btn:hover::before {
      opacity: 1;
      transform: translate(150%, -50%) skewX(-20deg);
    }

    .ctrl-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow:
        0 4px 16px rgba(0, 0, 0, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.15);
      border-color: rgba(255, 255, 255, 0.2);
    }

    .ctrl-btn:active:not(:disabled) {
      transform: translateY(0);
    }

    .ctrl-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      filter: grayscale(0.5);
    }

    .btn-green {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.9), rgba(5, 150, 105, 0.9));
      border-color: rgba(16, 185, 129, 0.3);
    }

    .btn-green:hover:not(:disabled) {
      background: linear-gradient(135deg, rgba(16, 185, 129, 1), rgba(5, 150, 105, 1));
      box-shadow:
        0 4px 20px rgba(16, 185, 129, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.15);
    }

    .btn-blue {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.9), rgba(37, 99, 235, 0.9));
      border-color: rgba(59, 130, 246, 0.3);
    }

    .btn-blue:hover:not(:disabled) {
      background: linear-gradient(135deg, rgba(59, 130, 246, 1), rgba(37, 99, 235, 1));
      box-shadow:
        0 4px 20px rgba(59, 130, 246, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.15);
    }

    .btn-orange {
      background: linear-gradient(135deg, rgba(249, 115, 22, 0.9), rgba(234, 88, 12, 0.9));
      border-color: rgba(249, 115, 22, 0.3);
    }

    .btn-orange:hover:not(:disabled) {
      background: linear-gradient(135deg, rgba(249, 115, 22, 1), rgba(234, 88, 12, 1));
      box-shadow:
        0 4px 20px rgba(249, 115, 22, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.15);
    }

    .btn-purple {
      background: linear-gradient(135deg, rgba(168, 85, 247, 0.9), rgba(147, 51, 234, 0.9));
      border-color: rgba(168, 85, 247, 0.3);
    }

    .btn-purple:hover:not(:disabled) {
      background: linear-gradient(135deg, rgba(168, 85, 247, 1), rgba(147, 51, 234, 1));
      box-shadow:
        0 4px 20px rgba(168, 85, 247, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.15);
    }

    .btn-gray {
      background: linear-gradient(135deg, rgba(71, 85, 105, 0.9), rgba(51, 65, 85, 0.9));
      border-color: rgba(71, 85, 105, 0.3);
    }

    .btn-red {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.9), rgba(220, 38, 38, 0.9));
      border-color: rgba(239, 68, 68, 0.3);
    }

    .btn-red:hover:not(:disabled) {
      background: linear-gradient(135deg, rgba(239, 68, 68, 1), rgba(220, 38, 38, 1));
      box-shadow:
        0 4px 20px rgba(239, 68, 68, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.15);
    }

    .file-row {
      display: flex;
      flex-direction: column;
      gap: 5px;
      margin-bottom: 8px;
    }

    .rng-block {
      padding: 12px;
      border-radius: 10px;
      background: rgba(15, 23, 42, 0.6);
      /* backdrop-filter removed for performance */
      border: 1px solid rgba(59, 130, 246, 0.2);
      font-size: 0.8rem;
      color: #cbd5e1;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.05);
      margin-bottom: 8px;
      flex-shrink: 0;
    }

    .rng-block label {
      display: block;
      margin-bottom: 6px;
      font-weight: 700;
      color: #e0e7ff;
      font-size: 0.8rem;
    }

    .rng-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .rng-row input[type="range"] {
      flex: 1;
      height: 6px;
      border-radius: 3px;
      background: rgba(71, 85, 105, 0.5);
      outline: none;
      -webkit-appearance: none;
      appearance: none;
    }

    .rng-row input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4);
      transition: all 0.2s ease;
    }

    .rng-row input[type="range"]::-webkit-slider-thumb:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.6);
    }

    .rng-row input[type="range"]::-moz-range-thumb {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      cursor: pointer;
      border: none;
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4);
      transition: all 0.2s ease;
    }

    .rng-row input[type="range"]::-moz-range-thumb:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.6);
    }

    .rng-presets {
      margin-top: 8px;
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .rng-pill {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.3);
      padding: 5px 12px;
      font-size: 0.75rem;
      background: rgba(15, 23, 42, 0.5);
      /* backdrop-filter removed for performance */
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s ease;
    }

    .rng-pill:hover {
      border-color: rgba(59, 130, 246, 0.5);
      background: rgba(59, 130, 246, 0.2);
      transform: translateY(-1px);
    }

    .rng-pill.active {
      border-color: rgba(16, 185, 129, 0.6);
      background: rgba(16, 185, 129, 0.2);
      color: #6ee7b7;
    }

    /* MAIN PANEL */

    .panel {
      background: linear-gradient(135deg, rgba(17, 24, 39, 0.95), rgba(31, 41, 55, 0.9));
      /* backdrop-filter removed for performance */
      border-radius: 16px;
      padding: 24px;
      border: 1px solid rgba(16, 185, 129, 0.3);
      box-shadow:
        0 4px 24px rgba(0, 0, 0, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
      min-height: 500px;
      position: relative;
    }

    .panel::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle, rgba(16, 185, 129, 0.03) 0%, transparent 70%);
      pointer-events: none;
    }

    #output {
      width: 100%;
      height: 100%;
      position: relative;
      z-index: 1;
    }

    h2, h3 {
      margin: 8px 0 12px;
      background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-size: 1.75rem;
      font-weight: 800;
      letter-spacing: -0.02em;
    }

    .output-sub {
      font-size: 0.95rem;
      color: #94a3b8;
      margin-bottom: 16px;
      line-height: 1.6;
    }

    .group-grid {
      margin-top: 8px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 10px;
    }

    .group-card {
      border-radius: 10px;
      background: linear-gradient(135deg, rgba(10, 25, 47, 0.96), rgba(5, 20, 13, 0.97));
      border: 1px solid rgba(72, 187, 120, 0.8);
      padding: 8px 8px 7px;
      font-size: 0.8rem;
      box-shadow: 0 8px 18px rgba(0, 0, 0, 0.6);
    }

    .group-title {
      font-size: 0.95rem;
      font-weight: 800;
      color: #a7f3d0;
      text-align: center;
      margin-bottom: 5px;
    }

    .team-list {
      list-style: none;
    }

    .team-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 4px 6px;
      border-radius: 6px;
      background: rgba(10, 25, 47, 0.9);
      border: 1px solid rgba(66, 153, 225, 0.6);
      margin-bottom: 3px;
    }

    .team-name {
      font-weight: 600;
      color: #edf2f7;
      font-size: 0.85rem;
    }

    .team-ovr {
      font-size: 0.75rem;
      color: #9ae6b4;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      border-radius: 8px;
      overflow: hidden;
      margin-top: 5px;
      font-size: 0.75rem;
      table-layout: auto;
    }

    /* Table wrapper for horizontal scroll on small screens */
    .table-wrapper {
      overflow-x: auto;
      overflow-y: visible;
      width: 100%;
      -webkit-overflow-scrolling: touch;
    }

    .table-wrapper::-webkit-scrollbar {
      height: 8px;
    }

    .table-wrapper::-webkit-scrollbar-track {
      background: rgba(15, 23, 42, 0.5);
      border-radius: 4px;
    }

    .table-wrapper::-webkit-scrollbar-thumb {
      background: rgba(16, 185, 129, 0.5);
      border-radius: 4px;
    }

    .table-wrapper::-webkit-scrollbar-thumb:hover {
      background: rgba(16, 185, 129, 0.7);
    }

    th, td {
      padding: 4px 5px;
      text-align: left;
    }

    th {
      background: linear-gradient(135deg, #234e52, #1a365d);
      color: #e6fffa;
      border-bottom: 1px solid rgba(15, 23, 42, 0.86);
    }

    tr:nth-child(even) td {
      background: rgba(15, 23, 42, 0.88);
    }

    tr:nth-child(odd) td {
      background: rgba(17, 24, 39, 0.92);
    }

    tr:hover td {
      background: rgba(30, 64, 175, 0.64);
    }

    .match-list {
      list-style: none;
      margin-top: 7px;
    }

    .match-item {
      font-size: 0.8rem;
      padding: 6px 7px;
      border-radius: 9px;
      background: rgba(15, 23, 42, 0.92);
      border-left: 3px solid #63b3ed;
      margin-bottom: 4px;
      cursor: pointer;
    }

    .match-item:hover {
      background: rgba(30, 64, 175, 0.7);
    }

    .match-score {
      font-weight: 700;
      color: #f6e05e;
    }

    .knockout-card {
      margin-top: 6px;
      padding: 9px 9px;
      border-radius: 12px;
      background: linear-gradient(135deg, rgba(10, 25, 47, 0.95), rgba(4, 20, 12, 0.97));
      border: 1px solid rgba(59, 130, 246, 0.75);
      font-size: 0.86rem;
      cursor: pointer;
    }

    .knockout-card:hover {
      border-color: rgba(129, 230, 217, 0.9);
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.7);
    }

    .final-banner {
      margin-top: 12px;
      padding: 14px 10px 16px;
      border-radius: 16px;
      text-align: center;
      background: radial-gradient(circle at top, #f6e05e, #dd6b20);
      color: #2d3748;
      box-shadow: 0 14px 32px rgba(236, 201, 75, 0.75);
      cursor: pointer;
    }

    .final-banner h3 {
      color: inherit;
    }

    .champion-line {
      font-size: 1.4rem;
      font-weight: 900;
      margin-top: 8px;
    }

    .empty-state {
      height: 100%;
      min-height: 400px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      gap: 16px;
      color: #cbd5e1;
      padding: 48px 24px;
    }

    .empty-icon {
      font-size: 5rem;
      filter: drop-shadow(0 4px 20px rgba(16, 185, 129, 0.3));
      animation: float 3s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% {
        transform: translateY(0px);
      }
      50% {
        transform: translateY(-10px);
      }
    }

    .empty-state h2 {
      margin-top: 8px;
    }

    .empty-state .output-sub {
      max-width: 500px;
    }
    /* Stats layout */

    .stats-grid {
      margin-top: 10px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 12px;
    }

    .stat-card {
      border-radius: 13px;
      padding: 10px 10px 9px;
      background: linear-gradient(135deg, rgba(9, 19, 35, 0.97), rgba(7, 25, 20, 0.96));
      border: 1px solid rgba(72, 187, 120, 0.8);
      font-size: 0.83rem;
    }

    .stat-title {
      text-align: center;
      font-weight: 800;
      color: #a7f3d0;
      margin-bottom: 6px;
    }

    .player-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 6px;
      border-radius: 8px;
      background: rgba(15, 23, 42, 0.92);
      margin-bottom: 4px;
    }

    /* Club legacy table */

    .legacy-table {
      width: 100%;
      border-collapse: collapse;
      border-radius: 12px;
      overflow: hidden;
      margin-top: 8px;
      font-size: 0.82rem;
    }

    .legacy-table th,
    .legacy-table td {
      padding: 6px 7px;
      text-align: left;
    }

    .legacy-table th {
      background: linear-gradient(135deg, #22543d, #2f855a);
      color: #e6fffa;
    }

    .legacy-table tr:nth-child(even) td {
      background: rgba(15, 23, 42, 0.9);
    }

    .legacy-table tr:nth-child(odd) td {
      background: rgba(17, 24, 39, 0.95);
    }

    .legacy-table tr:hover td {
      background: rgba(22, 101, 52, 0.75);
    }

    /* Modals */

    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      /* backdrop-filter removed for performance */
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      z-index: 9999;
    }

    .modal-backdrop.active {
      display: flex;
    }

    .modal {
      width: 100%;
      max-width: 700px;
      max-height: 90vh;
      overflow-y: auto;
      overflow-x: hidden;
    }

    .modal-content {
      background: linear-gradient(135deg, rgba(17, 24, 39, 0.98), rgba(31, 41, 55, 0.98));
      /* backdrop-filter removed for performance */
      border-radius: 16px;
      max-height: 90vh;
      overflow-y: auto;
      overflow-x: hidden;
      box-shadow:
        0 20px 60px rgba(0, 0, 0, 0.6),
        0 0 0 1px rgba(59, 130, 246, 0.2);
      padding: 24px;
      border: 1px solid rgba(59, 130, 246, 0.3);
      word-wrap: break-word;
      overflow-wrap: break-word;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .btn-primary {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.9), rgba(37, 99, 235, 0.9));
      color: white;
      border: 1px solid rgba(59, 130, 246, 0.3);
      padding: 10px 20px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, rgba(59, 130, 246, 1), rgba(37, 99, 235, 1));
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(59, 130, 246, 0.4);
    }

    .btn-secondary {
      background: linear-gradient(135deg, rgba(107, 114, 128, 0.9), rgba(75, 85, 99, 0.9));
      color: white;
      border: 1px solid rgba(107, 114, 128, 0.3);
      padding: 10px 20px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .btn-secondary:hover {
      background: linear-gradient(135deg, rgba(107, 114, 128, 1), rgba(75, 85, 99, 1));
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    }
    .modal-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.1rem;
      cursor: pointer;
      color: #e6fffa;
    }

    .section-label {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #a0aec0;
      margin: 4px 0;
    }

    .divider {
      margin: 6px 0;
      border-top: 1px solid rgba(75, 85, 99, 0.7);
    }

    .mini-badge {
      display: inline-block;
      padding: 1px 7px;
      border-radius: 999px;
      border: 1px solid rgba(107, 205, 187, 0.9);
      font-size: 0.7rem;
      margin-left: 4px;
      color: #a7f3d0;
    }

    .commentary {
      font-style: italic;
      color: #f6e05e;
      margin-top: 4px;
    }

    .lineup-list {
      list-style: none;
      margin-top: 4px;
    }

    .lineup-list li {
      margin-bottom: 2px;
    }

    .history-card {
      padding: 6px 7px;
      border-radius: 10px;
      background: rgba(15, 23, 42, 0.94);
      border: 1px solid rgba(72, 187, 120, 0.8);
      margin-bottom: 5px;
    }

    /* Custom match modal */

    .custom-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 4px;
    }

    select {
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid rgba(59, 130, 246, 0.3);
      background: rgba(15, 23, 42, 0.8);
      /* backdrop-filter removed for performance */
      color: #e0e7ff;
      font-size: 0.875rem;
      font-weight: 500;
      min-width: 200px;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    select:hover {
      border-color: rgba(59, 130, 246, 0.5);
      background: rgba(30, 41, 59, 0.9);
    }

    select:focus {
      outline: none;
      border-color: rgba(59, 130, 246, 0.7);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .radio-row {
      font-size: 0.875rem;
      color: #e2e8f0;
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .radio-row label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      padding: 8px 12px;
      border-radius: 8px;
      transition: all 0.2s ease;
    }

    .radio-row label:hover {
      background: rgba(59, 130, 246, 0.1);
    }

    .radio-row input[type="radio"] {
      cursor: pointer;
      accent-color: #3b82f6;
    }

    .small-btn {
      padding: 8px 16px;
      border-radius: 8px;
      border: 1px solid rgba(16, 185, 129, 0.3);
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.9), rgba(5, 150, 105, 0.9));
      color: #f1f5f9;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .small-btn:hover {
      background: linear-gradient(135deg, rgba(16, 185, 129, 1), rgba(5, 150, 105, 1));
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(16, 185, 129, 0.4);
    }

    .small-btn:active {
      transform: translateY(0);
    }

    /* Light theme overrides */

    body.light {
      background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 50%, #cbd5e1 100%);
      color: #1e293b;
    }

    body.light::before {
      background:
        radial-gradient(circle at 20% 50%, rgba(16, 185, 129, 0.05) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(59, 130, 246, 0.05) 0%, transparent 50%);
    }

    body.light header {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.98), rgba(248, 250, 252, 0.95));
      border-color: rgba(16, 185, 129, 0.3);
      box-shadow:
        0 4px 24px rgba(0, 0, 0, 0.1),
        0 0 0 1px rgba(16, 185, 129, 0.1);
    }

    body.light header::before {
      opacity: 0.02;
    }

    body.light h1 {
      background: linear-gradient(135deg, #059669 0%, #10b981 50%, #34d399 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    body.light .subtitle,
    body.light .rng-mini {
      color: #64748b;
    }

    body.light .chip {
      background: rgba(16, 185, 129, 0.1);
      color: #059669;
      border-color: rgba(16, 185, 129, 0.3);
    }

    body.light .sidebar,
    body.light .panel {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.98), rgba(248, 250, 252, 0.95));
      border-color: rgba(59, 130, 246, 0.2);
      box-shadow:
        0 4px 24px rgba(0, 0, 0, 0.08),
        inset 0 1px 0 rgba(255, 255, 255, 0.5);
    }

    body.light .panel::before {
      background: radial-gradient(circle, rgba(16, 185, 129, 0.02) 0%, transparent 70%);
    }

    body.light .team-row {
      background: rgba(241, 245, 249, 0.8);
      border-color: rgba(148, 163, 184, 0.3);
    }

    body.light table tr:nth-child(even) td,
    body.light table tr:nth-child(odd) td {
      background: rgba(248, 250, 252, 0.8);
    }

    body.light tr:hover td {
      background: rgba(224, 242, 254, 0.8);
    }

    body.light .stat-card {
      background: rgba(255, 255, 255, 0.95);
    }

    body.light .modal-content {
      background: rgba(255, 255, 255, 0.98);
      border-color: rgba(59, 130, 246, 0.2);
      color: #1e293b;
    }

    body.light .modal-close {
      color: #1e293b;
    }

    body.light .history-card {
      background: rgba(248, 250, 252, 0.8);
    }

    body.light h2,
    body.light h3 {
      background: linear-gradient(135deg, #1e293b 0%, #475569 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    body.light .ctrl-btn {
      border-color: rgba(0, 0, 0, 0.1);
      box-shadow:
        0 2px 8px rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.8);
    }

    body.light .sidebar-header-title {
      color: #334155;
    }

    body.light .sidebar-tab {
      color: #64748b;
    }

    body.light .sidebar-tab:hover {
      background: rgba(59, 130, 246, 0.15);
      color: #475569;
    }

    body.light .sidebar-tab.active {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.25), rgba(37, 99, 235, 0.25));
      color: #1e40af;
      border-color: rgba(59, 130, 246, 0.5);
    }

    body.light .theme-toggle-btn {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(6, 78, 59, 0.15));
      color: #059669;
      border-color: rgba(16, 185, 129, 0.3);
    }

    @media (max-width: 1024px) {
      .layout {
        grid-template-columns: 1fr;
        gap: 16px;
      }

      .sidebar {
        position: static;
        max-height: none;
      }

      header {
        flex-direction: column;
        align-items: flex-start;
        padding: 16px;
      }

      .right-header {
        width: 100%;
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
      }

      h1 {
        font-size: 1.5rem;
      }

      .page {
        padding: 12px;
      }
    }

    @media (max-width: 640px) {
      h1 {
        font-size: 1.25rem;
      }

      .chip {
        font-size: 0.65rem;
        padding: 3px 10px;
      }

      .ctrl-btn {
        padding: 12px 14px;
      }

      .empty-icon {
        font-size: 3.5rem;
      }

      .panel {
        padding: 16px;
      }
    }
    .match-card {
      transition: all 0.3s ease;
    }
    .match-card {
      transition: all 0.3s ease;
      padding: 12px !important;
      margin-bottom: 10px !important;
    }

    .match-card h2,
    .match-card h3 {
      font-size: 1.1rem !important;
      margin: 2px 0 4px !important;
    }

    .match-card [style*="font-size: 2.5em"] {
      font-size: 2em !important;
    }

    .match-card [style*="font-size: 1.3em"] {
      font-size: 1.1em !important;
    }

    .match-card [style*="padding: 20px"] {
      padding: 12px !important;
    }

    .match-card [style*="padding: 15px"] {
      padding: 10px !important;
    }

    .match-card [style*="margin-bottom: 15px"] {
      margin-bottom: 10px !important;
    }
    .match-card:hover {
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5) !important;
    }

    .matches-container {
      max-width: 100%;
      margin: 0 auto;
    }

    .match-week-card {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    @media (max-width: 768px) {
      .match-card > div:first-child {
        flex-direction: column;
        align-items: flex-start !important;
      }

      .match-card [style*="grid-template-columns"] {
        grid-template-columns: 1fr !important;
        gap: 10px !important;
      }
    }
    .bracket-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
      margin-top: 15px;
    }

    .bracket-round {
      background: rgba(30, 41, 59, 0.5);
      border-radius: 10px;
      padding: 12px;
      border: 1px solid #374151;
    }

    .bracket-matches {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 12px;
      margin-top: 10px;
    }

    .bracket-match {
      background: linear-gradient(135deg, rgba(30, 41, 59, 0.95), rgba(17, 24, 39, 0.95));
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid #4b5563;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .bracket-match:hover {
      border-color: #3b82f6;
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
    }

    .bracket-match.final-match {
      border: 2px solid #f59e0b;
    }

    .bracket-match-header {
      background: rgba(59, 130, 246, 0.2);
      padding: 6px 10px;
      font-size: 0.8rem;
      font-weight: bold;
      color: #60a5fa;
      text-align: center;
      border-bottom: 1px solid #374151;
    }

    .bracket-team {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      border-bottom: 1px solid #374151;
      transition: background 0.2s ease;
    }

    .bracket-team:last-of-type {
      border-bottom: none;
    }

    .bracket-team.winner {
      background: rgba(16, 185, 129, 0.15);
      border-left: 3px solid #10b981;
    }

    .bracket-team .team-name {
      font-weight: 600;
      color: #e5e7eb;
      font-size: 0.9rem;
    }

    .bracket-team .team-score {
      font-size: 1.2rem;
      font-weight: bold;
      color: #fbbf24;
      min-width: 30px;
      text-align: right;
    }

    .bracket-team.winner .team-score {
      color: #10b981;
    }

    .bracket-legs {
      background: rgba(15, 23, 42, 0.5);
      text-align: center;
      padding: 0;
    }

    .bracket-winner {
      background: rgba(59, 130, 246, 0.15);
      color: #60a5fa;
      padding: 6px 10px;
      text-align: center;
      font-weight: bold;
      font-size: 0.85rem;
      border-top: 1px solid #374151;
    }

    @media (max-width: 768px) {
      .bracket-matches {
        grid-template-columns: 1fr;
      }
    }

    /* Achievement System Styles */
    .trophy-cabinet {
      padding: 24px;
      background: linear-gradient(135deg, rgba(17, 24, 39, 0.95), rgba(31, 41, 55, 0.9));
      /* backdrop-filter removed for performance */
      border-radius: 16px;
      border: 1px solid rgba(249, 115, 22, 0.3);
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.4);
    }

    .achievement-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid rgba(249, 115, 22, 0.2);
    }

    .achievement-stats {
      display: flex;
      gap: 24px;
      font-size: 0.875rem;
    }

    .achievement-stat {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .achievement-stat-label {
      color: #94a3b8;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .achievement-stat-value {
      color: #f97316;
      font-size: 1.5rem;
      font-weight: 800;
    }

    .achievements-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 16px;
      margin-top: 20px;
    }

    .achievement-card {
      background: linear-gradient(135deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.9));
      border-radius: 12px;
      padding: 20px;
      border: 2px solid rgba(71, 85, 105, 0.3);
      text-align: center;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .achievement-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, rgba(249, 115, 22, 0.1), transparent);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .achievement-card:hover::before {
      opacity: 1;
    }

    .achievement-card.unlocked {
      border-color: rgba(249, 115, 22, 0.6);
      box-shadow: 0 4px 20px rgba(249, 115, 22, 0.2);
    }

    .achievement-card.unlocked::before {
      opacity: 0.5;
    }

    .achievement-card.locked {
      filter: grayscale(0.8);
      opacity: 0.5;
    }

    .achievement-icon {
      font-size: 3rem;
      margin-bottom: 12px;
      display: block;
      transition: transform 0.3s ease;
    }

    .achievement-card.unlocked .achievement-icon {
      animation: bounce 0.6s ease;
    }

    .achievement-card:hover .achievement-icon {
      transform: scale(1.1) rotate(5deg);
    }

    @keyframes bounce {
      0%, 100% {
        transform: translateY(0);
      }
      50% {
        transform: translateY(-10px);
      }
    }

    .achievement-name {
      font-size: 0.875rem;
      font-weight: 700;
      color: #e0e7ff;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .achievement-card.locked .achievement-name {
      color: #64748b;
    }

    .achievement-description {
      font-size: 0.75rem;
      color: #94a3b8;
      line-height: 1.4;
      margin-bottom: 12px;
    }

    .achievement-progress {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid rgba(71, 85, 105, 0.3);
    }

    .achievement-progress-bar {
      width: 100%;
      height: 6px;
      background: rgba(71, 85, 105, 0.3);
      border-radius: 3px;
      overflow: hidden;
      margin-bottom: 6px;
    }

    .achievement-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #f97316, #fb923c);
      border-radius: 3px;
      transition: width 0.5s ease;
    }

    .achievement-progress-text {
      font-size: 0.7rem;
      color: #f97316;
      font-weight: 600;
    }

    .achievement-unlocked-date {
      font-size: 0.7rem;
      color: #6ee7b7;
      font-style: italic;
      margin-top: 8px;
    }

    .achievement-rarity {
      position: absolute;
      top: 8px;
      right: 8px;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 0.65rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .achievement-rarity.common {
      background: rgba(148, 163, 184, 0.2);
      color: #94a3b8;
      border: 1px solid rgba(148, 163, 184, 0.3);
    }

    .achievement-rarity.rare {
      background: rgba(59, 130, 246, 0.2);
      color: #60a5fa;
      border: 1px solid rgba(59, 130, 246, 0.3);
    }

    .achievement-rarity.epic {
      background: rgba(168, 85, 247, 0.2);
      color: #c084fc;
      border: 1px solid rgba(168, 85, 247, 0.3);
    }

    .achievement-rarity.legendary {
      background: linear-gradient(135deg, rgba(249, 115, 22, 0.3), rgba(251, 146, 60, 0.3));
      color: #fb923c;
      border: 1px solid rgba(249, 115, 22, 0.5);
      box-shadow: 0 0 10px rgba(249, 115, 22, 0.3);
    }

    .achievement-notification {
      position: fixed;
      top: 80px;
      right: -400px;
      width: 350px;
      background: linear-gradient(135deg, rgba(17, 24, 39, 0.98), rgba(31, 41, 55, 0.98));
      /* backdrop-filter removed for performance */
      border-radius: 12px;
      border: 2px solid rgba(249, 115, 22, 0.6);
      box-shadow: 0 8px 32px rgba(249, 115, 22, 0.4);
      padding: 20px;
      z-index: 1000;
      transition: right 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    .achievement-notification.show {
      right: 20px;
    }

    .achievement-notification-content {
      display: flex;
      gap: 16px;
      align-items: center;
    }

    .achievement-notification-icon {
      font-size: 3rem;
      animation: bounce 0.6s ease;
    }

    .achievement-notification-text {
      flex: 1;
    }

    .achievement-notification-title {
      font-size: 0.75rem;
      color: #f97316;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .achievement-notification-name {
      font-size: 1.1rem;
      color: #e0e7ff;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .achievement-notification-description {
      font-size: 0.8rem;
      color: #94a3b8;
    }

    /* Loading Overlay */
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.65);
      /* backdrop-filter removed for performance */
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .loading-overlay.active {
      display: flex;
    }

    .loading-card {
      padding: 18px 20px;
      border-radius: 14px;
      background: rgba(10, 15, 30, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.08);
      text-align: center;
      min-width: 220px;
    }

    .spinner {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      border: 3px solid rgba(255, 255, 255, 0.15);
      border-top-color: rgba(120, 180, 255, 0.9);
      animation: spin 0.9s linear infinite;
      margin: 0 auto 10px;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .loading-progress {
      font-size: 0.9rem;
      opacity: 0.8;
      margin-top: 6px;
      color: #94a3b8;
    }

    .achievement-filter {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .achievement-filter-btn {
      padding: 8px 16px;
      border-radius: 8px;
      border: 1px solid rgba(71, 85, 105, 0.3);
      background: rgba(30, 41, 59, 0.5);
      color: #94a3b8;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .achievement-filter-btn:hover {
      border-color: rgba(249, 115, 22, 0.5);
      background: rgba(249, 115, 22, 0.1);
      color: #f97316;
    }

    .achievement-filter-btn.active {
      border-color: rgba(249, 115, 22, 0.6);
      background: rgba(249, 115, 22, 0.2);
      color: #f97316;
    }

    /* Smooth transitions for all buttons */
    .ctrl-btn,
    .btn-primary,
    .btn-secondary,
    .small-btn {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .ctrl-btn:not(:disabled):hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 28px rgba(0, 0, 0, 0.7) !important;
    }

    .ctrl-btn:not(:disabled):active {
      transform: translateY(0);
      box-shadow: 0 5px 14px rgba(0, 0, 0, 0.4) !important;
    }

    /* Glow effect for enabled buttons */
    .ctrl-btn:not(:disabled) {
      box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
      animation: pulse-glow 2s infinite;
    }

    @keyframes pulse-glow {
      0%, 100% {
        box-shadow: 0 5px 14px rgba(0, 0, 0, 0.4);
      }
      50% {
        box-shadow: 0 5px 14px rgba(0, 0, 0, 0.4), 0 0 20px rgba(59, 130, 246, 0.3);
      }
    }

    /* Disabled button styling */
    .ctrl-btn:disabled {
      filter: grayscale(0.7);
      cursor: not-allowed !important;
    }

    /* Enhanced match card hover */
    .match-card {
      position: relative;
      overflow: hidden;
    }

    .match-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.1), transparent);
      transition: left 0.5s ease;
    }

    .match-card:hover::before {
      left: 100%;
    }

    /* Enhanced group card styling */
    .group-card {
      transition: all 0.3s ease;
    }

    .group-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 28px rgba(0, 0, 0, 0.8) !important;
    }

    /* Smooth scrolling */
    html {
      scroll-behavior: smooth;
    }

    /* Better focus states for accessibility */
    button:focus-visible,
    select:focus-visible,
    input:focus-visible {
      outline: 2px solid #3b82f6;
      outline-offset: 2px;
    }

    /* Loading animation for button states */
    @keyframes shimmer {
      0% {
        background-position: -1000px 0;
      }
      100% {
        background-position: 1000px 0;
      }
    }

    .ctrl-btn.loading {
      background: linear-gradient(90deg, #4a5568 0%, #6b7280 50%, #4a5568 100%);
      background-size: 1000px 100%;
      animation: shimmer 2s infinite;
    }

    /* Enhanced modal animations */
    .modal-backdrop {
      /* backdrop-filter removed for performance */
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    /* Live Match Animations */
    @keyframes liveCommentarySlideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes goalPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.3); color: #10b981; }
    }

    /* Player Card Animations */
    @keyframes cardEntry {
      from {
        opacity: 0;
        transform: scale(0.9) rotateY(10deg);
      }
      to {
        opacity: 1;
        transform: scale(1) rotateY(0deg);
      }
    }

    .player-card.legendary {
      animation: cardShine 3s ease-in-out infinite;
    }

    @keyframes cardShine {
      0%, 100% { filter: brightness(1); }
      50% { filter: brightness(1.2); }
    }

    /* Tactical Formation Display */
    .tactical-section {
      margin: 20px 0;
      padding: 20px;
      background: rgba(15, 23, 42, 0.6);
      border-radius: 12px;
      border: 1px solid rgba(59, 130, 246, 0.3);
    }

    .tactical-section h3 {
      margin: 0 0 15px 0;
      color: #10b981;
      font-size: 1.1em;
    }

    .formations-display {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 15px;
    }

    .formation-team {
      flex: 1;
      text-align: center;
      padding: 15px;
      background: rgba(30, 41, 59, 0.5);
      border-radius: 8px;
      border: 2px solid transparent;
      transition: all 0.3s ease;
    }

    .formation-name {
      font-size: 0.9em;
      color: #94a3b8;
      margin-bottom: 8px;
    }

    .formation-value {
      font-size: 1.5em;
      font-weight: bold;
      margin: 10px 0;
    }

    .formation-value.offensive {
      color: #ef4444;
      border-color: #ef4444;
    }

    .formation-value.defensive {
      color: #3b82f6;
      border-color: #3b82f6;
    }

    .formation-value.balanced {
      color: #10b981;
      border-color: #10b981;
    }

    .formation-style {
      font-size: 0.85em;
      color: #cbd5e1;
      margin-top: 5px;
    }

    .tactical-advantage {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px;
      min-width: 120px;
    }

    .advantage-icon {
      font-size: 2em;
      margin-bottom: 5px;
    }

    .advantage-text {
      font-size: 0.9em;
      color: #fbbf24;
      font-weight: bold;
      text-align: center;
    }

    @media (max-width: 768px) {
      .formations-display {
        flex-direction: column;
      }

      .tactical-advantage {
        width: 100%;
        padding: 15px 0;
      }
    }

    .modal-content {
      animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes slideUp {
      from {
        transform: translateY(50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    /* Better scrollbar styling */
    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }

    ::-webkit-scrollbar-track {
      background: #1f2937;
      border-radius: 5px;
    }

    ::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, #4b5563, #374151);
      border-radius: 5px;
      border: 2px solid #1f2937;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(180deg, #6b7280, #4b5563);
    }

    /* Enhanced empty state */
    .empty-state {
      animation: fadeInUp 0.6s ease;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Stat cards with hover effects */
    .stat-card {
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .stat-card:hover {
      transform: translateY(-3px) scale(1.02);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5) !important;
    }

    /* Enhanced team row hover */
    .team-row {
      transition: all 0.2s ease;
    }

    .team-row:hover {
      transform: translateX(3px);
      border-color: #3b82f6 !important;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    /* New Feature Styles */

    /* Stat card styling */
    .stat-card {
      padding: 20px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      text-align: center;
      border: 1px solid rgba(16, 185, 129, 0.2);
      transition: all 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
      border-color: rgba(16, 185, 129, 0.5);
    }

    .stat-value {
      font-size: 2.5em;
      font-weight: bold;
      color: #10b981;
      margin-bottom: 8px;
    }

    .stat-label {
      font-size: 0.9em;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Matchup card styling */
    .matchup-card {
      transition: all 0.3s ease;
    }

    .matchup-card:hover {
      background: rgba(16, 185, 129, 0.1) !important;
      transform: translateY(-3px);
      box-shadow: 0 8px 24px rgba(16, 185, 129, 0.3);
    }

    /* Match card animations */
    .match-card {
      animation: slideIn 0.5s ease-out;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes slideOut {
      from {
        opacity: 1;
        transform: translateY(0);
      }
      to {
        opacity: 0;
        transform: translateY(-20px);
      }
    }

    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.05);
      }
    }

    @keyframes goalCelebration {
      0% {
        transform: scale(1) rotate(0deg);
      }
      25% {
        transform: scale(1.2) rotate(-5deg);
      }
      50% {
        transform: scale(1.3) rotate(5deg);
      }
      75% {
        transform: scale(1.2) rotate(-5deg);
      }
      100% {
        transform: scale(1) rotate(0deg);
      }
    }

    @keyframes cardReveal {
      0% {
        opacity: 0;
        transform: rotateY(90deg);
      }
      100% {
        opacity: 1;
        transform: rotateY(0deg);
      }
    }

    @keyframes trophyPresentation {
      0% {
        transform: translateY(50px) scale(0.5);
        opacity: 0;
      }
      50% {
        transform: translateY(-10px) scale(1.1);
      }
      100% {
        transform: translateY(0) scale(1);
        opacity: 1;
      }
    }

    /* Goal celebration animation */
    .goal-celebration {
      animation: goalCelebration 0.6s ease-out;
    }

    /* Card reveal animation */
    .card-reveal {
      animation: cardReveal 0.4s ease-out;
    }

    /* Trophy presentation animation */
    .trophy-presentation {
      animation: trophyPresentation 1s ease-out;
    }

    /* Milestone notification styling */
    .milestone-notification {
      animation: slideIn 0.5s ease-out;
    }

    /* Weather indicator */
    .weather-indicator {
      display: inline-block;
      padding: 4px 12px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      font-size: 0.9em;
      margin-left: 8px;
    }

    /* Stadium info */
    .stadium-info {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: rgba(16, 185, 129, 0.1);
      border-radius: 8px;
      margin: 8px 0;
    }

    /* Rivalry indicator */
    .rivalry-match {
      border: 2px solid #fbbf24 !important;
      box-shadow: 0 0 20px rgba(251, 191, 36, 0.3);
      animation: pulse 2s infinite;
    }

    /* Form tracker */
    .form-indicator {
      display: inline-flex;
      gap: 2px;
      margin-left: 8px;
    }

    /* Top performers carousel */
    .performers-carousel {
      display: flex;
      overflow-x: auto;
      gap: 15px;
      padding: 20px;
      scroll-behavior: smooth;
    }

    .performer-card {
      min-width: 250px;
      padding: 20px;
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(59, 130, 246, 0.1));
      border-radius: 12px;
      border: 1px solid rgba(16, 185, 129, 0.3);
      transition: all 0.3s ease;
    }

    .performer-card:hover {
      transform: translateY(-5px) scale(1.02);
      box-shadow: 0 10px 30px rgba(16, 185, 129, 0.4);
    }

    /* Match timeline */
    .timeline-event {
      position: relative;
      padding-left: 30px;
      margin: 15px 0;
    }

    .timeline-event::before {
      content: '';
      position: absolute;
      left: 10px;
      top: 0;
      bottom: -15px;
      width: 2px;
      background: linear-gradient(to bottom, #10b981, transparent);
    }

    .timeline-event::after {
      content: '';
      position: absolute;
      left: 6px;
      top: 6px;
      width: 10px;
      height: 10px;
      background: #10b981;
      border-radius: 50%;
    }

    /* Bracket zoom */
    .bracket-zoomable {
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .bracket-zoomable:hover {
      transform: scale(1.05);
      z-index: 10;
    }

    .bracket-zoomed {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(1.5);
      z-index: 1000;
      background: rgba(10, 22, 40, 0.98);
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
    }

    /* Prediction badge */
    .prediction-badge {
      display: inline-block;
      padding: 4px 10px;
      background: rgba(251, 191, 36, 0.2);
      border: 1px solid rgba(251, 191, 36, 0.5);
      border-radius: 12px;
      font-size: 0.85em;
      color: #fbbf24;
      font-weight: bold;
    }

    /* Formation selector */
    .formation-selector {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin: 15px 0;
    }

    .formation-option {
      padding: 15px;
      background: rgba(255, 255, 255, 0.05);
      border: 2px solid rgba(16, 185, 129, 0.2);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
    }

    .formation-option:hover {
      border-color: #10b981;
      background: rgba(16, 185, 129, 0.1);
      transform: translateY(-2px);
    }

    .formation-option.selected {
      border-color: #10b981;
      background: rgba(16, 185, 129, 0.2);
      box-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
    }

    /* Live match simulation */
    .live-match-container {
      position: relative;
      padding: 30px;
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), rgba(59, 130, 246, 0.05));
      border-radius: 16px;
      border: 2px solid rgba(16, 185, 129, 0.3);
    }

    .live-score {
      font-size: 3em;
      font-weight: bold;
      text-align: center;
      color: #10b981;
      animation: pulse 1s ease-in-out;
    }

    .match-controls {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 20px;
    }

    .control-btn-sim {
      padding: 12px 24px;
      background: linear-gradient(135deg, #10b981, #34d399);
      border: none;
      border-radius: 8px;
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .control-btn-sim:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
    }

    .control-btn-sim:active {
      transform: translateY(0);
    }

    /* Tournament Progress Indicator */
    .tournament-progress-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 24px;
      background: linear-gradient(135deg, var(--bg-secondary), var(--bg-primary));
      border-radius: 12px;
      margin-bottom: 20px;
      border: 1px solid rgba(16, 185, 129, 0.2);
      position: relative;
      overflow: hidden;
    }

    .tournament-progress-bar::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--color-groups), var(--color-knockout), var(--color-final));
    }

    .progress-step {
      flex: 1;
      text-align: center;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 0.9em;
      font-weight: 600;
      color: var(--text-muted);
      transition: all 0.3s ease;
      position: relative;
    }

    .progress-step:not(:last-child)::after {
      content: '→';
      position: absolute;
      right: -12px;
      top: 50%;
      transform: translateY(-50%);
      color: rgba(255, 255, 255, 0.2);
      font-size: 1.2em;
    }

    .progress-step.completed {
      color: var(--color-primary);
      background: rgba(16, 185, 129, 0.1);
    }

    .progress-step.active {
      color: var(--text-primary);
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(59, 130, 246, 0.2));
      box-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
      transform: scale(1.05);
    }

    .progress-step.pending {
      opacity: 0.5;
    }

    /* Smart Notifications */
    .notification-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10000;
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-width: 400px;
    }

    .notification {
      background: linear-gradient(135deg, var(--bg-secondary), var(--bg-primary));
      border-radius: 12px;
      padding: 16px 20px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
      border-left: 4px solid var(--color-primary);
      display: flex;
      align-items: center;
      gap: 12px;
      animation: notificationSlideIn 0.3s ease;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .notification:hover {
      transform: translateX(-4px);
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.5);
    }

    .notification.notification-goal {
      border-left-color: var(--color-primary);
    }

    .notification.notification-upset {
      border-left-color: var(--color-accent);
    }

    .notification.notification-milestone {
      border-left-color: var(--color-final);
    }

    .notification.notification-achievement {
      border-left-color: var(--color-purple);
    }

    .notification-icon {
      font-size: 1.5em;
      flex-shrink: 0;
    }

    .notification-content {
      flex: 1;
    }

    .notification-title {
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .notification-message {
      font-size: 0.9em;
      color: var(--text-muted);
    }

    .notification-close {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 1.2em;
      padding: 0;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      transition: all 0.2s ease;
    }

    .notification-close:hover {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-primary);
    }

    @keyframes notificationSlideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes notificationSlideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(400px);
        opacity: 0;
      }
    }

    .notification.removing {
      animation: notificationSlideOut 0.3s ease forwards;
    }

    @media (max-width: 768px) {
      .tournament-progress-bar {
        flex-wrap: wrap;
        gap: 8px;
      }

      .progress-step {
        flex: 0 0 calc(33.333% - 6px);
        font-size: 0.75em;
      }

      .progress-step:not(:last-child)::after {
        display: none;
      }

      .notification-container {
        left: 10px;
        right: 10px;
        max-width: none;
      }
    }

/* ===========================
   SIDEBAR POLISH OVERRIDES
   (paste at end of <style>)
   =========================== */

/* Sidebar spacing + scrollability fixes - REMOVED (handled in main CSS) */

/* Main sidebar action buttons */
.ctrl-btn{
  padding: 16px 16px;             /* bigger click target */
  border-radius: 12px;            /* smoother look */
  font-size: 0.95rem;             /* clearer text */
  min-height: 64px;               /* consistent height */
  line-height: 1.2;
  overflow: visible;              /* stop clipping tag/glow */
  display: flex;
  align-items: center;
  justify-content: space-between;
}

/* Button inner layout */
.ctrl-btn-main{
  gap: 4px;
}

.ctrl-btn-title{
  font-size: 1.02rem;
  font-weight: 700;
  letter-spacing: 0.2px;
}

.ctrl-btn-subtitle{
  font-size: 0.82rem;
  opacity: 0.85;
  font-weight: 500;
}

/* Right-side pill/tag */
.ctrl-btn-tag{
  font-size: 0.78rem;
  padding: 5px 10px;
  border-radius: 999px;
  white-space: nowrap;            /* prevents wrap cropping */
}

/* Keep disabled readable but clearly inactive */
.ctrl-btn:disabled{
  opacity: 0.55;
  filter: saturate(0.6);
  cursor: not-allowed;
}

/* Tabs row more breathable */
.sidebar-tabs{
  gap: 6px;
  padding: 8px;
  flex-wrap: wrap;
}

/* Tabs bigger + cleaner */
.sidebar-tab{
  padding: 10px 8px;
  font-size: 0.8rem;
  border-radius: 9px;
  min-width: 48%;
}

/* Make tab icon+label align nicer if you use icons */
.sidebar-tab i,
.sidebar-tab .tab-icon{
  font-size: 1rem;
  margin-bottom: 2px;
  display: block;
}

/* PROFILE cards proportionate to sidebar */
.profile-stats-grid{
  gap: 10px;
  overflow: visible;
}

.profile-stat-card{
  padding: 10px;
  border-radius: 10px;
  gap: 8px;
  min-height: 60px;
  overflow: visible;
}

.profile-stat-icon{
  font-size: 1.1rem;
}

.profile-stat-value{
  font-size: 1.15rem;
  font-weight: 700;
  line-height: 1.2;
}

.profile-stat-label{
  font-size: 0.8rem;
  opacity: 0.85;
  line-height: 1.2;
}

/* Layout polish - visual appeal and spacing */
.profile-section{
  margin-bottom: 12px;
}

.profile-section-header{
  margin-bottom: 10px;
  padding-bottom: 6px;
}

.profile-section-title{
  font-size: 0.85rem;
}

.profile-section-icon{
  font-size: 1.1rem;
}

/* Tracked team card styling */
.tracked-team-card{
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(37, 99, 235, 0.05));
  border: 1px solid rgba(59, 130, 246, 0.3);
  border-radius: 10px;
  padding: 14px;
}

.tracked-team-header{
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  margin-bottom: 10px;
}

.tracked-team-info{
  flex: 1;
  min-width: 0;
}

.tracked-team-label{
  font-size: 0.75rem;
  color: var(--text-muted);
  margin-bottom: 4px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.tracked-team-name{
  font-size: 1rem;
  font-weight: 600;
  color: var(--color-primary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.tracked-team-hint{
  font-size: 0.75rem;
  color: var(--text-muted);
  line-height: 1.4;
  opacity: 0.8;
}

/* Mini button polish */
.mini-btn{
  flex-shrink: 0;
  white-space: nowrap;
}

/* Profile best tournament styling */
.profile-best-tournament{
  min-height: 60px;
}

/* Profile achievements spacing */
.profile-achievements{
  gap: 8px;
}

.profile-achievement-card{
  padding: 10px;
  border-radius: 8px;
}

.profile-achievement-icon{
  font-size: 1.3rem;
}

.profile-achievement-name{
  font-size: 0.85rem;
}

.profile-achievement-desc{
  font-size: 0.72rem;
}

/* Empty state styling */
.profile-empty-state{
  text-align: center;
  padding: 20px 10px;
}

.profile-empty-icon{
  font-size: 2rem;
  margin-bottom: 8px;
  opacity: 0.5;
}

.profile-empty-text{
  font-size: 0.85rem;
  color: var(--text-muted);
}

/* Manager profile card polish */
.manager-profile-card{
  margin-bottom: 12px;
}

/* Tab content spacing */
.tab-content{
  overflow-y: auto;
  scrollbar-width: thin;
  scrollbar-color: rgba(59, 130, 246, 0.3) transparent;
}

.tab-content::-webkit-scrollbar{
  width: 6px;
}

.tab-content::-webkit-scrollbar-track{
  background: transparent;
}

.tab-content::-webkit-scrollbar-thumb{
  background: rgba(59, 130, 246, 0.3);
  border-radius: 3px;
}

.tab-content::-webkit-scrollbar-thumb:hover{
  background: rgba(59, 130, 246, 0.5);
}

/* Bracket responsive styling */
.bracket-container{
  width: 100%;
  overflow-x: auto;
  padding-bottom: 8px;
  -webkit-overflow-scrolling: touch;
}

.bracket{
  min-width: 720px;
  width: max-content;
}

.simple-bracket{
  min-width: 600px;
  width: max-content;
}

/* Mobile: don't over-bloat, but still readable */
@media (max-width: 640px){
  .ctrl-btn{
    padding: 14px 14px;
    min-height: 58px;
    font-size: 0.9rem;
  }
  .ctrl-btn-title{ font-size: 0.98rem; }
  .ctrl-btn-subtitle{ font-size: 0.78rem; }
  .sidebar-tab{
    min-width: 100%;
    font-size: 0.78rem;
  }

  .profile-stat-card{
    padding: 10px;
    min-height: 56px;
  }

  .tracked-team-name{
    font-size: 0.9rem;
  }

  /* Bracket mobile optimizations */
  .bracket{
    min-width: 600px;
  }

  .simple-bracket{
    min-width: 500px;
  }

  .bracket-round{
    gap: 6px;
  }

  /* Quick Actions Bar mobile optimization */
  #quickActionsBar{
    bottom: 10px !important;
    right: 10px !important;
    padding: 8px !important;
    gap: 6px !important;
    flex-wrap: wrap;
    max-width: calc(100vw - 20px);
  }

  #quickActionsBar button{
    width: 38px !important;
    height: 38px !important;
    font-size: 1.1em !important;
  }

  /* Theme Switcher mobile optimization */
  #themeSwitcher{
    top: 60px !important;
    right: 10px !important;
    padding: 6px !important;
    gap: 6px !important;
  }

  #themeSwitcher button{
    width: 35px !important;
    height: 35px !important;
    font-size: 1em !important;
  }

  .match-card{
    padding: 6px;
    font-size: 12px;
  }
}

/* ========================================
   AESTHETIC ENHANCEMENTS - ANIMATIONS & EFFECTS
   ======================================== */

/* Goal Celebration Animation */
@keyframes goalExplosion {
  0% {
    transform: scale(1);
    box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
  }
  25% {
    transform: scale(1.2) rotate(5deg);
    box-shadow:
      0 0 40px rgba(16, 185, 129, 0.8),
      0 0 80px rgba(16, 185, 129, 0.4);
  }
  50% {
    transform: scale(0.95) rotate(-5deg);
  }
  75% {
    transform: scale(1.1) rotate(3deg);
    box-shadow:
      0 0 60px rgba(16, 185, 129, 0.6),
      0 0 120px rgba(16, 185, 129, 0.3);
  }
  100% {
    transform: scale(1) rotate(0deg);
    box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
  }
}

.btn-goal-celebration {
  animation: goalExplosion 0.8s ease-out !important;
}

/* Loading State Animations */
/* Note: shimmer, spin, pulse keyframes already defined in main CSS above */

.btn-loading {
  background:
    linear-gradient(135deg, rgba(59, 130, 246, 0.9), rgba(37, 99, 235, 0.9)),
    linear-gradient(90deg,
      transparent 0%,
      rgba(255, 255, 255, 0.3) 50%,
      transparent 100%
    ) !important;
  background-size: 100% 100%, 200% 100% !important;
  animation: shimmer 1.5s infinite !important;
  pointer-events: none !important;
  position: relative;
  cursor: wait !important;
}

.btn-loading::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 20px;
  height: 20px;
  margin: -10px 0 0 -10px;
  border: 3px solid rgba(255, 255, 255, 0.3);
  border-top-color: white;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

.btn-loading-pulse {
  animation: pulse 2s infinite !important;
}

/* Success/Error States */
@keyframes successPulse {
  0% {
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.9), rgba(5, 150, 105, 0.9));
    box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
  }
  50% {
    background: linear-gradient(135deg, rgba(16, 185, 129, 1), rgba(5, 150, 105, 1));
    box-shadow: 0 8px 40px rgba(16, 185, 129, 0.6);
  }
  100% {
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.9), rgba(5, 150, 105, 0.9));
    box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
  }
}

@keyframes errorShake {
  0%, 100% { transform: translateX(0); }
  10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
  20%, 40%, 60%, 80% { transform: translateX(10px); }
}

.btn-success {
  animation: successPulse 0.6s ease !important;
  background: linear-gradient(135deg, rgba(16, 185, 129, 0.9), rgba(5, 150, 105, 0.9)) !important;
}

.btn-error {
  animation: errorShake 0.6s ease !important;
  background: linear-gradient(135deg, rgba(239, 68, 68, 0.9), rgba(220, 38, 38, 0.9)) !important;
  border-color: rgba(239, 68, 68, 0.5) !important;
}

/* Enhanced Modal Animations */
@keyframes slideInModal {
  from {
    transform: translateY(100%);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

@keyframes scaleInModal {
  from {
    transform: scale(0.7);
    opacity: 0;
  }
  to {
    transform: scale(1);
    opacity: 1;
  }
}

@keyframes flipInModal {
  from {
    transform: perspective(1000px) rotateX(-90deg);
    opacity: 0;
  }
  to {
    transform: perspective(1000px) rotateX(0deg);
    opacity: 1;
  }
}

@keyframes blurIn {
  from {
    backdrop-filter: blur(0px);
    background-color: rgba(0, 0, 0, 0);
  }
  to {
    backdrop-filter: blur(8px);
    background-color: rgba(0, 0, 0, 0.6);
  }
}

.modal-scale-in {
  animation: scaleInModal 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) !important;
}

.modal-slide-in {
  animation: slideInModal 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) !important;
}

.modal-flip-in {
  animation: flipInModal 0.5s ease-out !important;
}

.modal-backdrop-blur {
  animation: blurIn 0.3s ease !important;
  backdrop-filter: blur(8px) !important;
}

/* Enhanced Button Hover Effects */
.btn-primary, .btn-secondary, .btn-orange, .btn-purple, .btn-blue, .ctrl-btn {
  position: relative;
  overflow: hidden;
  transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.btn-primary::before, .btn-secondary::before, .btn-orange::before,
.btn-purple::before, .btn-blue::before, .ctrl-btn::before {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: linear-gradient(
    45deg,
    transparent 30%,
    rgba(255, 255, 255, 0.2) 50%,
    transparent 70%
  );
  transform: translateX(-100%);
  transition: transform 0.6s ease;
}

.btn-primary:hover::before, .btn-secondary:hover::before,
.btn-orange:hover::before, .btn-purple:hover::before,
.btn-blue:hover::before, .ctrl-btn:hover::before {
  transform: translateX(100%);
}

.btn-primary:active, .btn-secondary:active, .btn-orange:active,
.btn-purple:active, .btn-blue:active, .ctrl-btn:active {
  transform: translateY(-2px) scale(0.98);
}

/* Confetti Particle */
.confetti-particle {
  position: fixed;
  pointer-events: none;
  z-index: 10000;
  border-radius: 50%;
  will-change: transform, opacity;
}

/* Scorer Popup */
.scorer-popup {
  position: fixed;
  background: linear-gradient(135deg, rgba(16, 185, 129, 0.95), rgba(5, 150, 105, 0.95));
  color: white;
  padding: 15px 25px;
  border-radius: 12px;
  font-weight: 700;
  font-size: 1.2rem;
  border: 2px solid rgba(255, 255, 255, 0.3);
  box-shadow: 0 10px 40px rgba(16, 185, 129, 0.4);
  z-index: 10001;
  pointer-events: none;
  white-space: nowrap;
}

/* Stadium Night Theme (Optional - controlled by theme switcher) */
body[data-theme="stadium"] {
  background:
    linear-gradient(180deg, #0a0e1a 0%, #1a1f2e 50%, #0a0e1a 100%),
    radial-gradient(ellipse at bottom, rgba(0, 255, 65, 0.15) 0%, transparent 60%);
  background-attachment: fixed;
}

body[data-theme="stadium"]::before {
  content: '';
  position: fixed;
  top: -50%;
  left: 50%;
  transform: translateX(-50%);
  width: 150%;
  height: 100%;
  background: radial-gradient(
    ellipse at center top,
    rgba(255, 255, 255, 0.08) 0%,
    rgba(255, 255, 255, 0.02) 30%,
    transparent 60%
  );
  pointer-events: none;
  z-index: 0;
  animation: floodlightPulse 8s ease-in-out infinite;
}

@keyframes floodlightPulse {
  0%, 100% { opacity: 0.6; }
  50% { opacity: 1; }
}

body[data-theme="stadium"] .page::after {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-image:
    radial-gradient(circle at 20% 80%, rgba(255, 215, 0, 0.1) 1px, transparent 1px),
    radial-gradient(circle at 80% 60%, rgba(255, 56, 100, 0.1) 1px, transparent 1px);
  background-size: 200px 200px, 300px 300px;
  animation: crowdShimmer 20s linear infinite;
  pointer-events: none;
  z-index: 1;
}

@keyframes crowdShimmer {
  0% { transform: translate(0, 0); }
  100% { transform: translate(-200px, -200px); }
}

/* Context-Aware Stage Theming */
.stage-group {
  border-color: var(--color-groups) !important;
  box-shadow: 0 4px 20px rgba(59, 130, 246, 0.3) !important;
}

.stage-knockout {
  border-color: var(--color-knockout) !important;
  box-shadow: 0 4px 20px rgba(245, 158, 11, 0.3) !important;
}

.stage-semifinal {
  border-color: var(--color-purple) !important;
  box-shadow: 0 4px 20px rgba(168, 85, 247, 0.3) !important;
}

.stage-final {
  border-color: var(--color-final) !important;
  box-shadow: 0 4px 20px rgba(251, 191, 36, 0.3) !important;
}

/* Strength Indicators */
.strength-legendary {
  color: #fbbf24 !important;
  text-shadow: 0 0 10px rgba(251, 191, 36, 0.6) !important;
}

.strength-elite {
  color: #a855f7 !important;
  text-shadow: 0 0 10px rgba(168, 85, 247, 0.6) !important;
}

.strength-strong {
  color: #3b82f6 !important;
  text-shadow: 0 0 10px rgba(59, 130, 246, 0.6) !important;
}

.strength-good {
  color: #10b981 !important;
  text-shadow: 0 0 10px rgba(16, 185, 129, 0.6) !important;
}

/* Particle trail effect */
@keyframes particleTrail {
  0% {
    transform: translateY(0) scale(1);
    opacity: 1;
  }
  100% {
    transform: translateY(-100px) scale(0);
    opacity: 0;
  }
}

.particle-trail {
  animation: particleTrail 1s ease-out forwards;
}

/* Ripple effect on click */
@keyframes ripple {
  0% {
    transform: scale(0);
    opacity: 1;
  }
  100% {
    transform: scale(4);
    opacity: 0;
  }
}

.ripple {
  position: absolute;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.6);
  width: 20px;
  height: 20px;
  animation: ripple 0.6s ease-out;
  pointer-events: none;
}

/* ========================================
   ACCESSIBILITY - REDUCED MOTION SUPPORT
   ======================================== */
@media (prefers-reduced-motion: reduce) {
  *,
  *::before,
  *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
    scroll-behavior: auto !important;
  }

  /* Disable confetti animations */
  .confetti-particle {
    display: none !important;
  }

  /* Disable ripple effects */
  .ripple {
    display: none !important;
  }

  /* Disable goal celebration animations */
  .btn-goal-celebration {
    animation: none !important;
  }

  /* Keep essential transitions but make them instant */
  .modal-backdrop,
  .notification,
  .match-card {
    animation: none !important;
    transition: opacity 0.01ms !important;
  }
}

/* ========================================
   NEW FEATURES - CSS STYLES
   ======================================== */

/* Live Match Simulation */
.live-match-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.9);
  z-index: 10001;
  display: none;
  align-items: center;
  justify-content: center;
  animation: fadeIn 0.3s ease;
}

.live-match-modal.active {
  display: flex;
}

.live-match-container {
  background: linear-gradient(135deg, #1e293b, #0f172a);
  border: 1px solid rgba(16, 185, 129, 0.3);
  border-radius: 16px;
  padding: 24px;
  max-width: 900px;
  width: 90%;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
}

.live-scoreboard {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 32px;
  background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(59, 130, 246, 0.1));
  border-radius: 12px;
  margin-bottom: 24px;
  border: 1px solid rgba(16, 185, 129, 0.2);
}

.live-team {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
  flex: 1;
}

.live-team-name {
  font-size: 1.4em;
  font-weight: 700;
  color: #f1f5f9;
  text-align: center;
}

.live-score {
  font-size: 4em;
  font-weight: 900;
  color: #10b981;
  text-shadow: 0 0 20px rgba(16, 185, 129, 0.5);
  font-variant-numeric: tabular-nums;
}

.live-clock {
  font-size: 1.8em;
  font-weight: 700;
  color: #fbbf24;
  padding: 12px 24px;
  background: rgba(251, 191, 36, 0.1);
  border-radius: 8px;
  border: 1px solid rgba(251, 191, 36, 0.3);
  min-width: 100px;
  text-align: center;
}

.live-controls {
  display: flex;
  gap: 12px;
  justify-content: center;
  margin-bottom: 24px;
  flex-wrap: wrap;
}

.live-controls button {
  padding: 10px 20px;
  background: rgba(59, 130, 246, 0.2);
  border: 1px solid rgba(59, 130, 246, 0.4);
  color: #60a5fa;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.2s ease;
}

.live-controls button:hover {
  background: rgba(59, 130, 246, 0.3);
  transform: translateY(-2px);
}

.live-timeline {
  max-height: 400px;
  overflow-y: auto;
  padding: 16px;
  background: rgba(0, 0, 0, 0.3);
  border-radius: 12px;
  border: 1px solid rgba(71, 85, 105, 0.3);
}

.timeline-event {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 14px;
  margin-bottom: 10px;
  background: rgba(30, 41, 59, 0.6);
  border-radius: 8px;
  border-left: 3px solid rgba(71, 85, 105, 0.5);
  animation: slideInLeft 0.3s ease;
}

@keyframes slideInLeft {
  from {
    opacity: 0;
    transform: translateX(-20px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

.timeline-event.event-goal {
  border-left-color: #10b981;
  background: rgba(16, 185, 129, 0.1);
}

.timeline-event.event-yellow {
  border-left-color: #fbbf24;
}

.timeline-event.event-red {
  border-left-color: #ef4444;
}

.event-minute {
  font-weight: 700;
  color: #fbbf24;
  font-size: 1.1em;
  min-width: 40px;
}

.event-icon {
  font-size: 1.5em;
}

.event-text {
  color: #e2e8f0;
  font-weight: 500;
  flex: 1;
}

/* Export Menu */
.export-menu {
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(16, 185, 129, 0.1));
  border: 1px solid rgba(59, 130, 246, 0.3);
  border-radius: 12px;
  padding: 16px;
  margin: 20px 0;
  position: relative;
  z-index: 1;
}

.export-menu h3 {
  color: #60a5fa;
  margin-bottom: 12px;
  font-size: 1.1em;
}

.export-menu button {
  width: 100%;
  margin-bottom: 8px;
  padding: 12px;
  background: rgba(59, 130, 246, 0.2);
  border: 1px solid rgba(59, 130, 246, 0.3);
  color: #60a5fa;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.export-menu button:hover {
  background: rgba(59, 130, 246, 0.3);
  transform: translateX(4px);
}

/* Undo/Redo Controls */
.history-controls {
  display: flex;
  gap: 8px;
  margin-bottom: 12px;
}

.history-controls button {
  flex: 1;
  padding: 10px;
  background: rgba(168, 85, 247, 0.2);
  border: 1px solid rgba(168, 85, 247, 0.3);
  color: #c084fc;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.2s ease;
}

.history-controls button:disabled {
  opacity: 0.3;
  cursor: not-allowed;
}

.history-controls button:not(:disabled):hover {
  background: rgba(168, 85, 247, 0.3);
  transform: scale(1.05);
}

/* Search & Filter */
.search-filter-container {
  background: linear-gradient(135deg, rgba(30, 41, 59, 0.6), rgba(15, 23, 42, 0.6));
  border: 1px solid rgba(71, 85, 105, 0.3);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
}

.search-input {
  width: 100%;
  padding: 14px;
  background: rgba(15, 23, 42, 0.6);
  border: 1px solid rgba(71, 85, 105, 0.4);
  border-radius: 8px;
  color: #f1f5f9;
  font-size: 1em;
  margin-bottom: 16px;
  transition: all 0.2s ease;
}

.search-input:focus {
  outline: none;
  border-color: #10b981;
  box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
}

.filter-group {
  margin-bottom: 16px;
}

.filter-group label {
  display: block;
  color: #94a3b8;
  font-size: 0.9em;
  font-weight: 600;
  margin-bottom: 8px;
}

.filter-group select,
.filter-group input[type="range"] {
  width: 100%;
  padding: 10px;
  background: rgba(15, 23, 42, 0.6);
  border: 1px solid rgba(71, 85, 105, 0.4);
  border-radius: 8px;
  color: #f1f5f9;
}

.rating-display {
  display: flex;
  justify-content: space-between;
  color: #10b981;
  font-weight: 600;
  font-size: 0.9em;
  margin-top: 4px;
}

.filtered-teams-list {
  max-height: 400px;
  overflow-y: auto;
  margin-top: 16px;
}

.team-card {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px;
  margin-bottom: 8px;
  background: rgba(30, 41, 59, 0.6);
  border: 1px solid rgba(71, 85, 105, 0.3);
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.team-card:hover {
  background: rgba(59, 130, 246, 0.1);
  border-color: rgba(59, 130, 246, 0.4);
  transform: translateX(4px);
}

.team-card-name {
  font-weight: 600;
  color: #f1f5f9;
}

.team-card-rating {
  padding: 4px 12px;
  background: rgba(16, 185, 129, 0.2);
  border: 1px solid rgba(16, 185, 129, 0.3);
  border-radius: 6px;
  color: #10b981;
  font-weight: 700;
  font-size: 0.9em;
}

.no-results {
  text-align: center;
  color: #64748b;
  padding: 40px;
  font-style: italic;
}

/* Sound Controls */
.sound-controls {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  background: rgba(168, 85, 247, 0.1);
  border: 1px solid rgba(168, 85, 247, 0.3);
  border-radius: 8px;
  margin-bottom: 12px;
}

.sound-toggle {
  padding: 8px 16px;
  background: rgba(168, 85, 247, 0.2);
  border: 1px solid rgba(168, 85, 247, 0.3);
  color: #c084fc;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.2s ease;
}

.sound-toggle:hover {
  background: rgba(168, 85, 247, 0.3);
}

.sound-toggle.muted {
  opacity: 0.5;
  text-decoration: line-through;
}

.volume-slider {
  flex: 1;
  -webkit-appearance: none;
  appearance: none;
  height: 6px;
  border-radius: 3px;
  background: rgba(168, 85, 247, 0.2);
  outline: none;
}

.volume-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: #c084fc;
  cursor: pointer;
}

/* Tournament Templates */
.template-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
  gap: 16px;
  margin-top: 16px;
}

.template-card {
  background: linear-gradient(135deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.8));
  border: 1px solid rgba(71, 85, 105, 0.3);
  border-radius: 12px;
  padding: 20px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.template-card:hover {
  border-color: #10b981;
  transform: translateY(-4px);
  box-shadow: 0 8px 24px rgba(16, 185, 129, 0.2);
}

.template-icon {
  font-size: 3em;
  text-align: center;
  margin-bottom: 12px;
}

.template-name {
  font-size: 1.2em;
  font-weight: 700;
  color: #f1f5f9;
  margin-bottom: 8px;
  text-align: center;
}

.template-desc {
  font-size: 0.9em;
  color: #94a3b8;
  text-align: center;
  line-height: 1.5;
}

/* Prediction System */
.prediction-panel {
  background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(245, 158, 11, 0.1));
  border: 1px solid rgba(251, 191, 36, 0.3);
  border-radius: 12px;
  padding: 20px;
  margin: 20px 0;
}

.prediction-match {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 16px;
  background: rgba(15, 23, 42, 0.6);
  border-radius: 8px;
  margin-bottom: 12px;
}

.prediction-team {
  flex: 1;
  text-align: center;
  font-weight: 600;
  color: #f1f5f9;
}

.prediction-buttons {
  display: flex;
  gap: 8px;
}

.prediction-btn {
  padding: 8px 16px;
  background: rgba(251, 191, 36, 0.2);
  border: 1px solid rgba(251, 191, 36, 0.3);
  color: #fbbf24;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.2s ease;
}

.prediction-btn:hover {
  background: rgba(251, 191, 36, 0.3);
  transform: scale(1.05);
}

.prediction-btn.selected {
  background: rgba(251, 191, 36, 0.4);
  border-color: #fbbf24;
  box-shadow: 0 0 12px rgba(251, 191, 36, 0.3);
}

.prediction-score {
  text-align: center;
  padding: 16px;
  background: rgba(16, 185, 129, 0.1);
  border-radius: 8px;
  margin-top: 16px;
}

.prediction-accuracy {
  font-size: 2em;
  font-weight: 900;
  color: #10b981;
}

/* Print Styles */
@media print {
  body {
    background: white !important;
    color: black !important;
  }

  .sidebar,
  header,
  .theme-toggle-btn,
  #quickActionsBar,
  #themeSwitcher,
  .ctrl-btn,
  .export-menu,
  .history-controls,
  .sound-controls,
  button {
    display: none !important;
  }

  .main-content,
  .control-column,
  #output {
    width: 100% !important;
    max-width: 100% !important;
    margin: 0 !important;
    padding: 20px !important;
  }

  .bracket-container,
  .group-grid,
  table {
    page-break-inside: avoid;
  }

  * {
    background: white !important;
    color: black !important;
    border-color: #333 !important;
  }

  h1, h2, h3 {
    color: #000 !important;
  }
}

/* Mobile Optimizations for New Features */
@media (max-width: 640px) {
  .live-scoreboard {
    flex-direction: column;
    padding: 20px;
    gap: 16px;
  }

  .live-score {
    font-size: 3em;
  }

  .live-clock {
    font-size: 1.4em;
  }

  .template-grid {
    grid-template-columns: 1fr;
  }

  .export-menu button {
    font-size: 0.9em;
  }

  .live-controls {
    flex-direction: column;
  }

  .live-controls button {
    width: 100%;
  }
}

/* Achievement & Manager XP Animations */
@keyframes slideInAchievement {
  from {
    right: -400px;
    opacity: 0;
  }
  to {
    right: 20px;
    opacity: 1;
  }
}

@keyframes slideOutAchievement {
  from {
    right: 20px;
    opacity: 1;
  }
  to {
    right: -400px;
    opacity: 0;
  }
}

@keyframes bounce {
  0%, 100% {
    transform: scale(1);
  }
  25% {
    transform: scale(1.2);
  }
  50% {
    transform: scale(0.9);
  }
  75% {
    transform: scale(1.1);
  }
}

@keyframes fadeOut {
  from {
    opacity: 1;
  }
  to {
    opacity: 0;
  }
}

@keyframes slideInRight {
  from {
    transform: translateX(400px);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

/* ========================================
   OVERALL LAYOUT IMPROVEMENTS
   ======================================== */

/* Smooth Transitions */
* {
  transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
}

/* Button Improvements */
.btn-primary, .btn-secondary, .btn-warning {
  position: relative;
  overflow: hidden;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.btn-primary:hover, .btn-secondary:hover {
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
  transform: translateY(-2px);
}

.btn-primary:active, .btn-secondary:active {
  transform: translateY(0);
}

/* Card Hover Effects */
[style*="border-radius: 16px"], [style*="border-radius: 12px"] {
  transition: all 0.3s ease;
}

/* Scrollbar Styling */
::-webkit-scrollbar {
  width: 12px;
  height: 12px;
}

::-webkit-scrollbar-track {
  background: rgba(30, 41, 59, 0.5);
  border-radius: 6px;
}

::-webkit-scrollbar-thumb {
  background: rgba(71, 85, 105, 0.8);
  border-radius: 6px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(94, 110, 135, 0.9);
}

/* Modal Backdrop */
.modal-backdrop {
  backdrop-filter: blur(8px);
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.modal-content {
  animation: slideUp 0.3s ease;
}

@keyframes slideUp {
  from {
    transform: translateY(50px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

/* Responsive Improvements */
@media (max-width: 768px) {
  [style*="grid-template-columns"] {
    grid-template-columns: 1fr !important;
  }

  .modal-content {
    max-width: 95% !important;
    margin: 10px !important;
  }
}

/* Focus Improvements */
button:focus, input:focus, select:focus {
  outline: 2px solid var(--primary);
  outline-offset: 2px;
}

/* Loading Animation */
@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

/* Notification Slide */
@keyframes slideInRight {
  from {
    transform: translateX(400px);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

/* Text Selection */
::selection {
  background: rgba(16, 185, 129, 0.3);
  color: #F1F5F9;
}

  </style>
</head>
<body>
<div class="page">
  <header>
    <div class="title-block">
      <h1>All-Time Football</h1>
      <div class="subtitle">64 legendary club sides • multi-era knockout simulator</div>
      <div class="tagline-row">
        <span class="chip">Dynamic match engine</span>
        <span class="chip">Player scoring tracker</span>
        <span class="chip">Two-leg ties & single-match finals</span>
      </div>
    </div>
    <div class="right-header">
      <button id="themeToggle" class="theme-toggle-btn" type="button">🌙 Dark / ☀️ Light</button>
      <div class="rng-mini">
        Upset factor: <span id="rngLabelMini">Balanced</span>
      </div>
    </div>
  </header>

  <!-- Tournament Progress Indicator -->
  <div class="tournament-progress-bar" id="tournamentProgress" style="display: none;">
    <div class="progress-step pending" data-stage="groups">📊 Groups</div>
    <div class="progress-step pending" data-stage="r32">🏆 R32</div>
    <div class="progress-step pending" data-stage="r16">🥇 R16</div>
    <div class="progress-step pending" data-stage="qf">🏅 QF</div>
    <div class="progress-step pending" data-stage="sf">⭐ SF</div>
    <div class="progress-step pending" data-stage="final">👑 Final</div>
  </div>

  <!-- Notification Container -->
  <div class="notification-container" id="notificationContainer"></div>

  <div class="layout">
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-header-title">All-Time Sim</div>
        <div class="teams-pill"><span id="teamCount">64</span> teams</div>
      </div>

      <!-- Manager Profile Card -->
      <div class="manager-profile-card">
        <div class="manager-profile-header">
          <div class="manager-profile-icon">⚽</div>
          <div class="manager-profile-info">
            <div style="display: flex; align-items: center; gap: 8px;">
              <div class="manager-profile-name" id="managerName">Manager</div>
              <button class="mini-btn" onclick="openManagerEditModal()">Edit</button>
            </div>
            <div class="manager-profile-level">
              <span class="manager-level-badge" id="managerLevel">Level 1</span>
              <span class="manager-level-xp" id="managerXP">0 / 1000 XP</span>
            </div>
          </div>
        </div>
        <div class="manager-xp-bar">
          <div class="manager-xp-fill" id="managerXPFill" style="width: 0%"></div>
        </div>
        <div class="manager-profile-stats">
          <div class="manager-stat">
            <div class="manager-stat-value" id="managerTournaments">0</div>
            <div class="manager-stat-label">Tournaments</div>
          </div>
          <div class="manager-stat">
            <div class="manager-stat-value" id="managerWinRate">0%</div>
            <div class="manager-stat-label">Win Rate</div>
          </div>
          <div class="manager-stat">
            <div class="manager-stat-value" id="managerGoals">0</div>
            <div class="manager-stat-label">Total Goals</div>
          </div>
        </div>
      </div>

      <!-- Tab Navigation -->
      <div class="sidebar-tabs">
        <button class="sidebar-tab active" data-tab="tournament" onclick="switchTab('tournament')">
          ⚽ Tournament
        </button>
        <button class="sidebar-tab" data-tab="views" onclick="switchTab('views')">
          📊 Views
        </button>
        <button class="sidebar-tab" data-tab="tools" onclick="switchTab('tools')">
          🛠️ Tools
        </button>
        <button class="sidebar-tab" data-tab="profile" onclick="switchTab('profile')">
          👤 Profile
        </button>
        <button class="sidebar-tab" data-tab="settings" onclick="switchTab('settings')">
          ⚙️ Settings
        </button>
      </div>

      <!-- Tournament Tab -->
      <div class="tab-content active" id="tab-tournament">
        <div class="control-column">
          <button class="ctrl-btn btn-green" id="btnDraw">
            <div class="ctrl-btn-main">
              <span class="ctrl-btn-title">Generate Groups</span>
              <span class="ctrl-btn-subtitle">Draw all 16 groups from seeded pots</span>
            </div>
            <span class="ctrl-btn-tag">Draw</span>
          </button>

          <button class="ctrl-btn btn-blue" id="btnGroupStage" disabled>
            <div class="ctrl-btn-main">
              <span class="ctrl-btn-title">Simulate Group Stage</span>
              <span class="ctrl-btn-subtitle">Home-and-away round-robin</span>
            </div>
            <span class="ctrl-btn-tag">Play</span>
          </button>

          <button class="ctrl-btn btn-orange" id="btnKnockouts" disabled>
            <div class="ctrl-btn-main">
              <span class="ctrl-btn-title">Run Knockouts</span>
              <span class="ctrl-btn-subtitle">R32 → R16 → QF → SF → Final</span>
            </div>
            <span class="ctrl-btn-tag">KO</span>
          </button>

          <button class="ctrl-btn btn-red" id="resetTournamentBtn" onclick="showResetConfirmationModal()">
            <div class="ctrl-btn-main">
              <span class="ctrl-btn-title">Reset Tournament</span>
              <span class="ctrl-btn-subtitle">Clear and start fresh</span>
            </div>
            <span class="ctrl-btn-tag">🗑️</span>
          </button>
        </div>
      </div>

      <!-- Views Tab -->
      <div class="tab-content" id="tab-views">
        <div class="control-column">
          <button class="ctrl-btn btn-purple" id="btnStats" disabled onclick="showPlayerStats()">
            <div class="ctrl-btn-main">
              <span class="ctrl-btn-title">Player & Match Stats</span>
              <span class="ctrl-btn-subtitle">Top scorers & tournament log</span>
            </div>
            <span class="ctrl-btn-tag">View</span>
          </button>

          <button class="ctrl-btn btn-purple" id="btnAllMatches" disabled onclick="showTournamentOverview()">
            <div class="ctrl-btn-main">
              <span class="ctrl-btn-title">All Matches</span>
              <span class="ctrl-btn-subtitle">Complete match results</span>
            </div>
            <span class="ctrl-btn-tag">View</span>
          </button>

          <button class="ctrl-btn btn-purple" id="btnMatchWeeks" disabled onclick="showMatchWeeks()">
            <div class="ctrl-btn-main">
              <span class="ctrl-btn-title">Matchdays</span>
              <span class="ctrl-btn-subtitle">View by matchday</span>
            </div>
            <span class="ctrl-btn-tag">View</span>
          </button>

          <button class="ctrl-btn btn-purple" id="btnBracket" disabled onclick="showTournamentBracket()">
            <div class="ctrl-btn-main">
              <span class="ctrl-btn-title">Tournament Bracket</span>
              <span class="ctrl-btn-subtitle">Knockout tree view</span>
            </div>
            <span class="ctrl-btn-tag">View</span>
          </button>

          <button class="ctrl-btn btn-purple" id="btnSimpleBracket" disabled onclick="showSimpleBracket()">
            <div class="ctrl-btn-main">
              <span class="ctrl-btn-title">Simple Bracket</span>
              <span class="ctrl-btn-subtitle">NCAA-style tree view</span>
            </div>
            <span class="ctrl-btn-tag">🏀</span>
          </button>

          <button class="ctrl-btn btn-purple" id="btnClubLegacy" onclick="showClubLegacy()">
            <div class="ctrl-btn-main">
              <span class="ctrl-btn-title">Club Legacy</span>
              <span class="ctrl-btn-subtitle">All-time achievements</span>
            </div>
            <span class="ctrl-btn-tag">Legacy</span>
          </button>

          <button class="ctrl-btn btn-orange" id="btnHallOfFame" onclick="showHallOfFame()">
            <div class="ctrl-btn-main">
              <span class="ctrl-btn-title">Hall of Fame</span>
              <span class="ctrl-btn-subtitle">Legends & all-time records</span>
            </div>
            <span class="ctrl-btn-tag">🏛️</span>
          </button>

          <button class="ctrl-btn btn-blue" id="btnTopPerformers" onclick="showTopPerformersCarousel()">
            <div class="ctrl-btn-main">
              <span class="ctrl-btn-title">Top Performers</span>
              <span class="ctrl-btn-subtitle">Best players carousel</span>
            </div>
            <span class="ctrl-btn-tag">⭐</span>
          </button>
        </div>
      </div>

      <!-- Tools Tab -->
      <div class="tab-content" id="tab-tools">
        <div class="control-column">
          <button class="ctrl-btn btn-purple" id="customMatchBtn" onclick="showEnhancedCustomMatch()">
            <div class="ctrl-btn-main">
              <span class="ctrl-btn-title">Custom Match</span>
              <span class="ctrl-btn-subtitle">Simulate any matchup</span>
            </div>
            <span class="ctrl-btn-tag">Friendly</span>
          </button>

          <button class="ctrl-btn btn-orange" id="btnAchievements" onclick="showTrophyCabinet()">
            <div class="ctrl-btn-main">
              <span class="ctrl-btn-title">Trophy Cabinet</span>
              <span class="ctrl-btn-subtitle">Unlocked achievements</span>
            </div>
            <span class="ctrl-btn-tag">🏆</span>
          </button>

          <button class="ctrl-btn btn-purple" id="btnHistory" onclick="openHistory()">
            <div class="ctrl-btn-main">
              <span class="ctrl-btn-title">Tournament History</span>
              <span class="ctrl-btn-subtitle">Past champions</span>
            </div>
            <span class="ctrl-btn-tag">Log</span>
          </button>

          <button class="ctrl-btn btn-blue" id="btnTournamentStats" onclick="showTournamentStatsSummary()">
            <div class="ctrl-btn-main">
              <span class="ctrl-btn-title">Tournament Stats</span>
              <span class="ctrl-btn-subtitle">Goals, upsets, records</span>
            </div>
            <span class="ctrl-btn-tag">📊</span>
          </button>

          <button class="ctrl-btn btn-red" id="btnMedicalRoom" onclick="showMedicalRoom()">
            <div class="ctrl-btn-main">
              <span class="ctrl-btn-title">Medical Room</span>
              <span class="ctrl-btn-subtitle">Injuries & suspensions</span>
            </div>
            <span class="ctrl-btn-tag">🏥</span>
          </button>

          <button class="ctrl-btn btn-green" id="btnClassicMatchups" onclick="showClassicMatchups()">
            <div class="ctrl-btn-main">
              <span class="ctrl-btn-title">Classic Matchups</span>
              <span class="ctrl-btn-subtitle">Historic "What If" battles</span>
            </div>
            <span class="ctrl-btn-tag">🎭</span>
          </button>

          <button class="ctrl-btn btn-blue" id="btnShareResults" onclick="shareResultsToClipboard()">
            <div class="ctrl-btn-main">
              <span class="ctrl-btn-title">Share Results</span>
              <span class="ctrl-btn-subtitle">Copy to clipboard</span>
            </div>
            <span class="ctrl-btn-tag">📋</span>
          </button>

          <button class="ctrl-btn btn-purple" id="btnQuickTournament" onclick="quickTournamentMode()">
            <div class="ctrl-btn-main">
              <span class="ctrl-btn-title">Quick Tournament</span>
              <span class="ctrl-btn-subtitle">Fast-forward simulation</span>
            </div>
            <span class="ctrl-btn-tag">⚡</span>
          </button>

          <button class="ctrl-btn btn-orange" id="btnTemplates" onclick="showTemplateManager()">
            <div class="ctrl-btn-main">
              <span class="ctrl-btn-title">Tournament Templates</span>
              <span class="ctrl-btn-subtitle">Save/Load setups</span>
            </div>
            <span class="ctrl-btn-tag">💾</span>
          </button>

          <button class="ctrl-btn btn-green" id="btnSaveTemplate" onclick="saveTournamentTemplate()">
            <div class="ctrl-btn-main">
              <span class="ctrl-btn-title">Save Template</span>
              <span class="ctrl-btn-subtitle">Store current setup</span>
            </div>
            <span class="ctrl-btn-tag">💾</span>
          </button>

          <button class="ctrl-btn btn-blue" id="btnCompareTournaments" onclick="showTournamentComparison()">
            <div class="ctrl-btn-main">
              <span class="ctrl-btn-title">Compare Tournaments</span>
              <span class="ctrl-btn-subtitle">Side-by-side stats</span>
            </div>
            <span class="ctrl-btn-tag">📊</span>
          </button>

          <button disabled style="opacity: 0.5; cursor: not-allowed;" title="Predictions not applicable to simulations" class="ctrl-btn btn-purple" id="btnPredictionToggle" onclick="togglePredictions()">
            <div class="ctrl-btn-main">
              <span class="ctrl-btn-title" id="predictionToggleTitle">🔮 Predictions: ON</span>
              <span class="ctrl-btn-subtitle" id="predictionToggleSubtitle">Making predictions</span>
            </div>
            <span class="ctrl-btn-tag">🔮</span>
          </button>

          <button disabled style="opacity: 0.5; cursor: not-allowed;" title="Predictions not applicable to simulations" class="ctrl-btn btn-purple" id="btnPredictionStats" onclick="displayPredictionStats()">
            <div class="ctrl-btn-main">
              <span class="ctrl-btn-title">📊 Prediction Stats</span>
              <span class="ctrl-btn-subtitle">View your accuracy</span>
            </div>
            <span class="ctrl-btn-tag">📈</span>
          </button>

          <button class="ctrl-btn btn-gold" id="btnManagerProfile" onclick="displayManagerProfile()">
            <div class="ctrl-btn-main">
              <span class="ctrl-btn-title">👤 Manager Profile</span>
              <span class="ctrl-btn-subtitle">View stats & progress</span>
            </div>
            <span class="ctrl-btn-tag">⭐</span>
          </button>

          <button class="ctrl-btn btn-purple" id="btnManagerCustomization" onclick="showManagerCustomization()">
            <div class="ctrl-btn-main">
              <span class="ctrl-btn-title">👔 Customize Manager</span>
              <span class="ctrl-btn-subtitle">Personalize appearance</span>
            </div>
            <span class="ctrl-btn-tag">✨</span>
          </button>

          <button class="ctrl-btn btn-purple" id="btnTournamentHistory" onclick="displayTournamentHistory()">
            <div class="ctrl-btn-main">
              <span class="ctrl-btn-title">📚 Tournament History</span>
              <span class="ctrl-btn-subtitle">View past tournaments</span>
            </div>
            <span class="ctrl-btn-tag">🏆</span>
          </button>
        </div>
      </div>

      <!-- Settings Tab -->
      <div class="tab-content" id="tab-settings">
        <div class="control-column">
          <div class="file-row">
            <input id="importSave" type="file" class="file-input" accept=".json">
            <button class="small-btn" type="button" id="importSaveBtn">📂 Load Save</button>
          </div>

          <div class="rng-block">
            <label for="difficultySelect">Difficulty Mode</label>
            <div class="rng-presets" style="margin-top: 8px;">
              <button class="rng-pill" type="button" data-difficulty="easy" onclick="setDifficulty('easy')">⭐ Beginner</button>
              <button class="rng-pill active" type="button" data-difficulty="normal" onclick="setDifficulty('normal')">⭐⭐ Normal</button>
              <button class="rng-pill" type="button" data-difficulty="hard" onclick="setDifficulty('hard')">⭐⭐⭐ Expert</button>
              <button class="rng-pill" type="button" data-difficulty="legendary" onclick="setDifficulty('legendary')">⭐⭐⭐⭐ Legend</button>
            </div>
            <div style="font-size: 0.8em; color: var(--text-muted); margin-top: 6px;" id="difficultyDescription">
              Balanced experience
            </div>
          </div>

          <div class="rng-block">
            <label for="rngSlider">Upset factor</label>
            <div class="rng-row">
              <input id="rngSlider" type="range" min="0.5" max="2.0" step="0.05" value="1.0"
                     oninput="updateRNG(this.value)">
              <span id="rngLabel">Balanced</span>
            </div>
            <div class="rng-presets">
              <button class="rng-pill" type="button" data-rng-value="0.6">Tight</button>
              <button class="rng-pill active" type="button" data-rng-value="1.0">Balanced</button>
              <button class="rng-pill" type="button" data-rng-value="1.3">Chaos</button>
              <button class="rng-pill" type="button" data-rng-value="1.7">Extreme</button>
            </div>
          </div>

          <!-- Simulation Speed Control -->
          <div class="control-section">
            <label for="simSpeedSlider">Simulation Speed</label>
            <div class="rng-row">
              <input id="simSpeedSlider" type="range" min="0" max="3" step="1" value="1"
                     oninput="updateSimSpeed(this.value)">
              <span id="simSpeedLabel">Normal</span>
            </div>
            <div class="rng-presets">
              <button class="rng-pill" type="button" data-speed-value="0">Instant</button>
              <button class="rng-pill active" type="button" data-speed-value="1">Fast</button>
              <button class="rng-pill" type="button" data-speed-value="2">Normal</button>
              <button class="rng-pill" type="button" data-speed-value="3">Slow</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Profile Tab -->
      <div class="tab-content" id="tab-profile">
        <div class="control-column">

          <!-- Career Stats Section -->
          <div class="profile-section">
            <div class="profile-section-header">
              <span class="profile-section-icon">📊</span>
              <span class="profile-section-title">Career Statistics</span>
            </div>
            <div class="profile-stats-grid">
              <div class="profile-stat-card">
                <div class="profile-stat-icon">🏆</div>
                <div class="profile-stat-content">
                  <div class="profile-stat-value" id="profileTournamentsWon">0</div>
                  <div class="profile-stat-label">Championships</div>
                </div>
              </div>
              <div class="profile-stat-card">
                <div class="profile-stat-icon">📈</div>
                <div class="profile-stat-content">
                  <div class="profile-stat-value" id="profileTournamentsPlayed">0</div>
                  <div class="profile-stat-label">Tournaments</div>
                </div>
              </div>
              <div class="profile-stat-card">
                <div class="profile-stat-icon">⚽</div>
                <div class="profile-stat-content">
                  <div class="profile-stat-value" id="profileTotalGoals">0</div>
                  <div class="profile-stat-label">Total Goals</div>
                </div>
              </div>
              <div class="profile-stat-card">
                <div class="profile-stat-icon">🎯</div>
                <div class="profile-stat-content">
                  <div class="profile-stat-value" id="profileAvgGoals">0.0</div>
                  <div class="profile-stat-label">Avg Goals/Match</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Tracked Team Section -->
          <div class="profile-section">
            <div class="profile-section-header">
              <span class="profile-section-icon">⭐</span>
              <span class="profile-section-title">Tracked Team</span>
            </div>
            <div class="tracked-team-card">
              <div class="tracked-team-header">
                <div class="tracked-team-info">
                  <div class="tracked-team-label">Your Team</div>
                  <div class="tracked-team-name" id="trackedTeamDisplay">No team selected</div>
                </div>
                <button class="mini-btn" onclick="showTrackTeamModal()">Change</button>
              </div>
              <div class="tracked-team-hint">
                Your tracked team's progress counts toward your career stats and achievements
              </div>
            </div>
          </div>

          <!-- Best Tournament Section -->
          <div class="profile-section">
            <div class="profile-section-header">
              <span class="profile-section-icon">🏆</span>
              <span class="profile-section-title">Best Tournament</span>
            </div>
            <div class="profile-best-tournament" id="profileBestTournament">
              <div class="profile-empty-state">
                <div class="profile-empty-icon">🏟️</div>
                <div class="profile-empty-text">Complete your first tournament!</div>
              </div>
            </div>
          </div>

          <!-- Achievement Progress Section -->
          <div class="profile-section">
            <div class="profile-section-header">
              <span class="profile-section-icon">🏅</span>
              <span class="profile-section-title">Achievement Progress</span>
            </div>
            <div class="profile-achievements" id="profileAchievements">
              <!-- Achievements will be populated here -->
            </div>
          </div>

        </div>
      </div>
    </aside>

    <main class="panel">
      <div id="output">
        <div class="empty-state">
          <div class="empty-icon">⚽️</div>
          <h2>Welcome to All-Time Sim</h2>
          <p class="output-sub">
            Start by generating the group draw to launch a full all-eras tournament – every run writes a different piece of football history.
          </p>
        </div>
      </div>
    </main>
  </div>
</div>

<div id="matchDetailModal" class="modal-backdrop" onclick="closeMatchDetail()">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-content">
        <div class="modal-head">
          <h3 id="matchDetailTitle">Match Detail</h3>
          <button class="modal-close" onclick="closeMatchDetail()">✕</button>
        </div>
        <div id="matchDetailBody" class="modal-body"></div>
      </div>
    </div>
  </div>
  
  <!-- Team detail modal -->
  <div id="teamDetailModal" class="modal-backdrop" onclick="closeTeamDetail()">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-content">
        <div class="modal-head">
          <h3 id="teamDetailTitle">Team Detail</h3>
          <button class="modal-close" onclick="closeTeamDetail()">✕</button>
        </div>
        <div id="teamDetailBody" class="modal-body"></div>
      </div>
    </div>
  </div>
  
  <!-- Custom match modal -->
  <div id="customMatchModal" class="modal-backdrop" onclick="closeCustomMatch()">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-content">
        <div class="modal-head">
          <h3>Custom Match</h3>
          <button class="modal-close" onclick="closeCustomMatch()">✕</button>
        </div>
        <div class="modal-body">
          <div class="section-label">Pick your teams</div>
          <input id="customMatchSearch" type="text" placeholder="🔍 Search teams..."
                 style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.3);
                        background: rgba(0, 0, 0, 0.3); color: #e2e8f0; font-size: 0.95rem; margin-bottom: 12px;"
                 oninput="filterCustomMatchTeams(this.value)">
          <div class="custom-row">
            <select id="customTeamA" size="6"></select>
            <select id="customTeamB" size="6"></select>
          </div>
          <div id="teamComparison" style="display: none;"></div>

          <div class="section-label" style="margin-top: 16px;">Match Settings</div>

          <div class="radio-row">
            <strong style="color: #e2e8f0; display: block; margin-bottom: 8px;">Venue</strong>
            <label><input type="radio" name="customVenue" value="neutral" checked> ⚖️ Neutral venue</label><br>
            <label><input type="radio" name="customVenue" value="homeA"> 🏠 Team A home advantage</label><br>
            <label><input type="radio" name="customVenue" value="homeB"> 🏟️ Team B home advantage</label>
          </div>

          <div class="radio-row" style="margin-top: 12px;">
            <strong style="color: #e2e8f0; display: block; margin-bottom: 8px;">Weather Conditions</strong>
            <label><input type="radio" name="customWeather" value="clear" checked> ☀️ Clear (Normal)</label><br>
            <label><input type="radio" name="customWeather" value="rainy"> 🌧️ Rainy (Slower pace)</label><br>
            <label><input type="radio" name="customWeather" value="windy"> 💨 Windy (More chaos)</label><br>
            <label><input type="radio" name="customWeather" value="snowy"> ❄️ Snowy (Very unpredictable)</label><br>
            <label><input type="radio" name="customWeather" value="hot"> 🔥 Hot (Affects stamina)</label>
          </div>

          <div style="margin-top: 12px;">
            <label for="customImportance" style="color: #e2e8f0; display: block; margin-bottom: 8px;">
              <strong>Match Importance</strong> <span id="customImportanceLabel" style="color: #3b82f6;">Normal</span>
            </label>
            <input id="customImportance" type="range" min="0.5" max="2.5" step="0.25" value="1.5"
                   style="width: 100%;"
                   oninput="updateCustomImportanceLabel(this.value)">
            <div style="display: flex; justify-content: space-between; font-size: 0.85rem; color: #94a3b8; margin-top: 4px;">
              <span>Friendly</span>
              <span>Normal</span>
              <span>Final</span>
            </div>
          </div>

          <button class="small-btn" type="button" onclick="simulateCustomMatch()" style="margin-top: 16px;">
            ⚽ Play Match
          </button>
          <div id="customMatchResult" style="margin-top:8px;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Manager Edit Modal -->
  <div id="managerEditModal" class="modal-backdrop" onclick="closeManagerEditModal()">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-content">
        <div class="modal-head">
          <h3>Edit Manager Profile</h3>
          <button class="modal-close" onclick="closeManagerEditModal()">✕</button>
        </div>
        <div class="modal-body">
          <label for="managerNameInput" style="display: block; margin-bottom: 8px; color: #e2e8f0; font-weight: 600;">Manager Name</label>
          <input id="managerNameInput" type="text" placeholder="Enter your name"
                 style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.3);
                        background: rgba(0, 0, 0, 0.3); color: #e2e8f0; font-size: 1rem; margin-bottom: 20px;"/>

          <label for="managerFavoriteTeamSearch" style="display: block; margin-bottom: 8px; color: #e2e8f0; font-weight: 600;">Favorite Team (Optional)</label>
          <input id="managerFavoriteTeamSearch" type="text" placeholder="🔍 Search teams..."
                 style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.3);
                        background: rgba(0, 0, 0, 0.3); color: #e2e8f0; font-size: 1rem; margin-bottom: 12px;"
                 oninput="filterManagerFavoriteTeams(this.value)">
          <select id="managerFavoriteTeamSelect"
                  size="6"
                  style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.3);
                         background: rgba(0, 0, 0, 0.3); color: #e2e8f0; font-size: 1rem; margin-bottom: 20px; min-height: 150px;">
            <option value="">-- No team selected --</option>
          </select>

          <div style="display: flex; gap: 10px;">
            <button onclick="saveManagerEdits()"
                    style="flex: 1; padding: 12px; background: linear-gradient(135deg, #10b981, #059669);
                           border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer;">
              Save Changes
            </button>
            <button onclick="closeManagerEditModal()"
                    style="flex: 1; padding: 12px; background: rgba(100, 100, 100, 0.3);
                           border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: #e2e8f0;
                           font-weight: 600; cursor: pointer;">
              Cancel
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Track Team Modal -->
  <div id="trackTeamModal" class="modal-backdrop" onclick="closeTrackTeamModal()">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-content">
        <div class="modal-head">
          <h3>Choose Your Team</h3>
          <button class="modal-close" onclick="closeTrackTeamModal()">✕</button>
        </div>
        <div class="modal-body">
          <p style="color: #94a3b8; margin-bottom: 16px;">This team's results will count toward your Manager career & achievements.</p>

          <input id="trackTeamSearch" type="text" placeholder="🔍 Search teams by name, year, or country..."
                 style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.3);
                        background: rgba(0, 0, 0, 0.3); color: #e2e8f0; font-size: 1rem; margin-bottom: 12px;"
                 oninput="filterTrackTeamOptions(this.value)">

          <select id="trackTeamSelect"
                  size="8"
                  style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.3);
                         background: rgba(0, 0, 0, 0.3); color: #e2e8f0; font-size: 1rem; margin-bottom: 20px; min-height: 200px;">
            <option value="">-- Select a team --</option>
          </select>

          <div style="display: flex; gap: 10px;">
            <button onclick="confirmTrackedTeam()"
                    style="flex: 1; padding: 12px; background: linear-gradient(135deg, #3b82f6, #2563eb);
                           border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer;">
              Confirm Selection
            </button>
            <button onclick="closeTrackTeamModal()"
                    style="flex: 1; padding: 12px; background: rgba(100, 100, 100, 0.3);
                           border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: #e2e8f0;
                           font-weight: 600; cursor: pointer;">
              Cancel
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- History modal -->
  <div id="historyModal" class="modal-backdrop" onclick="closeHistory()">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-content">
        <div class="modal-head">
          <h3>Tournament History</h3>
          <button class="modal-close" onclick="closeHistory()">✕</button>
        </div>
        <div id="historyBody" class="modal-body"></div>
      </div>
    </div>
  </div>

  <!-- Achievement Notification -->
  <div id="achievementNotification" class="achievement-notification"></div>

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-card">
      <div class="spinner"></div>
      <div id="loadingText">Working...</div>
      <div id="loadingProgress" class="loading-progress"></div>
    </div>
  </div>

<script>
    // Debug configuration - set to false to reduce console spam
    window.DEBUG_MODE = false;
    window.VERBOSE_LOGGING = false;

    window.TEAM_POOL = [
      {
        name: "2009 Barcelona",
        season: 2009,
        strength: 95,
        overall: 95,
        startingXI: [
          { name: "Víctor Valdés", pos: "GK", quality: 90 },
          { name: "Dani Alves", pos: "RB", quality: 94 },
          { name: "Carles Puyol", pos: "CB", quality: 96 },
          { name: "Gerard Piqué", pos: "CB", quality: 94 },
          { name: "Eric Abidal", pos: "LB", quality: 90 },
          { name: "Sergio Busquets", pos: "DM", quality: 92 },
          { name: "Xavi Hernández", pos: "CM", quality: 97 },
          { name: "Andrés Iniesta", pos: "CM", quality: 96 },
          { name: "Lionel Messi", pos: "RW", quality: 99 },
          { name: "Samuel Eto'o", pos: "ST", quality: 95 },
          { name: "Thierry Henry", pos: "LW", quality: 95 }
        ],
        bench: [
          { name: "José Manuel Pinto", pos: "GK", quality: 80 },
          { name: "Rafael Márquez", pos: "CB", quality: 88 },
          { name: "Seydou Keita", pos: "CM", quality: 86 },
          { name: "Yaya Touré", pos: "DM", quality: 90 },
          { name: "Bojan Krkić", pos: "ST", quality: 82 },
          { name: "Pedro", pos: "RW", quality: 84 },
          { name: "Martin Cáceres", pos: "CB", quality: 80 }
        ]
      },
      {
        name: "2011 Barcelona",
        season: 2011,
        strength: 96,
        overall: 96,
        startingXI: [
          { name: "Víctor Valdés", pos: "GK", quality: 91 },
          { name: "Dani Alves", pos: "RB", quality: 95 },
          { name: "Gerard Piqué", pos: "CB", quality: 95 },
          { name: "Javier Mascherano", pos: "CB", quality: 90 },
          { name: "Eric Abidal", pos: "LB", quality: 89 },
          { name: "Sergio Busquets", pos: "DM", quality: 94 },
          { name: "Xavi Hernández", pos: "CM", quality: 97 },
          { name: "Andrés Iniesta", pos: "CM", quality: 96 },
          { name: "Lionel Messi", pos: "FW", quality: 99 },
          { name: "David Villa", pos: "ST", quality: 93 },
          { name: "Pedro", pos: "RW", quality: 87 }
        ],
        bench: [
          { name: "José Manuel Pinto", pos: "GK", quality: 80 },
          { name: "Carles Puyol", pos: "CB", quality: 92 },
          { name: "Seydou Keita", pos: "CM", quality: 86 },
          { name: "Thiago Alcântara", pos: "CM", quality: 84 },
          { name: "Ibrahim Afellay", pos: "RW", quality: 82 },
          { name: "Bojan Krkić", pos: "ST", quality: 82 },
          { name: "Maxwell", pos: "LB", quality: 82 }
        ]
      },
      {
        name: "2005 AC Milan",
        season: 2005,
        strength: 93,
        overall: 93,
        startingXI: [
          { name: "Dida", pos: "GK", quality: 90 },
          { name: "Cafu", pos: "RB", quality: 92 },
          { name: "Jaap Stam", pos: "CB", quality: 92 },
          { name: "Alessandro Nesta", pos: "CB", quality: 95 },
          { name: "Paolo Maldini", pos: "LB", quality: 96 },
          { name: "Andrea Pirlo", pos: "CM", quality: 96 },
          { name: "Gennaro Gattuso", pos: "DM", quality: 89 },
          { name: "Clarence Seedorf", pos: "CM", quality: 93 },
          { name: "Kaká", pos: "AM", quality: 97 },
          { name: "Andriy Shevchenko", pos: "ST", quality: 96 },
          { name: "Hernán Crespo", pos: "ST", quality: 92 }
        ],
        bench: [
          { name: "Christian Abbiati", pos: "GK", quality: 82 },
          { name: "Serginho", pos: "LB", quality: 85 },
          { name: "Rui Costa", pos: "AM", quality: 90 },
          { name: "Massimo Ambrosini", pos: "CM", quality: 86 },
          { name: "Jon Dahl Tomasson", pos: "ST", quality: 84 },
          { name: "Marco Borriello", pos: "ST", quality: 79 },
          { name: "Kakhaber Kaladze", pos: "CB", quality: 86 }
        ]
      },
      {
        name: "1994 AC Milan",
        season: 1994,
        strength: 94,
        overall: 94,
        startingXI: [
          { name: "Sebastiano Rossi", pos: "GK", quality: 90 },
          { name: "Paolo Maldini", pos: "CB", quality: 95 },
          { name: "Franco Baresi", pos: "CB", quality: 97 },
          { name: "Mauro Tassotti", pos: "RB", quality: 90 },
          { name: "Christian Panucci", pos: "LB", quality: 88 },
          { name: "Demetrio Albertini", pos: "CM", quality: 92 },
          { name: "Marcel Desailly", pos: "DM", quality: 93 },
          { name: "Roberto Donadoni", pos: "RM", quality: 89 },
          { name: "Dejan Savićević", pos: "AM", quality: 95 },
          { name: "Daniele Massaro", pos: "ST", quality: 89 },
          { name: "Zvonimir Boban", pos: "CM", quality: 90 }
        ],
        bench: [
          { name: "Luca Bucci", pos: "GK", quality: 78 },
          { name: "Alessandro Orlando", pos: "LB", quality: 80 },
          { name: "Filippo Galli", pos: "CB", quality: 82 },
          { name: "Brian Laudrup", pos: "RW", quality: 87 },
          { name: "Jean-Pierre Papin", pos: "ST", quality: 90 },
          { name: "Marco Simone", pos: "ST", quality: 85 },
          { name: "Stefano Eranio", pos: "RM", quality: 82 }
        ]
      },
      {
        name: "1986 Steaua București",
        season: 1986,
        strength: 90,
        overall: 90,
        startingXI: [
          { name: "Helmut Duckadam", pos: "GK", quality: 90 },
          { name: "Ștefan Iovan", pos: "RB", quality: 84 },
          { name: "Adrian Bumbescu", pos: "CB", quality: 85 },
          { name: "Ilie Bărbulescu", pos: "LB", quality: 84 },
          { name: "Miodrag Belodedici", pos: "CB", quality: 88 },
          { name: "Ştefan Stoica", pos: "CM", quality: 84 },
          { name: "Gavril Balint", pos: "RW", quality: 88 },
          { name: "Ladislau Bölöni", pos: "CM", quality: 90 },
          { name: "Marius Lăcătuș", pos: "LW", quality: 90 },
          { name: "Victor Pițurcă", pos: "ST", quality: 87 },
          { name: "Marin Radu", pos: "ST", quality: 81 }
        ],
        bench: [
          { name: "Dumitru Stângaciu", pos: "GK", quality: 78 },
          { name: "Daniel Minea", pos: "CM", quality: 79 },
          { name: "Gheorghe Hagi", pos: "AM", quality: 92 },
          { name: "Adrian Negrău", pos: "ST", quality: 79 },
          { name: "Iulian Majearu", pos: "RW", quality: 80 },
          { name: "Ion Ion", pos: "ST", quality: 78 },
          { name: "Nicolae Ungureanu", pos: "LB", quality: 80 }
        ]
      },
      {
        name: "1997 Borussia Dortmund",
        season: 1997,
        strength: 88,
        startingXI: [
          { name: "Stefan Klos", pos: "GK", quality: 88 },
          { name: "Stefan Reuter", pos: "RB", quality: 87 },
          { name: "Jürgen Kohler", pos: "CB", quality: 89 },
          { name: "Martin Kree", pos: "CB", quality: 85 },
          { name: "Jörg Heinrich", pos: "LB", quality: 86 },
          { name: "Paulo Sousa", pos: "DM", quality: 88 },
          { name: "Paul Lambert", pos: "CM", quality: 86 },
          { name: "Andreas Möller", pos: "AM", quality: 90 },
          { name: "Lars Ricken", pos: "SS", quality: 87 },
          { name: "Karl-Heinz Riedle", pos: "ST", quality: 88 },
          { name: "Stéphane Chapuisat", pos: "ST", quality: 88 }
        ],
        bench: [
          { name: "Wolfgang de Beer", pos: "GK", quality: 76 },
          { name: "Matthias Sammer", pos: "CB", quality: 90 },
          { name: "Heiko Herrlich", pos: "ST", quality: 84 },
          { name: "Rene Tretschok", pos: "CM", quality: 82 },
          { name: "Michael Zorc", pos: "CM", quality: 84 },
          { name: "Ibrahim Tanko", pos: "RW", quality: 78 },
          { name: "Knut Reinhardt", pos: "RB", quality: 80 }
        ]
      },
      {
        name: "2014 Atlético Madrid",
        season: 2014,
        strength: 90,
        startingXI: [
        { name: "Thibaut Courtois", pos: "GK", quality: 90 },
    { name: "Juanfran", pos: "RB", quality: 85 },
    { name: "Miranda", pos: "CB", quality: 88 },
    { name: "Diego Godín", pos: "CB", quality: 89 },
    { name: "Filipe Luís", pos: "LB", quality: 86 },
    { name: "Gabi", pos: "CM", quality: 86 },
    { name: "Tiago", pos: "CM", quality: 84 },
    { name: "Koke", pos: "CM", quality: 87 },
    { name: "Arda Turan", pos: "RW", quality: 88 },
    { name: "Diego Costa", pos: "ST", quality: 92 },
    { name: "David Villa", pos: "LW", quality: 89 }
        ],
        bench: [
          { name: "Daniel Aranzubia", pos: "GK", quality: 75 },
          { name: "Toby Alderweireld", pos: "CB", quality: 83 },
          { name: "Mario Suárez", pos: "DM", quality: 82 },
          { name: "Raúl García", pos: "AM", quality: 84 },
          { name: "Cristian Rodríguez", pos: "LW", quality: 82 },
          { name: "José Sosa", pos: "AM", quality: 81 },
          { name: "Adrián López", pos: "FW", quality: 81 }
        ]
      },

      {
        name: "1996 Juventus",
        season: 1996,
        strength: 92,
        startingXI: [
          { name: "Angelo Peruzzi", pos: "GK", quality: 90 },
          { name: "Moreno Torricelli", pos: "RB", quality: 85 },
          { name: "Ciro Ferrara", pos: "CB", quality: 88 },
          { name: "Piero Vierchowod", pos: "CB", quality: 87 },
          { name: "Gianluca Pessotto", pos: "LB", quality: 85 },
          { name: "Didier Deschamps", pos: "DM", quality: 89 },
          { name: "Antonio Conte", pos: "CM", quality: 87 },
          { name: "Zinedine Zidane", pos: "AM", quality: 95 },
          { name: "Alessandro Del Piero", pos: "SS", quality: 93 },
          { name: "Fabrizio Ravanelli", pos: "ST", quality: 90 },
          { name: "Gianluca Vialli", pos: "ST", quality: 91 }
        ],
        bench: [
          { name: "Michelangelo Rampulla", pos: "GK", quality: 78 },
          { name: "Sergio Porrini", pos: "RB", quality: 82 },
          { name: "Paolo Sousa", pos: "CM", quality: 88 },
          { name: "Alessio Tacchinardi", pos: "DM", quality: 84 },
          { name: "Vladimir Jugović", pos: "CM", quality: 88 },
          { name: "Pietro Vierchowod", pos: "CB", quality: 85 },
          { name: "Nicola Amoruso", pos: "ST", quality: 80 }
        ]
      },

      {
        name: "1962 Benfica",
        season: 1962,
        strength: 92,
        startingXI: [
          { name: "Costa Pereira", pos: "GK", quality: 88 },
          { name: "Domiciano Cavém", pos: "RB", quality: 86 },
          { name: "Germano", pos: "CB", quality: 88 },
          { name: "Raúl Machado", pos: "CB", quality: 86 },
          { name: "Ângelo Martins", pos: "LB", quality: 86 },
          { name: "Mário Coluna", pos: "CM", quality: 92 },
          { name: "Fernando Cruz", pos: "DM", quality: 87 },
          { name: "José Augusto", pos: "RW", quality: 88 },
          { name: "Santana", pos: "AM", quality: 86 },
          { name: "Eusébio", pos: "ST", quality: 96 },
          { name: "José Águas", pos: "ST", quality: 90 }
        ],
        bench: [
          { name: "José Pereira", pos: "GK", quality: 75 },
          { name: "Jacinto Santos", pos: "CB", quality: 80 },
          { name: "Hilário", pos: "LW", quality: 84 },
          { name: "Serafim", pos: "RW", quality: 81 },
          { name: "Simões", pos: "LW", quality: 88 },
          { name: "Coluna Backup", pos: "CM", quality: 78 },
          { name: "Cavaleiro", pos: "MF", quality: 78 }
        ]
      },

      {
        name: "1963 Santos",
        season: 1963,
        strength: 93,
        startingXI: [
          { name: "Gilmar", pos: "GK", quality: 92 },
          { name: "Carlos Alberto", pos: "RB", quality: 92 },
          { name: "Mauro Ramos", pos: "CB", quality: 90 },
          { name: "Calvet", pos: "CB", quality: 87 },
          { name: "Dalmo", pos: "LB", quality: 86 },
          { name: "Zito", pos: "DM", quality: 90 },
          { name: "Mengálvio", pos: "CM", quality: 88 },
          { name: "Dorval", pos: "RW", quality: 89 },
          { name: "Coutinho", pos: "ST", quality: 92 },
          { name: "Pelé", pos: "SS", quality: 99 },
          { name: "Pepe", pos: "LW", quality: 92 }
        ],
        bench: [
          { name: "Laércio", pos: "GK", quality: 76 },
          { name: "Lima", pos: "DM", quality: 83 },
          { name: "Joel Camargo", pos: "CB", quality: 82 },
          { name: "Toninho Guerreiro", pos: "ST", quality: 84 },
          { name: "Haroldo", pos: "CM", quality: 80 },
          { name: "Batista", pos: "RW", quality: 79 },
          { name: "Pomar", pos: "LB", quality: 78 }
        ]
      },

      {
        name: "2019 Flamengo",
        season: 2019,
        strength: 88,
        startingXI: [
          { name: "Diego Alves", pos: "GK", quality: 86 },
          { name: "Rafinha", pos: "RB", quality: 86 },
          { name: "Rodrigo Caio", pos: "CB", quality: 86 },
          { name: "Pablo Marí", pos: "CB", quality: 85 },
          { name: "Filipe Luís", pos: "LB", quality: 87 },
          { name: "Gerson", pos: "CM", quality: 86 },
          { name: "Willian Arão", pos: "DM", quality: 84 },
          { name: "Éverton Ribeiro", pos: "AM", quality: 88 },
          { name: "Giorgian de Arrascaeta", pos: "AM", quality: 89 },
          { name: "Bruno Henrique", pos: "LW", quality: 88 },
          { name: "Gabigol", pos: "ST", quality: 89 }
        ],
        bench: [
          { name: "César", pos: "GK", quality: 77 },
          { name: "Matheus Thuler", pos: "CB", quality: 78 },
          { name: "Renê", pos: "LB", quality: 79 },
          { name: "Diego", pos: "AM", quality: 84 },
          { name: "Vitinho", pos: "LW", quality: 82 },
          { name: "Lincoln", pos: "ST", quality: 76 },
          { name: "Reinier", pos: "AM", quality: 80 }
        ]
      },

      {
        name: "2018 River Plate",
        season: 2018,
        strength: 88,
        startingXI: [
          { name: "Franco Armani", pos: "GK", quality: 86 },
          { name: "Gonzalo Montiel", pos: "RB", quality: 84 },
          { name: "Jonatan Maidana", pos: "CB", quality: 84 },
          { name: "Javier Pinola", pos: "CB", quality: 85 },
          { name: "Milton Casco", pos: "LB", quality: 84 },
          { name: "Enzo Pérez", pos: "CM", quality: 86 },
          { name: "Exequiel Palacios", pos: "CM", quality: 85 },
          { name: "Ignacio Fernández", pos: "AM", quality: 87 },
          { name: "Pity Martínez", pos: "LW", quality: 86 },
          { name: "Lucas Pratto", pos: "ST", quality: 86 },
          { name: "Rafael Santos Borré", pos: "ST", quality: 85 }
        ],
        bench: [
          { name: "Germán Lux", pos: "GK", quality: 77 },
          { name: "Camilo Mayada", pos: "RB", quality: 81 },
          { name: "Bruno Zuculini", pos: "DM", quality: 80 },
          { name: "Juan Fernando Quintero", pos: "AM", quality: 87 },
          { name: "Rodrigo Mora", pos: "ST", quality: 80 },
          { name: "Nacho Scocco", pos: "ST", quality: 84 },
          { name: "Leonardo Ponzio", pos: "DM", quality: 83 }
        ]
      },

      {
        name: "2003 Boca Juniors",
        season: 2003,
        strength: 90,
        startingXI: [
          { name: "Roberto Abbondanzieri", pos: "GK", quality: 87 },
          { name: "Hugo Ibarra", pos: "RB", quality: 86 },
          { name: "Nicolás Burdisso", pos: "CB", quality: 86 },
          { name: "Rolando Schiavi", pos: "CB", quality: 87 },
          { name: "Clemente Rodríguez", pos: "LB", quality: 86 },
          { name: "Sebastián Battaglia", pos: "DM", quality: 86 },
          { name: "Raúl Cascini", pos: "CM", quality: 84 },
          { name: "Marcelo Delgado", pos: "RW", quality: 84 },
          { name: "Juan Román Riquelme", pos: "AM", quality: 93 },
          { name: "Carlos Tevez", pos: "ST", quality: 90 },
          { name: "Martín Palermo", pos: "ST", quality: 89 }
        ],
        bench: [
          { name: "Wilfredo Caballero", pos: "GK", quality: 77 },
          { name: "Pablo Ledesma", pos: "RW", quality: 78 },
          { name: "Pablo Jerez", pos: "RB", quality: 77 },
          { name: "Diego Cagna", pos: "CM", quality: 81 },
          { name: "Franco Cángele", pos: "AM", quality: 79 },
          { name: "Guillermo Barros Schelotto", pos: "RW", quality: 85 },
          { name: "Roberto Colautti", pos: "ST", quality: 78 }
        ]
      },

      {
        name: "1992 São Paulo",
        season: 1992,
        strength: 89,
        startingXI: [
          { name: "Zetti", pos: "GK", quality: 88 },
          { name: "Cafu", pos: "RB", quality: 90 },
          { name: "Ronaldão", pos: "CB", quality: 86 },
          { name: "Iván", pos: "CB", quality: 84 },
          { name: "André Luiz", pos: "LB", quality: 83 },
          { name: "Toninho Cerezo", pos: "CM", quality: 88 },
          { name: "Dinho", pos: "DM", quality: 83 },
          { name: "Raí", pos: "AM", quality: 90 },
          { name: "Pintado", pos: "CM", quality: 82 },
          { name: "Müller", pos: "ST", quality: 87 },
          { name: "Palhinha", pos: "ST", quality: 86 }
        ],
        bench: [
          { name: "Gilberto", pos: "GK", quality: 76 },
          { name: "Vítor", pos: "RB", quality: 80 },
          { name: "Adílson", pos: "CB", quality: 79 },
          { name: "Bernardinho", pos: "CM", quality: 78 },
          { name: "Vizolli", pos: "DM", quality: 77 },
          { name: "Elivelton", pos: "LW", quality: 82 },
          { name: "Edmilson", pos: "ST", quality: 79 }
        ]
      },

      {
        name: "2012 Corinthians",
        season: 2012,
        strength: 86,
        startingXI: [
          { name: "Cássio", pos: "GK", quality: 88 },
          { name: "Alessandro", pos: "RB", quality: 84 },
          { name: "Chicão", pos: "CB", quality: 83 },
          { name: "Paulo André", pos: "CB", quality: 82 },
          { name: "Fábio Santos", pos: "LB", quality: 83 },
          { name: "Ralf", pos: "DM", quality: 85 },
          { name: "Paulinho", pos: "CM", quality: 86 },
          { name: "Danilo", pos: "AM", quality: 85 },
          { name: "Jorge Henrique", pos: "RW", quality: 82 },
          { name: "Emerson Sheik", pos: "ST", quality: 85 },
          { name: "Fábio Guerrero", pos: "LW", quality: 80 }
        ],
        bench: [
          { name: "Julio Cesar", pos: "GK", quality: 75 },
          { name: "Wallace", pos: "CB", quality: 78 },
          { name: "Douglas", pos: "CM", quality: 80 },
          { name: "Romarinho", pos: "ST", quality: 82 },
          { name: "Giovanni Augusto", pos: "AM", quality: 79 },
          { name: "Paulo Victor", pos: "LB", quality: 77 },
          { name: "Willian", pos: "RW", quality: 78 }
        ]
      },

      {
        name: "1988 PSV Eindhoven",
        season: 1988,
        strength: 89,
        startingXI: [
          { name: "Hans van Breukelen", pos: "GK", quality: 88 },
          { name: "Eric Gerets", pos: "RB", quality: 88 },
          { name: "Ronald Koeman", pos: "CB", quality: 90 },
          { name: "Ivan Nielsen", pos: "CB", quality: 85 },
          { name: "Jan Heintze", pos: "LB", quality: 86 },
          { name: "Søren Lerby", pos: "CM", quality: 87 },
          { name: "Gerald Vanenburg", pos: "RM", quality: 88 },
          { name: "Arnold Scholten", pos: "DM", quality: 84 },
          { name: "Hans Gillhaus", pos: "LW", quality: 87 },
          { name: "Wim Kieft", pos: "ST", quality: 88 },
          { name: "Ephraim Chukwu", pos: "RW", quality: 82 }
        ],
        bench: [
          { name: "Berry van Aerle", pos: "RB", quality: 83 },
          { name: "Adick Koot", pos: "CB", quality: 80 },
          { name: "Ellery Cairo", pos: "RW", quality: 79 },
          { name: "Juul Ellerman", pos: "ST", quality: 80 },
          { name: "René van der Gijp", pos: "LM", quality: 78 },
          { name: "Ger Sereď", pos: "DM", quality: 77 },
          { name: "Willy van de Kerkhof", pos: "CM", quality: 82 }
        ]
      },

      {
        name: "1979 Nottingham Forest",
        season: 1979,
        strength: 87,
        startingXI: [
          { name: "Peter Shilton", pos: "GK", quality: 89 },
          { name: "Viv Anderson", pos: "RB", quality: 87 },
          { name: "Larry Lloyd", pos: "CB", quality: 86 },
          { name: "Kenny Burns", pos: "CB", quality: 86 },
          { name: "Frank Clark", pos: "LB", quality: 84 },
          { name: "Martin O'Neill", pos: "RM", quality: 86 },
          { name: "John McGovern", pos: "CM", quality: 85 },
          { name: "Ian Bowyer", pos: "CM", quality: 84 },
          { name: "John Robertson", pos: "LW", quality: 87 },
          { name: "Trevor Francis", pos: "ST", quality: 88 },
          { name: "Garry Birtles", pos: "ST", quality: 84 }
        ],
        bench: [
          { name: "Chris Woods", pos: "GK", quality: 76 },
          { name: "Colin Barrett", pos: "RB", quality: 80 },
          { name: "David Needham", pos: "CB", quality: 79 },
          { name: "Steve Elliott", pos: "CM", quality: 78 },
          { name: "Tony Woodcock", pos: "ST", quality: 85 },
          { name: "Brian Rice", pos: "CM", quality: 77 },
          { name: "John Middleton", pos: "GK", quality: 73 }
        ]
      },

      {
        name: "1968 Estudiantes",
        season: 1968,
        strength: 87,
        startingXI: [
          { name: "Alberto Poletti", pos: "GK", quality: 86 },
          { name: "Ramón Aguirre Suárez", pos: "RB", quality: 86 },
          { name: "Oscar Malbernat", pos: "CB", quality: 85 },
          { name: "Raúl Madero", pos: "CB", quality: 85 },
          { name: "Juan Echecopar", pos: "LB", quality: 84 },
          { name: "Carlos Bilardo", pos: "DM", quality: 86 },
          { name: "Eduardo Flores", pos: "CM", quality: 84 },
          { name: "Juan Ramón Verón", pos: "AM", quality: 88 },
          { name: "Felipe Ribaudo", pos: "RM", quality: 82 },
          { name: "Marcos Conigliaro", pos: "ST", quality: 84 },
          { name: "Hugo Medina", pos: "LW", quality: 83 }
        ],
        bench: [
          { name: "Jorge Solari", pos: "CM", quality: 81 },
          { name: "Néstor Togneri", pos: "CB", quality: 80 },
          { name: "Carlos Pachamé", pos: "DM", quality: 81 },
          { name: "Raúl Horacio Madero", pos: "DF", quality: 79 },
          { name: "Juan Trebucq", pos: "FW", quality: 80 },
          { name: "Alfredo Gironacci", pos: "LW", quality: 77 },
          { name: "Luis Medina", pos: "RW", quality: 76 }
        ]
      },

      {
        name: "1967 Celtic",
        season: 1967,
        strength: 90,
        startingXI: [
          { name: "Ronnie Simpson", pos: "GK", quality: 87 },
          { name: "Jim Craig", pos: "RB", quality: 86 },
          { name: "Billy McNeill", pos: "CB", quality: 88 },
          { name: "John Clark", pos: "CB", quality: 85 },
          { name: "Tommy Gemmell", pos: "LB", quality: 88 },
          { name: "Bertie Auld", pos: "CM", quality: 87 },
          { name: "Bobby Murdoch", pos: "CM", quality: 88 },
          { name: "Jimmy Johnstone", pos: "RW", quality: 89 },
          { name: "Willie Wallace", pos: "ST", quality: 86 },
          { name: "Stevie Chalmers", pos: "ST", quality: 85 },
          { name: "Bobby Lennox", pos: "LW", quality: 88 }
        ],
        bench: [
          { name: "John Fallon", pos: "GK", quality: 76 },
          { name: "Chris Shevlane", pos: "RB", quality: 80 },
          { name: "Davie Cattenach", pos: "CB", quality: 79 },
          { name: "Charlie Gallagher", pos: "CM", quality: 82 },
          { name: "Paddy Turner", pos: "LW", quality: 78 },
          { name: "George Connelly", pos: "CM", quality: 81 },
          { name: "Jim Brogan", pos: "LB", quality: 80 }
        ]
      },

      {
        name: "1991 Marseille",
        season: 1991,
        strength: 89,
        startingXI: [
          { name: "Gaëtan Huard", pos: "GK", quality: 86 },
          { name: "Manuel Amoros", pos: "RB", quality: 88 },
          { name: "Carlos Mozer", pos: "CB", quality: 90 },
          { name: "Bernard Casoni", pos: "CB", quality: 86 },
          { name: "Éric Di Meco", pos: "LB", quality: 85 },
          { name: "Didier Deschamps", pos: "DM", quality: 89 },
          { name: "Jean Tigana", pos: "CM", quality: 88 },
          { name: "Abedi Pelé", pos: "AM", quality: 90 },
          { name: "Franck Sauzée", pos: "CM", quality: 88 },
          { name: "Jean-Pierre Papin", pos: "ST", quality: 94 },
          { name: "Chris Waddle", pos: "LW", quality: 90 }
        ],
        bench: [
          { name: "Pascal Olmeta", pos: "GK", quality: 78 },
          { name: "Alain Roche", pos: "CB", quality: 83 },
          { name: "Jürgen Röber", pos: "CM", quality: 79 },
          { name: "Jean-Christophe Thomas", pos: "DM", quality: 80 },
          { name: "Didier Six", pos: "LW", quality: 82 },
          { name: "Daniel Xuereb", pos: "ST", quality: 82 },
          { name: "Bernard Ferrer", pos: "FW", quality: 78 }
        ]
      },

      {
        name: "1990 Napoli",
        season: 1990,
        strength: 92,
        startingXI: [
          { name: "Giuseppe Taglialatela", pos: "GK", quality: 84 },
          { name: "Giancarlo Corradini", pos: "CB", quality: 86 },
          { name: "Ciro Ferrara", pos: "CB", quality: 90 },
          { name: "Giovanni Francini", pos: "LB", quality: 86 },
          { name: "Alessandro Renica", pos: "CB", quality: 85 },
          { name: "Fernando De Napoli", pos: "CM", quality: 87 },
          { name: "Luca Fusi", pos: "DM", quality: 85 },
          { name: "Massimo Crippa", pos: "CM", quality: 86 },
          { name: "Careca", pos: "ST", quality: 92 },
          { name: "Andrea Carnevale", pos: "ST", quality: 88 },
          { name: "Diego Maradona", pos: "AM", quality: 99 }
        ],
        bench: [
          { name: "Raffaele Di Fusco", pos: "GK", quality: 78 },
          { name: "Gianfranco Zola", pos: "AM", quality: 84 },
          { name: "Marco Baroni", pos: "CB", quality: 82 },
          { name: "Fausto Pari", pos: "CM", quality: 81 },
          { name: "Claudio Garella", pos: "GK", quality: 79 },
          { name: "Edoardo Bianchi", pos: "RW", quality: 80 },
          { name: "Gianluca Gaetano", pos: "FW", quality: 78 }
        ]
      },

      {
        name: "2006 Barcelona",
        season: 2006,
        strength: 94,
        startingXI: [
          { name: "Víctor Valdés", pos: "GK", quality: 88 },
          { name: "Oleguer Presas", pos: "RB", quality: 82 },
          { name: "Carles Puyol", pos: "CB", quality: 94 },
          { name: "Edmílson", pos: "CB", quality: 86 },
          { name: "Giovanni van Bronckhorst", pos: "LB", quality: 86 },
          { name: "Rafael Márquez", pos: "DM", quality: 88 },
          { name: "Xavi Hernández", pos: "CM", quality: 94 },
          { name: "Deco", pos: "CM", quality: 92 },
          { name: "Ronaldinho", pos: "LW", quality: 98 },
          { name: "Samuel Eto'o", pos: "ST", quality: 95 },
          { name: "Ludovic Giuly", pos: "RW", quality: 88 }
        ],
        bench: [
          { name: "José Reina", pos: "GK", quality: 80 },
          { name: "Sylvinho", pos: "LB", quality: 82 },
          { name: "Andrés Iniesta", pos: "CM", quality: 90 },
          { name: "Henrik Larsson", pos: "ST", quality: 86 },
          { name: "Thiago Motta", pos: "CM", quality: 84 },
          { name: "Juliano Belletti", pos: "RB", quality: 83 },
          { name: "Maxi López", pos: "ST", quality: 78 }
        ]
      },

      {
        name: "2005 Chelsea",
        season: 2005,
        strength: 93,
        startingXI: [
          { name: "Petr Čech", pos: "GK", quality: 95 },
          { name: "Paulo Ferreira", pos: "RB", quality: 86 },
          { name: "John Terry", pos: "CB", quality: 95 },
          { name: "Ricardo Carvalho", pos: "CB", quality: 92 },
          { name: "William Gallas", pos: "LB", quality: 88 },
          { name: "Claude Makélélé", pos: "DM", quality: 94 },
          { name: "Frank Lampard", pos: "CM", quality: 94 },
          { name: "Tiago", pos: "CM", quality: 86 },
          { name: "Arjen Robben", pos: "LW", quality: 92 },
          { name: "Didier Drogba", pos: "ST", quality: 92 },
          { name: "Damien Duff", pos: "RW", quality: 88 }
        ],
        bench: [
          { name: "Carlo Cudicini", pos: "GK", quality: 82 },
          { name: "Joe Cole", pos: "AM", quality: 88 },
          { name: "Eiður Guðjohnsen", pos: "ST", quality: 87 },
          { name: "Scott Parker", pos: "CM", quality: 82 },
          { name: "Jiri Jarosik", pos: "CM", quality: 80 },
          { name: "Mateja Kežman", pos: "ST", quality: 81 },
          { name: "Wayne Bridge", pos: "LB", quality: 82 }
        ]
      },  
{
  name: "1999 Manchester United",
  season: 1999,
  strength: 94,
  startingXI: [
    { name: "Peter Schmeichel", pos: "GK", quality: 95 },
    { name: "Gary Neville", pos: "RB", quality: 90 },
    { name: "Jaap Stam", pos: "CB", quality: 94 },
    { name: "Ronny Johnsen", pos: "CB", quality: 87 },
    { name: "Denis Irwin", pos: "LB", quality: 90 },
    { name: "Roy Keane", pos: "CM", quality: 95 },
    { name: "Paul Scholes", pos: "CM", quality: 93 },
    { name: "David Beckham", pos: "RM", quality: 94 },
    { name: "Ryan Giggs", pos: "LM", quality: 93 },
    { name: "Dwight Yorke", pos: "ST", quality: 92 },
    { name: "Andy Cole", pos: "ST", quality: 92 }
  ],
  bench: [
    { name: "Raymond van der Gouw", pos: "GK", quality: 78 },
    { name: "Nicky Butt", pos: "CM", quality: 86 },
    { name: "Ole Gunnar Solskjær", pos: "ST", quality: 90 },
    { name: "Teddy Sheringham", pos: "ST", quality: 88 },
    { name: "Henning Berg", pos: "CB", quality: 84 },
    { name: "Phil Neville", pos: "LB", quality: 82 },
    { name: "Jesper Blomqvist", pos: "LW", quality: 82 }
  ]
},

{
  name: "2008 Manchester United",
  season: 2008,
  strength: 95,
  startingXI: [
    { name: "Edwin van der Sar", pos: "GK", quality: 93 },
    { name: "Wes Brown", pos: "RB", quality: 85 },
    { name: "Rio Ferdinand", pos: "CB", quality: 95 },
    { name: "Nemanja Vidić", pos: "CB", quality: 95 },
    { name: "Patrice Evra", pos: "LB", quality: 92 },
    { name: "Michael Carrick", pos: "CM", quality: 90 },
    { name: "Paul Scholes", pos: "CM", quality: 92 },
    { name: "Cristiano Ronaldo", pos: "RW", quality: 98 },
    { name: "Wayne Rooney", pos: "ST", quality: 94 },
    { name: "Carlos Tevez", pos: "ST", quality: 92 },
    { name: "Ryan Giggs", pos: "LW", quality: 90 }
  ],
  bench: [
    { name: "Tomasz Kuszczak", pos: "GK", quality: 80 },
    { name: "John O'Shea", pos: "DF", quality: 83 },
    { name: "Nani", pos: "LW", quality: 86 },
    { name: "Anderson", pos: "CM", quality: 84 },
    { name: "Darren Fletcher", pos: "CM", quality: 84 },
    { name: "Park Ji-sung", pos: "RM", quality: 85 },
    { name: "Louis Saha", pos: "ST", quality: 84 }
  ]
},

{
  name: "2004 Arsenal",
  season: 2004,
  strength: 94,
  startingXI: [
    { name: "Jens Lehmann", pos: "GK", quality: 90 },
    { name: "Lauren", pos: "RB", quality: 88 },
    { name: "Sol Campbell", pos: "CB", quality: 94 },
    { name: "Kolo Touré", pos: "CB", quality: 92 },
    { name: "Ashley Cole", pos: "LB", quality: 93 },
    { name: "Patrick Vieira", pos: "CM", quality: 95 },
    { name: "Gilberto Silva", pos: "DM", quality: 90 },
    { name: "Robert Pirès", pos: "LW", quality: 93 },
    { name: "Freddie Ljungberg", pos: "RW", quality: 89 },
    { name: "Dennis Bergkamp", pos: "SS", quality: 94 },
    { name: "Thierry Henry", pos: "ST", quality: 98 }
  ],
  bench: [
    { name: "Stuart Taylor", pos: "GK", quality: 76 },
    { name: "Gaël Clichy", pos: "LB", quality: 80 },
    { name: "Ray Parlour", pos: "CM", quality: 82 },
    { name: "Edu", pos: "CM", quality: 84 },
    { name: "José Antonio Reyes", pos: "LW", quality: 88 },
    { name: "Sylvain Wiltord", pos: "ST", quality: 84 },
    { name: "Nwankwo Kanu", pos: "ST", quality: 86 }
  ]
},

{
  name: "2009 Chelsea",
  season: 2009,
  strength: 92,
  startingXI: [
    { name: "Petr Čech", pos: "GK", quality: 94 },
    { name: "Branislav Ivanović", pos: "RB", quality: 88 },
    { name: "John Terry", pos: "CB", quality: 94 },
    { name: "Ricardo Carvalho", pos: "CB", quality: 91 },
    { name: "Ashley Cole", pos: "LB", quality: 93 },
    { name: "Michael Essien", pos: "CM", quality: 93 },
    { name: "Frank Lampard", pos: "CM", quality: 95 },
    { name: "Deco", pos: "AM", quality: 89 },
    { name: "Joe Cole", pos: "RW", quality: 88 },
    { name: "Didier Drogba", pos: "ST", quality: 94 },
    { name: "Nicolas Anelka", pos: "ST", quality: 90 }
  ],
  bench: [
    { name: "Hilário", pos: "GK", quality: 75 },
    { name: "Alex", pos: "CB", quality: 84 },
    { name: "Florent Malouda", pos: "LW", quality: 86 },
    { name: "Salomon Kalou", pos: "FW", quality: 84 },
    { name: "John Obi Mikel", pos: "DM", quality: 83 },
    { name: "Juliano Belletti", pos: "RB", quality: 82 },
    { name: "Michael Ballack", pos: "CM", quality: 90 }
  ]
},

{
  name: "2013 Bayern Munich",
  season: 2013,
  strength: 96,
  startingXI: [
    { name: "Manuel Neuer", pos: "GK", quality: 97 },
    { name: "Philipp Lahm", pos: "RB", quality: 96 },
    { name: "Jérôme Boateng", pos: "CB", quality: 92 },
    { name: "Dante", pos: "CB", quality: 90 },
    { name: "David Alaba", pos: "LB", quality: 93 },
    { name: "Javi Martínez", pos: "DM", quality: 92 },
    { name: "Bastian Schweinsteiger", pos: "CM", quality: 94 },
    { name: "Thomas Müller", pos: "AM", quality: 93 },
    { name: "Arjen Robben", pos: "RW", quality: 96 },
    { name: "Franck Ribéry", pos: "LW", quality: 96 },
    { name: "Mario Mandžukić", pos: "ST", quality: 90 }
  ],
  bench: [
    { name: "Tom Starke", pos: "GK", quality: 75 },
    { name: "Xherdan Shaqiri", pos: "LW", quality: 86 },
    { name: "Mario Gómez", pos: "ST", quality: 88 },
    { name: "Luiz Gustavo", pos: "DM", quality: 84 },
    { name: "Claudio Pizarro", pos: "ST", quality: 84 },
    { name: "Rafinha", pos: "RB", quality: 82 },
    { name: "Toni Kroos", pos: "CM", quality: 91 }
  ]
},

{
  name: "2020 Bayern Munich",
  season: 2020,
  strength: 97,
  startingXI: [
    { name: "Manuel Neuer", pos: "GK", quality: 96 },
    { name: "Joshua Kimmich", pos: "RB", quality: 94 },
    { name: "David Alaba", pos: "CB", quality: 92 },
    { name: "Jérôme Boateng", pos: "CB", quality: 90 },
    { name: "Alphonso Davies", pos: "LB", quality: 92 },
    { name: "Leon Goretzka", pos: "CM", quality: 90 },
    { name: "Thiago Alcântara", pos: "CM", quality: 92 },
    { name: "Thomas Müller", pos: "AM", quality: 94 },
    { name: "Serge Gnabry", pos: "RW", quality: 92 },
    { name: "Kingsley Coman", pos: "LW", quality: 90 },
    { name: "Robert Lewandowski", pos: "ST", quality: 98 }
  ],
  bench: [
    { name: "Sven Ulreich", pos: "GK", quality: 78 },
    { name: "Lucas Hernández", pos: "CB", quality: 85 },
    { name: "Javi Martínez", pos: "DM", quality: 84 },
    { name: "Ivan Perišić", pos: "LW", quality: 86 },
    { name: "Corentin Tolisso", pos: "CM", quality: 83 },
    { name: "Philippe Coutinho", pos: "AM", quality: 89 },
    { name: "Joshua Zirkzee", pos: "ST", quality: 76 }
  ]
},

{
  name: "2002 Bayer Leverkusen",
  season: 2002,
  strength: 90,
  startingXI: [
    { name: "Hans-Jörg Butt", pos: "GK", quality: 87 },
    { name: "Sebastian Boenisch", pos: "RB", quality: 80 },
    { name: "Lúcio", pos: "CB", quality: 92 },
    { name: "Carsten Ramelow", pos: "CB", quality: 87 },
    { name: "Diego Placente", pos: "LB", quality: 84 },
    { name: "Michael Ballack", pos: "CM", quality: 95 },
    { name: "Zé Roberto", pos: "LW", quality: 92 },
    { name: "Bernd Schneider", pos: "RW", quality: 89 },
    { name: "Yıldıray Baştürk", pos: "AM", quality: 88 },
    { name: "Oliver Neuville", pos: "ST", quality: 85 },
    { name: "Dimitar Berbatov", pos: "ST", quality: 88 }
  ],
  bench: [
    { name: "Jörg Reinke", pos: "GK", quality: 76 },
    { name: "Boris Živković", pos: "RB", quality: 80 },
    { name: "Marko Babić", pos: "LB", quality: 82 },
    { name: "Ikechukwu Uche", pos: "ST", quality: 77 },
    { name: "Hanno Balitsch", pos: "CM", quality: 78 },
    { name: "Robson Ponte", pos: "AM", quality: 80 },
    { name: "Ulf Kirsten", pos: "ST", quality: 84 }
  ]
},

{
  name: "1998 Juventus",
  season: 1998,
  strength: 94,
  startingXI: [
    { name: "Angelo Peruzzi", pos: "GK", quality: 92 },
    { name: "Mark Iuliano", pos: "CB", quality: 86 },
    { name: "Ciro Ferrara", pos: "CB", quality: 90 },
    { name: "Paolo Montero", pos: "CB", quality: 88 },
    { name: "Gianluca Pessotto", pos: "LB", quality: 86 },
    { name: "Edgar Davids", pos: "CM", quality: 92 },
    { name: "Zinedine Zidane", pos: "AM", quality: 97 },
    { name: "Alessandro Del Piero", pos: "SS", quality: 95 },
    { name: "Filippo Inzaghi", pos: "ST", quality: 93 },
    { name: "Didier Deschamps", pos: "DM", quality: 89 },
    { name: "Angelo Di Livio", pos: "RM", quality: 86 }
  ],
  bench: [
    { name: "Michelangelo Rampulla", pos: "GK", quality: 78 },
    { name: "Alessio Tacchinardi", pos: "DM", quality: 84 },
    { name: "Daniel Fonseca", pos: "ST", quality: 82 },
    { name: "Antonio Conte", pos: "CM", quality: 87 },
    { name: "Paolo Sousa", pos: "CM", quality: 88 },
    { name: "Nicola Amoruso", pos: "ST", quality: 82 },
    { name: "Sergio Porrini", pos: "RB", quality: 82 }
  ]
},

{
  name: "1991 Red Star Belgrade",
  season: 1991,
  strength: 91,
  startingXI: [
    { name: "Stevan Stojanović", pos: "GK", quality: 88 },
    { name: "Refik Šabanadžović", pos: "RB", quality: 85 },
    { name: "Ilija Najdoski", pos: "CB", quality: 87 },
    { name: "Slobodan Marović", pos: "CB", quality: 86 },
    { name: "Miodrag Belodedici", pos: "CB", quality: 88 },
    { name: "Robert Prosinečki", pos: "CM", quality: 94 },
    { name: "Dejan Savićević", pos: "AM", quality: 95 },
    { name: "Vladimir Jugović", pos: "CM", quality: 90 },
    { name: "Darko Pančev", pos: "ST", quality: 92 },
    { name: "Mitar Mrkela", pos: "RW", quality: 84 },
    { name: "Dragan Stojković", pos: "SS", quality: 94 }
  ],
  bench: [
    { name: "Zvonko Milojević", pos: "GK", quality: 78 },
    { name: "Slaviša Jokanović", pos: "DM", quality: 82 },
    { name: "Dragisa Binić", pos: "RW", quality: 84 },
    { name: "Goran Vasilijević", pos: "CM", quality: 80 },
    { name: "Goran Milojević", pos: "ST", quality: 81 },
    { name: "Saša Ilić", pos: "AM", quality: 82 },
    { name: "Vladan Lukić", pos: "ST", quality: 80 }
  ]
},

{
  name: "2000 Valencia",
  season: 2000,
  strength: 89,
  startingXI: [
    { name: "Santiago Cañizares", pos: "GK", quality: 90 },
    { name: "Curro Torres", pos: "RB", quality: 84 },
    { name: "Mauricio Pellegrino", pos: "CB", quality: 86 },
    { name: "Roberto Ayala", pos: "CB", quality: 92 },
    { name: "Amedeo Carboni", pos: "LB", quality: 84 },
    { name: "Rubén Baraja", pos: "CM", quality: 90 },
    { name: "David Albelda", pos: "DM", quality: 88 },
    { name: "Gaizka Mendieta", pos: "AM", quality: 94 },
    { name: "Kily González", pos: "LW", quality: 88 },
    { name: "Claudio López", pos: "ST", quality: 90 },
    { name: "Pablo Aimar", pos: "AM", quality: 92 }
  ],
  bench: [
    { name: "Andrés Palop", pos: "GK", quality: 78 },
    { name: "Javier Farinós", pos: "CM", quality: 82 },
    { name: "Adrián Ilie", pos: "ST", quality: 84 },
    { name: "John Carew", pos: "ST", quality: 84 },
    { name: "Miguel Ángel Angulo", pos: "RW", quality: 84 },
    { name: "Francisco Rufete", pos: "RW", quality: 82 },
    { name: "Siete", pos: "LB", quality: 77 }
  ]
},

{
  name: "2001 Valencia",
  season: 2001,
  strength: 90,
  startingXI: [
    { name: "Santiago Cañizares", pos: "GK", quality: 90 },
    { name: "Angloma", pos: "RB", quality: 86 },
    { name: "Roberto Ayala", pos: "CB", quality: 92 },
    { name: "Mauricio Pellegrino", pos: "CB", quality: 86 },
    { name: "Amedeo Carboni", pos: "LB", quality: 84 },
    { name: "Rubén Baraja", pos: "CM", quality: 90 },
    { name: "David Albelda", pos: "DM", quality: 88 },
    { name: "Kily González", pos: "LW", quality: 87 },
    { name: "Vicente", pos: "LW", quality: 90 },
    { name: "Pablo Aimar", pos: "AM", quality: 92 },
    { name: "Juan Sánchez", pos: "ST", quality: 84 }
  ],
  bench: [
    { name: "Andrés Palop", pos: "GK", quality: 78 },
    { name: "Javier Farinós", pos: "CM", quality: 82 },
    { name: "Francisco Rufete", pos: "RW", quality: 82 },
    { name: "Miguel Ángel Angulo", pos: "RW", quality: 84 },
    { name: "John Carew", pos: "ST", quality: 84 },
    { name: "Zlatko Zahović", pos: "AM", quality: 85 },
    { name: "Siete", pos: "LB", quality: 77 }
  ]
},

{
  name: "1983 Hamburg",
  season: 1983,
  strength: 89,
  startingXI: [
    { name: "Uli Stein", pos: "GK", quality: 88 },
    { name: "Manfred Kaltz", pos: "RB", quality: 90 },
    { name: "Holger Hieronymus", pos: "CB", quality: 85 },
    { name: "Ditmar Jakobs", pos: "CB", quality: 87 },
    { name: "Bernd Wehmeyer", pos: "LB", quality: 84 },
    { name: "Felix Magath", pos: "AM", quality: 92 },
    { name: "Caspar Memering", pos: "CM", quality: 84 },
    { name: "Jürgen Milewski", pos: "LW", quality: 85 },
    { name: "Horst Hrubesch", pos: "ST", quality: 90 },
    { name: "Wolfgang Rolff", pos: "DM", quality: 85 },
    { name: "Thomas von Heesen", pos: "RW", quality: 84 }
  ],
  bench: [
    { name: "Rudi Kargus", pos: "GK", quality: 77 },
    { name: "Peter Nogly", pos: "DF", quality: 80 },
    { name: "Thomas von Heesen (Bench)", pos: "AM", quality: 82 },
    { name: "Jürgen Groh", pos: "DM", quality: 81 },
    { name: "Miroslav Votava", pos: "CM", quality: 83 },
    { name: "Derek", pos: "ST", quality: 78 },
    { name: "Klaus Fichtel", pos: "CB", quality: 79 }
  ]
},

{
  name: "2004 Porto",
  season: 2004,
  strength: 91,
  startingXI: [
    { name: "Vítor Baía", pos: "GK", quality: 91 },
    { name: "Paulo Ferreira", pos: "RB", quality: 86 },
    { name: "Ricardo Carvalho", pos: "CB", quality: 92 },
    { name: "Jorge Costa", pos: "CB", quality: 88 },
    { name: "Nuno Valente", pos: "LB", quality: 86 },
    { name: "Costinha", pos: "DM", quality: 88 },
    { name: "Maniche", pos: "CM", quality: 89 },
    { name: "Deco", pos: "AM", quality: 95 },
    { name: "Dmitri Alenichev", pos: "LW", quality: 85 },
    { name: "Carlos Alberto", pos: "RW", quality: 84 },
    { name: "Benni McCarthy", pos: "ST", quality: 88 }
  ],
  bench: [
    { name: "Nuno Espírito Santo", pos: "GK", quality: 77 },
    { name: "Pedro Emanuel", pos: "CB", quality: 81 },
    { name: "Edgaras Jankauskas", pos: "ST", quality: 82 },
    { name: "Derlei", pos: "ST", quality: 84 },
    { name: "José Bosingwa", pos: "RB", quality: 80 },
    { name: "Ricardo Costa", pos: "CB", quality: 81 },
    { name: "Pedro Mendes", pos: "CM", quality: 84 }
  ]
},

{
  name: "2003 Porto",
  season: 2003,
  strength: 90,
  startingXI: [
    { name: "Vítor Baía", pos: "GK", quality: 90 },
    { name: "Paulo Ferreira", pos: "RB", quality: 86 },
    { name: "Ricardo Carvalho", pos: "CB", quality: 92 },
    { name: "Jorge Costa", pos: "CB", quality: 88 },
    { name: "Nuno Valente", pos: "LB", quality: 86 },
    { name: "Costinha", pos: "DM", quality: 87 },
    { name: "Maniche", pos: "CM", quality: 89 },
    { name: "Deco", pos: "AM", quality: 95 },
    { name: "Dmitri Alenichev", pos: "LW", quality: 85 },
    { name: "Derlei", pos: "ST", quality: 85 },
    { name: "Benni McCarthy", pos: "ST", quality: 88 }
  ],
  bench: [
    { name: "Nuno", pos: "GK", quality: 76 },
    { name: "Ricardo Costa", pos: "CB", quality: 81 },
    { name: "Edgaras Jankauskas", pos: "ST", quality: 82 },
    { name: "Pedro Mendes", pos: "CM", quality: 84 },
    { name: "Peixoto", pos: "LB", quality: 78 },
    { name: "José Bosingwa", pos: "RB", quality: 80 },
    { name: "Clayton", pos: "RW", quality: 82 }
  ]
},

{
  name: "1995 Ajax",
  season: 1995,
  strength: 95,
  startingXI: [
    { name: "Edwin van der Sar", pos: "GK", quality: 92 },
    { name: "Michael Reiziger", pos: "RB", quality: 89 },
    { name: "Frank Rijkaard", pos: "CB", quality: 94 },
    { name: "Danny Blind", pos: "CB", quality: 92 },
    { name: "Frank de Boer", pos: "LB", quality: 92 },
    { name: "Edgar Davids", pos: "CM", quality: 92 },
    { name: "Clarence Seedorf", pos: "CM", quality: 91 },
    { name: "Jari Litmanen", pos: "AM", quality: 94 },
    { name: "Marc Overmars", pos: "LW", quality: 90 },
    { name: "Patrick Kluivert", pos: "ST", quality: 90 },
    { name: "Finidi George", pos: "RW", quality: 89 }
  ],
  bench: [
    { name: "Stanley Menzo", pos: "GK", quality: 77 },
    { name: "Nwankwo Kanu", pos: "ST", quality: 85 },
    { name: "Winston Bogarde", pos: "CB", quality: 82 },
    { name: "Ronald de Boer", pos: "RW", quality: 85 },
    { name: "Nordin Wooter", pos: "LW", quality: 78 },
    { name: "John van den Brom", pos: "CM", quality: 79 },
    { name: "Tarik Oulida", pos: "AM", quality: 80 }
  ]
},

{
  name: "1971 Ajax",
  season: 1971,
  strength: 94,
  startingXI: [
    { name: "Heinz Stuy", pos: "GK", quality: 88 },
    { name: "Wim Suurbier", pos: "RB", quality: 90 },
    { name: "Barry Hulshoff", pos: "CB", quality: 89 },
    { name: "Velibor Vasović", pos: "CB", quality: 92 },
    { name: "Ruud Krol", pos: "LB", quality: 92 },
    { name: "Johan Neeskens", pos: "CM", quality: 93 },
    { name: "Arie Haan", pos: "DM", quality: 90 },
    { name: "Piet Keizer", pos: "LW", quality: 92 },
    { name: "Sjaak Swart", pos: "RW", quality: 89 },
    { name: "Johan Cruyff", pos: "ST", quality: 99 },
    { name: "Dick van Dijk", pos: "ST", quality: 88 }
  ],
  bench: [
    { name: "Gerrie Mühren", pos: "CM", quality: 84 },
    { name: "Horst Blankenburg", pos: "CB", quality: 85 },
    { name: "Klaas Nuninga", pos: "FW", quality: 80 },
    { name: "Tommy Söderberg", pos: "DM", quality: 78 },
    { name: "Piet Ouderland", pos: "DF", quality: 78 },
    { name: "Jan Mulder", pos: "ST", quality: 82 },
    { name: "Henk Groot", pos: "ST", quality: 84 }
  ]
},

{
  name: "1973 Ajax",
  season: 1973,
  strength: 95,
  startingXI: [
    { name: "Heinz Stuy", pos: "GK", quality: 89 },
    { name: "Wim Suurbier", pos: "RB", quality: 90 },
    { name: "Barry Hulshoff", pos: "CB", quality: 89 },
    { name: "Horst Blankenburg", pos: "CB", quality: 87 },
    { name: "Ruud Krol", pos: "LB", quality: 92 },
    { name: "Johan Neeskens", pos: "CM", quality: 94 },
    { name: "Arie Haan", pos: "DM", quality: 90 },
    { name: "Piet Keizer", pos: "LW", quality: 92 },
    { name: "Gerrie Mühren", pos: "CM", quality: 84 },
    { name: "Johan Cruyff", pos: "ST", quality: 99 },
    { name: "Johnny Rep", pos: "RW", quality: 92 }
  ],
  bench: [
    { name: "Jan Jongbloed", pos: "GK", quality: 78 },
    { name: "Sjaak Swart", pos: "RW", quality: 83 },
    { name: "Dick van Dijk", pos: "ST", quality: 82 },
    { name: "Piet Ouderland", pos: "DF", quality: 78 },
    { name: "Jan Mulder", pos: "ST", quality: 82 },
    { name: "Arie de Vroet", pos: "DM", quality: 79 },
    { name: "Wim Anderiesen Jr.", pos: "CM", quality: 77 }
  ]
},

{
  name: "1994 Barcelona",
  season: 1994,
  strength: 91,
  startingXI: [
    { name: "Andoni Zubizarreta", pos: "GK", quality: 89 },
    { name: "Albert Ferrer", pos: "RB", quality: 87 },
    { name: "Ronald Koeman", pos: "CB", quality: 93 },
    { name: "Miguel Ángel Nadal", pos: "CB", quality: 88 },
    { name: "Sergi Barjuán", pos: "LB", quality: 86 },
    { name: "Pep Guardiola", pos: "DM", quality: 93 },
    { name: "Jose Mari Bakero", pos: "CM", quality: 87 },
    { name: "Michael Laudrup", pos: "AM", quality: 95 },
    { name: "Hristo Stoichkov", pos: "LW", quality: 95 },
    { name: "Romário", pos: "ST", quality: 97 },
    { name: "Eusebio", pos: "RW", quality: 85 }
  ],
  bench: [
    { name: "Carles Busquets", pos: "GK", quality: 78 },
    { name: "Ion Andoni Goikoetxea", pos: "RW", quality: 84 },
    { name: "Quique Estebaranz", pos: "LW", quality: 80 },
    { name: "Julio Salinas", pos: "ST", quality: 82 },
    { name: "Guillermo Amor", pos: "CM", quality: 84 },
    { name: "Ronald de Boer", pos: "CM", quality: 84 },
    { name: "Abelardo", pos: "CB", quality: 82 }
  ]
},

{
  name: "2002 Real Madrid",
  season: 2002,
  strength: 95,
  startingXI: [
    { name: "Iker Casillas", pos: "GK", quality: 94 },
    { name: "Míchel Salgado", pos: "RB", quality: 88 },
    { name: "Fernando Hierro", pos: "CB", quality: 90 },
    { name: "Iván Helguera", pos: "CB", quality: 89 },
    { name: "Roberto Carlos", pos: "LB", quality: 96 },
    { name: "Claude Makélélé", pos: "DM", quality: 94 },
    { name: "Zinedine Zidane", pos: "AM", quality: 97 },
    { name: "Luis Figo", pos: "RW", quality: 94 },
    { name: "Raúl", pos: "ST", quality: 95 },
    { name: "Fernando Morientes", pos: "ST", quality: 90 },
    { name: "Steve McManaman", pos: "LW", quality: 88 }
  ],
  bench: [
    { name: "César Sánchez", pos: "GK", quality: 80 },
    { name: "Santiago Solari", pos: "LW", quality: 84 },
    { name: "Guti", pos: "AM", quality: 88 },
    { name: "Flávio Conceição", pos: "DM", quality: 84 },
    { name: "Ronaldo Nazário", pos: "ST", quality: 96 },
    { name: "Rubén", pos: "CB", quality: 77 },
    { name: "Aitor Karanka", pos: "CB", quality: 80 }
  ]
},

{
  name: "2016 Real Madrid",
  season: 2016,
  strength: 95,
  startingXI: [
    { name: "Keylor Navas", pos: "GK", quality: 92 },
    { name: "Dani Carvajal", pos: "RB", quality: 90 },
    { name: "Sergio Ramos", pos: "CB", quality: 94 },
    { name: "Pepe", pos: "CB", quality: 92 },
    { name: "Marcelo", pos: "LB", quality: 94 },
    { name: "Casemiro", pos: "DM", quality: 93 },
    { name: "Luka Modrić", pos: "CM", quality: 95 },
    { name: "Toni Kroos", pos: "CM", quality: 94 },
    { name: "Gareth Bale", pos: "RW", quality: 95 },
    { name: "Karim Benzema", pos: "ST", quality: 93 },
    { name: "Cristiano Ronaldo", pos: "LW", quality: 99 }
  ],
  bench: [
    { name: "Kiko Casilla", pos: "GK", quality: 81 },
    { name: "Isco", pos: "AM", quality: 90 },
    { name: "James Rodríguez", pos: "AM", quality: 88 },
    { name: "Lucas Vázquez", pos: "RW", quality: 84 },
    { name: "Marco Asensio", pos: "LW", quality: 85 },
    { name: "Mateo Kovačić", pos: "CM", quality: 84 },
    { name: "Álvaro Morata", pos: "ST", quality: 86 }
  ]
},

{
  name: "1997 Barcelona",
  season: 1997,
  strength: 90,
  startingXI: [
    { name: "Vítor Baía", pos: "GK", quality: 88 },
    { name: "Albert Ferrer", pos: "RB", quality: 86 },
    { name: "Fernando Couto", pos: "CB", quality: 87 },
    { name: "Miguel Ángel Nadal", pos: "CB", quality: 87 },
    { name: "Sergi Barjuán", pos: "LB", quality: 86 },
    { name: "Pep Guardiola", pos: "DM", quality: 93 },
    { name: "Luis Enrique", pos: "CM", quality: 88 },
    { name: "Rivaldo", pos: "AM", quality: 95 },
    { name: "Luis Figo", pos: "RW", quality: 94 },
    { name: "Ronaldo", pos: "ST", quality: 97 },
    { name: "Hristo Stoichkov", pos: "LW", quality: 93 }
  ],
  bench: [
    { name: "Carles Busquets", pos: "GK", quality: 77 },
    { name: "Abelardo", pos: "CB", quality: 82 },
    { name: "Óscar García", pos: "AM", quality: 82 },
    { name: "Aitor", pos: "DM", quality: 80 },
    { name: "Juan Antonio Pizzi", pos: "ST", quality: 84 },
    { name: "Iván de la Peña", pos: "AM", quality: 88 },
    { name: "Dani García", pos: "ST", quality: 80 }
  ]
},

{
  name: "1995 Borussia Dortmund",
  season: 1995,
  strength: 88,
  startingXI: [
    { name: "Stefan Klos", pos: "GK", quality: 88 },
    { name: "Stefan Reuter", pos: "RB", quality: 87 },
    { name: "Jürgen Kohler", pos: "CB", quality: 89 },
    { name: "Martin Kree", pos: "CB", quality: 85 },
    { name: "Jörg Heinrich", pos: "LB", quality: 86 },
    { name: "Andreas Möller", pos: "AM", quality: 90 },
    { name: "Michael Zorc", pos: "CM", quality: 84 },
    { name: "Lars Ricken", pos: "SS", quality: 87 },
    { name: "Karl-Heinz Riedle", pos: "ST", quality: 88 },
    { name: "Heiko Herrlich", pos: "ST", quality: 87 },
    { name: "Knut Reinhardt", pos: "RM", quality: 80 }
  ],
  bench: [
    { name: "Wolfgang de Beer", pos: "GK", quality: 76 },
    { name: "Matthias Sammer", pos: "CB", quality: 90 },
    { name: "Ibrahim Tanko", pos: "RW", quality: 78 },
    { name: "Michael Schulz", pos: "CB", quality: 82 },
    { name: "Holger Stemmann", pos: "ST", quality: 77 },
    { name: "Mike Zabel", pos: "LB", quality: 76 },
    { name: "Teddy de Beer", pos: "GK", quality: 75 }
  ]
},

{
  name: "2019 Liverpool",
  season: 2019,
  strength: 96,
  startingXI: [
    { name: "Alisson", pos: "GK", quality: 95 },
    { name: "Trent Alexander-Arnold", pos: "RB", quality: 94 },
    { name: "Virgil van Dijk", pos: "CB", quality: 98 },
    { name: "Joël Matip", pos: "CB", quality: 88 },
    { name: "Andrew Robertson", pos: "LB", quality: 93 },
    { name: "Fabinho", pos: "DM", quality: 92 },
    { name: "Jordan Henderson", pos: "CM", quality: 88 },
    { name: "Georginio Wijnaldum", pos: "CM", quality: 89 },
    { name: "Mohamed Salah", pos: "RW", quality: 96 },
    { name: "Sadio Mané", pos: "LW", quality: 95 },
    { name: "Roberto Firmino", pos: "ST", quality: 92 }
  ],
  bench: [
    { name: "Adrián", pos: "GK", quality: 80 },
    { name: "James Milner", pos: "CM", quality: 84 },
    { name: "Alex Oxlade-Chamberlain", pos: "CM", quality: 83 },
    { name: "Divock Origi", pos: "ST", quality: 82 },
    { name: "Xherdan Shaqiri", pos: "RW", quality: 84 },
    { name: "Joe Gomez", pos: "CB", quality: 85 },
    { name: "Naby Keïta", pos: "CM", quality: 84 }
  ]
},

{
  name: "2001 Roma",
  season: 2001,
  strength: 90,
  startingXI: [
    { name: "Francesco Antonioli", pos: "GK", quality: 86 },
    { name: "Cafu", pos: "RB", quality: 92 },
    { name: "Walter Samuel", pos: "CB", quality: 93 },
    { name: "Aldair", pos: "CB", quality: 90 },
    { name: "Vincent Candela", pos: "LB", quality: 87 },
    { name: "Damiano Tommasi", pos: "CM", quality: 86 },
    { name: "Emerson", pos: "DM", quality: 90 },
    { name: "Francesco Totti", pos: "AM", quality: 96 },
    { name: "Marco Delvecchio", pos: "ST", quality: 84 },
    { name: "Gabriel Batistuta", pos: "ST", quality: 95 },
    { name: "Antonio Cassano", pos: "SS", quality: 86 }
  ],
  bench: [
    { name: "Ivan Pelizzoli", pos: "GK", quality: 77 },
    { name: "Cristiano Zanetti", pos: "CM", quality: 82 },
    { name: "Hidetoshi Nakata", pos: "AM", quality: 88 },
    { name: "Abel Balbo", pos: "ST", quality: 80 },
    { name: "Jonathan Zebina", pos: "RB", quality: 82 },
    { name: "Guillermo Giacomazzi", pos: "CM", quality: 80 },
    { name: "Candela (Bench)", pos: "LB", quality: 87 }
  ]
},

{
  name: "1990 Marseille",
  season: 1990,
  strength: 90,
  startingXI: [
    { name: "Jean Castaneda", pos: "GK", quality: 85 },
    { name: "Manuel Amoros", pos: "RB", quality: 89 },
    { name: "Carlos Mozer", pos: "CB", quality: 90 },
    { name: "Basile Boli", pos: "CB", quality: 89 },
    { name: "Éric Di Meco", pos: "LB", quality: 85 },
    { name: "Jean Tigana", pos: "CM", quality: 89 },
    { name: "Didier Deschamps", pos: "DM", quality: 89 },
    { name: "Abedi Pelé", pos: "AM", quality: 90 },
    { name: "Franck Sauzée", pos: "CM", quality: 88 },
    { name: "Jean-Pierre Papin", pos: "ST", quality: 94 },
    { name: "Chris Waddle", pos: "LW", quality: 90 }
  ],
  bench: [
    { name: "Pascal Olmeta", pos: "GK", quality: 78 },
    { name: "Éric Cantona", pos: "ST", quality: 88 },
    { name: "Klaus Allofs", pos: "ST", quality: 82 },
    { name: "André Ayew", pos: "LW", quality: 82 },
    { name: "Yuri Djorkaeff", pos: "AM", quality: 86 },
    { name: "Karl-Heinz Förster", pos: "CB", quality: 82 },
    { name: "Bernard Casoni", pos: "CB", quality: 81 }
  ]
}, 
      {
        name: "1970 Feyenoord",
        season: 1970,
        strength: 89,
        startingXI: [
          { name: "Eddy Treijtel", pos: "GK", quality: 87 },
          { name: "Wim Jansen", pos: "RB", quality: 88 },
          { name: "Rinus Israël", pos: "CB", quality: 90 },
          { name: "Theo Laseroms", pos: "CB", quality: 88 },
          { name: "Henk Wery", pos: "LB", quality: 84 },
          { name: "Franz Hasil", pos: "CM", quality: 89 },
          { name: "Willem van Hanegem", pos: "CM", quality: 92 },
          { name: "Coen Moulijn", pos: "LW", quality: 90 },
          { name: "Henk Groot", pos: "AM", quality: 87 },
          { name: "Ove Kindvall", pos: "ST", quality: 90 },
          { name: "Rinus Bennaars", pos: "DM", quality: 84 }
        ],
        bench: [
          { name: "Piet Romeijn", pos: "DF", quality: 80 },
          { name: "Dick Schneider", pos: "DF", quality: 80 },
          { name: "Henk Schouten", pos: "CM", quality: 81 },
          { name: "Hans Venneker", pos: "FW", quality: 80 },
          { name: "Guus Haak", pos: "DF", quality: 79 },
          { name: "Ab Fafié", pos: "GK", quality: 76 },
          { name: "Lex Schoenmaker", pos: "ST", quality: 80 }
        ]
      },

      {
        name: "1982 Aston Villa",
        season: 1982,
        strength: 88,
        startingXI: [
          { name: "Jimmy Rimmer", pos: "GK", quality: 87 },
          { name: "Kenny Swain", pos: "RB", quality: 84 },
          { name: "Ken McNaught", pos: "CB", quality: 86 },
          { name: "Allan Evans", pos: "CB", quality: 88 },
          { name: "Gary Williams", pos: "LB", quality: 84 },
          { name: "Dennis Mortimer", pos: "CM", quality: 88 },
          { name: "Gordon Cowans", pos: "CM", quality: 89 },
          { name: "Tony Morley", pos: "LW", quality: 87 },
          { name: "Gary Shaw", pos: "ST", quality: 87 },
          { name: "Peter Withe", pos: "ST", quality: 88 },
          { name: "Des Bremner", pos: "RM", quality: 84 }
        ],
        bench: [
          { name: "Nigel Spink", pos: "GK", quality: 84 },
          { name: "Colin Gibson", pos: "DF", quality: 80 },
          { name: "Eamon Deacy", pos: "DF", quality: 79 },
          { name: "David Geddis", pos: "ST", quality: 80 },
          { name: "Garry Thompson", pos: "ST", quality: 80 },
          { name: "Brendan Ormsby", pos: "CB", quality: 79 },
          { name: "Pat Heard", pos: "MF", quality: 79 }
        ]
      },
      {
        name: "2012 Chelsea",
        season: 2012,
        strength: 91,
        startingXI: [
          { name: "Petr Čech", pos: "GK", quality: 94 },
          { name: "Branislav Ivanović", pos: "RB", quality: 88 },
          { name: "Gary Cahill", pos: "CB", quality: 86 },
          { name: "David Luiz", pos: "CB", quality: 87 },
          { name: "Ashley Cole", pos: "LB", quality: 93 },
          { name: "John Obi Mikel", pos: "DM", quality: 86 },
          { name: "Frank Lampard", pos: "CM", quality: 94 },
          { name: "Ramires", pos: "CM", quality: 87 },
          { name: "Juan Mata", pos: "AM", quality: 92 },
          { name: "Didier Drogba", pos: "ST", quality: 95 },
          { name: "Salomon Kalou", pos: "RW", quality: 84 }
        ],
        bench: [
          { name: "Ross Turnbull", pos: "GK", quality: 76 },
          { name: "Florent Malouda", pos: "LW", quality: 84 },
          { name: "Fernando Torres", pos: "ST", quality: 86 },
          { name: "Daniel Sturridge", pos: "ST", quality: 85 },
          { name: "Raúl Meireles", pos: "CM", quality: 84 },
          { name: "José Bosingwa", pos: "RB", quality: 82 },
          { name: "Ryan Bertrand", pos: "LB", quality: 80 }
        ]
      },
      {
        name: "2010 Inter Milan",
        season: 2010,
        strength: 93,
        startingXI: [
          { name: "Júlio César", pos: "GK", quality: 93 },
          { name: "Maicon", pos: "RB", quality: 94 },
          { name: "Lúcio", pos: "CB", quality: 93 },
          { name: "Walter Samuel", pos: "CB", quality: 92 },
          { name: "Cristian Chivu", pos: "LB", quality: 87 },
          { name: "Esteban Cambiasso", pos: "DM", quality: 93 },
          { name: "Wesley Sneijder", pos: "AM", quality: 96 },
          { name: "Thiago Motta", pos: "CM", quality: 88 },
          { name: "Goran Pandev", pos: "LW", quality: 86 },
          { name: "Samuel Eto'o", pos: "ST", quality: 94 },
          { name: "Diego Milito", pos: "ST", quality: 95 }
        ],
        bench: [
          { name: "Francesco Toldo", pos: "GK", quality: 82 },
          { name: "Dejan Stanković", pos: "CM", quality: 88 },
          { name: "Sulley Muntari", pos: "CM", quality: 84 },
          { name: "Mario Balotelli", pos: "ST", quality: 86 },
          { name: "Marco Materazzi", pos: "CB", quality: 84 },
          { name: "Davide Santon", pos: "LB", quality: 80 },
          { name: "McDonald Mariga", pos: "DM", quality: 80 }
        ]
      },

      {
        name: "1977 Liverpool",
        season: 1977,
        strength: 92,
        startingXI: [
          { name: "Ray Clemence", pos: "GK", quality: 92 },
          { name: "Phil Neal", pos: "RB", quality: 90 },
          { name: "Tommy Smith", pos: "CB", quality: 89 },
          { name: "Emlyn Hughes", pos: "CB", quality: 92 },
          { name: "Joey Jones", pos: "LB", quality: 85 },
          { name: "Graeme Souness", pos: "CM", quality: 92 },
          { name: "Ray Kennedy", pos: "CM", quality: 89 },
          { name: "Terry McDermott", pos: "AM", quality: 88 },
          { name: "Steve Heighway", pos: "LW", quality: 88 },
          { name: "Kevin Keegan", pos: "ST", quality: 94 },
          { name: "John Toshack", pos: "ST", quality: 88 }
        ],
        bench: [
          { name: "David Fairclough", pos: "ST", quality: 84 },
          { name: "Jimmy Case", pos: "RM", quality: 84 },
          { name: "Phil Thompson", pos: "CB", quality: 86 },
          { name: "Ian Callaghan", pos: "RM", quality: 83 },
          { name: "Alan Hansen", pos: "CB", quality: 86 },
          { name: "Brian Kettle", pos: "LB", quality: 78 },
          { name: "Steve Ogrizovic", pos: "GK", quality: 78 }
        ]
      },

      {
        name: "1984 Liverpool",
        season: 1984,
        strength: 93,
        startingXI: [
          { name: "Bruce Grobbelaar", pos: "GK", quality: 90 },
          { name: "Phil Neal", pos: "RB", quality: 90 },
          { name: "Alan Hansen", pos: "CB", quality: 93 },
          { name: "Mark Lawrenson", pos: "CB", quality: 92 },
          { name: "Alan Kennedy", pos: "LB", quality: 87 },
          { name: "Graeme Souness", pos: "CM", quality: 94 },
          { name: "Sammy Lee", pos: "CM", quality: 87 },
          { name: "Craig Johnston", pos: "RM", quality: 85 },
          { name: "Ronnie Whelan", pos: "LM", quality: 88 },
          { name: "Ian Rush", pos: "ST", quality: 95 },
          { name: "Kenny Dalglish", pos: "SS", quality: 96 }
        ],
        bench: [
          { name: "Steve Nicol", pos: "DF", quality: 86 },
          { name: "Michael Robinson", pos: "ST", quality: 82 },
          { name: "Kevin Sheedy", pos: "LM", quality: 82 },
          { name: "Jan Mølby", pos: "CM", quality: 86 },
          { name: "Jim Beglin", pos: "LB", quality: 80 },
          { name: "Gary Gillespie", pos: "CB", quality: 82 },
          { name: "Phil Thompson", pos: "CB", quality: 84 }
        ]
      },

      {
        name: "1960 Real Madrid",
        season: 1960,
        strength: 96,
        startingXI: [
          { name: "Vicente", pos: "GK", quality: 88 },
          { name: "Marquitos", pos: "RB", quality: 88 },
          { name: "Jose Santamaría", pos: "CB", quality: 93 },
          { name: "Paco Gento", pos: "LW", quality: 96 },
          { name: "José María Zárraga", pos: "CM", quality: 88 },
          { name: "Miguel Muñoz", pos: "CM", quality: 89 },
          { name: "Hector Rial", pos: "AM", quality: 90 },
          { name: "Luis del Sol", pos: "RM", quality: 90 },
          { name: "Ferenc Puskás", pos: "ST", quality: 98 },
          { name: "Alfredo Di Stéfano", pos: "ST", quality: 99 },
          { name: "Canario", pos: "RW", quality: 88 }
        ],
        bench: [
          { name: "Juanito Alonso", pos: "GK", quality: 82 },
          { name: "Enrique Pachín", pos: "DF", quality: 82 },
          { name: "Felipe Mateos", pos: "DF", quality: 80 },
          { name: "Isidro", pos: "FW", quality: 80 },
          { name: "Pepillo", pos: "FW", quality: 81 },
          { name: "Casado", pos: "DF", quality: 79 },
          { name: "Mateos", pos: "MF", quality: 80 }
        ]
      },

      {
        name: "2015 Barcelona",
        season: 2015,
        strength: 97,
        startingXI: [
          { name: "Marc-André ter Stegen", pos: "GK", quality: 92 },
          { name: "Dani Alves", pos: "RB", quality: 93 },
          { name: "Gerard Piqué", pos: "CB", quality: 94 },
          { name: "Javier Mascherano", pos: "CB", quality: 90 },
          { name: "Jordi Alba", pos: "LB", quality: 92 },
          { name: "Sergio Busquets", pos: "DM", quality: 95 },
          { name: "Ivan Rakitić", pos: "CM", quality: 91 },
          { name: "Andrés Iniesta", pos: "CM", quality: 96 },
          { name: "Lionel Messi", pos: "RW", quality: 99 },
          { name: "Luis Suárez", pos: "ST", quality: 97 },
          { name: "Neymar", pos: "LW", quality: 97 }
        ],
        bench: [
          { name: "Claudio Bravo", pos: "GK", quality: 90 },
          { name: "Jérémy Mathieu", pos: "CB", quality: 83 },
          { name: "Rafinha", pos: "CM", quality: 82 },
          { name: "Pedro", pos: "FW", quality: 85 },
          { name: "Sergi Roberto", pos: "CM", quality: 84 },
          { name: "Munir El Haddadi", pos: "ST", quality: 78 },
          { name: "Adriano", pos: "LB", quality: 82 }
        ]
      },

      {
        name: "2017 Real Madrid",
        season: 2017,
        strength: 97,
        startingXI: [
          { name: "Keylor Navas", pos: "GK", quality: 92 },
          { name: "Dani Carvajal", pos: "RB", quality: 91 },
          { name: "Sergio Ramos", pos: "CB", quality: 95 },
          { name: "Raphaël Varane", pos: "CB", quality: 93 },
          { name: "Marcelo", pos: "LB", quality: 94 },
          { name: "Casemiro", pos: "DM", quality: 94 },
          { name: "Toni Kroos", pos: "CM", quality: 95 },
          { name: "Luka Modrić", pos: "CM", quality: 96 },
          { name: "Isco", pos: "AM", quality: 92 },
          { name: "Karim Benzema", pos: "ST", quality: 94 },
          { name: "Cristiano Ronaldo", pos: "LW", quality: 99 }
        ],
        bench: [
          { name: "Kiko Casilla", pos: "GK", quality: 81 },
          { name: "Marco Asensio", pos: "LW", quality: 88 },
          { name: "Lucas Vázquez", pos: "RW", quality: 85 },
          { name: "Álvaro Morata", pos: "ST", quality: 87 },
          { name: "James Rodríguez", pos: "AM", quality: 89 },
          { name: "Mateo Kovačić", pos: "CM", quality: 84 },
          { name: "Nacho Fernández", pos: "DF", quality: 84 }
        ]
      },

      {
        name: "2000 Galatasaray",
        season: 2000,
        strength: 89,
        startingXI: [
          { name: "Cláudio Taffarel", pos: "GK", quality: 90 },
          { name: "Ümit Davala", pos: "RB", quality: 86 },
          { name: "Gheorghe Popescu", pos: "CB", quality: 89 },
          { name: "Bülent Korkmaz", pos: "CB", quality: 88 },
          { name: "Hakan Ünsal", pos: "LB", quality: 86 },
          { name: "Okan Buruk", pos: "RM", quality: 86 },
          { name: "Suat Kaya", pos: "CM", quality: 86 },
          { name: "Emre Belözoğlu", pos: "CM", quality: 87 },
          { name: "Hagi", pos: "AM", quality: 95 },
          { name: "Arif Erdem", pos: "ST", quality: 86 },
          { name: "Hakan Şükür", pos: "ST", quality: 92 }
        ],
        bench: [
          { name: "Mondragón", pos: "GK", quality: 84 },
          { name: "Fatih Akyel", pos: "DF", quality: 82 },
          { name: "Hasan Şaş", pos: "RM", quality: 86 },
          { name: "Ümit Karan", pos: "ST", quality: 84 },
          { name: "Ergün Penbe", pos: "LM", quality: 84 },
          { name: "Bülent Akın", pos: "CM", quality: 80 },
          { name: "Sabrı Sarıoğlu", pos: "RB", quality: 78 }
        ]
      },

      {
        name: "1993 Marseille",
        season: 1993,
        strength: 91,
        startingXI: [
          { name: "Fabien Barthez", pos: "GK", quality: 92 },
          { name: "Jocelyn Angloma", pos: "RB", quality: 90 },
          { name: "Marcel Desailly", pos: "CB", quality: 93 },
          { name: "Basel Boli", pos: "CB", quality: 90 },
          { name: "Éric Di Meco", pos: "LB", quality: 87 },
          { name: "Didier Deschamps", pos: "DM", quality: 92 },
          { name: "Franck Sauzée", pos: "CM", quality: 89 },
          { name: "Abedi Pelé", pos: "AM", quality: 92 },
          { name: "Rudi Völler", pos: "ST", quality: 90 },
          { name: "Alen Bokšić", pos: "ST", quality: 91 },
          { name: "Franck Leboeuf", pos: "CB", quality: 87 }
        ],
        bench: [
          { name: "Bruno Martini", pos: "GK", quality: 82 },
          { name: "Jean-Jacques Eydelie", pos: "RM", quality: 82 },
          { name: "Jean-Philippe Durand", pos: "CM", quality: 83 },
          { name: "Jean-Christophe Thomas", pos: "DM", quality: 81 },
          { name: "François Omam-Biyik", pos: "ST", quality: 84 },
          { name: "Éric Cantona (early)", pos: "ST", quality: 88 },
          { name: "Jean-Luc Dogon", pos: "DF", quality: 80 }
        ]
      }, 
      {
        name: "1974 Bayern Munich",
        season: 1974,
        strength: 93,
        startingXI: [
          { name: "Sepp Maier", pos: "GK", quality: 94 },
          { name: "Hans-Georg Schwarzenbeck", pos: "CB", quality: 90 },
          { name: "Franz Beckenbauer", pos: "CB", quality: 98 },
          { name: "Paul Breitner", pos: "LB", quality: 93 },
          { name: "Johnny Hansen", pos: "RB", quality: 86 },
          { name: "Uli Hoeneß", pos: "CM", quality: 90 },
          { name: "Rainer Zobel", pos: "DM", quality: 85 },
          { name: "Bernd Dürnberger", pos: "CM", quality: 84 },
          { name: "Jupp Kapellmann", pos: "AM", quality: 86 },
          { name: "Gerd Müller", pos: "ST", quality: 98 },
          { name: "Jupp Heynckes", pos: "ST", quality: 90 }
        ],
        bench: [
          { name: "Walter Junghans", pos: "GK", quality: 78 },
          { name: "Katsche Schwarzenbeck Backup", pos: "CB", quality: 82 },
          { name: "Georg Schwarzenberger", pos: "DF", quality: 79 },
          { name: "Conny Torstensson", pos: "FW", quality: 84 },
          { name: "Karl-Heinz Rummenigge (young)", pos: "FW", quality: 84 },
          { name: "Rudolf Noske", pos: "MF", quality: 78 },
          { name: "Josef Weiss", pos: "MF", quality: 77 }
        ]
      },

      {
        name: "1976 Bayern Munich",
        season: 1976,
        strength: 94,
        startingXI: [
          { name: "Sepp Maier", pos: "GK", quality: 95 },
          { name: "Björn Andersson", pos: "RB", quality: 85 },
          { name: "Franz Beckenbauer", pos: "CB", quality: 98 },
          { name: "Hans-Georg Schwarzenbeck", pos: "CB", quality: 90 },
          { name: "Paul Breitner", pos: "LB", quality: 93 },
          { name: "Franz Roth", pos: "CM", quality: 88 },
          { name: "Bernd Dürnberger", pos: "DM", quality: 86 },
          { name: "Uli Hoeneß", pos: "CM", quality: 90 },
          { name: "Karl-Heinz Rummenigge", pos: "LW", quality: 92 },
          { name: "Gerd Müller", pos: "ST", quality: 98 },
          { name: "Jupp Kapellmann", pos: "RW", quality: 86 }
        ],
        bench: [
          { name: "Walter Junghans", pos: "GK", quality: 79 },
          { name: "Dieter Koulmann", pos: "MF", quality: 80 },
          { name: "Josef Weiß", pos: "MF", quality: 79 },
          { name: "Rainer Zobel", pos: "DM", quality: 83 },
          { name: "Conny Torstensson", pos: "FW", quality: 84 },
          { name: "Charly Lutz", pos: "DF", quality: 78 },
          { name: "Wolfgang Sühnholz", pos: "FW", quality: 78 }
        ]
      },

      {
        name: "2001 Bayern Munich",
        season: 2001,
        strength: 94,
        startingXI: [
          { name: "Oliver Kahn", pos: "GK", quality: 97 },
          { name: "Willy Sagnol", pos: "RB", quality: 90 },
          { name: "Thomas Linke", pos: "CB", quality: 88 },
          { name: "Samuel Kuffour", pos: "CB", quality: 90 },
          { name: "Bixente Lizarazu", pos: "LB", quality: 92 },
          { name: "Stefan Effenberg", pos: "CM", quality: 94 },
          { name: "Owen Hargreaves", pos: "CM", quality: 87 },
          { name: "Jens Jeremies", pos: "DM", quality: 86 },
          { name: "Mehmet Scholl", pos: "AM", quality: 92 },
          { name: "Giovane Élber", pos: "ST", quality: 91 },
          { name: "Carsten Jancker", pos: "ST", quality: 86 }
        ],
        bench: [
          { name: "Bernd Dreher", pos: "GK", quality: 77 },
          { name: "Alexander Zickler", pos: "ST", quality: 84 },
          { name: "Paulo Sérgio", pos: "FW", quality: 85 },
          { name: "Ciriaco Sforza", pos: "CM", quality: 84 },
          { name: "Hasan Salihamidžić", pos: "RM", quality: 86 },
          { name: "Patrik Andersson", pos: "CB", quality: 86 },
          { name: "Thorsten Fink", pos: "DM", quality: 82 }
        ]
      },

      {
        name: "2018 Manchester City",
        season: 2018,
        strength: 96,
        startingXI: [
          { name: "Ederson", pos: "GK", quality: 93 },
          { name: "Kyle Walker", pos: "RB", quality: 92 },
          { name: "Vincent Kompany", pos: "CB", quality: 93 },
          { name: "Nicolás Otamendi", pos: "CB", quality: 88 },
          { name: "Fabian Delph", pos: "LB", quality: 84 },
          { name: "Fernandinho", pos: "DM", quality: 94 },
          { name: "Kevin De Bruyne", pos: "CM", quality: 98 },
          { name: "David Silva", pos: "CM", quality: 96 },
          { name: "Raheem Sterling", pos: "RW", quality: 94 },
          { name: "Sergio Agüero", pos: "ST", quality: 96 },
          { name: "Leroy Sané", pos: "LW", quality: 93 }
        ],
        bench: [
          { name: "Claudio Bravo", pos: "GK", quality: 82 },
          { name: "Aymeric Laporte", pos: "CB", quality: 90 },
          { name: "John Stones", pos: "CB", quality: 86 },
          { name: "Ilkay Gündoğan", pos: "CM", quality: 90 },
          { name: "Bernardo Silva", pos: "AM", quality: 92 },
          { name: "Gabriel Jesus", pos: "ST", quality: 89 },
          { name: "Riyad Mahrez", pos: "RW", quality: 90 }
        ]
      },

      {
        name: "2023 Manchester City",
        season: 2023,
        strength: 97,
        startingXI: [
          { name: "Ederson", pos: "GK", quality: 94 },
          { name: "Kyle Walker", pos: "RB", quality: 92 },
          { name: "Rúben Dias", pos: "CB", quality: 95 },
          { name: "John Stones", pos: "CB", quality: 92 },
          { name: "Nathan Aké", pos: "LB", quality: 88 },
          { name: "Rodri", pos: "DM", quality: 97 },
          { name: "Kevin De Bruyne", pos: "CM", quality: 98 },
          { name: "İlkay Gündoğan", pos: "CM", quality: 93 },
          { name: "Bernardo Silva", pos: "RW", quality: 93 },
          { name: "Erling Haaland", pos: "ST", quality: 99 },
          { name: "Jack Grealish", pos: "LW", quality: 91 }
        ],
        bench: [
          { name: "Stefan Ortega", pos: "GK", quality: 82 },
          { name: "Aymeric Laporte", pos: "CB", quality: 89 },
          { name: "Riyad Mahrez", pos: "RW", quality: 90 },
          { name: "Phil Foden", pos: "AM", quality: 92 },
          { name: "Julián Álvarez", pos: "ST", quality: 90 },
          { name: "Manuel Akanji", pos: "CB", quality: 88 },
          { name: "Kalvin Phillips", pos: "DM", quality: 83 }
        ]
      },

      {
        name: "1993 São Paulo",
        season: 1993,
        strength: 92,
        startingXI: [
          { name: "Zetti", pos: "GK", quality: 90 },
          { name: "Cafu", pos: "RB", quality: 92 },
          { name: "Ronaldão", pos: "CB", quality: 87 },
          { name: "Válber", pos: "CB", quality: 88 },
          { name: "André Luiz", pos: "LB", quality: 86 },
          { name: "Dinho", pos: "DM", quality: 86 },
          { name: "Toninho Cerezo", pos: "CM", quality: 90 },
          { name: "Raí", pos: "AM", quality: 94 },
          { name: "Pintado", pos: "CM", quality: 84 },
          { name: "Palhinha", pos: "ST", quality: 88 },
          { name: "Müller", pos: "ST", quality: 90 }
        ],
        bench: [
          { name: "Gilmar Rinaldi", pos: "GK", quality: 80 },
          { name: "Vítor", pos: "RB", quality: 82 },
          { name: "Adílson", pos: "CB", quality: 80 },
          { name: "Elivelton", pos: "LW", quality: 86 },
          { name: "Juninho Paulista", pos: "AM", quality: 88 },
          { name: "Valdir Bigode", pos: "ST", quality: 84 },
          { name: "Bernardinho", pos: "CM", quality: 80 }
        ]
      },
      {
        name: "1970 Feyenoord",
        season: 1970,
        strength: 90,
        startingXI: [
          { name: "Eddy Pieters Graafland", pos: "GK", quality: 88 },
          { name: "Wim Jansen", pos: "RB", quality: 88 },
          { name: "Rinus Israël", pos: "CB", quality: 92 },
          { name: "Theo Laseroms", pos: "CB", quality: 88 },
          { name: "Henk Wery", pos: "LB", quality: 84 },
          { name: "Frans Hasil", pos: "CM", quality: 88 },
          { name: "Willem van Hanegem", pos: "CM", quality: 94 },
          { name: "Coen Moulijn", pos: "LW", quality: 92 },
          { name: "Johan Boskamp", pos: "DM", quality: 84 },
          { name: "Ove Kindvall", pos: "ST", quality: 92 },
          { name: "Rinus Israël (sweeper)", pos: "SW", quality: 90 }
        ],
        bench: [
          { name: "Piet Romeijn", pos: "DF", quality: 80 },
          { name: "Henk Groot", pos: "FW", quality: 84 },
          { name: "Rinus Bennaars", pos: "MF", quality: 80 },
          { name: "Cor Veldhoen", pos: "DF", quality: 79 },
          { name: "Theo van Duivenbode", pos: "LB", quality: 80 },
          { name: "Joop van Daele", pos: "DF", quality: 80 },
          { name: "Rinus Gosens", pos: "GK", quality: 76 }
        ]
      },

      {
        name: "1982 Aston Villa",
        season: 1982,
        strength: 88,
        startingXI: [
          { name: "Jimmy Rimmer", pos: "GK", quality: 88 },
          { name: "Kenny Swain", pos: "RB", quality: 84 },
          { name: "Ken McNaught", pos: "CB", quality: 86 },
          { name: "Allan Evans", pos: "CB", quality: 87 },
          { name: "Gary Williams", pos: "LB", quality: 84 },
          { name: "Dennis Mortimer", pos: "CM", quality: 89 },
          { name: "Gordon Cowans", pos: "CM", quality: 88 },
          { name: "Des Bremner", pos: "RM", quality: 84 },
          { name: "Tony Morley", pos: "LM", quality: 86 },
          { name: "Peter Withe", pos: "ST", quality: 89 },
          { name: "Gary Shaw", pos: "ST", quality: 87 }
        ],
        bench: [
          { name: "Nigel Spink", pos: "GK", quality: 86 },
          { name: "Colin Gibson", pos: "LB", quality: 80 },
          { name: "Eamon Deacy", pos: "MF", quality: 78 },
          { name: "David Geddis", pos: "ST", quality: 80 },
          { name: "Pat Heard", pos: "MF", quality: 79 },
          { name: "Colin Gibson", pos: "LM", quality: 80 },
          { name: "Ken McNaught Backup", pos: "CB", quality: 80 }
        ]
      },
      {
  name: "1999 Palmeiras",
  season: 1999,
  strength: 87,
  startingXI: [
    { name: "Marcos", pos: "GK", quality: 90 },
    { name: "Arce", pos: "RB", quality: 85 },
    { name: "Roque Júnior", pos: "CB", quality: 88 },
    { name: "Júnior Baiano", pos: "CB", quality: 86 },
    { name: "Júnior", pos: "LB", quality: 84 },
    { name: "César Sampaio", pos: "DM", quality: 87 },
    { name: "Zinho", pos: "CM", quality: 86 },
    { name: "Rogério Ceni", pos: "CM", quality: 85 },
    { name: "Alex", pos: "AM", quality: 88 },
    { name: "Paulo Nunes", pos: "ST", quality: 87 },
    { name: "Oséas", pos: "ST", quality: 86 }
  ],
  bench: [
    { name: "Velloso", pos: "GK", quality: 78 },
    { name: "Gustavo", pos: "CB", quality: 80 },
    { name: "Evair", pos: "ST", quality: 84 },
    { name: "Djalminha", pos: "AM", quality: 87 },
    { name: "Cléber", pos: "CM", quality: 82 },
    { name: "Euller", pos: "LW", quality: 83 },
    { name: "Fabio Costa", pos: "GK", quality: 76 }
  ]
},

{
  name: "2005 Liverpool",
  season: 2005,
  strength: 91,
  startingXI: [
    { name: "Jerzy Dudek", pos: "GK", quality: 86 },
    { name: "Steve Finnan", pos: "RB", quality: 85 },
    { name: "Jamie Carragher", pos: "CB", quality: 90 },
    { name: "Sami Hyypiä", pos: "CB", quality: 88 },
    { name: "Djimi Traoré", pos: "LB", quality: 82 },
    { name: "Xabi Alonso", pos: "CM", quality: 89 },
    { name: "Steven Gerrard", pos: "CM", quality: 94 },
    { name: "Luis García", pos: "AM", quality: 86 },
    { name: "John Arne Riise", pos: "LW", quality: 87 },
    { name: "Milan Baroš", pos: "ST", quality: 85 },
    { name: "Harry Kewell", pos: "RW", quality: 86 }
  ],
  bench: [
    { name: "Scott Carson", pos: "GK", quality: 78 },
    { name: "Djibril Cissé", pos: "ST", quality: 84 },
    { name: "Vladimír Šmicer", pos: "AM", quality: 83 },
    { name: "Igor Bišćan", pos: "CM", quality: 80 },
    { name: "Antonio Núñez", pos: "RW", quality: 79 },
    { name: "Josemi", pos: "RB", quality: 80 },
    { name: "Florent Sinama-Pongolle", pos: "ST", quality: 81 }
  ]
},

{
  name: "1985 Everton",
  season: 1985,
  strength: 88,
  startingXI: [
    { name: "Neville Southall", pos: "GK", quality: 92 },
    { name: "Gary Stevens", pos: "RB", quality: 86 },
    { name: "Kevin Ratcliffe", pos: "CB", quality: 88 },
    { name: "Derek Mountfield", pos: "CB", quality: 85 },
    { name: "Pat Van Den Hauwe", pos: "LB", quality: 84 },
    { name: "Peter Reid", pos: "CM", quality: 89 },
    { name: "Paul Bracewell", pos: "CM", quality: 86 },
    { name: "Trevor Steven", pos: "RM", quality: 87 },
    { name: "Kevin Sheedy", pos: "LM", quality: 88 },
    { name: "Graeme Sharp", pos: "ST", quality: 87 },
    { name: "Andy Gray", pos: "ST", quality: 86 }
  ],
  bench: [
    { name: "Bobby Mimms", pos: "GK", quality: 78 },
    { name: "Gary Lineker", pos: "ST", quality: 90 },
    { name: "Adrian Heath", pos: "ST", quality: 84 },
    { name: "Alan Harper", pos: "CB", quality: 80 },
    { name: "Kevin Richardson", pos: "CM", quality: 82 },
    { name: "Ian Atkins", pos: "CM", quality: 79 },
    { name: "Paul Wilkinson", pos: "ST", quality: 78 }
  ]
},

{
  name: "1998 Real Madrid",
  season: 1998,
  strength: 93,
  startingXI: [
    { name: "Bodo Illgner", pos: "GK", quality: 88 },
    { name: "Christian Panucci", pos: "RB", quality: 86 },
    { name: "Manuel Sanchís", pos: "CB", quality: 89 },
    { name: "Fernando Hierro", pos: "CB", quality: 91 },
    { name: "Roberto Carlos", pos: "LB", quality: 94 },
    { name: "Clarence Seedorf", pos: "CM", quality: 90 },
    { name: "Fernando Redondo", pos: "DM", quality: 92 },
    { name: "Christian Karembeu", pos: "RM", quality: 85 },
    { name: "Raúl", pos: "ST", quality: 92 },
    { name: "Davor Šuker", pos: "ST", quality: 90 },
    { name: "Predrag Mijatović", pos: "ST", quality: 89 }
  ],
  bench: [
    { name: "Santiago Cañizares", pos: "GK", quality: 85 },
    { name: "Aitor Karanka", pos: "CB", quality: 82 },
    { name: "José Emilio Amavisca", pos: "LW", quality: 84 },
    { name: "Fernando Morientes", pos: "ST", quality: 87 },
    { name: "Sávio", pos: "LW", quality: 85 },
    { name: "Jaime", pos: "CM", quality: 80 },
    { name: "Guti", pos: "AM", quality: 86 }
  ]
},

{
  name: "1972 Ajax",
  season: 1972,
  strength: 94,
  startingXI: [
    { name: "Heinz Stuy", pos: "GK", quality: 88 },
    { name: "Wim Suurbier", pos: "RB", quality: 89 },
    { name: "Barry Hulshoff", pos: "CB", quality: 88 },
    { name: "Horst Blankenburg", pos: "CB", quality: 87 },
    { name: "Ruud Krol", pos: "LB", quality: 91 },
    { name: "Johan Neeskens", pos: "CM", quality: 92 },
    { name: "Arie Haan", pos: "DM", quality: 89 },
    { name: "Gerrie Mühren", pos: "CM", quality: 87 },
    { name: "Piet Keizer", pos: "LW", quality: 91 },
    { name: "Johan Cruyff", pos: "ST", quality: 98 },
    { name: "Johnny Rep", pos: "RW", quality: 88 }
  ],
  bench: [
    { name: "Jan Jongbloed", pos: "GK", quality: 82 },
    { name: "Sjaak Swart", pos: "RW", quality: 85 },
    { name: "Dick van Dijk", pos: "ST", quality: 83 },
    { name: "Arnold Mühren", pos: "CM", quality: 84 },
    { name: "Piet Schrijvers", pos: "GK", quality: 80 },
    { name: "Horst Blankenburg", pos: "CB", quality: 86 },
    { name: "Nico Rijnders", pos: "MF", quality: 79 }
  ]
},

{
  name: "2013 Borussia Dortmund",
  season: 2013,
  strength: 92,
  startingXI: [
    { name: "Roman Weidenfeller", pos: "GK", quality: 88 },
    { name: "Łukasz Piszczek", pos: "RB", quality: 87 },
    { name: "Neven Subotić", pos: "CB", quality: 86 },
    { name: "Mats Hummels", pos: "CB", quality: 90 },
    { name: "Marcel Schmelzer", pos: "LB", quality: 85 },
    { name: "İlkay Gündoğan", pos: "CM", quality: 88 },
    { name: "Sven Bender", pos: "DM", quality: 85 },
    { name: "Marco Reus", pos: "LW", quality: 92 },
    { name: "Mario Götze", pos: "AM", quality: 90 },
    { name: "Jakub Błaszczykowski", pos: "RW", quality: 87 },
    { name: "Robert Lewandowski", pos: "ST", quality: 91 }
  ],
  bench: [
    { name: "Mitchell Langerak", pos: "GK", quality: 78 },
    { name: "Felipe Santana", pos: "CB", quality: 82 },
    { name: "Nuri Şahin", pos: "CM", quality: 84 },
    { name: "Kevin Großkreutz", pos: "RW", quality: 83 },
    { name: "Julian Schieber", pos: "ST", quality: 80 },
    { name: "Moritz Leitner", pos: "CM", quality: 79 },
    { name: "Oliver Kirch", pos: "DM", quality: 77 }
  ]
},

{
  name: "1996 River Plate",
  season: 1996,
  strength: 89,
  startingXI: [
    { name: "Germán Burgos", pos: "GK", quality: 86 },
    { name: "Roberto Trotta", pos: "RB", quality: 85 },
    { name: "Celso Ayala", pos: "CB", quality: 87 },
    { name: "Juan Pablo Sorín", pos: "CB", quality: 86 },
    { name: "Leonardo Astrada", pos: "DM", quality: 88 },
    { name: "Matías Almeyda", pos: "CM", quality: 87 },
    { name: "Ariel Ortega", pos: "AM", quality: 92 },
    { name: "Enzo Francescoli", pos: "SS", quality: 90 },
    { name: "Marcelo Gallardo", pos: "AM", quality: 89 },
    { name: "Julio Cruz", pos: "ST", quality: 86 },
    { name: "Juan Pablo Ángel", pos: "ST", quality: 85 }
  ],
  bench: [
    { name: "Ángel Comizzo", pos: "GK", quality: 80 },
    { name: "Eduardo Berizzo", pos: "CB", quality: 83 },
    { name: "Sergio Berti", pos: "RW", quality: 84 },
    { name: "Hernán Crespo", pos: "ST", quality: 88 },
    { name: "Roberto Monserrat", pos: "LB", quality: 81 },
    { name: "Marcelo Escudero", pos: "CM", quality: 80 },
    { name: "Aníbal Matellán", pos: "CB", quality: 79 }
  ]
},

{
  name: "1992 Foggia",
  season: 1992,
  strength: 85,
  startingXI: [
    { name: "Giuseppe Taglialatela", pos: "GK", quality: 84 },
    { name: "Francesco Mancini", pos: "RB", quality: 82 },
    { name: "Lorenzo Amoruso", pos: "CB", quality: 85 },
    { name: "Mirko Taccola", pos: "CB", quality: 83 },
    { name: "Roberto Rambaudi", pos: "LB", quality: 81 },
    { name: "Francesco Baiano", pos: "AM", quality: 88 },
    { name: "Giuseppe Signori", pos: "SS", quality: 92 },
    { name: "Roberto Rambaudi", pos: "RM", quality: 83 },
    { name: "Domenico Marocchino", pos: "LM", quality: 82 },
    { name: "Andrea Carnevale", pos: "ST", quality: 86 },
    { name: "Francesco Baiano", pos: "ST", quality: 87 }
  ],
  bench: [
    { name: "Francesco Mancini", pos: "GK", quality: 76 },
    { name: "Giuseppe Scienza", pos: "CB", quality: 79 },
    { name: "Massimiliano Esposito", pos: "CM", quality: 78 },
    { name: "Francesco Dell'Anno", pos: "DM", quality: 80 },
    { name: "Giuseppe Galderisi", pos: "ST", quality: 82 },
    { name: "Francesco Moriero", pos: "RW", quality: 83 },
    { name: "Francesco Baiano", pos: "AM", quality: 84 }
  ]
},

{
  name: "2001 Lazio",
  season: 2001,
  strength: 91,
  startingXI: [
    { name: "Angelo Peruzzi", pos: "GK", quality: 90 },
    { name: "Giuseppe Pancaro", pos: "RB", quality: 85 },
    { name: "Alessandro Nesta", pos: "CB", quality: 94 },
    { name: "Sinisa Mihajlovic", pos: "CB", quality: 88 },
    { name: "Giuseppe Favalli", pos: "LB", quality: 86 },
    { name: "Diego Simeone", pos: "DM", quality: 89 },
    { name: "Juan Sebastián Verón", pos: "CM", quality: 92 },
    { name: "Pavel Nedvěd", pos: "LW", quality: 91 },
    { name: "Dejan Stanković", pos: "RW", quality: 87 },
    { name: "Hernán Crespo", pos: "ST", quality: 92 },
    { name: "Claudio López", pos: "ST", quality: 88 }
  ],
  bench: [
    { name: "Luca Marchegiani", pos: "GK", quality: 82 },
    { name: "Paolo Negro", pos: "CB", quality: 84 },
    { name: "Lucas Castromán", pos: "RW", quality: 83 },
    { name: "Fabio Liverani", pos: "CM", quality: 82 },
    { name: "Simone Inzaghi", pos: "ST", quality: 85 },
    { name: "Roberto Baronio", pos: "CM", quality: 80 },
    { name: "Dario Marcolin", pos: "DM", quality: 81 }
  ]
},

{
  name: "1990 Roma",
  season: 1990,
  strength: 87,
  startingXI: [
    { name: "Giovanni Cervone", pos: "GK", quality: 85 },
    { name: "Aldair", pos: "CB", quality: 88 },
    { name: "Sebastiano Nela", pos: "RB", quality: 86 },
    { name: "Thomas Berthold", pos: "CB", quality: 85 },
    { name: "Amedeo Carboni", pos: "LB", quality: 84 },
    { name: "Giuseppe Giannini", pos: "CM", quality: 90 },
    { name: "Stefano Desideri", pos: "CM", quality: 84 },
    { name: "Rudi Völler", pos: "ST", quality: 91 },
    { name: "Ruggiero Rizzitelli", pos: "ST", quality: 86 },
    { name: "Andrea Carnevale", pos: "ST", quality: 87 },
    { name: "Thomas Hassler", pos: "AM", quality: 88 }
  ],
  bench: [
    { name: "Giuseppe Zinetti", pos: "GK", quality: 78 },
    { name: "Francesco Statuto", pos: "CM", quality: 79 },
    { name: "Fausto Salsano", pos: "RW", quality: 80 },
    { name: "Giovanni Piacentini", pos: "LB", quality: 78 },
    { name: "Francesco Totti", pos: "AM", quality: 82 },
    { name: "Francesco Moriero", pos: "RW", quality: 83 },
    { name: "Raffaele Sergio", pos: "CB", quality: 79 }
  ]
},

{
  name: "1994 Parma",
  season: 1994,
  strength: 90,
  startingXI: [
    { name: "Luca Bucci", pos: "GK", quality: 86 },
    { name: "Antonio Benarrivo", pos: "RB", quality: 87 },
    { name: "Lorenzo Minotti", pos: "CB", quality: 88 },
    { name: "Luigi Apolloni", pos: "CB", quality: 86 },
    { name: "Roberto Sensini", pos: "LB", quality: 87 },
    { name: "Dino Baggio", pos: "CM", quality: 88 },
    { name: "Gabriele Pin", pos: "DM", quality: 85 },
    { name: "Tomas Brolin", pos: "AM", quality: 91 },
    { name: "Gianfranco Zola", pos: "SS", quality: 92 },
    { name: "Faustino Asprilla", pos: "ST", quality: 90 },
    { name: "Massimo Crippa", pos: "CM", quality: 84 }
  ],
  bench: [
    { name: "Gianluigi Buffon", pos: "GK", quality: 80 },
    { name: "Alain Boghossian", pos: "CM", quality: 82 },
    { name: "Alessandro Melli", pos: "ST", quality: 83 },
    { name: "Stefano Fiore", pos: "AM", quality: 81 },
    { name: "Nestor Sensini", pos: "CB", quality: 85 },
    { name: "Fernando Couto", pos: "CB", quality: 84 },
    { name: "Roberto Mussi", pos: "RB", quality: 83 }
  ]
},

{
  name: "1997 Inter Milan",
  season: 1997,
  strength: 92,
  startingXI: [
    { name: "Gianluca Pagliuca", pos: "GK", quality: 90 },
    { name: "Javier Zanetti", pos: "RB", quality: 89 },
    { name: "Ivan Cordoba", pos: "CB", quality: 87 },
    { name: "Fabio Galante", pos: "CB", quality: 85 },
    { name: "Giuseppe Bergomi", pos: "CB", quality: 88 },
    { name: "Aron Winter", pos: "CM", quality: 84 },
    { name: "Diego Simeone", pos: "DM", quality: 90 },
    { name: "Youri Djorkaeff", pos: "AM", quality: 91 },
    { name: "Ivan Zamorano", pos: "ST", quality: 89 },
    { name: "Ronaldo", pos: "ST", quality: 96 },
    { name: "Francesco Moriero", pos: "RW", quality: 86 }
  ],
  bench: [
    { name: "Andrea Mazzantini", pos: "GK", quality: 78 },
    { name: "Salvatore Fresi", pos: "CB", quality: 80 },
    { name: "Benito Carbone", pos: "LW", quality: 87 },
    { name: "Zé Elias", pos: "CM", quality: 83 },
    { name: "Andrea Pirlo", pos: "AM", quality: 82 },
    { name: "Alvaro Recoba", pos: "ST", quality: 86 },
    { name: "Nicolás Burdisso", pos: "CB", quality: 79 }
  ]
},
{
  name: "2015 Juventus",
  season: 2015,
  strength: 93,
  startingXI: [
    { name: "Gianluigi Buffon", pos: "GK", quality: 94 },
    { name: "Stephan Lichtsteiner", pos: "RB", quality: 86 },
    { name: "Leonardo Bonucci", pos: "CB", quality: 90 },
    { name: "Giorgio Chiellini", pos: "CB", quality: 92 },
    { name: "Patrice Evra", pos: "LB", quality: 87 },
    { name: "Claudio Marchisio", pos: "CM", quality: 88 },
    { name: "Andrea Pirlo", pos: "CM", quality: 90 },
    { name: "Paul Pogba", pos: "CM", quality: 91 },
    { name: "Arturo Vidal", pos: "CM", quality: 90 },
    { name: "Carlos Tevez", pos: "ST", quality: 92 },
    { name: "Álvaro Morata", pos: "ST", quality: 87 }
  ],
  bench: [
    { name: "Marco Storari", pos: "GK", quality: 80 },
    { name: "Andrea Barzagli", pos: "CB", quality: 88 },
    { name: "Simone Padoin", pos: "RB", quality: 79 },
    { name: "Roberto Pereyra", pos: "CM", quality: 82 },
    { name: "Kingsley Coman", pos: "LW", quality: 81 },
    { name: "Fernando Llorente", pos: "ST", quality: 84 },
    { name: "Alessandro Matri", pos: "ST", quality: 80 }
  ]
},

{
  name: "2016 Juventus",
  season: 2016,
  strength: 94,
  startingXI: [
    { name: "Gianluigi Buffon", pos: "GK", quality: 94 },
    { name: "Dani Alves", pos: "RB", quality: 88 },
    { name: "Leonardo Bonucci", pos: "CB", quality: 91 },
    { name: "Giorgio Chiellini", pos: "CB", quality: 92 },
    { name: "Alex Sandro", pos: "LB", quality: 89 },
    { name: "Sami Khedira", pos: "CM", quality: 87 },
    { name: "Miralem Pjanić", pos: "CM", quality: 89 },
    { name: "Paulo Dybala", pos: "SS", quality: 92 },
    { name: "Juan Cuadrado", pos: "RW", quality: 86 },
    { name: "Gonzalo Higuaín", pos: "ST", quality: 93 },
    { name: "Mario Mandžukić", pos: "LW", quality: 88 }
  ],
  bench: [
    { name: "Neto", pos: "GK", quality: 81 },
    { name: "Andrea Barzagli", pos: "CB", quality: 87 },
    { name: "Medhi Benatia", pos: "CB", quality: 85 },
    { name: "Claudio Marchisio", pos: "CM", quality: 86 },
    { name: "Marko Pjaca", pos: "LW", quality: 82 },
    { name: "Mario Lemina", pos: "CM", quality: 81 },
    { name: "Kwadwo Asamoah", pos: "LB", quality: 83 }
  ]
},

{
  name: "2000 Deportivo La Coruña",
  season: 2000,
  strength: 89,
  startingXI: [
    { name: "José Francisco Molina", pos: "GK", quality: 87 },
    { name: "Manuel Pablo", pos: "RB", quality: 85 },
    { name: "Noureddine Naybet", pos: "CB", quality: 88 },
    { name: "Mauro Silva", pos: "DM", quality: 89 },
    { name: "Enrique Romero", pos: "LB", quality: 84 },
    { name: "Flávio Conceição", pos: "CM", quality: 87 },
    { name: "Juan Carlos Valerón", pos: "AM", quality: 91 },
    { name: "Djalminha", pos: "AM", quality: 90 },
    { name: "Roy Makaay", pos: "ST", quality: 89 },
    { name: "Diego Tristán", pos: "ST", quality: 88 },
    { name: "Victor Sánchez", pos: "RW", quality: 84 }
  ],
  bench: [
    { name: "Jacques Songo'o", pos: "GK", quality: 80 },
    { name: "César", pos: "CB", quality: 82 },
    { name: "Sergio González", pos: "CM", quality: 83 },
    { name: "Pandiani", pos: "ST", quality: 84 },
    { name: "Emerson", pos: "DM", quality: 82 },
    { name: "Lionel Scaloni", pos: "RB", quality: 79 },
    { name: "Donato", pos: "CB", quality: 81 }
  ]
},

{
  name: "1998 Bayer Leverkusen",
  season: 1998,
  strength: 87,
  startingXI: [
    { name: "Adam Matysek", pos: "GK", quality: 84 },
    { name: "Marko Babić", pos: "RB", quality: 82 },
    { name: "Jens Nowotny", pos: "CB", quality: 87 },
    { name: "Boris Živković", pos: "CB", quality: 85 },
    { name: "Erik Meijer", pos: "ST", quality: 83 },
    { name: "Michael Ballack", pos: "CM", quality: 88 },
    { name: "Emerson", pos: "DM", quality: 86 },
    { name: "Zé Roberto", pos: "LW", quality: 87 },
    { name: "Bernd Schneider", pos: "RW", quality: 86 },
    { name: "Ulf Kirsten", pos: "ST", quality: 88 },
    { name: "Paulo Rink", pos: "ST", quality: 82 }
  ],
  bench: [
    { name: "Dirk Heinen", pos: "GK", quality: 78 },
    { name: "Carsten Ramelow", pos: "CB", quality: 84 },
    { name: "Hanno Balitsch", pos: "CM", quality: 79 },
    { name: "Oliver Neuville", pos: "ST", quality: 85 },
    { name: "Yıldıray Baştürk", pos: "AM", quality: 83 },
    { name: "Thomas Brdarić", pos: "ST", quality: 80 },
    { name: "Dariusz Wosz", pos: "CM", quality: 82 }
  ]
},

{
  name: "2003 Celtic",
  season: 2003,
  strength: 86,
  startingXI: [
    { name: "Rab Douglas", pos: "GK", quality: 83 },
    { name: "Didier Agathe", pos: "RB", quality: 82 },
    { name: "Bobo Baldé", pos: "CB", quality: 84 },
    { name: "Stanislav Varga", pos: "CB", quality: 83 },
    { name: "Joos Valgaeren", pos: "LB", quality: 82 },
    { name: "Neil Lennon", pos: "DM", quality: 85 },
    { name: "Stiliyan Petrov", pos: "CM", quality: 86 },
    { name: "Paul Lambert", pos: "CM", quality: 83 },
    { name: "Alan Thompson", pos: "LW", quality: 84 },
    { name: "Chris Sutton", pos: "ST", quality: 85 },
    { name: "Henrik Larsson", pos: "ST", quality: 91 }
  ],
  bench: [
    { name: "Magnus Hedman", pos: "GK", quality: 79 },
    { name: "Johan Mjällby", pos: "CB", quality: 83 },
    { name: "Jackie McNamara", pos: "RB", quality: 81 },
    { name: "Shaun Maloney", pos: "LW", quality: 80 },
    { name: "John Hartson", pos: "ST", quality: 84 },
    { name: "Steve Guppy", pos: "LW", quality: 78 },
    { name: "Ulrik Laursen", pos: "CB", quality: 79 }
  ]
},

{
  name: "1994 VfB Stuttgart",
  season: 1994,
  strength: 86,
  startingXI: [
    { name: "Eike Immel", pos: "GK", quality: 86 },
    { name: "Thomas Schneider", pos: "RB", quality: 82 },
    { name: "Michael Frontzeck", pos: "CB", quality: 84 },
    { name: "Guido Buchwald", pos: "CB", quality: 87 },
    { name: "Matthias Sammer", pos: "DM", quality: 90 },
    { name: "Krassimir Balakov", pos: "AM", quality: 88 },
    { name: "Maurizio Gaudino", pos: "CM", quality: 85 },
    { name: "Zvonimir Soldo", pos: "CM", quality: 83 },
    { name: "Lucien Mettomo", pos: "CB", quality: 81 },
    { name: "Fredi Bobic", pos: "ST", quality: 86 },
    { name: "Giovane Élber", pos: "ST", quality: 87 }
  ],
  bench: [
    { name: "Marc Ziegler", pos: "GK", quality: 77 },
    { name: "Thomas Berthold", pos: "CB", quality: 83 },
    { name: "Martin Spanring", pos: "DM", quality: 79 },
    { name: "Jonathan Akpoborie", pos: "ST", quality: 82 },
    { name: "Radoslav Látal", pos: "RW", quality: 81 },
    { name: "Jovo Simanić", pos: "CB", quality: 80 },
    { name: "Jürgen Rische", pos: "ST", quality: 78 }
  ]
},

{
  name: "2006 Sevilla",
  season: 2006,
  strength: 88,
  startingXI: [
    { name: "Andrés Palop", pos: "GK", quality: 86 },
    { name: "Daniel Alves", pos: "RB", quality: 87 },
    { name: "Javi Navarro", pos: "CB", quality: 85 },
    { name: "Julien Escudé", pos: "CB", quality: 84 },
    { name: "David Castedo", pos: "LB", quality: 83 },
    { name: "Enzo Maresca", pos: "CM", quality: 86 },
    { name: "Christian Poulsen", pos: "DM", quality: 85 },
    { name: "Jesús Navas", pos: "RW", quality: 87 },
    { name: "Luis Fabiano", pos: "ST", quality: 88 },
    { name: "Frédéric Kanouté", pos: "ST", quality: 89 },
    { name: "Adriano", pos: "LW", quality: 85 }
  ],
  bench: [
    { name: "David Cobeño", pos: "GK", quality: 78 },
    { name: "Antonio Puerta", pos: "LB", quality: 82 },
    { name: "Renato", pos: "CM", quality: 83 },
    { name: "Aleksandr Kerzhakov", pos: "ST", quality: 84 },
    { name: "Arouna Koné", pos: "ST", quality: 82 },
    { name: "Duda", pos: "LW", quality: 83 },
    { name: "Ivica Dragutinović", pos: "CB", quality: 81 }
  ]
},
      {
        name: "1991 Sampdoria",
        season: 1991,
        strength: 89,
        startingXI: [
          { name: "Gianluca Pagliuca", pos: "GK", quality: 90 },
          { name: "Moreno Mannini", pos: "RB", quality: 86 },
          { name: "Pietro Vierchowod", pos: "CB", quality: 92 },
          { name: "Lorenzo Minotti", pos: "CB", quality: 86 },
          { name: "Amedeo Carboni", pos: "LB", quality: 86 },
          { name: "Toninho Cerezo", pos: "CM", quality: 90 },
          { name: "Giuseppe Dossena", pos: "CM", quality: 87 },
          { name: "Attilio Lombardo", pos: "RM", quality: 88 },
          { name: "Mihailo Mihajlović", pos: "LM", quality: 82 },
          { name: "Gianluca Vialli", pos: "ST", quality: 93 },
          { name: "Roberto Mancini", pos: "SS", quality: 92 }
        ],
        bench: [
          { name: "Ivano Bonetti", pos: "MF", quality: 82 },
          { name: "Fausto Pari", pos: "MF", quality: 81 },
          { name: "Srecko Katanec", pos: "DM", quality: 84 },
          { name: "Marco Branca", pos: "ST", quality: 82 },
          { name: "Luca Pellegrini", pos: "DF", quality: 80 },
          { name: "Giovanni Invernizzi", pos: "DF", quality: 79 },
          { name: "Luca Bucci", pos: "GK", quality: 77 }
        ]
      },

      {
        name: "1996 Ajax",
        season: 1996,
        strength: 93,
        startingXI: [
          { name: "Edwin van der Sar", pos: "GK", quality: 93 },
          { name: "Michael Reiziger", pos: "RB", quality: 89 },
          { name: "Frank de Boer", pos: "CB", quality: 93 },
          { name: "Danny Blind", pos: "CB", quality: 91 },
          { name: "Winston Bogarde", pos: "LB", quality: 86 },
          { name: "Edgar Davids", pos: "CM", quality: 93 },
          { name: "Clarence Seedorf", pos: "CM", quality: 92 },
          { name: "Ronald de Boer", pos: "AM", quality: 89 },
          { name: "Marc Overmars", pos: "LW", quality: 91 },
          { name: "Jari Litmanen", pos: "ST", quality: 94 },
          { name: "Nwankwo Kanu", pos: "ST", quality: 88 }
        ],
        bench: [
          { name: "Fred Grim", pos: "GK", quality: 78 },
          { name: "Tijani Babangida", pos: "RW", quality: 84 },
          { name: "Kiki Musampa", pos: "LW", quality: 82 },
          { name: "Finidi George", pos: "RW", quality: 88 },
          { name: "Patrick Kluivert", pos: "ST", quality: 90 },
          { name: "Peter Hoekstra", pos: "LW", quality: 80 },
          { name: "Sonny Silooy", pos: "RB", quality: 80 }
        ]
      },

      {
        name: "1989 AC Milan",
        season: 1989,
        strength: 96,
        startingXI: [
          { name: "Giovanni Galli", pos: "GK", quality: 90 },
          { name: "Mauro Tassotti", pos: "RB", quality: 90 },
          { name: "Franco Baresi", pos: "CB", quality: 98 },
          { name: "Alessandro Costacurta", pos: "CB", quality: 92 },
          { name: "Paolo Maldini", pos: "LB", quality: 97 },
          { name: "Frank Rijkaard", pos: "DM", quality: 96 },
          { name: "Carlo Ancelotti", pos: "CM", quality: 90 },
          { name: "Roberto Donadoni", pos: "RM", quality: 89 },
          { name: "Ruud Gullit", pos: "AM", quality: 97 },
          { name: "Marco van Basten", pos: "ST", quality: 99 },
          { name: "Angelo Colombo", pos: "LM", quality: 84 }
        ],
        bench: [
          { name: "Andrea Pazzagli", pos: "GK", quality: 79 },
          { name: "Filippo Galli", pos: "CB", quality: 84 },
          { name: "Demetrio Albertini", pos: "CM", quality: 86 },
          { name: "Pietro Paolo Virdis", pos: "ST", quality: 86 },
          { name: "Alberico Evani", pos: "LM", quality: 84 },
          { name: "Daniele Massaro", pos: "FW", quality: 84 },
          { name: "Giovanni Stroppa", pos: "AM", quality: 80 }
        ]
      },

      {
        name: "2007 AC Milan",
        season: 2007,
        strength: 94,
        startingXI: [
          { name: "Dida", pos: "GK", quality: 90 },
          { name: "Massimo Oddo", pos: "RB", quality: 86 },
          { name: "Alessandro Nesta", pos: "CB", quality: 95 },
          { name: "Paolo Maldini", pos: "CB", quality: 95 },
          { name: "Marek Jankulovski", pos: "LB", quality: 87 },
          { name: "Andrea Pirlo", pos: "CM", quality: 96 },
          { name: "Gennaro Gattuso", pos: "DM", quality: 90 },
          { name: "Clarence Seedorf", pos: "CM", quality: 93 },
          { name: "Kaká", pos: "AM", quality: 98 },
          { name: "Filippo Inzaghi", pos: "ST", quality: 92 },
          { name: "Alberto Gilardino", pos: "ST", quality: 88 }
        ],
        bench: [
          { name: "Zeljko Kalac", pos: "GK", quality: 78 },
          { name: "Daniele Bonera", pos: "CB", quality: 82 },
          { name: "Massimo Ambrosini", pos: "CM", quality: 86 },
          { name: "Cristian Brocchi", pos: "CM", quality: 80 },
          { name: "Ronaldo", pos: "ST", quality: 90 },
          { name: "Yoann Gourcuff", pos: "AM", quality: 82 },
          { name: "Serginho", pos: "LB", quality: 82 }
        ]
      },
      {
        name: "2011 Santos",
        season: 2011,
        strength: 90,
        startingXI: [
          { name: "Rafael Cabral", pos: "GK", quality: 86 },
          { name: "Danilo", pos: "RB", quality: 88 },
          { name: "Edu Dracena", pos: "CB", quality: 86 },
          { name: "Durval", pos: "CB", quality: 85 },
          { name: "Léo", pos: "LB", quality: 86 },
          { name: "Arouca", pos: "CM", quality: 87 },
          { name: "Adriano", pos: "DM", quality: 84 },
          { name: "Elano", pos: "AM", quality: 88 },
          { name: "Ganso", pos: "AM", quality: 90 },
          { name: "Neymar", pos: "LW", quality: 96 },
          { name: "Borges", pos: "ST", quality: 88 }
        ],
        bench: [
          { name: "Aranha", pos: "GK", quality: 77 },
          { name: "Bruno Rodrigo", pos: "CB", quality: 80 },
          { name: "Pará", pos: "RB", quality: 80 },
          { name: "Ibson", pos: "CM", quality: 82 },
          { name: "Alan Kardec", pos: "ST", quality: 82 },
          { name: "Zé Eduardo", pos: "ST", quality: 81 },
          { name: "Felipe Anderson", pos: "AM", quality: 82 }
        ]
      }, 
{
  name: "1986 River Plate",
  season: 1986,
  strength: 90,
  startingXI: [
    { name: "Nery Pumpido", pos: "GK", quality: 90 },
    { name: "Jorge Gordillo", pos: "RB", quality: 84 },
    { name: "Nelson Gutiérrez", pos: "CB", quality: 86 },
    { name: "Óscar Ruggeri", pos: "CB", quality: 92 },
    { name: "Alejandro Montenegro", pos: "LB", quality: 84 },
    { name: "Héctor Enrique", pos: "CM", quality: 86 },
    { name: "Américo Gallego", pos: "DM", quality: 88 },
    { name: "Roque Alfaro", pos: "RM", quality: 84 },
    { name: "Antonio Alzamendi", pos: "RW", quality: 90 },
    { name: "Norberto Alonso", pos: "AM", quality: 91 },
    { name: "Juan Gilberto Funes", pos: "ST", quality: 88 }
  ],
  bench: [
    { name: "Sergio Goycochea", pos: "GK", quality: 82 },
    { name: "Oscar Cortéz", pos: "DF", quality: 79 },
    { name: "Claudio Morresi", pos: "AM", quality: 84 },
    { name: "Gabriel Rodríguez", pos: "FW", quality: 80 },
    { name: "Néstor Gorosito", pos: "AM", quality: 83 },
    { name: "Jorge Villarreal", pos: "CM", quality: 79 },
    { name: "Carlos Enrique", pos: "LM", quality: 80 }
  ]
},

{
  name: "1987 Porto",
  season: 1987,
  strength: 90,
  startingXI: [
    { name: "Mlynarczyk", pos: "GK", quality: 88 },
    { name: "João Pinto", pos: "RB", quality: 86 },
    { name: "Celso", pos: "CB", quality: 85 },
    { name: "Geraldão", pos: "CB", quality: 87 },
    { name: "Inácio", pos: "LB", quality: 84 },
    { name: "Jaime Magalhães", pos: "RM", quality: 86 },
    { name: "Quim", pos: "CM", quality: 84 },
    { name: "Sousa", pos: "CM", quality: 86 },
    { name: "Rui Barros", pos: "AM", quality: 90 },
    { name: "Paulo Futre", pos: "LW", quality: 93 },
    { name: "Fernando Gomes", pos: "ST", quality: 90 }
  ],
  bench: [
    { name: "Zé Beto", pos: "GK", quality: 78 },
    { name: "Edu Coimbra", pos: "MF", quality: 80 },
    { name: "André", pos: "CM", quality: 82 },
    { name: "Casagrande", pos: "ST", quality: 84 },
    { name: "Ribeiro", pos: "DF", quality: 79 },
    { name: "Frasco", pos: "DM", quality: 80 },
    { name: "Vítor Domingos", pos: "DF", quality: 78 }
  ]
},

{
  name: "1988 Steaua București",
  season: 1988,
  strength: 89,
  startingXI: [
    { name: "Silviu Lung", pos: "GK", quality: 88 },
    { name: "Ștefan Iovan", pos: "RB", quality: 86 },
    { name: "Miodrag Belodedici", pos: "CB", quality: 90 },
    { name: "Adrian Bumbescu", pos: "CB", quality: 86 },
    { name: "Ilie Bărbulescu", pos: "LB", quality: 84 },
    { name: "László Bölöni", pos: "CM", quality: 90 },
    { name: "Ionel Rotariu", pos: "CM", quality: 84 },
    { name: "Gavril Balint", pos: "ST", quality: 88 },
    { name: "Marius Lăcătuș", pos: "RW", quality: 91 },
    { name: "Victor Pițurcă", pos: "ST", quality: 88 },
    { name: "Iulian Majearu", pos: "LW", quality: 82 }
  ],
  bench: [
    { name: "Dumitru Stângaciu", pos: "GK", quality: 79 },
    { name: "Tudorel Stoica", pos: "DM", quality: 83 },
    { name: "Daniel Minea", pos: "CM", quality: 80 },
    { name: "Dan Petrescu", pos: "RB", quality: 82 },
    { name: "Gheorghe Hagi", pos: "AM", quality: 93 },
    { name: "Adrian Negrău", pos: "ST", quality: 80 },
    { name: "Ionut Lupescu", pos: "CM", quality: 82 }
  ]
},

{
  name: "1993 Marseille",
  season: 1993,
  strength: 92,
  startingXI: [
    { name: "Fabien Barthez", pos: "GK", quality: 92 },
    { name: "Jocelyn Angloma", pos: "RB", quality: 88 },
    { name: "Marcel Desailly", pos: "CB", quality: 93 },
    { name: "Basel Boli", pos: "CB", quality: 90 },
    { name: "Éric Di Meco", pos: "LB", quality: 86 },
    { name: "Didier Deschamps", pos: "DM", quality: 91 },
    { name: "Franck Sauzée", pos: "CM", quality: 89 },
    { name: "Abedi Pelé", pos: "AM", quality: 91 },
    { name: "Rudi Völler", pos: "ST", quality: 91 },
    { name: "Alen Bokšić", pos: "ST", quality: 92 },
    { name: "François Omam-Biyik", pos: "RW", quality: 86 }
  ],
  bench: [
    { name: "Jean-Michel Ferri", pos: "CM", quality: 82 },
    { name: "Jean-Philippe Durand", pos: "MF", quality: 82 },
    { name: "Jean-Christophe Thomas", pos: "DM", quality: 81 },
    { name: "Dragan Stojković", pos: "AM", quality: 90 },
    { name: "Jean-Pierre Papin (departed but alt-era)", pos: "ST", quality: 94 },
    { name: "Yannick Stopyra", pos: "ST", quality: 80 },
    { name: "Bruno Germain", pos: "CM", quality: 80 }
  ]
},

{
  name: "1981 Liverpool",
  season: 1981,
  strength: 92,
  startingXI: [
    { name: "Ray Clemence", pos: "GK", quality: 93 },
    { name: "Phil Neal", pos: "RB", quality: 90 },
    { name: "Alan Hansen", pos: "CB", quality: 93 },
    { name: "Phil Thompson", pos: "CB", quality: 88 },
    { name: "Alan Kennedy", pos: "LB", quality: 86 },
    { name: "Terry McDermott", pos: "CM", quality: 88 },
    { name: "Graeme Souness", pos: "CM", quality: 95 },
    { name: "Sammy Lee", pos: "CM", quality: 86 },
    { name: "Ray Kennedy", pos: "LM", quality: 88 },
    { name: "Kenny Dalglish", pos: "SS", quality: 97 },
    { name: "David Johnson", pos: "ST", quality: 86 }
  ],
  bench: [
    { name: "Bruce Grobbelaar", pos: "GK", quality: 84 },
    { name: "Steve Nicol", pos: "DF", quality: 84 },
    { name: "Ian Rush", pos: "ST", quality: 95 },
    { name: "Howard Gayle", pos: "FW", quality: 80 },
    { name: "Colin Irwin", pos: "DF", quality: 79 },
    { name: "Richard Money", pos: "DF", quality: 78 },
    { name: "Kevin Sheedy", pos: "LM", quality: 82 }
  ]
}
];
// === END OF TEAM_POOL DEFINITION =================================

/************* GLOBAL STATE INITIALIZATION *************/
const PLAYER_DB = (window.PLAYER_DB = window.PLAYER_DB || {});
const MATCH_DETAILS_DB = (window.MATCH_DETAILS_DB = window.MATCH_DETAILS_DB || {});
const CLUB_LEGACY_DB = (window.CLUB_LEGACY_DB = window.CLUB_LEGACY_DB || {
  champions: {},
  finals: {},
  semiFinals: {},
  quarterFinals: {},
  totalWins: {}
});

const MATCH_SCHEDULE = (window.MATCH_SCHEDULE = window.MATCH_SCHEDULE || {
  groupStage: [],
  knockoutStage: []
});

const TOURNAMENT_TIMELINE = (window.TOURNAMENT_TIMELINE = window.TOURNAMENT_TIMELINE || []);
const TEAM_MAP = (window.TEAM_MAP = window.TEAM_MAP || new Map());
const ALL_TIME_PLAYER_DB = (window.ALL_TIME_PLAYER_DB = window.ALL_TIME_PLAYER_DB || {});
const TOURNAMENT_HISTORY = (window.TOURNAMENT_HISTORY = window.TOURNAMENT_HISTORY || []);

/************* MANAGER CAREER MODE *************/

// Manager profile system
const MANAGER_PROFILE = window.MANAGER_PROFILE || {
  name: 'Manager',
  level: 1,
  xp: 0,
  xpToNextLevel: 1000,
  tournamentsPlayed: 0,
  tournamentsWon: 0,
  totalGoals: 0,
  totalMatches: 0,
  achievements: [],
  favoriteTeam: null,
  winRate: 0,
  avgGoalsPerMatch: 0,
  bestTournament: null,
  createdAt: new Date().toISOString()
};

// Load manager profile from localStorage
try {
  const savedProfile = localStorage.getItem('managerProfile');
  if (savedProfile) {
    Object.assign(MANAGER_PROFILE, JSON.parse(savedProfile));
  }
} catch (e) {
  console.warn('Could not load manager profile:', e);
}

window.MANAGER_PROFILE = MANAGER_PROFILE;

// ========================================
// ENHANCED THEME SYSTEM
// ========================================

const THEMES = {
  dark: {
    name: 'Dark Mode',
    icon: '🌙',
    colors: {
      primary: '#10B981',
      secondary: '#3B82F6',
      accent: '#8B5CF6',
      warning: '#F59E0B',
      danger: '#EF4444',
      background: 'linear-gradient(135deg, #0F172A 0%, #1E293B 100%)',
      cardBg: 'linear-gradient(135deg, rgba(30, 41, 59, 0.95), rgba(15, 23, 42, 0.95))',
      cardBorder: 'rgba(71, 85, 105, 0.4)',
      text: '#F1F5F9',
      textSecondary: '#94A3B8',
      textMuted: '#64748B',
      sidebarBg: 'rgba(15, 23, 42, 0.98)',
      headerBg: 'rgba(30, 41, 59, 0.95)',
      inputBg: 'rgba(30, 41, 59, 0.8)',
      hoverEffect: 'rgba(16, 185, 129, 0.1)'
    }
  },

  light: {
    name: 'Light Mode',
    icon: '☀️',
    colors: {
      primary: '#059669',
      secondary: '#2563EB',
      accent: '#7C3AED',
      warning: '#D97706',
      danger: '#DC2626',
      background: 'linear-gradient(135deg, #F8FAFC 0%, #E2E8F0 100%)',
      cardBg: 'linear-gradient(135deg, #FFFFFF, #F8FAFC)',
      cardBorder: 'rgba(203, 213, 225, 0.6)',
      text: '#1E293B',
      textSecondary: '#475569',
      textMuted: '#64748B',
      sidebarBg: 'rgba(255, 255, 255, 0.98)',
      headerBg: 'rgba(248, 250, 252, 0.95)',
      inputBg: 'rgba(248, 250, 252, 0.9)',
      hoverEffect: 'rgba(5, 150, 105, 0.1)'
    }
  },

  ocean: {
    name: 'Ocean Blue',
    icon: '🌊',
    colors: {
      primary: '#06B6D4',
      secondary: '#0EA5E9',
      accent: '#3B82F6',
      warning: '#F59E0B',
      danger: '#EF4444',
      background: 'linear-gradient(135deg, #0C4A6E 0%, #075985 50%, #0369A1 100%)',
      cardBg: 'linear-gradient(135deg, rgba(14, 116, 144, 0.95), rgba(8, 76, 97, 0.95))',
      cardBorder: 'rgba(6, 182, 212, 0.3)',
      text: '#F0F9FF',
      textSecondary: '#BAE6FD',
      textMuted: '#7DD3FC',
      sidebarBg: 'rgba(8, 76, 97, 0.98)',
      headerBg: 'rgba(14, 116, 144, 0.95)',
      inputBg: 'rgba(8, 76, 97, 0.8)',
      hoverEffect: 'rgba(6, 182, 212, 0.2)'
    }
  },

  forest: {
    name: 'Forest Green',
    icon: '🌲',
    colors: {
      primary: '#10B981',
      secondary: '#059669',
      accent: '#34D399',
      warning: '#F59E0B',
      danger: '#EF4444',
      background: 'linear-gradient(135deg, #064E3B 0%, #065F46 50%, #047857 100%)',
      cardBg: 'linear-gradient(135deg, rgba(6, 95, 70, 0.95), rgba(6, 78, 59, 0.95))',
      cardBorder: 'rgba(16, 185, 129, 0.3)',
      text: '#ECFDF5',
      textSecondary: '#A7F3D0',
      textMuted: '#6EE7B7',
      sidebarBg: 'rgba(6, 78, 59, 0.98)',
      headerBg: 'rgba(6, 95, 70, 0.95)',
      inputBg: 'rgba(6, 78, 59, 0.8)',
      hoverEffect: 'rgba(16, 185, 129, 0.2)'
    }
  },

  sunset: {
    name: 'Sunset Orange',
    icon: '🌅',
    colors: {
      primary: '#F59E0B',
      secondary: '#EF4444',
      accent: '#F97316',
      warning: '#DC2626',
      danger: '#B91C1C',
      background: 'linear-gradient(135deg, #7C2D12 0%, #9A3412 50%, #C2410C 100%)',
      cardBg: 'linear-gradient(135deg, rgba(154, 52, 18, 0.95), rgba(124, 45, 18, 0.95))',
      cardBorder: 'rgba(245, 158, 11, 0.3)',
      text: '#FFF7ED',
      textSecondary: '#FED7AA',
      textMuted: '#FDBA74',
      sidebarBg: 'rgba(124, 45, 18, 0.98)',
      headerBg: 'rgba(154, 52, 18, 0.95)',
      inputBg: 'rgba(124, 45, 18, 0.8)',
      hoverEffect: 'rgba(245, 158, 11, 0.2)'
    }
  },

  royal: {
    name: 'Royal Purple',
    icon: '👑',
    colors: {
      primary: '#8B5CF6',
      secondary: '#A78BFA',
      accent: '#C084FC',
      warning: '#F59E0B',
      danger: '#EF4444',
      background: 'linear-gradient(135deg, #4C1D95 0%, #5B21B6 50%, #6D28D9 100%)',
      cardBg: 'linear-gradient(135deg, rgba(91, 33, 182, 0.95), rgba(76, 29, 149, 0.95))',
      cardBorder: 'rgba(139, 92, 246, 0.3)',
      text: '#FAF5FF',
      textSecondary: '#E9D5FF',
      textMuted: '#D8B4FE',
      sidebarBg: 'rgba(76, 29, 149, 0.98)',
      headerBg: 'rgba(91, 33, 182, 0.95)',
      inputBg: 'rgba(76, 29, 149, 0.8)',
      hoverEffect: 'rgba(139, 92, 246, 0.2)'
    }
  }
};

let currentTheme = 'dark';

function applyTheme(themeName) {
  if (!THEMES[themeName]) {
    console.warn('Theme not found:', themeName);
    return;
  }

  currentTheme = themeName;
  const theme = THEMES[themeName];

  // Apply to document root
  const root = document.documentElement;
  Object.entries(theme.colors).forEach(([key, value]) => {
    root.style.setProperty(`--${key}`, value);
  });

  // Update body background
  document.body.style.background = theme.colors.background;
  document.body.style.color = theme.colors.text;

  // Update all major UI elements
  updateUIWithTheme(theme);

  // Save preference
  localStorage.setItem('selectedTheme', themeName);

  if (window.VERBOSE_LOGGING) console.log(`✓ Theme applied: ${theme.name}`);
  showNotification('success', 'Theme Changed',
    `Switched to ${theme.name}`, 2000);
}

function updateUIWithTheme(theme) {
  // Update sidebar
  const sidebar = document.getElementById('sidebar');
  if (sidebar) {
    sidebar.style.background = theme.colors.sidebarBg;
    sidebar.style.borderRight = `1px solid ${theme.colors.cardBorder}`;
  }

  // Update all cards
  document.querySelectorAll('[class*="card"], [style*="background"]').forEach(el => {
    if (el.classList.contains('card') || el.style.background.includes('gradient')) {
      el.style.background = theme.colors.cardBg;
      el.style.borderColor = theme.colors.cardBorder;
      el.style.color = theme.colors.text;
    }
  });

  // Update buttons
  document.querySelectorAll('.btn-primary').forEach(btn => {
    btn.style.background = `linear-gradient(135deg, ${theme.colors.primary}, ${theme.colors.secondary})`;
  });

  // Update text elements
  document.querySelectorAll('h1, h2, h3, h4, p, span, div').forEach(el => {
    if (!el.style.color || el.style.color.includes('rgb')) {
      el.style.color = theme.colors.text;
    }
  });
}

function showThemeSelector() {
  const modal = document.createElement('div');
  modal.className = 'modal-backdrop active';
  modal.style.zIndex = '10005';
  modal.innerHTML = `
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-head">
        <h2 style="color: ${THEMES[currentTheme].colors.primary};">🎨 Choose Theme</h2>
        <button class="modal-close" onclick="this.closest('.modal-backdrop').remove()">✕</button>
      </div>

      <div style="padding: 30px;">
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 16px;">
          ${Object.entries(THEMES).map(([key, theme]) => `
            <button onclick="applyTheme('${key}'); this.closest('.modal-backdrop').remove()"
                    style="padding: 24px; background: ${theme.colors.cardBg};
                           border: 3px solid ${currentTheme === key ? theme.colors.primary : theme.colors.cardBorder};
                           border-radius: 16px; cursor: pointer; transition: all 0.3s;
                           ${currentTheme === key ? 'box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);' : ''}"
                    onmouseover="this.style.transform='translateY(-4px)'; this.style.borderColor='${theme.colors.primary}'"
                    onmouseout="this.style.transform='translateY(0)'; this.style.borderColor='${currentTheme === key ? theme.colors.primary : theme.colors.cardBorder}'">
              <div style="font-size: 3em; margin-bottom: 10px;">${theme.icon}</div>
              <div style="color: ${theme.colors.text}; font-weight: 700; margin-bottom: 8px;">
                ${theme.name}
              </div>
              ${currentTheme === key ? `
                <div style="color: ${theme.colors.primary}; font-size: 0.85em; font-weight: 600;">
                  ✓ Active
                </div>
              ` : ''}

              <!-- Theme Preview -->
              <div style="display: flex; gap: 4px; margin-top: 12px; justify-content: center;">
                <div style="width: 20px; height: 20px; background: ${theme.colors.primary};
                            border-radius: 4px;"></div>
                <div style="width: 20px; height: 20px; background: ${theme.colors.secondary};
                            border-radius: 4px;"></div>
                <div style="width: 20px; height: 20px; background: ${theme.colors.accent};
                            border-radius: 4px;"></div>
              </div>
            </button>
          `).join('')}
        </div>
      </div>
    </div>
  `;

  document.body.appendChild(modal);
}

// Load saved theme on startup
window.addEventListener('DOMContentLoaded', () => {
  const savedTheme = localStorage.getItem('selectedTheme') || 'dark';
  applyTheme(savedTheme);
});

// ========================================
// TOURNAMENT HISTORY SYSTEM - ENHANCED
// ========================================

let TOURNAMENT_HISTORY_ENHANCED = {
  completed: [],
  currentTournament: null,
  totalTournamentsPlayed: 0,
  statistics: {
    totalMatches: 0,
    totalGoals: 0,
    biggestWin: null,
    mostGoalsInMatch: 0,
    championsByTeam: {},
    runnersUpByTeam: {},
    topScorers: []
  }
};

// Store current tournament data for history
function initializeTournamentTracking(tournamentName, teams, format) {
  TOURNAMENT_HISTORY_ENHANCED.currentTournament = {
    id: `tournament_${Date.now()}`,
    name: tournamentName || 'Tournament',
    startDate: new Date().toISOString(),
    endDate: null,
    format: format || 'knockout',
    teams: teams.map(t => ({ name: t.name, strength: t.strength })),
    totalTeams: teams.length,
    matches: [],
    stages: {
      groups: { completed: false, results: [] },
      roundOf32: { completed: false, results: [] },
      roundOf16: { completed: false, results: [] },
      quarterFinals: { completed: false, results: [] },
      semiFinals: { completed: false, results: [] },
      final: { completed: false, result: null }
    },
    champion: null,
    runnerUp: null,
    topScorer: null,
    statistics: {
      totalGoals: 0,
      totalMatches: 0,
      averageGoalsPerMatch: 0,
      biggestWin: null,
      mostGoalsInMatch: 0
    }
  };
}

function trackMatchForHistory(matchResult) {
  if (!TOURNAMENT_HISTORY_ENHANCED.currentTournament) return;

  const matchData = {
    teamA: matchResult.teamA,
    teamB: matchResult.teamB,
    scoreA: matchResult.scoreA,
    scoreB: matchResult.scoreB,
    stage: matchResult.stage || 'unknown',
    timestamp: Date.now(),
    matchId: matchResult.matchId
  };

  TOURNAMENT_HISTORY_ENHANCED.currentTournament.matches.push(matchData);
  TOURNAMENT_HISTORY_ENHANCED.currentTournament.statistics.totalMatches++;

  const totalGoals = matchResult.scoreA + matchResult.scoreB;
  TOURNAMENT_HISTORY_ENHANCED.currentTournament.statistics.totalGoals += totalGoals;

  // Track biggest win
  const goalDiff = Math.abs(matchResult.scoreA - matchResult.scoreB);
  if (!TOURNAMENT_HISTORY_ENHANCED.currentTournament.statistics.biggestWin ||
      goalDiff > TOURNAMENT_HISTORY_ENHANCED.currentTournament.statistics.biggestWin.difference) {
    TOURNAMENT_HISTORY_ENHANCED.currentTournament.statistics.biggestWin = {
      teamA: matchResult.teamA,
      teamB: matchResult.teamB,
      scoreA: matchResult.scoreA,
      scoreB: matchResult.scoreB,
      difference: goalDiff
    };
  }

  // Track most goals in a match
  if (totalGoals > TOURNAMENT_HISTORY_ENHANCED.currentTournament.statistics.mostGoalsInMatch) {
    TOURNAMENT_HISTORY_ENHANCED.currentTournament.statistics.mostGoalsInMatch = totalGoals;
  }

  // Update stage tracking
  if (matchResult.stage) {
    const stageKey = mapStageToKey(matchResult.stage);
    if (TOURNAMENT_HISTORY_ENHANCED.currentTournament.stages[stageKey]) {
      TOURNAMENT_HISTORY_ENHANCED.currentTournament.stages[stageKey].results.push(matchData);
    }
  }
}

function mapStageToKey(stageName) {
  const mapping = {
    'groups': 'groups',
    'group': 'groups',
    'round of 32': 'roundOf32',
    'round of 16': 'roundOf16',
    'round-of-16': 'roundOf16',
    'quarter-final': 'quarterFinals',
    'quarter-finals': 'quarterFinals',
    'semi-final': 'semiFinals',
    'semi-finals': 'semiFinals',
    'final': 'final'
  };

  return mapping[stageName.toLowerCase()] || 'groups';
}

function markStageComplete(stage) {
  if (!TOURNAMENT_HISTORY_ENHANCED.currentTournament) return;

  const stageKey = mapStageToKey(stage);
  if (TOURNAMENT_HISTORY_ENHANCED.currentTournament.stages[stageKey]) {
    TOURNAMENT_HISTORY_ENHANCED.currentTournament.stages[stageKey].completed = true;
    if (window.VERBOSE_LOGGING) console.log(`✓ Stage complete: ${stage}`);
  }
}

function completeTournament(champion, runnerUp, topScorer) {
  if (!TOURNAMENT_HISTORY_ENHANCED.currentTournament) {
    console.warn('No active tournament to complete');
    return;
  }

  // Finalize tournament data
  TOURNAMENT_HISTORY_ENHANCED.currentTournament.endDate = new Date().toISOString();
  TOURNAMENT_HISTORY_ENHANCED.currentTournament.champion = champion;
  TOURNAMENT_HISTORY_ENHANCED.currentTournament.runnerUp = runnerUp;
  TOURNAMENT_HISTORY_ENHANCED.currentTournament.topScorer = topScorer;

  // Calculate average goals per match
  if (TOURNAMENT_HISTORY_ENHANCED.currentTournament.statistics.totalMatches > 0) {
    TOURNAMENT_HISTORY_ENHANCED.currentTournament.statistics.averageGoalsPerMatch =
      (TOURNAMENT_HISTORY_ENHANCED.currentTournament.statistics.totalGoals /
       TOURNAMENT_HISTORY_ENHANCED.currentTournament.statistics.totalMatches).toFixed(2);
  }

  // Add to completed tournaments
  TOURNAMENT_HISTORY_ENHANCED.completed.push({...TOURNAMENT_HISTORY_ENHANCED.currentTournament});
  TOURNAMENT_HISTORY_ENHANCED.totalTournamentsPlayed++;

  // Update global statistics
  TOURNAMENT_HISTORY_ENHANCED.statistics.totalMatches += TOURNAMENT_HISTORY_ENHANCED.currentTournament.statistics.totalMatches;
  TOURNAMENT_HISTORY_ENHANCED.statistics.totalGoals += TOURNAMENT_HISTORY_ENHANCED.currentTournament.statistics.totalGoals;

  // Track champions
  if (champion) {
    if (!TOURNAMENT_HISTORY_ENHANCED.statistics.championsByTeam[champion]) {
      TOURNAMENT_HISTORY_ENHANCED.statistics.championsByTeam[champion] = 0;
    }
    TOURNAMENT_HISTORY_ENHANCED.statistics.championsByTeam[champion]++;
  }

  // Track runners-up
  if (runnerUp) {
    if (!TOURNAMENT_HISTORY_ENHANCED.statistics.runnersUpByTeam[runnerUp]) {
      TOURNAMENT_HISTORY_ENHANCED.statistics.runnersUpByTeam[runnerUp] = 0;
    }
    TOURNAMENT_HISTORY_ENHANCED.statistics.runnersUpByTeam[runnerUp]++;
  }

  // Track top scorer
  if (topScorer) {
    TOURNAMENT_HISTORY_ENHANCED.statistics.topScorers.push({
      name: topScorer.name,
      goals: topScorer.goals,
      tournament: TOURNAMENT_HISTORY_ENHANCED.currentTournament.name,
      date: TOURNAMENT_HISTORY_ENHANCED.currentTournament.endDate
    });
  }

  // Update biggest win if this tournament had a bigger one
  const currentBiggestWin = TOURNAMENT_HISTORY_ENHANCED.currentTournament.statistics.biggestWin;
  if (currentBiggestWin &&
      (!TOURNAMENT_HISTORY_ENHANCED.statistics.biggestWin ||
       currentBiggestWin.difference > TOURNAMENT_HISTORY_ENHANCED.statistics.biggestWin.difference)) {
    TOURNAMENT_HISTORY_ENHANCED.statistics.biggestWin = {...currentBiggestWin};
  }

  // Track most goals in a match
  const currentMostGoals = TOURNAMENT_HISTORY_ENHANCED.currentTournament.statistics.mostGoalsInMatch;
  if (currentMostGoals > TOURNAMENT_HISTORY_ENHANCED.statistics.mostGoalsInMatch) {
    TOURNAMENT_HISTORY_ENHANCED.statistics.mostGoalsInMatch = currentMostGoals;
  }

  console.log(`✓ Tournament completed: ${TOURNAMENT_HISTORY_ENHANCED.currentTournament.name}`);
  if (window.VERBOSE_LOGGING) console.log(`Champion: ${champion}`);

  // Clear current tournament
  TOURNAMENT_HISTORY_ENHANCED.currentTournament = null;

  // Save
  if (typeof AUTO_SAVE !== 'undefined' && AUTO_SAVE.save) {
    AUTO_SAVE.save();
  }

  // Award manager XP and check achievements
  if (MANAGER_STATE.active) {
    ACHIEVEMENT_PROGRESS.tournamentsWon++;
    awardManagerXP(200, 'Tournament completed!');
    checkTournamentAchievements();
  }
}

// ========================================
// KNOCKOUT MATCH TRACKING - TWO-LEG SYSTEM
// ========================================

let KNOCKOUT_STATE = {
  currentMatches: [],
  completedMatches: [],
  twoLegMatches: {}, // Track two-leg ties
  pendingLeg2: [], // Matches waiting for leg 2
  aggregateScores: {}
};

// Two-leg match structure
function createTwoLegMatch(teamA, teamB, stage) {
  const matchId = `${stage}_${teamA.name}_vs_${teamB.name}_${Date.now()}`;

  return {
    matchId: matchId,
    stage: stage,
    teamA: teamA,
    teamB: teamB,
    isTwoLeg: true,
    leg1: {
      completed: false,
      scoreA: null,
      scoreB: null,
      homeTeam: teamA,
      awayTeam: teamB,
      matchId: `${matchId}_leg1`
    },
    leg2: {
      completed: false,
      scoreA: null,
      scoreB: null,
      homeTeam: teamB, // Reversed for leg 2
      awayTeam: teamA,
      matchId: `${matchId}_leg2`
    },
    aggregate: {
      teamA: 0,
      teamB: 0
    },
    winner: null,
    completed: false
  };
}

function initializeKnockoutStage(teams, stage, useTwoLegs = false) {
  KNOCKOUT_STATE.currentMatches = [];

  // Pair teams for matches
  for (let i = 0; i < teams.length; i += 2) {
    const teamA = teams[i];
    const teamB = teams[i + 1];

    if (teamA && teamB) {
      let match;
      if (useTwoLegs) {
        match = createTwoLegMatch(teamA, teamB, stage);
      } else {
        match = {
          matchId: `${stage}_${teamA.name}_vs_${teamB.name}_${Date.now()}`,
          stage: stage,
          teamA: teamA,
          teamB: teamB,
          isTwoLeg: false,
          scoreA: null,
          scoreB: null,
          winner: null,
          completed: false
        };
      }

      KNOCKOUT_STATE.currentMatches.push(match);
    }
  }

  if (window.VERBOSE_LOGGING) console.log(`✓ Initialized ${KNOCKOUT_STATE.currentMatches.length} knockout matches for ${stage}`);
  console.log(`Two-leg format: ${useTwoLegs}`);
}

// Helper function to normalize stage names
function normalizeStageNames(stage) {
  const stageMap = {
    'roundOf16': 'roundOf16',
    'round16': 'roundOf16',
    'ro16': 'roundOf16',
    'quarterFinals': 'quarterFinals',
    'quarters': 'quarterFinals',
    'qf': 'quarterFinals',
    'semiFinals': 'semiFinals',
    'semis': 'semiFinals',
    'sf': 'semiFinals',
    'final': 'final'
  };
  return stageMap[stage] || stage;
}

// Stage display names and icons
const STAGE_DISPLAY_NAMES = {
  'roundOf16': 'Round of 16',
  'quarterFinals': 'Quarter Finals',
  'semiFinals': 'Semi Finals',
  'final': 'Final'
};

const STAGE_ICONS = {
  'roundOf16': '⚔️',
  'quarterFinals': '🔥',
  'semiFinals': '⭐',
  'final': '🏆'
};

// Leg simulation functions
function simulateLeg1(matchIndex) {
  const match = KNOCKOUT_STATE.currentMatches[matchIndex];
  if (!match || !match.isTwoLeg) {
    // Single match simulation
    simulateSingleKnockoutMatch(matchIndex);
    return;
  }

  showLoading('Simulating Leg 1...');

  setTimeout(() => {
    // Simulate with home advantage for leg 1 home team
    const result = simulateMatch(
      match.leg1.homeTeam,
      match.leg1.awayTeam,
      'Round ' + match.stage
    );

    // Update leg 1 data
    match.leg1.completed = true;
    match.leg1.scoreA = result.scoreA;
    match.leg1.scoreB = result.scoreB;

    // Update aggregate
    if (match.leg1.homeTeam.name === match.teamA.name) {
      match.aggregate.teamA += result.scoreA;
      match.aggregate.teamB += result.scoreB;
    } else {
      match.aggregate.teamA += result.scoreB;
      match.aggregate.teamB += result.scoreA;
    }

    // Track for history
    if (typeof trackMatchForHistory === 'function') {
      trackMatchForHistory({
        ...result,
        stage: match.stage,
        leg: 1
      });
    }

    // Add to pending leg 2
    if (!KNOCKOUT_STATE.pendingLeg2.includes(matchIndex)) {
      KNOCKOUT_STATE.pendingLeg2.push(matchIndex);
    }

    hideLoading();

    // Show result notification
    if (typeof showNotification === 'function') {
      showNotification('success', 'Leg 1 Complete!',
        `${result.scoreA} - ${result.scoreB}. Awaiting Leg 2`, 3000);
    }

    // Refresh display
    displayKnockoutStage(match.stage);

    // Award manager XP
    if (MANAGER_STATE && MANAGER_STATE.active) {
      awardManagerXP(25, 'Knockout leg 1 completed');
    }
  }, 800);
}

function simulateLeg2(matchIndex) {
  const match = KNOCKOUT_STATE.currentMatches[matchIndex];
  if (!match || !match.isTwoLeg || !match.leg1.completed) {
    if (typeof showNotification === 'function') {
      showNotification('error', 'Cannot Simulate',
        'Leg 1 must be completed first', 2000);
    }
    return;
  }

  showLoading('Simulating Leg 2...');

  setTimeout(() => {
    // Simulate with home advantage for leg 2 home team
    const result = simulateMatch(
      match.leg2.homeTeam,
      match.leg2.awayTeam,
      'Round ' + match.stage
    );

    // Update leg 2 data
    match.leg2.completed = true;
    match.leg2.scoreA = result.scoreA;
    match.leg2.scoreB = result.scoreB;

    // Update aggregate
    if (match.leg2.homeTeam.name === match.teamA.name) {
      match.aggregate.teamA += result.scoreA;
      match.aggregate.teamB += result.scoreB;
    } else {
      match.aggregate.teamA += result.scoreB;
      match.aggregate.teamB += result.scoreA;
    }

    // Determine winner
    if (match.aggregate.teamA > match.aggregate.teamB) {
      match.winner = match.teamA.name;
    } else if (match.aggregate.teamB > match.aggregate.teamA) {
      match.winner = match.teamB.name;
    } else {
      // Aggregate tied - simulate extra time/penalties
      match.winner = simulateTiebreaker(match);
    }

    match.completed = true;

    // Track for history
    if (typeof trackMatchForHistory === 'function') {
      trackMatchForHistory({
        ...result,
        stage: match.stage,
        leg: 2,
        winner: match.winner,
        aggregate: match.aggregate
      });
    }

    // Remove from pending
    KNOCKOUT_STATE.pendingLeg2 = KNOCKOUT_STATE.pendingLeg2.filter(i => i !== matchIndex);

    // Add to completed
    KNOCKOUT_STATE.completedMatches.push(match);

    hideLoading();

    // Show result notification
    if (typeof showNotification === 'function') {
      showNotification('success', 'Tie Complete!',
        `${match.winner} advances! (Agg: ${match.aggregate.teamA}-${match.aggregate.teamB})`, 4000);
    }

    // Refresh display
    displayKnockoutStage(match.stage);

    // Award manager XP
    if (MANAGER_STATE && MANAGER_STATE.active) {
      awardManagerXP(50, 'Knockout tie completed');
    }

    // Check if all matches in stage are complete
    checkStageCompletion(match.stage);
  }, 800);
}

function simulateTiebreaker(match) {
  // Away goals rule (if implemented)
  // For simplicity, we'll use penalty shootout

  const teamAPenalties = Math.floor(Math.random() * 3) + 3; // 3-5 penalties
  const teamBPenalties = Math.floor(Math.random() * 3) + 3;

  if (teamAPenalties !== teamBPenalties) {
    return teamAPenalties > teamBPenalties ? match.teamA.name : match.teamB.name;
  }

  // Sudden death
  return Math.random() > 0.5 ? match.teamA.name : match.teamB.name;
}

function simulateSingleKnockoutMatch(matchIndex) {
  const match = KNOCKOUT_STATE.currentMatches[matchIndex];
  if (!match) return;

  showLoading('Simulating match...');

  setTimeout(() => {
    const result = simulateMatch(
      match.teamA,
      match.teamB,
      'Round ' + match.stage
    );

    // Determine winner (no draws in knockout)
    let winner;
    if (result.scoreA > result.scoreB) {
      winner = match.teamA.name;
    } else if (result.scoreB > result.scoreA) {
      winner = match.teamB.name;
    } else {
      // Extra time/penalties
      winner = Math.random() > 0.5 ? match.teamA.name : match.teamB.name;
    }

    match.scoreA = result.scoreA;
    match.scoreB = result.scoreB;
    match.winner = winner;
    match.completed = true;

    // Track for history
    if (typeof trackMatchForHistory === 'function') {
      trackMatchForHistory({
        ...result,
        stage: match.stage,
        winner: winner
      });
    }

    KNOCKOUT_STATE.completedMatches.push(match);

    hideLoading();

    if (typeof showNotification === 'function') {
      showNotification('success', 'Match Complete!',
        `${winner} advances!`, 3000);
    }

    // Refresh display
    displayKnockoutStage(match.stage);

    // Award manager XP
    if (MANAGER_STATE && MANAGER_STATE.active) {
      awardManagerXP(40, 'Knockout match completed');
    }

    checkStageCompletion(match.stage);
  }, 800);
}

// Silent versions for bulk simulation
function simulateLeg1Silent(matchIndex) {
  const match = KNOCKOUT_STATE.currentMatches[matchIndex];
  const result = simulateMatch(
    match.leg1.homeTeam, match.leg1.awayTeam, 'Round ' + match.stage
  );

  match.leg1.completed = true;
  match.leg1.scoreA = result.scoreA;
  match.leg1.scoreB = result.scoreB;

  if (match.leg1.homeTeam.name === match.teamA.name) {
    match.aggregate.teamA += result.scoreA;
    match.aggregate.teamB += result.scoreB;
  } else {
    match.aggregate.teamA += result.scoreB;
    match.aggregate.teamB += result.scoreA;
  }
}

function simulateLeg2Silent(matchIndex) {
  const match = KNOCKOUT_STATE.currentMatches[matchIndex];
  const result = simulateMatch(
    match.leg2.homeTeam, match.leg2.awayTeam, 'Round ' + match.stage
  );

  match.leg2.completed = true;
  match.leg2.scoreA = result.scoreA;
  match.leg2.scoreB = result.scoreB;

  if (match.leg2.homeTeam.name === match.teamA.name) {
    match.aggregate.teamA += result.scoreA;
    match.aggregate.teamB += result.scoreB;
  } else {
    match.aggregate.teamA += result.scoreB;
    match.aggregate.teamB += result.scoreA;
  }

  if (match.aggregate.teamA > match.aggregate.teamB) {
    match.winner = match.teamA.name;
  } else if (match.aggregate.teamB > match.aggregate.teamA) {
    match.winner = match.teamB.name;
  } else {
    match.winner = simulateTiebreaker(match);
  }

  match.completed = true;
  KNOCKOUT_STATE.completedMatches.push(match);
}

function simulateSingleKnockoutMatchSilent(matchIndex) {
  const match = KNOCKOUT_STATE.currentMatches[matchIndex];
  const result = simulateMatch(
    match.teamA, match.teamB, 'Round ' + match.stage
  );

  let winner;
  if (result.scoreA > result.scoreB) {
    winner = match.teamA.name;
  } else if (result.scoreB > result.scoreA) {
    winner = match.teamB.name;
  } else {
    winner = Math.random() > 0.5 ? match.teamA.name : match.teamB.name;
  }

  match.scoreA = result.scoreA;
  match.scoreB = result.scoreB;
  match.winner = winner;
  match.completed = true;

  KNOCKOUT_STATE.completedMatches.push(match);
}

// Check if stage is complete
function checkStageCompletion(stage) {
  // Get all matches for this stage
  const stageMatches = KNOCKOUT_STATE.currentMatches.filter(m =>
    normalizeStageNames(m.stage) === normalizeStageNames(stage)
  );

  // Check if all completed
  const allComplete = stageMatches.every(m => m.completed);

  if (allComplete) {
    if (window.VERBOSE_LOGGING) console.log(`✓ All matches in ${stage} complete`);
    if (typeof markStageComplete === 'function') {
      markStageComplete(stage);
    }

    // Show completion notification
    if (typeof showNotification === 'function') {
      showNotification('success', 'Stage Complete!',
        `All ${STAGE_DISPLAY_NAMES[normalizeStageNames(stage)]} matches finished`, 3000);
    }

    // Check if we should auto-advance
    setTimeout(() => {
      const nextStage = getNextStage(normalizeStageNames(stage));
      if (nextStage && nextStage !== 'completed') {
        showStageCompleteModal(stage, nextStage);
      } else {
        // Tournament complete
        const winners = stageMatches.map(m => m.winner).filter(Boolean);
        if (winners.length === 1) {
          window.TOURNAMENT_CHAMPION = winners[0];
          if (typeof displayTournamentComplete === 'function') {
            displayTournamentComplete();
          }
        }
      }
    }, 1500);
  }
}

function getNextStage(currentStage) {
  const stageOrder = ['roundOf16', 'quarterFinals', 'semiFinals', 'final'];
  const currentIndex = stageOrder.indexOf(currentStage);
  if (currentIndex >= 0 && currentIndex < stageOrder.length - 1) {
    return stageOrder[currentIndex + 1];
  }
  return 'completed';
}

function showStageCompleteModal(currentStage, nextStage) {
  const modal = document.createElement('div');
  modal.className = 'modal-backdrop active';
  modal.style.zIndex = '10006';
  modal.innerHTML = `
    <div class="modal-content" style="max-width: 600px; text-align: center;">
      <div style="padding: 40px;">
        <div style="font-size: 5em; margin-bottom: 20px;">✅</div>
        <h2 style="color: #10b981; font-size: 2em; margin-bottom: 15px;">
          ${STAGE_DISPLAY_NAMES[normalizeStageNames(currentStage)]} Complete!
        </h2>
        <p style="color: #94a3b8; font-size: 1.1em; margin-bottom: 30px;">
          All matches have been played. Ready to advance to the next stage?
        </p>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
          <button onclick="this.closest('.modal-backdrop').remove()"
                  class="btn-secondary" style="padding: 14px; font-weight: 600;">
            Stay Here
          </button>
          <button onclick="this.closest('.modal-backdrop').remove(); advanceToNextStage('${normalizeStageNames(currentStage)}')"
                  class="btn-primary" style="padding: 14px; font-weight: 600;">
            Continue to ${STAGE_DISPLAY_NAMES[nextStage]} →
          </button>
        </div>
      </div>
    </div>
  `;

  document.body.appendChild(modal);
}

function advanceToNextStage(currentStage) {
  const nextStage = getNextStage(currentStage);
  if (nextStage && nextStage !== 'completed') {
    // Get winners from current stage
    const winners = KNOCKOUT_STATE.currentMatches
      .filter(m => normalizeStageNames(m.stage) === currentStage && m.winner)
      .map(m => {
        const winnerName = m.winner;
        return m.teamA.name === winnerName ? m.teamA : m.teamB;
      });

    // Initialize next stage
    initializeKnockoutStage(winners, nextStage, true);
    displayKnockoutStage(nextStage);
  }
}

/************* TOURNAMENT PRESETS *************/

const TOURNAMENT_PRESETS = {
  'classic-champions': {
    id: 'classic-champions',
    name: '🏆 Classic Champions',
    description: 'Legendary teams from football history',
    icon: '🏆',
    teamFilter: (team) => team.season < 2010,
    difficulty: 'normal',
    settings: {
      upsetFactor: 1.0,
      goalEnvironment: 1.2
    }
  },

  'modern-era': {
    id: 'modern-era',
    name: '⚡ Modern Era',
    description: 'Best teams from 2010-2020',
    icon: '⚡',
    teamFilter: (team) => team.season >= 2010,
    difficulty: 'hard',
    settings: {
      upsetFactor: 0.8,
      goalEnvironment: 1.4
    }
  },

  'underdogs-only': {
    id: 'underdogs-only',
    name: '🎲 Underdog Special',
    description: 'Lower-rated teams only (< 88)',
    icon: '🎲',
    teamFilter: (team) => team.strength < 88,
    difficulty: 'hard',
    settings: {
      upsetFactor: 1.5,
      goalEnvironment: 1.3
    }
  },

  'super-elite': {
    id: 'super-elite',
    name: '👑 Super Elite',
    description: 'Only the absolute best (95+)',
    icon: '👑',
    teamFilter: (team) => team.strength >= 95,
    difficulty: 'legendary',
    settings: {
      upsetFactor: 1.0,
      goalEnvironment: 1.5
    }
  },

  'random-chaos': {
    id: 'random-chaos',
    name: '🌪️ Random Chaos',
    description: 'Completely random teams, max chaos',
    icon: '🌪️',
    teamFilter: null,
    difficulty: 'legendary',
    settings: {
      upsetFactor: 2.0,
      goalEnvironment: 1.8
    }
  }
};

function showTournamentPresets() {
  const out = document.getElementById('output');
  if (!out) return;

  out.innerHTML = `
    <div class="presets-view">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
        <h2 style="margin: 0; color: #e5e7eb;">🎯 Quick Start Tournament</h2>
        <button onclick="showTournamentOverview()" class="btn-secondary" style="padding: 8px 16px; background: rgba(71, 85, 105, 0.3); border: none; border-radius: 8px; color: #e5e7eb; cursor: pointer;">
          ← Back
        </button>
      </div>

      <p style="color: #94a3b8; margin-bottom: 25px;">
        Choose a preset to instantly start a tournament with pre-configured teams and settings
      </p>

      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
        ${Object.values(TOURNAMENT_PRESETS).map(preset => `
          <div class="preset-card" onclick="loadTournamentPreset('${preset.id}')" style="background: linear-gradient(135deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.8)); padding: 25px; border-radius: 12px; border: 1px solid rgba(71, 85, 105, 0.3); cursor: pointer; transition: all 0.3s ease; text-align: center;">
            <div style="font-size: 3em; margin-bottom: 10px;">${preset.icon}</div>
            <h3 style="color: #e5e7eb; margin: 0 0 10px 0;">${preset.name}</h3>
            <p style="color: #94a3b8; font-size: 0.9em; margin: 0 0 15px 0;">
              ${preset.description}
            </p>
            <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 15px; border-top: 1px solid rgba(148, 163, 184, 0.2);">
              <span style="font-size: 0.85em; color: #64748b;">
                Difficulty: ${getDifficultyName(preset.difficulty)}
              </span>
              <button class="btn-primary" style="padding: 6px 16px; background: #3b82f6; border: none; border-radius: 8px; color: white; cursor: pointer; pointer-events: none;">
                Load →
              </button>
            </div>
          </div>
        `).join('')}
      </div>

      <div style="margin-top: 30px; padding: 20px; background: rgba(59, 130, 246, 0.1); border-radius: 12px; border: 1px solid #3b82f6;">
        <h3 style="color: #3b82f6; margin: 0 0 10px 0;">⚙️ Custom Tournament</h3>
        <p style="color: #94a3b8; margin: 0 0 15px 0;">
          Create your own tournament with custom settings
        </p>
        <button onclick="showTournamentOverview()" class="btn-secondary" style="padding: 8px 16px; background: rgba(71, 85, 105, 0.3); border: none; border-radius: 8px; color: #e5e7eb; cursor: pointer;">
          Build Custom Tournament
        </button>
      </div>
    </div>
  `;
}

function loadTournamentPreset(presetId) {
  const preset = TOURNAMENT_PRESETS[presetId];
  if (!preset) {
    showUtilityMessage('❌ Preset not found', 'error');
    return;
  }

  showUtilityMessage(`⏳ Loading ${preset.name}...`, 'info');

  // Filter teams
  let selectedTeams = window.TEAM_POOL || [];
  if (preset.teamFilter) {
    selectedTeams = selectedTeams.filter(preset.teamFilter);
  }

  if (selectedTeams.length < 32) {
    showUtilityMessage(`❌ Not enough teams (found ${selectedTeams.length}, need 32)`, 'error');
    return;
  }

  // Shuffle and select 32 teams
  selectedTeams = shuffleArray(selectedTeams).slice(0, 32);

  // Apply settings
  if (typeof setDifficulty === 'function') {
    setDifficulty(preset.difficulty);
  }
  if (window.RNG_SETTINGS) {
    window.RNG_SETTINGS.groupChaos = preset.settings.upsetFactor;
  }

  // Draw groups
  window.DRAWN_TEAMS = selectedTeams;
  if (typeof generateGroups === 'function') {
    generateGroups();
  }

  showUtilityMessage(`✅ ${preset.name} loaded! ${selectedTeams.length} teams ready`, 'success');

  // Switch to tournament tab
  if (typeof switchTab === 'function') {
    switchTab('tournament');
  }

  // Show groups
  setTimeout(() => {
    if (typeof showTournamentOverview === 'function') {
      showTournamentOverview();
    }
  }, 500);
}

function getDifficultyName(difficultyId) {
  const names = {
    easy: '⭐ Easy',
    normal: '⭐⭐ Normal',
    hard: '⭐⭐⭐ Hard',
    legendary: '⭐⭐⭐⭐ Legend'
  };
  return names[difficultyId] || 'Unknown';
}

/************* ADVANCED STATISTICS DASHBOARD *************/

function showAdvancedStatsDashboard() {
  const out = document.getElementById('output');
  if (!out) return;

  const matches = getAllMatchesForStats();
  if (matches.length === 0) {
    out.innerHTML = `
      <div class="empty-state" style="text-align: center; padding: 60px 20px;">
        <div style="font-size: 4em; margin-bottom: 20px;">📊</div>
        <h2 style="color: #e5e7eb; margin-bottom: 10px;">No Tournament Data</h2>
        <p style="color: #94a3b8;">Complete a tournament to see advanced analytics</p>
      </div>
    `;
    return;
  }

  out.innerHTML = `
    <div class="stats-dashboard">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
        <h2 style="margin: 0; color: #e5e7eb;">📊 Advanced Analytics Dashboard</h2>
        <div style="display: flex; gap: 10px;">
          <button onclick="exportStatsAsCSV()" class="btn-secondary" style="padding: 8px 16px; background: rgba(71, 85, 105, 0.3); border: none; border-radius: 8px; color: #e5e7eb; cursor: pointer;">
            📥 Export CSV
          </button>
          <button onclick="showAdvancedStatsDashboard()" class="btn-primary" style="padding: 8px 16px; background: #3b82f6; border: none; border-radius: 8px; color: white; cursor: pointer;">
            🔄 Refresh
          </button>
        </div>
      </div>

      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
        ${renderKeyMetricsCards(matches)}
      </div>

      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 20px; margin-bottom: 30px;">
        <div style="background: rgba(30, 41, 59, 0.5); padding: 20px; border-radius: 12px; border: 1px solid rgba(71, 85, 105, 0.3);">
          <h3 style="margin: 0 0 15px 0; color: #94a3b8; font-size: 1.1em;">⚽ Goals by Round</h3>
          <canvas id="goalsTimelineChart"></canvas>
        </div>

        <div style="background: rgba(30, 41, 59, 0.5); padding: 20px; border-radius: 12px; border: 1px solid rgba(71, 85, 105, 0.3);">
          <h3 style="margin: 0 0 15px 0; color: #94a3b8; font-size: 1.1em;">📊 Team Performance</h3>
          <canvas id="teamPerformanceChart"></canvas>
        </div>

        <div style="background: rgba(30, 41, 59, 0.5); padding: 20px; border-radius: 12px; border: 1px solid rgba(71, 85, 105, 0.3);">
          <h3 style="margin: 0 0 15px 0; color: #94a3b8; font-size: 1.1em;">🎯 Goals by Position</h3>
          <canvas id="positionGoalsChart"></canvas>
        </div>

        <div style="background: rgba(30, 41, 59, 0.5); padding: 20px; border-radius: 12px; border: 1px solid rgba(71, 85, 105, 0.3);">
          <h3 style="margin: 0 0 15px 0; color: #94a3b8; font-size: 1.1em;">⏰ Goals by Minute</h3>
          <canvas id="goalTimingChart"></canvas>
        </div>
      </div>

      <div style="background: rgba(30, 41, 59, 0.3); padding: 25px; border-radius: 12px; border: 1px solid rgba(71, 85, 105, 0.3); margin-top: 30px;">
        <h3 style="margin: 0 0 15px 0; color: #e5e7eb;">🎯 Player Consistency Rankings</h3>
        <div id="consistencyTable"></div>
      </div>
    </div>
  `;

  setTimeout(() => {
    renderGoalsTimelineChart(matches);
    renderTeamPerformanceChart(matches);
    renderPositionGoalsChart();
    renderGoalTimingChart(matches);
    renderConsistencyTable();
  }, 100);
}

function getAllMatchesForStats() {
  const matches = [];

  if (window.GROUP_RESULTS) {
    Object.values(window.GROUP_RESULTS).forEach(group => {
      if (group.matches) matches.push(...group.matches);
    });
  }

  if (window.TOURNAMENT && window.TOURNAMENT.allKnockoutMatches) {
    matches.push(...window.TOURNAMENT.allKnockoutMatches);
  }

  return matches;
}

function renderKeyMetricsCards(matches) {
  const totalGoals = matches.reduce((sum, m) => sum + ((m.scoreA || 0) + (m.scoreB || 0)), 0);
  const avgGoals = matches.length > 0 ? (totalGoals / matches.length).toFixed(2) : '0.00';
  const cleanSheets = matches.filter(m => m.scoreA === 0 || m.scoreB === 0).length;
  const highScoring = matches.filter(m => ((m.scoreA || 0) + (m.scoreB || 0)) >= 5).length;

  return `
    <div style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; padding: 20px; border-radius: 12px; text-align: center;">
      <div style="font-size: 2.5em; font-weight: bold; margin-bottom: 5px;">${totalGoals}</div>
      <div style="font-size: 0.9em; opacity: 0.9;">Total Goals</div>
      <div style="font-size: 0.75em; opacity: 0.7; margin-top: 5px;">${avgGoals} per match</div>
    </div>

    <div style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 20px; border-radius: 12px; text-align: center;">
      <div style="font-size: 2.5em; font-weight: bold; margin-bottom: 5px;">${cleanSheets}</div>
      <div style="font-size: 0.9em; opacity: 0.9;">Clean Sheets</div>
      <div style="font-size: 0.75em; opacity: 0.7; margin-top: 5px;">${((cleanSheets/(matches.length||1))*100).toFixed(1)}% of matches</div>
    </div>

    <div style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 20px; border-radius: 12px; text-align: center;">
      <div style="font-size: 2.5em; font-weight: bold; margin-bottom: 5px;">${highScoring}</div>
      <div style="font-size: 0.9em; opacity: 0.9;">High-Scoring (5+)</div>
      <div style="font-size: 0.75em; opacity: 0.7; margin-top: 5px;">${((highScoring/(matches.length||1))*100).toFixed(1)}% of matches</div>
    </div>

    <div style="background: linear-gradient(135deg, #a855f7, #9333ea); color: white; padding: 20px; border-radius: 12px; text-align: center;">
      <div style="font-size: 2.5em; font-weight: bold; margin-bottom: 5px;">${matches.length}</div>
      <div style="font-size: 0.9em; opacity: 0.9;">Total Matches</div>
      <div style="font-size: 0.75em; opacity: 0.7; margin-top: 5px;">Tournament progress</div>
    </div>
  `;
}

function renderGoalsTimelineChart(matches) {
  const ctx = document.getElementById('goalsTimelineChart');
  if (!ctx) return;

  // Check if Chart.js is loaded
  if (typeof Chart === 'undefined') {
    console.warn('Chart.js not loaded - skipping chart render');
    ctx.innerHTML = '<p style="text-align: center; color: #94a3b8; padding: 20px;">Chart.js library required for visualization</p>';
    return;
  }

  const rounds = {};
  matches.forEach(m => {
    const round = m.round || 'Group';
    if (!rounds[round]) rounds[round] = 0;
    rounds[round] += (m.scoreA || 0) + (m.scoreB || 0);
  });

  try {
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: Object.keys(rounds),
        datasets: [{
          label: 'Goals per Round',
          data: Object.values(rounds),
          borderColor: '#10b981',
          backgroundColor: 'rgba(16, 185, 129, 0.1)',
          borderWidth: 3,
          fill: true,
          tension: 0.4
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          y: { beginAtZero: true, ticks: { color: '#94a3b8' }, grid: { color: 'rgba(148, 163, 184, 0.1)' } },
          x: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(148, 163, 184, 0.1)' } }
        }
      }
    });
  } catch (error) {
    console.error('Failed to render chart:', error);
    ctx.innerHTML = '<p style="text-align: center; color: #ef4444; padding: 20px;">Failed to render chart</p>';
  }
}

function renderTeamPerformanceChart(matches) {
  const ctx = document.getElementById('teamPerformanceChart');
  if (!ctx) return;

  if (typeof Chart === 'undefined') {
    console.warn('Chart.js not loaded - skipping chart render');
    ctx.innerHTML = '<p style="text-align: center; color: #94a3b8; padding: 20px;">Chart.js library required for visualization</p>';
    return;
  }

  const teams = {};
  matches.forEach(m => {
    if (!teams[m.teamA]) teams[m.teamA] = { strength: m.teamAObj?.strength || 80, goals: 0 };
    if (!teams[m.teamB]) teams[m.teamB] = { strength: m.teamBObj?.strength || 80, goals: 0 };
    teams[m.teamA].goals += m.scoreA || 0;
    teams[m.teamB].goals += m.scoreB || 0;
  });

  const points = Object.entries(teams).map(([team, data]) => ({ x: data.strength, y: data.goals, team }));

  try {
    new Chart(ctx, {
    type: 'scatter',
    data: {
      datasets: [{
        label: 'Teams',
        data: points,
        backgroundColor: '#3b82f6',
        pointRadius: 6
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: (context) => `${points[context.dataIndex].team}: ${context.parsed.y} goals`
          }
        }
      },
      scales: {
        y: { title: { display: true, text: 'Goals Scored', color: '#94a3b8' }, ticks: { color: '#94a3b8' } },
        x: { title: { display: true, text: 'Team Strength', color: '#94a3b8' }, ticks: { color: '#94a3b8' } }
      }
    }
  });
  } catch (error) {
    console.error('Failed to render chart:', error);
    ctx.innerHTML = '<p style="text-align: center; color: #ef4444; padding: 20px;">Failed to render chart</p>';
  }
}

function renderPositionGoalsChart() {
  const ctx = document.getElementById('positionGoalsChart');
  if (!ctx) return;

  if (typeof Chart === 'undefined') {
    console.warn('Chart.js not loaded - skipping chart render');
    ctx.innerHTML = '<p style="text-align: center; color: #94a3b8; padding: 20px;">Chart.js library required for visualization</p>';
    return;
  }

  const positions = { FW: 0, MF: 0, DF: 0, Other: 0 };
  Object.values(PLAYER_DB).forEach(player => {
    const pos = player.pos || 'Other';
    if (pos.includes('F') || pos === 'ST') positions.FW += player.goals || 0;
    else if (pos.includes('M') || pos === 'AM' || pos === 'DM') positions.MF += player.goals || 0;
    else if (pos.includes('B') || pos === 'CB') positions.DF += player.goals || 0;
    else positions.Other += player.goals || 0;
  });

  try {
    new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['Forwards', 'Midfielders', 'Defenders', 'Others'],
        datasets: [{
          data: [positions.FW, positions.MF, positions.DF, positions.Other],
          backgroundColor: ['#ef4444', '#f59e0b', '#10b981', '#3b82f6'],
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'bottom', labels: { color: '#94a3b8' } }
        }
      }
    });
  } catch (error) {
    console.error('Failed to render chart:', error);
    ctx.innerHTML = '<p style="text-align: center; color: #ef4444; padding: 20px;">Failed to render chart</p>';
  }
}

function renderGoalTimingChart(matches) {
  const ctx = document.getElementById('goalTimingChart');
  if (!ctx) return;

  if (typeof Chart === 'undefined') {
    console.warn('Chart.js not loaded - skipping chart render');
    ctx.innerHTML = '<p style="text-align: center; color: #94a3b8; padding: 20px;">Chart.js library required for visualization</p>';
    return;
  }

  const bins = { '0-15': 0, '16-30': 0, '31-45': 0, '46-60': 0, '61-75': 0, '76-90': 0 };
  matches.forEach(match => {
    if (match.events && match.events.goals) {
      match.events.goals.forEach(goal => {
        const min = goal.minute || 0;
        if (min <= 15) bins['0-15']++;
        else if (min <= 30) bins['16-30']++;
        else if (min <= 45) bins['31-45']++;
        else if (min <= 60) bins['46-60']++;
        else if (min <= 75) bins['61-75']++;
        else bins['76-90']++;
      });
    }
  });

  try {
    new Chart(ctx, {
    type: 'bar',
    data: {
      labels: Object.keys(bins),
      datasets: [{
        label: 'Goals',
        data: Object.values(bins),
        backgroundColor: '#a855f7'
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: {
        y: { beginAtZero: true, ticks: { color: '#94a3b8' } },
        x: { ticks: { color: '#94a3b8' } }
      }
    }
  });
  } catch (error) {
    console.error('Failed to render chart:', error);
    ctx.innerHTML = '<p style="text-align: center; color: #ef4444; padding: 20px;">Failed to render chart</p>';
  }
}

function renderConsistencyTable() {
  const container = document.getElementById('consistencyTable');
  if (!container) return;

  const players = Object.values(PLAYER_DB)
    .filter(p => p.apps >= 3)
    .map(p => ({
      name: p.name,
      team: p.team,
      avgRating: p.avgRating || 6.5,
      apps: p.apps
    }))
    .sort((a, b) => b.avgRating - a.avgRating)
    .slice(0, 10);

  let html = `
    <p style="color: #94a3b8; font-size: 0.9em; margin-bottom: 15px;">
      Top consistent performers (minimum 3 appearances)
    </p>
    <table style="width: 100%; border-collapse: collapse;">
      <thead>
        <tr style="background: rgba(16, 185, 129, 0.1); border-bottom: 2px solid #10b981;">
          <th style="padding: 12px; text-align: center;">#</th>
          <th style="padding: 12px; text-align: left;">Player</th>
          <th style="padding: 12px; text-align: center;">Avg Rating</th>
          <th style="padding: 12px; text-align: center;">Apps</th>
        </tr>
      </thead>
      <tbody>
  `;

  players.forEach((p, i) => {
    html += `
      <tr style="border-bottom: 1px solid rgba(148, 163, 184, 0.1);">
        <td style="padding: 12px; text-align: center; color: #fbbf24; font-weight: bold;">${i + 1}</td>
        <td style="padding: 12px;">
          <div style="font-weight: 600; color: #e5e7eb;">${p.name}</div>
          <div style="font-size: 0.85em; color: #94a3b8;">${p.team}</div>
        </td>
        <td style="padding: 12px; text-align: center; color: #3b82f6; font-weight: 600;">
          ${p.avgRating.toFixed(1)}
        </td>
        <td style="padding: 12px; text-align: center; color: #94a3b8;">
          ${p.apps}
        </td>
      </tr>
    `;
  });

  html += '</tbody></table>';
  container.innerHTML = html;
}

function exportStatsAsCSV() {
  const matches = getAllMatchesForStats();
  const csv = matches.map(m =>
    `${m.round || 'Group'},${m.teamA},${m.teamB},${m.scoreA || 0},${m.scoreB || 0},${(m.scoreA || 0) + (m.scoreB || 0)}`
  ).join('\n');

  const fullCSV = 'Round,Team A,Team B,Score A,Score B,Total Goals\n' + csv;
  const blob = new Blob([fullCSV], { type: 'text/csv' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'tournament-stats.csv';
  a.click();
  window.URL.revokeObjectURL(url);

  showUtilityMessage('✅ Stats exported successfully!', 'success');
}

// Save manager profile to localStorage
function saveManagerProfile() {
  try {
    localStorage.setItem('managerProfile', JSON.stringify(MANAGER_PROFILE));
    updateManagerProfileUI();
    console.log('✅ Manager profile saved');
  } catch (e) {
    console.error('❌ Failed to save manager profile:', e);
  }
}

// Update manager profile UI
function updateManagerProfileUI() {
  // Update sidebar card
  const nameEl = document.getElementById('managerName');
  const levelEl = document.getElementById('managerLevel');
  const xpEl = document.getElementById('managerXP');
  const xpFillEl = document.getElementById('managerXPFill');
  const tournamentsEl = document.getElementById('managerTournaments');
  const winRateEl = document.getElementById('managerWinRate');
  const goalsEl = document.getElementById('managerGoals');

  if (nameEl) nameEl.textContent = MANAGER_PROFILE.name;
  if (levelEl) levelEl.textContent = `Level ${MANAGER_PROFILE.level}`;
  if (xpEl) xpEl.textContent = `${MANAGER_PROFILE.xp} / ${MANAGER_PROFILE.xpToNextLevel} XP`;

  if (xpFillEl) {
    const xpPercent = (MANAGER_PROFILE.xp / MANAGER_PROFILE.xpToNextLevel) * 100;
    xpFillEl.style.width = `${xpPercent}%`;
  }

  if (tournamentsEl) tournamentsEl.textContent = MANAGER_PROFILE.tournamentsPlayed;
  if (winRateEl) winRateEl.textContent = `${MANAGER_PROFILE.winRate}%`;
  if (goalsEl) goalsEl.textContent = MANAGER_PROFILE.totalGoals;

  // Update profile tab if it exists
  const profileTournamentsWon = document.getElementById('profileTournamentsWon');
  const profileTournamentsPlayed = document.getElementById('profileTournamentsPlayed');
  const profileTotalGoals = document.getElementById('profileTotalGoals');
  const profileAvgGoals = document.getElementById('profileAvgGoals');

  if (profileTournamentsWon) profileTournamentsWon.textContent = MANAGER_PROFILE.tournamentsWon;
  if (profileTournamentsPlayed) profileTournamentsPlayed.textContent = MANAGER_PROFILE.tournamentsPlayed;
  if (profileTotalGoals) profileTotalGoals.textContent = MANAGER_PROFILE.totalGoals;
  if (profileAvgGoals) profileAvgGoals.textContent = MANAGER_PROFILE.avgGoalsPerMatch || '0.0';

  // Update tracked team display
  const trackedTeamDisplay = document.getElementById('trackedTeamDisplay');
  if (trackedTeamDisplay) {
    const trackedTeam = getTrackedTeamName();
    trackedTeamDisplay.textContent = trackedTeam || 'No team selected';
  }

  // Update best tournament
  updateBestTournamentDisplay();

  // Update achievements
  updateAchievementsDisplay();
}

// Update best tournament display
function updateBestTournamentDisplay() {
  const container = document.getElementById('profileBestTournament');
  if (!container) return;

  if (!MANAGER_PROFILE.bestTournament) {
    container.innerHTML = `
      <div class="profile-empty-state">
        <div class="profile-empty-icon">🏟️</div>
        <div class="profile-empty-text">Complete your first tournament!</div>
      </div>
    `;
    return;
  }

  const best = MANAGER_PROFILE.bestTournament;
  const date = new Date(best.date).toLocaleDateString();

  container.innerHTML = `
    <div style="padding: 8px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
        <div style="font-size: 1.1rem; font-weight: 700; color: var(--color-primary);">
          🏆 ${best.champion}
        </div>
        <div style="font-size: 0.7rem; color: var(--text-muted);">${date}</div>
      </div>
      <div style="display: flex; gap: 16px; margin-top: 12px;">
        <div>
          <div style="font-size: 1.5rem; font-weight: 700; color: #10b981;">${best.goals}</div>
          <div style="font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase;">Total Goals</div>
        </div>
        <div style="flex: 1;">
          <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 4px;">Top Scorer</div>
          <div style="font-size: 0.8rem; font-weight: 600; color: var(--text-primary);">⚽ ${best.topScorer}</div>
        </div>
      </div>
    </div>
  `;
}

// Update achievements display
function updateAchievementsDisplay() {
  const container = document.getElementById('profileAchievements');
  if (!container) return;

  const achievementsHTML = Object.values(ACHIEVEMENTS).slice(0, 8).map(achievement => {
    const isUnlocked = window.ACHIEVEMENTS_DATA.unlocked[achievement.id];
    const lockedClass = isUnlocked ? '' : 'locked';
    const rarity = achievement.rarity || 'common';
    const points = achievement.points || 0;

    let progressHTML = '';
    if (achievement.requiresProgress && !isUnlocked) {
      const currentProgress = window.ACHIEVEMENTS_DATA.stats[achievement.id.replace(/V?\d*$/, '')] || 0;
      const maxProgress = achievement.maxProgress || 1;
      const progressPercent = Math.min((currentProgress / maxProgress) * 100, 100);

      progressHTML = `
        <div class="profile-achievement-progress">
          <div class="profile-achievement-progress-bar">
            <div class="profile-achievement-progress-fill" style="width: ${progressPercent}%"></div>
          </div>
          <div class="profile-achievement-progress-text">${currentProgress}/${maxProgress}</div>
        </div>
      `;
    }

    return `
      <div class="profile-achievement-card ${lockedClass}">
        <div class="profile-achievement-icon">${achievement.icon}</div>
        <div class="profile-achievement-info">
          <div class="profile-achievement-name">${achievement.name}</div>
          <div class="profile-achievement-desc">${achievement.description}</div>
          ${progressHTML}
        </div>
        <div class="profile-achievement-badge ${rarity}">${rarity}</div>
      </div>
    `;
  }).join('');

  container.innerHTML = achievementsHTML || `
    <div class="profile-empty-state">
      <div class="profile-empty-icon">🏅</div>
      <div class="profile-empty-text">Start unlocking achievements!</div>
    </div>
  `;
}

// Award XP to manager
// Removed duplicate: function awardManagerXP - see later definition

// Update manager stats after tournament
function updateManagerStats(tournamentData) {
  const tracked = getTrackedTeamName();
  if (!tracked) return; // Nothing tracked, nothing earned

  // Only count tournament if tracked team participated
  const trackedMatches = (tournamentData.matches || []).filter(matchInvolvesTrackedTeam);
  if (trackedMatches.length === 0) return;

  MANAGER_PROFILE.tournamentsPlayed++;

  // Only a "win" if tracked team is champion
  if (tournamentData.champion && tournamentData.champion.name === tracked) {
    MANAGER_PROFILE.tournamentsWon++;
    awardManagerXP(200, "Your team won the tournament!");
  }

  // Count goals and matches for tracked team only
  const totalGoals = trackedMatches.reduce((sum, m) =>
    sum + (m.scoreA || 0) + (m.scoreB || 0), 0);

  MANAGER_PROFILE.totalMatches += trackedMatches.length;
  MANAGER_PROFILE.totalGoals += totalGoals;

  // Award XP for participation
  awardManagerXP(100, "Tournament completed (tracked team)");
  awardManagerXP(trackedMatches.length * 5, `${trackedMatches.length} tracked matches`);

  // Calculate stats
  if (MANAGER_PROFILE.totalMatches > 0) {
    MANAGER_PROFILE.avgGoalsPerMatch = (MANAGER_PROFILE.totalGoals / MANAGER_PROFILE.totalMatches).toFixed(2);
  }

  if (MANAGER_PROFILE.tournamentsPlayed > 0) {
    MANAGER_PROFILE.winRate = ((MANAGER_PROFILE.tournamentsWon / MANAGER_PROFILE.tournamentsPlayed) * 100).toFixed(1);
  }

  // Update best tournament
  if (tournamentData.champion && tournamentData.matches) {
    const tournamentGoals = tournamentData.matches.reduce((sum, m) =>
      sum + (m.scoreA || 0) + (m.scoreB || 0), 0);

    if (!MANAGER_PROFILE.bestTournament || tournamentGoals > MANAGER_PROFILE.bestTournament.goals) {
      MANAGER_PROFILE.bestTournament = {
        date: new Date().toISOString(),
        champion: tournamentData.champion.name,
        goals: tournamentGoals,
        topScorer: tournamentData.topScorer ? `${tournamentData.topScorer.name} (${tournamentData.topScorer.goals} goals)` : 'Unknown'
      };
    }
  }

  // Award XP for completing tournament
  awardManagerXP(100, 'Tournament completed');

  // Award XP for winning
  if (tournamentData.champion) {
    awardManagerXP(200, 'Tournament champion!');
  }

  // Award XP for goals
  if (tournamentData.matches) {
    const matchesPlayed = tournamentData.matches.length;
    awardManagerXP(matchesPlayed * 5, `${matchesPlayed} matches played`);
  }

  saveManagerProfile();
}

/************* DIFFICULTY MODES *************/

// Difficulty mode definitions
const DIFFICULTY_MODES = {
  easy: {
    id: 'easy',
    name: '⭐ Beginner',
    description: 'Perfect for first-time players',
    upsetFactor: 0.5,        // Lower-rated teams less likely to win
    injuryRate: 0,           // No injuries
    xpMultiplier: 0.8,       // Less XP earned
    icon: '⭐',
    color: '#10b981'
  },
  normal: {
    id: 'normal',
    name: '⭐⭐ Normal',
    description: 'Balanced experience',
    upsetFactor: 1.0,
    injuryRate: 0.05,
    xpMultiplier: 1.0,
    icon: '⭐⭐',
    color: '#3b82f6'
  },
  hard: {
    id: 'hard',
    name: '⭐⭐⭐ Expert',
    description: 'For experienced managers',
    upsetFactor: 1.5,        // More upsets
    injuryRate: 0.1,
    xpMultiplier: 1.5,       // More XP earned
    icon: '⭐⭐⭐',
    color: '#a855f7'
  },
  legendary: {
    id: 'legendary',
    name: '⭐⭐⭐⭐ Legendary',
    description: 'Ultimate challenge - are you ready?',
    upsetFactor: 2.0,
    injuryRate: 0.15,
    xpMultiplier: 2.0,       // Double XP
    adaptiveAI: true,        // AI learns from patterns
    icon: '⭐⭐⭐⭐',
    color: '#fbbf24'
  }
};

// Current difficulty setting
window.CURRENT_DIFFICULTY = window.CURRENT_DIFFICULTY || 'normal';

// Load difficulty from localStorage
try {
  const savedDifficulty = localStorage.getItem('currentDifficulty');
  if (savedDifficulty && DIFFICULTY_MODES[savedDifficulty]) {
    window.CURRENT_DIFFICULTY = savedDifficulty;
  }
} catch (e) {
  console.warn('Could not load difficulty setting:', e);
}

// Set difficulty mode
function setDifficulty(difficultyId) {
  if (!DIFFICULTY_MODES[difficultyId]) {
    console.error(`Invalid difficulty: ${difficultyId}`);
    return;
  }

  window.CURRENT_DIFFICULTY = difficultyId;

  try {
    localStorage.setItem('currentDifficulty', difficultyId);
  } catch (e) {
    console.error('Failed to save difficulty:', e);
  }

  const difficulty = DIFFICULTY_MODES[difficultyId];
  if (window.VERBOSE_LOGGING) console.log(`🎯 Difficulty set to: ${difficulty.name}`);

  // Update RNG settings based on difficulty
  RNG_SETTINGS.groupChaos = difficulty.upsetFactor;
  RNG_SETTINGS.knockoutChaos = difficulty.upsetFactor * 1.1;

  // Update UI
  const buttons = document.querySelectorAll('[data-difficulty]');
  buttons.forEach(btn => {
    if (btn.getAttribute('data-difficulty') === difficultyId) {
      btn.classList.add('active');
    } else {
      btn.classList.remove('active');
    }
  });

  // Update description
  const descEl = document.getElementById('difficultyDescription');
  if (descEl) {
    descEl.textContent = difficulty.description;
    descEl.style.color = difficulty.color;
  }

  if (typeof showNotification === 'function') {
    showNotification('info',
      `Difficulty Changed`,
      `${difficulty.icon} ${difficulty.name}: ${difficulty.description}`,
      3000);
  }
}

// Get current difficulty
function getCurrentDifficulty() {
  return DIFFICULTY_MODES[window.CURRENT_DIFFICULTY] || DIFFICULTY_MODES.normal;
}

const RNG_SETTINGS = (window.RNG_SETTINGS = window.RNG_SETTINGS || {
  groupChaos: 1.0,
  knockoutChaos: 1.1
});

// Simulation speed settings (milliseconds)
const SIM_SPEED_SETTINGS = (window.SIM_SPEED_SETTINGS = window.SIM_SPEED_SETTINGS || {
  current: 1,
  speeds: {
    0: 0,      // Instant
    1: 50,     // Fast
    2: 200,    // Normal
    3: 500     // Slow
  }
});

// Global tournament state
window.GROUPS = window.GROUPS || null;
window.GROUP_RESULTS = window.GROUP_RESULTS || null;
window.TOURNAMENT = window.TOURNAMENT || null;
window.CURRENT_TOURNAMENT_ID = window.CURRENT_TOURNAMENT_ID || null;

// Async locks to prevent duplicate simulations
let isGroupStageRunning = false;
let isKnockoutRunning = false;
let isGeneratingGroups = false;
let isQuickRunning = false;

// New feature state
const HEAD_TO_HEAD_RECORDS = (window.HEAD_TO_HEAD_RECORDS = window.HEAD_TO_HEAD_RECORDS || {});
const TEAM_FORM_TRACKER = (window.TEAM_FORM_TRACKER = window.TEAM_FORM_TRACKER || {});
const TOURNAMENT_STATS_SUMMARY = (window.TOURNAMENT_STATS_SUMMARY = window.TOURNAMENT_STATS_SUMMARY || {});
const TOURNAMENT_TEMPLATES = (window.TOURNAMENT_TEMPLATES = window.TOURNAMENT_TEMPLATES || []);
const STADIUM_DATABASE = (window.STADIUM_DATABASE = window.STADIUM_DATABASE || {});
const RIVALRY_PAIRS = (window.RIVALRY_PAIRS = window.RIVALRY_PAIRS || {});
const WEATHER_CONDITIONS = ['Clear', 'Light Rain', 'Heavy Rain', 'Snow', 'Hot', 'Windy'];
const MILESTONE_NOTIFICATIONS = (window.MILESTONE_NOTIFICATIONS = window.MILESTONE_NOTIFICATIONS || []);

/************* ACHIEVEMENT SYSTEM *************/

// Achievement definitions
const ACHIEVEMENTS = {
  // Tournament Completion Achievements
  undefeatedTournament: {
    id: 'undefeatedTournament',
    name: 'Undefeated Champions',
    description: 'Win the tournament without losing a single match',
    icon: '👑',
    rarity: 'legendary',
    category: 'tournament',
    check: (data) => {
      if (!data.champion || !data.matches) return false;
      const championMatches = data.matches.filter(m =>
        m.teamA === data.champion || m.teamB === data.champion
      );
      return championMatches.every(m => {
        const isTeamA = m.teamA === data.champion;
        return isTeamA ? m.scoreA >= m.scoreB : m.scoreB >= m.scoreA;
      });
    }
  },

  comebackKing: {
    id: 'comebackKing',
    name: 'Comeback King',
    description: 'Win a knockout tie after losing the first leg',
    icon: '🔄',
    rarity: 'epic',
    category: 'match',
    requiresProgress: true,
    progress: 0,
    maxProgress: 1,
    check: (data) => data.comebacks > 0
  },

  giantKiller: {
    id: 'giantKiller',
    name: 'Giant Killer',
    description: 'Defeat a team rated 10+ points higher',
    icon: '🗡️',
    rarity: 'rare',
    category: 'match',
    requiresProgress: true,
    progress: 0,
    maxProgress: 3,
    check: (data) => data.upsets >= 3
  },

  goalFest: {
    id: 'goalFest',
    name: 'Goal Fest',
    description: 'Win a match with 5+ goals scored',
    icon: '⚽',
    rarity: 'common',
    category: 'match',
    requiresProgress: true,
    progress: 0,
    maxProgress: 5,
    check: (data) => data.highScoring >= 5
  },

  cleanSweep: {
    id: 'cleanSweep',
    name: 'Clean Sweep',
    description: 'Win all group stage matches',
    icon: '🧹',
    rarity: 'rare',
    category: 'group',
    check: (data) => {
      if (!data.groupResults) return false;
      return Object.values(data.groupResults).some(group => {
        const standings = group.teams || group.standings || [];
        if (standings.length === 0) return false;
        const winner = standings[0];
        return winner && winner.wins === 6 && winner.losses === 0;
      });
    }
  },

  perfectDefense: {
    id: 'perfectDefense',
    name: 'Fortress',
    description: 'Keep a clean sheet in 5 consecutive matches',
    icon: '🛡️',
    rarity: 'epic',
    category: 'defense',
    requiresProgress: true,
    progress: 0,
    maxProgress: 5,
    check: (data) => data.cleanSheets >= 5
  },

  lastMinuteHero: {
    id: 'lastMinuteHero',
    name: 'Last Minute Hero',
    description: 'Score a decisive goal in injury time',
    icon: '⏱️',
    rarity: 'rare',
    category: 'match',
    requiresProgress: true,
    progress: 0,
    maxProgress: 1,
    check: (data) => data.dramatics > 0
  },

  dynastyBuilder: {
    id: 'dynastyBuilder',
    name: 'Dynasty Builder',
    description: 'Win 3 tournaments with the same team',
    icon: '🏰',
    rarity: 'legendary',
    category: 'legacy',
    requiresProgress: true,
    progress: 0,
    maxProgress: 3,
    check: (data) => data.consecutiveWins >= 3
  },

  centuryClub: {
    id: 'centuryClub',
    name: 'Century Club',
    description: 'Score 100 total goals across all tournaments',
    icon: '💯',
    rarity: 'epic',
    category: 'scoring',
    requiresProgress: true,
    progress: 0,
    maxProgress: 100,
    check: (data) => data.totalGoals >= 100
  },

  tournamentRunner: {
    id: 'tournamentRunner',
    name: 'Tournament Runner',
    description: 'Complete 10 full tournaments',
    icon: '🏃',
    rarity: 'rare',
    category: 'participation',
    requiresProgress: true,
    progress: 0,
    maxProgress: 10,
    check: (data) => data.tournamentsCompleted >= 10
  },

  upsetSpecialist: {
    id: 'upsetSpecialist',
    name: 'Upset Specialist',
    description: 'Cause 10 major upsets in knockout rounds',
    icon: '🎲',
    rarity: 'epic',
    category: 'upsets',
    requiresProgress: true,
    progress: 0,
    maxProgress: 10,
    check: (data) => data.knockoutUpsets >= 10
  },

  goldenBoot: {
    id: 'goldenBoot',
    name: 'Golden Boot',
    description: 'Have a player score 10+ goals in one tournament',
    icon: '👢',
    rarity: 'rare',
    category: 'player',
    check: (data) => {
      if (!data.topScorer) return false;
      return data.topScorer.goals >= 10;
    }
  },

  firstBlood: {
    id: 'firstBlood',
    name: 'First Blood',
    description: 'Score your first goal',
    icon: '⚽',
    rarity: 'common',
    category: 'scoring',
    points: 10,
    check: (data) => data.totalGoals >= 1
  },

  hatTrickHero: {
    id: 'hatTrickHero',
    name: 'Hat-Trick Hero',
    description: 'Score a hat-trick',
    icon: '🎩',
    rarity: 'uncommon',
    category: 'player',
    points: 30,
    requiresProgress: true,
    progress: 0,
    maxProgress: 1,
    check: (data) => data.hatTricks > 0
  },

  penaltySpecialist: {
    id: 'penaltySpecialist',
    name: 'Penalty Specialist',
    description: 'Win 3 penalty shootouts',
    icon: '🎯',
    rarity: 'rare',
    category: 'knockout',
    points: 60,
    requiresProgress: true,
    progress: 0,
    maxProgress: 3,
    check: (data) => data.penaltyWins >= 3
  },

  demolition: {
    id: 'demolition',
    name: 'Demolition',
    description: 'Win a match by 7+ goals',
    icon: '💥',
    rarity: 'epic',
    category: 'match',
    points: 120,
    requiresProgress: true,
    progress: 0,
    maxProgress: 1,
    check: (data) => data.bigWins > 0
  },

  invincible: {
    id: 'invincible',
    name: 'Invincible',
    description: 'Win tournament without losing a match',
    icon: '👑',
    rarity: 'legendary',
    category: 'tournament',
    points: 500,
    check: (data) => {
      if (!data.champion || !data.matches) return false;
      const championMatches = data.matches.filter(m =>
        m.teamA === data.champion || m.teamB === data.champion
      );
      return championMatches.every(m => {
        const isTeamA = m.teamA === data.champion;
        return isTeamA ? m.scoreA >= m.scoreB : m.scoreB >= m.scoreA;
      }) && championMatches.length > 0;
    }
  },

  comebackKingV2: {
    id: 'comebackKingV2',
    name: 'Comeback King',
    description: 'Win after being 3+ goals down',
    icon: '💪',
    rarity: 'epic',
    category: 'match',
    points: 100,
    requiresProgress: true,
    progress: 0,
    maxProgress: 1,
    check: (data) => data.bigComebacks > 0
  },

  perfectGroup: {
    id: 'perfectGroup',
    name: 'Perfect Group',
    description: 'Win all 6 group stage matches',
    icon: '✨',
    rarity: 'rare',
    category: 'group',
    points: 75,
    check: (data) => {
      if (!data.groupResults) return false;
      return Object.values(data.groupResults).some(group => {
        const standings = group.teams || group.standings || [];
        if (standings.length === 0) return false;
        const winner = standings[0];
        return winner && winner.wins === 6 && winner.losses === 0;
      });
    }
  },

  centuryClubV2: {
    id: 'centuryClubV2',
    name: 'Century Club',
    description: 'Score 100+ goals in a tournament',
    icon: '💯',
    rarity: 'epic',
    category: 'scoring',
    points: 150,
    check: (data) => {
      if (!data.matches) return false;
      const totalGoals = data.matches.reduce((sum, m) => sum + (m.scoreA || 0) + (m.scoreB || 0), 0);
      return totalGoals >= 100;
    }
  },

  cleanSweepV2: {
    id: 'cleanSweepV2',
    name: 'Clean Sweep',
    description: 'Win 5 consecutive clean sheets',
    icon: '🧤',
    rarity: 'rare',
    category: 'defense',
    points: 80,
    requiresProgress: true,
    progress: 0,
    maxProgress: 5,
    check: (data) => data.consecutiveCleanSheets >= 5
  },

  // Custom Match Achievements
  weatherWarrior: {
    id: 'weatherWarrior',
    name: 'Weather Warrior',
    description: 'Win custom matches in all weather conditions',
    icon: '⛈️',
    rarity: 'rare',
    category: 'custom',
    points: 75,
    requiresProgress: true,
    progress: 0,
    maxProgress: 5,
    check: (data) => data.weatherWins >= 5
  },

  customMatchMaster: {
    id: 'customMatchMaster',
    name: 'Custom Match Master',
    description: 'Play 25 custom matches',
    icon: '🎮',
    rarity: 'uncommon',
    category: 'custom',
    points: 50,
    requiresProgress: true,
    progress: 0,
    maxProgress: 25,
    check: (data) => data.customMatchesPlayed >= 25
  },

  blizzardVictory: {
    id: 'blizzardVictory',
    name: 'Blizzard Victory',
    description: 'Win a custom match in snowy conditions',
    icon: '❄️',
    rarity: 'common',
    category: 'custom',
    points: 25,
    requiresProgress: true,
    progress: 0,
    maxProgress: 1,
    check: (data) => data.snowyWins > 0
  },

  heatwave: {
    id: 'heatwave',
    name: 'Heatwave Hero',
    description: 'Win 5 matches in hot weather',
    icon: '🔥',
    rarity: 'uncommon',
    category: 'custom',
    points: 40,
    requiresProgress: true,
    progress: 0,
    maxProgress: 5,
    check: (data) => data.hotWins >= 5
  },

  // Career Achievements
  favoriteTeamChampion: {
    id: 'favoriteTeamChampion',
    name: 'Favorite Team Champion',
    description: 'Win a tournament with your tracked team',
    icon: '❤️',
    rarity: 'epic',
    category: 'career',
    points: 150,
    requiresProgress: true,
    progress: 0,
    maxProgress: 1,
    check: (data) => data.favoriteTeamWins > 0
  },

  dedication: {
    id: 'dedication',
    name: 'Dedication',
    description: 'Track the same team for 10 tournaments',
    icon: '🎯',
    rarity: 'rare',
    category: 'career',
    points: 100,
    requiresProgress: true,
    progress: 0,
    maxProgress: 10,
    check: (data) => data.trackedTournaments >= 10
  },

  dynasty: {
    id: 'dynasty',
    name: 'Dynasty',
    description: 'Win 3 tournaments with your tracked team',
    icon: '👑',
    rarity: 'legendary',
    category: 'career',
    points: 250,
    requiresProgress: true,
    progress: 0,
    maxProgress: 3,
    check: (data) => data.favoriteTeamWins >= 3
  },

  managerLevel10: {
    id: 'managerLevel10',
    name: 'Rising Star',
    description: 'Reach Manager Level 10',
    icon: '⭐',
    rarity: 'common',
    category: 'career',
    points: 50,
    check: (data) => MANAGER_PROFILE.level >= 10
  },

  managerLevel25: {
    id: 'managerLevel25',
    name: 'Veteran Manager',
    description: 'Reach Manager Level 25',
    icon: '🌟',
    rarity: 'rare',
    category: 'career',
    points: 100,
    check: (data) => MANAGER_PROFILE.level >= 25
  },

  managerLevel50: {
    id: 'managerLevel50',
    name: 'Legendary Manager',
    description: 'Reach Manager Level 50',
    icon: '✨',
    rarity: 'legendary',
    category: 'career',
    points: 250,
    check: (data) => MANAGER_PROFILE.level >= 50
  },

  streakMaster: {
    id: 'streakMaster',
    name: 'Streak Master',
    description: 'Win 5 tournaments in a row',
    icon: '🔥',
    rarity: 'epic',
    category: 'career',
    points: 200,
    requiresProgress: true,
    progress: 0,
    maxProgress: 5,
    check: (data) => data.winStreak >= 5
  },

  // Player Form Achievement
  onFireManager: {
    id: 'onFireManager',
    name: 'On Fire Manager',
    description: 'Have 3 or more players in hot form (🔥) simultaneously',
    icon: '🔥',
    rarity: 'rare',
    category: 'players',
    points: 100,
    check: (data) => {
      const hotPlayerCount = Object.values(PLAYER_DB).filter(
        player => player.form && player.form.current >= 1
      ).length;
      return hotPlayerCount >= 3;
    }
  }
};

// Initialize achievement system
window.ACHIEVEMENTS_DATA = JSON.parse(localStorage.getItem('achievementsData')) || {
  unlocked: {},
  progress: {},
  stats: {
    comebacks: 0,
    upsets: 0,
    highScoring: 0,
    cleanSheets: 0,
    dramatics: 0,
    consecutiveWins: 0,
    totalGoals: 0,
    tournamentsCompleted: 0,
    knockoutUpsets: 0,
    hatTricks: 0,
    penaltyWins: 0,
    bigWins: 0,
    bigComebacks: 0,
    consecutiveCleanSheets: 0,
    // Custom match stats
    weatherWins: 0,
    customMatchesPlayed: 0,
    snowyWins: 0,
    hotWins: 0,
    // Career stats
    favoriteTeamWins: 0,
    trackedTournaments: 0,
    winStreak: 0
  }
};

/************* STADIUM AND RIVALRY DATA *************/

// Stadium database with home advantage and atmosphere
const STADIUMS = {
  'Camp Nou': { capacity: 99354, homeAdvantage: 0.02, atmosphere: 'Electric atmosphere in Catalonia' },
  'Santiago Bernabéu': { capacity: 81044, homeAdvantage: 0.02, atmosphere: 'Royal and intimidating presence' },
  'Old Trafford': { capacity: 74879, homeAdvantage: 0.015, atmosphere: 'Theatre of Dreams in Manchester' },
  'Anfield': { capacity: 53394, homeAdvantage: 0.025, atmosphere: 'You\'ll Never Walk Alone echoes' },
  'San Siro': { capacity: 75923, homeAdvantage: 0.02, atmosphere: 'Historic Milan cathedral of football' },
  'Allianz Arena': { capacity: 75024, homeAdvantage: 0.02, atmosphere: 'Modern German fortress' },
  'Parc des Princes': { capacity: 47929, homeAdvantage: 0.015, atmosphere: 'Parisian passion and flair' },
  'Stamford Bridge': { capacity: 40341, homeAdvantage: 0.015, atmosphere: 'West London stronghold' },
  'Signal Iduna Park': { capacity: 81365, homeAdvantage: 0.025, atmosphere: 'Yellow Wall thunders' },
  'Wembley': { capacity: 90000, homeAdvantage: 0.01, atmosphere: 'Iconic neutral venue' },
  'Juventus Stadium': { capacity: 41507, homeAdvantage: 0.02, atmosphere: 'Turin\'s modern arena' },
  'Celtic Park': { capacity: 60411, homeAdvantage: 0.025, atmosphere: 'Paradise in Glasgow' },
  'Ibrox': { capacity: 50817, homeAdvantage: 0.02, atmosphere: 'Rangers fortress' },
  'Estádio da Luz': { capacity: 64642, homeAdvantage: 0.02, atmosphere: 'Stadium of Light in Lisbon' },
  'Maracanã': { capacity: 78838, homeAdvantage: 0.015, atmosphere: 'Rio\'s legendary temple' },
  'La Bombonera': { capacity: 49000, homeAdvantage: 0.03, atmosphere: 'Most intimidating in the world' }
};

// Classic rivalries
const RIVALRIES = {
  'Barcelona-Real Madrid': ['Barcelona', 'Real Madrid'],
  'Man United-Liverpool': ['Manchester United', 'Liverpool'],
  'AC Milan-Inter Milan': ['AC Milan', 'Inter Milan'],
  'Celtic-Rangers': ['Celtic', 'Rangers'],
  'Boca-River': ['Boca Juniors', 'River Plate'],
  'Arsenal-Tottenham': ['Arsenal', 'Tottenham'],
  'Benfica-Porto': ['Benfica', 'Porto']
};

// Historical "What If" Matchups
const CLASSIC_MATCHUPS = [
  {
    name: 'Tiki-Taka Clash',
    teamA: '2009 Barcelona',
    teamB: '2011 Barcelona',
    description: 'The two greatest Barcelona teams face off'
  },
  {
    name: 'Galácticos Showdown',
    teamA: '2002 Real Madrid',
    teamB: '2017 Real Madrid',
    description: 'Different eras of Madrid dominance collide'
  },
  {
    name: 'Milan Derby of Legends',
    teamA: '1994 AC Milan',
    teamB: '2010 Inter Milan',
    description: 'Historic Milan powerhouses battle'
  },
  {
    name: 'Premier League Titans',
    teamA: '1999 Manchester United',
    teamB: '2005 Chelsea',
    description: 'English football\'s golden age'
  },
  {
    name: 'German Efficiency',
    teamA: '2013 Bayern Munich',
    teamB: '1997 Borussia Dortmund',
    description: 'Bundesliga legends clash'
  },
  {
    name: 'Dutch Masters',
    teamA: '1995 Ajax',
    teamB: '1988 PSV Eindhoven',
    description: 'Total Football philosophy'
  },
  {
    name: 'European Giants',
    teamA: '2019 Liverpool',
    teamB: '2013 Bayern Munich',
    description: 'Modern powerhouses collide'
  },
  {
    name: 'Italian Dominance',
    teamA: '2005 AC Milan',
    teamB: '1996 Juventus',
    description: 'Serie A golden era battle'
  },
  {
    name: 'Portuguese Pride',
    teamA: '2004 Porto',
    teamB: '2003 Porto',
    description: 'Champions League winning Porto teams'
  },
  {
    name: 'South American Glory',
    teamA: '2019 Flamengo',
    teamB: '2003 Boca Juniors',
    description: 'Continental legends from Brazil vs Argentina'
  },
  {
    name: 'The Invincibles Era',
    teamA: '2004 Arsenal',
    teamB: '2008 Manchester United',
    description: 'English Premier League dominance'
  },
  {
    name: 'Barcelona Golden Age',
    teamA: '2006 Barcelona',
    teamB: '2015 Barcelona',
    description: 'Ronaldinho\'s magic vs MSN attack'
  },
  {
    name: 'Madrid Royalty',
    teamA: '2016 Real Madrid',
    teamB: '1998 Real Madrid',
    description: 'Champions League dynasties collide'
  },
  {
    name: 'German Powerhouses',
    teamA: '2001 Bayern Munich',
    teamB: '2013 Borussia Dortmund',
    description: 'Bundesliga title rivals face off'
  }
];

// Formation templates
const FORMATIONS = {
  '4-3-3': {
    name: '4-3-3',
    attackBonus: 0.05,
    defenseBonus: -0.02,
    description: 'Attacking formation with wide wingers'
  },
  '4-4-2': {
    name: '4-4-2',
    attackBonus: 0,
    defenseBonus: 0,
    description: 'Balanced traditional formation'
  },
  '5-3-2': {
    name: '5-3-2',
    attackBonus: -0.03,
    defenseBonus: 0.05,
    description: 'Defensive formation with wingbacks'
  },
  '4-2-3-1': {
    name: '4-2-3-1',
    attackBonus: 0.02,
    defenseBonus: 0.02,
    description: 'Modern balanced approach'
  },
  '3-5-2': {
    name: '3-5-2',
    attackBonus: 0.03,
    defenseBonus: 0,
    description: 'Control through midfield'
  }
};

// Save achievements to localStorage
function saveAchievements() {
  localStorage.setItem('achievementsData', JSON.stringify(window.ACHIEVEMENTS_DATA));
}

// Check and unlock achievement
function checkAchievement(achievementId, data = {}) {
  const achievement = ACHIEVEMENTS[achievementId];
  if (!achievement) return false;

  // Already unlocked
  if (window.ACHIEVEMENTS_DATA.unlocked[achievementId]) {
    return false;
  }

  // Merge data with global stats
  const checkData = { ...window.ACHIEVEMENTS_DATA.stats, ...data };

  // Check if achievement is unlocked
  if (achievement.check(checkData)) {
    unlockAchievement(achievementId);
    return true;
  }

  // Update progress if applicable
  if (achievement.requiresProgress) {
    const progressKey = achievementId;
    const currentProgress = window.ACHIEVEMENTS_DATA.progress[progressKey] || 0;
    const newProgress = Math.min(achievement.maxProgress, currentProgress + (data.increment || 0));

    if (newProgress !== currentProgress) {
      window.ACHIEVEMENTS_DATA.progress[progressKey] = newProgress;
      saveAchievements();
    }
  }

  return false;
}

// Unlock an achievement
// Removed duplicate: function unlockAchievement - see later definition

// Show achievement unlock notification
function showAchievementNotification(achievement) {
  // Use new notification system if available
  if (typeof showNotification === 'function') {
    const pointsText = achievement.points ? ` | +${achievement.points} points` : '';
    const rarityColor = {
      'common': '#9ca3af',
      'uncommon': '#10b981',
      'rare': '#3b82f6',
      'epic': '#a855f7',
      'legendary': '#fbbf24'
    }[achievement.rarity] || '#10b981';

    showNotification('achievement',
      `🏆 Achievement Unlocked!`,
      `<div style="display: flex; align-items: center; gap: 12px;">
        <div style="font-size: 2.5em;">${achievement.icon}</div>
        <div>
          <div style="font-weight: 700; font-size: 1.1em; color: ${rarityColor};">${achievement.name}</div>
          <div style="color: var(--text-secondary); margin-top: 4px;">${achievement.description}</div>
          <div style="color: var(--color-accent); margin-top: 4px; font-weight: 600;">${pointsText}</div>
        </div>
      </div>`,
      5000);

    // Play sound effect (optional)
    try {
      const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZUQ4NVanm8aFaDgpDm+Hyu3QlBi6E0PLaizsGHmu/8OScTw0PVKXl8aBeFApBmuDyu3MkBi2D0PLairwGH2y+8OWcTQ0OVKTl8Z9dDwpAmd/yu3IjBiyC0PKaisAGIGu98OWbTA0PU6Pl8Z5dDwo/mN/yu3EiBiuB0PKaisMGIWq88OWaTBIOUqLk8Z1cDgk+l97yu28hBimA0PKZicQGImm78OSZSxEOU6Hj8ZxbDgg9lt3yum4gBih/z/KYiMUGI2m68OSYSxEPUZ/i8ZpaDgc8lNzyu24fBid+zvKXiMYGJGi58OOXShEQUZ7h8ZlZDQc7k9vxu2weBiZ9zfKWh8cGJWe48OOWSREQUJzg8JhYDQc6ktrxumsfBiV8zPKVhscGJma378OWSBIPUJrg8JdXDAU5kdnxuWoeBSR7y/KUhsgGJ2W278KVRxIPT5nf8JdWCwU4kNjxuGkdBSN6yvKTh8kGKGS178GURxIOTpje75dVCgQ3j9fxt2kcBCJ5yPKSiMoGKWO0772TRhEOTpfd75ZUCgM2jtbxtmgcBCF4yPKRiMsGKmGz7r2SRREOTZbb75VTCgI1jdXxtWgcAyB3x/KQicsGK2Cy7rySRBEOS5Ta75RTCQIzjNTxs2caAx52xvKPicwGK1+x7ruRQhAOSZPZ75RSCQExitPxs2YaAh11xfKOiM0HLF6w7rqQQhANSZHY7pRQCAAwicfFBQECAwMNDg8PERISFBUVFxcYGRkaHBwdHR4eHyAgISIjIyQkJSUmJicoKCgpKSorKysrLCwtLS0tLi4uLy8wMDEwMDExMTIyMjMyMzMzNDQ0NDQ1NTY2Njc3NzY3Nzg4ODk5Ojk6Ojo7Ozs7Ozs8PDw8PDw9PT0+Pj4+Pj8/Pz8/QEBAQEBAQEBAQEBAQEBAQEBAQD8/Pz8/Pz8/Pj4+Pj4+Pj09PTw8PDw8PDw7Ozs7Ozs6Ojo5OTk5ODg4Nzc3NjY2NTU1NDQ0MzMzMjIyMTExMDAwLy8vLi4uLS0tLCwsKysrKioqKSkoKCgnJycmJiYlJSQkIyMjIiEhICAgHx4eHh0dHBwbGxoaGRkYGBcXFRUVFBMTEhEREA8PDw0NDAw=');
      audio.volume = 0.3;
      audio.play().catch(() => {});
    } catch (e) {}
    return;
  }

  // Fallback to old notification system
  const notification = document.getElementById('achievementNotification');
  if (!notification) return;

  notification.innerHTML = `
    <div class="achievement-notification-content">
      <div class="achievement-notification-icon">${achievement.icon}</div>
      <div class="achievement-notification-text">
        <div class="achievement-notification-title">Achievement Unlocked!</div>
        <div class="achievement-notification-name">${achievement.name}</div>
        <div class="achievement-notification-description">${achievement.description}</div>
        ${achievement.points ? `<div class="achievement-notification-points">+${achievement.points} points</div>` : ''}
      </div>
    </div>
  `;

  notification.classList.add('show');

  setTimeout(() => {
    notification.classList.remove('show');
  }, 5000);
}

// Check all achievements
function checkAllAchievements(tournamentData) {
  Object.keys(ACHIEVEMENTS).forEach(id => {
    checkAchievement(id, tournamentData);
  });
}

// Update achievement progress
function updateAchievementProgress(type, value = 1) {
  if (!window.ACHIEVEMENTS_DATA.stats[type]) {
    window.ACHIEVEMENTS_DATA.stats[type] = 0;
  }
  window.ACHIEVEMENTS_DATA.stats[type] += value;
  saveAchievements();
}

// Show trophy cabinet
function showTrophyCabinet() {
  const out = document.getElementById('output');
  if (!out) return;

  const totalAchievements = Object.keys(ACHIEVEMENTS).length;
  const unlockedCount = Object.keys(window.ACHIEVEMENTS_DATA.unlocked).length;
  const percentage = Math.round((unlockedCount / totalAchievements) * 100);

  let html = `
    <div class="trophy-cabinet">
      <div class="achievement-header">
        <div>
          <h2 style="margin: 0;">🏆 Trophy Cabinet</h2>
          <p style="color: #94a3b8; font-size: 0.875rem; margin-top: 4px;">
            Your collection of achievements and milestones
          </p>
        </div>
        <div class="achievement-stats">
          <div class="achievement-stat">
            <div class="achievement-stat-label">Unlocked</div>
            <div class="achievement-stat-value">${unlockedCount}/${totalAchievements}</div>
          </div>
          <div class="achievement-stat">
            <div class="achievement-stat-label">Progress</div>
            <div class="achievement-stat-value">${percentage}%</div>
          </div>
        </div>
      </div>

      <div class="achievement-filter">
        <button class="achievement-filter-btn active" onclick="filterAchievements('all')">All</button>
        <button class="achievement-filter-btn" onclick="filterAchievements('unlocked')">Unlocked</button>
        <button class="achievement-filter-btn" onclick="filterAchievements('locked')">Locked</button>
        <button class="achievement-filter-btn" onclick="filterAchievements('legendary')">Legendary</button>
        <button class="achievement-filter-btn" onclick="filterAchievements('epic')">Epic</button>
        <button class="achievement-filter-btn" onclick="filterAchievements('rare')">Rare</button>
      </div>

      <div class="achievements-grid" id="achievementsGrid">
  `;

  Object.entries(ACHIEVEMENTS).forEach(([id, achievement]) => {
    const isUnlocked = window.ACHIEVEMENTS_DATA.unlocked[id];
    const progress = window.ACHIEVEMENTS_DATA.progress[id] || 0;
    const progressPercent = achievement.requiresProgress
      ? Math.round((progress / achievement.maxProgress) * 100)
      : 100;

    html += `
      <div class="achievement-card ${isUnlocked ? 'unlocked' : 'locked'}" data-rarity="${achievement.rarity}" data-status="${isUnlocked ? 'unlocked' : 'locked'}">
        <span class="achievement-rarity ${achievement.rarity}">${achievement.rarity}</span>
        <div class="achievement-icon">${achievement.icon}</div>
        <div class="achievement-name">${achievement.name}</div>
        <div class="achievement-description">${achievement.description}</div>
        ${achievement.requiresProgress && !isUnlocked ? `
          <div class="achievement-progress">
            <div class="achievement-progress-bar">
              <div class="achievement-progress-fill" style="width: ${progressPercent}%"></div>
            </div>
            <div class="achievement-progress-text">${progress}/${achievement.maxProgress}</div>
          </div>
        ` : ''}
        ${isUnlocked ? `
          <div class="achievement-unlocked-date">
            Unlocked ${new Date(window.ACHIEVEMENTS_DATA.unlocked[id].unlockedAt).toLocaleDateString()}
          </div>
        ` : ''}
      </div>
    `;
  });

  html += `
      </div>
    </div>
  `;

  out.innerHTML = html;
}

// Filter achievements
function filterAchievements(filter) {
  const cards = document.querySelectorAll('.achievement-card');
  const buttons = document.querySelectorAll('.achievement-filter-btn');

  buttons.forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');

  cards.forEach(card => {
    let show = false;
    if (filter === 'all') {
      show = true;
    } else if (filter === 'unlocked' || filter === 'locked') {
      show = card.dataset.status === filter;
    } else {
      show = card.dataset.rarity === filter;
    }
    card.style.display = show ? 'block' : 'none';
  });
}

/************* TOURNAMENT STAGE FUNCTIONS *************/
/************* MATCH DISPLAY FUNCTIONS *************/
function displayMatchWeekResults() {
  if (window.VERBOSE_LOGGING) console.log("Displaying match week results...");
  // Placeholder for future detailed week-by-week view
}

function displayKnockoutRound() {
  if (window.VERBOSE_LOGGING) console.log("Displaying knockout round...");
  // Placeholder for future knockout bracket view
}

/************* UTILITY / CORE FUNCTIONS *************/
function exportTournament() {
  if (window.VERBOSE_LOGGING) console.log("Exporting tournament...");

  const exportPayload = {
    metadata: {
      version: 1,
      dataType: "football-tournament",
      exportDate: new Date().toISOString(),
      tournamentId: window.CURRENT_TOURNAMENT_ID || null,
      tournamentName: getTournamentName(),
      totalMatches: Object.keys(MATCH_DETAILS_DB).length,
      totalPlayers: Object.keys(PLAYER_DB).length,
      exportSize: 0
    },
    groups: window.GROUPS,
    groupResults: window.GROUP_RESULTS,
    knockoutResults: window.TOURNAMENT,
    matchDetails: MATCH_DETAILS_DB,
    playerStats: PLAYER_DB,
    clubLegacy: CLUB_LEGACY_DB,
    allTimeStats: ALL_TIME_PLAYER_DB,
    matchSchedule: MATCH_SCHEDULE,
    timeline: TOURNAMENT_TIMELINE,
    rngSettings: RNG_SETTINGS,
    history: TOURNAMENT_HISTORY,
    customMatches: getCustomMatchesHistory()
  };

  try {
    const json = JSON.stringify(exportPayload, null, 2);
    exportPayload.metadata.exportSize = new Blob([json]).size;
    const finalJson = JSON.stringify(exportPayload, null, 2);
    
    if (typeof showExportPreviewModal === 'function') {
      showExportPreviewModal(exportPayload, finalJson);
    } else {
      const blob = new Blob([finalJson], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const ts = new Date().toISOString().replace(/[:.]/g, "-");
      a.href = url;
      a.download = `all-time-football-save-${ts}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      showUtilityMessage("Tournament exported to JSON file.", "success");
    }
  } catch (err) {
    console.error("Export error:", err);
    showUtilityMessage("Failed to export tournament.", "error");
  }
}
// downloadTournamentExport is defined later in the file with enhanced implementation (line 28117)
// copyExportToClipboard is defined later in the file with enhanced implementation (line 28137)

function resetTournament() {
  if (confirm("Are you sure you want to reset the tournament? All current progress will be lost.")) {
    performReset();
  }
}
function handleImport() {
  if (window.VERBOSE_LOGGING) console.log("Handling import...");

  const input = document.getElementById("importSave");
  if (!input || !input.files || input.files.length === 0) {
    showUtilityMessage("Please choose a save file first.", "info");
    return;
  }

  const file = input.files[0];
  const reader = new FileReader();

  reader.onload = (e) => {
    try {
      const text = e.target.result;
      const parsed = JSON.parse(text);

      if (!parsed || typeof parsed !== "object") {
        showUtilityMessage("Invalid save file format.", "error");
        return;
      }

      if (typeof validateAndImportData === 'function') {
        validateAndImportData(parsed, file.name);
      } else {
        legacyImportData(parsed);
      }
    } catch (err) {
      console.error("Import error:", err);
      showUtilityMessage("Failed to load save file.", "error");
    }
  };

  reader.onerror = () => {
    console.error("File read error:", reader.error);
    showUtilityMessage("Error reading save file.", "error");
  };

  reader.readAsText(file);
}

function legacyImportData(parsed) {
  const state = parsed.state || parsed;
  const data = parsed.data || parsed;

  window.GROUPS = state.groups || parsed.groups || null;
  window.GROUP_RESULTS = state.groupResults || parsed.groupResults || null;
  window.TOURNAMENT = state.tournament || state.knockoutResults || parsed.knockoutResults || null;
  window.CURRENT_TOURNAMENT_ID = (parsed.meta && parsed.meta.tournamentId) || (parsed.metadata && parsed.metadata.tournamentId) || null;

  if (data.playerDb || data.playerStats) {
    Object.assign(PLAYER_DB, data.playerDb || data.playerStats || {});
  }
  if (data.allTimePlayerDb || data.allTimeStats) {
    Object.assign(ALL_TIME_PLAYER_DB, data.allTimePlayerDb || data.allTimeStats || {});
  }
  if (data.matchDetails) {
    Object.assign(MATCH_DETAILS_DB, data.matchDetails || {});
  }
  if (data.clubLegacy) {
    Object.assign(CLUB_LEGACY_DB.champions, (data.clubLegacy && data.clubLegacy.champions) || {});
    Object.assign(CLUB_LEGACY_DB.finals, (data.clubLegacy && data.clubLegacy.finals) || {});
    Object.assign(CLUB_LEGACY_DB.semiFinals, (data.clubLegacy && data.clubLegacy.semiFinals) || {});
    Object.assign(CLUB_LEGACY_DB.quarterFinals, (data.clubLegacy && data.clubLegacy.quarterFinals) || {});
    Object.assign(CLUB_LEGACY_DB.totalWins, (data.clubLegacy && data.clubLegacy.totalWins) || {});
  }

  if (data.matchSchedule) {
    MATCH_SCHEDULE.groupStage = data.matchSchedule.groupStage || [];
    MATCH_SCHEDULE.knockoutStage = data.matchSchedule.knockoutStage || [];
  }

  if (Array.isArray(data.timeline)) {
    TOURNAMENT_TIMELINE.length = 0;
    TOURNAMENT_TIMELINE.push(...data.timeline);
  }

  if (data.rngSettings) {
    RNG_SETTINGS.groupChaos = data.rngSettings.groupChaos ?? RNG_SETTINGS.groupChaos;
    RNG_SETTINGS.knockoutChaos = data.rngSettings.knockoutChaos ?? RNG_SETTINGS.knockoutChaos;
  }

  if (Array.isArray(data.history)) {
    TOURNAMENT_HISTORY.length = 0;
    TOURNAMENT_HISTORY.push(...data.history);
  }

  updateButtonStates();
  showUtilityMessage("Save file loaded successfully.", "success");
}

function setRNGPreset(value, element) {
  if (window.VERBOSE_LOGGING) console.log("Setting RNG preset:", value);
  const slider = document.getElementById("rngSlider");
  if (slider) {
    slider.value = value;
    if (typeof updateRNG === "function") {
      updateRNG(value);
    }
  }

  // Update active state for pills
  document.querySelectorAll(".rng-pill").forEach((pill) => {
    pill.classList.remove("active");
  });
  if (element) element.classList.add("active");
}

/************* MATCH SUMMARY / CONTENT HELPERS *************/
// Removed duplicate: function generateMatchSummary - see later definition

/************* NEW FEATURE FUNCTIONS *************/

// Head-to-Head Records
function updateHeadToHeadRecord(teamA, teamB, result) {
  const key = [teamA, teamB].sort().join(' vs ');
  if (!HEAD_TO_HEAD_RECORDS[key]) {
    HEAD_TO_HEAD_RECORDS[key] = {
      teams: [teamA, teamB],
      matches: [],
      wins: { [teamA]: 0, [teamB]: 0 },
      draws: 0
    };
  }

  HEAD_TO_HEAD_RECORDS[key].matches.push(result);
  if (HEAD_TO_HEAD_RECORDS[key].matches.length > 10) {
    HEAD_TO_HEAD_RECORDS[key].matches.shift();
  }

  if (result.winner === teamA) {
    HEAD_TO_HEAD_RECORDS[key].wins[teamA]++;
  } else if (result.winner === teamB) {
    HEAD_TO_HEAD_RECORDS[key].wins[teamB]++;
  } else {
    HEAD_TO_HEAD_RECORDS[key].draws++;
  }
}

function getHeadToHeadRecord(teamA, teamB) {
  const key = [teamA, teamB].sort().join(' vs ');
  return HEAD_TO_HEAD_RECORDS[key] || null;
}

function showHeadToHeadModal(teamA, teamB) {
  const record = getHeadToHeadRecord(teamA, teamB);
  if (!record) {
    showUtilityMessage('No head-to-head record found for these teams', 'info');
    return;
  }

  const last5 = record.matches.slice(-5).reverse();
  const last5HTML = last5.map(m => {
    const color = m.winner === teamA ? '#10b981' : m.winner === teamB ? '#ef4444' : '#fbbf24';
    const result = m.winner ? 'W' : 'D';
    return `<span style="display:inline-block;width:24px;height:24px;background:${color};color:#000;font-weight:bold;border-radius:4px;text-align:center;line-height:24px;margin:2px;">${result}</span>`;
  }).join('');

  const content = `
    <div style="padding: 20px;">
      <h2 style="margin-bottom: 20px; color: #10b981;">Head-to-Head: ${teamA} vs ${teamB}</h2>
      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px;">
        <div style="text-align: center; padding: 15px; background: rgba(16, 185, 129, 0.1); border-radius: 8px;">
          <div style="font-size: 2em; font-weight: bold;">${record.wins[teamA]}</div>
          <div>${teamA} Wins</div>
        </div>
        <div style="text-align: center; padding: 15px; background: rgba(251, 191, 36, 0.1); border-radius: 8px;">
          <div style="font-size: 2em; font-weight: bold;">${record.draws}</div>
          <div>Draws</div>
        </div>
        <div style="text-align: center; padding: 15px; background: rgba(239, 68, 68, 0.1); border-radius: 8px;">
          <div style="font-size: 2em; font-weight: bold;">${record.wins[teamB]}</div>
          <div>${teamB} Wins</div>
        </div>
      </div>
      <div style="margin-top: 20px;">
        <h3>Last 5 Meetings:</h3>
        <div style="margin-top: 10px;">${last5HTML}</div>
      </div>
      <div style="margin-top: 20px;">
        ${record.matches.slice(-5).reverse().map(m => `
          <div style="padding: 10px; background: rgba(255,255,255,0.05); margin: 5px 0; border-radius: 4px;">
            ${m.teamA} ${m.scoreA} - ${m.scoreB} ${m.teamB}
          </div>
        `).join('')}
      </div>
    </div>
  `;

  const modal = document.createElement('div');
  modal.className = 'modal-backdrop active';
  modal.innerHTML = content;
  modal.onclick = (e) => {
    if (e.target === modal) modal.remove();
  };
  document.body.appendChild(modal);
}

// Team Form Tracker
function updateTeamForm(teamName, result) {
  if (!TEAM_FORM_TRACKER[teamName]) {
    TEAM_FORM_TRACKER[teamName] = [];
  }
  TEAM_FORM_TRACKER[teamName].push(result);
  if (TEAM_FORM_TRACKER[teamName].length > 5) {
    TEAM_FORM_TRACKER[teamName].shift();
  }
}

function getTeamFormHTML(teamName) {
  const form = TEAM_FORM_TRACKER[teamName] || [];
  if (form.length === 0) return '';

  return form.map(result => {
    let color, letter;
    if (result === 'W') {
      color = '#10b981';
      letter = 'W';
    } else if (result === 'D') {
      color = '#fbbf24';
      letter = 'D';
    } else {
      color = '#ef4444';
      letter = 'L';
    }
    return `<span style="display:inline-block;width:20px;height:20px;background:${color};color:#000;font-weight:bold;border-radius:3px;text-align:center;line-height:20px;margin:1px;font-size:11px;">${letter}</span>`;
  }).join('');
}

// Tournament Statistics Summary
function calculateTournamentStats() {
  const groupMatches = [];
  const knockoutMatches = [];

  // Collect group stage matches
  if (window.GROUP_RESULTS) {
    Object.values(window.GROUP_RESULTS).forEach(groupData => {
      if (groupData && groupData.matches) {
        groupMatches.push(...groupData.matches);
      }
    });
  }

  // Collect knockout matches
  if (window.TOURNAMENT && window.TOURNAMENT.allKnockoutMatches) {
    knockoutMatches.push(...window.TOURNAMENT.allKnockoutMatches);
  }

  const allMatches = [...groupMatches, ...knockoutMatches];
  if (allMatches.length === 0) return null;

  let totalGoals = 0;
  let biggestWin = { diff: 0, match: null };
  let upsets = 0;
  let cleanSheets = 0;
  let hatTricks = 0;

  allMatches.forEach(match => {
    if (!match) return;
    const goalsInMatch = (match.scoreA || 0) + (match.scoreB || 0);
    totalGoals += goalsInMatch;

    const diff = Math.abs((match.scoreA || 0) - (match.scoreB || 0));
    if (diff > biggestWin.diff) {
      biggestWin = { diff, match };
    }

    if ((match.scoreA || 0) === 0 || (match.scoreB || 0) === 0) {
      cleanSheets++;
    }
  });

  TOURNAMENT_STATS_SUMMARY.goalsPerGame = (totalGoals / allMatches.length).toFixed(2);
  TOURNAMENT_STATS_SUMMARY.biggestWin = biggestWin;
  TOURNAMENT_STATS_SUMMARY.upsets = upsets;
  TOURNAMENT_STATS_SUMMARY.cleanSheets = cleanSheets;
  TOURNAMENT_STATS_SUMMARY.hatTricks = hatTricks;
  TOURNAMENT_STATS_SUMMARY.totalMatches = allMatches.length;

  return TOURNAMENT_STATS_SUMMARY;
}

function showTournamentStatsSummary() {
  const stats = calculateTournamentStats();
  if (!stats) {
    showUtilityMessage('No tournament data available', 'info');
    return;
  }

  const content = `
    <div style="padding: 15px; max-width: 100%; overflow-x: hidden;">
      <h2 style="margin-bottom: 15px; color: #10b981; font-size: 1.3em;">Tournament Statistics</h2>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; max-width: 100%;">
        <div class="stat-card">
          <div class="stat-value">${stats.goalsPerGame}</div>
          <div class="stat-label">Goals Per Game</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${stats.biggestWin.diff}</div>
          <div class="stat-label">Biggest Win Margin</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${stats.upsets}</div>
          <div class="stat-label">Total Upsets</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${stats.cleanSheets}</div>
          <div class="stat-label">Clean Sheets</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${stats.hatTricks}</div>
          <div class="stat-label">Hat-tricks</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${stats.totalMatches}</div>
          <div class="stat-label">Total Matches</div>
        </div>
      </div>
    </div>
  `;

  const modal = document.createElement('div');
  modal.className = 'modal-backdrop active';
  modal.innerHTML = content;
  modal.onclick = (e) => {
    if (e.target === modal) modal.remove();
  };
  document.body.appendChild(modal);
}

// ========================================
// ENHANCED TOURNAMENT STATS DISPLAY
// ========================================

function displayEnhancedTournamentStats() {
  const out = document.getElementById('content') || document.getElementById('output') || document.getElementById('output');
  if (!out) return;

  out.innerHTML = `
    <div style="max-width: 1000px; margin: 0 auto; padding: 20px;">
      <div style="background: linear-gradient(135deg, var(--cardBg) 0%, color-mix(in srgb, var(--cardBg) 95%, var(--primary)) 100%); padding: 30px; border-radius: 16px; border: 1px solid var(--border);">
        <h2 style="margin: 0 0 24px 0; color: var(--text); display: flex; align-items: center; gap: 10px;">
          📊 Tournament Statistics
        </h2>

        <!-- Tab Navigation -->
        <div style="display: flex; gap: 12px; margin-bottom: 24px; border-bottom: 2px solid var(--border); flex-wrap: wrap;">
          <button onclick="switchStatsTab('current')" id="tab-current"
                  class="stats-tab active"
                  style="padding: 12px 24px; background: none; border: none; color: var(--primary); border-bottom: 3px solid var(--primary); cursor: pointer; font-weight: 600; transition: all 0.3s;">
            Current Tournament
          </button>
          <button onclick="switchStatsTab('records')" id="tab-records"
                  class="stats-tab"
                  style="padding: 12px 24px; background: none; border: none; color: var(--textMuted); border-bottom: 3px solid transparent; cursor: pointer; font-weight: 600; transition: all 0.3s;">
            All-Time Records
          </button>
          <button onclick="switchStatsTab('history')" id="tab-history"
                  class="stats-tab"
                  style="padding: 12px 24px; background: none; border: none; color: var(--textMuted); border-bottom: 3px solid transparent; cursor: pointer; font-weight: 600; transition: all 0.3s;">
            Full History
          </button>
        </div>

        <!-- Tab Content Container -->
        <div id="stats-content">
          ${createCurrentTournamentTab()}
        </div>

        <button onclick="showMainMenu()" class="btn-secondary" style="width: 100%; margin-top: 24px; padding: 12px;">
          ← Back to Menu
        </button>
      </div>
    </div>
  `;
}

function createCurrentTournamentTab() {
  const stats = calculateTournamentStats();
  if (!stats) {
    return '<div style="text-align: center; padding: 40px; color: var(--textMuted);">No active tournament data available</div>';
  }

  const topScorer = getTopScorer();

  return `
    <div class="stats-tab-content">
      <!-- Quick Stats Grid -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
        <div style="background: var(--bg); padding: 20px; border-radius: 12px; border-left: 4px solid var(--primary);">
          <div style="font-size: 32px; font-weight: bold; color: var(--primary); margin-bottom: 8px;">${stats.totalMatches || 0}</div>
          <div style="color: var(--textMuted); font-size: 14px;">Total Matches</div>
        </div>

        <div style="background: var(--bg); padding: 20px; border-radius: 12px; border-left: 4px solid #3B82F6;">
          <div style="font-size: 32px; font-weight: bold; color: #3B82F6; margin-bottom: 8px;">${stats.goalsPerGame || '0.0'}</div>
          <div style="color: var(--textMuted); font-size: 14px;">Goals Per Game</div>
        </div>

        <div style="background: var(--bg); padding: 20px; border-radius: 12px; border-left: 4px solid #F59E0B;">
          <div style="font-size: 32px; font-weight: bold; color: #F59E0B; margin-bottom: 8px;">${stats.biggestWin?.diff || 0}</div>
          <div style="color: var(--textMuted); font-size: 14px;">Biggest Win Margin</div>
        </div>

        <div style="background: var(--bg); padding: 20px; border-radius: 12px; border-left: 4px solid #EF4444;">
          <div style="font-size: 32px; font-weight: bold; color: #EF4444; margin-bottom: 8px;">${stats.upsets || 0}</div>
          <div style="color: var(--textMuted); font-size: 14px;">Total Upsets</div>
        </div>

        <div style="background: var(--bg); padding: 20px; border-radius: 12px; border-left: 4px solid #8B5CF6;">
          <div style="font-size: 32px; font-weight: bold; color: #8B5CF6; margin-bottom: 8px;">${stats.cleanSheets || 0}</div>
          <div style="color: var(--textMuted); font-size: 14px;">Clean Sheets</div>
        </div>

        <div style="background: var(--bg); padding: 20px; border-radius: 12px; border-left: 4px solid #10B981;">
          <div style="font-size: 32px; font-weight: bold; color: #10B981; margin-bottom: 8px;">${stats.hatTricks || 0}</div>
          <div style="color: var(--textMuted); font-size: 14px;">Hat-tricks</div>
        </div>
      </div>

      <!-- Top Scorers Section -->
      ${topScorer ? `
        <div style="background: var(--bg); padding: 24px; border-radius: 12px; margin-bottom: 24px;">
          <h3 style="margin: 0 0 16px 0; color: var(--text); font-size: 18px; display: flex; align-items: center; gap: 8px;">
            ⚽ Top Scorer
          </h3>
          <div style="display: flex; align-items: center; gap: 16px;">
            <div style="font-size: 48px;">🥇</div>
            <div style="flex: 1;">
              <div style="font-size: 24px; font-weight: bold; color: var(--primary); margin-bottom: 4px;">${topScorer.name}</div>
              <div style="color: var(--textMuted);">${topScorer.goals} Goals</div>
            </div>
          </div>
        </div>
      ` : ''}

      <!-- Match Highlights -->
      ${stats.biggestWin ? `
        <div style="background: var(--bg); padding: 24px; border-radius: 12px;">
          <h3 style="margin: 0 0 16px 0; color: var(--text); font-size: 18px; display: flex; align-items: center; gap: 8px;">
            🏆 Biggest Win
          </h3>
          <div style="padding: 16px; background: linear-gradient(90deg, rgba(16, 185, 129, 0.1), transparent); border-left: 4px solid var(--primary); border-radius: 8px;">
            <div style="font-size: 18px; font-weight: 600; color: var(--text); margin-bottom: 8px;">
              ${stats.biggestWin.winner} ${stats.biggestWin.score}
            </div>
            <div style="color: var(--textMuted);">Margin: ${stats.biggestWin.diff} goals</div>
          </div>
        </div>
      ` : ''}
    </div>
  `;
}

function createAllTimeRecordsTab() {
  if (!TOURNAMENT_HISTORY_ENHANCED || !TOURNAMENT_HISTORY_ENHANCED.tournaments || TOURNAMENT_HISTORY_ENHANCED.tournaments.length === 0) {
    return '<div style="text-align: center; padding: 40px; color: var(--textMuted);">No historical tournament data available</div>';
  }

  const allTimeStats = {
    totalTournaments: TOURNAMENT_HISTORY_ENHANCED.tournaments.length,
    totalMatches: 0,
    totalGoals: 0,
    mostChampionships: {},
    biggestWinEver: { diff: 0, score: '', winner: '' }
  };

  // Aggregate all-time stats
  TOURNAMENT_HISTORY_ENHANCED.tournaments.forEach(tournament => {
    if (tournament.stats) {
      allTimeStats.totalMatches += tournament.stats.totalMatches || 0;
      allTimeStats.totalGoals += tournament.stats.totalGoals || 0;
    }

    // Track championships
    if (tournament.champion) {
      allTimeStats.mostChampionships[tournament.champion] =
        (allTimeStats.mostChampionships[tournament.champion] || 0) + 1;
    }

    // Find biggest win
    if (tournament.stats?.biggestWin && tournament.stats.biggestWin.diff > allTimeStats.biggestWinEver.diff) {
      allTimeStats.biggestWinEver = tournament.stats.biggestWin;
    }
  });

  // Get most successful team
  let mostSuccessful = { team: 'None', count: 0 };
  Object.entries(allTimeStats.mostChampionships).forEach(([team, count]) => {
    if (count > mostSuccessful.count) {
      mostSuccessful = { team, count };
    }
  });

  const avgGoalsPerMatch = allTimeStats.totalMatches > 0 ?
    (allTimeStats.totalGoals / allTimeStats.totalMatches).toFixed(2) : '0.00';

  return `
    <div class="stats-tab-content">
      <!-- All-Time Stats Grid -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; margin-bottom: 24px;">
        <div style="background: linear-gradient(135deg, #10B981 0%, #059669 100%); padding: 24px; border-radius: 12px; color: white;">
          <div style="font-size: 36px; font-weight: bold; margin-bottom: 8px;">${allTimeStats.totalTournaments}</div>
          <div style="opacity: 0.9; font-size: 14px;">Total Tournaments</div>
        </div>

        <div style="background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%); padding: 24px; border-radius: 12px; color: white;">
          <div style="font-size: 36px; font-weight: bold; margin-bottom: 8px;">${allTimeStats.totalMatches}</div>
          <div style="opacity: 0.9; font-size: 14px;">Total Matches Played</div>
        </div>

        <div style="background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%); padding: 24px; border-radius: 12px; color: white;">
          <div style="font-size: 36px; font-weight: bold; margin-bottom: 8px;">${allTimeStats.totalGoals}</div>
          <div style="opacity: 0.9; font-size: 14px;">Total Goals Scored</div>
        </div>

        <div style="background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%); padding: 24px; border-radius: 12px; color: white;">
          <div style="font-size: 36px; font-weight: bold; margin-bottom: 8px;">${avgGoalsPerMatch}</div>
          <div style="opacity: 0.9; font-size: 14px;">Avg Goals/Match</div>
        </div>
      </div>

      <!-- Most Successful Team -->
      ${mostSuccessful.count > 0 ? `
        <div style="background: var(--bg); padding: 24px; border-radius: 12px; margin-bottom: 24px;">
          <h3 style="margin: 0 0 16px 0; color: var(--text); font-size: 18px;">🏆 Most Successful Team</h3>
          <div style="display: flex; align-items: center; gap: 16px;">
            <div style="font-size: 64px;">👑</div>
            <div>
              <div style="font-size: 24px; font-weight: bold; color: var(--primary); margin-bottom: 4px;">${mostSuccessful.team}</div>
              <div style="color: var(--textMuted);">${mostSuccessful.count} Championship${mostSuccessful.count > 1 ? 's' : ''}</div>
            </div>
          </div>
        </div>
      ` : ''}

      <!-- All-Time Biggest Win -->
      ${allTimeStats.biggestWinEver.diff > 0 ? `
        <div style="background: var(--bg); padding: 24px; border-radius: 12px;">
          <h3 style="margin: 0 0 16px 0; color: var(--text); font-size: 18px;">🎯 All-Time Biggest Win</h3>
          <div style="padding: 20px; background: linear-gradient(90deg, rgba(239, 68, 68, 0.1), transparent); border-left: 4px solid #EF4444; border-radius: 8px;">
            <div style="font-size: 24px; font-weight: 600; color: var(--text); margin-bottom: 8px;">
              ${allTimeStats.biggestWinEver.winner}
            </div>
            <div style="font-size: 20px; color: var(--primary); margin-bottom: 8px;">${allTimeStats.biggestWinEver.score}</div>
            <div style="color: var(--textMuted);">Victory Margin: ${allTimeStats.biggestWinEver.diff} goals</div>
          </div>
        </div>
      ` : ''}
    </div>
  `;
}

function createFullHistoryTab() {
  if (!TOURNAMENT_HISTORY_ENHANCED || !TOURNAMENT_HISTORY_ENHANCED.tournaments || TOURNAMENT_HISTORY_ENHANCED.tournaments.length === 0) {
    return '<div style="text-align: center; padding: 40px; color: var(--textMuted);">No tournament history available</div>';
  }

  const tournaments = [...TOURNAMENT_HISTORY_ENHANCED.tournaments].reverse(); // Most recent first

  let historyHTML = '<div class="stats-tab-content"><div style="display: flex; flex-direction: column; gap: 12px;">';

  tournaments.forEach((tournament, index) => {
    const date = tournament.timestamp ? new Date(tournament.timestamp).toLocaleDateString() : 'Unknown Date';
    const champion = tournament.champion || 'Unknown';
    const totalMatches = tournament.stats?.totalMatches || 0;
    const totalGoals = tournament.stats?.totalGoals || 0;
    const topScorer = tournament.topScorer?.name || 'Unknown';
    const topScorerGoals = tournament.topScorer?.goals || 0;

    historyHTML += `
      <div style="background: var(--bg); padding: 20px; border-radius: 12px; border: 1px solid var(--border); transition: transform 0.2s; cursor: pointer;"
           onmouseover="this.style.transform='translateX(4px)'; this.style.borderColor='var(--primary)';"
           onmouseout="this.style.transform='translateX(0)'; this.style.borderColor='var(--border)';">
        <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 16px;">
          <div style="flex: 1; min-width: 200px;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
              <div style="font-size: 24px;">🏆</div>
              <div>
                <div style="font-size: 18px; font-weight: 600; color: var(--primary);">${champion}</div>
                <div style="font-size: 12px; color: var(--textMuted);">${date}</div>
              </div>
            </div>
            <div style="display: flex; gap: 16px; margin-top: 12px; flex-wrap: wrap;">
              <div style="font-size: 14px; color: var(--textMuted);">
                ⚽ <span style="color: var(--text); font-weight: 600;">${totalGoals}</span> goals
              </div>
              <div style="font-size: 14px; color: var(--textMuted);">
                📊 <span style="color: var(--text); font-weight: 600;">${totalMatches}</span> matches
              </div>
              ${topScorerGoals > 0 ? `
                <div style="font-size: 14px; color: var(--textMuted);">
                  👟 <span style="color: var(--text); font-weight: 600;">${topScorer}</span> (${topScorerGoals})
                </div>
              ` : ''}
            </div>
          </div>
        </div>
      </div>
    `;
  });

  historyHTML += '</div></div>';

  return historyHTML;
}

function switchStatsTab(tabId) {
  // Update tab styling
  document.querySelectorAll('.stats-tab').forEach(tab => {
    tab.style.color = 'var(--textMuted)';
    tab.style.borderBottomColor = 'transparent';
  });

  const activeTab = document.getElementById(`tab-${tabId}`);
  if (activeTab) {
    activeTab.style.color = 'var(--primary)';
    activeTab.style.borderBottomColor = 'var(--primary)';
  }

  // Update content
  const contentDiv = document.getElementById('stats-content');
  if (!contentDiv) return;

  switch(tabId) {
    case 'current':
      contentDiv.innerHTML = createCurrentTournamentTab();
      break;
    case 'records':
      contentDiv.innerHTML = createAllTimeRecordsTab();
      break;
    case 'history':
      contentDiv.innerHTML = createFullHistoryTab();
      break;
  }
}

// Share Results to Clipboard
function shareResultsToClipboard() {
  if (!window.TOURNAMENT) {
    showUtilityMessage('No tournament results to share', 'info');
    return;
  }

  const champion = window.TOURNAMENT.champion || 'Unknown';
  const topScorer = getTopScorer();
  const stats = calculateTournamentStats();

  const text = `
⚽ All-Time Football Tournament Results ⚽

🏆 Champion: ${champion}
⚽ Top Scorer: ${topScorer ? topScorer.name + ' (' + topScorer.goals + ' goals)' : 'Unknown'}
📊 Goals Per Game: ${stats ? stats.goalsPerGame : 'N/A'}
🎯 Total Matches: ${stats ? stats.totalMatches : 'N/A'}

Generated with All-Time Football Simulator
  `.trim();

  navigator.clipboard.writeText(text).then(() => {
    showUtilityMessage('Results copied to clipboard!', 'success');
  }).catch(() => {
    showUtilityMessage('Failed to copy to clipboard', 'error');
  });
}

// getTopScorer is defined later in the file with enhanced return format (line 15175)

// Historical "What If" Matchups
function showClassicMatchups() {
  const out = document.getElementById('output');
  if (!out) return;

  const html = `
    <div style="max-width: 1200px; margin: 0 auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
        <h2 style="margin: 0; color: #10b981;">🎭 Historical "What If" Matchups</h2>
        <p style="color: #94a3b8; margin: 0; font-size: 0.9em;">Click any matchup to simulate</p>
      </div>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px;">
        ${CLASSIC_MATCHUPS.map(matchup => `
          <div class="matchup-card"
               style="padding: 20px; background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05));
                      border-radius: 12px; cursor: pointer; transition: all 0.3s; border: 2px solid rgba(16, 185, 129, 0.3);
                      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);"
               onclick="simulateClassicMatchup('${matchup.teamA}', '${matchup.teamB}', '${matchup.name}')"
               onmouseover="this.style.transform='translateY(-4px)'; this.style.borderColor='#10b981'; this.style.boxShadow='0 8px 12px rgba(16, 185, 129, 0.3)'"
               onmouseout="this.style.transform='translateY(0)'; this.style.borderColor='rgba(16, 185, 129, 0.3)'; this.style.boxShadow='0 4px 6px rgba(0, 0, 0, 0.2)'">
            <h3 style="color: #10b981; margin: 0 0 12px 0; font-size: 1.2em; font-weight: 600;">${matchup.name}</h3>
            <div style="font-size: 1em; margin: 12px 0; color: #e5e7eb; font-weight: 500; line-height: 1.6;">
              <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                <span style="flex: 1; text-align: right; color: #60a5fa;">${matchup.teamA}</span>
                <span style="color: #94a3b8; font-weight: bold;">vs</span>
                <span style="flex: 1; text-align: left; color: #f59e0b;">${matchup.teamB}</span>
              </div>
            </div>
            <div style="color: #94a3b8; font-size: 0.85em; margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(16, 185, 129, 0.2);">
              ${matchup.description}
            </div>
          </div>
        `).join('')}
      </div>
    </div>
  `;

  out.innerHTML = html;
}

function simulateClassicMatchup(teamAName, teamBName, matchupName) {
  const teamA = TEAM_POOL.find(t => t.name === teamAName);
  const teamB = TEAM_POOL.find(t => t.name === teamBName);

  if (!teamA || !teamB) {
    showUtilityMessage('Team not found in database', 'error');
    return;
  }

  if (window.VERBOSE_LOGGING) console.log(`🎭 Simulating classic matchup: ${matchupName}`);

  try {
    // Close any open modals first
    const modals = document.querySelectorAll('.modal-backdrop.active');
    modals.forEach(modal => modal.classList.remove('active'));

    // Show loading message
    showUtilityMessage(`⚽ Simulating ${matchupName}...`, 'info');

    // Simulate the match directly
    const result = simulateMatch(teamA, teamB, 0, 1.0, 'Clear');

    if (!result || !result.matchId) {
      showUtilityMessage('❌ Failed to simulate match', 'error');
      return;
    }

    // Show success and display results
    setTimeout(() => {
      showUtilityMessage(
        `✅ ${matchupName}: ${teamA.name} ${result.scoreA}-${result.scoreB} ${teamB.name}`,
        'success'
      );

      if (typeof viewMatchDetails === 'function') {
        viewMatchDetails(result.matchId);
      }
    }, 500);

  } catch (error) {
    console.error('Error simulating classic matchup:', error);
    showUtilityMessage('❌ Error: ' + error.message, 'error');
  }
}

// Weather System
function generateWeather() {
  return WEATHER_CONDITIONS[Math.floor(Math.random() * WEATHER_CONDITIONS.length)];
}

function getWeatherModifier(weather) {
  const modifiers = {
    'Clear': 0,
    'Light Rain': -0.02,
    'Heavy Rain': -0.05,
    'Snow': -0.07,
    'Hot': -0.03,
    'Windy': -0.02
  };
  return modifiers[weather] || 0;
}

function getWeatherIcon(weather) {
  const icons = {
    'Clear': '☀️',
    'Light Rain': '🌧️',
    'Heavy Rain': '⛈️',
    'Snow': '❄️',
    'Hot': '🔥',
    'Windy': '💨'
  };
  return icons[weather] || '☀️';
}

// Stadium System
function assignStadium(teamName) {
  const stadiumNames = Object.keys(STADIUMS);
  const randomStadium = stadiumNames[Math.floor(Math.random() * stadiumNames.length)];
  STADIUM_DATABASE[teamName] = randomStadium;
  return randomStadium;
}

function getStadiumAdvantage(teamName, isHome) {
  if (!isHome) return 0;
  const stadiumName = STADIUM_DATABASE[teamName];
  if (!stadiumName) return 0;
  const stadium = STADIUMS[stadiumName];
  return stadium ? stadium.homeAdvantage : 0;
}

// Rivalry System
function checkRivalry(teamA, teamB) {
  for (const [rivalryName, teams] of Object.entries(RIVALRIES)) {
    if ((teams.includes(teamA) && teams.includes(teamB)) ||
        (teamA.includes(teams[0].split(' ')[teams[0].split(' ').length - 1]) &&
         teamB.includes(teams[1].split(' ')[teams[1].split(' ').length - 1]))) {
      return true;
    }
  }
  return false;
}

function getRivalryBonus(teamA, teamB) {
  return checkRivalry(teamA, teamB) ? 0.05 : 0;
}

// Match Prediction System
function predictMatch(teamA, teamB) {
  const strengthDiff = Math.abs(teamA.strength - teamB.strength);
  let confidence;
  let favorite;

  if (strengthDiff < 3) {
    confidence = 55 + Math.random() * 10;
    favorite = teamA.strength > teamB.strength ? teamA.name : teamB.name;
  } else if (strengthDiff < 7) {
    confidence = 65 + Math.random() * 10;
    favorite = teamA.strength > teamB.strength ? teamA.name : teamB.name;
  } else {
    confidence = 75 + Math.random() * 15;
    favorite = teamA.strength > teamB.strength ? teamA.name : teamB.name;
  }

  return {
    favorite,
    confidence: Math.min(95, confidence).toFixed(1)
  };
}

// Player Milestone Notifications
function checkPlayerMilestones(player) {
  const notifications = [];

  if (player.goals === 100) {
    notifications.push({ type: 'milestone', message: `🎯 ${player.name} reaches 100 goals!`, player });
  }
  if (player.assists === 10) {
    notifications.push({ type: 'milestone', message: `🎁 ${player.name} reaches 10 assists!`, player });
  }

  return notifications;
}

function showMilestoneNotification(messageOrMilestones) {
  // Handle both string messages and milestone arrays
  if (Array.isArray(messageOrMilestones)) {
    // Use modal version for milestone arrays (full version at line 20915)
    const modal = document.createElement('div');
    modal.id = 'milestone-modal';
    modal.style.cssText = `
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.85); display: flex; align-items: center;
      justify-content: center; z-index: 10001; animation: fadeIn 0.3s;
    `;

    const content = `
      <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 40px; border-radius: 16px; max-width: 600px; width: 90%; box-shadow: 0 25px 50px rgba(0,0,0,0.5);">
        <h2 style="margin: 0 0 20px 0; color: #ffd700; font-size: 32px; text-align: center; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">
          🏆 MILESTONE ACHIEVED! 🏆
        </h2>
        <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
          ${messageOrMilestones.map(m => `
            <div style="color: white; font-size: 20px; margin: 15px 0; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px; border-left: 4px solid #ffd700;">
              <strong>${m.type || m}</strong>
              ${m.season ? `<div style="font-size: 14px; margin-top: 5px; opacity: 0.9;">Season ${m.season}</div>` : ''}
            </div>
          `).join('')}
        </div>
        <button onclick="closeMilestoneModal()" style="width: 100%; background: #ffd700; color: #1a1a2e; border: none; padding: 16px; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 18px;">
          Continue
        </button>
      </div>
    `;

    modal.innerHTML = content;
    document.body.appendChild(modal);
  } else {
    // Simple notification for string messages
    const notification = document.createElement('div');
    notification.className = 'milestone-notification';
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #10b981, #34d399);
      color: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(16, 185, 129, 0.4);
      z-index: 10000;
      animation: slideIn 0.5s ease-out;
      font-weight: bold;
      font-size: 1.1em;
    `;
    notification.textContent = messageOrMilestones;
    document.body.appendChild(notification);

    setTimeout(() => {
      notification.style.animation = 'slideOut 0.5s ease-out';
      setTimeout(() => notification.remove(), 500);
    }, 3000);
  }
}

// Tournament Templates
function saveTournamentTemplate() {
  if (!window.GROUPS || !window.GROUP_RESULTS) {
    showUtilityMessage('No tournament to save as template', 'info');
    return;
  }

  const templateName = prompt('Enter template name:');
  if (!templateName) return;

  const template = {
    name: templateName,
    teams: Object.keys(window.GROUPS).flatMap(group => window.GROUPS[group]),
    rngSettings: { ...RNG_SETTINGS },
    timestamp: Date.now()
  };

  TOURNAMENT_TEMPLATES.push(template);
  localStorage.setItem('tournamentTemplates', JSON.stringify(TOURNAMENT_TEMPLATES));
  showUtilityMessage('Template saved successfully!', 'success');
}

function loadTournamentTemplate(templateKey) {
  const template = TOURNAMENT_TEMPLATES[templateKey];
  if (!template) {
    console.error('Template not found:', templateKey);
    return;
  }

  showLoading(`Loading ${template.name}...`);

  setTimeout(() => {
    const selectedTeams = [];
    const usedTeamNames = new Set();

    // Step 1: Add all specified historic teams
    template.teams.forEach(teamKey => {
      const historicTeam = findHistoricTeam(teamKey);
      if (historicTeam && !usedTeamNames.has(historicTeam.name)) {
        selectedTeams.push(historicTeam);
        usedTeamNames.add(historicTeam.name);
      }
    });

    // Step 2: Fill remaining slots based on fillWith strategy
    const remaining = template.teamCount - selectedTeams.length;

    if (remaining > 0) {
      let fillPool = [];

      switch(template.fillWith) {
        case 'worldCup':
          fillPool = HISTORIC_TEAMS && HISTORIC_TEAMS.worldCup ? Object.values(HISTORIC_TEAMS.worldCup) : [];
          break;
        case 'championsLeague':
          fillPool = HISTORIC_TEAMS && HISTORIC_TEAMS.championsLeague ? Object.values(HISTORIC_TEAMS.championsLeague) : [];
          break;
        case 'mixed':
          fillPool = [
            ...(HISTORIC_TEAMS && HISTORIC_TEAMS.worldCup ? Object.values(HISTORIC_TEAMS.worldCup) : []),
            ...(HISTORIC_TEAMS && HISTORIC_TEAMS.championsLeague ? Object.values(HISTORIC_TEAMS.championsLeague) : [])
          ];
          break;
        case 'current':
        default:
          fillPool = ALL_TEAMS || [];
          break;
      }

      // Apply filters if specified
      if (template.filters) {
        if (template.filters.strengthRange) {
          const [min, max] = template.filters.strengthRange;
          fillPool = fillPool.filter(t => t.strength >= min && t.strength <= max);
        }
        if (template.filters.country) {
          fillPool = fillPool.filter(t => t.country === template.filters.country);
        }
      }

      // Remove already used teams
      fillPool = fillPool.filter(t => !usedTeamNames.has(t.name));

      // Shuffle and take remaining
      fillPool.sort(() => Math.random() - 0.5);
      const additionalTeams = fillPool.slice(0, remaining);
      selectedTeams.push(...additionalTeams);
    }

    // Validate final count
    if (selectedTeams.length !== template.teamCount) {
      console.warn(`Team count mismatch: expected ${template.teamCount}, got ${selectedTeams.length}`);
      // Adjust if needed
      if (selectedTeams.length < template.teamCount) {
        // Add more random teams
        const moreTeams = (ALL_TEAMS || [])
          .filter(t => !usedTeamNames.has(t.name))
          .sort(() => Math.random() - 0.5)
          .slice(0, template.teamCount - selectedTeams.length);
        selectedTeams.push(...moreTeams);
      } else {
        // Trim excess
        selectedTeams.splice(template.teamCount);
      }
    }

    hideLoading();

    // Start tournament with selected teams
    if (template.format === 'knockout') {
      startKnockoutOnlyWithTeams(selectedTeams, template.name);
    } else {
      startQuickTournamentWithTeams(selectedTeams, template.name);
    }

    showNotification('success', 'Template Loaded!',
      `${template.name} started with ${selectedTeams.length} teams`, 3000);

  }, 800);
}

function findHistoricTeam(teamKey) {
  // Check World Cup teams
  if (HISTORIC_TEAMS && HISTORIC_TEAMS.worldCup && HISTORIC_TEAMS.worldCup[teamKey]) {
    return HISTORIC_TEAMS.worldCup[teamKey];
  }

  // Check Champions League teams
  if (HISTORIC_TEAMS && HISTORIC_TEAMS.championsLeague && HISTORIC_TEAMS.championsLeague[teamKey]) {
    return HISTORIC_TEAMS.championsLeague[teamKey];
  }

  // Try to find by name in ALL_TEAMS
  const team = (ALL_TEAMS || []).find(t => t.name.toLowerCase().includes(teamKey.toLowerCase()));
  return team || null;
}

function startKnockoutOnlyWithTeams(teams, tournamentName) {
  // Initialize tournament tracking
  if (typeof initializeTournamentTracking === 'function') {
    initializeTournamentTracking(tournamentName, teams, 'knockout');
  }

  // Shuffle teams
  teams.sort(() => Math.random() - 0.5);

  // Determine starting round based on team count
  let stage;
  if (teams.length === 32) stage = 'round-of-32';
  else if (teams.length === 16) stage = 'round-of-16';
  else if (teams.length === 8) stage = 'quarter-finals';
  else if (teams.length === 4) stage = 'semi-finals';
  else if (teams.length === 2) stage = 'final';
  else {
    // Pad to nearest power of 2
    const target = [2, 4, 8, 16, 32].find(n => n >= teams.length) || 16;
    const allTeams = window.ALL_TEAMS || window.TEAMS || [];
    while (teams.length < target && allTeams.length > 0) {
      const randomTeam = allTeams[Math.floor(Math.random() * allTeams.length)];
      if (randomTeam && !teams.find(t => t.name === randomTeam.name)) {
        teams.push(randomTeam);
      }
    }
    stage = target === 32 ? 'round-of-32' : target === 16 ? 'round-of-16' : 'quarter-finals';
  }

  // Initialize knockout stage
  if (typeof initializeKnockoutStage === 'function') {
    initializeKnockoutStage(teams, stage, false);
  }

  // Update UI
  if (typeof updateTournamentStage === 'function') {
    updateTournamentStage(stage);
  }

  // Display
  if (typeof displayKnockoutStage === 'function') {
    displayKnockoutStage(stage);
  }
}

function startQuickTournamentWithTeams(teams, tournamentName) {
  // Ensure team count is divisible by 4 for groups
  const groupCount = Math.ceil(teams.length / 4);
  const targetCount = groupCount * 4;

  // Pad with random teams if needed
  const allTeams = window.ALL_TEAMS || window.TEAMS || [];
  while (teams.length < targetCount && allTeams.length > 0) {
    const randomTeam = allTeams[Math.floor(Math.random() * allTeams.length)];
    if (randomTeam && !teams.find(t => t.name === randomTeam.name)) {
      teams.push(randomTeam);
    }
  }

  // Trim if too many
  teams.splice(targetCount);

  // Initialize tournament tracking
  if (typeof initializeTournamentTracking === 'function') {
    initializeTournamentTracking(tournamentName, teams, 'groups');
  }

  // Create groups
  teams.sort(() => Math.random() - 0.5);
  const groups = [];

  for (let i = 0; i < groupCount; i++) {
    const group = teams.slice(i * 4, (i + 1) * 4).map(team => ({
      ...team,
      played: 0,
      wins: 0,
      draws: 0,
      losses: 0,
      goalsFor: 0,
      goalsAgainst: 0,
      points: 0
    }));
    groups.push(group);
  }

  window.GROUPS = groups;

  // Update stage
  if (typeof updateTournamentStage === 'function') {
    updateTournamentStage('groups');
  }

  // Display groups
  if (typeof displayGroups === 'function') {
    displayGroups(groups);
  }
}

function showTemplateManager() {
  if (TOURNAMENT_TEMPLATES.length === 0) {
    showUtilityMessage('No saved templates', 'info');
    return;
  }

  const content = `
    <div style="padding: 20px;">
      <h2 style="margin-bottom: 20px; color: #10b981;">Tournament Templates</h2>
      <div style="display: grid; gap: 10px;">
        ${TOURNAMENT_TEMPLATES.map((template, index) => `
          <div style="padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
            <div>
              <div style="font-weight: bold;">${template.name}</div>
              <div style="color: #94a3b8; font-size: 0.9em;">${template.teams.length} teams</div>
            </div>
            <button onclick="loadTournamentTemplate('${template.name}')" class="btn-secondary">Load</button>
          </div>
        `).join('')}
      </div>
    </div>
  `;

  const modal = document.createElement('div');
  modal.className = 'modal-backdrop active';
  modal.innerHTML = content;
  modal.onclick = (e) => {
    if (e.target === modal) modal.remove();
  };
  document.body.appendChild(modal);
}

// Quick Tournament Mode
function quickTournamentMode() {
  // Prevent duplicate runs
  if (isQuickRunning) {
    console.warn("⚠️ Quick tournament already running - ignored");
    showUtilityMessage("Quick tournament already in progress!", "warning");
    return;
  }

  if (!window.GROUPS) {
    showUtilityMessage('Generate groups first', 'info');
    return;
  }

  isQuickRunning = true;
  const btn = document.getElementById("btnQuickTournament");
  if (btn) btn.disabled = true;

  showUtilityMessage('Running quick tournament...', 'info');

  // Run group stage if not done
  if (!window.GROUP_RESULTS) {
    setTimeout(() => {
      if (typeof runGroupStage === 'function') {
        runGroupStage();

        // Run knockouts after group stage
        setTimeout(() => {
          if (typeof runKnockouts === 'function') {
            runKnockouts();

            // Show highlights after everything
            setTimeout(() => {
              showTournamentHighlights();
              isQuickRunning = false;
              if (btn) btn.disabled = false;
            }, 500);
          }
        }, 500);
      }
    }, 100);
  } else if (!window.TOURNAMENT) {
    // Group stage done, run knockouts
    setTimeout(() => {
      if (typeof runKnockouts === 'function') {
        runKnockouts();

        setTimeout(() => {
          showTournamentHighlights();
          isQuickRunning = false;
          if (btn) btn.disabled = false;
        }, 500);
      }
    }, 100);
  } else {
    // Everything done, just show highlights
    showTournamentHighlights();
    isQuickRunning = false;
    if (btn) btn.disabled = false;
  }
}

function showTournamentHighlights() {
  if (!window.TOURNAMENT) {
    showUtilityMessage('No tournament completed', 'info');
    return;
  }

  const championData = window.TOURNAMENT.champion;
  const championName = championData?.name || championData || 'Unknown';
  const topScorer = getTopScorer();
  const stats = calculateTournamentStats();

  const content = `
    <div style="padding: 30px; text-align: center; background: linear-gradient(135deg, #1e293b, #0f172a); border-radius: 12px;">
      <h1 style="color: #10b981; font-size: 2.5em; margin-bottom: 30px;">🏆 Tournament Complete!</h1>
      <div style="font-size: 1.5em; margin: 20px 0; padding: 15px; background: rgba(251, 191, 36, 0.1); border-radius: 8px; border: 2px solid #fbbf24;">
        <div style="color: #94a3b8; font-size: 0.6em; margin-bottom: 8px;">Champion</div>
        <div style="color: #fbbf24; font-weight: bold;">${championName}</div>
      </div>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 25px;">
        <div style="padding: 15px; background: rgba(59, 130, 246, 0.1); border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.3);">
          <div style="color: #94a3b8; font-size: 0.9em; margin-bottom: 5px;">⚽ Top Scorer</div>
          <div style="color: #e5e7eb; font-weight: 600;">${topScorer ? topScorer.name : 'Unknown'}</div>
          <div style="color: #60a5fa; font-size: 0.9em;">${topScorer ? topScorer.goals + ' goals' : ''}</div>
        </div>
        <div style="padding: 15px; background: rgba(16, 185, 129, 0.1); border-radius: 8px; border: 1px solid rgba(16, 185, 129, 0.3);">
          <div style="color: #94a3b8; font-size: 0.9em; margin-bottom: 5px;">📊 Goals Per Game</div>
          <div style="color: #10b981; font-weight: 600; font-size: 1.2em;">${stats ? stats.goalsPerGame : 'N/A'}</div>
        </div>
        <div style="padding: 15px; background: rgba(245, 158, 11, 0.1); border-radius: 8px; border: 1px solid rgba(245, 158, 11, 0.3);">
          <div style="color: #94a3b8; font-size: 0.9em; margin-bottom: 5px;">🎯 Total Matches</div>
          <div style="color: #f59e0b; font-weight: 600; font-size: 1.2em;">${stats ? stats.totalMatches : 'N/A'}</div>
        </div>
      </div>
      <button onclick="this.closest('.modal-backdrop').remove()"
              style="margin-top: 25px; padding: 12px 24px; background: linear-gradient(135deg, #3b82f6, #2563eb);
                     border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer;
                     transition: all 0.3s;"
              onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.4)'"
              onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
        Close
      </button>
    </div>
  `;

  const modal = document.createElement('div');
  modal.className = 'modal-backdrop active';
  modal.innerHTML = content;
  modal.onclick = (e) => {
    if (e.target === modal) modal.remove();
  };
  document.body.appendChild(modal);
}

// Match Event Timeline
function generateMatchTimeline(matchData) {
  if (!matchData.events) return [];

  return matchData.events.map(event => ({
    minute: event.minute,
    type: event.type,
    player: event.player,
    team: event.team
  }));
}

function showMatchTimeline(matchData) {
  const timeline = generateMatchTimeline(matchData);
  if (timeline.length === 0) {
    showUtilityMessage('No match events available', 'info');
    return;
  }

  const content = `
    <div style="padding: 20px;">
      <h2 style="margin-bottom: 20px; color: #10b981;">Match Timeline</h2>
      <div style="position: relative;">
        ${timeline.map(event => `
          <div style="display: flex; align-items: center; margin: 15px 0; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px;">
            <div style="min-width: 50px; font-weight: bold; color: #fbbf24;">${event.minute}'</div>
            <div style="flex: 1;">
              <div style="font-weight: bold;">${event.player}</div>
              <div style="color: #94a3b8; font-size: 0.9em;">${event.type} - ${event.team}</div>
            </div>
          </div>
        `).join('')}
      </div>
    </div>
  `;

  const modal = document.createElement('div');
  modal.className = 'modal-backdrop active';
  modal.innerHTML = content;
  modal.onclick = (e) => {
    if (e.target === modal) modal.remove();
  };
  document.body.appendChild(modal);
}

// Tournament Comparison Tool
function showTournamentComparison() {
  if (TOURNAMENT_HISTORY.length < 2) {
    showUtilityMessage('Need at least 2 completed tournaments to compare', 'info');
    return;
  }

  const recentTournaments = TOURNAMENT_HISTORY.slice(-5);

  const content = `
    <div style="padding: 30px; max-width: 1000px; margin: 0 auto;">
      <div style="text-align: center; margin-bottom: 30px;">
        <h2 style="color: #10b981; font-size: 2em; margin-bottom: 10px;">🏆 Tournament Comparison</h2>
        <p style="color: #94a3b8; margin: 0;">Showing ${recentTournaments.length} most recent tournaments (${TOURNAMENT_HISTORY.length} total)</p>
      </div>

      <table style="width: 100%; border-collapse: collapse; background: rgba(15, 23, 42, 0.6); border-radius: 12px; overflow: hidden;">
        <thead>
          <tr style="background: rgba(16, 185, 129, 0.2);">
            <th style="padding: 15px; text-align: left; color: #10b981; font-weight: 600;">#</th>
            <th style="padding: 15px; text-align: left; color: #10b981; font-weight: 600;">Champion</th>
            <th style="padding: 15px; text-align: center; color: #10b981; font-weight: 600;">Season</th>
            <th style="padding: 15px; text-align: center; color: #10b981; font-weight: 600;">Avg Goals</th>
            <th style="padding: 15px; text-align: center; color: #10b981; font-weight: 600;">Top Scorer</th>
          </tr>
        </thead>
        <tbody>
          ${recentTournaments.map((tournament, index) => {
            const tournamentNum = TOURNAMENT_HISTORY.length - recentTournaments.length + index + 1;
            return `
            <tr style="border-bottom: 1px solid rgba(255,255,255,0.1); transition: background 0.2s;"
                onmouseover="this.style.background='rgba(16, 185, 129, 0.1)'"
                onmouseout="this.style.background='transparent'">
              <td style="padding: 15px; color: #94a3b8; font-weight: 600;">${tournamentNum}</td>
              <td style="padding: 15px; color: #fbbf24; font-weight: 600;">${tournament.champion || 'Unknown'}</td>
              <td style="padding: 15px; text-align: center; color: #60a5fa;">${tournament.season || 'N/A'}</td>
              <td style="padding: 15px; text-align: center; color: #10b981; font-weight: 600;">${tournament.avgGoals || 'N/A'}</td>
              <td style="padding: 15px; text-align: center; color: #e879f9;">${tournament.topScorer || 'Unknown'}</td>
            </tr>
          `;
          }).join('')}
        </tbody>
      </table>

      <div style="text-align: center; margin-top: 20px;">
        <button onclick="this.closest('.modal-backdrop').remove()"
                style="padding: 12px 30px; background: #10b981; color: white; border: none; border-radius: 8px;
                       font-weight: 600; cursor: pointer; transition: all 0.2s;"
                onmouseover="this.style.background='#059669'"
                onmouseout="this.style.background='#10b981'">
          Close
        </button>
      </div>
    </div>
  `;

  const modal = document.createElement('div');
  modal.className = 'modal-backdrop active';
  modal.innerHTML = content;
  modal.onclick = (e) => {
    if (e.target === modal) modal.remove();
  };
  document.body.appendChild(modal);
}

// Top Performers Carousel
function showTopPerformersCarousel() {
  const out = document.getElementById('output');
  if (!out) return;

  if (!PLAYER_DB || Object.keys(PLAYER_DB).length === 0) {
    out.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">⭐</div>
        <h2>No Player Data</h2>
        <p class="output-sub">Complete matches to see top performers.</p>
      </div>
    `;
    return;
  }

  const players = Object.values(PLAYER_DB).sort((a, b) => b.goals - a.goals).slice(0, 10);

  let html = `
    <div style="margin-bottom: 20px;">
      <h2 style="color: #10b981;">⭐ Top Performers</h2>
    </div>
    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px;">
      ${players.map((player, index) => `
        <div class="performer-card card-reveal" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(59, 130, 246, 0.1)); padding: 20px; border-radius: 12px; border: 1px solid rgba(16, 185, 129, 0.3); position: relative;">
          <div style="position: absolute; top: 10px; right: 10px; background: rgba(251, 191, 36, 0.2); color: #fbbf24; padding: 4px 12px; border-radius: 20px; font-weight: bold; font-size: 0.9em;">
            #${index + 1}
          </div>
          <div style="text-align: center; margin-bottom: 15px;">
            <div style="font-size: 3em; margin-bottom: 10px;">⚽</div>
            <div style="font-weight: bold; font-size: 1.2em; margin-bottom: 4px; color: #e5e7eb;">${player.name}</div>
            <div style="color: #94a3b8; font-size: 0.9em;">${player.team}</div>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; padding-top: 15px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
            <div style="text-align: center;">
              <div style="font-size: 1.8em; font-weight: bold; color: #10b981;">${player.goals || 0}</div>
              <div style="font-size: 0.75em; color: #94a3b8;">Goals</div>
            </div>
            <div style="text-align: center;">
              <div style="font-size: 1.8em; font-weight: bold; color: #3b82f6;">${player.assists || 0}</div>
              <div style="font-size: 0.75em; color: #94a3b8;">Assists</div>
            </div>
            <div style="text-align: center;">
              <div style="font-size: 1.8em; font-weight: bold; color: #fbbf24;">${player.apps || 0}</div>
              <div style="font-size: 0.75em; color: #94a3b8;">Apps</div>
            </div>
          </div>
        </div>
      `).join('')}
    </div>
  `;

  out.innerHTML = html;
  console.log('✅ Top performers displayed');
}

// Interactive Bracket Zoom
function makeBracketZoomable() {
  const bracketElements = document.querySelectorAll('.bracket-match, .match-card');

  bracketElements.forEach(element => {
    element.classList.add('bracket-zoomable');

    element.addEventListener('click', function() {
      const clone = this.cloneNode(true);
      clone.classList.remove('bracket-zoomable');
      clone.classList.add('bracket-zoomed');

      const overlay = document.createElement('div');
      overlay.className = 'modal-backdrop active';
      overlay.appendChild(clone);

      overlay.onclick = (e) => {
        if (e.target === overlay || e.target === clone) {
          overlay.remove();
        }
      };

      document.body.appendChild(overlay);
    });
  });
}

// Live Match Simulation Mode
let liveMatchState = {
  isRunning: false,
  isPaused: false,
  currentMinute: 0,
  scoreA: 0,
  scoreB: 0,
  events: [],
  interval: null
};

function startLiveMatchSimulation(teamA, teamB) {
  if (!teamA || !teamB) {
    showUtilityMessage('Select teams first', 'error');
    return;
  }

  liveMatchState = {
    isRunning: true,
    isPaused: false,
    currentMinute: 0,
    scoreA: 0,
    scoreB: 0,
    events: [],
    interval: null,
    teamA: teamA,
    teamB: teamB
  };

  const content = `
    <div class="live-match-container" id="liveMatchContainer">
      <h2 style="text-align: center; color: #10b981; margin-bottom: 20px;">Live Match Simulation</h2>
      <div style="display: flex; justify-content: space-around; align-items: center; margin: 30px 0;">
        <div style="text-align: center; flex: 1;">
          <div style="font-size: 1.5em; font-weight: bold;">${teamA.name}</div>
        </div>
        <div class="live-score" id="liveScore">
          <span id="scoreA">0</span> - <span id="scoreB">0</span>
        </div>
        <div style="text-align: center; flex: 1;">
          <div style="font-size: 1.5em; font-weight: bold;">${teamB.name}</div>
        </div>
      </div>
      <div style="text-align: center; font-size: 1.2em; color: #fbbf24; margin: 20px 0;">
        <span id="currentMinute">0</span>' / 90'
      </div>
      <div class="match-controls">
        <button class="control-btn-sim" onclick="pauseLiveMatch()">⏸️ Pause</button>
        <button class="control-btn-sim" onclick="resumeLiveMatch()">▶️ Resume</button>
        <button class="control-btn-sim" onclick="stopLiveMatch()">⏹️ Stop</button>
      </div>
      <div id="liveEvents" style="margin-top: 30px; max-height: 300px; overflow-y: auto;">
        <h3 style="color: #10b981;">Match Events:</h3>
      </div>
    </div>
  `;

  const modal = document.createElement('div');
  modal.className = 'modal-backdrop active';
  modal.id = 'liveMatchModal';
  modal.innerHTML = content;
  document.body.appendChild(modal);

  startLiveMatchInterval();
}

function startLiveMatchInterval() {
  liveMatchState.interval = setInterval(() => {
    if (!liveMatchState.isPaused && liveMatchState.currentMinute < 90) {
      liveMatchState.currentMinute++;
      document.getElementById('currentMinute').textContent = liveMatchState.currentMinute;

      if (Math.random() < 0.05) {
        const scoringTeam = Math.random() < 0.5 ? 'A' : 'B';
        if (scoringTeam === 'A') {
          liveMatchState.scoreA++;
          document.getElementById('scoreA').textContent = liveMatchState.scoreA;
          addLiveEvent(liveMatchState.currentMinute, `⚽ GOAL! ${liveMatchState.teamA.name} scores!`, 'goal');
        } else {
          liveMatchState.scoreB++;
          document.getElementById('scoreB').textContent = liveMatchState.scoreB;
          addLiveEvent(liveMatchState.currentMinute, `⚽ GOAL! ${liveMatchState.teamB.name} scores!`, 'goal');
        }
      }
    } else if (liveMatchState.currentMinute >= 90) {
      stopLiveMatch();
    }
  }, 200);
}

function addLiveEvent(minute, text, type) {
  const eventsContainer = document.getElementById('liveEvents');
  const event = document.createElement('div');
  event.className = 'timeline-event';
  event.innerHTML = `
    <div style="display: flex; justify-content: space-between; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px; margin: 10px 0;">
      <span style="color: #fbbf24; font-weight: bold;">${minute}'</span>
      <span style="flex: 1; margin-left: 15px;">${text}</span>
    </div>
  `;
  eventsContainer.appendChild(event);
  eventsContainer.scrollTop = eventsContainer.scrollHeight;

  if (type === 'goal') {
    const scoreDisplay = document.getElementById('liveScore');
    scoreDisplay.classList.add('goal-celebration');
    setTimeout(() => scoreDisplay.classList.remove('goal-celebration'), 600);
  }
}

function pauseLiveMatch() {
  liveMatchState.isPaused = true;
}

function resumeLiveMatch() {
  liveMatchState.isPaused = false;
}

function stopLiveMatch() {
  if (liveMatchState.interval) {
    clearInterval(liveMatchState.interval);
  }
  liveMatchState.isRunning = false;

  addLiveEvent(90, '⏹️ Full Time!', 'fulltime');

  setTimeout(() => {
    const modal = document.getElementById('liveMatchModal');
    if (modal) modal.remove();
    showUtilityMessage('Match simulation complete!', 'success');
  }, 2000);
}

// Formation/Tactics Selection
let selectedFormations = {
  teamA: '4-4-2',
  teamB: '4-4-2'
};

function showFormationSelector(teamA, teamB, callback) {
  const content = `
    <div style="padding: 30px;">
      <h2 style="text-align: center; color: #10b981; margin-bottom: 30px;">Select Formations</h2>

      <div style="margin-bottom: 30px;">
        <h3 style="color: #10b981; margin-bottom: 15px;">${teamA.name}</h3>
        <div class="formation-selector" id="formationA">
          ${Object.entries(FORMATIONS).map(([key, formation]) => `
            <div class="formation-option ${key === '4-4-2' ? 'selected' : ''}"
                 onclick="selectFormation('A', '${key}')">
              <div style="font-size: 1.5em; font-weight: bold; margin-bottom: 8px;">${formation.name}</div>
              <div style="font-size: 0.85em; color: #94a3b8;">${formation.description}</div>
              <div style="margin-top: 10px; font-size: 0.9em;">
                <span style="color: ${formation.attackBonus > 0 ? '#10b981' : formation.attackBonus < 0 ? '#ef4444' : '#94a3b8'};">
                  ATK: ${formation.attackBonus > 0 ? '+' : ''}${(formation.attackBonus * 100).toFixed(0)}%
                </span>
                <span style="margin-left: 10px; color: ${formation.defenseBonus > 0 ? '#10b981' : formation.defenseBonus < 0 ? '#ef4444' : '#94a3b8'};">
                  DEF: ${formation.defenseBonus > 0 ? '+' : ''}${(formation.defenseBonus * 100).toFixed(0)}%
                </span>
              </div>
            </div>
          `).join('')}
        </div>
      </div>

      <div style="margin-bottom: 30px;">
        <h3 style="color: #10b981; margin-bottom: 15px;">${teamB.name}</h3>
        <div class="formation-selector" id="formationB">
          ${Object.entries(FORMATIONS).map(([key, formation]) => `
            <div class="formation-option ${key === '4-4-2' ? 'selected' : ''}"
                 onclick="selectFormation('B', '${key}')">
              <div style="font-size: 1.5em; font-weight: bold; margin-bottom: 8px;">${formation.name}</div>
              <div style="font-size: 0.85em; color: #94a3b8;">${formation.description}</div>
              <div style="margin-top: 10px; font-size: 0.9em;">
                <span style="color: ${formation.attackBonus > 0 ? '#10b981' : formation.attackBonus < 0 ? '#ef4444' : '#94a3b8'};">
                  ATK: ${formation.attackBonus > 0 ? '+' : ''}${(formation.attackBonus * 100).toFixed(0)}%
                </span>
                <span style="margin-left: 10px; color: ${formation.defenseBonus > 0 ? '#10b981' : formation.defenseBonus < 0 ? '#ef4444' : '#94a3b8'};">
                  DEF: ${formation.defenseBonus > 0 ? '+' : ''}${(formation.defenseBonus * 100).toFixed(0)}%
                </span>
              </div>
            </div>
          `).join('')}
        </div>
      </div>

      <div style="text-align: center;">
        <button class="control-btn-sim" onclick="confirmFormations(); ${callback ? callback + '()' : ''}">
          ✓ Confirm Formations
        </button>
      </div>
    </div>
  `;

  const modal = document.createElement('div');
  modal.className = 'modal-backdrop active';
  modal.id = 'formationModal';
  modal.innerHTML = content;
  document.body.appendChild(modal);
}

function selectFormation(team, formationKey) {
  selectedFormations[`team${team}`] = formationKey;

  const container = document.getElementById(`formation${team}`);
  const options = container.querySelectorAll('.formation-option');
  options.forEach(option => option.classList.remove('selected'));

  event.target.closest('.formation-option').classList.add('selected');
}

function confirmFormations() {
  const modal = document.getElementById('formationModal');
  if (modal) modal.remove();
  showUtilityMessage('Formations selected!', 'success');
}

function getFormationBonus(formationType, bonusType) {
  const formation = FORMATIONS[formationType];
  if (!formation) return 0;
  return bonusType === 'attack' ? formation.attackBonus : formation.defenseBonus;
}

function calculateTacticalAdvantage(formationA, formationB, attackBonusA, defenseBonusA, attackBonusB, defenseBonusB) {
  // Calculate net tactical advantage
  const teamAAttackAdvantage = attackBonusA - defenseBonusB;
  const teamBAttackAdvantage = attackBonusB - defenseBonusA;

  const netAdvantage = (teamAAttackAdvantage + defenseBonusA) - (teamBAttackAdvantage + defenseBonusB);

  let advantage = 'Balanced';
  let advantageTeam = null;
  let advantagePercent = 0;

  if (Math.abs(netAdvantage) > 0.05) {
    advantageTeam = netAdvantage > 0 ? 'A' : 'B';
    advantagePercent = Math.abs(netAdvantage * 100);
    advantage = `Team ${advantageTeam} +${advantagePercent.toFixed(0)}%`;
  }

  return {
    advantage,
    advantageTeam,
    advantagePercent,
    teamAOffensive: attackBonusA > 0,
    teamBOffensive: attackBonusB > 0,
    teamADefensive: defenseBonusA > 0,
    teamBDefensive: defenseBonusB > 0
  };
}

function assignIntelligentFormation(team) {
  // Assign formation based on team strength and playing style
  const strength = team.strength || 75;

  // Strong teams (85+) prefer attacking formations
  if (strength >= 85) {
    return Math.random() < 0.6 ? '4-3-3' : '4-4-2';
  }
  // Mid-tier teams (75-84) use balanced formations
  else if (strength >= 75) {
    return '4-4-2';
  }
  // Weaker teams (below 75) prefer defensive formations
  else {
    return Math.random() < 0.7 ? '5-3-2' : '4-4-2';
  }
}

function assignFormationsToAllTeams(teams) {
  // Assign intelligent formations to all teams in tournament
  if (!Array.isArray(teams)) return;

  teams.forEach(team => {
    if (!team.formation) {
      team.formation = assignIntelligentFormation(team);
    }
  });

  console.log('✅ Formations assigned to all teams');
}

/************* RESET LOGIC *************/
// performReset and restoreFromBackup are defined later in the file

/************* VIEW OPENERS *************/

/************* MODAL HELPERS *************/
function hideModal(id) {
  const el = document.getElementById(id);
  if (el) el.classList.remove("active");
}

// Removed duplicate: function openCustomMatch - see later definition

function closeCustomMatch() {
  if (window.VERBOSE_LOGGING) console.log("Closing custom match modal");
  const modal = document.getElementById("customMatchModal");
  if (modal) {
    modal.classList.remove("active");
    modal.style.display = "none";
  }
}

// Manager Edit Modal Functions
function openManagerEditModal() {
  if (window.VERBOSE_LOGGING) console.log('👤 Opening manager edit modal...');
  const modal = document.getElementById("managerEditModal");
  const input = document.getElementById("managerNameInput");
  const teamSelect = document.getElementById("managerFavoriteTeamSelect");

  if (!modal) {
    console.error('❌ managerEditModal element not found');
    showUtilityMessage('Manager edit modal not found', 'error');
    return;
  }

  // Set manager name
  if (input) {
    input.value = MANAGER_PROFILE.name || "";
    console.log('✅ Set input value to:', MANAGER_PROFILE.name);
  } else {
    console.warn('⚠️ managerNameInput not found');
  }

  // Populate team dropdown
  if (teamSelect) {
    teamSelect.innerHTML = '<option value="">-- No team selected --</option>';

    // Use TEAM_POOL to populate options
    const teams = window.TEAM_POOL || [];
    if (teams.length > 0) {
      teams.forEach(team => {
        if (team && team.name) {
          const option = document.createElement("option");
          option.value = team.name;
          option.textContent = team.name;
          teamSelect.appendChild(option);
        }
      });

      // Set current favorite team if exists
      const currentTeam = MANAGER_PROFILE.favoriteTeam || MANAGER_PROFILE.predictedWinner;
      if (currentTeam) {
        teamSelect.value = currentTeam;
        console.log('✅ Set favorite team to:', currentTeam);
      }
      console.log('✅ Populated', teams.length, 'teams in dropdown');
    } else {
      console.warn('⚠️ No teams available in TEAM_POOL');
    }
  } else {
    console.warn('⚠️ managerFavoriteTeamSelect not found');
  }

  // Ensure modal backdrop is visible
  modal.classList.add("active");
  modal.style.display = "flex";
  modal.style.zIndex = "10000";
  modal.style.opacity = "1";
  modal.style.visibility = "visible";

  // Ensure inner modal content is also visible
  const innerModal = modal.querySelector('.modal');
  if (innerModal) {
    innerModal.style.display = "block";
    innerModal.style.opacity = "1";
    innerModal.style.visibility = "visible";
  }

  console.log('✅ Manager edit modal opened');
}

function closeManagerEditModal() {
  const modal = document.getElementById("managerEditModal");
  if (modal) {
    modal.classList.remove("active");
    modal.style.display = "none";
  }
}

function saveManagerEdits() {
  const input = document.getElementById("managerNameInput");
  const teamSelect = document.getElementById("managerFavoriteTeamSelect");
  const name = input ? input.value.trim() : "";

  if (name) {
    MANAGER_PROFILE.name = name;

    // Save favorite team selection if changed
    if (teamSelect) {
      const selectedTeam = teamSelect.value;
      if (selectedTeam) {
        MANAGER_PROFILE.favoriteTeam = selectedTeam;
        console.log('✅ Favorite team set to:', selectedTeam);
      } else {
        // Clear favorite team if "No team selected" is chosen
        MANAGER_PROFILE.favoriteTeam = null;
        console.log('✅ Favorite team cleared');
      }
    }

    saveManagerProfile();
    updateManagerProfileUI();
    closeManagerEditModal();
    showUtilityMessage("Manager profile updated!", "success");
  } else {
    showUtilityMessage("Please enter a name", "error");
  }
}

// Tracked Team Functions
function getTrackedTeamName() {
  return MANAGER_PROFILE.favoriteTeam || MANAGER_PROFILE.predictedWinner;
}

function matchInvolvesTrackedTeam(match) {
  const tracked = getTrackedTeamName();
  if (!tracked) return false;
  return match.teamA?.name === tracked || match.teamB?.name === tracked;
}

function showTrackTeamModal() {
  if (window.VERBOSE_LOGGING) console.log('🎯 Opening track team modal...');
  const modal = document.getElementById("trackTeamModal");
  const select = document.getElementById("trackTeamSelect");

  if (!modal) {
    console.error('❌ trackTeamModal element not found');
    showUtilityMessage('Track team modal not found', 'error');
    return;
  }

  if (!select) {
    console.error('❌ trackTeamSelect element not found');
    showUtilityMessage('Track team select not found', 'error');
    return;
  }

  select.innerHTML = '<option value="">-- Select a team --</option>';

  // Use DRAWN_TEAMS if available, otherwise use all teams from TEAM_POOL
  let teams = window.DRAWN_TEAMS || [];
  if (window.VERBOSE_LOGGING) console.log(`📊 DRAWN_TEAMS has ${teams.length} teams`);

  // If no drawn teams yet, use full team pool
  if (teams.length === 0) {
    teams = window.TEAM_POOL || [];
    if (window.VERBOSE_LOGGING) console.log(`📊 TEAM_POOL has ${teams.length} teams`);

    if (teams.length === 0) {
      console.warn('⚠️ No teams available in TEAM_POOL or DRAWN_TEAMS');
      select.innerHTML = '<option value="">No teams available - please load team data</option>';
    } else {
      console.log(`✅ Populating with ${teams.length} teams from TEAM_POOL`);
      // Populate with all available teams
      teams.forEach(team => {
        if (team && team.name) {
          const option = document.createElement("option");
          option.value = team.name;
          option.textContent = team.name;
          select.appendChild(option);
        }
      });
      console.log(`✅ Added ${select.options.length - 1} teams to dropdown`);
    }
  } else {
    console.log(`✅ Populating with ${teams.length} drawn teams`);
    // Populate with drawn teams
    teams.forEach(team => {
      if (team && team.name) {
        const option = document.createElement("option");
        option.value = team.name;
        option.textContent = team.name;
        select.appendChild(option);
      }
    });
    console.log(`✅ Added ${select.options.length - 1} teams to dropdown`);
  }

  // Open modal with immediate display (no animation)
  modal.classList.add("active");
  modal.style.display = "flex";
  modal.style.zIndex = "10000";
  modal.style.opacity = "1";
  modal.style.visibility = "visible";

  // Ensure inner modal content is also visible
  const innerModal = modal.querySelector('.modal');
  if (innerModal) {
    innerModal.style.display = "block";
    innerModal.style.opacity = "1";
    innerModal.style.visibility = "visible";
  }

  console.log('✅ Track team modal opened with', select.options.length - 1, 'team options');
}

function closeTrackTeamModal() {
  const modal = document.getElementById("trackTeamModal");
  if (modal) {
    modal.classList.remove("active");
    modal.style.display = "none";
  }
}

function confirmTrackedTeam() {
  const select = document.getElementById("trackTeamSelect");
  const teamName = select ? select.value : "";

  if (teamName) {
    MANAGER_PROFILE.favoriteTeam = teamName;
    saveManagerProfile();
    updateManagerProfileUI();
    closeTrackTeamModal();
    showUtilityMessage(`Now tracking ${teamName}!`, "success");
  } else {
    showUtilityMessage("Please select a team", "error");
  }
}

function closeAllModals() {
  if (window.VERBOSE_LOGGING) console.log("Closing all modals");
  document.querySelectorAll(".modal-backdrop").forEach((el) => {
    el.classList.remove("active");
    el.style.display = "none";
  });
}

/************* ADVANCED FILTERING & SEARCH *************/

// Filter track team options
function filterTrackTeamOptions(searchTerm) {
  const select = document.getElementById("trackTeamSelect");
  if (!select) return;

  const options = select.querySelectorAll('option');
  searchTerm = searchTerm.toLowerCase();

  options.forEach(option => {
    if (option.value === '') {
      option.style.display = ''; // Always show "Select a team" option
      return;
    }

    const optionText = option.textContent.toLowerCase();
    const matches = optionText.includes(searchTerm);
    option.style.display = matches ? '' : 'none';
  });
}

// Filter custom match teams
function filterCustomMatchTeams(searchTerm) {
  const selectA = document.getElementById("customTeamA");
  const selectB = document.getElementById("customTeamB");
  if (!selectA || !selectB) return;

  searchTerm = searchTerm.toLowerCase();

  [selectA, selectB].forEach(select => {
    const options = select.querySelectorAll('option');
    options.forEach(option => {
      const optionText = option.textContent.toLowerCase();
      const matches = optionText.includes(searchTerm);
      option.style.display = matches ? '' : 'none';
    });
  });
}

// Filter manager favorite teams
function filterManagerFavoriteTeams(searchTerm) {
  const select = document.getElementById("managerFavoriteTeamSelect");
  if (!select) return;

  const options = select.querySelectorAll('option');
  searchTerm = searchTerm.toLowerCase();

  options.forEach(option => {
    if (option.value === '') {
      option.style.display = ''; // Always show "No team selected" option
      return;
    }

    const optionText = option.textContent.toLowerCase();
    const matches = optionText.includes(searchTerm);
    option.style.display = matches ? '' : 'none';
  });
}

/************* CUSTOM MATCH ENHANCEMENTS *************/

// Update custom match importance label
function updateCustomImportanceLabel(value) {
  const v = parseFloat(value);
  const label = document.getElementById('customImportanceLabel');
  if (!label) return;

  let text = 'Normal';
  let color = '#3b82f6';

  if (v <= 0.75) {
    text = 'Friendly';
    color = '#10b981';
  } else if (v <= 1.25) {
    text = 'Normal';
    color = '#3b82f6';
  } else if (v <= 1.75) {
    text = 'Important';
    color = '#f59e0b';
  } else if (v <= 2.25) {
    text = 'Critical';
    color = '#ef4444';
  } else {
    text = 'Final';
    color = '#8b5cf6';
  }

  label.textContent = text;
  label.style.color = color;
}

// Simulate match with weather effects
function simulateMatchWithWeather(teamA, teamB, isHome, importance, weather) {
  // Apply weather modifiers
  const weatherEffects = {
    clear: { chaos: 1.0, description: 'Perfect conditions' },
    rainy: { chaos: 1.2, description: 'Slippery pitch, slower play' },
    windy: { chaos: 1.4, description: 'Unpredictable ball movement' },
    snowy: { chaos: 1.6, description: 'Very difficult conditions' },
    hot: { chaos: 1.1, description: 'Players tire faster' }
  };

  const effect = weatherEffects[weather] || weatherEffects.clear;
  const adjustedImportance = importance * effect.chaos;

  if (window.VERBOSE_LOGGING) console.log(`🌤️ ${effect.description} (chaos: ${effect.chaos}x)`);

  // Use existing simulateMatch function with adjusted parameters
  const result = simulateMatch(teamA, teamB, isHome, adjustedImportance, weather);

  // Add weather info to result
  if (result && result.matchId) {
    const matchDetails = MATCH_DETAILS_DB[result.matchId];
    if (matchDetails) {
      matchDetails.weather = weather;
      matchDetails.weatherDescription = effect.description;
    }
  }

  return result;
}

/************* SIMULATION SPEED CONTROL *************/

function updateSimSpeed(value) {
  const v = parseInt(value);
  SIM_SPEED_SETTINGS.current = v;

  const labels = ['Instant', 'Fast', 'Normal', 'Slow'];
  const label = document.getElementById('simSpeedLabel');
  if (label) {
    label.textContent = labels[v] || 'Normal';
  }

  // Update button active state
  document.querySelectorAll('.rng-pill[data-speed-value]').forEach(btn => {
    const btnValue = parseInt(btn.getAttribute('data-speed-value'));
    if (btnValue === v) {
      btn.classList.add('active');
    } else {
      btn.classList.remove('active');
    }
  });

  // Save to localStorage
  try {
    localStorage.setItem('simSpeed', v.toString());
    if (window.VERBOSE_LOGGING) console.log(`⚡ Simulation speed set to: ${labels[v]} (${SIM_SPEED_SETTINGS.speeds[v]}ms)`);
  } catch (e) {
    console.error('Failed to save simulation speed:', e);
  }
}

function initializeSimSpeed() {
  try {
    const saved = localStorage.getItem('simSpeed');
    if (saved !== null) {
      const v = parseInt(saved);
      if (v >= 0 && v <= 3) {
        SIM_SPEED_SETTINGS.current = v;
        const slider = document.getElementById('simSpeedSlider');
        if (slider) slider.value = v;
        updateSimSpeed(v);
      }
    }
  } catch (e) {
    console.error('Failed to load simulation speed:', e);
  }

  // Setup button click handlers
  document.querySelectorAll('.rng-pill[data-speed-value]').forEach(btn => {
    btn.addEventListener('click', () => {
      const v = parseInt(btn.getAttribute('data-speed-value'));
      const slider = document.getElementById('simSpeedSlider');
      if (slider) slider.value = v;
      updateSimSpeed(v);
    });
  });
}

// Helper function to get current delay
function getSimDelay() {
  return SIM_SPEED_SETTINGS.speeds[SIM_SPEED_SETTINGS.current] || 200;
}

// Helper function for async delays in simulation
function simDelay() {
  const delay = getSimDelay();
  return delay > 0 ? new Promise(resolve => setTimeout(resolve, delay)) : Promise.resolve();
}

/************* PLAYER FUNCTIONS *************/

/************* CUSTOM MATCH FUNCTIONS *************/

function simulateCustomMatch() {
  const teamAName = document.getElementById('customTeamA')?.value;
  const teamBName = document.getElementById('customTeamB')?.value;

  if (!teamAName || !teamBName) {
    showUtilityMessage('Please select both teams', 'warning');
    return;
  }

  if (teamAName === teamBName) {
    showUtilityMessage('Please select different teams', 'warning');
    return;
  }

  // Try to find teams from DRAWN_TEAMS or fallback to TEAM_POOL
  const availableTeams = window.DRAWN_TEAMS || TEAM_POOL || [];
  const teamA = availableTeams.find(t => t.name === teamAName);
  const teamB = availableTeams.find(t => t.name === teamBName);

  if (!teamA || !teamB) {
    showUtilityMessage('Teams not found', 'error');
    return;
  }

  if (window.VERBOSE_LOGGING) console.log(`🎮 Simulating custom match: ${teamA.name} vs ${teamB.name}`);

  try {
    // Close the modal first
    closeCustomMatch();

    // Show loading message
    showUtilityMessage('⚽ Simulating custom match...', 'info');

    // Store for rematch feature
    window.LAST_CUSTOM_MATCH = {
      teamA: teamA,
      teamB: teamB
    };

    // Get venue setting
    const venueRadios = document.getElementsByName('customVenue');
    let isHome = 0;
    for (const radio of venueRadios) {
      if (radio.checked) {
        if (radio.value === 'homeA') isHome = 1;
        else if (radio.value === 'homeB') isHome = -1;
      }
    }

    // Get weather setting
    const weatherRadios = document.getElementsByName('customWeather');
    let weather = 'clear';
    for (const radio of weatherRadios) {
      if (radio.checked) {
        weather = radio.value;
      }
    }

    // Get match importance
    const importanceSlider = document.getElementById('customImportance');
    const importance = importanceSlider ? parseFloat(importanceSlider.value) : 1.5;

    if (window.VERBOSE_LOGGING) console.log(`🌤️ Weather: ${weather}, 📊 Importance: ${importance}`);

    // Simulate the match with custom settings
    const result = simulateMatchWithWeather(teamA, teamB, isHome, importance, weather);

    if (!result || !result.matchId) {
      showUtilityMessage('❌ Failed to simulate match', 'error');
      return;
    }

    console.log('✅ Custom match simulated:', result);

    // Show success message and match details
    setTimeout(() => {
      showUtilityMessage(
        `✅ Match complete: ${teamA.name} ${result.scoreA}-${result.scoreB} ${teamB.name}`,
        'success'
      );

      // Display the match details
      if (typeof viewMatchDetails === 'function') {
        viewMatchDetails(result.matchId);
      }
    }, 500);

  } catch (error) {
    console.error('Error simulating custom match:', error);
    showUtilityMessage('❌ Error simulating match: ' + error.message, 'error');
  }
}
function simulateRematch() {
  if (!window.LAST_CUSTOM_MATCH) {
    showUtilityMessage('No previous match to rematch', 'warning');
    return;
  }

  const { teamA, teamB, matchType } = window.LAST_CUSTOM_MATCH;
  
  if (window.VERBOSE_LOGGING) console.log(`🔄 Simulating rematch: ${teamA.name} vs ${teamB.name}`);
  
  try {
    showUtilityMessage('⚽ Simulating rematch...', 'info');
    
    const result = simulateMatch(teamA, teamB, 1, `Rematch (${matchType})`, 1);
    
    if (!result || !result.matchId) {
      showUtilityMessage('❌ Failed to simulate rematch', 'error');
      return;
    }

    setTimeout(() => {
      showUtilityMessage(
        `✅ Rematch complete: ${teamA.name} ${result.scoreA}-${result.scoreB} ${teamB.name}`,
        'success'
      );
      viewMatchDetails(result.matchId);
    }, 500);

  } catch (error) {
    console.error('Error simulating rematch:', error);
    showUtilityMessage('❌ Error: ' + error.message, 'error');
  }
}

// Removed duplicate: function saveCustomMatch - see later definition

// Removed duplicate: function shareMatchResult - see later definition

function showShareModal(text) {
  const modal = document.createElement('div');
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  `;

  modal.innerHTML = `
    <div style="background: linear-gradient(135deg, #1e293b, #0f172a); padding: 25px; border-radius: 12px; max-width: 500px; width: 90%; border: 2px solid #3b82f6;">
      <h3 style="margin: 0 0 15px 0; color: #60a5fa;">📋 Match Result</h3>
      <textarea readonly style="width: 100%; height: 200px; padding: 10px; background: #0f172a; border: 1px solid #475569; border-radius: 6px; color: white; font-family: monospace; font-size: 0.9em; resize: none;">${text}</textarea>
      <div style="display: flex; gap: 10px; margin-top: 15px; justify-content: flex-end;">
        <button onclick="this.closest('div').parentElement.remove()" class="btn-secondary" style="padding: 10px 20px;">
          Close
        </button>
        <button onclick="navigator.clipboard.writeText(\`${text.replace(/`/g, '\\`')}\`).then(() => { showUtilityMessage('✅ Copied!', 'success'); this.closest('div').parentElement.remove(); })" class="btn-primary" style="padding: 10px 20px;">
          📋 Copy
        </button>
      </div>
    </div>
  `;

  document.body.appendChild(modal);
}

// Removed duplicate: function updateTeamComparison - see later definition
/************* EXPORT / BACKUP FUNCTIONS *************/
// backupToLocalStorage and restorePreResetBackup are defined later in the file

/************* THEME & BUTTON STATE *************/
function initializeTheme() {
  if (window.VERBOSE_LOGGING) console.log("Initializing theme...");

  const stored = localStorage.getItem("allTimeSimTheme");
  const prefersLight = window.matchMedia &&
    window.matchMedia("(prefers-color-scheme: light)").matches;

  const body = document.body;
  const theme = stored || (prefersLight ? "light" : "dark");

  if (theme === "light") {
    body.classList.add("light");
  } else {
    body.classList.remove("light");
  }

  const toggleBtn = document.getElementById("themeToggle");
  if (toggleBtn) {
    // You can customize this text further if you like
    toggleBtn.textContent = "🌙 Dark / ☀️ Light";
  }
}
function updateButtonStatesEnhanced() {
  const hasGroups = window.GROUPS && window.GROUPS.length > 0;
  const hasGroupResults = window.GROUP_RESULTS && Object.keys(window.GROUP_RESULTS).length > 0;
  const hasKnockouts = window.TOURNAMENT && window.TOURNAMENT.champion;
  
  // Step 1: Generate Groups
  const btnDraw = document.getElementById('btnDraw');
  if (btnDraw) {
    btnDraw.disabled = false; // Always enabled
    btnDraw.style.opacity = '1';
  }
  
  // Step 2: View Group Stage
  const btnViewGroups = document.querySelectorAll('[onclick*="showGroupStageResults"]');
  btnViewGroups.forEach(btn => {
    btn.disabled = !hasGroups;
    btn.style.opacity = hasGroups ? '1' : '0.5';
  });
  
  // Step 3: Run Group Stage
  const btnGroupStage = document.getElementById('btnGroupStage');
  if (btnGroupStage) {
    btnGroupStage.disabled = !hasGroups || hasGroupResults;
    btnGroupStage.style.opacity = (hasGroups && !hasGroupResults) ? '1' : '0.5';
  }
  
  // Step 4: Run Knockouts
  const btnKnockouts = document.getElementById('btnKnockouts');
  if (btnKnockouts) {
    btnKnockouts.disabled = !hasGroupResults || hasKnockouts;
    btnKnockouts.style.opacity = (hasGroupResults && !hasKnockouts) ? '1' : '0.5';
  }
  
  // View buttons
  const viewButtons = [
    'btnStats',
    'btnAllMatches',
    'btnMatchWeeks',
    'btnBracket',
    'btnSimpleBracket',
    'btnClubLegacy'
  ];
  
  viewButtons.forEach(btnId => {
    const btn = document.getElementById(btnId);
    if (btn) {
      const enabled = hasGroupResults || hasKnockouts;
      btn.disabled = !enabled;
      btn.style.opacity = enabled ? '1' : '0.5';
    }
  });
  
  console.log('✅ Button states updated');
}

// Loading indicator helper
function showLoadingIndicator(message = 'Processing...') {
  const out = document.getElementById('output');
  if (!out) return;
  
  out.innerHTML = `
    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 400px;">
      <div style="width: 60px; height: 60px; border: 4px solid #374151; border-top: 4px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px;"></div>
      <div style="color: #60a5fa; font-size: 1.2em; font-weight: 600;">${message}</div>
    </div>
    <style>
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
  `;
}

/************* GENERIC UTILITY MESSAGE *************/
/************* STYLE INJECTION (OPTIONAL ENHANCEMENTS) *************/

// Single function to inject *extra* styles (no conflicts with base CSS)
function injectAllStyles() {
  const existingStyle = document.getElementById("all-injected-styles");
  if (existingStyle) {
    existingStyle.remove();
  }

  const styleSheet = document.createElement("style");
  styleSheet.id = "all-injected-styles";

  const allStyles = `
    /* Small UI niceties for RNG controls */
    .rng-pill {
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .rng-pill:hover:not(.active) {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    #rngSlider {
      background: linear-gradient(90deg, #10b981 0%, #f59e0b 50%, #ef4444 100%);
      height: 6px;
      border-radius: 3px;
      outline: none;
      transition: all 0.3s ease;
    }

    #rngSlider::-webkit-slider-thumb {
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #ffffff;
      border: 2px solid #3b82f6;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
      transition: all 0.2s ease;
    }

    #rngSlider::-webkit-slider-thumb:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }

    /* Table container + standings table for reusable stat views */
    .table-container {
      overflow-x: auto;
      margin: 0 -4px;
      padding: 0 4px;
    }

    .standings-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    .standings-table th {
      background: rgba(30, 41, 59, 0.9);
      padding: 8px 6px;
      text-align: left;
      font-weight: 600;
      color: #e5e7eb;
      border-bottom: 1px solid #374151;
    }

    .standings-table td {
      padding: 6px 6px;
      border-bottom: 1px solid rgba(55, 65, 81, 0.6);
    }

    .standings-table tr:hover {
      background: rgba(55, 65, 81, 0.35);
    }

    @media (max-width: 768px) {
      .standings-table {
        font-size: 0.8rem;
      }

      .standings-table th,
      .standings-table td {
        padding: 6px 4px;
      }
    }
  `;

  styleSheet.textContent = allStyles;
  document.head.appendChild(styleSheet);
}

/************* HIGH-LEVEL TOURNAMENT HELPERS *************/

// Run entire tournament in one go (draw → groups → knockouts → overview)
async function runFullTournament() {
  if (window.VERBOSE_LOGGING) console.log("🚀 Running full tournament...");

  try {
    // 1) Draw groups if not already drawn
    if (!window.GROUPS && typeof startTournament === "function") {
      startTournament();
      // Wait a bit for UI to update
      await new Promise(resolve => setTimeout(resolve, 100));
    }

    // 2) Run group stage if groups are ready but results not yet done
    if (window.GROUPS && !window.GROUP_RESULTS && typeof runGroupStage === "function") {
      await runGroupStage();
      // Wait a bit for UI to update
      await new Promise(resolve => setTimeout(resolve, 100));
    }

    // 3) Run knockouts if group results exist but tournament object not yet created
    if (window.GROUP_RESULTS && !window.TOURNAMENT && typeof runKnockouts === "function") {
      await runKnockouts();
      // Wait a bit for UI to update
      await new Promise(resolve => setTimeout(resolve, 100));
    }

    // 4) Show overview if everything is complete
    if (window.TOURNAMENT && typeof showTournamentOverview === "function") {
      showTournamentOverview();
      showUtilityMessage("Full tournament completed successfully!", "success");
    } else if (!window.TOURNAMENT) {
      showUtilityMessage(
        "Unable to complete full tournament. Please check that all stages are implemented.",
        "error"
      );
    }

    updateButtonStates();
  } catch (error) {
    console.error("❌ Error running full tournament:", error);
    showUtilityMessage("Error running full tournament. Please try again.", "error");
  }
}

/************* ENHANCED STATS VIEW (MAIN PANEL) *************/

// showEnhancedStatistics is defined later in the file with full functionality (line 31874)

/************* TEAM / PLAYER VIEWS *************/

function viewTeamPlayers(teamName) {
  const out = document.getElementById("output");
  if (!out) return;

  const teamPlayers = Object.values(PLAYER_DB).filter(
    (p) => p.team === teamName && (p.apps || 0) > 0
  );

  let html = `
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
      <h2>👥 ${teamName} Squad</h2>
      ${
        typeof openTeamDetail === "function"
          ? `<button onclick="openTeamDetail('${teamName.replace(/'/g, "\\'")}')" class="btn-secondary">← Back to Team</button>`
          : `<button onclick="history.back()" class="btn-secondary">← Back</button>`
      }
    </div>

    <div class="group-card">
      <div class="group-title">Player Statistics</div>
  `;

  if (teamPlayers.length > 0) {
    html += `
      <div class="table-container">
        <table class="standings-table">
          <thead>
            <tr>
              <th>Player</th>
              <th>Goals</th>
              <th>Assists</th>
              <th>Apps</th>
              <th>Rating</th>
            </tr>
          </thead>
          <tbody>
    `;

    teamPlayers.forEach((player) => {
      html += `
        <tr>
          <td><strong>${player.name}</strong></td>
          <td>${player.goals ?? 0}</td>
          <td>${player.assists ?? 0}</td>
          <td>${player.apps ?? 0}</td>
          <td>${player.avgRating ? player.avgRating.toFixed(1) : "N/A"}</td>
        </tr>
      `;
    });

    html += `
          </tbody>
        </table>
      </div>
    `;
  } else {
    html += `
      <div style="padding: 30px 12px; text-align: center;">
        <div style="font-size: 40px; margin-bottom: 12px;">👥</div>
        <p><strong>No player data available</strong></p>
        <p class="output-sub">Player statistics will appear after simulating matches involving ${teamName}.</p>
      </div>
    `;
  }

  html += `</div>`;
  out.innerHTML = html;
}

/************* CUSTOM MATCH HISTORY (LOCAL STORAGE) *************/

function deleteSavedMatch(matchId) {
  try {
    const savedMatches = JSON.parse(localStorage.getItem("savedCustomMatches") || "[]");
    const updatedMatches = savedMatches.filter((match) => match.id !== matchId);
    localStorage.setItem("savedCustomMatches", JSON.stringify(updatedMatches));
    showCustomMatchHistory();
    showUtilityMessage("Match deleted successfully!", "success");
  } catch (error) {
    console.error(error);
    showUtilityMessage("Error deleting match: " + error.message, "error");
  }
}

function clearCustomMatchHistory() {
  if (confirm("Are you sure you want to clear all saved custom matches?")) {
    localStorage.removeItem("savedCustomMatches");
    showCustomMatchHistory();
    showUtilityMessage("Custom match history cleared!", "success");
  }
}

/************* HISTORY / SETTINGS / STATISTICS MODAL CONTENT *************/

function loadHistoryContent(filter = null) {
  // We already have a static header + close button in HTML for #historyModal
  const body = document.getElementById("historyBody");
  if (!body) return;

  // For now, just a placeholder
  body.innerHTML = `
    <div style="text-align: center; padding: 24px 12px;">
      <div style="font-size: 48px; margin-bottom: 12px;">📚</div>
      <p style="font-size: 1.05em; margin-bottom: 4px;"><strong>Match History</strong></p>
      <p class="output-sub">Comprehensive match and tournament history will appear here.</p>
      <p class="output-sub">Future plans: filter by tournament, team, era, or competition type.</p>
    </div>
  `;
}

function populateSettingsModal() {
  // Only run if you actually create a #settingsModal in HTML
  const modal = document.getElementById("settingsModal");
  if (!modal) return;

  const body = modal.querySelector(".modal-body");
  if (!body) return;

  body.innerHTML = `
    <div style="text-align: center; padding: 24px 12px;">
      <div style="font-size: 48px; margin-bottom: 12px;">⚙️</div>
      <p style="font-size: 1.05em; margin-bottom: 4px;"><strong>Settings</strong></p>
      <p class="output-sub">Configuration options (theme, difficulty presets, data reset) coming soon.</p>
    </div>
  `;
}

function populateStatisticsModal() {
  // Only run if you actually create a #statisticsModal in HTML
  const modal = document.getElementById("statisticsModal");
  if (!modal) return;

  const body = modal.querySelector(".modal-body");
  if (!body) return;

  body.innerHTML = `
    <div style="text-align: center; padding: 24px 12px;">
      <div style="font-size: 48px; margin-bottom: 12px;">📊</div>
      <p style="font-size: 1.05em; margin-bottom: 4px;"><strong>Advanced Statistics</strong></p>
      <p class="output-sub">Detailed analytics, xG-style metrics, and club-era comparisons coming soon.</p>
    </div>
  `;
}

// Hooks for future enhancements
function enhanceSettingsModal() {
  // Placeholder for future controls (toggles, sliders, etc.)
}

function enhanceStatisticsModal() {
  // Placeholder for future advanced charts/filters
}
/************* TEAMS & GROUP DRAW CORE *************/

// Ensure TEAM_POOL exists on window and as a const reference
window.TEAM_POOL = window.TEAM_POOL || [];

/**
 * Initialize TEAM_MAP and register players into PLAYER_DB.
 * Should be called once after TEAM_POOL is defined.
 */
async function initTeamsAndPlayers() {
  // Clear any existing map entries to prevent duplicates on re-init
  TEAM_MAP.clear();

  let validCount = 0;

  for (let i = 0; i < TEAM_POOL.length; i++) {
    const team = TEAM_POOL[i];
    if (validateTeam(team)) {
      TEAM_MAP.set(team.name, team);
      registerTeamPlayers(team);
      validCount++;
    } else {
      console.warn("⚠️ Skipping invalid team in TEAM_POOL:", team);
    }

    // Yield every 50 teams to prevent UI freeze (increased frequency)
    if (i % 50 === 0 && i > 0) {
      await new Promise(resolve => setTimeout(resolve, 0));

      // Update loading progress if available
      if (typeof updateLoadingProgress === 'function') {
        const percent = Math.floor((i / TEAM_POOL.length) * 100);
        document.getElementById("loadingText").textContent = `Loading teams... ${percent}%`;
      }
    }
  }

  if (window.VERBOSE_LOGGING) console.log("🏁 Teams initialized from TEAM_POOL:", TEAM_POOL.length);
  console.log("✅ Valid teams registered in TEAM_MAP:", validCount);
  if (window.VERBOSE_LOGGING) console.log("👥 Players tracked in PLAYER_DB:", Object.keys(PLAYER_DB).length);
}

/**
 * Register all players for a team into PLAYER_DB.
 * Only sets up base entries; match engine will update stats.
 */
function registerTeamPlayers(team) {
  const allPlayers = [
    ...(team.startingXI || []),
    ...(team.bench || [])
  ];

  allPlayers.forEach((player) => {
    if (!player || !player.name) return;

    const key = player.name; // Could also be `${player.name}-${team.name}` if needed
    if (!PLAYER_DB[key]) {
      PLAYER_DB[key] = {
        name: player.name,
        pos: player.pos || "Unknown",
        team: team.name,
        goals: 0,
        assists: 0,
        apps: 0,
        avgRating: 0,                // Updated over time by match engine
        baseQuality: player.quality ?? 75,
        // Player Form System
        form: {
          current: 0,                // -2 (cold) to +2 (hot)
          recentMatches: [],         // Last 3 match ratings
          indicator: '➡️'            // 🔥 (hot), ❄️ (cold), ➡️ (neutral)
        }
      };
    }
  });
}

/************* SEEDED RANDOM NUMBER GENERATOR *************/

/**
 * Seeded Random Number Generator (Mulberry32)
 * Allows deterministic match replay using match seeds
 */
class SeededRandom {
  constructor(seed) {
    this.seed = seed;
  }

  // Generate next random number between 0 and 1
  next() {
    let t = this.seed += 0x6D2B79F5;
    t = Math.imul(t ^ t >>> 15, t | 1);
    t ^= t + Math.imul(t ^ t >>> 7, t | 61);
    return ((t ^ t >>> 14) >>> 0) / 4294967296;
  }

  // Generate random integer between min and max (inclusive)
  nextInt(min, max) {
    return Math.floor(this.next() * (max - min + 1)) + min;
  }

  // Generate random number between min and max
  nextFloat(min, max) {
    return this.next() * (max - min) + min;
  }
}

/************* MATCH REPLAY & COMPARISON SYSTEM *************/

// Store match seeds for replay capability
const MATCH_SEEDS = (window.MATCH_SEEDS = window.MATCH_SEEDS || {});

/**
 * Generate a unique match seed based on teams and timestamp
 * @param {string} teamAName - Team A name
 * @param {string} teamBName - Team B name
 * @returns {number} - Seed for deterministic replay
 */
function generateMatchSeed(teamAName, teamBName) {
  const str = `${teamAName}-${teamBName}-${Date.now()}`;
  let hash = 0;
  for (let i = 0; i < str.length; i++) {
    const char = str.charCodeAt(i);
    hash = ((hash << 5) - hash) + char;
    hash = hash & hash; // Convert to 32-bit integer
  }
  return Math.abs(hash);
}

/**
 * Store match seed and result for replay
 * @param {string} matchId - Unique match identifier
 * @param {number} seed - Match seed
 * @param {object} result - Match result data
 */
function storeMatchForReplay(matchId, seed, result) {
  MATCH_SEEDS[matchId] = {
    seed: seed,
    timestamp: Date.now(),
    teamA: result.teamA,
    teamB: result.teamB,
    scoreA: result.scoreA,
    scoreB: result.scoreB,
    matchEvents: result.matchEvents
  };

  // Save to localStorage
  try {
    localStorage.setItem('matchSeeds', JSON.stringify(MATCH_SEEDS));
  } catch (e) {
    console.warn('Could not save match seeds:', e);
  }
}

/**
 * Replay a match using its stored seed
 * @param {string} matchId - Match ID to replay
 * @returns {object} - Match result (should match original)
 */
function replayMatch(matchId) {
  const matchData = MATCH_SEEDS[matchId];
  if (!matchData) {
    console.warn('⚠️ No seed found for match:', matchId);
    return null;
  }

  if (window.VERBOSE_LOGGING) console.log(`🔄 Replaying match: ${matchData.teamA} vs ${matchData.teamB} with seed ${matchData.seed}`);

  // Find teams in TEAM_MAP
  const teamA = TEAM_MAP.get(matchData.teamA);
  const teamB = TEAM_MAP.get(matchData.teamB);

  if (!teamA || !teamB) {
    console.warn('⚠️ Teams not found for replay');
    return null;
  }

  // Replay with same seed
  return simulateMatchWithSeed(teamA, teamB, true, 1.0, 'clear', matchData.seed);
}

/**
 * Simulate match with a specific seed for deterministic results
 * This is a seeded version of simulateMatch() for replay capability
 */
function simulateMatchWithSeed(teamA, teamB, isHome, matchImportance = 1.0, weather = 'normal', seed = null) {
  if (!teamA || !teamB) {
    console.error("❌ Invalid teams provided to simulateMatchWithSeed");
    return {
      teamA: "Unknown Team A",
      teamB: "Unknown Team B",
      scoreA: 0,
      scoreB: 0,
      isHome,
      matchId: "invalid_match"
    };
  }

  // Generate or use provided seed
  const matchSeed = seed !== null ? seed : generateMatchSeed(teamA.name, teamB.name);
  const rng = new SeededRandom(matchSeed);

  const chaosFactor = RNG_SETTINGS.groupChaos || 1.0;
  const homeAdvantage = isHome ? 0.3 : -0.3;

  // Get formation bonuses
  const formationA = teamA.formation || selectedFormations?.teamA || '4-4-2';
  const formationB = teamB.formation || selectedFormations?.teamB || '4-4-2';

  const attackBonusA = getFormationBonus(formationA, 'attack');
  const defenseBonusA = getFormationBonus(formationA, 'defense');
  const attackBonusB = getFormationBonus(formationB, 'attack');
  const defenseBonusB = getFormationBonus(formationB, 'defense');

  // Apply formation bonuses to team strength
  const effectiveStrengthA = (teamA.strength || 70) * (1 + attackBonusA);
  const effectiveStrengthB = (teamB.strength || 70) * (1 + attackBonusB);

  // Defensive formations reduce opponent's scoring
  const defensiveResistanceA = 1 - (defenseBonusA * 0.5); // Defense affects opponent's attack
  const defensiveResistanceB = 1 - (defenseBonusB * 0.5);

  // Use seeded RNG instead of Math.random()
  const baseScoreA = rng.next() * (effectiveStrengthA / 25) * chaosFactor * defensiveResistanceB;
  const baseScoreB = rng.next() * (effectiveStrengthB / 25) * chaosFactor * defensiveResistanceA;

  const adjustedScoreA = baseScoreA + homeAdvantage + matchImportance * 0.1;
  const adjustedScoreB = baseScoreB - homeAdvantage + matchImportance * 0.1;

  const goalsA = Math.max(0, Math.floor(adjustedScoreA + rng.next() * chaosFactor));
  const goalsB = Math.max(0, Math.floor(adjustedScoreB + rng.next() * chaosFactor));

  const finalGoalsA = Math.min(goalsA, 7);
  const finalGoalsB = Math.min(goalsB, 7);

  // Track player stats
  const matchEvents = trackEnhancedPlayerStats(teamA, teamB, finalGoalsA, finalGoalsB);

  const matchId = `${teamA.name}_vs_${teamB.name}_${matchSeed}`;

  const result = {
    id: matchId,
    matchId: matchId,
    teamA: teamA.name,
    teamB: teamB.name,
    teamAObj: teamA,
    teamBObj: teamB,
    scoreA: Number(finalGoalsA) || 0,
    scoreB: Number(finalGoalsB) || 0,
    goalsA: (Array.isArray(matchEvents?.goals) ? matchEvents.goals.filter(e => e.teamId === teamA.name || e.team === teamA.name) : []),
    goalsB: (Array.isArray(matchEvents?.goals) ? matchEvents.goals.filter(e => e.teamId === teamB.name || e.team === teamB.name) : []),
    isHome,
    events: matchEvents,
    playerOfTheGame: determinePlayerOfTheGame(matchEvents, teamA, teamB),
    timestamp: new Date().toISOString(),
    venue: isHome ? `${teamA.name} Home` : "Neutral",
    importance: matchImportance,
    weather: weather,
    seed: matchSeed,
    // Formation data
    formationA: formationA,
    formationB: formationB,
    tacticalAdvantage: calculateTacticalAdvantage(formationA, formationB, attackBonusA, defenseBonusA, attackBonusB, defenseBonusB)
  };

  MATCH_DETAILS_DB[matchId] = result;

  // Store seed for replay
  if (seed === null) {
    storeMatchForReplay(matchId, matchSeed, result);
  }

  if (window.VERBOSE_LOGGING) console.log(`⚽ Match simulated (seed: ${matchSeed}): ${teamA.name} ${finalGoalsA}-${finalGoalsB} ${teamB.name} ${isHome ? "(H)" : "(A)"}`);

  return result;
}

/**
 * Compare two match scenarios side-by-side
 * @param {string} matchId - Original match ID
 * @param {object} whatIfChanges - Changes to apply (e.g., {teamAStrength: 80, weather: 'rainy'})
 * @returns {object} - Comparison data
 */
function compareMatches(matchId, whatIfChanges = {}) {
  const originalMatch = MATCH_SEEDS[matchId];
  if (!originalMatch) {
    console.warn('⚠️ Original match not found');
    return null;
  }

  // Get teams
  let teamA = TEAM_MAP.get(originalMatch.teamA);
  let teamB = TEAM_MAP.get(originalMatch.teamB);

  if (!teamA || !teamB) {
    console.warn('⚠️ Teams not found');
    return null;
  }

  // Apply what-if changes
  if (whatIfChanges.teamAStrength) {
    teamA = { ...teamA, strength: whatIfChanges.teamAStrength };
  }
  if (whatIfChanges.teamBStrength) {
    teamB = { ...teamB, strength: whatIfChanges.teamBStrength };
  }

  // Simulate with same seed but different parameters
  const whatIfResult = simulateMatchWithSeed(
    teamA,
    teamB,
    true,
    whatIfChanges.importance || 1.0,
    whatIfChanges.weather || 'clear',
    originalMatch.seed
  );

  return {
    original: {
      scoreA: originalMatch.scoreA,
      scoreB: originalMatch.scoreB,
      teamA: originalMatch.teamA,
      teamB: originalMatch.teamB
    },
    whatIf: {
      scoreA: whatIfResult.scoreA,
      scoreB: whatIfResult.scoreB,
      teamA: whatIfResult.teamA,
      teamB: whatIfResult.teamB,
      changes: whatIfChanges
    }
  };
}

/************* AI COMMENTARY ENGINE *************/

const COMMENTARY_TEMPLATES = {
  goals: {
    early: [
      "Early strike! {player} catches the defense napping!",
      "What a start! {player} opens the scoring!",
      "{player} with an early breakthrough!",
      "Brilliant! {player} gives {team} the perfect start!",
      "Lightning start from {player}!"
    ],
    late: [
      "Drama! {player} scores in the dying minutes!",
      "Incredible timing! {player} strikes late!",
      "{player} with a crucial late goal!",
      "In the final moments, {player} finds the net!",
      "Late heroics from {player}!"
    ],
    equalizer: [
      "EQUALIZER! {player} brings {team} level!",
      "{player} levels the score! Game on!",
      "We're all square! {player} with the equalizer!",
      "{player} restores parity!",
      "Back in it! {player} equalizes for {team}!"
    ],
    goAhead: [
      "{player} puts {team} ahead!",
      "The lead changes hands! {player} scores!",
      "{player} gives {team} the advantage!",
      "A crucial goal from {player}!",
      "{player} turns the game around!"
    ],
    comfortable: [
      "{player} extends the lead!",
      "Comfortable now! {player} adds another!",
      "{player} with the cushion goal!",
      "That should be game! {player} scores!",
      "{player} puts this one to bed!"
    ],
    consolation: [
      "A consolation for {team} through {player}",
      "{player} gets one back but it may be too late",
      "Too little, too late from {player}",
      "{player} pulls one back for {team}",
      "A mere consolation from {player}"
    ]
  },
  cards: {
    yellow: [
      "Yellow card! {player} goes into the book",
      "{player} cautioned by the referee",
      "The referee shows yellow to {player}",
      "{player} picks up a booking",
      "Harsh but fair - yellow card for {player}"
    ],
    red: [
      "RED CARD! {player} is sent off!",
      "Disaster! {player} sees red!",
      "{player} is shown a straight red!",
      "Down to 10 men! {player} dismissed!",
      "Early shower for {player}!"
    ]
  },
  moments: {
    possession: [
      "{team} controlling the tempo",
      "{team} dominating possession",
      "{team} bossing this game",
      "{team} in total control"
    ],
    pressure: [
      "{team} piling on the pressure!",
      "{team} pushing hard for a goal!",
      "Wave after wave from {team}!",
      "{team} laying siege here!"
    ],
    defend: [
      "{team} defending desperately!",
      "{team} under heavy pressure!",
      "Can {team} hold on?",
      "{team} backs to the wall!"
    ]
  },
  halftime: [
    "Half time! {scoreA}-{scoreB}",
    "The whistle blows for half time",
    "We're at the break - {scoreA}-{scoreB}",
    "Half time score: {scoreA}-{scoreB}",
    "Into the break we go"
  ],
  fulltime: [
    "Full time! {teamA} {scoreA}-{scoreB} {teamB}",
    "It's all over! Final score: {scoreA}-{scoreB}",
    "The final whistle blows!",
    "Game over! {teamA} {scoreA}, {teamB} {scoreB}",
    "That's it! {scoreA}-{scoreB} the final score"
  ]
};

function generateContextualCommentary(eventType, context) {
  const {
    player,
    team,
    minute,
    scoreA,
    scoreB,
    teamA,
    teamB,
    isHome
  } = context;

  let templates = [];
  let commentary = '';

  switch(eventType) {
    case 'goal':
      // Determine goal context
      const scoreDiff = Math.abs(scoreA - scoreB);
      const scoringTeam = context.scoringTeam; // 'A' or 'B'
      const isDrawing = scoreA === scoreB;
      const isTakingLead = (scoringTeam === 'A' && scoreA > scoreB) || (scoringTeam === 'B' && scoreB > scoreA);
      const wasDrawn = (scoringTeam === 'A' && scoreA - 1 === scoreB) || (scoringTeam === 'B' && scoreB - 1 === scoreA);

      if (minute <= 10) {
        templates = COMMENTARY_TEMPLATES.goals.early;
      } else if (minute >= 85) {
        templates = COMMENTARY_TEMPLATES.goals.late;
      } else if (isDrawing) {
        templates = COMMENTARY_TEMPLATES.goals.equalizer;
      } else if (isTakingLead && wasDrawn) {
        templates = COMMENTARY_TEMPLATES.goals.goAhead;
      } else if (scoreDiff >= 2) {
        const scoringScore = scoringTeam === 'A' ? scoreA : scoreB;
        const concedingScore = scoringTeam === 'A' ? scoreB : scoreA;
        if (scoringScore > concedingScore) {
          templates = COMMENTARY_TEMPLATES.goals.comfortable;
        } else {
          templates = COMMENTARY_TEMPLATES.goals.consolation;
        }
      } else {
        // Default to general goal commentary
        templates = minute >= 70 ? COMMENTARY_TEMPLATES.goals.late : COMMENTARY_TEMPLATES.goals.early;
      }
      break;

    case 'yellow':
      templates = COMMENTARY_TEMPLATES.cards.yellow;
      break;

    case 'red':
      templates = COMMENTARY_TEMPLATES.cards.red;
      break;

    case 'halftime':
      templates = COMMENTARY_TEMPLATES.halftime;
      break;

    case 'fulltime':
      templates = COMMENTARY_TEMPLATES.fulltime;
      break;

    default:
      return '';
  }

  // Select random template
  const template = templates[Math.floor(Math.random() * templates.length)];

  // Replace placeholders
  commentary = template
    .replace(/{player}/g, player || 'Player')
    .replace(/{team}/g, team || 'Team')
    .replace(/{teamA}/g, teamA || 'Team A')
    .replace(/{teamB}/g, teamB || 'Team B')
    .replace(/{scoreA}/g, scoreA !== undefined ? scoreA : 0)
    .replace(/{scoreB}/g, scoreB !== undefined ? scoreB : 0)
    .replace(/{minute}/g, minute || 0);

  return commentary;
}

function getCommentaryForGoal(goalData, matchState) {
  const context = {
    player: goalData.scorer?.name || goalData.player || 'Player',
    team: goalData.team,
    minute: goalData.minute || matchState.currentMinute,
    scoreA: matchState.scoreA,
    scoreB: matchState.scoreB,
    teamA: matchState.teamA?.name || matchState.teamA,
    teamB: matchState.teamB?.name || matchState.teamB,
    scoringTeam: goalData.team === (matchState.teamA?.name || matchState.teamA) ? 'A' : 'B'
  };

  return generateContextualCommentary('goal', context);
}

function getCommentaryForCard(cardType, player, team, minute) {
  const context = {
    player: player,
    team: team,
    minute: minute
  };

  return generateContextualCommentary(cardType, context);
}

function generateAIMatchSummary(matchResult) {
  // Generate a detailed AI post-match summary based on the result
  const { teamA, teamB, scoreA, scoreB, formationA, formationB, tacticalAdvantage } = matchResult;

  const scoreDiff = Math.abs(scoreA - scoreB);
  const winner = scoreA > scoreB ? teamA : scoreB > scoreA ? teamB : null;
  const loser = scoreA > scoreB ? teamB : scoreB > scoreA ? teamA : null;

  let summary = '';

  if (scoreDiff === 0) {
    const drawTemplates = [
      `A hard-fought draw between ${teamA} and ${teamB}. Both teams will feel they could have won this one.`,
      `Honours even as ${teamA} and ${teamB} share the points in a ${scoreA}-${scoreB} thriller.`,
      `Neither side could find the breakthrough. A fair result for both ${teamA} and ${teamB}.`,
      `${teamA} and ${teamB} cancel each other out in an entertaining ${scoreA}-${scoreB} draw.`
    ];
    summary = drawTemplates[Math.floor(Math.random() * drawTemplates.length)];
  } else if (scoreDiff === 1) {
    const narrowTemplates = [
      `A narrow victory for ${winner}! ${loser} pushed them all the way but came up just short.`,
      `${winner} edge past ${loser} in a tight contest. One goal made all the difference.`,
      `Close one! ${winner} hold on for a ${scoreA > scoreB ? scoreA : scoreB}-${scoreA > scoreB ? scoreB : scoreA} win over ${loser}.`,
      `${winner} prevail in a nervy finish. ${loser} will be disappointed not to get something from this.`
    ];
    summary = narrowTemplates[Math.floor(Math.random() * narrowTemplates.length)];
  } else if (scoreDiff >= 3) {
    const dominantTemplates = [
      `Dominant performance from ${winner}! ${loser} were completely outplayed today.`,
      `A comprehensive ${scoreA > scoreB ? scoreA : scoreB}-${scoreA > scoreB ? scoreB : scoreA} victory for ${winner}. ${loser} had no answers.`,
      `${winner} run riot! An emphatic win that sends a message to the rest of the competition.`,
      `Clinical from ${winner}. ${loser} were simply overwhelmed by the quality on display.`
    ];
    summary = dominantTemplates[Math.floor(Math.random() * dominantTemplates.length)];
  } else {
    const comfortableTemplates = [
      `${winner} secure a solid victory over ${loser}. Never really in doubt after the break.`,
      `Comfortable win for ${winner}. ${loser} tried to fight back but couldn't find a way through.`,
      `${winner} in control throughout. A deserved ${scoreA > scoreB ? scoreA : scoreB}-${scoreA > scoreB ? scoreB : scoreA} win.`,
      `Professional performance from ${winner} to see off ${loser}.`
    ];
    summary = comfortableTemplates[Math.floor(Math.random() * comfortableTemplates.length)];
  }

  // Add tactical note if formations were impactful
  if (tacticalAdvantage && tacticalAdvantage.advantagePercent > 10) {
    const tacticalNote = ` The ${formationA || '4-4-2'} formation proved effective against ${teamB}'s ${formationB || '4-4-2'} setup.`;
    summary += tacticalNote;
  }

  return summary;
}

/************* SOCIAL SHARING FEATURES *************/

function generateMatchShareText(matchResult) {
  // Generate formatted text for sharing match results
  const { teamA, teamB, scoreA, scoreB, formationA, formationB, playerOfTheGame } = matchResult;

  let shareText = `⚽ MATCH RESULT ⚽\n\n`;
  shareText += `${teamA} ${scoreA} - ${scoreB} ${teamB}\n\n`;

  // Add formations if available
  if (formationA && formationB) {
    shareText += `📋 Formations:\n`;
    shareText += `${teamA}: ${formationA}\n`;
    shareText += `${teamB}: ${formationB}\n\n`;
  }

  // Add player of the game if available
  if (playerOfTheGame && playerOfTheGame.player) {
    shareText += `⭐ Player of the Game: ${playerOfTheGame.player}\n`;
    shareText += `Rating: ${playerOfTheGame.rating}/10\n`;
    if (playerOfTheGame.goals > 0) {
      shareText += `Goals: ${playerOfTheGame.goals}\n`;
    }
    if (playerOfTheGame.assists > 0) {
      shareText += `Assists: ${playerOfTheGame.assists}\n`;
    }
    shareText += `\n`;
  }

  // Add match summary if available
  const summary = generateAIMatchSummary(matchResult);
  if (summary) {
    shareText += `📝 ${summary}\n\n`;
  }

  shareText += `🎮 Created with All-Time Football Simulator`;

  return shareText;
}

function generateTournamentShareText(tournamentData) {
  // Generate formatted text for sharing tournament results
  const { winner, runnerUp, topScorer, tournamentName, totalMatches } = tournamentData;

  let shareText = `🏆 TOURNAMENT RESULTS 🏆\n\n`;

  if (tournamentName) {
    shareText += `${tournamentName}\n\n`;
  }

  shareText += `👑 Champion: ${winner}\n`;

  if (runnerUp) {
    shareText += `🥈 Runner-up: ${runnerUp}\n`;
  }

  if (topScorer && topScorer.player) {
    shareText += `\n⚽ Golden Boot: ${topScorer.player}\n`;
    shareText += `Goals: ${topScorer.goals}\n`;
  }

  if (totalMatches) {
    shareText += `\n📊 Matches Played: ${totalMatches}\n`;
  }

  shareText += `\n🎮 Created with All-Time Football Simulator`;

  return shareText;
}

async function copyToClipboard(text) {
  // Copy text to clipboard with fallback support
  try {
    if (navigator.clipboard && navigator.clipboard.writeText) {
      await navigator.clipboard.writeText(text);
      showUtilityMessage('✓ Copied to clipboard!', 'success');
      return true;
    } else {
      // Fallback for older browsers
      const textarea = document.createElement('textarea');
      textarea.value = text;
      textarea.style.position = 'fixed';
      textarea.style.opacity = '0';
      document.body.appendChild(textarea);
      textarea.select();

      const success = document.execCommand('copy');
      document.body.removeChild(textarea);

      if (success) {
        showUtilityMessage('✓ Copied to clipboard!', 'success');
        return true;
      } else {
        showUtilityMessage('⚠ Could not copy to clipboard', 'warning');
        return false;
      }
    }
  } catch (err) {
    console.error('Copy to clipboard failed:', err);
    showUtilityMessage('❌ Copy failed', 'error');
    return false;
  }
}

function shareMatch(matchResult) {
  // Share match result
  const shareText = generateMatchShareText(matchResult);

  // Try native share API first (mobile)
  if (navigator.share) {
    navigator.share({
      title: `${matchResult.teamA} vs ${matchResult.teamB}`,
      text: shareText
    }).catch(err => {
      console.log('Share cancelled or failed:', err);
      // Fallback to copy
      copyToClipboard(shareText);
    });
  } else {
    // Desktop - copy to clipboard
    copyToClipboard(shareText);
  }
}

function shareTournament(tournamentData) {
  // Share tournament results
  const shareText = generateTournamentShareText(tournamentData);

  // Try native share API first (mobile)
  if (navigator.share) {
    navigator.share({
      title: tournamentData.tournamentName || 'Tournament Results',
      text: shareText
    }).catch(err => {
      console.log('Share cancelled or failed:', err);
      // Fallback to copy
      copyToClipboard(shareText);
    });
  } else {
    // Desktop - copy to clipboard
    copyToClipboard(shareText);
  }
}

function showSharePreview(text, onConfirm) {
  // Show preview of share text before sharing
  const modal = document.createElement('div');
  modal.className = 'modal-backdrop';
  modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); z-index: 10000; display: flex; align-items: center; justify-content: center;';

  modal.innerHTML = `
    <div style="max-width: 500px; width: 90%; background: #1e293b; border-radius: 16px; padding: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.5);" onclick="event.stopPropagation()">
      <h2 style="margin: 0 0 20px 0; color: #10b981; font-size: 1.5em;">📤 Share Preview</h2>

      <div style="background: #0f172a; padding: 20px; border-radius: 8px; margin-bottom: 20px; max-height: 400px; overflow-y: auto; border: 1px solid rgba(59, 130, 246, 0.3);">
        <pre style="margin: 0; color: #e5e7eb; font-family: monospace; font-size: 0.9em; white-space: pre-wrap; word-wrap: break-word;">${text}</pre>
      </div>

      <div style="display: flex; gap: 10px;">
        <button onclick="sharePreviewConfirm()" style="flex: 1; background: #10b981; color: white; border: none; padding: 14px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1em;">
          📤 Share
        </button>
        <button onclick="closeSharePreview()" style="flex: 1; background: #475569; color: white; border: none; padding: 14px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1em;">
          Cancel
        </button>
      </div>
    </div>
  `;

  // Store confirm callback
  window._sharePreviewCallback = onConfirm;

  document.body.appendChild(modal);
}

function sharePreviewConfirm() {
  if (window._sharePreviewCallback) {
    window._sharePreviewCallback();
    delete window._sharePreviewCallback;
  }
  closeSharePreview();
}

function closeSharePreview() {
  const modal = document.querySelector('.modal-backdrop');
  if (modal && modal.innerHTML.includes('Share Preview')) {
    modal.remove();
  }
  delete window._sharePreviewCallback;
}

function shareLastTournament() {
  // Share the most recent tournament result
  if (window.LAST_TOURNAMENT_RESULT) {
    shareTournament(window.LAST_TOURNAMENT_RESULT);
  } else if (TOURNAMENT_HISTORY && TOURNAMENT_HISTORY.length > 0) {
    // Fallback to tournament history
    const latest = TOURNAMENT_HISTORY[TOURNAMENT_HISTORY.length - 1];
    shareTournament({
      winner: latest.champion,
      runnerUp: null,
      topScorer: latest.topScorer ? { player: latest.topScorer, goals: 0 } : null,
      tournamentName: 'All-Time Football Tournament',
      totalMatches: 0
    });
  } else {
    showUtilityMessage('No tournament to share', 'warning');
  }
}

/************* SEASON MODE *************/

// Season Mode State - Enhanced
let SEASON_STATE = {
  active: false,
  seasonNumber: 1,
  currentMatchday: 0,
  totalMatchdays: 38,
  standings: [],
  fixtures: [],
  results: [],
  playerTeam: null,
  seasonHistory: [],
  topScorers: [],
  statistics: {
    totalGoals: 0,
    totalMatches: 0,
    averageGoals: 0,
    biggestWin: null,
    mostGoalsMatch: 0
  },
  // Legacy compatibility
  teams: [],
  table: [],
  seasonStats: {
    topScorer: null,
    topAssists: null,
    cleanSheets: {},
    form: {},
    playerStats: {}
  },
  startDate: null,
  currentStage: 'setup'
};

// League table entry structure
function createTableEntry(team) {
  return {
    team: team,
    played: 0,
    wins: 0,
    draws: 0,
    losses: 0,
    goalsFor: 0,
    goalsAgainst: 0,
    goalDifference: 0,
    points: 0,
    form: [], // Last 5 results: 'W', 'D', 'L'
    homeRecord: { W: 0, D: 0, L: 0, GF: 0, GA: 0 },
    awayRecord: { W: 0, D: 0, L: 0, GF: 0, GA: 0 }
  };
}

function initializeSeasonMode(teams) {
  // Initialize a new season with given teams
  if (!teams || teams.length < 4) {
    showUtilityMessage('Need at least 4 teams for Season Mode', 'error');
    return false;
  }

  // Maximum 20 teams for performance, ensure even number
  let maxTeams = Math.min(teams.length, 20);
  if (maxTeams % 2 !== 0) maxTeams--; // Ensure even number

  const seasonTeams = teams.slice(0, maxTeams);

  if (seasonTeams.length < 4) {
    showUtilityMessage('Not enough teams for Season Mode', 'error');
    return false;
  }

  SEASON_STATE = {
    active: true,
    currentMatchday: 0,
    totalMatchdays: (seasonTeams.length - 1) * 2, // Round-robin home and away
    teams: seasonTeams,
    fixtures: generateSeasonFixtures(seasonTeams),
    table: seasonTeams.map(team => createTableEntry(team)),
    seasonStats: {
      topScorer: null,
      topAssists: null,
      cleanSheets: {},
      form: {}
    },
    seasonNumber: SEASON_STATE.seasonNumber || 1,
    startDate: new Date().toISOString()
  };

  if (window.VERBOSE_LOGGING) console.log(`⚽ Season ${SEASON_STATE.seasonNumber} initialized with ${seasonTeams.length} teams`);
  console.log(`📅 Total matchdays: ${SEASON_STATE.totalMatchdays}`);

  return true;
}

function generateSeasonFixtures(teams) {
  // Generate round-robin fixtures (home and away)
  const fixtures = [];
  const numTeams = teams.length;

  // Ensure even number of teams
  if (numTeams % 2 !== 0) {
    console.error('Need even number of teams for round-robin');
    return [];
  }

  // Round-robin algorithm (circle method)
  for (let round = 0; round < numTeams - 1; round++) {
    const matchday = [];

    for (let match = 0; match < numTeams / 2; match++) {
      // Last team stays in place, others rotate
      let homeTeam, awayTeam;

      if (match === 0) {
        // First match always involves the fixed team
        homeTeam = teams[numTeams - 1];
        awayTeam = teams[round];
      } else {
        const homeIdx = (round + match) % (numTeams - 1);
        const awayIdx = (numTeams - 1 - match + round) % (numTeams - 1);
        homeTeam = teams[homeIdx];
        awayTeam = teams[awayIdx];
      }

      if (homeTeam && awayTeam && homeTeam !== awayTeam) {
        matchday.push({
          home: homeTeam,
          away: awayTeam,
          matchday: round + 1,
          played: false,
          result: null
        });
      }
    }

    fixtures.push(matchday);
  }

  // Add reverse fixtures (away becomes home)
  const reverseFixtures = fixtures.map((matchday, idx) => {
    return matchday.map(fixture => ({
      home: fixture.away,
      away: fixture.home,
      matchday: fixtures.length + idx + 1,
      played: false,
      result: null
    }));
  });

  return [...fixtures, ...reverseFixtures];
}

// Removed duplicate: function simulateMatchday - see later definition

function updateTableWithResult(result, homeTeam, awayTeam) {
  // Update league table with match result
  if (!result || !homeTeam || !awayTeam) {
    console.error('Invalid match result or teams', { result, homeTeam, awayTeam });
    return;
  }

  const homeEntry = SEASON_STATE.table.find(t => t.team && t.team.name === homeTeam.name);
  const awayEntry = SEASON_STATE.table.find(t => t.team && t.team.name === awayTeam.name);

  if (!homeEntry || !awayEntry) {
    console.error('Team not found in table', {
      homeTeam: homeTeam.name,
      awayTeam: awayTeam.name,
      tableTeams: SEASON_STATE.table.map(t => t.team?.name)
    });
    return;
  }

  const homeGoals = Number(result.scoreA) || 0;
  const awayGoals = Number(result.scoreB) || 0;

  // Update played
  homeEntry.played++;
  awayEntry.played++;

  // Update goals
  homeEntry.goalsFor += homeGoals;
  homeEntry.goalsAgainst += awayGoals;
  awayEntry.goalsFor += awayGoals;
  awayEntry.goalsAgainst += homeGoals;

  // Update goal difference
  homeEntry.goalDifference = homeEntry.goalsFor - homeEntry.goalsAgainst;
  awayEntry.goalDifference = awayEntry.goalsFor - awayEntry.goalsAgainst;

  // Determine result
  let homeResult, awayResult;
  if (homeGoals > awayGoals) {
    homeEntry.wins++;
    awayEntry.losses++;
    homeEntry.points += 3;
    homeResult = 'W';
    awayResult = 'L';
  } else if (homeGoals < awayGoals) {
    homeEntry.losses++;
    awayEntry.wins++;
    awayEntry.points += 3;
    homeResult = 'L';
    awayResult = 'W';
  } else {
    homeEntry.draws++;
    awayEntry.draws++;
    homeEntry.points++;
    awayEntry.points++;
    homeResult = 'D';
    awayResult = 'D';
  }

  // Update form (last 5 matches)
  homeEntry.form.unshift(homeResult);
  if (homeEntry.form.length > 5) homeEntry.form.pop();

  awayEntry.form.unshift(awayResult);
  if (awayEntry.form.length > 5) awayEntry.form.pop();

  // Update home/away records
  homeEntry.homeRecord[homeResult]++;
  homeEntry.homeRecord.GF += homeGoals;
  homeEntry.homeRecord.GA += awayGoals;

  awayEntry.awayRecord[awayResult]++;
  awayEntry.awayRecord.GF += awayGoals;
  awayEntry.awayRecord.GA += homeGoals;
}

function sortTable() {
  // Sort table by points, then GD, then GF
  SEASON_STATE.table.sort((a, b) => {
    if (b.points !== a.points) return b.points - a.points;
    if (b.goalDifference !== a.goalDifference) return b.goalDifference - a.goalDifference;
    return b.goalsFor - a.goalsFor;
  });
}

function endSeason() {
  // End the current season and show results
  if (!SEASON_STATE.active) return;

  SEASON_STATE.active = false;

  const champion = SEASON_STATE.table[0];
  const relegated = SEASON_STATE.table.slice(-3); // Bottom 3 teams

  if (window.VERBOSE_LOGGING) console.log(`🏆 Season ${SEASON_STATE.seasonNumber} Champion: ${champion.team.name}`);
  console.log(`📉 Relegated: ${relegated.map(t => t.team.name).join(', ')}`);

  // Update Career Mode if active
  if (CAREER_STATE.active && SEASON_STATE.table.length > 0) {
    // Find user's team in the table by club name
    let userTeamEntry = SEASON_STATE.table.find(entry => entry.team.name === CAREER_STATE.clubName);

    // If not found by exact match, use champion (first team)
    if (!userTeamEntry) {
      userTeamEntry = SEASON_STATE.table[0];
    }

    // Find position in table
    const position = SEASON_STATE.table.indexOf(userTeamEntry) + 1;

    const topScorer = getTopScorer();
    const topAssists = getTopAssists();

    const seasonResults = {
      position: position,
      points: userTeamEntry.points,
      wins: userTeamEntry.wins,
      draws: userTeamEntry.draws,
      losses: userTeamEntry.losses,
      goalsFor: userTeamEntry.goalsFor,
      goalsAgainst: userTeamEntry.goalsAgainst,
      goalDifference: userTeamEntry.goalDifference,
      topScorer: topScorer ? { name: topScorer.player, goals: topScorer.goals } : null,
      topAssists: topAssists ? { name: topAssists.player, assists: topAssists.assists } : null,
      promoted: false,
      relegated: relegated.some(t => t.team.name === userTeamEntry.team.name)
    };

    endSeasonCareer(seasonResults);
  }

  // Show season summary
  showSeasonSummary(champion, relegated);

  // Increment season number for next season
  SEASON_STATE.seasonNumber++;
}

function showSeasonSummary(champion, relegated) {
  // Display season summary modal
  const topScorer = getTopScorer();
  const topAssists = getTopAssists();

  const modal = document.createElement('div');
  modal.className = 'modal-backdrop season-summary-modal';
  modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); z-index: 10000; display: flex; align-items: center; justify-content: center;';

  modal.innerHTML = `
    <div style="max-width: 600px; width: 90%; background: #1e293b; border-radius: 16px; padding: 30px; max-height: 80vh; overflow-y: auto;">
      <h2 style="margin: 0 0 20px 0; color: #10b981; font-size: 2em; text-align: center;">
        🏆 Season ${SEASON_STATE.seasonNumber} Complete!
      </h2>

      <div style="background: linear-gradient(135deg, #fbbf24, #f59e0b); padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center;">
        <div style="font-size: 1.2em; color: #1e293b; margin-bottom: 8px;">CHAMPION</div>
        <div style="font-size: 2em; font-weight: 700; color: #1e293b;">${champion.team.name}</div>
        <div style="font-size: 1.1em; color: #1e293b; margin-top: 8px;">${champion.points} points | ${champion.wins}W ${champion.draws}D ${champion.losses}L</div>
      </div>

      <div style="background: rgba(59, 130, 246, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <h3 style="margin: 0 0 10px 0; color: #3b82f6;">⚽ Top Scorer</h3>
        <div style="color: #e5e7eb;">${topScorer ? `${topScorer.player} - ${topScorer.goals} goals` : 'N/A'}</div>
      </div>

      <div style="background: rgba(59, 130, 246, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <h3 style="margin: 0 0 10px 0; color: #3b82f6;">🎯 Top Assists</h3>
        <div style="color: #e5e7eb;">${topAssists ? `${topAssists.player} - ${topAssists.assists} assists` : 'N/A'}</div>
      </div>

      ${relegated.length > 0 ? `
        <div style="background: rgba(239, 68, 68, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
          <h3 style="margin: 0 0 10px 0; color: #ef4444;">📉 Relegated</h3>
          <div style="color: #e5e7eb;">${relegated.map(t => t.team.name).join(', ')}</div>
        </div>
      ` : ''}

      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button onclick="closeSeasonSummary()" style="flex: 1; background: #3b82f6; color: white; border: none; padding: 14px; border-radius: 8px; cursor: pointer; font-weight: 600;">
          Close
        </button>
        ${CAREER_STATE.active ? `
          <button onclick="viewCareerDashboardFromSeason()" style="flex: 1; background: #8b5cf6; color: white; border: none; padding: 14px; border-radius: 8px; cursor: pointer; font-weight: 600;">
            Career Stats
          </button>
        ` : ''}
        <button onclick="startNewSeason()" style="flex: 1; background: #10b981; color: white; border: none; padding: 14px; border-radius: 8px; cursor: pointer; font-weight: 600;">
          New Season
        </button>
      </div>
    </div>
  `;

  document.body.appendChild(modal);
}

function viewCareerDashboardFromSeason() {
  closeSeasonSummary();
  showCareerDashboard();
}

function closeSeasonSummary() {
  const modal = document.querySelector('.season-summary-modal');
  if (modal) modal.remove();
}

// startNewSeason is defined later in the file with enhanced implementation (line 15455)

function getTopScorer() {
  // Get top scorer from player database
  if (!window.PLAYER_DB) return null;

  const players = Object.values(window.PLAYER_DB)
    .filter(p => p.goals && p.goals > 0)
    .sort((a, b) => (b.goals || 0) - (a.goals || 0));

  return players.length > 0 ? { player: players[0].name, goals: players[0].goals } : null;
}

function getTopAssists() {
  // Get top assists from player database
  if (!window.PLAYER_DB) return null;

  const players = Object.values(window.PLAYER_DB)
    .filter(p => p.assists && p.assists > 0)
    .sort((a, b) => (b.assists || 0) - (a.assists || 0));

  return players.length > 0 ? { player: players[0].name, assists: players[0].assists } : null;
}

function showLeagueTable() {
  // Display league table modal
  if (!SEASON_STATE.active && SEASON_STATE.table.length === 0) {
    showUtilityMessage('No active season', 'warning');
    return;
  }

  let tableHTML = `
    <div class="modal-backdrop league-table-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); z-index: 10000; display: flex; align-items: center; justify-content: center; overflow-y: auto; padding: 20px;">
      <div style="max-width: 900px; width: 100%; background: #1e293b; border-radius: 16px; padding: 30px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2 style="margin: 0; color: #10b981; font-size: 1.8em;">📊 League Table</h2>
          <button onclick="closeLeagueTable()" style="background: transparent; border: none; color: #94a3b8; font-size: 2em; cursor: pointer; line-height: 1;">&times;</button>
        </div>

        <div style="background: rgba(59, 130, 246, 0.1); padding: 12px; border-radius: 8px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
          <div style="color: #e5e7eb;">
            <strong>Season ${SEASON_STATE.seasonNumber}</strong> | Matchday ${SEASON_STATE.currentMatchday}/${SEASON_STATE.totalMatchdays}
          </div>
          ${SEASON_STATE.active ? `
            <button onclick="simulateNextMatchday()" style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">
              ⚽ Simulate Next Matchday
            </button>
          ` : ''}
        </div>

        <div style="overflow-x: auto;">
          <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
            <thead>
              <tr style="background: rgba(59, 130, 246, 0.2); color: #e5e7eb;">
                <th style="padding: 10px; text-align: left; border-bottom: 2px solid rgba(59, 130, 246, 0.5);">Pos</th>
                <th style="padding: 10px; text-align: left; border-bottom: 2px solid rgba(59, 130, 246, 0.5);">Team</th>
                <th style="padding: 10px; text-align: center; border-bottom: 2px solid rgba(59, 130, 246, 0.5);">P</th>
                <th style="padding: 10px; text-align: center; border-bottom: 2px solid rgba(59, 130, 246, 0.5);">W</th>
                <th style="padding: 10px; text-align: center; border-bottom: 2px solid rgba(59, 130, 246, 0.5);">D</th>
                <th style="padding: 10px; text-align: center; border-bottom: 2px solid rgba(59, 130, 246, 0.5);">L</th>
                <th style="padding: 10px; text-align: center; border-bottom: 2px solid rgba(59, 130, 246, 0.5);">GF</th>
                <th style="padding: 10px; text-align: center; border-bottom: 2px solid rgba(59, 130, 246, 0.5);">GA</th>
                <th style="padding: 10px; text-align: center; border-bottom: 2px solid rgba(59, 130, 246, 0.5);">GD</th>
                <th style="padding: 10px; text-align: center; border-bottom: 2px solid rgba(59, 130, 246, 0.5);">Pts</th>
                <th style="padding: 10px; text-align: center; border-bottom: 2px solid rgba(59, 130, 246, 0.5);">Form</th>
              </tr>
            </thead>
            <tbody>
  `;

  SEASON_STATE.table.forEach((entry, index) => {
    const position = index + 1;
    let rowColor = 'rgba(30, 41, 59, 0.5)';

    // Color coding
    if (position === 1) {
      rowColor = 'rgba(251, 191, 36, 0.15)'; // Champion - Gold
    } else if (position <= 4) {
      rowColor = 'rgba(59, 130, 246, 0.15)'; // Champions League - Blue
    } else if (position <= 6) {
      rowColor = 'rgba(16, 185, 129, 0.15)'; // Europa League - Green
    } else if (position >= SEASON_STATE.table.length - 2) {
      rowColor = 'rgba(239, 68, 68, 0.15)'; // Relegation - Red
    }

    const formHTML = entry.form.map(result => {
      const color = result === 'W' ? '#10b981' : result === 'D' ? '#fbbf24' : '#ef4444';
      return `<span style="display: inline-block; width: 20px; height: 20px; background: ${color}; border-radius: 3px; text-align: center; line-height: 20px; margin: 0 1px; font-size: 0.75em; color: #1e293b; font-weight: 700;">${result}</span>`;
    }).join('');

    tableHTML += `
      <tr style="background: ${rowColor}; border-bottom: 1px solid rgba(71, 85, 105, 0.3);">
        <td style="padding: 10px; color: #e5e7eb; font-weight: 600;">${position}</td>
        <td style="padding: 10px; color: #e5e7eb; font-weight: 600;">${entry.team.name}</td>
        <td style="padding: 10px; text-align: center; color: #cbd5e1;">${entry.played}</td>
        <td style="padding: 10px; text-align: center; color: #10b981;">${entry.wins}</td>
        <td style="padding: 10px; text-align: center; color: #fbbf24;">${entry.draws}</td>
        <td style="padding: 10px; text-align: center; color: #ef4444;">${entry.losses}</td>
        <td style="padding: 10px; text-align: center; color: #cbd5e1;">${entry.goalsFor}</td>
        <td style="padding: 10px; text-align: center; color: #cbd5e1;">${entry.goalsAgainst}</td>
        <td style="padding: 10px; text-align: center; color: ${entry.goalDifference >= 0 ? '#10b981' : '#ef4444'}; font-weight: 600;">${entry.goalDifference >= 0 ? '+' : ''}${entry.goalDifference}</td>
        <td style="padding: 10px; text-align: center; color: #e5e7eb; font-weight: 700; font-size: 1.1em;">${entry.points}</td>
        <td style="padding: 10px; text-align: center;">${formHTML || '-'}</td>
      </tr>
    `;
  });

  tableHTML += `
            </tbody>
          </table>
        </div>

        <div style="margin-top: 20px; display: flex; gap: 10px; font-size: 0.85em; flex-wrap: wrap;">
          <div style="display: flex; align-items: center; gap: 5px;">
            <div style="width: 15px; height: 15px; background: rgba(251, 191, 36, 0.3); border-radius: 3px;"></div>
            <span style="color: #94a3b8;">Champion</span>
          </div>
          <div style="display: flex; align-items: center; gap: 5px;">
            <div style="width: 15px; height: 15px; background: rgba(59, 130, 246, 0.3); border-radius: 3px;"></div>
            <span style="color: #94a3b8;">Champions League</span>
          </div>
          <div style="display: flex; align-items: center; gap: 5px;">
            <div style="width: 15px; height: 15px; background: rgba(16, 185, 129, 0.3); border-radius: 3px;"></div>
            <span style="color: #94a3b8;">Europa League</span>
          </div>
          <div style="display: flex; align-items: center; gap: 5px;">
            <div style="width: 15px; height: 15px; background: rgba(239, 68, 68, 0.3); border-radius: 3px;"></div>
            <span style="color: #94a3b8;">Relegation</span>
          </div>
        </div>
      </div>
    </div>
  `;

  const existing = document.querySelector('.league-table-modal');
  if (existing) existing.remove();

  document.body.insertAdjacentHTML('beforeend', tableHTML);
}

function closeLeagueTable() {
  const modal = document.querySelector('.league-table-modal');
  if (modal) modal.remove();
}

function simulateNextMatchday() {
  if (!SEASON_STATE.active) {
    showUtilityMessage('No active season', 'error');
    return;
  }

  const matchdayNumber = SEASON_STATE.currentMatchday + 1; // Display the actual matchday number (1-based)
  const results = simulateMatchday(SEASON_STATE.currentMatchday);

  if (results) {
    showUtilityMessage(`Matchday ${matchdayNumber} simulated!`, 'success');

    // Refresh table display
    setTimeout(() => {
      closeLeagueTable();
      showLeagueTable();
    }, 500);
  }
}

// Season Mode UI Display
function displaySeasonMode() {
  const out = document.getElementById('output');
  if (!out) return;

  if (!SEASON_STATE.active) {
    out.innerHTML = `
      <div style="max-width: 1000px; margin: 0 auto;">
        <h2 style="color: #10b981; margin-bottom: 20px;">⚽ Season Mode</h2>
        <p style="color: #94a3b8; margin-bottom: 30px;">Create a league season and compete for the championship!</p>

        <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(59, 130, 246, 0.1));
                    border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 12px; padding: 30px; margin-bottom: 20px;">
          <h3 style="color: #10b981; margin-bottom: 15px;">Setup Your Season</h3>

          <div style="margin-bottom: 20px;">
            <label style="display: block; color: #94a3b8; margin-bottom: 8px; font-weight: 600;">
              Number of Teams (4-20, must be even)
            </label>
            <input type="number" id="seasonTeamCount" min="4" max="20" step="2" value="8"
                   style="width: 100%; padding: 12px; background: rgba(15, 23, 42, 0.6);
                          border: 1px solid rgba(71, 85, 105, 0.4); border-radius: 8px;
                          color: #f1f5f9; font-size: 1em;">
          </div>

          <div style="margin-bottom: 20px;">
            <label style="display: block; color: #94a3b8; margin-bottom: 8px; font-weight: 600;">
              Select Teams
            </label>
            <div style="color: #64748b; font-size: 0.9em; margin-bottom: 10px;">
              Teams will be auto-selected based on rating. You can customize after setup.
            </div>
          </div>

          <button onclick="startNewSeason()" class="btn-primary"
                  style="width: 100%; padding: 16px; font-size: 1.1em; font-weight: 600;">
            🏁 Start Season
          </button>
        </div>

        ${SEASON_STATE.seasonHistory && SEASON_STATE.seasonHistory.length > 0 ? `
          <div style="margin-top: 30px;">
            <h3 style="color: #10b981; margin-bottom: 15px;">📚 Season History</h3>
            <div style="display: grid; gap: 12px;">
              ${SEASON_STATE.seasonHistory.map((season, idx) => `
                <div style="background: rgba(30, 41, 59, 0.6); border: 1px solid rgba(71, 85, 105, 0.3);
                            border-radius: 8px; padding: 16px; cursor: pointer;"
                     onclick="viewSeasonHistory(${idx})">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                      <div style="font-weight: 600; color: #f1f5f9;">Season ${season.number}</div>
                      <div style="color: #94a3b8; font-size: 0.9em;">${season.teams.length} teams</div>
                    </div>
                    <div style="text-align: right;">
                      <div style="color: #10b981; font-weight: 700;">🏆 ${season.champion}</div>
                      <div style="color: #94a3b8; font-size: 0.9em;">${season.completedDate}</div>
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        ` : ''}
      </div>
    `;
    return;
  }

  // Active season display
  const currentMatchday = SEASON_STATE.currentMatchday;
  const totalMatchdays = SEASON_STATE.totalMatchdays;
  const progressPercent = (currentMatchday / totalMatchdays * 100).toFixed(0);

  out.innerHTML = `
    <div style="max-width: 1200px; margin: 0 auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div>
          <h2 style="color: #10b981; margin: 0;">⚽ Season ${SEASON_STATE.seasonNumber}</h2>
          <p style="color: #94a3b8; margin: 5px 0 0 0;">Matchday ${currentMatchday} of ${totalMatchdays}</p>
        </div>
        <div style="display: flex; gap: 10px;">
          <button onclick="displaySeasonTable()" class="btn-secondary">📊 Table</button>
          <button onclick="viewSeasonFixtures()" class="btn-secondary">📅 Fixtures</button>
          <button onclick="viewSeasonStats()" class="btn-secondary">📈 Stats</button>
        </div>
      </div>

      <!-- Progress Bar -->
      <div style="background: rgba(30, 41, 59, 0.6); border-radius: 8px; padding: 12px; margin-bottom: 20px;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
          <span style="color: #94a3b8; font-size: 0.9em;">Season Progress</span>
          <span style="color: #10b981; font-weight: 600;">${progressPercent}%</span>
        </div>
        <div style="background: rgba(15, 23, 42, 0.6); height: 8px; border-radius: 4px; overflow: hidden;">
          <div style="background: linear-gradient(90deg, #10b981, #34d399); height: 100%; width: ${progressPercent}%; transition: width 0.3s ease;"></div>
        </div>
      </div>

      <!-- Next Matchday -->
      ${currentMatchday < totalMatchdays ? `
        <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(59, 130, 246, 0.1));
                    border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 12px; padding: 24px; margin-bottom: 20px;">
          <h3 style="color: #10b981; margin-bottom: 15px;">Next Matchday: ${currentMatchday + 1}</h3>
          <div id="nextMatchdayFixtures"></div>
          <button onclick="simulateNextMatchdayNew()" class="btn-primary"
                  style="width: 100%; padding: 16px; margin-top: 15px; font-size: 1.1em; font-weight: 600;">
            ▶️ Simulate Matchday ${currentMatchday + 1}
          </button>
        </div>
      ` : `
        <div style="background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.2));
                    border: 2px solid rgba(251, 191, 36, 0.5); border-radius: 12px; padding: 30px; text-align: center;">
          <div style="font-size: 3em; margin-bottom: 15px;">🏆</div>
          <h3 style="color: #fbbf24; margin-bottom: 10px;">Season Complete!</h3>
          <p style="color: #94a3b8; margin-bottom: 20px;">View final standings and stats</p>
          <button onclick="completeSeasonFinale()" class="btn-primary" style="padding: 14px 28px; font-weight: 600;">
            🎉 View Final Results
          </button>
        </div>
      `}

      <!-- Current Table (Top 5) -->
      <div id="seasonTablePreview"></div>
    </div>
  `;

  displayNextMatchdayFixtures();
  displaySeasonTablePreview();
}

function startNewSeason() {
  const teamCount = parseInt(document.getElementById('seasonTeamCount').value);

  if (!teamCount || teamCount < 4 || teamCount > 20 || teamCount % 2 !== 0) {
    showNotification('error', 'Invalid Team Count', 'Please select 4-20 teams (even number)', 3000);
    return;
  }

  // Get top teams by rating
  const allTeams = window.ALL_TEAMS || window.TEAMS || [];
  if (allTeams.length === 0) {
    showNotification('error', 'No Teams Available', 'Please generate groups first', 3000);
    return;
  }

  const topTeams = allTeams.slice(0, Math.min(teamCount, allTeams.length));

  const success = initializeSeasonMode(topTeams);
  if (success) {
    showNotification('success', 'Season Started!', `Season ${SEASON_STATE.seasonNumber} is ready`, 3000);
    displaySeasonMode();
  }
}

function simulateNextMatchdayNew() {
  if (!SEASON_STATE.active || SEASON_STATE.currentMatchday >= SEASON_STATE.totalMatchdays) {
    return;
  }

  showLoading('Simulating matchday...');

  setTimeout(() => {
    const results = simulateMatchday(SEASON_STATE.currentMatchday);
    hideLoading();

    if (results && results.length > 0) {
      showNotification('success', 'Matchday Complete',
        `Matchday ${SEASON_STATE.currentMatchday} results are in!`, 3000);
      displaySeasonMode();
    }
  }, 500);
}

function displayNextMatchdayFixtures() {
  const container = document.getElementById('nextMatchdayFixtures');
  if (!container || !SEASON_STATE.active) return;

  const nextMatchday = SEASON_STATE.fixtures[SEASON_STATE.currentMatchday];
  if (!nextMatchday) {
    container.innerHTML = '<p style="color: #94a3b8;">No fixtures available</p>';
    return;
  }

  container.innerHTML = nextMatchday.map(fixture => `
    <div style="display: flex; justify-content: space-between; align-items: center;
                padding: 12px; background: rgba(30, 41, 59, 0.4); border-radius: 8px; margin-bottom: 8px;">
      <div style="flex: 1; text-align: right; padding-right: 15px;">
        <span style="color: #f1f5f9; font-weight: 600;">${fixture.home.name}</span>
        <span style="color: #94a3b8; font-size: 0.85em; margin-left: 8px;">(${fixture.home.strength})</span>
      </div>
      <div style="color: #64748b; font-weight: 600;">vs</div>
      <div style="flex: 1; text-align: left; padding-left: 15px;">
        <span style="color: #94a3b8; font-size: 0.85em; margin-right: 8px;">(${fixture.away.strength})</span>
        <span style="color: #f1f5f9; font-weight: 600;">${fixture.away.name}</span>
      </div>
    </div>
  `).join('');
}

function displaySeasonTablePreview() {
  const container = document.getElementById('seasonTablePreview');
  if (!container || !SEASON_STATE.active) return;

  const topFive = SEASON_STATE.table.slice(0, 5);

  container.innerHTML = `
    <div style="background: rgba(30, 41, 59, 0.6); border: 1px solid rgba(71, 85, 105, 0.3);
                border-radius: 12px; padding: 20px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h3 style="color: #10b981; margin: 0;">Current Standings (Top 5)</h3>
        <button onclick="displaySeasonTable()" class="small-btn" style="padding: 6px 12px;">
          View Full Table →
        </button>
      </div>
      <div style="overflow-x: auto;">
        <table style="width: 100%; font-size: 0.9em;">
          <thead>
            <tr>
              <th style="text-align: left;">Pos</th>
              <th style="text-align: left;">Team</th>
              <th>P</th>
              <th>W</th>
              <th>D</th>
              <th>L</th>
              <th>GF</th>
              <th>GA</th>
              <th>GD</th>
              <th>Pts</th>
            </tr>
          </thead>
          <tbody>
            ${topFive.map((entry, idx) => `
              <tr>
                <td style="font-weight: 600; color: ${idx === 0 ? '#fbbf24' : '#94a3b8'};">
                  ${idx + 1}${idx === 0 ? '🏆' : ''}
                </td>
                <td style="font-weight: 600; color: #f1f5f9;">${entry.team.name}</td>
                <td style="text-align: center;">${entry.played}</td>
                <td style="text-align: center; color: #10b981;">${entry.wins}</td>
                <td style="text-align: center; color: #fbbf24;">${entry.draws}</td>
                <td style="text-align: center; color: #ef4444;">${entry.losses}</td>
                <td style="text-align: center;">${entry.goalsFor}</td>
                <td style="text-align: center;">${entry.goalsAgainst}</td>
                <td style="text-align: center; color: ${entry.goalDifference >= 0 ? '#10b981' : '#ef4444'};">
                  ${entry.goalDifference >= 0 ? '+' : ''}${entry.goalDifference}
                </td>
                <td style="text-align: center; font-weight: 700; color: #10b981;">${entry.points}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    </div>
  `;
}

function displaySeasonTable() {
  const out = document.getElementById('output');
  if (!out || !SEASON_STATE.active) return;

  out.innerHTML = `
    <div style="max-width: 1200px; margin: 0 auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="color: #10b981; margin: 0;">📊 League Table</h2>
        <button onclick="displaySeasonMode()" class="btn-secondary">← Back to Season</button>
      </div>

      <div style="background: rgba(30, 41, 59, 0.6); border: 1px solid rgba(71, 85, 105, 0.3);
                  border-radius: 12px; padding: 20px; overflow-x: auto;">
        <table style="width: 100%;">
          <thead>
            <tr>
              <th style="text-align: left; padding: 12px;">Pos</th>
              <th style="text-align: left; padding: 12px;">Team</th>
              <th style="padding: 12px;">Played</th>
              <th style="padding: 12px;">Won</th>
              <th style="padding: 12px;">Draw</th>
              <th style="padding: 12px;">Lost</th>
              <th style="padding: 12px;">GF</th>
              <th style="padding: 12px;">GA</th>
              <th style="padding: 12px;">GD</th>
              <th style="padding: 12px;">Points</th>
              <th style="padding: 12px;">Form</th>
            </tr>
          </thead>
          <tbody>
            ${SEASON_STATE.table.map((entry, idx) => `
              <tr style="border-bottom: 1px solid rgba(71, 85, 105, 0.2);">
                <td style="padding: 12px; font-weight: 600; color: ${
                  idx === 0 ? '#fbbf24' :
                  idx < 4 ? '#10b981' :
                  idx >= SEASON_STATE.table.length - 3 ? '#ef4444' : '#94a3b8'
                };">
                  ${idx + 1}
                  ${idx === 0 ? ' 🏆' : idx < 4 ? ' ⭐' : idx >= SEASON_STATE.table.length - 3 ? ' ⚠️' : ''}
                </td>
                <td style="padding: 12px; font-weight: 600; color: #f1f5f9;">${entry.team.name}</td>
                <td style="padding: 12px; text-align: center;">${entry.played}</td>
                <td style="padding: 12px; text-align: center; color: #10b981;">${entry.wins}</td>
                <td style="padding: 12px; text-align: center; color: #fbbf24;">${entry.draws}</td>
                <td style="padding: 12px; text-align: center; color: #ef4444;">${entry.losses}</td>
                <td style="padding: 12px; text-align: center;">${entry.goalsFor}</td>
                <td style="padding: 12px; text-align: center;">${entry.goalsAgainst}</td>
                <td style="padding: 12px; text-align: center; color: ${entry.goalDifference >= 0 ? '#10b981' : '#ef4444'}; font-weight: 600;">
                  ${entry.goalDifference >= 0 ? '+' : ''}${entry.goalDifference}
                </td>
                <td style="padding: 12px; text-align: center; font-weight: 700; font-size: 1.1em; color: #10b981;">
                  ${entry.points}
                </td>
                <td style="padding: 12px; text-align: center;">
                  ${(entry.form || []).slice(-5).map(result => {
                    const color = result === 'W' ? '#10b981' : result === 'D' ? '#fbbf24' : '#ef4444';
                    return `<span style="display: inline-block; width: 18px; height: 18px; background: ${color};
                                         color: #000; font-weight: bold; border-radius: 3px; line-height: 18px;
                                         margin: 0 1px; font-size: 0.7em;">${result}</span>`;
                  }).join('')}
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>

      <div style="margin-top: 20px; padding: 15px; background: rgba(59, 130, 246, 0.1);
                  border-left: 3px solid #3b82f6; border-radius: 4px;">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
          <div><span style="color: #fbbf24;">🏆</span> <span style="color: #94a3b8;">Champion</span></div>
          <div><span style="color: #10b981;">⭐</span> <span style="color: #94a3b8;">Top 4 (European spots)</span></div>
          <div><span style="color: #ef4444;">⚠️</span> <span style="color: #94a3b8;">Relegation zone</span></div>
        </div>
      </div>
    </div>
  `;
}

function completeSeasonFinale() {
  if (!SEASON_STATE.active || SEASON_STATE.currentMatchday < SEASON_STATE.totalMatchdays) return;

  // Ensure table is sorted before determining champion
  SEASON_STATE.table.sort((a, b) => {
    if (b.points !== a.points) return b.points - a.points;
    const gdDiff = (b.goalsFor - b.goalsAgainst) - (a.goalsFor - a.goalsAgainst);
    if (gdDiff !== 0) return gdDiff;
    if (b.goalsFor !== a.goalsFor) return b.goalsFor - a.goalsFor;
    return a.team.name.localeCompare(b.team.name);
  });

  const champion = SEASON_STATE.table[0];
  const topScorer = getSeasonTopScorer();

  // Store in history
  SEASON_STATE.seasonHistory.push({
    number: SEASON_STATE.seasonNumber,
    champion: champion.team.name,
    teams: SEASON_STATE.teams.map(t => t.name),
    completedDate: new Date().toLocaleDateString(),
    finalTable: [...SEASON_STATE.table]
  });

  // Award manager XP
  if (window.MANAGER_STATE && window.MANAGER_STATE.active) {
    awardManagerXP(500, `Completed Season ${SEASON_STATE.seasonNumber}`);
  }

  // Reset for new season
  SEASON_STATE.seasonNumber++;
  SEASON_STATE.active = false;
  SEASON_STATE.currentStage = 'completed';

  // Save state
  if (typeof AUTO_SAVE !== 'undefined' && AUTO_SAVE.save) {
    AUTO_SAVE.save();
  }

  showNotification('success', '🏆 Season Complete!',
    `${champion.team.name} are the champions!`, 5000);

  displaySeasonMode();
}

function getSeasonTopScorer() {
  if (!SEASON_STATE.seasonStats || !SEASON_STATE.seasonStats.playerStats) return null;

  let topScorer = null;
  let maxGoals = 0;

  Object.values(SEASON_STATE.seasonStats.playerStats).forEach(player => {
    if (player.goals > maxGoals) {
      maxGoals = player.goals;
      topScorer = player;
    }
  });

  return topScorer;
}

// ========================================
// ENHANCED SEASON FUNCTIONS
// ========================================

function simulateMatchday() {
  if (!SEASON_STATE.active || !SEASON_STATE.fixtures) {
    showNotification('error', 'Season Error', 'No active season found', 2000);
    return;
  }

  const matchdayIndex = SEASON_STATE.currentMatchday;
  if (matchdayIndex >= SEASON_STATE.fixtures.length) {
    showNotification('info', 'Season Complete', 'All matchdays have been played', 2000);
    return;
  }

  showLoading(`Simulating Matchday ${matchdayIndex + 1}...`);

  setTimeout(() => {
    const matchday = SEASON_STATE.fixtures[matchdayIndex];

    if (Array.isArray(matchday)) {
      matchday.forEach(match => {
        if (!match.played) {
          const homeTeam = match.home || match.homeTeam;
          const awayTeam = match.away || match.awayTeam;

          if (homeTeam && awayTeam) {
            const result = simulateMatch(homeTeam, awayTeam, true, 1.0, 'normal');

            match.played = true;
            match.result = {
              homeScore: result.scoreA,
              awayScore: result.scoreB
            };

            // Update standings
            updateStandings(homeTeam.name, awayTeam.name, result.scoreA, result.scoreB);

            // Track for favorite club bonus
            if (MANAGER_STATE.active && MANAGER_STATE.favoriteClub) {
              const favoriteClub = MANAGER_STATE.favoriteClub;
              if (homeTeam.name === favoriteClub || awayTeam.name === favoriteClub) {
                const isWin = (homeTeam.name === favoriteClub && result.scoreA > result.scoreB) ||
                              (awayTeam.name === favoriteClub && result.scoreB > result.scoreA);
                if (isWin && typeof awardManagerXP === 'function') {
                  awardManagerXP(15, `${favoriteClub} won! (+50% bonus)`);
                }
              }
            }
          }
        }
      });
    }

    SEASON_STATE.currentMatchday++;

    hideLoading();

    // Award XP
    if (MANAGER_STATE.active && typeof awardManagerXP === 'function') {
      awardManagerXP(10, 'Matchday completed');
    }

    // Save
    if (typeof AUTO_SAVE !== 'undefined' && AUTO_SAVE.save) {
      AUTO_SAVE.save();
    }

    displaySeasonMode();
  }, 800);
}

function updateStandings(homeTeam, awayTeam, homeScore, awayScore) {
  // Update in new standings format
  if (SEASON_STATE.standings && Array.isArray(SEASON_STATE.standings)) {
    const homeData = SEASON_STATE.standings.find(t => t.name === homeTeam);
    const awayData = SEASON_STATE.standings.find(t => t.name === awayTeam);

    if (homeData && awayData) {
      homeData.played++;
      awayData.played++;
      homeData.goalsFor += homeScore;
      homeData.goalsAgainst += awayScore;
      awayData.goalsFor += awayScore;
      awayData.goalsAgainst += homeScore;
      homeData.goalDifference = homeData.goalsFor - homeData.goalsAgainst;
      awayData.goalDifference = awayData.goalsFor - awayData.goalsAgainst;

      if (homeScore > awayScore) {
        homeData.wins++;
        homeData.points += 3;
        if (homeData.form) homeData.form.push('W');
        awayData.losses++;
        if (awayData.form) awayData.form.push('L');
      } else if (awayScore > homeScore) {
        awayData.wins++;
        awayData.points += 3;
        if (awayData.form) awayData.form.push('W');
        homeData.losses++;
        if (homeData.form) homeData.form.push('L');
      } else {
        homeData.draws++;
        homeData.points++;
        if (homeData.form) homeData.form.push('D');
        awayData.draws++;
        awayData.points++;
        if (awayData.form) awayData.form.push('D');
      }

      if (homeData.form && homeData.form.length > 10) homeData.form.shift();
      if (awayData.form && awayData.form.length > 10) awayData.form.shift();
    }
  }

  // Update in legacy table format for compatibility
  if (SEASON_STATE.table && Array.isArray(SEASON_STATE.table)) {
    const homeEntry = SEASON_STATE.table.find(t => t.team && t.team.name === homeTeam);
    const awayEntry = SEASON_STATE.table.find(t => t.team && t.team.name === awayTeam);

    if (homeEntry && awayEntry) {
      homeEntry.played++;
      awayEntry.played++;
      homeEntry.goalsFor += homeScore;
      homeEntry.goalsAgainst += awayScore;
      awayEntry.goalsFor += awayScore;
      awayEntry.goalsAgainst += homeScore;
      homeEntry.goalDifference = homeEntry.goalsFor - homeEntry.goalsAgainst;
      awayEntry.goalDifference = awayEntry.goalsFor - awayEntry.goalsAgainst;

      if (homeScore > awayScore) {
        homeEntry.wins++;
        homeEntry.points += 3;
        if (homeEntry.form) homeEntry.form.push('W');
        awayEntry.losses++;
        if (awayEntry.form) awayEntry.form.push('L');
      } else if (awayScore > homeScore) {
        awayEntry.wins++;
        awayEntry.points += 3;
        if (awayEntry.form) awayEntry.form.push('W');
        homeEntry.losses++;
        if (homeEntry.form) homeEntry.form.push('L');
      } else {
        homeEntry.draws++;
        homeEntry.points++;
        if (homeEntry.form) homeEntry.form.push('D');
        awayEntry.draws++;
        awayEntry.points++;
        if (awayEntry.form) awayEntry.form.push('D');
      }

      if (homeEntry.form && homeEntry.form.length > 5) homeEntry.form.shift();
      if (awayEntry.form && awayEntry.form.length > 5) awayEntry.form.shift();
    }
  }
}

function simulateRestOfSeason() {
  if (!SEASON_STATE.active) {
    showNotification('error', 'Season Error', 'No active season found', 2000);
    return;
  }

  if (!confirm('Simulate all remaining matchdays? This cannot be undone.')) {
    return;
  }

  showLoading('Simulating rest of season...');

  setTimeout(() => {
    while (SEASON_STATE.currentMatchday < SEASON_STATE.totalMatchdays &&
           SEASON_STATE.currentMatchday < SEASON_STATE.fixtures.length) {
      const matchday = SEASON_STATE.fixtures[SEASON_STATE.currentMatchday];

      if (Array.isArray(matchday)) {
        matchday.forEach(match => {
          if (!match.played) {
            const homeTeam = match.home || match.homeTeam;
            const awayTeam = match.away || match.awayTeam;

            if (homeTeam && awayTeam) {
              const result = simulateMatch(homeTeam, awayTeam, true, 1.0, 'normal');
              match.played = true;
              match.result = {
                homeScore: result.scoreA,
                awayScore: result.scoreB
              };
              updateStandings(homeTeam.name, awayTeam.name, result.scoreA, result.scoreB);
            }
          }
        });
      }

      SEASON_STATE.currentMatchday++;
    }

    hideLoading();

    if (MANAGER_STATE.active && typeof awardManagerXP === 'function') {
      awardManagerXP(100, 'Season completed!');
    }

    // Save
    if (typeof AUTO_SAVE !== 'undefined' && AUTO_SAVE.save) {
      AUTO_SAVE.save();
    }

    displaySeasonMode();
  }, 1500);
}

function abandonSeason() {
  if (!confirm('Are you sure you want to abandon this season? All progress will be lost.')) {
    return;
  }

  SEASON_STATE.active = false;
  SEASON_STATE.currentMatchday = 0;
  SEASON_STATE.standings = [];
  SEASON_STATE.fixtures = [];
  SEASON_STATE.results = [];
  SEASON_STATE.table = [];
  SEASON_STATE.teams = [];

  showNotification('info', 'Season Abandoned', 'Season has been abandoned', 2000);
  displaySeasonMode();
}

function viewSeasonFixtures() {
  const out = document.getElementById('output');
  if (!out || !SEASON_STATE.active) {
    showNotification('error', 'No Active Season', 'Please start a season first', 2000);
    return;
  }

  if (!SEASON_STATE.fixtures || SEASON_STATE.fixtures.length === 0) {
    showNotification('error', 'No Fixtures', 'No fixtures available', 2000);
    return;
  }

  // Group fixtures by matchday
  const matchdayGroups = {};
  SEASON_STATE.fixtures.forEach(fixture => {
    const md = fixture.matchday || 1;
    if (!matchdayGroups[md]) matchdayGroups[md] = [];
    matchdayGroups[md].push(fixture);
  });

  const matchdayKeys = Object.keys(matchdayGroups).sort((a, b) => Number(a) - Number(b));

  out.innerHTML = `
    <div style="max-width: 1200px; margin: 0 auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="color: #10b981; margin: 0;">📅 Season Fixtures</h2>
        <button onclick="displaySeasonMode()" class="btn-secondary">← Back</button>
      </div>

      ${matchdayKeys.map(mdKey => {
        const fixtures = matchdayGroups[mdKey];
        const allPlayed = fixtures.every(f => f.played);

        return `
          <div style="background: rgba(30, 41, 59, 0.6); border: 1px solid rgba(71, 85, 105, 0.3);
                      border-radius: 12px; padding: 20px; margin-bottom: 20px;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
              <h3 style="color: ${allPlayed ? '#10b981' : '#f59e0b'}; margin: 0;">
                Matchday ${mdKey} ${allPlayed ? '✓' : '⏳'}
              </h3>
              ${!allPlayed ? `<span style="color: #94a3b8; font-size: 0.9em;">(Not yet played)</span>` : ''}
            </div>

            <div style="display: grid; gap: 12px;">
              ${fixtures.map(fixture => `
                <div style="display: flex; align-items: center; justify-content: space-between;
                            padding: 12px; background: rgba(15, 23, 42, 0.6); border-radius: 8px;
                            border-left: 3px solid ${fixture.played ? (fixture.homeScore > fixture.awayScore ? '#10b981' : fixture.homeScore < fixture.awayScore ? '#ef4444' : '#94a3b8') : 'rgba(71, 85, 105, 0.3)'};">

                  <div style="flex: 1; text-align: right; padding-right: 20px;">
                    <div style="color: #f1f5f9; font-weight: 600;">${fixture.home}</div>
                  </div>

                  <div style="min-width: 80px; text-align: center;">
                    ${fixture.played ? `
                      <div style="background: rgba(16, 185, 129, 0.15); padding: 8px 16px; border-radius: 6px;">
                        <span style="color: #10b981; font-weight: 700; font-size: 1.2em;">
                          ${fixture.homeScore} - ${fixture.awayScore}
                        </span>
                      </div>
                    ` : `
                      <div style="color: #94a3b8; font-weight: 500;">vs</div>
                    `}
                  </div>

                  <div style="flex: 1; text-align: left; padding-left: 20px;">
                    <div style="color: #f1f5f9; font-weight: 600;">${fixture.away}</div>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }).join('')}
    </div>
  `;
}

function viewSeasonStats() {
  const out = document.getElementById('output');
  if (!out || !SEASON_STATE.active) return;

  out.innerHTML = `
    <div style="max-width: 1200px; margin: 0 auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="color: #10b981; margin: 0;">📈 Season Statistics</h2>
        <button onclick="displaySeasonMode()" class="btn-secondary">← Back</button>
      </div>

      <!-- Top Scorers -->
      <div style="background: rgba(30, 41, 59, 0.6); border: 1px solid rgba(71, 85, 105, 0.3);
                  border-radius: 12px; padding: 20px; margin-bottom: 20px;">
        <h3 style="color: #10b981; margin-bottom: 15px;">⚽ Top Scorers</h3>
        <div style="display: grid; gap: 8px;">
          ${getSeasonTopScorers(15).map((scorer, idx) => `
            <div style="display: flex; align-items: center; gap: 12px; padding: 12px;
                        background: ${idx < 3 ? 'rgba(16, 185, 129, 0.1)' : 'rgba(15, 23, 42, 0.4)'};
                        border-left: 3px solid ${idx === 0 ? '#FBBF24' : idx === 1 ? '#94A3B8' : idx === 2 ? '#CD7F32' : 'rgba(71, 85, 105, 0.3)'};
                        border-radius: 6px;">
              <div style="width: 35px; text-align: center; font-weight: 700; font-size: 1.1em; color: ${idx < 3 ? (idx === 0 ? '#FBBF24' : idx === 1 ? '#C0C0C0' : '#CD7F32') : '#64748B'};">
                ${idx < 3 ? ['🥇','🥈','🥉'][idx] : idx + 1}
              </div>
              <div style="flex: 1;">
                <div style="color: #f1f5f9; font-weight: 600;">${scorer.name}</div>
                <div style="color: #94a3b8; font-size: 0.85em;">${scorer.team}</div>
              </div>
              <div style="display: flex; gap: 20px;">
                <div style="text-align: center;">
                  <div style="color: #10b981; font-weight: 700; font-size: 1.2em;">${scorer.goals}</div>
                  <div style="color: #64748b; font-size: 0.75em;">Goals</div>
                </div>
                <div style="text-align: center;">
                  <div style="color: #3b82f6; font-weight: 700;">${scorer.assists || 0}</div>
                  <div style="color: #64748b; font-size: 0.75em;">Assists</div>
                </div>
                <div style="text-align: center;">
                  <div style="color: #8b5cf6; font-weight: 700;">${(scorer.goals * 1 + (scorer.assists || 0) * 0.5).toFixed(1)}</div>
                  <div style="color: #64748b; font-size: 0.75em;">Points</div>
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      </div>

      <!-- Team Stats -->
      <div style="background: rgba(30, 41, 59, 0.6); border: 1px solid rgba(71, 85, 105, 0.3);
                  border-radius: 12px; padding: 20px;">
        <h3 style="color: #10b981; margin-bottom: 15px;">📊 Team Statistics</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
          ${getSeasonTeamStats().map(stat => `
            <div style="padding: 16px; background: rgba(15, 23, 42, 0.6); border-radius: 8px;">
              <div style="color: #94a3b8; font-size: 0.9em; margin-bottom: 8px;">${stat.label}</div>
              <div style="color: #f1f5f9; font-weight: 700; font-size: 1.3em;">${stat.team}</div>
              <div style="color: #10b981; font-weight: 600; margin-top: 5px;">${stat.value}</div>
            </div>
          `).join('')}
        </div>
      </div>
    </div>
  `;
}

function getSeasonTopScorers(limit) {
  const scorers = {};

  // Collect scorers from all played fixtures
  if (SEASON_STATE.fixtures) {
    SEASON_STATE.fixtures.forEach(fixture => {
      if (fixture.played && fixture.scorers) {
        fixture.scorers.forEach(s => {
          const key = `${s.name}_${s.team}`;
          if (!scorers[key]) {
            scorers[key] = { name: s.name, team: s.team, goals: 0, assists: 0 };
          }
          scorers[key].goals += s.goals || 1;
          if (s.assists) scorers[key].assists += s.assists;
        });
      }
    });
  }

  // If no scorers from fixtures, try to extract from PLAYER_DB
  if (Object.keys(scorers).length === 0 && window.PLAYER_DB) {
    Object.values(PLAYER_DB).forEach(player => {
      if (player.goals > 0) {
        const key = `${player.name}_${player.team}`;
        scorers[key] = {
          name: player.name,
          team: player.team,
          goals: player.goals,
          assists: player.assists || 0
        };
      }
    });
  }

  return Object.values(scorers)
    .sort((a, b) => b.goals - a.goals || (b.assists || 0) - (a.assists || 0))
    .slice(0, limit);
}

function getSeasonTeamStats() {
  if (!SEASON_STATE.table || SEASON_STATE.table.length === 0) {
    return [
      { label: 'Most Goals Scored', team: 'N/A', value: '0 goals' },
      { label: 'Best Defense', team: 'N/A', value: '0 conceded' },
      { label: 'Best Form', team: 'N/A', value: '0 wins' }
    ];
  }

  const table = [...SEASON_STATE.table];

  const topScoring = table.sort((a, b) => b.goalsFor - a.goalsFor)[0];
  const bestDefense = table.sort((a, b) => a.goalsAgainst - b.goalsAgainst)[0];
  const bestForm = table.sort((a, b) => {
    const winsA = (a.form || []).filter(r => r === 'W').length;
    const winsB = (b.form || []).filter(r => r === 'W').length;
    return winsB - winsA;
  })[0];

  return [
    { label: 'Most Goals Scored', team: topScoring.team.name, value: topScoring.goalsFor + ' goals' },
    { label: 'Best Defense', team: bestDefense.team.name, value: 'Only ' + bestDefense.goalsAgainst + ' conceded' },
    { label: 'Best Form', team: bestForm.team.name, value: (bestForm.form || []).filter(r => r === 'W').length + ' wins in last 5' }
  ];
}

// ========================================
// HALL OF FAME SYSTEM
// ========================================

// Note: HALL_OF_FAME is defined later in the file with full functionality

function displayHallOfFame() {
  const out = document.getElementById('output');
  if (!out) return;

  out.innerHTML = `
    <div style="max-width: 1400px; margin: 0 auto;">
      <!-- Header -->
      <div style="background: linear-gradient(135deg, rgba(251, 191, 36, 0.3), rgba(245, 158, 11, 0.3));
                  border: 3px solid rgba(251, 191, 36, 0.6); border-radius: 20px; padding: 50px;
                  text-align: center; margin-bottom: 40px; position: relative; overflow: hidden;">
        <div style="position: absolute; top: -100px; right: -100px; font-size: 300px; opacity: 0.1;">🏆</div>
        <div style="position: relative; z-index: 2;">
          <h1 style="color: #FBBF24; font-size: 3.5em; margin-bottom: 15px; font-weight: 900;">
            🏆 Hall of Fame
          </h1>
          <p style="color: var(--textSecondary); font-size: 1.3em;">
            Honoring the greatest achievements in tournament history
          </p>
        </div>
      </div>

      <!-- Stats Overview -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                  gap: 20px; margin-bottom: 40px;">
        ${[
          { label: 'Tournaments Played', value: TOURNAMENT_HISTORY_ENHANCED?.totalTournamentsPlayed || 0, icon: '⚽', color: '#3B82F6' },
          { label: 'Total Matches', value: TOURNAMENT_HISTORY_ENHANCED?.statistics?.totalMatches || 0, icon: '🎯', color: '#10B981' },
          { label: 'Total Goals', value: TOURNAMENT_HISTORY_ENHANCED?.statistics?.totalGoals || 0, icon: '⚔️', color: '#EF4444' },
          { label: 'Biggest Win', value: TOURNAMENT_HISTORY_ENHANCED?.statistics?.biggestWin ?
            `${TOURNAMENT_HISTORY_ENHANCED.statistics.biggestWin.difference} goals` : 'N/A', icon: '📊', color: '#F59E0B' }
        ].map(stat => `
          <div style="background: var(--cardBg); border: 1px solid var(--cardBorder);
                      border-radius: 16px; padding: 24px; text-align: center; transition: all 0.3s; cursor: pointer;"
               onmouseover="this.style.transform='translateY(-4px)'; this.style.borderColor='${stat.color}'"
               onmouseout="this.style.transform='translateY(0)'; this.style.borderColor='var(--cardBorder)'">
            <div style="font-size: 3em; margin-bottom: 10px;">${stat.icon}</div>
            <div style="color: ${stat.color}; font-size: 2em; font-weight: 900; margin-bottom: 8px;">
              ${stat.value}
            </div>
            <div style="color: var(--textSecondary); font-size: 0.95em; font-weight: 600;">${stat.label}</div>
          </div>
        `).join('')}
      </div>

      <!-- Tab Navigation -->
      <div style="display: flex; gap: 12px; margin-bottom: 30px; flex-wrap: wrap;
                  border-bottom: 2px solid var(--cardBorder); padding-bottom: 15px;">
        ${[
          { id: 'champions', name: 'Champions', icon: '👑' },
          { id: 'records', name: 'Records', icon: '📊' },
          { id: 'moments', name: 'Greatest Moments', icon: '⭐' },
          { id: 'legends', name: 'Legends', icon: '🎖️' }
        ].map((tab, idx) => `
          <button onclick="switchHallOfFameTab('${tab.id}')"
                  id="hof-tab-${tab.id}"
                  class="hof-tab ${idx === 0 ? 'active' : ''}"
                  style="padding: 12px 24px; background: ${idx === 0 ? 'rgba(251, 191, 36, 0.2)' : 'var(--cardBg)'};
                         border: 1px solid ${idx === 0 ? 'rgba(251, 191, 36, 0.4)' : 'var(--cardBorder)'};
                         border-radius: 10px; color: ${idx === 0 ? '#FBBF24' : 'var(--textSecondary)'};
                         font-weight: 600; cursor: pointer; transition: all 0.2s; font-size: 1em;"
                  onmouseover="if (!this.classList.contains('active')) { this.style.borderColor='var(--primary)'; this.style.color='var(--primary)'; }"
                  onmouseout="if (!this.classList.contains('active')) { this.style.borderColor='var(--cardBorder)'; this.style.color='var(--textSecondary)'; }">
            ${tab.icon} ${tab.name}
          </button>
        `).join('')}
      </div>

      <!-- Tab Content -->
      <div id="hofContent">
        ${createChampionsTab()}
      </div>

      <div style="text-align: center; margin-top: 40px;">
        <button onclick="showOutput('')" class="btn-secondary"
                style="padding: 16px 32px; font-weight: 600; font-size: 1.1em;">
          ← Back to Main Menu
        </button>
      </div>
    </div>
  `;
}

function createChampionsTab() {
  const champions = TOURNAMENT_HISTORY_ENHANCED?.statistics?.championsByTeam || {};
  const runnersUp = TOURNAMENT_HISTORY_ENHANCED?.statistics?.runnersUpByTeam || {};

  if (Object.keys(champions).length === 0) {
    return `
      <div style="text-align: center; padding: 80px 20px; background: var(--cardBg);
                  border-radius: 16px; border: 1px solid var(--cardBorder);">
        <div style="font-size: 5em; margin-bottom: 20px; opacity: 0.5;">🏆</div>
        <h3 style="color: var(--textSecondary); margin-bottom: 15px;">No Champions Yet</h3>
        <p style="color: var(--textMuted);">Complete tournaments to start building your Hall of Fame</p>
      </div>
    `;
  }

  return `
    <div>
      <!-- Most Championships -->
      <div style="background: var(--cardBg); border: 1px solid var(--cardBorder);
                  border-radius: 16px; padding: 30px; margin-bottom: 30px;">
        <h3 style="color: #FBBF24; margin-bottom: 25px; font-size: 1.5em; display: flex; align-items: center; gap: 12px;">
          <span style="font-size: 1.3em;">👑</span>
          Most Championships
        </h3>

        <div style="display: grid; gap: 16px;">
          ${Object.entries(champions)
            .sort(([,a], [,b]) => b - a)
            .slice(0, 10)
            .map(([team, wins], idx) => {
              const finals = wins + (runnersUp[team] || 0);
              const winRate = finals > 0 ? ((wins / finals) * 100).toFixed(0) : 0;

              return `
                <div style="background: linear-gradient(135deg, rgba(15, 23, 42, 0.8), rgba(30, 41, 59, 0.8));
                            border: 2px solid ${idx === 0 ? 'rgba(251, 191, 36, 0.5)' : 'var(--cardBorder)'};
                            border-radius: 12px; padding: 24px; transition: all 0.3s;"
                     onmouseover="this.style.transform='translateX(8px)'; this.style.borderColor='#FBBF24'"
                     onmouseout="this.style.transform='translateX(0)'; this.style.borderColor='${idx === 0 ? 'rgba(251, 191, 36, 0.5)' : 'var(--cardBorder)'}'">

                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; align-items: center; gap: 20px; flex: 1;">
                      <!-- Rank -->
                      <div style="width: 50px; height: 50px; border-radius: 50%;
                                  background: ${idx === 0 ? 'linear-gradient(135deg, #FBBF24, #F59E0B)' :
                                               idx === 1 ? 'linear-gradient(135deg, #94A3B8, #64748B)' :
                                               idx === 2 ? 'linear-gradient(135deg, #CD7F32, #B8651B)' :
                                               'rgba(71, 85, 105, 0.3)'};
                                  display: flex; align-items: center; justify-content: center;
                                  font-weight: 900; font-size: 1.3em; color: ${idx < 3 ? '#000' : 'var(--text)'};">
                        ${idx + 1}
                      </div>

                      <!-- Team Info -->
                      <div style="flex: 1;">
                        <div style="font-weight: 700; font-size: 1.3em; color: var(--text); margin-bottom: 8px;">
                          ${team}
                        </div>
                        <div style="display: flex; gap: 20px; color: var(--textSecondary); font-size: 0.9em;">
                          <span>Finals: ${finals}</span>
                          <span>Win Rate: ${winRate}%</span>
                          ${runnersUp[team] ? `<span>Runner-up: ${runnersUp[team]}×</span>` : ''}
                        </div>
                      </div>
                    </div>

                    <!-- Trophies -->
                    <div style="text-align: center; padding: 16px 24px; background: rgba(251, 191, 36, 0.1);
                                border: 1px solid rgba(251, 191, 36, 0.3); border-radius: 10px;">
                      <div style="font-size: 2em; margin-bottom: 5px;">🏆</div>
                      <div style="color: #FBBF24; font-weight: 900; font-size: 1.8em;">${wins}</div>
                      <div style="color: var(--textMuted); font-size: 0.75em; text-transform: uppercase;">
                        ${wins === 1 ? 'Trophy' : 'Trophies'}
                      </div>
                    </div>
                  </div>
                </div>
              `;
            }).join('')}
        </div>
      </div>

      <!-- Recent Champions -->
      ${TOURNAMENT_HISTORY_ENHANCED?.completed && TOURNAMENT_HISTORY_ENHANCED.completed.length > 0 ? `
        <div style="background: var(--cardBg); border: 1px solid var(--cardBorder);
                    border-radius: 16px; padding: 30px;">
          <h3 style="color: #10B981; margin-bottom: 25px; font-size: 1.5em; display: flex; align-items: center; gap: 12px;">
            <span style="font-size: 1.3em;">📅</span>
            Recent Champions
          </h3>

          <div style="display: grid; gap: 12px;">
            ${TOURNAMENT_HISTORY_ENHANCED.completed.slice(-5).reverse().map((tournament, idx) => `
              <div style="padding: 20px; background: rgba(15, 23, 42, 0.6); border-radius: 10px;
                          display: flex; justify-content: space-between; align-items: center;
                          border-left: 4px solid #10B981;">
                <div>
                  <div style="color: var(--text); font-weight: 700; font-size: 1.1em; margin-bottom: 5px;">
                    ${tournament.champion || 'Unknown'}
                  </div>
                  <div style="color: var(--textSecondary); font-size: 0.9em;">
                    ${tournament.name || 'Tournament'} • ${tournament.endDate ? new Date(tournament.endDate).toLocaleDateString() : 'N/A'}
                  </div>
                </div>
                <button onclick="viewTournamentDetails(${idx})" class="btn-secondary"
                        style="padding: 8px 16px; font-size: 0.9em;">
                  View Details
                </button>
              </div>
            `).join('')}
          </div>
        </div>
      ` : ''}
    </div>
  `;
}

function createRecordsTab() {
  const stats = TOURNAMENT_HISTORY_ENHANCED?.statistics || {};

  return `
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 24px;">
      <!-- Tournament Records -->
      <div style="background: var(--cardBg); border: 1px solid var(--cardBorder);
                  border-radius: 16px; padding: 30px;">
        <h3 style="color: #3B82F6; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
          <span style="font-size: 1.3em;">🏆</span>
          Tournament Records
        </h3>

        <div style="display: grid; gap: 16px;">
          ${[
            { label: 'Total Tournaments', value: TOURNAMENT_HISTORY_ENHANCED?.totalTournamentsPlayed || 0, icon: '⚽' },
            { label: 'Total Matches', value: stats.totalMatches || 0, icon: '🎯' },
            { label: 'Total Goals', value: stats.totalGoals || 0, icon: '⚔️' },
            { label: 'Average Goals/Match', value: stats.totalMatches > 0 ?
              (stats.totalGoals / stats.totalMatches).toFixed(2) : '0.00', icon: '📊' }
          ].map(record => `
            <div style="display: flex; justify-content: space-between; align-items: center;
                        padding: 16px; background: rgba(15, 23, 42, 0.6); border-radius: 10px;">
              <div style="display: flex; align-items: center; gap: 12px;">
                <span style="font-size: 1.5em;">${record.icon}</span>
                <span style="color: var(--textSecondary);">${record.label}</span>
              </div>
              <span style="color: var(--text); font-weight: 700; font-size: 1.3em;">${record.value}</span>
            </div>
          `).join('')}
        </div>
      </div>

      <!-- Match Records -->
      <div style="background: var(--cardBg); border: 1px solid var(--cardBorder);
                  border-radius: 16px; padding: 30px;">
        <h3 style="color: #F59E0B; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
          <span style="font-size: 1.3em;">🎯</span>
          Match Records
        </h3>

        <div style="display: grid; gap: 16px;">
          ${stats.biggestWin ? `
            <div style="padding: 20px; background: rgba(15, 23, 42, 0.6); border-radius: 10px;">
              <div style="color: var(--textSecondary); font-size: 0.9em; margin-bottom: 10px;">Biggest Win</div>
              <div style="display: flex; justify-content: center; align-items: center; gap: 15px; margin-bottom: 10px;">
                <div style="text-align: right; flex: 1;">
                  <div style="color: var(--text); font-weight: 700; font-size: 1.1em;">
                    ${stats.biggestWin.teamA}
                  </div>
                </div>
                <div style="padding: 10px 20px; background: rgba(16, 185, 129, 0.2);
                            border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 8px;">
                  <span style="color: #10B981; font-weight: 900; font-size: 1.5em;">
                    ${stats.biggestWin.scoreA} - ${stats.biggestWin.scoreB}
                  </span>
                </div>
                <div style="text-align: left; flex: 1;">
                  <div style="color: var(--text); font-weight: 700; font-size: 1.1em;">
                    ${stats.biggestWin.teamB}
                  </div>
                </div>
              </div>
              <div style="text-align: center; color: #F59E0B; font-weight: 600;">
                Goal Difference: ${stats.biggestWin.difference}
              </div>
            </div>
          ` : `
            <div style="padding: 20px; background: rgba(15, 23, 42, 0.6); border-radius: 10px; text-align: center;">
              <div style="color: var(--textMuted);">No records yet</div>
            </div>
          `}

          <div style="padding: 16px; background: rgba(15, 23, 42, 0.6); border-radius: 10px;
                      display: flex; justify-content: space-between; align-items: center;">
            <span style="color: var(--textSecondary);">Most Goals in Match</span>
            <span style="color: var(--text); font-weight: 700; font-size: 1.3em;">
              ${stats.mostGoalsInMatch || 0}
            </span>
          </div>
        </div>
      </div>
    </div>
  `;
}

function createMomentsTab() {
  const moments = [];

  // Generate moments from tournament history
  if (TOURNAMENT_HISTORY_ENHANCED?.completed) {
    TOURNAMENT_HISTORY_ENHANCED.completed.forEach(tournament => {
      if (tournament.champion) {
        moments.push({
          type: 'championship',
          title: `${tournament.champion} Crowned Champions`,
          description: `${tournament.champion} won the ${tournament.name || 'tournament'}`,
          date: tournament.endDate,
          icon: '🏆',
          color: '#FBBF24'
        });
      }

      if (tournament.statistics?.biggestWin) {
        const win = tournament.statistics.biggestWin;
        moments.push({
          type: 'bigwin',
          title: 'Historic Victory',
          description: `${win.teamA} ${win.scoreA}-${win.scoreB} ${win.teamB}`,
          date: tournament.endDate,
          icon: '⚔️',
          color: '#EF4444'
        });
      }
    });
  }

  if (moments.length === 0) {
    return `
      <div style="text-align: center; padding: 80px 20px; background: var(--cardBg);
                  border-radius: 16px; border: 1px solid var(--cardBorder);">
        <div style="font-size: 5em; margin-bottom: 20px; opacity: 0.5;">⭐</div>
        <h3 style="color: var(--textSecondary); margin-bottom: 15px;">No Moments Yet</h3>
        <p style="color: var(--textMuted);">Great moments will be captured as you play</p>
      </div>
    `;
  }

  return `
    <div style="display: grid; gap: 20px;">
      ${moments.slice(0, 20).map(moment => `
        <div style="background: var(--cardBg); border: 1px solid var(--cardBorder);
                    border-left: 4px solid ${moment.color}; border-radius: 12px; padding: 24px;
                    transition: all 0.3s;"
             onmouseover="this.style.transform='translateX(8px)'"
             onmouseout="this.style.transform='translateX(0)'">
          <div style="display: flex; gap: 20px; align-items: start;">
            <div style="font-size: 3em;">${moment.icon}</div>
            <div style="flex: 1;">
              <h4 style="color: ${moment.color}; font-size: 1.3em; margin-bottom: 8px;">
                ${moment.title}
              </h4>
              <p style="color: var(--textSecondary); margin-bottom: 10px; line-height: 1.6;">
                ${moment.description}
              </p>
              <div style="color: var(--textMuted); font-size: 0.85em;">
                ${moment.date ? new Date(moment.date).toLocaleDateString() : 'N/A'}
              </div>
            </div>
          </div>
        </div>
      `).join('')}
    </div>
  `;
}

function createLegendsTab() {
  const legends = getPlayerLegends();

  if (legends.length === 0) {
    return `
      <div style="text-align: center; padding: 80px 20px; background: var(--cardBg);
                  border-radius: 16px; border: 1px solid var(--cardBorder);">
        <div style="font-size: 5em; margin-bottom: 20px; opacity: 0.5;">🎖️</div>
        <h3 style="color: var(--textSecondary); margin-bottom: 15px;">No Legends Yet</h3>
        <p style="color: var(--textMuted);">Complete tournaments to create legendary players</p>
      </div>
    `;
  }

  return `
    <div>
      <div style="text-align: center; margin-bottom: 30px;">
        <h3 style="color: #FBBF24; margin-bottom: 10px;">🎖️ Hall of Fame Players</h3>
        <p style="color: var(--textMuted);">Top performers across all tournaments</p>
      </div>

      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 24px;">
        ${legends.map((player, idx) => `
          <div style="background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(245, 158, 11, 0.1));
                      border: 2px solid rgba(251, 191, 36, 0.3); border-radius: 16px; padding: 24px;
                      transition: all 0.3s; cursor: pointer;"
               onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 10px 30px rgba(251, 191, 36, 0.3)'"
               onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">

            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
              <div style="font-size: 3em;">${idx < 3 ? ['🥇','🥈','🥉'][idx] : '🎖️'}</div>
              <div style="flex: 1;">
                <div style="color: var(--text); font-weight: 700; font-size: 1.3em;">${player.name}</div>
                <div style="color: #FBBF24; font-size: 0.9em;">${player.team}</div>
              </div>
              <div style="text-align: center; padding: 8px 12px; background: rgba(251, 191, 36, 0.2);
                          border-radius: 8px;">
                <div style="color: #FBBF24; font-weight: 700; font-size: 1.1em;">#${idx + 1}</div>
                <div style="color: var(--textMuted); font-size: 0.7em;">RANK</div>
              </div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 16px;">
              <div style="text-align: center; padding: 12px; background: rgba(15, 23, 42, 0.6); border-radius: 8px;">
                <div style="color: #10B981; font-size: 1.5em; font-weight: 700;">${player.goals || 0}</div>
                <div style="color: #94A3B8; font-size: 0.8em;">Goals</div>
              </div>
              <div style="text-align: center; padding: 12px; background: rgba(15, 23, 42, 0.6); border-radius: 8px;">
                <div style="color: #3B82F6; font-size: 1.5em; font-weight: 700;">${player.assists || 0}</div>
                <div style="color: #94A3B8; font-size: 0.8em;">Assists</div>
              </div>
              <div style="text-align: center; padding: 12px; background: rgba(15, 23, 42, 0.6); border-radius: 8px;">
                <div style="color: #F59E0B; font-size: 1.5em; font-weight: 700;">${player.apps || 0}</div>
                <div style="color: #94A3B8; font-size: 0.8em;">Appearances</div>
              </div>
              <div style="text-align: center; padding: 12px; background: rgba(15, 23, 42, 0.6); border-radius: 8px;">
                <div style="color: #8B5CF6; font-size: 1.5em; font-weight: 700;">${player.avgRating ? player.avgRating.toFixed(1) : 'N/A'}</div>
                <div style="color: #94A3B8; font-size: 0.8em;">Avg Rating</div>
              </div>
            </div>

            <div style="padding-top: 12px; border-top: 1px solid rgba(251, 191, 36, 0.2);">
              <div style="display: flex; justify-content: space-between; font-size: 0.85em;">
                <span style="color: var(--textMuted);">Goals/Game</span>
                <span style="color: #10B981; font-weight: 600;">${player.apps > 0 ? (player.goals / player.apps).toFixed(2) : '0.00'}</span>
              </div>
              <div style="display: flex; justify-content: space-between; font-size: 0.85em; margin-top: 6px;">
                <span style="color: var(--textMuted);">Contributions</span>
                <span style="color: #3B82F6; font-weight: 600;">${(player.goals || 0) + (player.assists || 0)}</span>
              </div>
            </div>
          </div>
        `).join('')}
      </div>
    </div>
  `;
}

function getPlayerLegends() {
  const players = [];

  // Collect from PLAYER_DB if available
  if (window.PLAYER_DB) {
    Object.values(PLAYER_DB).forEach(player => {
      if (player.apps >= 3) {  // Minimum 3 appearances to be considered
        players.push({
          name: player.name,
          team: player.team,
          goals: player.goals || 0,
          assists: player.assists || 0,
          apps: player.apps || 0,
          avgRating: player.avgRating || (player.ratings ? player.ratings.reduce((a, b) => a + b, 0) / player.ratings.length : null)
        });
      }
    });
  }

  // Collect from ALL_TIME_PLAYER_DB if available
  if (window.ALL_TIME_PLAYER_DB && players.length === 0) {
    Object.values(ALL_TIME_PLAYER_DB).forEach(player => {
      if (player.apps >= 3) {
        players.push({
          name: player.name,
          team: player.team,
          goals: player.goals || 0,
          assists: player.assists || 0,
          apps: player.apps || 0,
          avgRating: player.avgRating || null
        });
      }
    });
  }

  // Sort by total contributions (goals + assists), then by goals
  return players
    .sort((a, b) => {
      const contribA = (a.goals || 0) + (a.assists || 0);
      const contribB = (b.goals || 0) + (b.assists || 0);
      return contribB - contribA || b.goals - a.goals;
    })
    .slice(0, 12);  // Top 12 legends
}

function switchHallOfFameTab(tabId) {
  // Remove active class from all tabs
  document.querySelectorAll('.hof-tab').forEach(tab => {
    tab.classList.remove('active');
    tab.style.background = 'var(--cardBg)';
    tab.style.borderColor = 'var(--cardBorder)';
    tab.style.color = 'var(--textSecondary)';
  });

  // Add active class to selected tab
  const activeTab = document.getElementById(`hof-tab-${tabId}`);
  if (activeTab) {
    activeTab.classList.add('active');
    activeTab.style.background = 'rgba(251, 191, 36, 0.2)';
    activeTab.style.borderColor = 'rgba(251, 191, 36, 0.4)';
    activeTab.style.color = '#FBBF24';
  }

  // Update content
  const content = document.getElementById('hofContent');
  if (!content) return;

  switch(tabId) {
    case 'champions':
      content.innerHTML = createChampionsTab();
      break;
    case 'records':
      content.innerHTML = createRecordsTab();
      break;
    case 'moments':
      content.innerHTML = createMomentsTab();
      break;
    case 'legends':
      content.innerHTML = createLegendsTab();
      break;
  }
}

// Removed duplicate: function viewTournamentDetails - see later definition

// ========================================
// STORAGE MANAGEMENT - FIX QUOTA ISSUES
// ========================================

const STORAGE_MANAGER = {
  maxSize: 5 * 1024 * 1024, // 5MB limit
  compressionEnabled: true,

  getUsage() {
    let total = 0;
    for (let key in localStorage) {
      if (localStorage.hasOwnProperty(key)) {
        total += localStorage[key].length + key.length;
      }
    }
    return total;
  },

  getUsageMB() {
    return (this.getUsage() / (1024 * 1024)).toFixed(2);
  },

  isNearLimit() {
    return this.getUsage() > (this.maxSize * 0.8);
  },

  // Simple compression using RLE-like encoding for repeated patterns
  compress(data) {
    if (!this.compressionEnabled) return data;

    try {
      const jsonString = JSON.stringify(data);

      // Simple compression: encode repeated patterns
      let compressed = jsonString
        .replace(/"status":"([^"]+)"/g, (m, s) => `"s":"${s}"`)
        .replace(/"timestamp":(\d+)/g, (m, t) => `"t":${t}`)
        .replace(/"team1":"([^"]+)"/g, (m, t) => `"t1":"${t}"`)
        .replace(/"team2":"([^"]+)"/g, (m, t) => `"t2":"${t}"`)
        .replace(/"score1":(\d+)/g, (m, s) => `"s1":${s}`)
        .replace(/"score2":(\d+)/g, (m, s) => `"s2":${s}`)
        .replace(/"winner":"([^"]+)"/g, (m, w) => `"w":"${w}"`)
        .replace(/"matchNumber":(\d+)/g, (m, n) => `"mn":${n}`);

      return compressed;
    } catch (e) {
      console.error('Compression failed:', e);
      return JSON.stringify(data);
    }
  },

  decompress(compressedString) {
    if (!this.compressionEnabled) return JSON.parse(compressedString);

    try {
      // Reverse compression
      let decompressed = compressedString
        .replace(/"s":"([^"]+)"/g, (m, s) => `"status":"${s}"`)
        .replace(/"t":(\d+)/g, (m, t) => `"timestamp":${t}`)
        .replace(/"t1":"([^"]+)"/g, (m, t) => `"team1":"${t}"`)
        .replace(/"t2":"([^"]+)"/g, (m, t) => `"team2":"${t}"`)
        .replace(/"s1":(\d+)/g, (m, s) => `"score1":${s}`)
        .replace(/"s2":(\d+)/g, (m, s) => `"score2":${s}`)
        .replace(/"w":"([^"]+)"/g, (m, w) => `"winner":"${w}"`)
        .replace(/"mn":(\d+)/g, (m, n) => `"matchNumber":${n}`);

      return JSON.parse(decompressed);
    } catch (e) {
      console.error('Decompression failed:', e);
      return JSON.parse(compressedString);
    }
  },

  safeSet(key, value) {
    try {
      const compressed = this.compress(value);

      // Try to save
      localStorage.setItem(key, compressed);
      return true;
    } catch (e) {
      if (e.name === 'QuotaExceededError') {
        console.warn('Storage quota exceeded, attempting cleanup...');

        // Try smart cleanup
        this.smartCleanup();

        try {
          localStorage.setItem(key, this.compress(value));
          showNotification('warning', 'Storage Cleaned', 'Old data cleaned to make room', 2000);
          return true;
        } catch (e2) {
          console.error('Storage still full after cleanup');

          // Last resort: aggressive cleanup
          this.aggressiveCleanup();

          try {
            localStorage.setItem(key, this.compress(value));
            showNotification('warning', 'Aggressive Cleanup', 'Multiple backups removed', 2000);
            return true;
          } catch (e3) {
            showNotification('error', 'Storage Full', 'Cannot save. Export your data!', 3000);
            return false;
          }
        }
      } else {
        console.error('Storage error:', e);
        return false;
      }
    }
  },

  safeGet(key) {
    try {
      const item = localStorage.getItem(key);
      if (!item) return null;

      return this.decompress(item);
    } catch (e) {
      console.error('Failed to retrieve ' + key + ':', e);
      return null;
    }
  },

  smartCleanup() {
    if (window.VERBOSE_LOGGING) console.log('Running smart cleanup...');

    // 1. Remove old auto-backups (keep only last 3)
    this.cleanOldBackups();

    // 2. Trim tournament history to last 50 tournaments
    try {
      const history = this.safeGet('tournamentHistory');
      if (history && history.length > 50) {
        const trimmed = history.slice(-50);
        this.safeSet('tournamentHistory', trimmed);
        if (window.VERBOSE_LOGGING) console.log(`Trimmed tournament history from ${history.length} to 50`);
      }
    } catch (e) {
      console.error('Failed to trim history:', e);
    }

    // 3. Clean TOURNAMENT_HISTORY_ENHANCED
    try {
      const enhanced = this.safeGet('tournamentHistoryEnhanced');
      if (enhanced && enhanced.tournaments && enhanced.tournaments.length > 50) {
        enhanced.tournaments = enhanced.tournaments.slice(-50);
        this.safeSet('tournamentHistoryEnhanced', enhanced);
        if (window.VERBOSE_LOGGING) console.log('Trimmed enhanced tournament history to 50');
      }
    } catch (e) {
      console.error('Failed to trim enhanced history:', e);
    }
  },

  aggressiveCleanup() {
    if (window.VERBOSE_LOGGING) console.log('Running aggressive cleanup...');

    // Remove all backups except current state
    for (let key in localStorage) {
      if (key.startsWith('backup_') || key.startsWith('autoBackup_')) {
        localStorage.removeItem(key);
      }
    }

    // Trim histories to last 20
    try {
      const history = this.safeGet('tournamentHistory');
      if (history && history.length > 20) {
        this.safeSet('tournamentHistory', history.slice(-20));
      }
    } catch (e) {
      console.error('Aggressive trim failed:', e);
    }

    try {
      const enhanced = this.safeGet('tournamentHistoryEnhanced');
      if (enhanced && enhanced.tournaments && enhanced.tournaments.length > 20) {
        enhanced.tournaments = enhanced.tournaments.slice(-20);
        this.safeSet('tournamentHistoryEnhanced', enhanced);
      }
    } catch (e) {
      console.error('Aggressive trim of enhanced failed:', e);
    }
  },

  cleanOldBackups() {
    // Get all backup keys
    const backupKeys = [];
    for (let key in localStorage) {
      if (key.startsWith('backup_') || key.startsWith('autoBackup_')) {
        backupKeys.push(key);
      }
    }

    // Sort by timestamp (extract from key)
    backupKeys.sort((a, b) => {
      const timeA = parseInt(a.split('_')[1]) || 0;
      const timeB = parseInt(b.split('_')[1]) || 0;
      return timeB - timeA; // Newest first
    });

    // Keep only last 3
    if (backupKeys.length > 3) {
      for (let i = 3; i < backupKeys.length; i++) {
        localStorage.removeItem(backupKeys[i]);
      }
      if (window.VERBOSE_LOGGING) console.log(`Removed ${backupKeys.length - 3} old backups`);
    }
  },

  exportToFile() {
    try {
      const data = {
        managerState: this.safeGet('managerState'),
        tournamentHistory: this.safeGet('tournamentHistory'),
        tournamentHistoryEnhanced: this.safeGet('tournamentHistoryEnhanced'),
        seasonState: this.safeGet('seasonState'),
        achievementProgress: this.safeGet('achievementProgress'),
        predictionState: this.safeGet('predictionState'),
        selectedTheme: localStorage.getItem('selectedTheme'),
        exportDate: new Date().toISOString()
      };

      const jsonString = JSON.stringify(data, null, 2);
      const blob = new Blob([jsonString], { type: 'application/json' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = `soccer-sim-backup-${Date.now()}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      showNotification('success', 'Export Complete', 'Data exported to file', 2000);
    } catch (e) {
      console.error('Export failed:', e);
      showNotification('error', 'Export Failed', 'Could not export data', 2000);
    }
  },

  importFromFile(file) {
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const data = JSON.parse(e.target.result);

        // Restore all data
        if (data.managerState) this.safeSet('managerState', data.managerState);
        if (data.tournamentHistory) this.safeSet('tournamentHistory', data.tournamentHistory);
        if (data.tournamentHistoryEnhanced) this.safeSet('tournamentHistoryEnhanced', data.tournamentHistoryEnhanced);
        if (data.seasonState) this.safeSet('seasonState', data.seasonState);
        if (data.achievementProgress) this.safeSet('achievementProgress', data.achievementProgress);
        if (data.predictionState) this.safeSet('predictionState', data.predictionState);
        if (data.selectedTheme) localStorage.setItem('selectedTheme', data.selectedTheme);

        showNotification('success', 'Import Complete', 'Data restored! Reloading...', 2000);
        setTimeout(() => location.reload(), 2000);
      } catch (e) {
        console.error('Import failed:', e);
        showNotification('error', 'Import Failed', 'Invalid backup file', 2000);
      }
    };
    reader.readAsText(file);
  },

  displayStorageInfo() {
    const usage = this.getUsageMB();
    const maxMB = (this.maxSize / (1024 * 1024)).toFixed(2);
    const percentage = ((this.getUsage() / this.maxSize) * 100).toFixed(1);

    let backupCount = 0;
    for (let key in localStorage) {
      if (key.startsWith('backup_') || key.startsWith('autoBackup_')) {
        backupCount++;
      }
    }

    const statusColor = percentage > 80 ? '#EF4444' : percentage > 60 ? '#F59E0B' : '#10B981';

    const out = document.getElementById('content') || document.getElementById('output') || document.getElementById('output');
    if (!out) return;

    out.innerHTML = `
      <div style="max-width: 600px; margin: 0 auto; padding: 20px;">
        <div style="background: linear-gradient(135deg, var(--cardBg) 0%, color-mix(in srgb, var(--cardBg) 95%, var(--primary)) 100%); padding: 30px; border-radius: 16px; border: 1px solid var(--border);">
          <h2 style="margin: 0 0 24px 0; color: var(--text); display: flex; align-items: center; gap: 10px;">
            💾 Storage Management
          </h2>

          <div style="background: var(--bg); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
              <span style="color: var(--textMuted);">Storage Used</span>
              <span style="color: ${statusColor}; font-size: 20px; font-weight: bold;">${usage} MB / ${maxMB} MB</span>
            </div>

            <div style="background: var(--border); height: 24px; border-radius: 12px; overflow: hidden; margin-bottom: 10px;">
              <div style="background: linear-gradient(90deg, ${statusColor}, color-mix(in srgb, ${statusColor} 70%, white)); height: 100%; width: ${percentage}%; transition: width 0.3s ease;"></div>
            </div>

            <div style="display: flex; justify-content: space-between; color: var(--textMuted); font-size: 14px;">
              <span>${percentage}% Full</span>
              <span>${backupCount} Backups</span>
            </div>
          </div>

          ${percentage > 80 ? `
            <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid #EF4444; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
              <div style="color: #EF4444; font-weight: 600; margin-bottom: 5px;">⚠️ Storage Almost Full</div>
              <div style="color: var(--textMuted); font-size: 14px;">Consider cleaning up old data or exporting to a file.</div>
            </div>
          ` : ''}

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <button onclick="STORAGE_MANAGER.smartCleanup(); STORAGE_MANAGER.displayStorageInfo();"
                    class="btn-primary" style="padding: 12px;">
              🧹 Smart Cleanup
            </button>

            <button onclick="if(confirm('Remove old backups and trim history to last 20 tournaments?')) { STORAGE_MANAGER.aggressiveCleanup(); STORAGE_MANAGER.displayStorageInfo(); }"
                    class="btn-danger" style="padding: 12px;">
              🔥 Aggressive Cleanup
            </button>

            <button onclick="STORAGE_MANAGER.exportToFile();"
                    class="btn-success" style="padding: 12px;">
              📥 Export Data
            </button>

            <button onclick="const input = document.createElement('input'); input.type = 'file'; input.accept = '.json'; input.onchange = (e) => STORAGE_MANAGER.importFromFile(e.target.files[0]); input.click();"
                    class="btn-secondary" style="padding: 12px;">
              📤 Import Data
            </button>
          </div>

          <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border);">
            <h3 style="margin: 0 0 12px 0; color: var(--text); font-size: 16px;">Storage Tips</h3>
            <ul style="color: var(--textMuted); font-size: 14px; margin: 0; padding-left: 20px;">
              <li style="margin-bottom: 8px;">Smart Cleanup keeps last 3 backups and 50 tournaments</li>
              <li style="margin-bottom: 8px;">Aggressive Cleanup removes all backups and keeps only 20 tournaments</li>
              <li style="margin-bottom: 8px;">Export regularly to save your progress to a file</li>
              <li>Compression is automatically applied to all saved data</li>
            </ul>
          </div>

          <button onclick="showMainMenu()" class="btn-secondary" style="width: 100%; margin-top: 20px; padding: 12px;">
            ← Back to Menu
          </button>
        </div>
      </div>
    `;
  }
};

// Override AUTO_SAVE to use STORAGE_MANAGER
if (typeof AUTO_SAVE !== 'undefined') {
  const originalSave = AUTO_SAVE.save;
  AUTO_SAVE.save = function() {
    if (!this.enabled) return;

    const success = STORAGE_MANAGER.safeSet('managerState', MANAGER_STATE);
    if (success) {
      this.lastSave = Date.now();
      if (window.VERBOSE_LOGGING) console.log('✓ Auto-saved with compression at', new Date().toLocaleTimeString());
    }
  };

  const originalLoad = AUTO_SAVE.load;
  AUTO_SAVE.load = function() {
    const saved = STORAGE_MANAGER.safeGet('managerState');
    if (saved) {
      Object.assign(MANAGER_STATE, saved);
      if (window.VERBOSE_LOGGING) console.log('✓ Loaded manager state from compressed storage');
      return true;
    }
    return false;
  };
}

// Override backupToLocalStorage if it exists
if (typeof backupToLocalStorage === 'function') {
  const originalBackup = backupToLocalStorage;
  window.backupToLocalStorage = function() {
    const timestamp = Date.now();
    const backupData = {
      managerState: MANAGER_STATE,
      tournamentHistory: TOURNAMENT_HISTORY,
      tournamentHistoryEnhanced: TOURNAMENT_HISTORY_ENHANCED,
      timestamp: timestamp
    };

    STORAGE_MANAGER.safeSet(`backup_${timestamp}`, backupData);
    STORAGE_MANAGER.cleanOldBackups();
    showNotification('success', 'Backup Created', 'Progress saved successfully', 2000);
  };
}

// ========================================
// PREDICTION SYSTEM
// ========================================

let PREDICTION_STATE = {
  active: true,
  totalPredictions: 0,
  correctPredictions: 0,
  predictions: {}, // Store predictions by matchId
  predictionHistory: [],
  streakCurrent: 0,
  streakBest: 0,
  accuracy: 0,
  byStage: {
    group: { total: 0, correct: 0 },
    knockout: { total: 0, correct: 0 },
    final: { total: 0, correct: 0 }
  },
  byConfidence: {
    low: { total: 0, correct: 0 },
    medium: { total: 0, correct: 0 },
    high: { total: 0, correct: 0 }
  },
  confidenceLevels: {
    low: { total: 0, correct: 0 },
    medium: { total: 0, correct: 0 },
    high: { total: 0, correct: 0 }
  },
  achievements: {
    novice: false,      // 10 correct
    expert: false,      // 25 correct
    master: false,      // 50 correct
    psychic: false,     // 10 in a row
    underdog: false     // 5 upset predictions correct
  }
};

// ========================================
// ENHANCED PREDICTIONS - INTERACTIVE
// ========================================

function enablePredictionsForMatch(teamA, teamB, stage, matchId) {
  if (!PREDICTION_STATE.active) {
    return Promise.resolve(null);
  }

  // Check if already predicted
  if (PREDICTION_STATE.predictions[matchId]) {
    if (window.VERBOSE_LOGGING) console.log('Match already predicted');
    return Promise.resolve(PREDICTION_STATE.predictions[matchId]);
  }

  return new Promise((resolve) => {
    showPredictionModal(teamA, teamB, stage, matchId, resolve);
  });
}

function showPredictionModal(teamA, teamB, stage, matchId, callback) {
  const modal = document.createElement('div');
  modal.className = 'modal-backdrop active';
  modal.style.zIndex = '10006';

  // Calculate win probabilities
  const strengthDiff = teamA.strength - teamB.strength;
  let probA = 50 + (strengthDiff * 0.7);
  let probB = 50 - (strengthDiff * 0.7);
  let probDraw = 25;

  // Normalize
  const total = probA + probB + probDraw;
  probA = Math.max(5, Math.min(80, probA / total * 100));
  probB = Math.max(5, Math.min(80, probB / total * 100));
  probDraw = 100 - probA - probB;

  const stageDisplay = STAGE_DISPLAY_NAMES && STAGE_DISPLAY_NAMES[normalizeStageNames ? normalizeStageNames(stage) : stage] || stage;

  modal.innerHTML = `
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-head" style="background: linear-gradient(135deg, rgba(168, 85, 247, 0.2), rgba(139, 92, 246, 0.2));">
        <h2 style="color: #C084FC;">🔮 Make Your Prediction</h2>
        <button class="modal-close" onclick="this.closest('.modal-backdrop').remove(); window._predictionCallback(null)">✕</button>
      </div>

      <div style="padding: 30px;">
        <!-- Stage Info -->
        <div style="text-align: center; margin-bottom: 25px;">
          <div style="color: var(--textSecondary); font-size: 0.9em; margin-bottom: 10px;">
            ${stageDisplay}
          </div>
        </div>

        <!-- Teams Display -->
        <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 20px; align-items: center; margin-bottom: 30px;">
          <!-- Team A -->
          <div style="text-align: center;">
            <div style="font-size: 3em; margin-bottom: 10px;">⚽</div>
            <div style="color: var(--text); font-weight: 700; font-size: 1.3em; margin-bottom: 8px;">
              ${teamA.name}
            </div>
            <div style="display: inline-block; padding: 6px 14px; background: rgba(16, 185, 129, 0.2);
                        border: 1px solid rgba(16, 185, 129, 0.4); border-radius: 20px;">
              <span style="color: #10B981; font-weight: 700;">${teamA.strength}</span>
            </div>
          </div>

          <div style="color: var(--textMuted); font-size: 2em; font-weight: 700;">VS</div>

          <!-- Team B -->
          <div style="text-align: center;">
            <div style="font-size: 3em; margin-bottom: 10px;">⚽</div>
            <div style="color: var(--text); font-weight: 700; font-size: 1.3em; margin-bottom: 8px;">
              ${teamB.name}
            </div>
            <div style="display: inline-block; padding: 6px 14px; background: rgba(59, 130, 246, 0.2);
                        border: 1px solid rgba(59, 130, 246, 0.4); border-radius: 20px;">
              <span style="color: #60A5FA; font-weight: 700;">${teamB.strength}</span>
            </div>
          </div>
        </div>

        <!-- AI Prediction Hint -->
        <div style="background: rgba(168, 85, 247, 0.1); border: 1px solid rgba(168, 85, 247, 0.3);
                    border-radius: 10px; padding: 16px; margin-bottom: 25px;">
          <div style="color: #C084FC; font-weight: 600; margin-bottom: 10px; text-align: center;">
            📊 Win Probabilities
          </div>
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; text-align: center;">
            <div>
              <div style="color: var(--textSecondary); font-size: 0.85em; margin-bottom: 5px;">
                ${teamA.name}
              </div>
              <div style="color: #10B981; font-weight: 700; font-size: 1.3em;">
                ${probA.toFixed(0)}%
              </div>
            </div>
            <div>
              <div style="color: var(--textSecondary); font-size: 0.85em; margin-bottom: 5px;">Draw</div>
              <div style="color: #F59E0B; font-weight: 700; font-size: 1.3em;">
                ${probDraw.toFixed(0)}%
              </div>
            </div>
            <div>
              <div style="color: var(--textSecondary); font-size: 0.85em; margin-bottom: 5px;">
                ${teamB.name}
              </div>
              <div style="color: #60A5FA; font-weight: 700; font-size: 1.3em;">
                ${probB.toFixed(0)}%
              </div>
            </div>
          </div>
        </div>

        <!-- Prediction Options -->
        <div style="margin-bottom: 25px;">
          <label style="display: block; color: var(--textSecondary); margin-bottom: 12px; font-weight: 600;">
            Select Your Prediction:
          </label>
          <div style="display: grid; gap: 12px;">
            <button onclick="makePrediction('${matchId}', 'teamA', '${teamA.name}', '${teamB.name}')"
                    class="prediction-btn"
                    style="padding: 18px; background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.2));
                           border: 2px solid rgba(16, 185, 129, 0.4); border-radius: 10px;
                           color: #10B981; font-weight: 700; font-size: 1.1em; cursor: pointer; transition: all 0.2s;"
                    onmouseover="this.style.transform='scale(1.02)'; this.style.borderColor='#10B981'"
                    onmouseout="this.style.transform='scale(1)'; this.style.borderColor='rgba(16, 185, 129, 0.4)'">
              ${teamA.name} Wins
            </button>

            <button onclick="makePrediction('${matchId}', 'draw', '${teamA.name}', '${teamB.name}')"
                    class="prediction-btn"
                    style="padding: 18px; background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(217, 119, 6, 0.2));
                           border: 2px solid rgba(245, 158, 11, 0.4); border-radius: 10px;
                           color: #F59E0B; font-weight: 700; font-size: 1.1em; cursor: pointer; transition: all 0.2s;"
                    onmouseover="this.style.transform='scale(1.02)'; this.style.borderColor='#F59E0B'"
                    onmouseout="this.style.transform='scale(1)'; this.style.borderColor='rgba(245, 158, 11, 0.4)'">
              Draw
            </button>

            <button onclick="makePrediction('${matchId}', 'teamB', '${teamA.name}', '${teamB.name}')"
                    class="prediction-btn"
                    style="padding: 18px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(37, 99, 235, 0.2));
                           border: 2px solid rgba(59, 130, 246, 0.4); border-radius: 10px;
                           color: #60A5FA; font-weight: 700; font-size: 1.1em; cursor: pointer; transition: all 0.2s;"
                    onmouseover="this.style.transform='scale(1.02)'; this.style.borderColor='#60A5FA'"
                    onmouseout="this.style.transform='scale(1)'; this.style.borderColor='rgba(59, 130, 246, 0.4)'">
              ${teamB.name} Wins
            </button>
          </div>
        </div>

        <!-- Confidence Level -->
        <div style="margin-bottom: 25px;">
          <label style="display: block; color: var(--textSecondary); margin-bottom: 12px; font-weight: 600;">
            Confidence Level:
          </label>
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
            <button onclick="setPredictionConfidence(1)" id="confidence-1"
                    class="confidence-btn active-confidence"
                    style="padding: 12px; background: rgba(168, 85, 247, 0.2);
                           border: 2px solid rgba(168, 85, 247, 0.4); border-radius: 8px;
                           color: #C084FC; font-weight: 600; cursor: pointer; transition: all 0.2s;">
              Low
            </button>
            <button onclick="setPredictionConfidence(2)" id="confidence-2"
                    class="confidence-btn"
                    style="padding: 12px; background: var(--cardBg); border: 1px solid var(--cardBorder);
                           border-radius: 8px; color: var(--textSecondary); font-weight: 600;
                           cursor: pointer; transition: all 0.2s;">
              Medium
            </button>
            <button onclick="setPredictionConfidence(3)" id="confidence-3"
                    class="confidence-btn"
                    style="padding: 12px; background: var(--cardBg); border: 1px solid var(--cardBorder);
                           border-radius: 8px; color: var(--textSecondary); font-weight: 600;
                           cursor: pointer; transition: all 0.2s;">
              High
            </button>
          </div>
        </div>

        <!-- Your Stats -->
        <div style="background: rgba(30, 41, 59, 0.6); border-radius: 10px; padding: 16px; margin-bottom: 20px;">
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; text-align: center;">
            <div>
              <div style="color: var(--textSecondary); font-size: 0.85em; margin-bottom: 5px;">Accuracy</div>
              <div style="color: var(--text); font-weight: 700; font-size: 1.2em;">
                ${PREDICTION_STATE.totalPredictions > 0 ?
                  ((PREDICTION_STATE.correctPredictions / PREDICTION_STATE.totalPredictions) * 100).toFixed(1) : 0}%
              </div>
            </div>
            <div>
              <div style="color: var(--textSecondary); font-size: 0.85em; margin-bottom: 5px;">Streak</div>
              <div style="color: var(--text); font-weight: 700; font-size: 1.2em;">
                ${PREDICTION_STATE.streakCurrent || 0} 🔥
              </div>
            </div>
            <div>
              <div style="color: var(--textSecondary); font-size: 0.85em; margin-bottom: 5px;">Total</div>
              <div style="color: var(--text); font-weight: 700; font-size: 1.2em;">
                ${PREDICTION_STATE.totalPredictions || 0}
              </div>
            </div>
          </div>
        </div>

        <!-- Skip Button -->
        <div style="text-align: center;">
          <button onclick="this.closest('.modal-backdrop').remove(); window._predictionCallback(null)"
                  class="btn-secondary" style="padding: 12px 24px; font-weight: 600;">
            Skip Prediction
          </button>
        </div>
      </div>
    </div>
  `;

  // Store callback globally
  window._predictionCallback = callback;
  window._currentPredictionConfidence = 1;

  document.body.appendChild(modal);
}

function setPredictionConfidence(level) {
  window._currentPredictionConfidence = level;

  // Update UI
  document.querySelectorAll('.confidence-btn').forEach(btn => {
    btn.style.background = 'var(--cardBg)';
    btn.style.border = '1px solid var(--cardBorder)';
    btn.style.color = 'var(--textSecondary)';
  });

  const activeBtn = document.getElementById(`confidence-${level}`);
  if (activeBtn) {
    activeBtn.style.background = 'rgba(168, 85, 247, 0.2)';
    activeBtn.style.border = '2px solid rgba(168, 85, 247, 0.4)';
    activeBtn.style.color = '#C084FC';
  }
}

function makePrediction(matchId, prediction, teamAName, teamBName) {
  const confidence = window._currentPredictionConfidence || 1;

  // Store prediction
  PREDICTION_STATE.predictions[matchId] = {
    prediction: prediction,
    confidence: confidence,
    teamA: teamAName,
    teamB: teamBName,
    timestamp: Date.now()
  };

  PREDICTION_STATE.totalPredictions++;

  // Update by confidence
  const confKey = confidence === 1 ? 'low' : confidence === 2 ? 'medium' : 'high';
  if (!PREDICTION_STATE.byConfidence[confKey]) {
    PREDICTION_STATE.byConfidence[confKey] = { total: 0, correct: 0 };
  }
  PREDICTION_STATE.byConfidence[confKey].total++;

  // Close modal
  const modal = document.querySelector('.modal-backdrop');
  if (modal) modal.remove();

  // Show confirmation
  const predictionText = prediction === 'teamA' ? teamAName :
                        prediction === 'teamB' ? teamBName : 'Draw';
  showNotification('success', 'Prediction Recorded!',
    `You predicted: ${predictionText}`, 2000);

  // Call callback
  if (window._predictionCallback) {
    window._predictionCallback(PREDICTION_STATE.predictions[matchId]);
  }
}

// Update verifyPrediction to show better feedback
function verifyPredictionEnhanced(matchId, actualResult) {
  const prediction = PREDICTION_STATE.predictions[matchId];
  if (!prediction) return;

  // Determine actual outcome
  let actualOutcome;
  if (actualResult.scoreA > actualResult.scoreB) {
    actualOutcome = 'teamA';
  } else if (actualResult.scoreB > actualResult.scoreA) {
    actualOutcome = 'teamB';
  } else {
    actualOutcome = 'draw';
  }

  // Check if correct
  const correct = prediction.prediction === actualOutcome;

  if (correct) {
    PREDICTION_STATE.correctPredictions++;
    PREDICTION_STATE.streakCurrent++;

    if (PREDICTION_STATE.streakCurrent > PREDICTION_STATE.streakBest) {
      PREDICTION_STATE.streakBest = PREDICTION_STATE.streakCurrent;
    }

    // Update by confidence
    const confKey = prediction.confidence === 1 ? 'low' :
                   prediction.confidence === 2 ? 'medium' : 'high';
    PREDICTION_STATE.byConfidence[confKey].correct++;

    // Award XP based on confidence
    const xpReward = prediction.confidence === 3 ? 30 :
                    prediction.confidence === 2 ? 20 : 10;
    if (MANAGER_STATE.active) {
      awardManagerXP(xpReward, `Correct prediction! (+${prediction.confidence === 3 ? 'high' : prediction.confidence === 2 ? 'medium' : 'low'} confidence)`);
    }

    // Show success notification
    showPredictionResultModal(true, prediction, actualResult);
  } else {
    PREDICTION_STATE.streakCurrent = 0;
    showPredictionResultModal(false, prediction, actualResult);
  }

  // Add to history
  PREDICTION_STATE.predictionHistory.push({
    matchId: matchId,
    prediction: prediction,
    actual: actualOutcome,
    correct: correct,
    result: actualResult,
    timestamp: Date.now()
  });

  // Check achievements
  checkPredictionAchievements();
}

function showPredictionResultModal(correct, prediction, actualResult) {
  const modal = document.createElement('div');
  modal.className = 'modal-backdrop active';
  modal.style.zIndex = '10006';

  modal.innerHTML = `
    <div class="modal-content" style="max-width: 500px; text-align: center;">
      <div style="padding: 40px;">
        <div style="font-size: 5em; margin-bottom: 20px;">
          ${correct ? '✅' : '❌'}
        </div>

        <h2 style="color: ${correct ? '#10B981' : '#EF4444'}; font-size: 2em; margin-bottom: 15px;">
          ${correct ? 'Correct Prediction!' : 'Wrong Prediction'}
        </h2>

        <div style="background: var(--cardBg); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
          <div style="display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 15px;">
            <div style="text-align: center;">
              <div style="color: var(--textSecondary); font-size: 0.85em; margin-bottom: 5px;">
                ${prediction.teamA}
              </div>
              <div style="font-size: 2em; font-weight: 900; color: ${actualResult.scoreA > actualResult.scoreB ? '#10B981' : 'var(--textMuted)'};">
                ${actualResult.scoreA}
              </div>
            </div>
            <div style="color: var(--textMuted); font-size: 1.5em;">-</div>
            <div style="text-align: center;">
              <div style="color: var(--textSecondary); font-size: 0.85em; margin-bottom: 5px;">
                ${prediction.teamB}
              </div>
              <div style="font-size: 2em; font-weight: 900; color: ${actualResult.scoreB > actualResult.scoreA ? '#10B981' : 'var(--textMuted)'};">
                ${actualResult.scoreB}
              </div>
            </div>
          </div>

          <div style="padding: 12px; background: ${correct ? 'rgba(16, 185, 129, 0.2)' : 'rgba(239, 68, 68, 0.2)'};
                      border: 1px solid ${correct ? 'rgba(16, 185, 129, 0.4)' : 'rgba(239, 68, 68, 0.4)'};
                      border-radius: 8px;">
            <div style="color: ${correct ? '#10B981' : '#EF4444'}; font-weight: 600;">
              You predicted: ${prediction.prediction === 'teamA' ? prediction.teamA :
                              prediction.prediction === 'teamB' ? prediction.teamB : 'Draw'}
            </div>
          </div>
        </div>

        ${correct ? `
          <div style="background: rgba(251, 191, 36, 0.2); border: 1px solid rgba(251, 191, 36, 0.4);
                      border-radius: 10px; padding: 16px; margin-bottom: 20px;">
            <div style="color: #FBBF24; font-weight: 700;">
              🔥 Current Streak: ${PREDICTION_STATE.streakCurrent}
            </div>
          </div>
        ` : ''}

        <button onclick="this.closest('.modal-backdrop').remove()" class="btn-primary"
                style="padding: 14px 32px; font-weight: 600;">
          Continue
        </button>
      </div>
    </div>
  `;

  document.body.appendChild(modal);

  // Auto-close after 5 seconds
  setTimeout(() => {
    const m = document.querySelector('.modal-backdrop');
    if (m && m.contains(modal.firstElementChild)) m.remove();
  }, 5000);
}

// checkPredictionAchievements is defined later with enhanced implementation (line 18180)
function checkPredictionAchievements_SIMPLE() {
  // Check for achievements
  if (PREDICTION_STATE.correctPredictions >= 10 && ACHIEVEMENT_PROGRESS && !ACHIEVEMENT_PROGRESS.unlockedAchievements.includes('prediction_novice')) {
    const achievement = ACHIEVEMENTS_CONFIG && ACHIEVEMENTS_CONFIG.predictions ? ACHIEVEMENTS_CONFIG.predictions.find(a => a.id === 'novice') : null;
    if (achievement && typeof unlockAchievement === 'function') {
      unlockAchievement('prediction_novice', achievement);
    }
  }

  if (PREDICTION_STATE.correctPredictions >= 25 && ACHIEVEMENT_PROGRESS && !ACHIEVEMENT_PROGRESS.unlockedAchievements.includes('prediction_expert')) {
    const achievement = ACHIEVEMENTS_CONFIG && ACHIEVEMENTS_CONFIG.predictions ? ACHIEVEMENTS_CONFIG.predictions.find(a => a.id === 'expert') : null;
    if (achievement && typeof unlockAchievement === 'function') {
      unlockAchievement('prediction_expert', achievement);
    }
  }

  if (PREDICTION_STATE.correctPredictions >= 50 && ACHIEVEMENT_PROGRESS && !ACHIEVEMENT_PROGRESS.unlockedAchievements.includes('prediction_master')) {
    const achievement = ACHIEVEMENTS_CONFIG && ACHIEVEMENTS_CONFIG.predictions ? ACHIEVEMENTS_CONFIG.predictions.find(a => a.id === 'master') : null;
    if (achievement && typeof unlockAchievement === 'function') {
      unlockAchievement('prediction_master', achievement);
    }
  }

  if (PREDICTION_STATE.streakCurrent >= 10 && ACHIEVEMENT_PROGRESS && !ACHIEVEMENT_PROGRESS.unlockedAchievements.includes('prediction_psychic')) {
    const achievement = ACHIEVEMENTS_CONFIG && ACHIEVEMENTS_CONFIG.predictions ? ACHIEVEMENTS_CONFIG.predictions.find(a => a.id === 'psychic') : null;
    if (achievement && typeof unlockAchievement === 'function') {
      unlockAchievement('prediction_psychic', achievement);
    }
  }
}

// ========================================
// ACHIEVEMENTS SYSTEM - FIXED
// ========================================

const ACHIEVEMENTS_CONFIG = {
  // Manager XP Achievements
  managerXP: {
    rookie: {
      id: 'xp_rookie',
      name: 'Rookie Manager',
      description: 'Reach Level 5',
      icon: '🎓',
      rarity: 'common',
      requirement: 5,
      xpReward: 100,
      unlocked: false
    },
    experienced: {
      id: 'xp_experienced',
      name: 'Experienced Manager',
      description: 'Reach Level 10',
      icon: '📚',
      rarity: 'rare',
      requirement: 10,
      xpReward: 250,
      unlocked: false
    },
    veteran: {
      id: 'xp_veteran',
      name: 'Veteran Manager',
      description: 'Reach Level 25',
      icon: '⭐',
      rarity: 'epic',
      requirement: 25,
      xpReward: 500,
      unlocked: false
    },
    legend: {
      id: 'xp_legend',
      name: 'Legendary Manager',
      description: 'Reach Level 50',
      icon: '👑',
      rarity: 'legendary',
      requirement: 50,
      xpReward: 1000,
      unlocked: false
    },
    icon: {
      id: 'xp_icon',
      name: 'Managerial Icon',
      description: 'Reach Level 100',
      icon: '💎',
      rarity: 'legendary',
      requirement: 100,
      xpReward: 2500,
      unlocked: false
    }
  },

  // Tournament Achievements
  tournaments: {
    firstWin: {
      id: 'tour_first',
      name: 'First Victory',
      description: 'Win your first tournament',
      icon: '🏆',
      rarity: 'common',
      xpReward: 200,
      unlocked: false
    },
    champion5: {
      id: 'tour_5',
      name: 'Serial Winner',
      description: 'Win 5 tournaments',
      icon: '🏆',
      rarity: 'rare',
      xpReward: 500,
      unlocked: false
    },
    champion10: {
      id: 'tour_10',
      name: 'Dynasty Builder',
      description: 'Win 10 tournaments',
      icon: '👑',
      rarity: 'epic',
      xpReward: 1000,
      unlocked: false
    },
    champion25: {
      id: 'tour_25',
      name: 'Tournament Legend',
      description: 'Win 25 tournaments',
      icon: '💫',
      rarity: 'legendary',
      xpReward: 2500,
      unlocked: false
    }
  },

  // Match Achievements
  matches: {
    matches10: {
      id: 'match_10',
      name: 'Getting Started',
      description: 'Complete 10 matches',
      icon: '⚽',
      rarity: 'common',
      xpReward: 50,
      unlocked: false
    },
    matches100: {
      id: 'match_100',
      name: 'Centurion',
      description: 'Complete 100 matches',
      icon: '💯',
      rarity: 'rare',
      xpReward: 300,
      unlocked: false
    },
    matches500: {
      id: 'match_500',
      name: 'Marathon Manager',
      description: 'Complete 500 matches',
      icon: '🎯',
      rarity: 'epic',
      xpReward: 750,
      unlocked: false
    },
    matches1000: {
      id: 'match_1000',
      name: 'Master of the Game',
      description: 'Complete 1000 matches',
      icon: '🌟',
      rarity: 'legendary',
      xpReward: 2000,
      unlocked: false
    }
  },

  // Prediction Achievements (already defined in PREDICTION_STATE)
  predictions: {
    novice: {
      id: 'pred_novice',
      name: 'Novice Predictor',
      description: '10 correct predictions',
      icon: '🔮',
      rarity: 'common',
      xpReward: 100,
      unlocked: false
    },
    expert: {
      id: 'pred_expert',
      name: 'Expert Predictor',
      description: '25 correct predictions',
      icon: '🎯',
      rarity: 'rare',
      xpReward: 250,
      unlocked: false
    },
    master: {
      id: 'pred_master',
      name: 'Master Predictor',
      description: '50 correct predictions',
      icon: '👁️',
      rarity: 'epic',
      xpReward: 500,
      unlocked: false
    },
    psychic: {
      id: 'pred_psychic',
      name: 'Psychic',
      description: '10 correct predictions in a row',
      icon: '🌟',
      rarity: 'legendary',
      xpReward: 1000,
      unlocked: false
    }
  },

  // Season Achievements
  seasons: {
    firstSeason: {
      id: 'season_first',
      name: 'First Season',
      description: 'Complete your first season',
      icon: '📅',
      rarity: 'common',
      xpReward: 200,
      unlocked: false
    },
    champion: {
      id: 'season_champion',
      name: 'League Champion',
      description: 'Win a season league',
      icon: '🏆',
      rarity: 'rare',
      xpReward: 400,
      unlocked: false
    },
    unbeaten: {
      id: 'season_unbeaten',
      name: 'Invincibles',
      description: 'Complete an unbeaten season',
      icon: '💪',
      rarity: 'legendary',
      xpReward: 2000,
      unlocked: false
    }
  }
};

// Track achievement progress
let ACHIEVEMENT_PROGRESS = {
  totalMatches: 0,
  tournamentsWon: 0,
  seasonsCompleted: 0,
  managerLevel: 1,
  unlockedAchievements: []
};

// ========================================
// MANAGER SYSTEM - FIXED
// ========================================

let MANAGER_STATE = {
  active: false,
  managerName: 'Manager',
  teamName: 'My Team',
  level: 1,
  xp: 0,
  xpToNextLevel: 100,
  totalXP: 0,
  matchesManaged: 0,
  tournamentsWon: 0,
  winRate: 0,
  reputation: 'Unknown',
  createdDate: null,

  // Enhanced customization system
  customization: {
    skinTone: 'light',
    hairStyle: 'short',
    hairColor: 'brown',
    facialHair: 'none',
    facialHairColor: 'brown',
    glasses: 'none',
    hat: 'none',
    scarf: 'none',
    shirt: 'polo-blue',
    suit: 'casual',
    accessories: [],
    badge: 'none'
  },

  // Unlocked customization items by level
  unlockedCustomization: {
    skinTones: ['light', 'medium', 'tan', 'dark'],
    hairStyles: ['short', 'medium'],
    hairColors: ['brown', 'black'],
    facialHair: ['none', 'stubble'],
    facialHairColors: ['brown', 'black'],
    glasses: ['none'],
    hats: ['none'],
    scarfs: ['none'],
    shirts: ['polo-blue', 'polo-red'],
    suits: ['casual'],
    accessories: [],
    badges: ['none']
  },

  statistics: {
    totalMatches: 0,
    wins: 0,
    draws: 0,
    losses: 0,
    goalsScored: 0,
    goalsConceded: 0,
    cleanSheets: 0,
    biggestWin: { opponent: '', score: '' },
    longestWinStreak: 0,
    currentWinStreak: 0
  }
};

// Complete customization catalog
const CUSTOMIZATION_CATALOG = {
  skinTones: [
    { id: 'light', name: 'Light', unlockLevel: 1, color: '#FFD7BA' },
    { id: 'medium', name: 'Medium', unlockLevel: 1, color: '#D9A066' },
    { id: 'tan', name: 'Tan', unlockLevel: 1, color: '#C68642' },
    { id: 'dark', name: 'Dark', unlockLevel: 1, color: '#8D5524' }
  ],

  hairStyles: [
    { id: 'short', name: 'Short', unlockLevel: 1, icon: '✂️' },
    { id: 'medium', name: 'Medium', unlockLevel: 1, icon: '💈' },
    { id: 'long', name: 'Long', unlockLevel: 10, icon: '🦁' },
    { id: 'spiky', name: 'Spiky', unlockLevel: 15, icon: '⚡' },
    { id: 'slicked', name: 'Slicked Back', unlockLevel: 20, icon: '✨' },
    { id: 'curly', name: 'Curly', unlockLevel: 25, icon: '🌀' },
    { id: 'bald', name: 'Bald', unlockLevel: 30, icon: '🥚' }
  ],

  hairColors: [
    { id: 'black', name: 'Black', unlockLevel: 1, color: '#2C2C2C' },
    { id: 'brown', name: 'Brown', unlockLevel: 1, color: '#6B4423' },
    { id: 'blonde', name: 'Blonde', unlockLevel: 5, color: '#F5D76E' },
    { id: 'red', name: 'Red', unlockLevel: 10, color: '#C1440E' },
    { id: 'gray', name: 'Gray', unlockLevel: 15, color: '#8E8E93' },
    { id: 'white', name: 'White', unlockLevel: 40, color: '#E8E8E8' }
  ],

  facialHair: [
    { id: 'none', name: 'Clean Shaven', unlockLevel: 1, icon: '👤' },
    { id: 'stubble', name: 'Stubble', unlockLevel: 1, icon: '🧔' },
    { id: 'goatee', name: 'Goatee', unlockLevel: 15, icon: '🐐' },
    { id: 'beard', name: 'Full Beard', unlockLevel: 15, icon: '🧔‍♂️' },
    { id: 'mustache', name: 'Mustache', unlockLevel: 20, icon: '👨' },
    { id: 'handlebar', name: 'Handlebar', unlockLevel: 30, icon: '🎩' },
    { id: 'long-beard', name: 'Long Beard', unlockLevel: 35, icon: '🧙' }
  ],

  glasses: [
    { id: 'none', name: 'No Glasses', unlockLevel: 1, icon: '👁️' },
    { id: 'round', name: 'Round Glasses', unlockLevel: 5, icon: '🤓' },
    { id: 'square', name: 'Square Glasses', unlockLevel: 5, icon: '👓' },
    { id: 'aviator', name: 'Aviator Sunglasses', unlockLevel: 20, icon: '😎' },
    { id: 'sport', name: 'Sport Glasses', unlockLevel: 25, icon: '🏃' },
    { id: 'reading', name: 'Reading Glasses', unlockLevel: 30, icon: '📖' }
  ],

  hats: [
    { id: 'none', name: 'No Hat', unlockLevel: 1, icon: '🙂' },
    { id: 'baseball', name: 'Baseball Cap', unlockLevel: 10, icon: '🧢' },
    { id: 'beanie', name: 'Beanie', unlockLevel: 30, icon: '🎿' },
    { id: 'fedora', name: 'Fedora', unlockLevel: 40, icon: '🎩' },
    { id: 'bucket', name: 'Bucket Hat', unlockLevel: 35, icon: '👒' },
    { id: 'visor', name: 'Visor', unlockLevel: 25, icon: '⛳' }
  ],

  scarfs: [
    { id: 'none', name: 'No Scarf', unlockLevel: 1, icon: '👔' },
    { id: 'team-red', name: 'Red Team Scarf', unlockLevel: 25, icon: '🧣', color: '#EF4444' },
    { id: 'team-blue', name: 'Blue Team Scarf', unlockLevel: 25, icon: '🧣', color: '#3B82F6' },
    { id: 'team-green', name: 'Green Team Scarf', unlockLevel: 25, icon: '🧣', color: '#10B981' },
    { id: 'striped', name: 'Striped Scarf', unlockLevel: 30, icon: '🧣', color: 'linear-gradient(45deg, #EF4444, #F59E0B)' },
    { id: 'luxury', name: 'Luxury Scarf', unlockLevel: 50, icon: '🧣', color: '#FBBF24' }
  ],

  shirts: [
    { id: 'polo-blue', name: 'Blue Polo', unlockLevel: 1, icon: '👕', color: '#3B82F6' },
    { id: 'polo-red', name: 'Red Polo', unlockLevel: 1, icon: '👕', color: '#EF4444' },
    { id: 'polo-green', name: 'Green Polo', unlockLevel: 5, icon: '👕', color: '#10B981' },
    { id: 'polo-black', name: 'Black Polo', unlockLevel: 10, icon: '👕', color: '#1F2937' },
    { id: 'dress-white', name: 'White Dress Shirt', unlockLevel: 15, icon: '👔', color: '#F9FAFB' },
    { id: 'dress-blue', name: 'Blue Dress Shirt', unlockLevel: 15, icon: '👔', color: '#60A5FA' },
    { id: 'tracksuit-top', name: 'Tracksuit Top', unlockLevel: 20, icon: '🏃', color: '#6B7280' }
  ],

  suits: [
    { id: 'casual', name: 'Casual', unlockLevel: 1, icon: '👕' },
    { id: 'smart-casual', name: 'Smart Casual', unlockLevel: 10, icon: '👔' },
    { id: 'formal', name: 'Formal Suit', unlockLevel: 20, icon: '🤵' },
    { id: 'tactical', name: 'Tactical Jacket', unlockLevel: 40, icon: '🧥' },
    { id: 'tracksuit', name: 'Full Tracksuit', unlockLevel: 35, icon: '🏃' },
    { id: 'luxury', name: 'Luxury Suit', unlockLevel: 50, icon: '💼' }
  ],

  badges: [
    { id: 'none', name: 'No Badge', unlockLevel: 1, icon: '' },
    { id: 'rookie', name: 'Rookie Manager', unlockLevel: 5, icon: '🎓' },
    { id: 'champion', name: 'Champion', unlockLevel: 15, icon: '🏆' },
    { id: 'legend', name: 'Legend', unlockLevel: 50, icon: '👑' },
    { id: 'hall-of-fame', name: 'Hall of Fame', unlockLevel: 100, icon: '⭐' }
  ]
};

function promptPrediction(teamA, teamB, stage = 'group', matchId = null) {
  if (!PREDICTION_STATE.active) return null;

  const actualMatchId = matchId || `${teamA.name}_vs_${teamB.name}_${Date.now()}`;

  // Check if already predicted
  if (PREDICTION_STATE.predictions[actualMatchId]) {
    return PREDICTION_STATE.predictions[actualMatchId];
  }

  return new Promise((resolve) => {
    const modal = document.createElement('div');
    modal.className = 'modal-backdrop active';
    modal.style.zIndex = '10005';
    modal.innerHTML = `
      <div class="modal-content" style="max-width: 600px;">
        <div class="modal-head" style="background: linear-gradient(135deg, rgba(168, 85, 247, 0.2), rgba(139, 92, 246, 0.2));
                                       border-bottom: 2px solid rgba(168, 85, 247, 0.3);">
          <h2 style="color: #c084fc; margin: 0;">🔮 Make Your Prediction</h2>
          <button class="modal-close" onclick="this.closest('.modal-backdrop').remove();
                  window._predictionCallback && window._predictionCallback(null)">✕</button>
        </div>

        <div style="padding: 30px;">
          <!-- Stage Badge -->
          <div style="text-align: center; margin-bottom: 20px;">
            <span style="display: inline-block; padding: 6px 16px; background: rgba(168, 85, 247, 0.2);
                         border: 1px solid rgba(168, 85, 247, 0.4); border-radius: 20px;
                         color: #c084fc; font-size: 0.9em; font-weight: 600;">
              ${stage.toUpperCase()} STAGE
            </span>
          </div>

          <!-- Teams Display -->
          <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 20px; align-items: center; margin-bottom: 30px;">
            <div style="text-align: center; padding: 20px; background: rgba(30, 41, 59, 0.6);
                        border-radius: 12px; border: 2px solid transparent; cursor: pointer; transition: all 0.3s;"
                 class="prediction-option" data-prediction="A"
                 onmouseover="this.style.borderColor='#10b981'; this.style.transform='scale(1.05)'"
                 onmouseout="this.style.borderColor='transparent'; this.style.transform='scale(1)'">
              <div style="font-size: 2em; margin-bottom: 10px;">🏟️</div>
              <div style="font-weight: 700; font-size: 1.2em; color: #f1f5f9; margin-bottom: 5px;">${teamA.name}</div>
              <div style="color: #94a3b8; font-size: 0.9em;">Rating: ${teamA.strength}</div>
              <div style="margin-top: 10px; padding: 8px; background: rgba(16, 185, 129, 0.1);
                          border-radius: 6px; font-weight: 600; color: #10b981; opacity: 0;"
                   class="prediction-check">✓ Selected</div>
            </div>

            <div style="text-align: center;">
              <div style="font-size: 1.5em; color: #64748b; font-weight: 600;">VS</div>
            </div>

            <div style="text-align: center; padding: 20px; background: rgba(30, 41, 59, 0.6);
                        border-radius: 12px; border: 2px solid transparent; cursor: pointer; transition: all 0.3s;"
                 class="prediction-option" data-prediction="B"
                 onmouseover="this.style.borderColor='#10b981'; this.style.transform='scale(1.05)'"
                 onmouseout="this.style.borderColor='transparent'; this.style.transform='scale(1)'">
              <div style="font-size: 2em; margin-bottom: 10px;">🏟️</div>
              <div style="font-weight: 700; font-size: 1.2em; color: #f1f5f9; margin-bottom: 5px;">${teamB.name}</div>
              <div style="color: #94a3b8; font-size: 0.9em;">Rating: ${teamB.strength}</div>
              <div style="margin-top: 10px; padding: 8px; background: rgba(16, 185, 129, 0.1);
                          border-radius: 6px; font-weight: 600; color: #10b981; opacity: 0;"
                   class="prediction-check">✓ Selected</div>
            </div>
          </div>

          <!-- Draw Option -->
          <div style="text-align: center; margin-bottom: 30px;">
            <div style="display: inline-block; padding: 16px 32px; background: rgba(30, 41, 59, 0.6);
                        border-radius: 12px; border: 2px solid transparent; cursor: pointer; transition: all 0.3s;"
                 class="prediction-option" data-prediction="D"
                 onmouseover="this.style.borderColor='#fbbf24'; this.style.transform='scale(1.05)'"
                 onmouseout="this.style.borderColor='transparent'; this.style.transform='scale(1)'">
              <div style="font-weight: 700; font-size: 1.1em; color: #fbbf24;">⚖️ Draw</div>
              <div style="margin-top: 8px; padding: 8px; background: rgba(251, 191, 36, 0.1);
                          border-radius: 6px; font-weight: 600; color: #fbbf24; opacity: 0;"
                   class="prediction-check">✓ Selected</div>
            </div>
          </div>

          <!-- Confidence Slider -->
          <div style="margin-bottom: 25px;">
            <label style="display: block; color: #94a3b8; margin-bottom: 10px; font-weight: 600;">
              Confidence Level: <span id="confidenceLabel" style="color: #10b981;">Medium</span>
            </label>
            <input type="range" id="confidenceSlider" min="1" max="3" value="2"
                   style="width: 100%; height: 8px; background: linear-gradient(90deg, #ef4444, #fbbf24, #10b981);
                          border-radius: 4px; outline: none; -webkit-appearance: none;"
                   oninput="updateConfidenceLabel(this.value)">
            <div style="display: flex; justify-content: space-between; margin-top: 5px; font-size: 0.85em; color: #64748b;">
              <span>Low</span>
              <span>Medium</span>
              <span>High</span>
            </div>
          </div>

          <!-- Stats -->
          <div style="background: rgba(168, 85, 247, 0.1); border: 1px solid rgba(168, 85, 247, 0.3);
                      border-radius: 8px; padding: 15px; margin-bottom: 20px;">
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; text-align: center;">
              <div>
                <div style="color: #94a3b8; font-size: 0.85em; margin-bottom: 5px;">Accuracy</div>
                <div style="color: #c084fc; font-weight: 700; font-size: 1.2em;">
                  ${PREDICTION_STATE.totalPredictions > 0 ?
                    ((PREDICTION_STATE.correctPredictions / PREDICTION_STATE.totalPredictions) * 100).toFixed(1) : 0}%
                </div>
              </div>
              <div>
                <div style="color: #94a3b8; font-size: 0.85em; margin-bottom: 5px;">Streak</div>
                <div style="color: #10b981; font-weight: 700; font-size: 1.2em;">
                  ${PREDICTION_STATE.streakCurrent} 🔥
                </div>
              </div>
              <div>
                <div style="color: #94a3b8; font-size: 0.85em; margin-bottom: 5px;">Total</div>
                <div style="color: #f1f5f9; font-weight: 700; font-size: 1.2em;">
                  ${PREDICTION_STATE.totalPredictions}
                </div>
              </div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <button onclick="this.closest('.modal-backdrop').remove();
                           window._predictionCallback && window._predictionCallback(null)"
                    class="btn-secondary" style="width: 100%; padding: 12px;">
              Skip Prediction
            </button>
            <button id="confirmPredictionBtn" onclick="confirmPrediction()"
                    class="btn-primary" style="width: 100%; padding: 12px;" disabled>
              Confirm Prediction
            </button>
          </div>
        </div>
      </div>
    `;

    document.body.appendChild(modal);

    // Store callback
    window._predictionCallback = resolve;
    window._predictionData = {
      teamA: teamA,
      teamB: teamB,
      stage: stage,
      matchId: actualMatchId,
      selected: null
    };

    // Add click handlers for prediction options
    modal.querySelectorAll('.prediction-option').forEach(option => {
      option.addEventListener('click', function() {
        // Remove previous selections
        modal.querySelectorAll('.prediction-option').forEach(opt => {
          opt.style.borderColor = 'transparent';
          opt.querySelector('.prediction-check').style.opacity = '0';
        });

        // Mark this option as selected
        this.style.borderColor = this.dataset.prediction === 'D' ? '#fbbf24' : '#10b981';
        this.querySelector('.prediction-check').style.opacity = '1';

        // Store selection
        window._predictionData.selected = this.dataset.prediction;

        // Enable confirm button
        document.getElementById('confirmPredictionBtn').disabled = false;
      });
    });
  });
}

function updateConfidenceLabel(value) {
  const label = document.getElementById('confidenceLabel');
  if (!label) return;

  if (value == 1) {
    label.textContent = 'Low';
    label.style.color = '#ef4444';
  } else if (value == 2) {
    label.textContent = 'Medium';
    label.style.color = '#fbbf24';
  } else {
    label.textContent = 'High';
    label.style.color = '#10b981';
  }
}

function confirmPrediction() {
  if (!window._predictionData || !window._predictionData.selected) {
    showNotification('error', 'No Selection', 'Please select a prediction', 2000);
    return;
  }

  const confidence = parseInt(document.getElementById('confidenceSlider').value);
  const confidenceText = confidence === 1 ? 'low' : confidence === 2 ? 'medium' : 'high';

  const prediction = {
    matchId: window._predictionData.matchId,
    teamA: window._predictionData.teamA.name,
    teamB: window._predictionData.teamB.name,
    predicted: window._predictionData.selected,
    confidence: confidenceText,
    stage: window._predictionData.stage,
    timestamp: Date.now()
  };

  // Store prediction
  PREDICTION_STATE.predictions[prediction.matchId] = prediction;
  PREDICTION_STATE.totalPredictions++;

  // Close modal
  const modal = document.querySelector('.modal-backdrop');
  if (modal) modal.remove();

  // Call callback
  if (window._predictionCallback) {
    window._predictionCallback(prediction);
    delete window._predictionCallback;
  }

  delete window._predictionData;

  showNotification('success', 'Prediction Recorded!',
    `You predicted: ${prediction.predicted === 'A' ? prediction.teamA :
                      prediction.predicted === 'B' ? prediction.teamB : 'Draw'}`, 2000);
}

function verifyPrediction(matchId, actualResult) {
  const prediction = PREDICTION_STATE.predictions[matchId];
  if (!prediction) return;

  // Determine actual winner
  let actualOutcome;
  if (actualResult.scoreA > actualResult.scoreB) {
    actualOutcome = 'A';
  } else if (actualResult.scoreB > actualResult.scoreA) {
    actualOutcome = 'B';
  } else {
    actualOutcome = 'D';
  }

  // Check if prediction was correct
  const isCorrect = prediction.predicted === actualOutcome;

  // Update statistics
  if (isCorrect) {
    PREDICTION_STATE.correctPredictions++;
    PREDICTION_STATE.streakCurrent++;

    if (PREDICTION_STATE.streakCurrent > PREDICTION_STATE.streakBest) {
      PREDICTION_STATE.streakBest = PREDICTION_STATE.streakCurrent;
    }

    // Update by stage
    if (PREDICTION_STATE.byStage[prediction.stage]) {
      PREDICTION_STATE.byStage[prediction.stage].correct++;
    }

    // Update by confidence
    if (PREDICTION_STATE.confidenceLevels[prediction.confidence]) {
      PREDICTION_STATE.confidenceLevels[prediction.confidence].correct++;
    }

    // Check for upset prediction
    const teamAStrength = actualResult.teamAObj?.strength || 75;
    const teamBStrength = actualResult.teamBObj?.strength || 75;
    const isUpset = Math.abs(teamAStrength - teamBStrength) >= 10;

    if (isUpset) {
      checkPredictionAchievement('underdog');
    }

  } else {
    PREDICTION_STATE.streakCurrent = 0;
  }

  // Update stage totals
  if (PREDICTION_STATE.byStage[prediction.stage]) {
    PREDICTION_STATE.byStage[prediction.stage].total++;
  }

  // Update confidence totals
  if (PREDICTION_STATE.confidenceLevels[prediction.confidence]) {
    PREDICTION_STATE.confidenceLevels[prediction.confidence].total++;
  }

  // Update accuracy
  PREDICTION_STATE.accuracy = (PREDICTION_STATE.correctPredictions / PREDICTION_STATE.totalPredictions) * 100;

  // Store in history
  PREDICTION_STATE.predictionHistory.push({
    ...prediction,
    actualOutcome,
    isCorrect,
    result: actualResult
  });

  // Check achievements
  checkPredictionAchievements();

  // Award manager XP if correct
  if (isCorrect && window.MANAGER_STATE && window.MANAGER_STATE.active) {
    const xp = prediction.confidence === 'high' ? 30 :
               prediction.confidence === 'medium' ? 20 : 10;
    awardManagerXP(xp, 'Correct prediction');
  }

  // Show result notification
  showPredictionResult(prediction, actualOutcome, isCorrect);

  return isCorrect;
}

function showPredictionResult(prediction, actualOutcome, isCorrect) {
  const actualTeam = actualOutcome === 'A' ? prediction.teamA :
                     actualOutcome === 'B' ? prediction.teamB : 'Draw';
  const predictedTeam = prediction.predicted === 'A' ? prediction.teamA :
                        prediction.predicted === 'B' ? prediction.teamB : 'Draw';

  if (isCorrect) {
    showNotification('success', '🎯 Correct Prediction!',
      `You predicted ${predictedTeam} correctly! Streak: ${PREDICTION_STATE.streakCurrent}`, 4000);
  } else {
    showNotification('info', 'Prediction Result',
      `You predicted ${predictedTeam}, but ${actualTeam} was the outcome`, 3000);
  }
}

function checkPredictionAchievements() {
  // Novice Predictor - 10 correct
  if (PREDICTION_STATE.correctPredictions >= 10 && !PREDICTION_STATE.achievements.novice) {
    PREDICTION_STATE.achievements.novice = true;
    unlockAchievement('prediction_novice');
  }

  // Expert Predictor - 25 correct
  if (PREDICTION_STATE.correctPredictions >= 25 && !PREDICTION_STATE.achievements.expert) {
    PREDICTION_STATE.achievements.expert = true;
    unlockAchievement('prediction_expert');
  }

  // Master Predictor - 50 correct
  if (PREDICTION_STATE.correctPredictions >= 50 && !PREDICTION_STATE.achievements.master) {
    PREDICTION_STATE.achievements.master = true;
    unlockAchievement('prediction_master');
  }

  // Psychic - 10 in a row
  if (PREDICTION_STATE.streakBest >= 10 && !PREDICTION_STATE.achievements.psychic) {
    PREDICTION_STATE.achievements.psychic = true;
    unlockAchievement('prediction_psychic');
  }
}

function checkPredictionAchievement(type) {
  // Track upset predictions
  if (type === 'underdog') {
    if (!PREDICTION_STATE.upsetCorrect) {
      PREDICTION_STATE.upsetCorrect = 0;
    }
    PREDICTION_STATE.upsetCorrect++;

    if (PREDICTION_STATE.upsetCorrect >= 5 && !PREDICTION_STATE.achievements.underdog) {
      PREDICTION_STATE.achievements.underdog = true;
      unlockAchievement('prediction_underdog');
    }
  }
}

function togglePredictions() {
  PREDICTION_STATE.active = !PREDICTION_STATE.active;
  const titleEl = document.getElementById('predictionToggleTitle');
  const subtitleEl = document.getElementById('predictionToggleSubtitle');

  if (titleEl) {
    titleEl.textContent = PREDICTION_STATE.active ? '🔮 Predictions: ON' : '🔮 Predictions: OFF';
  }
  if (subtitleEl) {
    subtitleEl.textContent = PREDICTION_STATE.active ? 'Making predictions' : 'Auto-simulate';
  }

  showNotification(
    PREDICTION_STATE.active ? 'success' : 'info',
    'Predictions ' + (PREDICTION_STATE.active ? 'Enabled' : 'Disabled'),
    PREDICTION_STATE.active ? 'You will be prompted to predict matches' : 'Matches will auto-simulate',
    2000
  );
}

function displayPredictionStats() {
  const out = document.getElementById('output');
  if (!out) return;

  const accuracy = PREDICTION_STATE.totalPredictions > 0 ?
    (PREDICTION_STATE.correctPredictions / PREDICTION_STATE.totalPredictions * 100).toFixed(1) : 0;

  out.innerHTML = `
    <div style="max-width: 1200px; margin: 0 auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="color: #c084fc; margin: 0;">🔮 Prediction Statistics</h2>
        <button onclick="showOutput('')" class="btn-secondary">← Back</button>
      </div>

      <!-- Overall Stats -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 30px;">
        <div style="background: linear-gradient(135deg, rgba(168, 85, 247, 0.2), rgba(139, 92, 246, 0.2));
                    border: 1px solid rgba(168, 85, 247, 0.3); border-radius: 12px; padding: 20px; text-align: center;">
          <div style="color: #94a3b8; font-size: 0.9em; margin-bottom: 8px;">Overall Accuracy</div>
          <div style="color: #c084fc; font-size: 2.5em; font-weight: 800;">${accuracy}%</div>
          <div style="color: #64748b; font-size: 0.85em; margin-top: 5px;">
            ${PREDICTION_STATE.correctPredictions} / ${PREDICTION_STATE.totalPredictions}
          </div>
        </div>

        <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.2));
                    border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 12px; padding: 20px; text-align: center;">
          <div style="color: #94a3b8; font-size: 0.9em; margin-bottom: 8px;">Current Streak</div>
          <div style="color: #10b981; font-size: 2.5em; font-weight: 800;">${PREDICTION_STATE.streakCurrent}</div>
          <div style="color: #64748b; font-size: 0.85em; margin-top: 5px;">🔥 In a row</div>
        </div>

        <div style="background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.2));
                    border: 1px solid rgba(251, 191, 36, 0.3); border-radius: 12px; padding: 20px; text-align: center;">
          <div style="color: #94a3b8; font-size: 0.9em; margin-bottom: 8px;">Best Streak</div>
          <div style="color: #fbbf24; font-size: 2.5em; font-weight: 800;">${PREDICTION_STATE.streakBest}</div>
          <div style="color: #64748b; font-size: 0.85em; margin-top: 5px;">⭐ Personal best</div>
        </div>

        <div style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(37, 99, 235, 0.2));
                    border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 12px; padding: 20px; text-align: center;">
          <div style="color: #94a3b8; font-size: 0.9em; margin-bottom: 8px;">Total Predictions</div>
          <div style="color: #60a5fa; font-size: 2.5em; font-weight: 800;">${PREDICTION_STATE.totalPredictions}</div>
          <div style="color: #64748b; font-size: 0.85em; margin-top: 5px;">📊 All time</div>
        </div>
      </div>

      <!-- By Stage Breakdown -->
      <div style="background: rgba(30, 41, 59, 0.6); border: 1px solid rgba(71, 85, 105, 0.3);
                  border-radius: 12px; padding: 24px; margin-bottom: 20px;">
        <h3 style="color: #c084fc; margin-bottom: 20px;">📈 Accuracy by Stage</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
          ${Object.entries(PREDICTION_STATE.byStage).map(([stage, stats]) => {
            const stageAccuracy = stats.total > 0 ? ((stats.correct / stats.total) * 100).toFixed(1) : 0;
            return `
              <div style="padding: 16px; background: rgba(15, 23, 42, 0.6); border-radius: 8px;
                          border-left: 3px solid ${stage === 'group' ? '#3b82f6' : stage === 'knockout' ? '#f59e0b' : '#fbbf24'};">
                <div style="color: #94a3b8; font-size: 0.85em; text-transform: uppercase; margin-bottom: 8px;">
                  ${stage} Stage
                </div>
                <div style="font-size: 1.8em; font-weight: 700; color: #f1f5f9; margin-bottom: 5px;">
                  ${stageAccuracy}%
                </div>
                <div style="color: #64748b; font-size: 0.85em;">
                  ${stats.correct} / ${stats.total} correct
                </div>
              </div>
            `;
          }).join('')}
        </div>
      </div>

      <!-- By Confidence Level -->
      <div style="background: rgba(30, 41, 59, 0.6); border: 1px solid rgba(71, 85, 105, 0.3);
                  border-radius: 12px; padding: 24px; margin-bottom: 20px;">
        <h3 style="color: #c084fc; margin-bottom: 20px;">🎯 Accuracy by Confidence</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
          ${Object.entries(PREDICTION_STATE.confidenceLevels).map(([level, stats]) => {
            const levelAccuracy = stats.total > 0 ? ((stats.correct / stats.total) * 100).toFixed(1) : 0;
            const color = level === 'low' ? '#ef4444' : level === 'medium' ? '#fbbf24' : '#10b981';
            return `
              <div style="padding: 16px; background: rgba(15, 23, 42, 0.6); border-radius: 8px;
                          border-left: 3px solid ${color};">
                <div style="color: #94a3b8; font-size: 0.85em; text-transform: uppercase; margin-bottom: 8px;">
                  ${level} Confidence
                </div>
                <div style="font-size: 1.8em; font-weight: 700; color: ${color}; margin-bottom: 5px;">
                  ${levelAccuracy}%
                </div>
                <div style="color: #64748b; font-size: 0.85em;">
                  ${stats.correct} / ${stats.total} correct
                </div>
              </div>
            `;
          }).join('')}
        </div>
      </div>

      <!-- Recent Predictions -->
      ${PREDICTION_STATE.predictionHistory.length > 0 ? `
        <div style="background: rgba(30, 41, 59, 0.6); border: 1px solid rgba(71, 85, 105, 0.3);
                    border-radius: 12px; padding: 24px;">
          <h3 style="color: #c084fc; margin-bottom: 20px;">📜 Recent Predictions</h3>
          <div style="display: grid; gap: 12px; max-height: 400px; overflow-y: auto;">
            ${PREDICTION_STATE.predictionHistory.slice(-10).reverse().map(pred => `
              <div style="padding: 16px; background: rgba(15, 23, 42, 0.6); border-radius: 8px;
                          border-left: 3px solid ${pred.isCorrect ? '#10b981' : '#ef4444'};">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                  <div style="flex: 1;">
                    <div style="font-weight: 600; color: #f1f5f9; margin-bottom: 5px;">
                      ${pred.teamA} vs ${pred.teamB}
                    </div>
                    <div style="color: #94a3b8; font-size: 0.85em; margin-bottom: 8px;">
                      ${pred.stage.toUpperCase()} • ${pred.confidence.toUpperCase()} confidence
                    </div>
                    <div style="display: flex; gap: 15px; font-size: 0.9em;">
                      <div>
                        <span style="color: #64748b;">Predicted:</span>
                        <span style="color: #c084fc; font-weight: 600; margin-left: 5px;">
                          ${pred.predicted === 'A' ? pred.teamA : pred.predicted === 'B' ? pred.teamB : 'Draw'}
                        </span>
                      </div>
                      <div>
                        <span style="color: #64748b;">Actual:</span>
                        <span style="color: #f1f5f9; font-weight: 600; margin-left: 5px;">
                          ${pred.actualOutcome === 'A' ? pred.teamA : pred.actualOutcome === 'B' ? pred.teamB : 'Draw'}
                        </span>
                      </div>
                    </div>
                  </div>
                  <div style="font-size: 1.5em;">
                    ${pred.isCorrect ? '✅' : '❌'}
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      ` : `
        <div style="text-align: center; padding: 60px; color: #64748b;">
          <div style="font-size: 3em; margin-bottom: 15px;">🔮</div>
          <div style="font-size: 1.1em;">No predictions yet</div>
          <div style="font-size: 0.9em; margin-top: 8px;">Make your first prediction in a match!</div>
        </div>
      `}

      <!-- Achievements -->
      <div style="margin-top: 30px; background: rgba(168, 85, 247, 0.1); border: 1px solid rgba(168, 85, 247, 0.3);
                  border-radius: 12px; padding: 24px;">
        <h3 style="color: #c084fc; margin-bottom: 20px;">🏆 Prediction Achievements</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px;">
          ${[
            { id: 'novice', name: 'Novice Predictor', desc: '10 correct predictions', req: 10 },
            { id: 'expert', name: 'Expert Predictor', desc: '25 correct predictions', req: 25 },
            { id: 'master', name: 'Master Predictor', desc: '50 correct predictions', req: 50 },
            { id: 'psychic', name: 'Psychic', desc: '10 correct in a row', req: 10 },
            { id: 'underdog', name: 'Underdog Specialist', desc: '5 upset predictions', req: 5 }
          ].map(ach => {
            const unlocked = PREDICTION_STATE.achievements[ach.id];
            return `
              <div style="padding: 16px; background: ${unlocked ? 'rgba(16, 185, 129, 0.1)' : 'rgba(15, 23, 42, 0.6)'};
                          border: 1px solid ${unlocked ? 'rgba(16, 185, 129, 0.3)' : 'rgba(71, 85, 105, 0.3)'};
                          border-radius: 8px; text-align: center; opacity: ${unlocked ? '1' : '0.5'};">
                <div style="font-size: 2em; margin-bottom: 8px;">${unlocked ? '🏆' : '🔒'}</div>
                <div style="font-weight: 600; color: ${unlocked ? '#10b981' : '#64748b'}; margin-bottom: 5px;">
                  ${ach.name}
                </div>
                <div style="font-size: 0.85em; color: #94a3b8;">${ach.desc}</div>
              </div>
            `;
          }).join('')}
        </div>
      </div>
    </div>
  `;
}

// ========================================
// MANAGER XP & ACHIEVEMENT FUNCTIONS
// ========================================

function awardManagerXP(amount, reason = '') {
  if (!MANAGER_STATE.active) {
    console.log('Manager system not active, XP not awarded');
    return;
  }

  const oldLevel = MANAGER_STATE.level;
  MANAGER_STATE.xp += amount;
  MANAGER_STATE.totalXP += amount;

  if (window.VERBOSE_LOGGING) console.log(`✨ +${amount} XP awarded${reason ? ': ' + reason : ''}`);

  // Check for level up
  let leveledUp = false;
  while (MANAGER_STATE.xp >= MANAGER_STATE.xpToNextLevel) {
    MANAGER_STATE.xp -= MANAGER_STATE.xpToNextLevel;
    MANAGER_STATE.level++;
    leveledUp = true;

    // Calculate next level XP requirement (exponential curve)
    MANAGER_STATE.xpToNextLevel = Math.floor(100 * Math.pow(1.15, MANAGER_STATE.level - 1));
  }

  // Show XP notification
  showXPNotification(amount, reason);

  // Handle level up
  if (leveledUp) {
    handleLevelUp(oldLevel, MANAGER_STATE.level);
  }

  // Check for XP-based achievements
  checkManagerXPAchievements();

  // Save state
  if (typeof AUTO_SAVE !== 'undefined' && AUTO_SAVE.save) {
    AUTO_SAVE.save();
  }
}

function showXPNotification(amount, reason) {
  // Create floating XP indicator
  const notification = document.createElement('div');
  notification.style.cssText = `
    position: fixed;
    top: 100px;
    right: 20px;
    background: linear-gradient(135deg, rgba(251, 191, 36, 0.95), rgba(245, 158, 11, 0.95));
    color: #1a1a2e;
    padding: 12px 20px;
    border-radius: 12px;
    font-weight: 700;
    font-size: 1.1em;
    box-shadow: 0 8px 24px rgba(251, 191, 36, 0.4);
    z-index: 10002;
    animation: slideInRight 0.3s ease, fadeOut 0.3s ease 2.7s;
    pointer-events: none;
  `;

  notification.innerHTML = `
    <div style="display: flex; align-items: center; gap: 10px;">
      <span style="font-size: 1.5em;">✨</span>
      <div>
        <div style="font-size: 1.2em;">+${amount} XP</div>
        ${reason ? `<div style="font-size: 0.8em; opacity: 0.8;">${reason}</div>` : ''}
      </div>
    </div>
  `;

  document.body.appendChild(notification);

  setTimeout(() => notification.remove(), 3000);
}

function handleLevelUp(oldLevel, newLevel) {
  console.log(`🎉 LEVEL UP! ${oldLevel} → ${newLevel}`);

  // Show level up modal
  const modal = document.createElement('div');
  modal.className = 'modal-backdrop active';
  modal.style.zIndex = '10006';
  modal.innerHTML = `
    <div class="modal-content" style="max-width: 600px; text-align: center;">
      <div style="padding: 40px;">
        <div style="font-size: 5em; margin-bottom: 20px; animation: bounce 0.6s ease;">🎉</div>
        <h2 style="color: #fbbf24; font-size: 2.5em; margin-bottom: 15px;">LEVEL UP!</h2>
        <div style="font-size: 1.5em; color: #f1f5f9; margin-bottom: 10px;">
          Level ${oldLevel} → Level ${newLevel}
        </div>

        <!-- Progress Bar -->
        <div style="margin: 30px 0;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px; color: #94a3b8; font-size: 0.9em;">
            <span>XP: ${MANAGER_STATE.xp}</span>
            <span>Next: ${MANAGER_STATE.xpToNextLevel}</span>
          </div>
          <div style="background: rgba(15, 23, 42, 0.6); height: 12px; border-radius: 6px; overflow: hidden;">
            <div style="background: linear-gradient(90deg, #fbbf24, #f59e0b); height: 100%;
                        width: ${(MANAGER_STATE.xp / MANAGER_STATE.xpToNextLevel * 100)}%;
                        transition: width 0.5s ease;"></div>
          </div>
        </div>

        <!-- Rewards -->
        <div style="background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.2));
                    border: 1px solid rgba(251, 191, 36, 0.4); border-radius: 12px; padding: 20px; margin-bottom: 25px;">
          <h3 style="color: #fbbf24; margin-bottom: 15px;">🎁 Rewards Unlocked</h3>
          <div id="levelUpRewards"></div>
        </div>

        <button onclick="this.closest('.modal-backdrop').remove()"
                class="btn-primary" style="width: 100%; padding: 16px; font-size: 1.1em; font-weight: 700;">
          Continue
        </button>
      </div>
    </div>
  `;

  document.body.appendChild(modal);

  // Calculate and display rewards
  setTimeout(() => {
    const rewards = calculateLevelRewards(newLevel);
    displayLevelRewards(rewards);
  }, 100);

  // Play sound if available
  if (window.SOUND_ENABLED && window.playSound) {
    playSound('levelup');
  }

  // Update reputation
  updateManagerReputation();
}

function calculateLevelRewards(level) {
  const rewards = [];

  // Check each category for unlocks
  Object.entries(CUSTOMIZATION_CATALOG).forEach(([category, items]) => {
    items.forEach(item => {
      if (item.unlockLevel === level) {
        // Add to unlocked items
        const categoryKey = category; // e.g., 'hairStyles'
        if (MANAGER_STATE.unlockedCustomization[categoryKey]) {
          if (!MANAGER_STATE.unlockedCustomization[categoryKey].includes(item.id)) {
            MANAGER_STATE.unlockedCustomization[categoryKey].push(item.id);
            rewards.push({
              type: 'customization',
              item: item.name,
              category: category,
              icon: item.icon,
              name: `Unlocked: ${item.name}`
            });
          }
        }
      }
    });
  });

  // Generic XP bonus if no specific unlocks
  if (rewards.length === 0) {
    rewards.push({
      type: 'xp',
      amount: level * 10,
      name: `Bonus XP: +${level * 10}`
    });
  }

  return rewards;
}

function displayLevelRewards(rewards) {
  const container = document.getElementById('levelUpRewards');
  if (!container) return;

  if (rewards.length === 0) {
    container.innerHTML = '<div style="color: #94a3b8;">Keep playing to unlock more rewards!</div>';
    return;
  }

  container.innerHTML = rewards.map(reward => `
    <div style="padding: 12px; background: rgba(251, 191, 36, 0.1); border-radius: 8px;
                margin-bottom: 10px; text-align: left;">
      <div style="display: flex; align-items: center; gap: 12px;">
        <span style="font-size: 2em;">
          ${reward.type === 'customization' ? '👔' :
            reward.type === 'xp' ? '✨' : '🎁'}
        </span>
        <div style="flex: 1;">
          <div style="color: #f1f5f9; font-weight: 600;">${reward.name}</div>
          ${reward.item ? `<div style="color: #94a3b8; font-size: 0.85em;">Customization: ${reward.item}</div>` : ''}
        </div>
      </div>
    </div>
  `).join('');
}

function updateManagerReputation() {
  const level = MANAGER_STATE.level;

  if (level >= 50) {
    MANAGER_STATE.reputation = 'Legendary';
  } else if (level >= 40) {
    MANAGER_STATE.reputation = 'World Class';
  } else if (level >= 30) {
    MANAGER_STATE.reputation = 'Elite';
  } else if (level >= 20) {
    MANAGER_STATE.reputation = 'Established';
  } else if (level >= 10) {
    MANAGER_STATE.reputation = 'Promising';
  } else if (level >= 5) {
    MANAGER_STATE.reputation = 'Developing';
  } else {
    MANAGER_STATE.reputation = 'Unknown';
  }
}

function checkManagerXPAchievements() {
  const level = MANAGER_STATE.level;

  Object.entries(ACHIEVEMENTS_CONFIG.managerXP).forEach(([key, achievement]) => {
    if (!achievement.unlocked && level >= achievement.requirement) {
      unlockAchievement(achievement.id, achievement);
    }
  });
}

function checkTournamentAchievements() {
  const wins = ACHIEVEMENT_PROGRESS.tournamentsWon;

  if (wins >= 1 && !ACHIEVEMENTS_CONFIG.tournaments.firstWin.unlocked) {
    unlockAchievement('tour_first', ACHIEVEMENTS_CONFIG.tournaments.firstWin);
  }
  if (wins >= 5 && !ACHIEVEMENTS_CONFIG.tournaments.champion5.unlocked) {
    unlockAchievement('tour_5', ACHIEVEMENTS_CONFIG.tournaments.champion5);
  }
  if (wins >= 10 && !ACHIEVEMENTS_CONFIG.tournaments.champion10.unlocked) {
    unlockAchievement('tour_10', ACHIEVEMENTS_CONFIG.tournaments.champion10);
  }
  if (wins >= 25 && !ACHIEVEMENTS_CONFIG.tournaments.champion25.unlocked) {
    unlockAchievement('tour_25', ACHIEVEMENTS_CONFIG.tournaments.champion25);
  }
}

function checkMatchAchievements() {
  const matches = ACHIEVEMENT_PROGRESS.totalMatches;

  if (matches >= 10 && !ACHIEVEMENTS_CONFIG.matches.matches10.unlocked) {
    unlockAchievement('match_10', ACHIEVEMENTS_CONFIG.matches.matches10);
  }
  if (matches >= 100 && !ACHIEVEMENTS_CONFIG.matches.matches100.unlocked) {
    unlockAchievement('match_100', ACHIEVEMENTS_CONFIG.matches.matches100);
  }
  if (matches >= 500 && !ACHIEVEMENTS_CONFIG.matches.matches500.unlocked) {
    unlockAchievement('match_500', ACHIEVEMENTS_CONFIG.matches.matches500);
  }
  if (matches >= 1000 && !ACHIEVEMENTS_CONFIG.matches.matches1000.unlocked) {
    unlockAchievement('match_1000', ACHIEVEMENTS_CONFIG.matches.matches1000);
  }
}

function unlockAchievement(achievementId, achievementData) {
  // Prevent duplicate unlocks
  if (ACHIEVEMENT_PROGRESS.unlockedAchievements.includes(achievementId)) {
    return;
  }

  // Mark as unlocked
  achievementData.unlocked = true;
  ACHIEVEMENT_PROGRESS.unlockedAchievements.push(achievementId);

  if (window.VERBOSE_LOGGING) console.log(`🏆 Achievement Unlocked: ${achievementData.name}`);

  // Award XP
  if (achievementData.xpReward && MANAGER_STATE.active) {
    awardManagerXP(achievementData.xpReward, `Achievement: ${achievementData.name}`);
  }

  // Show achievement notification
  showAchievementUnlock(achievementData);

  // Save progress
  if (typeof AUTO_SAVE !== 'undefined' && AUTO_SAVE.save) {
    AUTO_SAVE.save();
  }
}

function showAchievementUnlock(achievement) {
  const notification = document.createElement('div');
  notification.className = 'achievement-notification';
  notification.style.cssText = `
    position: fixed;
    top: 80px;
    right: -400px;
    width: 350px;
    background: linear-gradient(135deg, rgba(17, 24, 39, 0.98), rgba(31, 41, 55, 0.98));
    border-radius: 12px;
    border: 2px solid ${
      achievement.rarity === 'legendary' ? '#f59e0b' :
      achievement.rarity === 'epic' ? '#a855f7' :
      achievement.rarity === 'rare' ? '#3b82f6' : '#10b981'
    };
    box-shadow: 0 8px 32px ${
      achievement.rarity === 'legendary' ? 'rgba(245, 158, 11, 0.4)' :
      achievement.rarity === 'epic' ? 'rgba(168, 85, 247, 0.4)' :
      achievement.rarity === 'rare' ? 'rgba(59, 130, 246, 0.4)' : 'rgba(16, 185, 129, 0.4)'
    };
    padding: 20px;
    z-index: 10003;
    animation: slideInAchievement 0.5s ease forwards, slideOutAchievement 0.5s ease 4.5s forwards;
  `;

  notification.innerHTML = `
    <div style="display: flex; gap: 16px; align-items: center;">
      <div style="font-size: 3em;">${achievement.icon}</div>
      <div style="flex: 1;">
        <div style="color: ${
          achievement.rarity === 'legendary' ? '#fbbf24' :
          achievement.rarity === 'epic' ? '#c084fc' :
          achievement.rarity === 'rare' ? '#60a5fa' : '#10b981'
        }; font-size: 0.75em; text-transform: uppercase; letter-spacing: 0.1em;
                    font-weight: 700; margin-bottom: 5px;">
          🏆 Achievement Unlocked
        </div>
        <div style="color: #f1f5f9; font-weight: 700; font-size: 1.1em; margin-bottom: 5px;">
          ${achievement.name}
        </div>
        <div style="color: #94a3b8; font-size: 0.85em;">
          ${achievement.description}
        </div>
        ${achievement.xpReward ? `
          <div style="margin-top: 8px; color: #fbbf24; font-weight: 600; font-size: 0.9em;">
            ✨ +${achievement.xpReward} XP
          </div>
        ` : ''}
      </div>
    </div>
  `;

  document.body.appendChild(notification);

  // Remove after animation
  setTimeout(() => notification.remove(), 5000);

  // Play sound if available
  if (window.SOUND_ENABLED && window.playSound) {
    playSound('achievement');
  }
}

// ========================================
// MANAGER PROFILE & SETUP FUNCTIONS
// ========================================

function displayManagerProfile() {
  if (!MANAGER_STATE.active) {
    showManagerSetup();
    return;
  }

  const out = document.getElementById('content') || document.getElementById('output') || document.getElementById('output');
  if (!out) return;

  // Calculate progress percentage
  const xpProgress = (MANAGER_STATE.xp / MANAGER_STATE.xpToNextLevel * 100).toFixed(1);

  // Get favorite club stats
  const favoriteClub = MANAGER_STATE.favoriteClub || null;
  const favoriteClubMatches = favoriteClub ?
    (MANAGER_STATE.statistics.clubSpecificStats?.[favoriteClub]?.matches || 0) : 0;
  const favoriteClubWins = favoriteClub ?
    (MANAGER_STATE.statistics.clubSpecificStats?.[favoriteClub]?.wins || 0) : 0;

  out.innerHTML = `
    <div style="max-width: 1200px; margin: 0 auto;">
      <!-- Profile Header Card -->
      <div style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(139, 92, 246, 0.15));
                  border: 2px solid rgba(139, 92, 246, 0.4); border-radius: 20px; padding: 40px;
                  margin-bottom: 30px; position: relative; overflow: hidden;">

        <!-- Background Pattern -->
        <div style="position: absolute; top: -50%; right: -50%; width: 200%; height: 200%;
                    background: radial-gradient(circle, rgba(139, 92, 246, 0.1) 0%, transparent 70%);
                    animation: pulse 8s ease-in-out infinite;"></div>

        <div style="position: relative; z-index: 2; display: grid; grid-template-columns: auto 1fr auto;
                    gap: 30px; align-items: center;">

          <!-- Avatar Column -->
          <div style="text-align: center;">
            ${createManagerAvatar('large', false)}
            <button onclick="showManagerCustomization()"
                    class="btn-secondary"
                    style="margin-top: 15px; padding: 10px 20px; font-size: 0.9em; width: 100%;">
              👔 Customize
            </button>
          </div>

          <!-- Info Column -->
          <div>
            <h1 style="color: #A78BFA; font-size: 2.5em; margin-bottom: 8px; font-weight: 900;">
              ${MANAGER_STATE.managerName}
            </h1>
            <div style="color: #94A3B8; font-size: 1.2em; margin-bottom: 20px;">
              ${MANAGER_STATE.teamName}
            </div>

            <!-- Reputation & Level -->
            <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
              <div style="padding: 8px 16px; background: rgba(251, 191, 36, 0.2);
                          border: 1px solid rgba(251, 191, 36, 0.4); border-radius: 20px;">
                <span style="color: #FBBF24; font-weight: 700;">👑 ${MANAGER_STATE.reputation}</span>
              </div>
              <div style="padding: 8px 16px; background: rgba(16, 185, 129, 0.2);
                          border: 1px solid rgba(16, 185, 129, 0.4); border-radius: 20px;">
                <span style="color: #10B981; font-weight: 700;">Level ${MANAGER_STATE.level}</span>
              </div>
              <div style="padding: 8px 16px; background: rgba(59, 130, 246, 0.2);
                          border: 1px solid rgba(59, 130, 246, 0.4); border-radius: 20px;">
                <span style="color: #60A5FA; font-weight: 700;">${MANAGER_STATE.winRate}% Win Rate</span>
              </div>
              ${favoriteClub ? `
                <div style="padding: 8px 16px; background: rgba(168, 85, 247, 0.2);
                            border: 1px solid rgba(168, 85, 247, 0.4); border-radius: 20px;">
                  <span style="color: #C084FC; font-weight: 700;">❤️ ${favoriteClub}</span>
                </div>
              ` : ''}
            </div>

            <!-- XP Progress Bar -->
            <div style="margin-bottom: 15px;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <span style="color: #94A3B8; font-size: 0.9em;">Experience Progress</span>
                <span style="color: #10B981; font-weight: 700;">${MANAGER_STATE.xp} / ${MANAGER_STATE.xpToNextLevel} XP</span>
              </div>
              <div style="height: 12px; background: rgba(71, 85, 105, 0.3); border-radius: 6px; overflow: hidden;">
                <div style="height: 100%; background: linear-gradient(90deg, #10B981, #34D399);
                            width: ${xpProgress}%; transition: width 0.5s ease; border-radius: 6px;
                            box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);"></div>
              </div>
              <div style="text-align: right; margin-top: 5px;">
                <span style="color: #64748B; font-size: 0.85em;">
                  ${(MANAGER_STATE.xpToNextLevel - MANAGER_STATE.xp)} XP to Level ${MANAGER_STATE.level + 1}
                </span>
              </div>
            </div>

            <!-- Unlocked Items Count -->
            <div style="background: rgba(168, 85, 247, 0.1); border: 1px solid rgba(168, 85, 247, 0.3);
                        border-radius: 10px; padding: 12px 16px;">
              <span style="color: #C084FC; font-weight: 600;">
                🎨 ${countUnlockedItems()} / ${getTotalItems()} Customization Items Unlocked
              </span>
            </div>
          </div>

          <!-- Actions Column -->
          <div style="display: flex; flex-direction: column; gap: 10px; min-width: 150px;">
            <button onclick="showManagerCustomization()" class="btn-primary"
                    style="padding: 12px 20px; font-weight: 600; white-space: nowrap;">
              👔 Customize
            </button>
            <button onclick="showManagerStats()" class="btn-secondary"
                    style="padding: 12px 20px; font-weight: 600;">
              📊 Full Stats
            </button>
            <button onclick="editManagerProfile()" class="btn-secondary"
                    style="padding: 12px 20px; font-weight: 600;">
              ✏️ Edit Profile
            </button>
            <button onclick="showMainMenu()" class="btn-secondary"
                    style="padding: 12px 20px; font-weight: 600;">
              ← Back
            </button>
          </div>
        </div>
      </div>

      <!-- Stats Grid -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                  gap: 20px; margin-bottom: 30px;">
        ${[
          { icon: '⚽', label: 'Matches Managed', value: MANAGER_STATE.matchesManaged || 0, color: '#3B82F6' },
          { icon: '🏆', label: 'Tournaments Won', value: MANAGER_STATE.tournamentsWon || 0, color: '#FBBF24' },
          { icon: '🔥', label: 'Current Streak', value: MANAGER_STATE.statistics?.currentWinStreak || 0, color: '#EF4444' },
          { icon: '🎯', label: 'Goals Scored', value: MANAGER_STATE.statistics?.goalsScored || 0, color: '#10B981' },
          { icon: '🛡️', label: 'Clean Sheets', value: MANAGER_STATE.statistics?.cleanSheets || 0, color: '#8B5CF6' },
          { icon: '💎', label: 'Total XP', value: MANAGER_STATE.totalXP || 0, color: '#06B6D4' }
        ].map(stat => `
          <div style="background: linear-gradient(135deg, rgba(30, 41, 59, 0.9), rgba(15, 23, 42, 0.9));
                      border: 1px solid rgba(71, 85, 105, 0.4); border-radius: 16px; padding: 24px;
                      text-align: center; transition: all 0.3s; cursor: pointer;"
               onmouseover="this.style.transform='translateY(-4px)'; this.style.borderColor='${stat.color}'"
               onmouseout="this.style.transform='translateY(0)'; this.style.borderColor='rgba(71, 85, 105, 0.4)'">
            <div style="font-size: 3em; margin-bottom: 10px;">${stat.icon}</div>
            <div style="color: ${stat.color}; font-size: 2.2em; font-weight: 900; margin-bottom: 8px;">
              ${stat.value}
            </div>
            <div style="color: #94A3B8; font-size: 0.95em; font-weight: 600;">${stat.label}</div>
          </div>
        `).join('')}
      </div>

      ${favoriteClub ? `
        <!-- Favorite Club Stats -->
        <div style="background: linear-gradient(135deg, rgba(168, 85, 247, 0.15), rgba(139, 92, 246, 0.15));
                    border: 2px solid rgba(168, 85, 247, 0.4); border-radius: 16px; padding: 30px;
                    margin-bottom: 30px;">
          <h3 style="color: #C084FC; margin-bottom: 20px; display: flex; align-items: center; gap: 12px;">
            <span style="font-size: 1.5em;">❤️</span>
            Favorite Club: ${favoriteClub}
          </h3>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px;">
            <div style="text-align: center; padding: 16px; background: rgba(15, 23, 42, 0.6); border-radius: 10px;">
              <div style="color: #60A5FA; font-size: 1.8em; font-weight: 700; margin-bottom: 5px;">
                ${favoriteClubMatches}
              </div>
              <div style="color: #94A3B8; font-size: 0.9em;">Matches</div>
            </div>
            <div style="text-align: center; padding: 16px; background: rgba(15, 23, 42, 0.6); border-radius: 10px;">
              <div style="color: #10B981; font-size: 1.8em; font-weight: 700; margin-bottom: 5px;">
                ${favoriteClubWins}
              </div>
              <div style="color: #94A3B8; font-size: 0.9em;">Wins</div>
            </div>
            <div style="text-align: center; padding: 16px; background: rgba(15, 23, 42, 0.6); border-radius: 10px;">
              <div style="color: #FBBF24; font-size: 1.8em; font-weight: 700; margin-bottom: 5px;">
                ${favoriteClubMatches > 0 ? ((favoriteClubWins / favoriteClubMatches) * 100).toFixed(1) : 0}%
              </div>
              <div style="color: #94A3B8; font-size: 0.9em;">Win Rate</div>
            </div>
            <div style="text-align: center; padding: 16px; background: rgba(15, 23, 42, 0.6); border-radius: 10px;">
              <div style="color: #C084FC; font-size: 1.8em; font-weight: 700; margin-bottom: 5px;">
                +${Math.floor(favoriteClubWins * 15)}
              </div>
              <div style="color: #94A3B8; font-size: 0.9em;">Bonus XP</div>
            </div>
          </div>
          <div style="margin-top: 20px; padding: 16px; background: rgba(168, 85, 247, 0.1);
                      border: 1px solid rgba(168, 85, 247, 0.3); border-radius: 10px; text-align: center;">
            <div style="color: #C084FC; font-weight: 600;">
              💡 Playing with ${favoriteClub} gives +50% bonus XP on wins!
            </div>
          </div>
        </div>
      ` : `
        <!-- Set Favorite Club -->
        <div style="background: rgba(30, 41, 59, 0.6); border: 1px solid rgba(71, 85, 105, 0.3);
                    border-radius: 16px; padding: 30px; margin-bottom: 30px; text-align: center;">
          <div style="font-size: 3em; margin-bottom: 15px; opacity: 0.5;">❤️</div>
          <h3 style="color: #94A3B8; margin-bottom: 15px;">No Favorite Club Set</h3>
          <p style="color: #64748B; margin-bottom: 20px;">
            Choose a favorite club to earn bonus XP when playing with them!
          </p>
          <button onclick="selectFavoriteClub()" class="btn-primary"
                  style="padding: 14px 28px; font-weight: 600;">
            Choose Favorite Club
          </button>
        </div>
      `}

      <!-- Recent Achievements -->
      <div style="background: rgba(30, 41, 59, 0.6); border: 1px solid rgba(71, 85, 105, 0.4);
                  border-radius: 16px; padding: 30px;">
        <h3 style="color: #FBBF24; margin-bottom: 20px; display: flex; align-items: center; gap: 12px;">
          <span style="font-size: 1.5em;">🏆</span>
          Recent Achievements
        </h3>
        <div id="recentAchievements">
          <!-- Will be populated by loadRecentAchievements() -->
        </div>
      </div>
    </div>
  `;

  // Add pulse animation if not already added
  if (!document.getElementById('pulseAnimation')) {
    const style = document.createElement('style');
    style.id = 'pulseAnimation';
    style.textContent = `
      @keyframes pulse {
        0%, 100% { transform: scale(1); opacity: 0.5; }
        50% { transform: scale(1.05); opacity: 0.7; }
      }
    `;
    document.head.appendChild(style);
  }

  // Load recent achievements
  loadRecentAchievements();
}

function loadRecentAchievements() {
  const container = document.getElementById('recentAchievements');
  if (!container) return;

  const unlockedIds = ACHIEVEMENT_PROGRESS.unlockedAchievements.slice(-5).reverse();

  if (unlockedIds.length === 0) {
    container.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #64748b;">
        <div style="font-size: 3em; margin-bottom: 15px; opacity: 0.5;">🏆</div>
        <div>No achievements unlocked yet. Keep playing!</div>
      </div>
    `;
    return;
  }

  // Find achievement data for each ID
  const achievements = [];
  Object.values(ACHIEVEMENTS_CONFIG).forEach(category => {
    Object.values(category).forEach(ach => {
      if (unlockedIds.includes(ach.id)) {
        achievements.push(ach);
      }
    });
  });

  container.innerHTML = `
    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px;">
      ${achievements.map(ach => `
        <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3);
                    border-radius: 10px; padding: 16px; text-align: center;">
          <div style="font-size: 2.5em; margin-bottom: 10px;">${ach.icon}</div>
          <div style="font-weight: 600; color: #f1f5f9; margin-bottom: 5px;">${ach.name}</div>
          <div style="color: #94a3b8; font-size: 0.85em; margin-bottom: 8px;">${ach.description}</div>
          <div style="color: #10b981; font-size: 0.85em; font-weight: 600;">+${ach.xpReward} XP</div>
        </div>
      `).join('')}
    </div>
  `;
}

function showManagerSetup() {
  const out = document.getElementById('content') || document.getElementById('output');
  if (!out) return;

  out.innerHTML = `
    <div style="max-width: 800px; margin: 0 auto; padding: 20px;">
      <div style="background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.2));
                  border: 2px solid rgba(251, 191, 36, 0.4); border-radius: 16px; padding: 40px; text-align: center;">
        <div style="font-size: 5em; margin-bottom: 20px;">👤</div>
        <h1 style="color: #fbbf24; margin-bottom: 15px;">Create Your Manager Profile</h1>
        <p style="color: #94a3b8; font-size: 1.1em; margin-bottom: 30px;">
          Track your progress, earn XP, unlock achievements, and customize your manager
        </p>

        <div style="max-width: 500px; margin: 0 auto;">
          <div style="margin-bottom: 20px; text-align: left;">
            <label style="display: block; color: #94a3b8; font-weight: 600; margin-bottom: 10px;">
              Manager Name
            </label>
            <input type="text" id="managerNameInput" placeholder="Enter your name"
                   style="width: 100%; padding: 14px; background: rgba(15, 23, 42, 0.6);
                          border: 1px solid rgba(71, 85, 105, 0.4); border-radius: 8px;
                          color: #f1f5f9; font-size: 1em;">
          </div>

          <div style="margin-bottom: 30px; text-align: left;">
            <label style="display: block; color: #94a3b8; font-weight: 600; margin-bottom: 10px;">
              Team Name
            </label>
            <input type="text" id="teamNameInput" placeholder="Enter team name"
                   style="width: 100%; padding: 14px; background: rgba(15, 23, 42, 0.6);
                          border: 1px solid rgba(71, 85, 105, 0.4); border-radius: 8px;
                          color: #f1f5f9; font-size: 1em;">
          </div>

          <button onclick="createManagerProfile()" class="btn-primary"
                  style="width: 100%; padding: 16px; font-size: 1.1em; font-weight: 700;">
            Create Profile
          </button>
        </div>
      </div>
    </div>
  `;
}

function createManagerProfile() {
  const managerName = document.getElementById('managerNameInput').value.trim();
  const teamName = document.getElementById('teamNameInput').value.trim();

  if (!managerName) {
    showNotification('error', 'Name Required', 'Please enter a manager name', 2000);
    return;
  }

  MANAGER_STATE.active = true;
  MANAGER_STATE.managerName = managerName || 'Manager';
  MANAGER_STATE.teamName = teamName || 'My Team';
  MANAGER_STATE.createdDate = new Date().toISOString();

  // Save
  if (typeof AUTO_SAVE !== 'undefined' && AUTO_SAVE.save) {
    AUTO_SAVE.save();
  }

  showNotification('success', 'Profile Created!',
    `Welcome, ${MANAGER_STATE.managerName}!`, 3000);

  displayManagerProfile();
}

// showManagerCustomization is defined later in the file with full functionality

function showManagerStats() {
  const out = document.getElementById('content') || document.getElementById('output');
  if (!out) return;

  out.innerHTML = `
    <div style="max-width: 1200px; margin: 0 auto; padding: 20px;">
      <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                  padding: 30px; border-radius: 15px; text-align: center; margin-bottom: 30px;">
        <h1 style="margin: 0; color: white; font-size: 2.5em;">📊 Manager Statistics</h1>
        <p style="margin: 10px 0 0 0; color: rgba(255,255,255,0.9);">${MANAGER_STATE.managerName}</p>
      </div>

      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
        <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
          <h3 style="margin-top: 0; color: #667eea;">Match Record</h3>
          <div style="font-size: 0.9em; color: #555; line-height: 1.8;">
            <div><strong>Total Matches:</strong> ${MANAGER_STATE.statistics.totalMatches}</div>
            <div><strong>Wins:</strong> ${MANAGER_STATE.statistics.wins}</div>
            <div><strong>Draws:</strong> ${MANAGER_STATE.statistics.draws}</div>
            <div><strong>Losses:</strong> ${MANAGER_STATE.statistics.losses}</div>
            <div><strong>Win Rate:</strong> ${MANAGER_STATE.winRate}%</div>
          </div>
        </div>

        <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
          <h3 style="margin-top: 0; color: #667eea;">Goals</h3>
          <div style="font-size: 0.9em; color: #555; line-height: 1.8;">
            <div><strong>Goals Scored:</strong> ${MANAGER_STATE.statistics.goalsScored}</div>
            <div><strong>Goals Conceded:</strong> ${MANAGER_STATE.statistics.goalsConceded}</div>
            <div><strong>Goal Difference:</strong> ${MANAGER_STATE.statistics.goalsScored - MANAGER_STATE.statistics.goalsConceded}</div>
            <div><strong>Clean Sheets:</strong> ${MANAGER_STATE.statistics.cleanSheets}</div>
          </div>
        </div>

        <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
          <h3 style="margin-top: 0; color: #667eea;">Achievements</h3>
          <div style="font-size: 0.9em; color: #555; line-height: 1.8;">
            <div><strong>Level:</strong> ${MANAGER_STATE.level}</div>
            <div><strong>Total XP:</strong> ${MANAGER_STATE.totalXP.toLocaleString()}</div>
            <div><strong>Reputation:</strong> ${MANAGER_STATE.reputation}</div>
            <div><strong>Tournaments Won:</strong> ${MANAGER_STATE.tournamentsWon}</div>
          </div>
        </div>

        <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
          <h3 style="margin-top: 0; color: #667eea;">Streaks</h3>
          <div style="font-size: 0.9em; color: #555; line-height: 1.8;">
            <div><strong>Current Streak:</strong> ${MANAGER_STATE.statistics.currentWinStreak} wins</div>
            <div><strong>Best Streak:</strong> ${MANAGER_STATE.statistics.longestWinStreak} wins</div>
            ${MANAGER_STATE.statistics.biggestWin.opponent ? `
              <div><strong>Biggest Win:</strong> ${MANAGER_STATE.statistics.biggestWin.score} vs ${MANAGER_STATE.statistics.biggestWin.opponent}</div>
            ` : ''}
          </div>
        </div>
      </div>

      <div style="text-align: center;">
        <button onclick="displayManagerProfile()" class="btn-secondary" style="padding: 14px 28px; font-weight: 600;">
          ← Back to Profile
        </button>
      </div>
    </div>
  `;
}

function showAllAchievements() {
  const out = document.getElementById('content') || document.getElementById('output');
  if (!out) return;

  const allAchievements = [];
  Object.entries(ACHIEVEMENTS_CONFIG).forEach(([category, achievements]) => {
    Object.values(achievements).forEach(ach => {
      allAchievements.push({ ...ach, category });
    });
  });

  out.innerHTML = `
    <div style="max-width: 1400px; margin: 0 auto; padding: 20px;">
      <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                  padding: 30px; border-radius: 15px; text-align: center; margin-bottom: 30px;">
        <h1 style="margin: 0; color: white; font-size: 2.5em;">🏆 All Achievements</h1>
        <p style="margin: 10px 0 0 0; color: rgba(255,255,255,0.9);">
          ${ACHIEVEMENT_PROGRESS.unlockedAchievements.length} / ${allAchievements.length} Unlocked
        </p>
      </div>

      <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 16px;">
        ${allAchievements.map(ach => {
          const unlocked = ach.unlocked || ACHIEVEMENT_PROGRESS.unlockedAchievements.includes(ach.id);
          return `
            <div style="background: ${unlocked ? 'linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.2))' : 'rgba(30, 41, 59, 0.8)'};
                        border: 2px solid ${unlocked ? '#10b981' : '#334155'};
                        border-radius: 12px; padding: 20px; text-align: center;
                        opacity: ${unlocked ? '1' : '0.6'};">
              <div style="font-size: 3em; margin-bottom: 10px;">${unlocked ? ach.icon : '🔒'}</div>
              <div style="font-weight: 700; color: ${unlocked ? '#10b981' : '#94a3b8'}; font-size: 1.1em; margin-bottom: 8px;">
                ${ach.name}
              </div>
              <div style="color: #94a3b8; font-size: 0.9em; margin-bottom: 10px;">
                ${ach.description}
              </div>
              <div style="display: inline-block; padding: 4px 12px; background: rgba(251, 191, 36, 0.2);
                          border-radius: 12px; color: #fbbf24; font-size: 0.85em; font-weight: 600;">
                +${ach.xpReward} XP
              </div>
              <div style="margin-top: 8px; text-transform: uppercase; font-size: 0.7em; letter-spacing: 0.05em;
                          color: ${
                            ach.rarity === 'legendary' ? '#fbbf24' :
                            ach.rarity === 'epic' ? '#c084fc' :
                            ach.rarity === 'rare' ? '#60a5fa' : '#10b981'
                          }; font-weight: 700;">
                ${ach.rarity}
              </div>
            </div>
          `;
        }).join('')}
      </div>

      <div style="text-align: center; margin-top: 30px;">
        <button onclick="displayManagerProfile()" class="btn-secondary" style="padding: 14px 28px; font-weight: 600;">
          ← Back to Profile
        </button>
      </div>
    </div>
  `;
}

// ========================================
// FAVORITE CLUB & PROFILE EDITING FUNCTIONS
// ========================================

function selectFavoriteClub() {
  const modal = document.createElement('div');
  modal.className = 'modal-backdrop active';
  modal.style.zIndex = '10005';
  modal.innerHTML = `
    <div class="modal-content" style="max-width: 800px;">
      <div class="modal-head">
        <h2 style="color: #C084FC;">❤️ Choose Your Favorite Club</h2>
        <button class="modal-close" onclick="this.closest('.modal-backdrop').remove()">✕</button>
      </div>

      <div style="padding: 30px;">
        <p style="color: #94A3B8; margin-bottom: 20px;">
          Select a club to earn +50% bonus XP when managing them in matches and tournaments!
        </p>

        <!-- Search -->
        <input type="text" id="clubSearch" placeholder="Search for a club..."
               oninput="filterClubList(this.value)"
               style="width: 100%; padding: 12px; background: rgba(30, 41, 59, 0.8);
                      border: 1px solid rgba(71, 85, 105, 0.4); border-radius: 8px;
                      color: #F1F5F9; margin-bottom: 20px; font-size: 1em;">

        <!-- Club List -->
        <div id="clubListContainer" style="max-height: 400px; overflow-y: auto; display: grid;
                                            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px;">
          ${(window.ALL_TEAMS || window.TEAMS || []).slice(0, 50).map(team => `
            <button onclick="setFavoriteClub('${team.name}')"
                    class="club-select-btn"
                    style="padding: 16px; background: rgba(15, 23, 42, 0.6);
                           border: 1px solid rgba(71, 85, 105, 0.3); border-radius: 10px;
                           text-align: left; cursor: pointer; transition: all 0.2s;"
                    onmouseover="this.style.borderColor='#C084FC'; this.style.background='rgba(168, 85, 247, 0.1)'"
                    onmouseout="this.style.borderColor='rgba(71, 85, 105, 0.3)'; this.style.background='rgba(15, 23, 42, 0.6)'">
              <div style="font-weight: 700; color: #F1F5F9; margin-bottom: 5px;">${team.name}</div>
              <div style="color: #94A3B8; font-size: 0.85em;">Rating: ${team.strength}</div>
            </button>
          `).join('')}
        </div>
      </div>
    </div>
  `;

  document.body.appendChild(modal);
}

function filterClubList(searchTerm) {
  const container = document.getElementById('clubListContainer');
  if (!container) return;

  const allTeams = window.ALL_TEAMS || window.TEAMS || [];
  const filtered = allTeams.filter(team =>
    team.name.toLowerCase().includes(searchTerm.toLowerCase())
  ).slice(0, 50);

  container.innerHTML = filtered.map(team => `
    <button onclick="setFavoriteClub('${team.name}')"
            class="club-select-btn"
            style="padding: 16px; background: rgba(15, 23, 42, 0.6);
                   border: 1px solid rgba(71, 85, 105, 0.3); border-radius: 10px;
                   text-align: left; cursor: pointer; transition: all 0.2s;"
            onmouseover="this.style.borderColor='#C084FC'; this.style.background='rgba(168, 85, 247, 0.1)'"
            onmouseout="this.style.borderColor='rgba(71, 85, 105, 0.3)'; this.style.background='rgba(15, 23, 42, 0.6)'">
      <div style="font-weight: 700; color: #F1F5F9; margin-bottom: 5px;">${team.name}</div>
      <div style="color: #94A3B8; font-size: 0.85em;">Rating: ${team.strength}</div>
    </button>
  `).join('');
}

function setFavoriteClub(clubName) {
  MANAGER_STATE.favoriteClub = clubName;

  // Initialize club-specific stats if not exists
  if (!MANAGER_STATE.statistics.clubSpecificStats) {
    MANAGER_STATE.statistics.clubSpecificStats = {};
  }
  if (!MANAGER_STATE.statistics.clubSpecificStats[clubName]) {
    MANAGER_STATE.statistics.clubSpecificStats[clubName] = {
      matches: 0,
      wins: 0,
      draws: 0,
      losses: 0,
      goalsScored: 0,
      goalsConceded: 0
    };
  }

  // Save
  if (typeof AUTO_SAVE !== 'undefined' && AUTO_SAVE.save) {
    AUTO_SAVE.save();
  }

  // Close modal
  const modal = document.querySelector('.modal-backdrop');
  if (modal) modal.remove();

  showNotification('success', 'Favorite Club Set!',
    `${clubName} is now your favorite club. Earn +50% bonus XP!`, 3000);

  // Refresh profile
  displayManagerProfile();
}

function editManagerProfile() {
  const modal = document.createElement('div');
  modal.className = 'modal-backdrop active';
  modal.style.zIndex = '10005';
  modal.innerHTML = `
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-head">
        <h2 style="color: #10B981;">✏️ Edit Profile</h2>
        <button class="modal-close" onclick="this.closest('.modal-backdrop').remove()">✕</button>
      </div>

      <div style="padding: 30px;">
        <div style="margin-bottom: 20px;">
          <label style="display: block; color: #94A3B8; margin-bottom: 8px; font-weight: 600;">
            Manager Name
          </label>
          <input type="text" id="editManagerName" value="${MANAGER_STATE.managerName}"
                 style="width: 100%; padding: 12px; background: rgba(30, 41, 59, 0.8);
                        border: 1px solid rgba(71, 85, 105, 0.4); border-radius: 8px;
                        color: #F1F5F9; font-size: 1em;">
        </div>

        <div style="margin-bottom: 25px;">
          <label style="display: block; color: #94A3B8; margin-bottom: 8px; font-weight: 600;">
            Team Name
          </label>
          <input type="text" id="editTeamName" value="${MANAGER_STATE.teamName}"
                 style="width: 100%; padding: 12px; background: rgba(30, 41, 59, 0.8);
                        border: 1px solid rgba(71, 85, 105, 0.4); border-radius: 8px;
                        color: #F1F5F9; font-size: 1em;">
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
          <button onclick="saveProfileEdits()" class="btn-primary"
                  style="padding: 14px; font-weight: 600;">
            Save Changes
          </button>
          <button onclick="this.closest('.modal-backdrop').remove()" class="btn-secondary"
                  style="padding: 14px; font-weight: 600;">
            Cancel
          </button>
        </div>
      </div>
    </div>
  `;

  document.body.appendChild(modal);
}

function saveProfileEdits() {
  const managerName = document.getElementById('editManagerName').value.trim();
  const teamName = document.getElementById('editTeamName').value.trim();

  if (!managerName) {
    showNotification('error', 'Invalid Name', 'Manager name cannot be empty', 2000);
    return;
  }

  MANAGER_STATE.managerName = managerName;
  MANAGER_STATE.teamName = teamName || 'My Team';

  if (typeof AUTO_SAVE !== 'undefined' && AUTO_SAVE.save) {
    AUTO_SAVE.save();
  }

  const modal = document.querySelector('.modal-backdrop');
  if (modal) modal.remove();

  showNotification('success', 'Profile Updated!', 'Your changes have been saved', 2000);
  displayManagerProfile();
}

// ========================================
// TOURNAMENT HISTORY DISPLAY FUNCTIONS
// ========================================

function displayTournamentHistory() {
  const out = document.getElementById('content') || document.getElementById('output');
  if (!out) return;

  const completed = TOURNAMENT_HISTORY_ENHANCED.completed || [];

  out.innerHTML = `
    <div style="max-width: 1400px; margin: 0 auto; padding: 20px;">
      <div style="background: linear-gradient(135deg, rgba(168, 85, 247, 0.2), rgba(139, 92, 246, 0.2));
                  border: 2px solid rgba(168, 85, 247, 0.4); border-radius: 16px; padding: 30px;
                  margin-bottom: 30px; text-align: center;">
        <h1 style="color: #c084fc; margin-bottom: 10px; font-size: 2.5em;">📚 Tournament History</h1>
        <p style="color: #94a3b8; font-size: 1.1em;">Complete record of all tournaments played</p>
      </div>

      ${completed.length === 0 ? `
        <div style="text-align: center; padding: 80px 20px; background: rgba(30, 41, 59, 0.6); border-radius: 16px;">
          <div style="font-size: 5em; margin-bottom: 20px; opacity: 0.5;">📚</div>
          <h3 style="color: #94a3b8; margin-bottom: 10px;">No Tournament History</h3>
          <p style="color: #64748b; margin-bottom: 25px;">Complete your first tournament to start building your history</p>
          <button onclick="showMainMenu()" class="btn-primary" style="padding: 14px 28px; font-weight: 600;">Start a Tournament</button>
        </div>
      ` : `
        <div style="display: grid; gap: 16px;">
          ${completed.slice().reverse().map((tournament, idx) => {
            const startDate = new Date(tournament.startDate).toLocaleDateString();
            return `
              <div style="background: linear-gradient(135deg, rgba(15, 23, 42, 0.9), rgba(30, 41, 59, 0.9));
                          border: 1px solid rgba(71, 85, 105, 0.3); border-radius: 12px; padding: 24px;
                          cursor: pointer; transition: all 0.2s;"
                   onclick="viewTournamentDetails(${completed.length - 1 - idx})"
                   onmouseover="this.style.borderColor='#c084fc'; this.style.transform='translateY(-2px)'"
                   onmouseout="this.style.borderColor='rgba(71, 85, 105, 0.3)'; this.style.transform='translateY(0)'">
                <div style="display: grid; grid-template-columns: auto 1fr auto; gap: 20px; align-items: center;">
                  <div style="font-size: 3em;">🏆</div>
                  <div>
                    <h3 style="color: #f1f5f9; margin-bottom: 8px; font-size: 1.3em;">${tournament.name}</h3>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 12px;">
                      <span style="color: #94a3b8; font-size: 0.9em;">📅 ${startDate}</span>
                      <span style="color: #94a3b8; font-size: 0.9em;">⚽ ${tournament.statistics.totalMatches} matches</span>
                      <span style="color: #94a3b8; font-size: 0.9em;">🎯 ${tournament.statistics.totalGoals} goals</span>
                    </div>
                    ${tournament.champion ? `
                      <div style="display: flex; gap: 20px; margin-top: 10px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                          <span style="font-size: 1.3em;">🥇</span>
                          <div style="color: #fbbf24; font-weight: 700;">${tournament.champion}</div>
                        </div>
                      </div>
                    ` : ''}
                  </div>
                  <button class="small-btn" style="padding: 10px 20px; white-space: nowrap;">View Details →</button>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `}

      <div style="text-align: center; margin-top: 30px;">
        <button onclick="showMainMenu()" class="btn-secondary" style="padding: 14px 28px; font-weight: 600;">← Back to Main Menu</button>
      </div>
    </div>
  `;
}

function viewTournamentDetails(index) {
  const tournament = TOURNAMENT_HISTORY_ENHANCED.completed[index];
  if (!tournament) {
    showNotification('error', 'Not Found', 'Tournament not found', 2000);
    return;
  }

  const out = document.getElementById('content') || document.getElementById('output');
  if (!out) return;

  const startDate = new Date(tournament.startDate).toLocaleDateString();
  const endDate = tournament.endDate ? new Date(tournament.endDate).toLocaleDateString() : 'In Progress';

  out.innerHTML = `
    <div style="max-width: 1200px; margin: 0 auto; padding: 20px;">
      <div style="background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.2));
                  border: 2px solid rgba(251, 191, 36, 0.4); border-radius: 16px; padding: 30px; margin-bottom: 30px;">
        <div style="display: flex; justify-content: space-between; align-items: start;">
          <div>
            <h1 style="color: #fbbf24; margin-bottom: 10px; font-size: 2.2em;">${tournament.name}</h1>
            <div style="color: #94a3b8; font-size: 1em; margin-bottom: 15px;">${startDate} - ${endDate}</div>
          </div>
          <button onclick="displayTournamentHistory()" class="btn-secondary">← Back to History</button>
        </div>
      </div>

      ${tournament.champion ? `
        <div style="background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.2));
                    border: 2px solid rgba(251, 191, 36, 0.5); border-radius: 16px; padding: 30px;
                    margin-bottom: 30px; text-align: center;">
          <div style="font-size: 4em; margin-bottom: 15px;">🏆</div>
          <h2 style="color: #fbbf24; font-size: 2em; margin-bottom: 10px;">CHAMPION</h2>
          <div style="color: #f1f5f9; font-size: 2.5em; font-weight: 900; margin-bottom: 20px;">${tournament.champion}</div>
        </div>
      ` : ''}

      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 30px;">
        ${[
          { label: 'Total Matches', value: tournament.statistics.totalMatches, icon: '⚽' },
          { label: 'Total Goals', value: tournament.statistics.totalGoals, icon: '🎯' },
          { label: 'Avg Goals/Match', value: tournament.statistics.averageGoalsPerMatch || '0.00', icon: '📊' },
          { label: 'Most Goals', value: tournament.statistics.mostGoalsInMatch || 0, icon: '🔥' }
        ].map(stat => `
          <div style="background: linear-gradient(135deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.8));
                      border: 1px solid rgba(71, 85, 105, 0.3); border-radius: 12px; padding: 20px; text-align: center;">
            <div style="font-size: 2.5em; margin-bottom: 10px;">${stat.icon}</div>
            <div style="color: #10b981; font-size: 2em; font-weight: 800; margin-bottom: 5px;">${stat.value}</div>
            <div style="color: #94a3b8; font-size: 0.9em;">${stat.label}</div>
          </div>
        `).join('')}
      </div>
    </div>
  `;
}

/************* MULTI-SEASON CAREER MODE *************/

let CAREER_STATE = {
  active: false,
  currentSeason: 1,
  totalSeasons: 0,
  managerName: '',
  clubName: '',
  startYear: new Date().getFullYear(),

  // Career Statistics
  careerStats: {
    totalMatches: 0,
    totalWins: 0,
    totalDraws: 0,
    totalLosses: 0,
    totalGoalsScored: 0,
    totalGoalsConceded: 0,
    totalTrophies: 0,
    championships: 0,
    promotions: 0,
    relegations: 0
  },

  // Season History
  seasonHistory: [],

  // Hall of Fame - Legendary Players
  hallOfFame: [],

  // Records
  records: {
    mostGoalsInSeason: { player: null, goals: 0, season: 0 },
    mostAssistsInSeason: { player: null, assists: 0, season: 0 },
    longestWinStreak: { streak: 0, startSeason: 0, endSeason: 0 },
    longestUnbeatenRun: { run: 0, startSeason: 0, endSeason: 0 },
    biggestWin: { score: '', opponent: '', season: 0 },
    highestLeaguePosition: { position: 999, season: 0 },
    mostPointsInSeason: { points: 0, season: 0 }
  },

  // Current streak tracking
  currentStreak: {
    wins: 0,
    unbeaten: 0,
    lastResult: null
  },

  // Dynasty milestones
  milestones: []
};

// ========================================
// ENHANCED KNOCKOUT MATCH DISPLAY
// ========================================

function displayEnhancedKnockoutMatch(match, matchIndex) {
  const isTwoLeg = match.isTwoLeg || false;
  const leg1Complete = isTwoLeg && match.leg1?.completed;
  const leg2Complete = isTwoLeg && match.leg2?.completed;
  const bothLegsComplete = leg1Complete && leg2Complete;

  return `
    <div style="background: linear-gradient(135deg, rgba(30, 41, 59, 0.9), rgba(15, 23, 42, 0.9));
                border: ${bothLegsComplete ? '2px solid rgba(16, 185, 129, 0.5)' :
                         leg1Complete ? '2px solid rgba(251, 191, 36, 0.5)' :
                         '1px solid rgba(71, 85, 105, 0.3)'};
                border-radius: 12px; padding: 24px; position: relative; overflow: hidden;">

      ${isTwoLeg ? `
        <!-- Two-Leg Indicator -->
        <div style="position: absolute; top: 12px; right: 12px; padding: 6px 12px;
                    background: rgba(168, 85, 247, 0.2); border: 1px solid rgba(168, 85, 247, 0.4);
                    border-radius: 6px; font-size: 0.75em; font-weight: 700; color: #c084fc;">
          TWO-LEG TIE
        </div>
      ` : ''}

      <!-- Match Header -->
      <div style="text-align: center; margin-bottom: 20px;">
        <div style="color: #94a3b8; font-size: 0.9em; font-weight: 600;">
          ${match.stage ? STAGE_DISPLAY_NAMES[normalizeStageNames(match.stage)] || match.stage : 'Match'} -
          ${isTwoLeg ? (leg1Complete && !leg2Complete ? 'Leg 1 Complete' :
                        bothLegsComplete ? 'Tie Complete' : 'First Leg') : 'Single Match'}
        </div>
      </div>

      <!-- LEG 1 (or Single Match) -->
      <div style="background: rgba(15, 23, 42, 0.6); border-radius: 10px; padding: 20px;
                  margin-bottom: ${isTwoLeg ? '16px' : '0'};">
        ${isTwoLeg ? `
          <div style="text-align: center; color: #fbbf24; font-weight: 600; font-size: 0.85em;
                      margin-bottom: 12px; text-transform: uppercase;">
            Leg 1 - ${match.leg1.homeTeam.name} (Home)
          </div>
        ` : ''}

        <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 20px; align-items: center;">
          <!-- Team A -->
          <div style="text-align: right;">
            <div style="font-weight: 700; font-size: 1.4em; color: #f1f5f9; margin-bottom: 8px;">
              ${match.teamA.name}
            </div>
            <div style="color: #94a3b8; font-size: 0.9em;">
              Rating: ${match.teamA.strength}
            </div>
            ${isTwoLeg && leg1Complete ? `
              <div style="margin-top: 8px; color: #10b981; font-weight: 600; font-size: 0.9em;">
                ${match.leg1.homeTeam.name === match.teamA.name ? '🏠 Home' : '✈️ Away'}
              </div>
            ` : ''}
          </div>

          <!-- Score Display -->
          <div style="text-align: center; min-width: 120px;">
            ${leg1Complete ? `
              <div style="display: flex; align-items: center; gap: 12px; justify-content: center;
                          padding: 12px 20px; background: rgba(16, 185, 129, 0.1);
                          border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 8px;">
                <span style="color: ${match.leg1.scoreA > match.leg1.scoreB ? '#10b981' : '#64748b'};
                             font-weight: 900; font-size: 2.2em;">
                  ${match.leg1.scoreA}
                </span>
                <span style="color: #64748b; font-weight: 600; font-size: 1.2em;">-</span>
                <span style="color: ${match.leg1.scoreB > match.leg1.scoreA ? '#10b981' : '#64748b'};
                             font-weight: 900; font-size: 2.2em;">
                  ${match.leg1.scoreB}
                </span>
              </div>
            ` : `
              <div style="color: #f59e0b; font-weight: 700; font-size: 1.5em;">VS</div>
            `}
          </div>

          <!-- Team B -->
          <div style="text-align: left;">
            <div style="font-weight: 700; font-size: 1.4em; color: #f1f5f9; margin-bottom: 8px;">
              ${match.teamB.name}
            </div>
            <div style="color: #94a3b8; font-size: 0.9em;">
              Rating: ${match.teamB.strength}
            </div>
            ${isTwoLeg && leg1Complete ? `
              <div style="margin-top: 8px; color: #10b981; font-weight: 600; font-size: 0.9em;">
                ${match.leg1.homeTeam.name === match.teamB.name ? '🏠 Home' : '✈️ Away'}
              </div>
            ` : ''}
          </div>
        </div>

        <!-- Leg 1 Actions -->
        ${!leg1Complete && match.teamA && match.teamB ? `
          <button onclick="simulateLeg1(${matchIndex})"
                  class="btn-primary"
                  style="width: 100%; margin-top: 20px; padding: 14px; font-weight: 600;">
            ⚽ Simulate ${isTwoLeg ? 'Leg 1' : 'Match'}
          </button>
        ` : ''}
      </div>

      <!-- AGGREGATE SCORE (if two-leg and leg 1 complete) -->
      ${isTwoLeg && leg1Complete ? `
        <div style="background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.2));
                    border: 2px solid rgba(251, 191, 36, 0.4); border-radius: 10px; padding: 16px;
                    margin-bottom: 16px; text-align: center;">
          <div style="color: #fbbf24; font-weight: 600; font-size: 0.85em; margin-bottom: 10px;
                      text-transform: uppercase; letter-spacing: 0.05em;">
            ${bothLegsComplete ? 'Final Aggregate Score' : 'Current Aggregate'}
          </div>
          <div style="display: flex; justify-content: center; align-items: center; gap: 20px;">
            <div>
              <div style="color: #f1f5f9; font-size: 1.1em; margin-bottom: 5px;">${match.teamA.name}</div>
              <div style="color: ${match.aggregate.teamA > match.aggregate.teamB ? '#10b981' : '#fbbf24'};
                          font-weight: 900; font-size: 2.5em;">
                ${match.aggregate.teamA}
              </div>
            </div>
            <div style="color: #fbbf24; font-size: 1.5em; font-weight: 600;">-</div>
            <div>
              <div style="color: #f1f5f9; font-size: 1.1em; margin-bottom: 5px;">${match.teamB.name}</div>
              <div style="color: ${match.aggregate.teamB > match.aggregate.teamA ? '#10b981' : '#fbbf24'};
                          font-weight: 900; font-size: 2.5em;">
                ${match.aggregate.teamB}
              </div>
            </div>
          </div>
          ${bothLegsComplete && match.aggregate.teamA === match.aggregate.teamB ? `
            <div style="margin-top: 12px; padding: 10px; background: rgba(239, 68, 68, 0.1);
                        border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 6px;
                        color: #ef4444; font-weight: 600; font-size: 0.9em;">
              ⚡ Aggregate tied - Extra time or penalties required
            </div>
          ` : ''}
        </div>
      ` : ''}

      <!-- LEG 2 (if applicable) -->
      ${isTwoLeg && leg1Complete ? `
        <div style="background: rgba(15, 23, 42, 0.6); border-radius: 10px; padding: 20px;">
          <div style="text-align: center; color: #3b82f6; font-weight: 600; font-size: 0.85em;
                      margin-bottom: 12px; text-transform: uppercase;">
            Leg 2 - ${match.leg2.homeTeam.name} (Home)
          </div>

          <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 20px; align-items: center;">
            <!-- Team A (now away) -->
            <div style="text-align: right;">
              <div style="font-weight: 700; font-size: 1.4em; color: #f1f5f9; margin-bottom: 8px;">
                ${match.teamA.name}
              </div>
              <div style="color: #94a3b8; font-size: 0.9em;">
                Rating: ${match.teamA.strength}
              </div>
              <div style="margin-top: 8px; color: #10b981; font-weight: 600; font-size: 0.9em;">
                ${match.leg2.homeTeam.name === match.teamA.name ? '🏠 Home' : '✈️ Away'}
              </div>
            </div>

            <!-- Score Display -->
            <div style="text-align: center; min-width: 120px;">
              ${leg2Complete ? `
                <div style="display: flex; align-items: center; gap: 12px; justify-content: center;
                            padding: 12px 20px; background: rgba(16, 185, 129, 0.1);
                            border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 8px;">
                  <span style="color: ${match.leg2.scoreA > match.leg2.scoreB ? '#10b981' : '#64748b'};
                               font-weight: 900; font-size: 2.2em;">
                    ${match.leg2.scoreA}
                  </span>
                  <span style="color: #64748b; font-weight: 600; font-size: 1.2em;">-</span>
                  <span style="color: ${match.leg2.scoreB > match.leg2.scoreA ? '#10b981' : '#64748b'};
                               font-weight: 900; font-size: 2.2em;">
                    ${match.leg2.scoreB}
                  </span>
                </div>
              ` : `
                <div style="color: #3b82f6; font-weight: 700; font-size: 1.5em;">VS</div>
              `}
            </div>

            <!-- Team B (now home) -->
            <div style="text-align: left;">
              <div style="font-weight: 700; font-size: 1.4em; color: #f1f5f9; margin-bottom: 8px;">
                ${match.teamB.name}
              </div>
              <div style="color: #94a3b8; font-size: 0.9em;">
                Rating: ${match.teamB.strength}
              </div>
              <div style="margin-top: 8px; color: #10b981; font-weight: 600; font-size: 0.9em;">
                ${match.leg2.homeTeam.name === match.teamB.name ? '🏠 Home' : '✈️ Away'}
              </div>
            </div>
          </div>

          <!-- Leg 2 Actions -->
          ${!leg2Complete ? `
            <button onclick="simulateLeg2(${matchIndex})"
                    class="btn-primary"
                    style="width: 100%; margin-top: 20px; padding: 14px; font-weight: 600;
                           background: linear-gradient(135deg, #3b82f6, #2563eb);">
              ⚽ Simulate Leg 2
            </button>
          ` : ''}
        </div>
      ` : ''}

      <!-- Winner Declaration (if complete) -->
      ${bothLegsComplete && match.winner ? `
        <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.2));
                    border: 2px solid rgba(16, 185, 129, 0.5); border-radius: 10px; padding: 20px;
                    margin-top: 16px; text-align: center;">
          <div style="font-size: 2.5em; margin-bottom: 10px;">🏆</div>
          <div style="color: #10b981; font-weight: 600; font-size: 0.9em; margin-bottom: 8px;
                      text-transform: uppercase;">
            Advances to Next Round
          </div>
          <div style="color: #f1f5f9; font-weight: 900; font-size: 2em;">
            ${match.winner}
          </div>
          <div style="color: #94a3b8; font-size: 0.9em; margin-top: 8px;">
            Aggregate: ${match.aggregate.teamA} - ${match.aggregate.teamB}
          </div>
        </div>
      ` : ''}

      <!-- Quick Actions -->
      ${leg1Complete && !leg2Complete ? `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 16px;">
          <button onclick="viewLeg1Details(${matchIndex})"
                  class="btn-secondary"
                  style="padding: 12px; font-weight: 600;">
            📊 Leg 1 Details
          </button>
          <button onclick="simulateLeg2(${matchIndex})"
                  class="btn-primary"
                  style="padding: 12px; font-weight: 600;
                         background: linear-gradient(135deg, #10b981, #059669);">
            ➡️ Go to Leg 2
          </button>
        </div>
      ` : bothLegsComplete ? `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 16px;">
          <button onclick="viewLeg1Details(${matchIndex})"
                  class="btn-secondary"
                  style="padding: 12px; font-weight: 600;">
            📊 Leg 1 Details
          </button>
          <button onclick="viewLeg2Details(${matchIndex})"
                  class="btn-secondary"
                  style="padding: 12px; font-weight: 600;">
            📊 Leg 2 Details
          </button>
        </div>
      ` : ''}
    </div>
  `;
}

function displayKnockoutStage(stage) {
  // Normalize stage name
  stage = normalizeStageNames(stage);

  const out = document.getElementById('output');
  if (!out) return;

  // Update tournament progress timeline
  if (typeof updateTournamentProgress === 'function') {
    updateTournamentProgress(stage);
  }

  // Get matches for this stage
  const stageMatches = KNOCKOUT_STATE.currentMatches.filter(m =>
    normalizeStageNames(m.stage) === stage
  );

  out.innerHTML = `
    <div style="max-width: 1400px; margin: 0 auto;">
      <div style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(251, 191, 36, 0.2));
                  border: 2px solid rgba(245, 158, 11, 0.4); border-radius: 16px; padding: 30px;
                  margin-bottom: 30px; text-align: center;">
        <h1 style="color: #f59e0b; margin-bottom: 10px; font-size: 2.5em;">
          ${STAGE_ICONS[stage] || '⚔️'} ${STAGE_DISPLAY_NAMES[stage] || stage}
        </h1>
        <p style="color: #94a3b8; font-size: 1.1em;">
          ${stageMatches.length} ${stageMatches.length === 1 ? 'match' : 'matches'} in this round
        </p>
      </div>

      <!-- Matches Display -->
      <div style="display: grid; gap: 20px;">
        ${stageMatches.length > 0 ? stageMatches.map((match, idx) =>
          displayEnhancedKnockoutMatch(match, idx)
        ).join('') : `
          <div style="text-align: center; padding: 60px 20px; background: rgba(30, 41, 59, 0.6);
                      border-radius: 12px;">
            <div style="font-size: 3em; margin-bottom: 15px; opacity: 0.5;">⏳</div>
            <div style="color: #94a3b8; font-size: 1.1em;">Waiting for previous stage to complete</div>
          </div>
        `}
      </div>

      ${stageMatches.length > 0 && stageMatches.some(m => !m.completed) ? `
        <div style="text-align: center; margin-top: 30px;">
          <button onclick="simulateAllStageMatches('${stage}')"
                  class="btn-secondary"
                  style="padding: 16px 32px; font-weight: 600; font-size: 1.1em;">
            ⚡ Simulate All Remaining
          </button>
        </div>
      ` : ''}
    </div>
  `;
}

function simulateAllStageMatches(stage) {
  const stageMatches = KNOCKOUT_STATE.currentMatches.filter(m =>
    normalizeStageNames(m.stage) === normalizeStageNames(stage) && !m.completed
  );

  if (stageMatches.length === 0) {
    if (typeof showNotification === 'function') {
      showNotification('info', 'All Complete', 'All matches already played', 2000);
    }
    return;
  }

  showLoading(`Simulating ${stageMatches.length} matches...`);

  let completed = 0;
  const interval = setInterval(() => {
    if (completed >= stageMatches.length) {
      clearInterval(interval);
      hideLoading();
      displayKnockoutStage(stage);
      if (typeof showNotification === 'function') {
        showNotification('success', 'Simulation Complete!',
          `All ${stageMatches.length} matches finished`, 3000);
      }
      return;
    }

    const match = stageMatches[completed];
    const matchIndex = KNOCKOUT_STATE.currentMatches.indexOf(match);

    if (match.isTwoLeg) {
      if (!match.leg1.completed) {
        simulateLeg1Silent(matchIndex);
      }
      if (match.leg1.completed && !match.leg2.completed) {
        simulateLeg2Silent(matchIndex);
      }
    } else {
      simulateSingleKnockoutMatchSilent(matchIndex);
    }

    completed++;
  }, 500);
}

// Leg details view functions
function viewLeg1Details(matchIndex) {
  const match = KNOCKOUT_STATE.currentMatches[matchIndex];
  if (!match || !match.leg1.completed) {
    if (typeof showNotification === 'function') {
      showNotification('error', 'No Data', 'Leg 1 has not been played yet', 2000);
    }
    return;
  }

  const modal = document.createElement('div');
  modal.className = 'modal-backdrop active';
  modal.style.zIndex = '10005';
  modal.innerHTML = `
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-head" style="background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.2));
                                     border-bottom: 2px solid rgba(251, 191, 36, 0.4);">
        <h2 style="color: #fbbf24;">📊 Leg 1 Details</h2>
        <button class="modal-close" onclick="this.closest('.modal-backdrop').remove()">✕</button>
      </div>

      <div style="padding: 30px;">
        <!-- Match Summary -->
        <div style="text-align: center; margin-bottom: 30px;">
          <div style="color: #94a3b8; font-size: 0.9em; margin-bottom: 15px;">
            ${STAGE_DISPLAY_NAMES[normalizeStageNames(match.stage)] || match.stage} - Leg 1
          </div>
          <div style="display: flex; justify-content: center; align-items: center; gap: 30px; margin-bottom: 20px;">
            <div>
              <div style="font-weight: 700; font-size: 1.5em; color: #f1f5f9; margin-bottom: 5px;">
                ${match.leg1.homeTeam.name}
              </div>
              <div style="color: #10b981; font-size: 0.85em;">🏠 Home</div>
            </div>
            <div style="display: flex; align-items: center; gap: 15px; padding: 12px 24px;
                        background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3);
                        border-radius: 10px;">
              <span style="color: ${match.leg1.scoreA > match.leg1.scoreB ? '#10b981' : '#64748b'};
                           font-weight: 900; font-size: 2.5em;">
                ${match.leg1.scoreA}
              </span>
              <span style="color: #64748b;">-</span>
              <span style="color: ${match.leg1.scoreB > match.leg1.scoreA ? '#10b981' : '#64748b'};
                           font-weight: 900; font-size: 2.5em;">
                ${match.leg1.scoreB}
              </span>
            </div>
            <div>
              <div style="font-weight: 700; font-size: 1.5em; color: #f1f5f9; margin-bottom: 5px;">
                ${match.leg1.awayTeam.name}
              </div>
              <div style="color: #3b82f6; font-size: 0.85em;">✈️ Away</div>
            </div>
          </div>
        </div>

        <!-- Match Stats -->
        <div style="background: rgba(30, 41, 59, 0.6); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
          <h3 style="color: #10b981; margin-bottom: 15px;">Match Statistics</h3>
          <div style="display: grid; gap: 12px;">
            <div style="display: flex; justify-content: space-between; padding: 10px;
                        background: rgba(15, 23, 42, 0.6); border-radius: 6px;">
              <span style="color: #94a3b8;">Venue:</span>
              <span style="color: #f1f5f9; font-weight: 600;">${match.leg1.homeTeam.name} Stadium</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 10px;
                        background: rgba(15, 23, 42, 0.6); border-radius: 6px;">
              <span style="color: #94a3b8;">First Leg Score:</span>
              <span style="color: #f1f5f9; font-weight: 600;">
                ${match.leg1.scoreA} - ${match.leg1.scoreB}
              </span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 10px;
                        background: rgba(15, 23, 42, 0.6); border-radius: 6px;">
              <span style="color: #94a3b8;">Away Goals:</span>
              <span style="color: #3b82f6; font-weight: 600;">
                ${match.leg1.scoreB}
              </span>
            </div>
          </div>
        </div>

        <!-- Actions -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
          <button onclick="this.closest('.modal-backdrop').remove()"
                  class="btn-secondary" style="padding: 12px; font-weight: 600;">
            Close
          </button>
          ${!match.leg2.completed ? `
            <button onclick="this.closest('.modal-backdrop').remove(); simulateLeg2(${matchIndex})"
                    class="btn-primary" style="padding: 12px; font-weight: 600;">
              ➡️ Go to Leg 2
            </button>
          ` : `
            <button onclick="this.closest('.modal-backdrop').remove(); viewLeg2Details(${matchIndex})"
                    class="btn-secondary" style="padding: 12px; font-weight: 600;">
              View Leg 2 →
            </button>
          `}
        </div>
      </div>
    </div>
  `;

  document.body.appendChild(modal);
}

function viewLeg2Details(matchIndex) {
  const match = KNOCKOUT_STATE.currentMatches[matchIndex];
  if (!match || !match.leg2.completed) {
    if (typeof showNotification === 'function') {
      showNotification('error', 'No Data', 'Leg 2 has not been played yet', 2000);
    }
    return;
  }

  const modal = document.createElement('div');
  modal.className = 'modal-backdrop active';
  modal.style.zIndex = '10005';
  modal.innerHTML = `
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-head" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(37, 99, 235, 0.2));
                                     border-bottom: 2px solid rgba(59, 130, 246, 0.4);">
        <h2 style="color: #60a5fa;">📊 Leg 2 Details</h2>
        <button class="modal-close" onclick="this.closest('.modal-backdrop').remove()">✕</button>
      </div>

      <div style="padding: 30px;">
        <!-- Match Summary -->
        <div style="text-align: center; margin-bottom: 30px;">
          <div style="color: #94a3b8; font-size: 0.9em; margin-bottom: 15px;">
            ${STAGE_DISPLAY_NAMES[normalizeStageNames(match.stage)] || match.stage} - Leg 2
          </div>
          <div style="display: flex; justify-content: center; align-items: center; gap: 30px; margin-bottom: 20px;">
            <div>
              <div style="font-weight: 700; font-size: 1.5em; color: #f1f5f9; margin-bottom: 5px;">
                ${match.leg2.homeTeam.name}
              </div>
              <div style="color: #10b981; font-size: 0.85em;">🏠 Home</div>
            </div>
            <div style="display: flex; align-items: center; gap: 15px; padding: 12px 24px;
                        background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3);
                        border-radius: 10px;">
              <span style="color: ${match.leg2.scoreA > match.leg2.scoreB ? '#10b981' : '#64748b'};
                           font-weight: 900; font-size: 2.5em;">
                ${match.leg2.scoreA}
              </span>
              <span style="color: #64748b;">-</span>
              <span style="color: ${match.leg2.scoreB > match.leg2.scoreA ? '#10b981' : '#64748b'};
                           font-weight: 900; font-size: 2.5em;">
                ${match.leg2.scoreB}
              </span>
            </div>
            <div>
              <div style="font-weight: 700; font-size: 1.5em; color: #f1f5f9; margin-bottom: 5px;">
                ${match.leg2.awayTeam.name}
              </div>
              <div style="color: #3b82f6; font-size: 0.85em;">✈️ Away</div>
            </div>
          </div>
        </div>

        <!-- Aggregate Result -->
        <div style="background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.2));
                    border: 2px solid rgba(251, 191, 36, 0.4); border-radius: 12px; padding: 20px;
                    margin-bottom: 20px; text-align: center;">
          <div style="color: #fbbf24; font-weight: 600; font-size: 0.9em; margin-bottom: 12px;">
            FINAL AGGREGATE
          </div>
          <div style="display: flex; justify-content: center; align-items: center; gap: 20px;">
            <div>
              <div style="color: #f1f5f9; font-size: 1.2em; margin-bottom: 5px;">${match.teamA.name}</div>
              <div style="color: ${match.aggregate.teamA > match.aggregate.teamB ? '#10b981' : '#fbbf24'};
                          font-weight: 900; font-size: 2.5em;">
                ${match.aggregate.teamA}
              </div>
            </div>
            <div style="color: #fbbf24; font-size: 1.5em;">-</div>
            <div>
              <div style="color: #f1f5f9; font-size: 1.2em; margin-bottom: 5px;">${match.teamB.name}</div>
              <div style="color: ${match.aggregate.teamB > match.aggregate.teamA ? '#10b981' : '#fbbf24'};
                          font-weight: 900; font-size: 2.5em;">
                ${match.aggregate.teamB}
              </div>
            </div>
          </div>
          ${match.winner ? `
            <div style="margin-top: 20px; padding: 12px; background: rgba(16, 185, 129, 0.2);
                        border: 1px solid rgba(16, 185, 129, 0.4); border-radius: 8px;">
              <div style="font-size: 1.5em; margin-bottom: 5px;">🏆</div>
              <div style="color: #10b981; font-weight: 700; font-size: 1.3em;">
                ${match.winner} Advances!
              </div>
            </div>
          ` : ''}
        </div>

        <!-- Match Stats -->
        <div style="background: rgba(30, 41, 59, 0.6); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
          <h3 style="color: #3b82f6; margin-bottom: 15px;">Match Statistics</h3>
          <div style="display: grid; gap: 12px;">
            <div style="display: flex; justify-content: space-between; padding: 10px;
                        background: rgba(15, 23, 42, 0.6); border-radius: 6px;">
              <span style="color: #94a3b8;">Venue:</span>
              <span style="color: #f1f5f9; font-weight: 600;">${match.leg2.homeTeam.name} Stadium</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 10px;
                        background: rgba(15, 23, 42, 0.6); border-radius: 6px;">
              <span style="color: #94a3b8;">Second Leg Score:</span>
              <span style="color: #f1f5f9; font-weight: 600;">
                ${match.leg2.scoreA} - ${match.leg2.scoreB}
              </span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 10px;
                        background: rgba(15, 23, 42, 0.6); border-radius: 6px;">
              <span style="color: #94a3b8;">Total Goals:</span>
              <span style="color: #10b981; font-weight: 600;">
                ${match.aggregate.teamA + match.aggregate.teamB}
              </span>
            </div>
          </div>
        </div>

        <button onclick="this.closest('.modal-backdrop').remove()"
                class="btn-primary" style="width: 100%; padding: 12px; font-weight: 600;">
          Close
        </button>
      </div>
    </div>
  `;

  document.body.appendChild(modal);
}

// ========================================
// MANAGER CUSTOMIZATION SYSTEM
// ========================================

function createManagerAvatar(size = 'medium', showDetails = false) {
  if (!MANAGER_STATE.active) return '';

  const sizeMap = {
    small: { container: 60, icon: '2em', details: 'none' },
    medium: { container: 120, icon: '4em', details: showDetails ? 'block' : 'none' },
    large: { container: 200, icon: '6em', details: 'block' }
  };

  const dimensions = sizeMap[size] || sizeMap.medium;
  const custom = MANAGER_STATE.customization;

  // Get colors from catalog
  const skinTone = CUSTOMIZATION_CATALOG.skinTones.find(s => s.id === custom.skinTone)?.color || '#FFD7BA';
  const hairColor = CUSTOMIZATION_CATALOG.hairColors.find(h => h.id === custom.hairColor)?.color || '#6B4423';
  const shirtItem = CUSTOMIZATION_CATALOG.shirts.find(s => s.id === custom.shirt);
  const shirtColor = shirtItem?.color || '#3B82F6';

  return `
    <div style="position: relative; width: ${dimensions.container}px; height: ${dimensions.container}px;
                margin: 0 auto;">
      <!-- Avatar Circle -->
      <div style="width: 100%; height: 100%; border-radius: 50%;
                  background: linear-gradient(135deg, ${skinTone}, ${skinTone});
                  border: 4px solid rgba(71, 85, 105, 0.3);
                  display: flex; align-items: center; justify-content: center;
                  position: relative; overflow: hidden;
                  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);">

        <!-- Base Face -->
        <div style="font-size: ${dimensions.icon}; position: relative; z-index: 2;">
          👤
        </div>

        <!-- Glasses Overlay -->
        ${custom.glasses !== 'none' ? `
          <div style="position: absolute; top: ${size === 'large' ? '35%' : '38%'}; left: 50%;
                      transform: translateX(-50%); font-size: ${size === 'large' ? '2.5em' : '1.5em'}; z-index: 3;">
            ${CUSTOMIZATION_CATALOG.glasses.find(g => g.id === custom.glasses)?.icon || ''}
          </div>
        ` : ''}

        <!-- Hat Overlay -->
        ${custom.hat !== 'none' ? `
          <div style="position: absolute; top: ${size === 'large' ? '5%' : '8%'}; left: 50%;
                      transform: translateX(-50%); font-size: ${size === 'large' ? '3em' : '2em'}; z-index: 4;">
            ${CUSTOMIZATION_CATALOG.hats.find(h => h.id === custom.hat)?.icon || ''}
          </div>
        ` : ''}

        <!-- Facial Hair Overlay -->
        ${custom.facialHair !== 'none' ? `
          <div style="position: absolute; bottom: ${size === 'large' ? '25%' : '28%'}; left: 50%;
                      transform: translateX(-50%); font-size: ${size === 'large' ? '2em' : '1.2em'}; z-index: 3;">
            ${CUSTOMIZATION_CATALOG.facialHair.find(f => f.id === custom.facialHair)?.icon || ''}
          </div>
        ` : ''}

        <!-- Scarf Overlay -->
        ${custom.scarf !== 'none' ? `
          <div style="position: absolute; bottom: 0; left: 0; right: 0; height: 25%;
                      background: ${CUSTOMIZATION_CATALOG.scarfs.find(s => s.id === custom.scarf)?.color || '#EF4444'};
                      opacity: 0.8; z-index: 1;"></div>
        ` : ''}
      </div>

      <!-- Badge -->
      ${custom.badge !== 'none' ? `
        <div style="position: absolute; bottom: -5px; right: -5px;
                    background: linear-gradient(135deg, #FBBF24, #F59E0B);
                    width: ${size === 'large' ? '50px' : '35px'};
                    height: ${size === 'large' ? '50px' : '35px'};
                    border-radius: 50%; border: 3px solid rgba(15, 23, 42, 0.9);
                    display: flex; align-items: center; justify-content: center;
                    font-size: ${size === 'large' ? '1.5em' : '1em'};
                    box-shadow: 0 4px 12px rgba(251, 191, 36, 0.4);">
          ${CUSTOMIZATION_CATALOG.badges.find(b => b.id === custom.badge)?.icon || ''}
        </div>
      ` : ''}

      <!-- Level Badge -->
      <div style="position: absolute; top: -5px; right: -5px;
                  background: linear-gradient(135deg, #10B981, #059669);
                  padding: ${size === 'large' ? '8px 12px' : '4px 8px'};
                  border-radius: 12px; border: 2px solid rgba(15, 23, 42, 0.9);
                  font-weight: 700; color: #F1F5F9;
                  font-size: ${size === 'large' ? '0.9em' : '0.7em'};
                  box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);">
        LVL ${MANAGER_STATE.level}
      </div>

      ${showDetails ? `
        <div style="margin-top: 15px; text-align: center;">
          <div style="font-weight: 700; font-size: 1.2em; color: #F1F5F9; margin-bottom: 5px;">
            ${MANAGER_STATE.managerName}
          </div>
          <div style="color: #94A3B8; font-size: 0.9em;">
            ${MANAGER_STATE.reputation}
          </div>
        </div>
      ` : ''}
    </div>
  `;
}

function showManagerCustomization() {
  if (!MANAGER_STATE.active) {
    if (typeof showNotification === 'function') {
      showNotification('warning', 'No Manager Profile',
        'Create a manager profile first', 2000);
    }
    if (typeof showManagerSetup === 'function') {
      showManagerSetup();
    }
    return;
  }

  const out = document.getElementById('output');
  if (!out) return;

  out.innerHTML = `
    <div style="max-width: 1400px; margin: 0 auto;">
      <!-- Header -->
      <div style="background: linear-gradient(135deg, rgba(168, 85, 247, 0.2), rgba(139, 92, 246, 0.2));
                  border: 2px solid rgba(168, 85, 247, 0.4); border-radius: 16px; padding: 30px;
                  margin-bottom: 30px; text-align: center;">
        <h1 style="color: #C084FC; margin-bottom: 10px; font-size: 2.5em;">👔 Manager Customization</h1>
        <p style="color: #94A3B8; font-size: 1.1em;">
          Personalize your manager's appearance
        </p>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 30px;">
        <!-- Preview Panel -->
        <div style="background: linear-gradient(135deg, rgba(30, 41, 59, 0.9), rgba(15, 23, 42, 0.9));
                    border: 1px solid rgba(71, 85, 105, 0.3); border-radius: 16px; padding: 30px;
                    position: sticky; top: 20px; height: fit-content;">
          <h3 style="color: #10B981; margin-bottom: 20px; text-align: center;">Preview</h3>

          <!-- Avatar Display -->
          <div id="avatarPreview" style="margin-bottom: 25px;">
            ${createManagerAvatar('large', true)}
          </div>

          <!-- Manager Info -->
          <div style="background: rgba(15, 23, 42, 0.6); border-radius: 10px; padding: 16px; margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
              <span style="color: #94A3B8; font-size: 0.9em;">Level</span>
              <span style="color: #10B981; font-weight: 700;">${MANAGER_STATE.level}</span>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
              <span style="color: #94A3B8; font-size: 0.9em;">Reputation</span>
              <span style="color: #FBBF24; font-weight: 600;">${MANAGER_STATE.reputation}</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: #94A3B8; font-size: 0.9em;">Items Unlocked</span>
              <span style="color: #60A5FA; font-weight: 600;">${countUnlockedItems()}/${getTotalItems()}</span>
            </div>
          </div>

          <!-- Actions -->
          <button onclick="saveCustomization()" class="btn-primary"
                  style="width: 100%; padding: 14px; font-weight: 600; margin-bottom: 10px;">
            ✓ Save Changes
          </button>
          <button onclick="resetCustomization()" class="btn-secondary"
                  style="width: 100%; padding: 12px; font-weight: 600; margin-bottom: 10px;">
            ↺ Reset to Default
          </button>
          <button onclick="displayManagerProfile()" class="btn-secondary"
                  style="width: 100%; padding: 12px; font-weight: 600;">
            ← Back to Profile
          </button>
        </div>

        <!-- Customization Options -->
        <div style="background: rgba(30, 41, 59, 0.6); border: 1px solid rgba(71, 85, 105, 0.3);
                    border-radius: 16px; padding: 24px;">
          <div id="customizationTabs" style="display: flex; gap: 10px; margin-bottom: 25px;
                                              flex-wrap: wrap; border-bottom: 2px solid rgba(71, 85, 105, 0.3);
                                              padding-bottom: 15px;">
            ${[
              { id: 'appearance', name: 'Appearance', icon: '👤' },
              { id: 'clothing', name: 'Clothing', icon: '👔' },
              { id: 'accessories', name: 'Accessories', icon: '👓' },
              { id: 'badges', name: 'Badges', icon: '🏆' }
            ].map((tab, idx) => `
              <button onclick="switchCustomizationTab('${tab.id}')"
                      id="tab-${tab.id}"
                      class="customization-tab ${idx === 0 ? 'active' : ''}"
                      style="padding: 10px 20px; background: ${idx === 0 ? 'rgba(168, 85, 247, 0.2)' : 'rgba(15, 23, 42, 0.6)'};
                             border: 1px solid ${idx === 0 ? 'rgba(168, 85, 247, 0.4)' : 'rgba(71, 85, 105, 0.3)'};
                             border-radius: 8px; color: ${idx === 0 ? '#C084FC' : '#94A3B8'};
                             font-weight: 600; cursor: pointer; transition: all 0.2s;">
                ${tab.icon} ${tab.name}
              </button>
            `).join('')}
          </div>

          <!-- Tab Content -->
          <div id="customizationContent">
            ${createAppearanceTab()}
          </div>
        </div>
      </div>
    </div>
  `;
}

function countUnlockedItems() {
  let count = 0;
  Object.values(MANAGER_STATE.unlockedCustomization).forEach(items => {
    count += Array.isArray(items) ? items.length : 0;
  });
  return count;
}

function getTotalItems() {
  let count = 0;
  Object.values(CUSTOMIZATION_CATALOG).forEach(category => {
    count += Array.isArray(category) ? category.length : 0;
  });
  return count;
}

function createAppearanceTab() {
  return `
    <div class="customization-section">
      <!-- Skin Tone -->
      <div style="margin-bottom: 30px;">
        <h4 style="color: #10B981; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
          <span style="font-size: 1.5em;">🎨</span>
          Skin Tone
        </h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 12px;">
          ${CUSTOMIZATION_CATALOG.skinTones.map(tone => {
            const isUnlocked = MANAGER_STATE.unlockedCustomization.skinTones.includes(tone.id);
            const isSelected = MANAGER_STATE.customization.skinTone === tone.id;
            return `
              <button onclick="${isUnlocked ? `selectCustomization('skinTone', '${tone.id}')` : `showLockMessage(${tone.unlockLevel})`}"
                      class="customization-item ${isSelected ? 'selected' : ''} ${!isUnlocked ? 'locked' : ''}"
                      style="padding: 16px; background: ${isSelected ? 'rgba(16, 185, 129, 0.2)' : 'rgba(15, 23, 42, 0.6)'};
                             border: 2px solid ${isSelected ? '#10B981' : 'rgba(71, 85, 105, 0.3)'};
                             border-radius: 10px; cursor: ${isUnlocked ? 'pointer' : 'not-allowed'};
                             opacity: ${isUnlocked ? '1' : '0.5'}; transition: all 0.2s; position: relative;"
                      ${isUnlocked ? `onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'"` : ''}>
                <div style="width: 50px; height: 50px; background: ${tone.color};
                            border-radius: 50%; margin: 0 auto 10px;
                            border: 3px solid rgba(71, 85, 105, 0.3);"></div>
                <div style="color: ${isSelected ? '#10B981' : '#94A3B8'}; font-size: 0.85em; font-weight: 600; text-align: center;">
                  ${tone.name}
                </div>
                ${!isUnlocked ? `
                  <div style="position: absolute; top: 8px; right: 8px; background: rgba(239, 68, 68, 0.9);
                              color: #FFF; padding: 2px 6px; border-radius: 4px; font-size: 0.7em; font-weight: 700;">
                    LVL ${tone.unlockLevel}
                  </div>
                ` : ''}
              </button>
            `;
          }).join('')}
        </div>
      </div>

      <!-- Hair Style -->
      <div style="margin-bottom: 30px;">
        <h4 style="color: #10B981; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
          <span style="font-size: 1.5em;">💇</span>
          Hair Style
        </h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 12px;">
          ${CUSTOMIZATION_CATALOG.hairStyles.map(style => {
            const isUnlocked = MANAGER_STATE.unlockedCustomization.hairStyles.includes(style.id);
            const isSelected = MANAGER_STATE.customization.hairStyle === style.id;
            return createCustomizationButton('hairStyle', style, isUnlocked, isSelected);
          }).join('')}
        </div>
      </div>

      <!-- Hair Color -->
      <div style="margin-bottom: 30px;">
        <h4 style="color: #10B981; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
          <span style="font-size: 1.5em;">🎨</span>
          Hair Color
        </h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 12px;">
          ${CUSTOMIZATION_CATALOG.hairColors.map(color => {
            const isUnlocked = MANAGER_STATE.unlockedCustomization.hairColors.includes(color.id);
            const isSelected = MANAGER_STATE.customization.hairColor === color.id;
            return `
              <button onclick="${isUnlocked ? `selectCustomization('hairColor', '${color.id}')` : `showLockMessage(${color.unlockLevel})`}"
                      style="padding: 16px; background: ${isSelected ? 'rgba(16, 185, 129, 0.2)' : 'rgba(15, 23, 42, 0.6)'};
                             border: 2px solid ${isSelected ? '#10B981' : 'rgba(71, 85, 105, 0.3)'};
                             border-radius: 10px; cursor: ${isUnlocked ? 'pointer' : 'not-allowed'};
                             opacity: ${isUnlocked ? '1' : '0.5'}; transition: all 0.2s; position: relative;">
                <div style="width: 50px; height: 50px; background: ${color.color};
                            border-radius: 50%; margin: 0 auto 10px;
                            border: 3px solid rgba(71, 85, 105, 0.3);"></div>
                <div style="color: ${isSelected ? '#10B981' : '#94A3B8'}; font-size: 0.85em; font-weight: 600;">
                  ${color.name}
                </div>
                ${!isUnlocked ? `
                  <div style="position: absolute; top: 8px; right: 8px; background: rgba(239, 68, 68, 0.9);
                              color: #FFF; padding: 2px 6px; border-radius: 4px; font-size: 0.7em; font-weight: 700;">
                    LVL ${color.unlockLevel}
                  </div>
                ` : ''}
              </button>
            `;
          }).join('')}
        </div>
      </div>

      <!-- Facial Hair -->
      <div>
        <h4 style="color: #10B981; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
          <span style="font-size: 1.5em;">🧔</span>
          Facial Hair
        </h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 12px;">
          ${CUSTOMIZATION_CATALOG.facialHair.map(facial => {
            const isUnlocked = MANAGER_STATE.unlockedCustomization.facialHair.includes(facial.id);
            const isSelected = MANAGER_STATE.customization.facialHair === facial.id;
            return createCustomizationButton('facialHair', facial, isUnlocked, isSelected);
          }).join('')}
        </div>
      </div>
    </div>
  `;
}

function createClothingTab() {
  return `
    <div class="customization-section">
      <!-- Shirts -->
      <div style="margin-bottom: 30px;">
        <h4 style="color: #3B82F6; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
          <span style="font-size: 1.5em;">👕</span>
          Shirts
        </h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px;">
          ${CUSTOMIZATION_CATALOG.shirts.map(shirt => {
            const isUnlocked = MANAGER_STATE.unlockedCustomization.shirts.includes(shirt.id);
            const isSelected = MANAGER_STATE.customization.shirt === shirt.id;
            return `
              <button onclick="${isUnlocked ? `selectCustomization('shirt', '${shirt.id}')` : `showLockMessage(${shirt.unlockLevel})`}"
                      style="padding: 20px; background: ${isSelected ? 'rgba(59, 130, 246, 0.2)' : 'rgba(15, 23, 42, 0.6)'};
                             border: 2px solid ${isSelected ? '#3B82F6' : 'rgba(71, 85, 105, 0.3)'};
                             border-radius: 10px; cursor: ${isUnlocked ? 'pointer' : 'not-allowed'};
                             opacity: ${isUnlocked ? '1' : '0.5'}; transition: all 0.2s; position: relative;">
                <div style="font-size: 3em; margin-bottom: 10px; filter: ${isUnlocked ? 'none' : 'grayscale(100%)'};">
                  ${shirt.icon}
                </div>
                <div style="color: ${isSelected ? '#60A5FA' : '#94A3B8'}; font-size: 0.85em; font-weight: 600; margin-bottom: 5px;">
                  ${shirt.name}
                </div>
                <div style="width: 40px; height: 40px; background: ${shirt.color};
                            border-radius: 6px; margin: 0 auto; border: 2px solid rgba(71, 85, 105, 0.3);"></div>
                ${!isUnlocked ? `
                  <div style="position: absolute; top: 8px; right: 8px; background: rgba(239, 68, 68, 0.9);
                              color: #FFF; padding: 2px 6px; border-radius: 4px; font-size: 0.7em; font-weight: 700;">
                    LVL ${shirt.unlockLevel}
                  </div>
                ` : ''}
              </button>
            `;
          }).join('')}
        </div>
      </div>

      <!-- Suits -->
      <div>
        <h4 style="color: #3B82F6; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
          <span style="font-size: 1.5em;">🤵</span>
          Suit Style
        </h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px;">
          ${CUSTOMIZATION_CATALOG.suits.map(suit => {
            const isUnlocked = MANAGER_STATE.unlockedCustomization.suits.includes(suit.id);
            const isSelected = MANAGER_STATE.customization.suit === suit.id;
            return createCustomizationButton('suit', suit, isUnlocked, isSelected);
          }).join('')}
        </div>
      </div>
    </div>
  `;
}

function createAccessoriesTab() {
  return `
    <div class="customization-section">
      <!-- Glasses -->
      <div style="margin-bottom: 30px;">
        <h4 style="color: #F59E0B; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
          <span style="font-size: 1.5em;">👓</span>
          Glasses
        </h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 12px;">
          ${CUSTOMIZATION_CATALOG.glasses.map(glass => {
            const isUnlocked = MANAGER_STATE.unlockedCustomization.glasses.includes(glass.id);
            const isSelected = MANAGER_STATE.customization.glasses === glass.id;
            return createCustomizationButton('glasses', glass, isUnlocked, isSelected);
          }).join('')}
        </div>
      </div>

      <!-- Hats -->
      <div style="margin-bottom: 30px;">
        <h4 style="color: #F59E0B; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
          <span style="font-size: 1.5em;">🧢</span>
          Hats
        </h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 12px;">
          ${CUSTOMIZATION_CATALOG.hats.map(hat => {
            const isUnlocked = MANAGER_STATE.unlockedCustomization.hats.includes(hat.id);
            const isSelected = MANAGER_STATE.customization.hat === hat.id;
            return createCustomizationButton('hat', hat, isUnlocked, isSelected);
          }).join('')}
        </div>
      </div>

      <!-- Scarfs -->
      <div>
        <h4 style="color: #F59E0B; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
          <span style="font-size: 1.5em;">🧣</span>
          Scarfs
        </h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 12px;">
          ${CUSTOMIZATION_CATALOG.scarfs.map(scarf => {
            const isUnlocked = MANAGER_STATE.unlockedCustomization.scarfs.includes(scarf.id);
            const isSelected = MANAGER_STATE.customization.scarf === scarf.id;
            return `
              <button onclick="${isUnlocked ? `selectCustomization('scarf', '${scarf.id}')` : `showLockMessage(${scarf.unlockLevel})`}"
                      style="padding: 20px; background: ${isSelected ? 'rgba(245, 158, 11, 0.2)' : 'rgba(15, 23, 42, 0.6)'};
                             border: 2px solid ${isSelected ? '#F59E0B' : 'rgba(71, 85, 105, 0.3)'};
                             border-radius: 10px; cursor: ${isUnlocked ? 'pointer' : 'not-allowed'};
                             opacity: ${isUnlocked ? '1' : '0.5'}; transition: all 0.2s; position: relative;">
                <div style="font-size: 3em; margin-bottom: 10px;">
                  ${scarf.icon}
                </div>
                <div style="color: ${isSelected ? '#FBBF24' : '#94A3B8'}; font-size: 0.85em; font-weight: 600; margin-bottom: 8px;">
                  ${scarf.name}
                </div>
                ${scarf.color ? `
                  <div style="width: 60px; height: 8px; background: ${scarf.color};
                              border-radius: 4px; margin: 0 auto; border: 1px solid rgba(71, 85, 105, 0.3);"></div>
                ` : ''}
                ${!isUnlocked ? `
                  <div style="position: absolute; top: 8px; right: 8px; background: rgba(239, 68, 68, 0.9);
                              color: #FFF; padding: 2px 6px; border-radius: 4px; font-size: 0.7em; font-weight: 700;">
                    LVL ${scarf.unlockLevel}
                  </div>
                ` : ''}
              </button>
            `;
          }).join('')}
        </div>
      </div>
    </div>
  `;
}

function createBadgesTab() {
  return `
    <div class="customization-section">
      <h4 style="color: #FBBF24; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
        <span style="font-size: 1.5em;">🏆</span>
        Achievement Badges
      </h4>
      <p style="color: #94A3B8; margin-bottom: 20px; font-size: 0.95em;">
        Unlock badges by reaching higher levels and completing achievements
      </p>
      <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px;">
        ${CUSTOMIZATION_CATALOG.badges.map(badge => {
          const isUnlocked = MANAGER_STATE.unlockedCustomization.badges.includes(badge.id) ||
                            MANAGER_STATE.level >= badge.unlockLevel;
          const isSelected = MANAGER_STATE.customization.badge === badge.id;
          return `
            <button onclick="${isUnlocked ? `selectCustomization('badge', '${badge.id}')` : `showLockMessage(${badge.unlockLevel})`}"
                    style="padding: 24px; background: ${isSelected ? 'rgba(251, 191, 36, 0.2)' : 'rgba(15, 23, 42, 0.6)'};
                           border: 2px solid ${isSelected ? '#FBBF24' : 'rgba(71, 85, 105, 0.3)'};
                           border-radius: 10px; cursor: ${isUnlocked ? 'pointer' : 'not-allowed'};
                           opacity: ${isUnlocked ? '1' : '0.4'}; transition: all 0.2s; position: relative;">
              <div style="font-size: 4em; margin-bottom: 10px; filter: ${isUnlocked ? 'none' : 'grayscale(100%)'};">
                ${badge.icon || '🔒'}
              </div>
              <div style="color: ${isSelected ? '#FBBF24' : '#94A3B8'}; font-size: 0.9em; font-weight: 600;">
                ${badge.name}
              </div>
              ${!isUnlocked ? `
                <div style="position: absolute; top: 8px; right: 8px; background: rgba(239, 68, 68, 0.9);
                            color: #FFF; padding: 3px 8px; border-radius: 4px; font-size: 0.75em; font-weight: 700;">
                  LVL ${badge.unlockLevel}
                </div>
              ` : ''}
            </button>
          `;
        }).join('')}
      </div>
    </div>
  `;
}

function createCustomizationButton(category, item, isUnlocked, isSelected) {
  return `
    <button onclick="${isUnlocked ? `selectCustomization('${category}', '${item.id}')` : `showLockMessage(${item.unlockLevel})`}"
            style="padding: 20px; background: ${isSelected ? 'rgba(16, 185, 129, 0.2)' : 'rgba(15, 23, 42, 0.6)'};
                   border: 2px solid ${isSelected ? '#10B981' : 'rgba(71, 85, 105, 0.3)'};
                   border-radius: 10px; cursor: ${isUnlocked ? 'pointer' : 'not-allowed'};
                   opacity: ${isUnlocked ? '1' : '0.5'}; transition: all 0.2s; position: relative;"
            ${isUnlocked ? `onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'"` : ''}>
      <div style="font-size: 3em; margin-bottom: 10px; filter: ${isUnlocked ? 'none' : 'grayscale(100%)'};">
        ${item.icon}
      </div>
      <div style="color: ${isSelected ? '#10B981' : '#94A3B8'}; font-size: 0.85em; font-weight: 600;">
        ${item.name}
      </div>
      ${!isUnlocked ? `
        <div style="position: absolute; top: 8px; right: 8px; background: rgba(239, 68, 68, 0.9);
                    color: #FFF; padding: 2px 6px; border-radius: 4px; font-size: 0.7em; font-weight: 700;">
          LVL ${item.unlockLevel}
        </div>
      ` : ''}
    </button>
  `;
}

function switchCustomizationTab(tabId) {
  // Remove active class from all tabs
  document.querySelectorAll('.customization-tab').forEach(tab => {
    tab.style.background = 'rgba(15, 23, 42, 0.6)';
    tab.style.borderColor = 'rgba(71, 85, 105, 0.3)';
    tab.style.color = '#94A3B8';
  });

  // Add active class to selected tab
  const activeTab = document.getElementById(`tab-${tabId}`);
  if (activeTab) {
    activeTab.style.background = 'rgba(168, 85, 247, 0.2)';
    activeTab.style.borderColor = 'rgba(168, 85, 247, 0.4)';
    activeTab.style.color = '#C084FC';
  }

  // Update content
  const content = document.getElementById('customizationContent');
  if (!content) return;

  switch(tabId) {
    case 'appearance':
      content.innerHTML = createAppearanceTab();
      break;
    case 'clothing':
      content.innerHTML = createClothingTab();
      break;
    case 'accessories':
      content.innerHTML = createAccessoriesTab();
      break;
    case 'badges':
      content.innerHTML = createBadgesTab();
      break;
  }
}

function selectCustomization(category, itemId) {
  MANAGER_STATE.customization[category] = itemId;

  // Update preview
  const preview = document.getElementById('avatarPreview');
  if (preview) {
    preview.innerHTML = createManagerAvatar('large', true);
  }

  // Refresh current tab to show selection
  const activeTab = document.querySelector('.customization-tab[style*="rgba(168, 85, 247"]');
  if (activeTab) {
    const tabId = activeTab.id.replace('tab-', '');
    switchCustomizationTab(tabId);
  }

  if (window.VERBOSE_LOGGING) console.log(`Selected ${category}: ${itemId}`);
}

function showLockMessage(levelRequired) {
  if (typeof showNotification === 'function') {
    showNotification('info', 'Item Locked',
      `Reach level ${levelRequired} to unlock this item`, 2500);
  }
}

function saveCustomization() {
  // Save to storage
  if (typeof AUTO_SAVE !== 'undefined' && AUTO_SAVE.save) {
    AUTO_SAVE.save();
  }

  if (typeof showNotification === 'function') {
    showNotification('success', 'Saved!',
      'Your customization has been saved', 2000);
  }
}

function resetCustomization() {
  if (!confirm('Reset all customization to default? This cannot be undone.')) {
    return;
  }

  MANAGER_STATE.customization = {
    skinTone: 'light',
    hairStyle: 'short',
    hairColor: 'brown',
    facialHair: 'none',
    facialHairColor: 'brown',
    glasses: 'none',
    hat: 'none',
    scarf: 'none',
    shirt: 'polo-blue',
    suit: 'casual',
    accessories: [],
    badge: 'none'
  };

  // Refresh display
  showManagerCustomization();

  if (typeof showNotification === 'function') {
    showNotification('success', 'Reset Complete',
      'Customization reset to default', 2000);
  }
}

/**
 * Initialize Career Mode
 */
function initializeCareerMode(managerName, clubName) {
  if (!managerName || !clubName) {
    showUtilityMessage('Please enter manager and club names', 'error');
    return false;
  }

  CAREER_STATE.active = true;
  CAREER_STATE.managerName = managerName;
  CAREER_STATE.clubName = clubName;
  CAREER_STATE.currentSeason = 1;
  CAREER_STATE.startYear = new Date().getFullYear();

  showUtilityMessage(`Career Mode started: ${managerName} at ${clubName}!`, 'success');
  return true;
}

/**
 * End season and update career statistics
 */
function endSeasonCareer(seasonResults) {
  if (!CAREER_STATE.active) return;

  const seasonData = {
    seasonNumber: CAREER_STATE.currentSeason,
    year: CAREER_STATE.startYear + CAREER_STATE.currentSeason - 1,
    leaguePosition: seasonResults.position,
    points: seasonResults.points,
    wins: seasonResults.wins,
    draws: seasonResults.draws,
    losses: seasonResults.losses,
    goalsFor: seasonResults.goalsFor,
    goalsAgainst: seasonResults.goalsAgainst,
    goalDifference: seasonResults.goalDifference,
    topScorer: seasonResults.topScorer,
    topAssists: seasonResults.topAssists,
    trophies: seasonResults.trophies || 0,
    wasChampion: seasonResults.position === 1,
    wasPromoted: seasonResults.promoted || false,
    wasRelegated: seasonResults.relegated || false
  };

  // Update career totals
  CAREER_STATE.careerStats.totalMatches += seasonResults.wins + seasonResults.draws + seasonResults.losses;
  CAREER_STATE.careerStats.totalWins += seasonResults.wins;
  CAREER_STATE.careerStats.totalDraws += seasonResults.draws;
  CAREER_STATE.careerStats.totalLosses += seasonResults.losses;
  CAREER_STATE.careerStats.totalGoalsScored += seasonResults.goalsFor;
  CAREER_STATE.careerStats.totalGoalsConceded += seasonResults.goalsAgainst;

  if (seasonResults.position === 1) {
    CAREER_STATE.careerStats.championships++;
    CAREER_STATE.careerStats.totalTrophies++;
  }

  if (seasonResults.promoted) CAREER_STATE.careerStats.promotions++;
  if (seasonResults.relegated) CAREER_STATE.careerStats.relegations++;

  // Update streak tracking
  updateStreaks(seasonResults);

  // Update records
  updateCareerRecords(seasonResults);

  // Check for Hall of Fame inductions
  checkHallOfFameInductions(seasonResults);

  // Check for milestones
  checkCareerMilestones();

  // Add to history
  CAREER_STATE.seasonHistory.push(seasonData);
  CAREER_STATE.currentSeason++;
  CAREER_STATE.totalSeasons++;

  // Save career progress
  saveCareerProgress();
}

/**
 * Update win/unbeaten streaks
 */
function updateStreaks(seasonResults) {
  // This is simplified - in full implementation would track match-by-match
  if (seasonResults.position === 1) {
    CAREER_STATE.currentStreak.wins++;
    CAREER_STATE.currentStreak.unbeaten++;

    // Update win streak record
    if (CAREER_STATE.currentStreak.wins > CAREER_STATE.records.longestWinStreak.streak) {
      CAREER_STATE.records.longestWinStreak = {
        streak: CAREER_STATE.currentStreak.wins,
        startSeason: CAREER_STATE.currentSeason - CAREER_STATE.currentStreak.wins + 1,
        endSeason: CAREER_STATE.currentSeason
      };
    }

    // Update unbeaten record
    if (CAREER_STATE.currentStreak.unbeaten > CAREER_STATE.records.longestUnbeatenRun.run) {
      CAREER_STATE.records.longestUnbeatenRun = {
        run: CAREER_STATE.currentStreak.unbeaten,
        startSeason: CAREER_STATE.currentSeason - CAREER_STATE.currentStreak.unbeaten + 1,
        endSeason: CAREER_STATE.currentSeason
      };
    }
  } else if (seasonResults.position <= 3) {
    CAREER_STATE.currentStreak.wins = 0;
    CAREER_STATE.currentStreak.unbeaten++;

    // Update unbeaten record
    if (CAREER_STATE.currentStreak.unbeaten > CAREER_STATE.records.longestUnbeatenRun.run) {
      CAREER_STATE.records.longestUnbeatenRun = {
        run: CAREER_STATE.currentStreak.unbeaten,
        startSeason: CAREER_STATE.currentSeason - CAREER_STATE.currentStreak.unbeaten + 1,
        endSeason: CAREER_STATE.currentSeason
      };
    }
  } else {
    // Streak ended - reset both
    CAREER_STATE.currentStreak.wins = 0;
    CAREER_STATE.currentStreak.unbeaten = 0;
  }
}

/**
 * Update career records
 */
function updateCareerRecords(seasonResults) {
  // Top scorer record
  if (seasonResults.topScorer && seasonResults.topScorer.goals > CAREER_STATE.records.mostGoalsInSeason.goals) {
    CAREER_STATE.records.mostGoalsInSeason = {
      player: seasonResults.topScorer.name,
      goals: seasonResults.topScorer.goals,
      season: CAREER_STATE.currentSeason
    };
  }

  // Top assists record
  if (seasonResults.topAssists && seasonResults.topAssists.assists > CAREER_STATE.records.mostAssistsInSeason.assists) {
    CAREER_STATE.records.mostAssistsInSeason = {
      player: seasonResults.topAssists.name,
      assists: seasonResults.topAssists.assists,
      season: CAREER_STATE.currentSeason
    };
  }

  // League position record
  if (seasonResults.position < CAREER_STATE.records.highestLeaguePosition.position) {
    CAREER_STATE.records.highestLeaguePosition = {
      position: seasonResults.position,
      season: CAREER_STATE.currentSeason
    };
  }

  // Points record
  if (seasonResults.points > CAREER_STATE.records.mostPointsInSeason.points) {
    CAREER_STATE.records.mostPointsInSeason = {
      points: seasonResults.points,
      season: CAREER_STATE.currentSeason
    };
  }
}

/**
 * Check for Hall of Fame inductions
 */
function checkHallOfFameInductions(seasonResults) {
  // Induct top performers into Hall of Fame
  if (!seasonResults || !seasonResults.topScorer) return;
  if (!seasonResults || !seasonResults.topScorer) return;
  if (seasonResults.topScorer && seasonResults.topScorer.goals >= 30) {
    const existing = CAREER_STATE.hallOfFame.find(p => p.name === seasonResults.topScorer.name);

    if (!existing) {
      CAREER_STATE.hallOfFame.push({
        name: seasonResults.topScorer.name,
        type: 'Legendary Striker',
        achievements: [`${seasonResults.topScorer.goals} goals in Season ${CAREER_STATE.currentSeason}`],
        seasons: [CAREER_STATE.currentSeason],
        inductionYear: CAREER_STATE.startYear + CAREER_STATE.currentSeason - 1
      });
    } else {
      existing.achievements.push(`${seasonResults.topScorer.goals} goals in Season ${CAREER_STATE.currentSeason}`);
      existing.seasons.push(CAREER_STATE.currentSeason);
    }
  }

  // Induct exceptional playmakers
  if (seasonResults.topAssists && seasonResults.topAssists.assists >= 20) {
    const existing = CAREER_STATE.hallOfFame.find(p => p.name === seasonResults.topAssists.name);

    if (!existing) {
      CAREER_STATE.hallOfFame.push({
        name: seasonResults.topAssists.name,
        type: 'Legendary Playmaker',
        achievements: [`${seasonResults.topAssists.assists} assists in Season ${CAREER_STATE.currentSeason}`],
        seasons: [CAREER_STATE.currentSeason],
        inductionYear: CAREER_STATE.startYear + CAREER_STATE.currentSeason - 1
      });
    } else {
      existing.achievements.push(`${seasonResults.topAssists.assists} assists in Season ${CAREER_STATE.currentSeason}`);
      existing.seasons.push(CAREER_STATE.currentSeason);
    }
  }
}

/**
 * Check for career milestones
 */
function checkCareerMilestones() {
  const milestones = [];

  // Championship milestones
  if (CAREER_STATE.careerStats.championships === 1) {
    milestones.push({ type: 'First Championship', season: CAREER_STATE.currentSeason });
  } else if (CAREER_STATE.careerStats.championships === 5) {
    milestones.push({ type: 'Dynasty Builder - 5 Championships', season: CAREER_STATE.currentSeason });
  } else if (CAREER_STATE.careerStats.championships === 10) {
    milestones.push({ type: 'Legend - 10 Championships', season: CAREER_STATE.currentSeason });
  }

  // Match milestones
  if (CAREER_STATE.careerStats.totalMatches >= 100 && CAREER_STATE.careerStats.totalMatches < 200) {
    if (!CAREER_STATE.milestones.find(m => m.type === 'Century of Matches')) {
      milestones.push({ type: 'Century of Matches', season: CAREER_STATE.currentSeason });
    }
  } else if (CAREER_STATE.careerStats.totalMatches >= 500) {
    if (!CAREER_STATE.milestones.find(m => m.type === '500 Matches')) {
      milestones.push({ type: '500 Matches - Career Veteran', season: CAREER_STATE.currentSeason });
    }
  }

  // Win percentage milestones
  const winPercentage = (CAREER_STATE.careerStats.totalWins / CAREER_STATE.careerStats.totalMatches) * 100;
  if (winPercentage >= 70 && CAREER_STATE.careerStats.totalMatches >= 100) {
    if (!CAREER_STATE.milestones.find(m => m.type === 'Master Tactician')) {
      milestones.push({ type: 'Master Tactician - 70% Win Rate', season: CAREER_STATE.currentSeason });
    }
  }

  // Season milestones
  if (CAREER_STATE.totalSeasons === 10) {
    milestones.push({ type: 'Decade of Excellence', season: CAREER_STATE.currentSeason });
  } else if (CAREER_STATE.totalSeasons === 25) {
    milestones.push({ type: 'Silver Jubilee - 25 Seasons', season: CAREER_STATE.currentSeason });
  }

  CAREER_STATE.milestones.push(...milestones);

  // Show milestone notifications
  if (milestones.length > 0) {
    showMilestoneNotification(milestones);
  }
}

/**
 * Show milestone notification
 */
// showMilestoneNotification is defined earlier in the file with unified functionality (line 11922)

function closeMilestoneModal() {
  const modal = document.getElementById('milestone-modal');
  if (modal) modal.remove();
}

/**
 * Show Career Stats Dashboard
 */
function showCareerDashboard() {
  if (!CAREER_STATE.active) {
    showUtilityMessage('No active career. Start Season Mode first!', 'error');
    return;
  }

  const winRate = CAREER_STATE.careerStats.totalMatches > 0
    ? ((CAREER_STATE.careerStats.totalWins / CAREER_STATE.careerStats.totalMatches) * 100).toFixed(1)
    : 0;

  const avgGoalsPerMatch = CAREER_STATE.careerStats.totalMatches > 0
    ? (CAREER_STATE.careerStats.totalGoalsScored / CAREER_STATE.careerStats.totalMatches).toFixed(2)
    : 0;

  const modal = document.createElement('div');
  modal.id = 'career-dashboard-modal';
  modal.style.cssText = `
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.9); display: flex; align-items: center;
    justify-content: center; z-index: 10000; animation: fadeIn 0.3s;
    overflow-y: auto; padding: 20px;
  `;

  const content = `
    <div style="background: #1a1a2e; padding: 30px; border-radius: 16px; max-width: 1200px; width: 95%; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px rgba(0,0,0,0.5);">

      <!-- Header -->
      <div style="border-bottom: 2px solid #667eea; padding-bottom: 20px; margin-bottom: 30px;">
        <h2 style="margin: 0 0 10px 0; color: #667eea; font-size: 32px;">Career Dashboard</h2>
        <div style="color: #888; font-size: 16px;">
          <strong style="color: #ffd700;">${CAREER_STATE.managerName}</strong> at <strong style="color: #10b981;">${CAREER_STATE.clubName}</strong>
        </div>
        <div style="color: #666; font-size: 14px; margin-top: 5px;">
          Season ${CAREER_STATE.currentSeason} • Started ${CAREER_STATE.startYear}
        </div>
      </div>

      <!-- Career Statistics -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 12px; text-align: center;">
          <div style="color: rgba(255,255,255,0.8); font-size: 14px; margin-bottom: 5px;">Total Seasons</div>
          <div style="color: white; font-size: 32px; font-weight: bold;">${CAREER_STATE.totalSeasons}</div>
        </div>
        <div style="background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%); padding: 20px; border-radius: 12px; text-align: center;">
          <div style="color: rgba(0,0,0,0.7); font-size: 14px; margin-bottom: 5px;">Championships</div>
          <div style="color: #1a1a2e; font-size: 32px; font-weight: bold;">${CAREER_STATE.careerStats.championships}</div>
        </div>
        <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 20px; border-radius: 12px; text-align: center;">
          <div style="color: rgba(255,255,255,0.8); font-size: 14px; margin-bottom: 5px;">Win Rate</div>
          <div style="color: white; font-size: 32px; font-weight: bold;">${winRate}%</div>
        </div>
        <div style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); padding: 20px; border-radius: 12px; text-align: center;">
          <div style="color: rgba(255,255,255,0.8); font-size: 14px; margin-bottom: 5px;">Total Matches</div>
          <div style="color: white; font-size: 32px; font-weight: bold;">${CAREER_STATE.careerStats.totalMatches}</div>
        </div>
      </div>

      <!-- Record and Stats Grid -->
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">

        <!-- Match Record -->
        <div style="background: #16213e; padding: 20px; border-radius: 12px; border: 1px solid #334155;">
          <h3 style="margin: 0 0 15px 0; color: #667eea;">Match Record</h3>
          <div style="color: #e2e8f0; line-height: 1.8;">
            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #334155;">
              <span>Wins:</span> <strong style="color: #10b981;">${CAREER_STATE.careerStats.totalWins}</strong>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #334155;">
              <span>Draws:</span> <strong style="color: #f59e0b;">${CAREER_STATE.careerStats.totalDraws}</strong>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #334155;">
              <span>Losses:</span> <strong style="color: #ef4444;">${CAREER_STATE.careerStats.totalLosses}</strong>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 8px 0;">
              <span>Goals Scored:</span> <strong style="color: #3b82f6;">${CAREER_STATE.careerStats.totalGoalsScored}</strong>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 8px 0;">
              <span>Goals Conceded:</span> <strong style="color: #8b5cf6;">${CAREER_STATE.careerStats.totalGoalsConceded}</strong>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-top: 2px solid #667eea; margin-top: 10px;">
              <span>Avg Goals/Match:</span> <strong style="color: #ffd700;">${avgGoalsPerMatch}</strong>
            </div>
          </div>
        </div>

        <!-- Career Records -->
        <div style="background: #16213e; padding: 20px; border-radius: 12px; border: 1px solid #334155;">
          <h3 style="margin: 0 0 15px 0; color: #ffd700;">Career Records</h3>
          <div style="color: #e2e8f0; font-size: 14px; line-height: 1.8;">
            ${CAREER_STATE.records.mostGoalsInSeason.player ? `
              <div style="padding: 8px 0; border-bottom: 1px solid #334155;">
                <div style="color: #10b981; font-weight: bold;">Most Goals in a Season</div>
                <div>${CAREER_STATE.records.mostGoalsInSeason.player} - ${CAREER_STATE.records.mostGoalsInSeason.goals} goals (S${CAREER_STATE.records.mostGoalsInSeason.season})</div>
              </div>
            ` : ''}
            ${CAREER_STATE.records.mostAssistsInSeason.player ? `
              <div style="padding: 8px 0; border-bottom: 1px solid #334155;">
                <div style="color: #3b82f6; font-weight: bold;">Most Assists in a Season</div>
                <div>${CAREER_STATE.records.mostAssistsInSeason.player} - ${CAREER_STATE.records.mostAssistsInSeason.assists} assists (S${CAREER_STATE.records.mostAssistsInSeason.season})</div>
              </div>
            ` : ''}
            ${CAREER_STATE.records.highestLeaguePosition.position < 999 ? `
              <div style="padding: 8px 0; border-bottom: 1px solid #334155;">
                <div style="color: #ffd700; font-weight: bold;">Best League Finish</div>
                <div>${CAREER_STATE.records.highestLeaguePosition.position}${getOrdinalSuffix(CAREER_STATE.records.highestLeaguePosition.position)} Place (Season ${CAREER_STATE.records.highestLeaguePosition.season})</div>
              </div>
            ` : ''}
            ${CAREER_STATE.records.mostPointsInSeason.points > 0 ? `
              <div style="padding: 8px 0;">
                <div style="color: #8b5cf6; font-weight: bold;">Most Points in a Season</div>
                <div>${CAREER_STATE.records.mostPointsInSeason.points} points (Season ${CAREER_STATE.records.mostPointsInSeason.season})</div>
              </div>
            ` : ''}
          </div>
        </div>
      </div>

      <!-- Hall of Fame -->
      ${CAREER_STATE.hallOfFame.length > 0 ? `
        <div style="background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%); padding: 25px; border-radius: 12px; margin-bottom: 30px;">
          <h3 style="margin: 0 0 20px 0; color: #1a1a2e; font-size: 24px; text-align: center;">🌟 Hall of Fame 🌟</h3>
          <div style="display: grid; gap: 15px;">
            ${CAREER_STATE.hallOfFame.map(player => `
              <div style="background: rgba(255,255,255,0.9); padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                <div style="color: #1a1a2e; font-weight: bold; font-size: 18px; margin-bottom: 5px;">${player.name}</div>
                <div style="color: #667eea; font-size: 14px; margin-bottom: 8px;">${player.type}</div>
                <div style="color: #64748b; font-size: 13px;">
                  ${player.achievements.slice(0, 3).join(' • ')}
                </div>
                <div style="color: #94a3b8; font-size: 12px; margin-top: 5px;">
                  Inducted ${player.inductionYear}
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      ` : ''}

      <!-- Milestones -->
      ${CAREER_STATE.milestones.length > 0 ? `
        <div style="background: #16213e; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #667eea;">
          <h3 style="margin: 0 0 15px 0; color: #667eea;">🏆 Career Milestones</h3>
          <div style="display: flex; flex-wrap: wrap; gap: 10px;">
            ${CAREER_STATE.milestones.slice(-10).reverse().map(m => `
              <div style="background: rgba(102, 126, 234, 0.2); padding: 10px 15px; border-radius: 8px; border: 1px solid #667eea;">
                <div style="color: #ffd700; font-size: 13px; font-weight: bold;">${m.type}</div>
                <div style="color: #888; font-size: 11px;">Season ${m.season}</div>
              </div>
            `).join('')}
          </div>
        </div>
      ` : ''}

      <!-- Actions -->
      <div style="display: flex; gap: 15px; margin-top: 20px;">
        <button onclick="closeCareerDashboard()" style="flex: 1; background: #3b82f6; color: white; border: none; padding: 14px; border-radius: 8px; cursor: pointer; font-weight: 600;">
          Close
        </button>
        <button onclick="showSeasonHistory()" style="flex: 1; background: #10b981; color: white; border: none; padding: 14px; border-radius: 8px; cursor: pointer; font-weight: 600;">
          View Season History
        </button>
        <button onclick="exportCareerData()" style="flex: 1; background: #8b5cf6; color: white; border: none; padding: 14px; border-radius: 8px; cursor: pointer; font-weight: 600;">
          Export Career
        </button>
      </div>
    </div>
  `;

  modal.innerHTML = content;
  document.body.appendChild(modal);
}

function getOrdinalSuffix(num) {
  const j = num % 10;
  const k = num % 100;
  if (j === 1 && k !== 11) return num + 'st';
  if (j === 2 && k !== 12) return num + 'nd';
  if (j === 3 && k !== 13) return num + 'rd';
  return num + 'th';
}

function closeCareerDashboard() {
  const modal = document.getElementById('career-dashboard-modal');
  if (modal) modal.remove();
}

/**
 * Show Season History
 */
function showSeasonHistory() {
  if (CAREER_STATE.seasonHistory.length === 0) {
    showUtilityMessage('No season history yet', 'info');
    return;
  }

  closeCareerDashboard();

  const modal = document.createElement('div');
  modal.id = 'season-history-modal';
  modal.style.cssText = `
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.9); display: flex; align-items: center;
    justify-content: center; z-index: 10001; animation: fadeIn 0.3s;
    overflow-y: auto; padding: 20px;
  `;

  const content = `
    <div style="background: #1a1a2e; padding: 30px; border-radius: 16px; max-width: 1000px; width: 95%; max-height: 90vh; overflow-y: auto;">
      <h2 style="margin: 0 0 20px 0; color: #667eea; font-size: 28px;">Season History</h2>

      <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse; color: white;">
          <thead>
            <tr style="background: #16213e; border-bottom: 2px solid #667eea;">
              <th style="padding: 12px; text-align: left;">Season</th>
              <th style="padding: 12px; text-align: center;">Year</th>
              <th style="padding: 12px; text-align: center;">Position</th>
              <th style="padding: 12px; text-align: center;">Points</th>
              <th style="padding: 12px; text-align: center;">W-D-L</th>
              <th style="padding: 12px; text-align: center;">GF-GA</th>
              <th style="padding: 12px; text-align: center;">GD</th>
              <th style="padding: 12px; text-align: left;">Top Scorer</th>
            </tr>
          </thead>
          <tbody>
            ${CAREER_STATE.seasonHistory.map(season => {
              let positionColor = '#e2e8f0';
              if (season.leaguePosition === 1) positionColor = '#ffd700';
              else if (season.leaguePosition <= 4) positionColor = '#3b82f6';
              else if (season.leaguePosition <= 6) positionColor = '#10b981';

              return `
                <tr style="border-bottom: 1px solid #334155;">
                  <td style="padding: 12px;">
                    <strong>Season ${season.seasonNumber}</strong>
                    ${season.wasChampion ? ' 🏆' : ''}
                    ${season.wasPromoted ? ' ⬆️' : ''}
                    ${season.wasRelegated ? ' ⬇️' : ''}
                  </td>
                  <td style="padding: 12px; text-align: center; color: #888;">${season.year}</td>
                  <td style="padding: 12px; text-align: center;">
                    <span style="color: ${positionColor}; font-weight: bold;">${season.leaguePosition}${getOrdinalSuffix(season.leaguePosition)}</span>
                  </td>
                  <td style="padding: 12px; text-align: center; font-weight: bold;">${season.points}</td>
                  <td style="padding: 12px; text-align: center; color: #888;">${season.wins}-${season.draws}-${season.losses}</td>
                  <td style="padding: 12px; text-align: center; color: #888;">${season.goalsFor}-${season.goalsAgainst}</td>
                  <td style="padding: 12px; text-align: center;">
                    <span style="color: ${season.goalDifference >= 0 ? '#10b981' : '#ef4444'};">${season.goalDifference >= 0 ? '+' : ''}${season.goalDifference}</span>
                  </td>
                  <td style="padding: 12px; font-size: 13px;">
                    ${season.topScorer ? `${season.topScorer.name} (${season.topScorer.goals})` : '-'}
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      </div>

      <button onclick="closeSeasonHistory()" style="width: 100%; margin-top: 20px; background: #3b82f6; color: white; border: none; padding: 14px; border-radius: 8px; cursor: pointer; font-weight: 600;">
        Close
      </button>
    </div>
  `;

  modal.innerHTML = content;
  document.body.appendChild(modal);
}

function closeSeasonHistory() {
  const modal = document.getElementById('season-history-modal');
  if (modal) modal.remove();
}

/**
 * Export career data to JSON
 */
function exportCareerData() {
  const careerData = {
    manager: CAREER_STATE.managerName,
    club: CAREER_STATE.clubName,
    exportDate: new Date().toISOString(),
    careerStats: CAREER_STATE.careerStats,
    seasonHistory: CAREER_STATE.seasonHistory,
    hallOfFame: CAREER_STATE.hallOfFame,
    records: CAREER_STATE.records,
    milestones: CAREER_STATE.milestones
  };

  const dataStr = JSON.stringify(careerData, null, 2);
  const dataBlob = new Blob([dataStr], { type: 'application/json' });
  const url = URL.createObjectURL(dataBlob);

  const link = document.createElement('a');
  link.href = url;
  link.download = `career_${CAREER_STATE.managerName.replace(/\s+/g, '_')}_${Date.now()}.json`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);

  showUtilityMessage('Career data exported!', 'success');
}

/**
 * Save career progress to localStorage
 */
function saveCareerProgress() {
  try {
    localStorage.setItem('careerState', JSON.stringify(CAREER_STATE));
  } catch (e) {
    console.error('Failed to save career progress', e);
  }
}

/**
 * Load career progress from localStorage
 */
function loadCareerProgress() {
  try {
    const saved = localStorage.getItem('careerState');
    if (saved) {
      CAREER_STATE = JSON.parse(saved);
      showUtilityMessage('Career progress loaded!', 'success');
      return true;
    }
  } catch (e) {
    console.error('Failed to load career progress', e);
  }
  return false;
}

/************* ADVANCED ANALYTICS V2 *************/

let ANALYTICS_STATE = {
  matchAnalytics: [], // Store analytics for each match
  aggregatedStats: null,
  currentMatchAnalysis: null
};

/**
 * Calculate Expected Goals (xG) for a shot
 * Based on distance, angle, shot type, and situation
 */
function calculateXG(shot) {
  const {
    distance = 20,      // Distance from goal in meters (0-40)
    angle = 45,         // Angle to goal in degrees (0-90)
    shotType = 'normal', // 'header', 'volley', 'normal', 'penalty'
    situation = 'open',  // 'open', 'counter', 'setpiece', 'corner'
    defenderPressure = 'medium', // 'low', 'medium', 'high'
    assistType = null    // 'through_ball', 'cross', 'cutback', null
  } = shot;

  let xg = 1.0;

  // Distance factor (exponential decay)
  // Closer shots have much higher xG
  if (distance <= 6) {
    xg *= 0.5; // Very close (6-yard box)
  } else if (distance <= 11) {
    xg *= 0.35; // Penalty area edge
  } else if (distance <= 16.5) {
    xg *= 0.2; // Inside box
  } else if (distance <= 25) {
    xg *= 0.08; // Edge of box
  } else {
    xg *= 0.03; // Long range
  }

  // Angle factor
  // Central shots are worth more
  const angleFactor = Math.cos((angle * Math.PI) / 180);
  xg *= (0.5 + angleFactor * 0.5);

  // Shot type multiplier
  const shotTypeMultipliers = {
    'penalty': 7.5,      // Penalties ~75% conversion
    'normal': 1.0,
    'volley': 0.7,       // Volleys are harder
    'header': 0.5        // Headers generally lower xG
  };
  xg *= shotTypeMultipliers[shotType] || 1.0;

  // Situation multiplier
  const situationMultipliers = {
    'counter': 1.3,      // Counter attacks more dangerous
    'setpiece': 0.9,
    'corner': 0.4,       // Corners rarely score
    'open': 1.0
  };
  xg *= situationMultipliers[situation] || 1.0;

  // Defender pressure
  const pressureMultipliers = {
    'low': 1.2,
    'medium': 1.0,
    'high': 0.7
  };
  xg *= pressureMultipliers[defenderPressure] || 1.0;

  // Assist type bonus
  if (assistType === 'through_ball') xg *= 1.15;
  if (assistType === 'cutback') xg *= 1.1;
  if (assistType === 'cross') xg *= 0.9;

  // Cap at reasonable values
  return Math.min(Math.max(xg, 0.01), 0.95);
}

/**
 * Calculate team quality from team strength/overall rating
 */
function calculateTeamQuality(team) {
  return team.strength || team.overall || team.rating || 75;
}

/**
 * Generate shot data for a match based on match result
 */
function generateMatchShots(teamA, teamB, result) {
  const shots = { teamA: [], teamB: [] };

  // Calculate expected shots based on team quality and possession
  const teamAQuality = calculateTeamQuality(teamA);
  const teamBQuality = calculateTeamQuality(teamB);

  const qualityRatio = teamAQuality / (teamAQuality + teamBQuality);
  const baseShots = 12;

  const teamAShots = Math.floor(baseShots * (0.5 + qualityRatio * 0.8)) + Math.floor(Math.random() * 5);
  const teamBShots = Math.floor(baseShots * (0.5 + (1 - qualityRatio) * 0.8)) + Math.floor(Math.random() * 5);

  // Generate Team A shots
  for (let i = 0; i < teamAShots; i++) {
    const isGoal = i < (result.scoreA || 0);
    shots.teamA.push(generateShot(teamA, isGoal, i + 1));
  }

  // Generate Team B shots
  for (let i = 0; i < teamBShots; i++) {
    const isGoal = i < (result.scoreB || 0);
    shots.teamB.push(generateShot(teamB, isGoal, i + 1));
  }

  return shots;
}

/**
 * Generate a single shot with realistic parameters
 */
function generateShot(team, isGoal, shotNumber) {
  const shotTypes = ['normal', 'header', 'volley'];
  const situations = ['open', 'counter', 'setpiece', 'corner'];
  const pressureLevels = ['low', 'medium', 'high'];
  const assistTypes = [null, 'through_ball', 'cross', 'cutback'];

  // If it's a goal, make it more likely to be a good shooting position
  let distance, angle, shotType, situation, pressure;

  if (isGoal) {
    distance = 8 + Math.random() * 10; // 8-18m for goals
    angle = Math.random() * 40; // Central angles
    shotType = Math.random() > 0.7 ? 'header' : 'normal';
    situation = Math.random() > 0.6 ? 'counter' : 'open';
    pressure = Math.random() > 0.5 ? 'low' : 'medium';
  } else {
    distance = 10 + Math.random() * 25; // 10-35m
    angle = Math.random() * 80;
    shotType = shotTypes[Math.floor(Math.random() * shotTypes.length)];
    situation = situations[Math.floor(Math.random() * situations.length)];
    pressure = pressureLevels[Math.floor(Math.random() * pressureLevels.length)];
  }

  const assistType = Math.random() > 0.6 ? assistTypes[Math.floor(Math.random() * assistTypes.length)] : null;

  const shot = {
    minute: Math.floor(Math.random() * 90) + 1,
    distance,
    angle,
    shotType,
    situation,
    defenderPressure: pressure,
    assistType,
    isGoal,
    onTarget: isGoal || Math.random() > 0.6,
    // Shot position on field (for heat map) - normalized 0-100
    positionX: 50 + (Math.random() - 0.5) * 40, // 30-70 (attacking half)
    positionY: 70 + Math.random() * 25 // 70-95 (in attacking third)
  };

  shot.xg = calculateXG(shot);

  return shot;
}

/**
 * Analyze match and generate comprehensive analytics
 */
function analyzeMatch(teamA, teamB, result) {
  const shots = generateMatchShots(teamA, teamB, result);

  // Calculate xG totals
  const xgA = shots.teamA.reduce((sum, shot) => sum + shot.xg, 0);
  const xgB = shots.teamB.reduce((sum, shot) => sum + shot.xg, 0);

  // Shot statistics
  const shotsOnTargetA = shots.teamA.filter(s => s.onTarget).length;
  const shotsOnTargetB = shots.teamB.filter(s => s.onTarget).length;

  // Big chances (xG > 0.3)
  const bigChancesA = shots.teamA.filter(s => s.xg > 0.3).length;
  const bigChancesB = shots.teamB.filter(s => s.xg > 0.3).length;

  // Possession estimate based on team quality
  const teamAQuality = calculateTeamQuality(teamA);
  const teamBQuality = calculateTeamQuality(teamB);
  const totalQuality = teamAQuality + teamBQuality;
  const possessionA = Math.floor((teamAQuality / totalQuality) * 40 + 30); // 30-70%
  const possessionB = 100 - possessionA;

  // Passing accuracy estimate
  const passAccuracyA = Math.floor(75 + (teamAQuality / 100) * 15); // 75-90%
  const passAccuracyB = Math.floor(75 + (teamBQuality / 100) * 15);

  // Build analytics object
  const analytics = {
    matchId: `${teamA.name}_vs_${teamB.name}_${Date.now()}`,
    timestamp: Date.now(),
    teamA: { name: teamA.name, ...teamA },
    teamB: { name: teamB.name, ...teamB },
    result: {
      scoreA: result.scoreA || 0,
      scoreB: result.scoreB || 0
    },
    xg: {
      teamA: Number(xgA.toFixed(2)),
      teamB: Number(xgB.toFixed(2)),
      difference: Number((xgA - xgB).toFixed(2))
    },
    shots: {
      teamA: {
        total: shots.teamA.length,
        onTarget: shotsOnTargetA,
        bigChances: bigChancesA,
        shots: shots.teamA
      },
      teamB: {
        total: shots.teamB.length,
        onTarget: shotsOnTargetB,
        bigChances: bigChancesB,
        shots: shots.teamB
      }
    },
    possession: {
      teamA: possessionA,
      teamB: possessionB
    },
    passing: {
      teamA: {
        accuracy: passAccuracyA,
        total: Math.floor(possessionA * 5 + Math.random() * 50),
        completed: 0 // Will calculate
      },
      teamB: {
        accuracy: passAccuracyB,
        total: Math.floor(possessionB * 5 + Math.random() * 50),
        completed: 0
      }
    },
    performance: {
      teamA: calculatePerformanceRating(result.scoreA, xgA, shots.teamA.length, possessionA),
      teamB: calculatePerformanceRating(result.scoreB, xgB, shots.teamB.length, possessionB)
    }
  };

  // Calculate completed passes
  analytics.passing.teamA.completed = Math.floor(analytics.passing.teamA.total * (passAccuracyA / 100));
  analytics.passing.teamB.completed = Math.floor(analytics.passing.teamB.total * (passAccuracyB / 100));

  // Store analytics
  ANALYTICS_STATE.matchAnalytics.push(analytics);
  ANALYTICS_STATE.currentMatchAnalysis = analytics;

  return analytics;
}

/**
 * Calculate performance rating (0-10)
 */
function calculatePerformanceRating(goals, xg, shots, possession) {
  let rating = 5.0;

  // Goals scored
  rating += goals * 1.5;

  // Performance vs xG
  const xgDiff = goals - xg;
  if (xgDiff > 1) rating += 1.5; // Clinical finishing
  else if (xgDiff > 0) rating += 0.5;
  else if (xgDiff < -2) rating -= 1.0; // Wasteful

  // Shot volume
  rating += Math.min(shots * 0.1, 1.5);

  // Possession
  if (possession > 60) rating += 0.5;
  else if (possession < 40) rating -= 0.3;

  return Number(Math.max(1, Math.min(10, rating)).toFixed(1));
}

/**
 * Show Advanced Analytics Dashboard
 */
function showAdvancedAnalytics(analytics) {
  if (!analytics) {
    showUtilityMessage('No analytics data available', 'error');
    return;
  }

  const modal = document.createElement('div');
  modal.id = 'advanced-analytics-modal';
  modal.style.cssText = `
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.95); display: flex; align-items: center;
    justify-content: center; z-index: 10002; animation: fadeIn 0.3s;
    overflow-y: auto; padding: 20px;
  `;

  const xgDiff = analytics.xg.teamA - analytics.xg.teamB;
  const xgWinner = xgDiff > 0.3 ? analytics.teamA.name : xgDiff < -0.3 ? analytics.teamB.name : 'Even';

  const content = `
    <div style="background: #0f172a; padding: 30px; border-radius: 16px; max-width: 1400px; width: 98%; max-height: 95vh; overflow-y: auto; box-shadow: 0 25px 50px rgba(0,0,0,0.5);">

      <!-- Header -->
      <div style="border-bottom: 3px solid #3b82f6; padding-bottom: 20px; margin-bottom: 30px;">
        <h2 style="margin: 0 0 15px 0; color: #3b82f6; font-size: 36px; text-align: center;">⚡ Advanced Analytics</h2>
        <div style="display: flex; justify-content: center; align-items: center; gap: 40px; color: white; font-size: 24px; font-weight: bold;">
          <div style="text-align: right; flex: 1;">
            <div style="color: #10b981; font-size: 32px;">${analytics.teamA.name}</div>
            <div style="color: #888; font-size: 16px; margin-top: 5px;">Performance: ${analytics.performance.teamA}/10</div>
          </div>
          <div style="text-align: center;">
            <div style="background: linear-gradient(135deg, #667eea, #764ba2); padding: 15px 30px; border-radius: 12px;">
              ${analytics.result.scoreA} - ${analytics.result.scoreB}
            </div>
            <div style="color: #fbbf24; font-size: 14px; margin-top: 8px;">xG: ${analytics.xg.teamA} - ${analytics.xg.teamB}</div>
          </div>
          <div style="text-align: left; flex: 1;">
            <div style="color: #ef4444; font-size: 32px;">${analytics.teamB.name}</div>
            <div style="color: #888; font-size: 16px; margin-top: 5px;">Performance: ${analytics.performance.teamB}/10</div>
          </div>
        </div>
      </div>

      <!-- xG Analysis -->
      <div style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); padding: 25px; border-radius: 16px; margin-bottom: 30px; border: 2px solid #3b82f6;">
        <h3 style="margin: 0 0 20px 0; color: #fbbf24; font-size: 24px; text-align: center;">📊 Expected Goals (xG) Analysis</h3>

        <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 30px; align-items: center; margin-bottom: 25px;">
          <div style="text-align: center;">
            <div style="font-size: 48px; font-weight: bold; color: #10b981; text-shadow: 0 0 20px rgba(16, 185, 129, 0.5);">
              ${analytics.xg.teamA}
            </div>
            <div style="color: #888; margin-top: 10px;">Expected Goals</div>
            <div style="color: ${analytics.result.scoreA > analytics.xg.teamA ? '#10b981' : '#ef4444'}; margin-top: 5px; font-size: 14px;">
              ${analytics.result.scoreA > analytics.xg.teamA ? '🔥 Clinical Finishing' : analytics.result.scoreA < analytics.xg.teamA - 1 ? '❌ Wasteful' : '✓ Normal'}
            </div>
          </div>

          <div style="text-align: center; color: #64748b;">
            <div style="font-size: 18px; font-weight: bold; margin-bottom: 10px;">xG Difference</div>
            <div style="font-size: 32px; color: ${Math.abs(xgDiff) < 0.3 ? '#fbbf24' : xgDiff > 0 ? '#10b981' : '#ef4444'};">
              ${xgDiff > 0 ? '+' : ''}${analytics.xg.difference}
            </div>
            <div style="font-size: 14px; margin-top: 8px;">
              ${xgWinner === 'Even' ? '⚖️ Balanced Match' : `🎯 ${xgWinner} Dominated`}
            </div>
          </div>

          <div style="text-align: center;">
            <div style="font-size: 48px; font-weight: bold; color: #ef4444; text-shadow: 0 0 20px rgba(239, 68, 68, 0.5);">
              ${analytics.xg.teamB}
            </div>
            <div style="color: #888; margin-top: 10px;">Expected Goals</div>
            <div style="color: ${analytics.result.scoreB > analytics.xg.teamB ? '#10b981' : '#ef4444'}; margin-top: 5px; font-size: 14px;">
              ${analytics.result.scoreB > analytics.xg.teamB ? '🔥 Clinical Finishing' : analytics.result.scoreB < analytics.xg.teamB - 1 ? '❌ Wasteful' : '✓ Normal'}
            </div>
          </div>
        </div>

        <!-- xG Bar Chart -->
        <div style="background: #1e293b; padding: 20px; border-radius: 12px;">
          <div style="height: 40px; display: flex; border-radius: 8px; overflow: hidden; box-shadow: inset 0 2px 8px rgba(0,0,0,0.3);">
            ${analytics.xg.teamA + analytics.xg.teamB > 0 ? `
              <div style="background: linear-gradient(90deg, #10b981, #059669); width: ${(analytics.xg.teamA / (analytics.xg.teamA + analytics.xg.teamB)) * 100}%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 18px;">
                ${analytics.xg.teamA}
              </div>
              <div style="background: linear-gradient(90deg, #dc2626, #ef4444); width: ${(analytics.xg.teamB / (analytics.xg.teamA + analytics.xg.teamB)) * 100}%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 18px;">
                ${analytics.xg.teamB}
              </div>
            ` : `
              <div style="display: flex; align-items: center; justify-content: center; width: 100%; color: #888; font-style: italic;">
                No shots recorded
              </div>
            `}
          </div>
        </div>
      </div>

      <!-- Match Statistics Grid -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">

        <!-- Shots -->
        <div style="background: #1e293b; padding: 20px; border-radius: 12px; border: 1px solid #334155;">
          <h4 style="margin: 0 0 15px 0; color: #3b82f6; font-size: 18px; text-align: center;">⚽ Shot Statistics</h4>
          <div style="color: white;">
            <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #334155;">
              <span>Total Shots:</span>
              <div><strong style="color: #10b981;">${analytics.shots.teamA.total}</strong> - <strong style="color: #ef4444;">${analytics.shots.teamB.total}</strong></div>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #334155;">
              <span>On Target:</span>
              <div><strong style="color: #10b981;">${analytics.shots.teamA.onTarget}</strong> - <strong style="color: #ef4444;">${analytics.shots.teamB.onTarget}</strong></div>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 10px 0;">
              <span>Big Chances:</span>
              <div><strong style="color: #10b981;">${analytics.shots.teamA.bigChances}</strong> - <strong style="color: #ef4444;">${analytics.shots.teamB.bigChances}</strong></div>
            </div>
          </div>
        </div>

        <!-- Possession -->
        <div style="background: #1e293b; padding: 20px; border-radius: 12px; border: 1px solid #334155;">
          <h4 style="margin: 0 0 15px 0; color: #8b5cf6; font-size: 18px; text-align: center;">📊 Possession</h4>
          <div style="height: 120px; display: flex; flex-direction: column; justify-content: center;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 15px; color: white; font-size: 32px; font-weight: bold;">
              <span style="color: #10b981;">${analytics.possession.teamA}%</span>
              <span style="color: #ef4444;">${analytics.possession.teamB}%</span>
            </div>
            <div style="height: 30px; display: flex; border-radius: 8px; overflow: hidden;">
              <div style="background: linear-gradient(90deg, #10b981, #059669); width: ${analytics.possession.teamA}%;"></div>
              <div style="background: linear-gradient(90deg, #dc2626, #ef4444); width: ${analytics.possession.teamB}%;"></div>
            </div>
          </div>
        </div>

        <!-- Passing -->
        <div style="background: #1e293b; padding: 20px; border-radius: 12px; border: 1px solid #334155;">
          <h4 style="margin: 0 0 15px 0; color: #fbbf24; font-size: 18px; text-align: center;">🎯 Passing Accuracy</h4>
          <div style="color: white;">
            <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #334155;">
              <span>Accuracy:</span>
              <div><strong style="color: #10b981;">${analytics.passing.teamA.accuracy}%</strong> - <strong style="color: #ef4444;">${analytics.passing.teamB.accuracy}%</strong></div>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 10px 0;">
              <span>Completed:</span>
              <div><strong style="color: #10b981;">${analytics.passing.teamA.completed}</strong> - <strong style="color: #ef4444;">${analytics.passing.teamB.completed}</strong></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Shot Maps -->
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
        ${renderShotMap(analytics.teamA.name, analytics.shots.teamA.shots, '#10b981')}
        ${renderShotMap(analytics.teamB.name, analytics.shots.teamB.shots, '#ef4444')}
      </div>

      <!-- Actions -->
      <div style="display: flex; gap: 15px; justify-content: center;">
        <button onclick="closeAdvancedAnalytics()" style="background: #3b82f6; color: white; border: none; padding: 16px 32px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px;">
          Close
        </button>
        <button onclick="exportAnalytics()" style="background: #8b5cf6; color: white; border: none; padding: 16px 32px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px;">
          Export Data
        </button>
        <button onclick="compareWithPreviousMatches()" style="background: #10b981; color: white; border: none; padding: 16px 32px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px;">
          Compare Matches
        </button>
      </div>
    </div>
  `;

  modal.innerHTML = content;
  document.body.appendChild(modal);
}

/**
 * Render shot map visualization
 */
function renderShotMap(teamName, shots, color) {
  const goals = shots.filter(s => s.isGoal);
  const misses = shots.filter(s => !s.isGoal);

  return `
    <div style="background: #1e293b; padding: 20px; border-radius: 12px; border: 1px solid #334155;">
      <h4 style="margin: 0 0 15px 0; color: ${color}; font-size: 18px; text-align: center;">🎯 ${teamName} Shot Map</h4>
      <div style="position: relative; width: 100%; height: 300px; background: linear-gradient(180deg, #0a3d0a 0%, #052905 100%); border-radius: 8px; overflow: hidden; border: 2px solid #1a4d1a;">

        <!-- Field markings -->
        <div style="position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 40%; height: 18%; border: 2px solid rgba(255,255,255,0.3); border-bottom: none;"></div>
        <div style="position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 70%; height: 40%; border: 2px solid rgba(255,255,255,0.3); border-bottom: none;"></div>

        <!-- Shots -->
        ${shots.map((shot, idx) => {
          const x = shot.positionX || (50 + (Math.random() - 0.5) * 30);
          const y = shot.positionY || (75 + Math.random() * 20);
          const size = 8 + shot.xg * 20; // Bigger circles = higher xG

          return `
            <div title="xG: ${shot.xg.toFixed(2)} | ${shot.minute}' | ${shot.shotType}" style="
              position: absolute;
              left: ${x}%;
              top: ${100 - y}%;
              width: ${size}px;
              height: ${size}px;
              background: ${shot.isGoal ? color : 'rgba(255,255,255,0.3)'};
              border: 2px solid ${shot.isGoal ? '#ffffff' : color};
              border-radius: 50%;
              transform: translate(-50%, -50%);
              cursor: pointer;
              box-shadow: 0 0 ${shot.isGoal ? '15px' : '8px'} ${shot.isGoal ? color : 'rgba(255,255,255,0.2)'};
              z-index: ${shot.isGoal ? 10 : 5};
            "></div>
          `;
        }).join('')}
      </div>
      <div style="display: flex; justify-content: space-around; margin-top: 15px; color: #888; font-size: 13px;">
        <div>⚪ Miss (${misses.length})</div>
        <div style="color: ${color};">⚫ Goal (${goals.length})</div>
        <div>Size = xG</div>
      </div>
    </div>
  `;
}

function closeAdvancedAnalytics() {
  const modal = document.getElementById('advanced-analytics-modal');
  if (modal) modal.remove();
}

function exportAnalytics() {
  if (!ANALYTICS_STATE.currentMatchAnalysis) {
    showUtilityMessage('No analytics to export', 'error');
    return;
  }

  const dataStr = JSON.stringify(ANALYTICS_STATE.currentMatchAnalysis, null, 2);
  const dataBlob = new Blob([dataStr], { type: 'application/json' });
  const url = URL.createObjectURL(dataBlob);

  const link = document.createElement('a');
  link.href = url;
  link.download = `match_analytics_${Date.now()}.json`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);

  showUtilityMessage('Analytics exported!', 'success');
}

function compareWithPreviousMatches() {
  if (ANALYTICS_STATE.matchAnalytics.length < 2) {
    showUtilityMessage('Need at least 2 matches to compare', 'info');
    return;
  }

  showUtilityMessage('Match comparison feature - coming soon!', 'info');
}

/************* LIVE MATCH SIMULATION MODE *************/

let LIVE_MATCH_STATE = null;

/**
 * Simulate match in live mode with minute-by-minute updates
 */
function simulateMatchLive(teamA, teamB, round = 'Friendly', matchImportance = 1.0) {
  const modal = createLiveMatchModal(teamA, teamB, round);
  document.body.appendChild(modal);

  LIVE_MATCH_STATE = {
    teamA, teamB, round,
    currentMinute: 0,
    scoreA: 0, scoreB: 0,
    events: [],
    interval: null,
    seed: generateMatchSeed(teamA.name, teamB.name),
    goalTimes: [],
    cardEvents: []
  };

  // Pre-calculate match events using the match engine
  const finalResult = simulateMatchWithSeed(teamA, teamB, true, matchImportance, 'normal', LIVE_MATCH_STATE.seed);

  // Extract goal times from result
  const allGoals = [];
  if (finalResult.goalsA && Array.isArray(finalResult.goalsA)) {
    finalResult.goalsA.forEach(goal => {
      allGoals.push({
        minute: goal.minute || Math.floor(Math.random() * 88) + 1,
        team: 'A',
        scorer: goal.scorer || { name: 'Player' }
      });
    });
  }
  if (finalResult.goalsB && Array.isArray(finalResult.goalsB)) {
    finalResult.goalsB.forEach(goal => {
      allGoals.push({
        minute: goal.minute || Math.floor(Math.random() * 88) + 1,
        team: 'B',
        scorer: goal.scorer || { name: 'Player' }
      });
    });
  }

  // Sort goals by minute
  LIVE_MATCH_STATE.goalTimes = allGoals.sort((a, b) => a.minute - b.minute);

  // Initialize momentum system
  if (typeof MOMENTUM_SYSTEM !== 'undefined') {
    MOMENTUM_SYSTEM.reset();
    // Display initial momentum
    const momentumDisplay = document.getElementById('momentumDisplay');
    if (momentumDisplay) {
      momentumDisplay.innerHTML = MOMENTUM_SYSTEM.getVisualMomentum(teamA, teamB);
    }
  }

  // Start simulation
  addCommentaryEvent("⚽ Kick off!", 'info');
  startLiveSimulation();
}

function createLiveMatchModal(teamA, teamB, round) {
  const modal = document.createElement('div');
  modal.className = 'modal-backdrop live-match-modal';
  modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); z-index: 10000; display: flex; align-items: center; justify-content: center;';

  // Get formations for display
  const formationA = teamA.formation || selectedFormations?.teamA || '4-4-2';
  const formationB = teamB.formation || selectedFormations?.teamB || '4-4-2';

  modal.innerHTML = `
    <div class="modal live-match-content" style="max-width: 600px; width: 90%; background: #1e293b; border-radius: 16px; max-height: 80vh; display: flex; flex-direction: column;" onclick="event.stopPropagation()">
      <div style="padding: 20px; background: linear-gradient(135deg, #3b82f6, #2563eb); border-radius: 16px 16px 0 0; text-align: center;">
        <div style="color: #cbd5e1; font-size: 0.8em; margin-bottom: 8px;">${round}</div>
        <div style="display: flex; justify-content: space-between; align-items: center; gap: 20px;">
          <div style="flex: 1; text-align: right;">
            <div style="color: white; font-weight: 700; font-size: 1.1em; margin-bottom: 4px;">${teamA.name}</div>
            <div style="color: #cbd5e1; font-size: 0.75em;">${teamA.strength}</div>
            <div style="color: #fbbf24; font-size: 0.7em; margin-top: 2px;">${formationA}</div>
          </div>
          <div style="display: flex; align-items: center; gap: 12px;">
            <div style="font-size: 2.5em; font-weight: 700; color: white; min-width: 40px; text-align: center;" id="liveScoreA">0</div>
            <div style="color: #94a3b8; font-size: 1.2em;">-</div>
            <div style="font-size: 2.5em; font-weight: 700; color: white; min-width: 40px; text-align: center;" id="liveScoreB">0</div>
          </div>
          <div style="flex: 1; text-align: left;">
            <div style="color: white; font-weight: 700; font-size: 1.1em; margin-bottom: 4px;">${teamB.name}</div>
            <div style="color: #cbd5e1; font-size: 0.75em;">${teamB.strength}</div>
            <div style="color: #fbbf24; font-size: 0.7em; margin-top: 2px;">${formationB}</div>
          </div>
        </div>
        <div style="margin-top: 15px; color: white; font-size: 1.3em; font-weight: 600;">
          ⏱️ <span id="liveMatchClock">0'</span>
        </div>
      </div>
      <div id="momentumDisplay" style="padding: 0 20px;">
        <!-- Momentum bar will be inserted here -->
      </div>
      <div style="flex: 1; overflow-y: auto; padding: 20px; background: #0f172a;">
        <div style="color: #94a3b8; font-size: 0.9em; margin-bottom: 10px; font-weight: 600;">Commentary:</div>
        <div id="liveCommentaryFeed" style="display: flex; flex-direction: column-reverse; gap: 8px; max-height: 300px; overflow-y: auto;"></div>
      </div>
      <div style="padding: 15px; background: #1e293b; border-top: 1px solid rgba(71, 85, 105, 0.3); display: flex; gap: 10px; border-radius: 0 0 16px 16px;">
        <button onclick="skipToEnd()" style="flex: 1; background: #3b82f6; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600;">
          ⏩ Skip to End
        </button>
        <button onclick="closeLiveMatch()" style="background: #475569; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer;">
          ✕
        </button>
      </div>
    </div>
  `;

  return modal;
}

function startLiveSimulation() {
  if (!LIVE_MATCH_STATE) return;

  LIVE_MATCH_STATE.interval = setInterval(() => {
    LIVE_MATCH_STATE.currentMinute += 1;
    updateMatchClock(LIVE_MATCH_STATE.currentMinute);

    // Check for goals at this minute
    const goalsAtMinute = LIVE_MATCH_STATE.goalTimes.filter(g => g.minute === LIVE_MATCH_STATE.currentMinute);
    goalsAtMinute.forEach(goal => {
      if (goal.team === 'A') {
        LIVE_MATCH_STATE.scoreA++;
      } else {
        LIVE_MATCH_STATE.scoreB++;
      }

      // Generate AI commentary for goal
      const goalCommentary = getCommentaryForGoal({
        scorer: goal.scorer,
        player: goal.scorer?.name || 'Player',
        team: goal.team === 'A' ? LIVE_MATCH_STATE.teamA.name : LIVE_MATCH_STATE.teamB.name,
        minute: LIVE_MATCH_STATE.currentMinute
      }, LIVE_MATCH_STATE);

      addCommentaryEvent(
        `⚽ ${LIVE_MATCH_STATE.currentMinute}' ${goalCommentary}`,
        'goal'
      );
      updateLiveScore(LIVE_MATCH_STATE.scoreA, LIVE_MATCH_STATE.scoreB);
      playGoalAnimation();

      // Trigger goal celebration with confetti
      if (typeof celebrateGoal === 'function') {
        const liveMatchModal = document.querySelector('.live-match-content');
        if (liveMatchModal && goal.scorer) {
          celebrateGoal(liveMatchModal, goal.scorer, goal.team === 'A' ? LIVE_MATCH_STATE.teamA.name : LIVE_MATCH_STATE.teamB.name);
        }
      }

      // Update momentum system
      if (typeof MOMENTUM_SYSTEM !== 'undefined') {
        MOMENTUM_SYSTEM.updateMomentum('goal', goal.team);
        const momentumDisplay = document.getElementById('momentumDisplay');
        if (momentumDisplay) {
          momentumDisplay.innerHTML = MOMENTUM_SYSTEM.getVisualMomentum(LIVE_MATCH_STATE.teamA, LIVE_MATCH_STATE.teamB);
        }
      }
    });

    // Half time
    if (LIVE_MATCH_STATE.currentMinute === 45) {
      const halftimeCommentary = generateContextualCommentary('halftime', {
        scoreA: LIVE_MATCH_STATE.scoreA,
        scoreB: LIVE_MATCH_STATE.scoreB,
        teamA: LIVE_MATCH_STATE.teamA.name,
        teamB: LIVE_MATCH_STATE.teamB.name
      });
      addCommentaryEvent(`⏸️ ${halftimeCommentary}`, 'info');
    }

    // Random cards (5% chance per minute after minute 10)
    if (LIVE_MATCH_STATE.currentMinute > 10 && Math.random() < 0.05) {
      const team = Math.random() < 0.5 ? LIVE_MATCH_STATE.teamA : LIVE_MATCH_STATE.teamB;
      const cardType = Math.random() < 0.9 ? 'yellow' : 'red';

      // Generate random player name from team
      const playerName = `Player ${Math.floor(Math.random() * 11) + 1}`;

      const cardCommentary = getCommentaryForCard(cardType, playerName, team.name, LIVE_MATCH_STATE.currentMinute);

      addCommentaryEvent(
        `${cardType === 'yellow' ? '🟨' : '🟥'} ${LIVE_MATCH_STATE.currentMinute}' ${cardCommentary}`,
        'card'
      );

      // Update momentum for cards
      if (typeof MOMENTUM_SYSTEM !== 'undefined') {
        const teamSide = team === LIVE_MATCH_STATE.teamA ? 'A' : 'B';
        MOMENTUM_SYSTEM.updateMomentum(cardType === 'yellow' ? 'yellowCard' : 'redCard', teamSide);
        const momentumDisplay = document.getElementById('momentumDisplay');
        if (momentumDisplay) {
          momentumDisplay.innerHTML = MOMENTUM_SYSTEM.getVisualMomentum(LIVE_MATCH_STATE.teamA, LIVE_MATCH_STATE.teamB);
        }
      }
    }

    // Dynamic match moments (3% chance per minute)
    if (LIVE_MATCH_STATE.currentMinute > 5 && Math.random() < 0.03) {
      const scoreDiff = LIVE_MATCH_STATE.scoreA - LIVE_MATCH_STATE.scoreB;
      let momentType;
      let team;

      // Context-aware moment selection
      if (scoreDiff > 0) {
        // Team A winning - Team B likely pressuring
        momentType = Math.random() < 0.6 ? 'pressure' : 'defend';
        team = momentType === 'pressure' ? LIVE_MATCH_STATE.teamB.name : LIVE_MATCH_STATE.teamA.name;
      } else if (scoreDiff < 0) {
        // Team B winning - Team A likely pressuring
        momentType = Math.random() < 0.6 ? 'pressure' : 'defend';
        team = momentType === 'pressure' ? LIVE_MATCH_STATE.teamA.name : LIVE_MATCH_STATE.teamB.name;
      } else {
        // Even game - possession-based
        momentType = 'possession';
        team = Math.random() < 0.5 ? LIVE_MATCH_STATE.teamA.name : LIVE_MATCH_STATE.teamB.name;
      }

      const templates = COMMENTARY_TEMPLATES.moments[momentType];
      const template = templates[Math.floor(Math.random() * templates.length)];
      const commentary = template.replace(/{team}/g, team);

      addCommentaryEvent(`💬 ${commentary}`, 'info');
    }

    // Full time
    if (LIVE_MATCH_STATE.currentMinute >= 90) {
      clearInterval(LIVE_MATCH_STATE.interval);

      const fulltimeCommentary = generateContextualCommentary('fulltime', {
        scoreA: LIVE_MATCH_STATE.scoreA,
        scoreB: LIVE_MATCH_STATE.scoreB,
        teamA: LIVE_MATCH_STATE.teamA.name,
        teamB: LIVE_MATCH_STATE.teamB.name
      });

      addCommentaryEvent(`🏁 ${fulltimeCommentary}`, 'info');
      setTimeout(showLiveFinalResult, 2000);
    }
  }, 200); // 200ms per minute = 18 seconds per match
}

function updateMatchClock(minute) {
  const clockEl = document.getElementById('liveMatchClock');
  if (clockEl) clockEl.textContent = `${minute}'`;
}

function updateLiveScore(scoreA, scoreB) {
  const scoreAEl = document.getElementById('liveScoreA');
  const scoreBEl = document.getElementById('liveScoreB');
  if (scoreAEl) scoreAEl.textContent = scoreA;
  if (scoreBEl) scoreBEl.textContent = scoreB;
}

function addCommentaryEvent(text, type = 'default') {
  const feed = document.getElementById('liveCommentaryFeed');
  if (!feed) return;

  const event = document.createElement('div');
  const bgColor = type === 'goal' ? 'rgba(16, 185, 129, 0.1)' :
                   type === 'card' ? 'rgba(251, 191, 36, 0.1)' :
                   type === 'info' ? 'rgba(59, 130, 246, 0.1)' : 'transparent';
  const borderColor = type === 'goal' ? '#10b981' :
                      type === 'card' ? '#fbbf24' :
                      type === 'info' ? '#3b82f6' : 'rgba(71, 85, 105, 0.3)';

  event.style.cssText = `
    padding: 10px;
    background: ${bgColor};
    border-left: 3px solid ${borderColor};
    border-radius: 6px;
    color: #e5e7eb;
    font-size: 0.9em;
    animation: liveCommentarySlideIn 0.3s ease-out;
  `;
  event.textContent = text;

  feed.insertBefore(event, feed.firstChild);
}

function playGoalAnimation() {
  const scoreAEl = document.getElementById('liveScoreA');
  const scoreBEl = document.getElementById('liveScoreB');

  [scoreAEl, scoreBEl].forEach(el => {
    if (el) {
      el.style.animation = 'goalPulse 0.5s ease-out';
      setTimeout(() => el.style.animation = '', 500);
    }
  });

  // Haptic feedback on mobile
  if (navigator.vibrate) {
    navigator.vibrate([50, 100, 50]);
  }
}

function skipToEnd() {
  if (!LIVE_MATCH_STATE) return;
  if (LIVE_MATCH_STATE.interval) {
    clearInterval(LIVE_MATCH_STATE.interval);
  }
  LIVE_MATCH_STATE.currentMinute = 90;

  // Add all remaining goals instantly
  LIVE_MATCH_STATE.goalTimes.forEach(goal => {
    if (goal.minute > LIVE_MATCH_STATE.currentMinute - 1) {
      if (goal.team === 'A') LIVE_MATCH_STATE.scoreA++;
      else LIVE_MATCH_STATE.scoreB++;
    }
  });

  updateLiveScore(LIVE_MATCH_STATE.scoreA, LIVE_MATCH_STATE.scoreB);
  showLiveFinalResult();
}

function showLiveFinalResult() {
  if (!LIVE_MATCH_STATE) return;

  const winner = LIVE_MATCH_STATE.scoreA > LIVE_MATCH_STATE.scoreB ? LIVE_MATCH_STATE.teamA.name :
                 LIVE_MATCH_STATE.scoreB > LIVE_MATCH_STATE.scoreA ? LIVE_MATCH_STATE.teamB.name :
                 'Draw';

  addCommentaryEvent(`🏆 Final Score: ${LIVE_MATCH_STATE.teamA.name} ${LIVE_MATCH_STATE.scoreA}-${LIVE_MATCH_STATE.scoreB} ${LIVE_MATCH_STATE.teamB.name}`, 'info');

  if (winner !== 'Draw') {
    addCommentaryEvent(`👑 ${winner} wins!`, 'goal');
  }

  // Generate and display match summary
  setTimeout(() => {
    const matchSummary = generateAIMatchSummary({
      teamA: LIVE_MATCH_STATE.teamA.name,
      teamB: LIVE_MATCH_STATE.teamB.name,
      scoreA: LIVE_MATCH_STATE.scoreA,
      scoreB: LIVE_MATCH_STATE.scoreB,
      formationA: LIVE_MATCH_STATE.teamA.formation || '4-4-2',
      formationB: LIVE_MATCH_STATE.teamB.formation || '4-4-2',
      tacticalAdvantage: { advantagePercent: 0 } // Could be enhanced with actual tactical data
    });

    addCommentaryEvent(`📝 ${matchSummary}`, 'info');

    // Add share button after summary
    setTimeout(() => {
      addCommentaryEvent(
        `📤 <span style="color: #10b981; cursor: pointer; text-decoration: underline;" onclick="shareLiveMatchResult()">Share this match</span>`,
        'info'
      );
    }, 500);
  }, 1000);
}

function shareLiveMatchResult() {
  if (!LIVE_MATCH_STATE) return;

  const matchData = {
    teamA: LIVE_MATCH_STATE.teamA.name,
    teamB: LIVE_MATCH_STATE.teamB.name,
    scoreA: LIVE_MATCH_STATE.scoreA,
    scoreB: LIVE_MATCH_STATE.scoreB,
    formationA: LIVE_MATCH_STATE.teamA.formation || '4-4-2',
    formationB: LIVE_MATCH_STATE.teamB.formation || '4-4-2'
  };

  shareMatch(matchData);
}

function closeLiveMatch() {
  if (LIVE_MATCH_STATE && LIVE_MATCH_STATE.interval) {
    clearInterval(LIVE_MATCH_STATE.interval);
  }
  LIVE_MATCH_STATE = null;

  const modal = document.querySelector('.live-match-modal');
  if (modal) modal.remove();
}

/************* PLAYER CARD SYSTEM *************/

/**
 * Calculate FIFA-style pace attribute
 */
function calculatePace(player) {
  const base = player.quality || 75;
  const modifier = player.pos === 'FW' ? 5 : player.pos === 'DF' ? -5 : 0;
  return Math.max(50, Math.min(99, Math.round(base + modifier + (Math.random() * 10 - 5))));
}

/**
 * Calculate shooting attribute
 */
function calculateShooting(player) {
  const base = player.quality || 75;
  const modifier = player.pos === 'FW' ? 10 : player.pos === 'DF' ? -10 : player.pos === 'MF' ? 0 : -15;
  return Math.max(50, Math.min(99, Math.round(base + modifier)));
}

/**
 * Calculate passing attribute
 */
function calculatePassing(player) {
  const base = player.quality || 75;
  const modifier = player.pos === 'MF' ? 8 : player.pos === 'DF' ? 3 : 0;
  return Math.max(50, Math.min(99, Math.round(base + modifier)));
}

/**
 * Calculate dribbling attribute
 */
function calculateDribbling(player) {
  const base = player.quality || 75;
  const modifier = player.pos === 'FW' ? 8 : player.pos === 'MF' ? 5 : player.pos === 'DF' ? -8 : -10;
  return Math.max(50, Math.min(99, Math.round(base + modifier)));
}

/**
 * Calculate defense attribute
 */
function calculateDefense(player) {
  const base = player.quality || 75;
  const modifier = player.pos === 'DF' ? 15 : player.pos === 'MF' ? -5 : player.pos === 'FW' ? -15 : 0;
  return Math.max(50, Math.min(99, Math.round(base + modifier)));
}

/**
 * Calculate physical attribute
 */
function calculatePhysical(player) {
  const base = player.quality || 75;
  return Math.max(50, Math.min(99, Math.round(base + (Math.random() * 10 - 5))));
}

/**
 * Get player rarity based on quality
 */
function getPlayerRarity(quality) {
  if (quality >= 95) return { class: 'legendary', name: 'Legendary', color: '#fbbf24', glow: '#f59e0b' };
  if (quality >= 90) return { class: 'epic', name: 'Epic', color: '#a855f7', glow: '#9333ea' };
  if (quality >= 85) return { class: 'rare', name: 'Rare', color: '#3b82f6', glow: '#2563eb' };
  if (quality >= 80) return { class: 'uncommon', name: 'Uncommon', color: '#10b981', glow: '#059669' };
  return { class: 'common', name: 'Common', color: '#6b7280', glow: '#4b5563' };
}

/**
 * Get human-readable form text
 */
function getFormText(form) {
  if (!form) return 'Average';
  if (form.current >= 2) return 'On Fire!';
  if (form.current >= 1) return 'Hot Form';
  if (form.current === 0) return 'Steady';
  if (form.current <= -2) return 'Ice Cold';
  return 'Poor Form';
}

/**
 * Render stat bar for player attributes
 */
function renderStatBar(label, value) {
  const percentage = Math.min(100, value);
  return `
    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
      <div style="color: #94a3b8; font-size: 0.75em; width: 35px; font-weight: 600;">${label}</div>
      <div style="flex: 1; height: 6px; background: rgba(71, 85, 105, 0.3); border-radius: 3px; overflow: hidden;">
        <div style="height: 100%; background: linear-gradient(90deg, #10b981, #3b82f6); width: ${percentage}%; transition: width 0.3s;"></div>
      </div>
      <div style="color: #e5e7eb; font-size: 0.75em; width: 25px; text-align: right; font-weight: 600;">${Math.round(value)}</div>
    </div>
  `;
}

/**
 * Show player card modal
 */
function showPlayerCard(playerKey) {
  const player = PLAYER_DB[playerKey];
  if (!player) {
    showUtilityMessage("Player not found", "error");
    return;
  }

  const rarity = getPlayerRarity(player.quality || 75);
  const stats = player.stats || {};

  const modal = document.createElement('div');
  modal.className = 'modal-backdrop player-card-modal';
  modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); z-index: 10000; display: flex; align-items: center; justify-content: center;';
  modal.onclick = () => modal.remove();

  modal.innerHTML = `
    <div class="player-card ${rarity.class}" style="max-width: 380px; width: 90%; background: linear-gradient(135deg, #1e293b, #0f172a); border-radius: 20px; border: 3px solid ${rarity.color}; box-shadow: 0 0 30px ${rarity.glow}, 0 10px 40px rgba(0,0,0,0.5); overflow: hidden; animation: cardEntry 0.4s ease-out;" onclick="event.stopPropagation()">
      <div style="background: linear-gradient(135deg, ${rarity.color}, ${rarity.glow}); padding: 20px; position: relative; overflow: hidden;">
        <div style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.3); padding: 8px 14px; border-radius: 8px; font-size: 1.5em; font-weight: 700; color: white;">
          ${player.quality || 75}
        </div>
        <div style="position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.3); padding: 6px 12px; border-radius: 8px; font-size: 0.9em; font-weight: 600; color: white;">
          ${player.pos}
        </div>
        <div style="margin-top: 50px; color: white; text-align: center;">
          <div style="font-size: 1.4em; font-weight: 700; text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">${player.name}</div>
          <div style="font-size: 0.9em; margin-top: 4px; opacity: 0.9;">${player.team}</div>
          <div style="font-size: 0.75em; margin-top: 8px; background: rgba(0,0,0,0.2); display: inline-block; padding: 4px 12px; border-radius: 12px;">${rarity.name}</div>
        </div>
      </div>
      <div style="padding: 20px;">
        <div style="margin-bottom: 20px;">
          <div style="color: #94a3b8; font-size: 0.8em; margin-bottom: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px;">Attributes</div>
          ${renderStatBar('PAC', calculatePace(player))}
          ${renderStatBar('SHO', calculateShooting(player))}
          ${renderStatBar('PAS', calculatePassing(player))}
          ${renderStatBar('DRI', calculateDribbling(player))}
          ${renderStatBar('DEF', calculateDefense(player))}
          ${renderStatBar('PHY', calculatePhysical(player))}
        </div>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 15px;">
          <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); padding: 12px; border-radius: 8px; text-align: center;">
            <div style="font-size: 1.5em; font-weight: 700; color: #10b981;">⚽</div>
            <div style="color: #94a3b8; font-size: 0.75em; margin-top: 4px;">Goals</div>
            <div style="color: #e5e7eb; font-weight: 600; margin-top: 2px;">${stats.goals || 0}</div>
          </div>
          <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); padding: 12px; border-radius: 8px; text-align: center;">
            <div style="font-size: 1.5em; font-weight: 700; color: #3b82f6;">🎯</div>
            <div style="color: #94a3b8; font-size: 0.75em; margin-top: 4px;">Assists</div>
            <div style="color: #e5e7eb; font-weight: 600; margin-top: 2px;">${stats.assists || 0}</div>
          </div>
          <div style="background: rgba(251, 191, 36, 0.1); border: 1px solid rgba(251, 191, 36, 0.3); padding: 12px; border-radius: 8px; text-align: center;">
            <div style="font-size: 1.5em; font-weight: 700; color: #fbbf24;">⭐</div>
            <div style="color: #94a3b8; font-size: 0.75em; margin-top: 4px;">Rating</div>
            <div style="color: #e5e7eb; font-weight: 600; margin-top: 2px;">${stats.avgRating?.toFixed(1) || 'N/A'}</div>
          </div>
        </div>
        <div style="background: rgba(71, 85, 105, 0.2); padding: 12px; border-radius: 8px; text-align: center; margin-bottom: 15px;">
          <span style="font-size: 1.2em;">${player.form?.indicator || '➡️'}</span>
          <span style="color: #e5e7eb; font-weight: 600; margin-left: 8px;">${getFormText(player.form)}</span>
        </div>
        <div style="display: flex; gap: 10px;">
          <button onclick="addToFavorites('${playerKey}')" style="flex: 1; background: linear-gradient(135deg, #fbbf24, #f59e0b); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 6px;">
            ⭐ Favorite
          </button>
          <button onclick="closePlayerCard()" style="background: #475569; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;">
            ✕
          </button>
        </div>
      </div>
    </div>
  `;

  document.body.appendChild(modal);
}

function closePlayerCard() {
  const modal = document.querySelector('.player-card-modal');
  if (modal) modal.remove();
}

function addToFavorites(playerKey) {
  try {
    let favorites = JSON.parse(localStorage.getItem('favoritePlayers') || '[]');
    if (!favorites.includes(playerKey)) {
      favorites.push(playerKey);
      localStorage.setItem('favoritePlayers', JSON.stringify(favorites));
      showUtilityMessage("⭐ Added to favorites!", "success");
    } else {
      showUtilityMessage("Already in favorites", "info");
    }
  } catch (e) {
    console.error('Error adding to favorites:', e);
  }
}

/**
 * Replay a saved match and show comparison modal
 */
function replaySavedMatch(matchId) {
  const original = MATCH_DETAILS_DB[matchId];
  const replay = replayMatch(matchId);

  if (!replay) {
    showUtilityMessage("❌ Replay failed - match data not found", "error");
    return;
  }

  showReplayComparisonModal(original, replay);
}

/**
 * Display replay comparison modal
 */
function showReplayComparisonModal(original, replay) {
  const modal = document.createElement('div');
  modal.className = 'modal-backdrop';
  modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;';

  modal.innerHTML = `
    <div class="modal replay-comparison-modal" style="max-width: 900px; width: 90%; background: #1e293b; border-radius: 16px; max-height: 90vh; overflow-y: auto;" onclick="event.stopPropagation()">
      <div style="padding: 20px; border-bottom: 1px solid rgba(71, 85, 105, 0.3); display: flex; justify-content: space-between; align-items: center;">
        <h2 style="margin: 0; color: #e5e7eb;">⏮️ Match Replay</h2>
        <button onclick="this.closest('.modal-backdrop').remove()" style="background: none; border: none; color: #94a3b8; font-size: 1.5em; cursor: pointer;">×</button>
      </div>

      <div style="padding: 20px;">
        <div style="text-align: center; margin-bottom: 20px;">
          <h3 style="color: #94a3b8; font-size: 0.9em; margin: 0;">${original.teamA} vs ${original.teamB}</h3>
          <p style="color: #64748b; font-size: 0.8em; margin: 5px 0 0 0;">${new Date(original.timestamp).toLocaleString()}</p>
        </div>

        <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 20px;">
          <div style="background: rgba(59, 130, 246, 0.1); padding: 20px; border-radius: 12px; border: 2px solid #3b82f6;">
            <h3 style="text-align: center; color: #3b82f6; margin: 0 0 15px 0;">📜 Original</h3>
            <div style="text-align: center; font-size: 2.5em; font-weight: bold; color: #e5e7eb; margin-bottom: 10px;">
              ${original.scoreA} - ${original.scoreB}
            </div>
          </div>

          <div style="display: flex; align-items: center; font-size: 2em; color: #64748b;">VS</div>

          <div style="background: rgba(16, 185, 129, 0.1); padding: 20px; border-radius: 12px; border: 2px solid #10b981;">
            <h3 style="text-align: center; color: #10b981; margin: 0 0 15px 0;">🔄 Replay</h3>
            <div style="text-align: center; font-size: 2.5em; font-weight: bold; color: #e5e7eb; margin-bottom: 10px;">
              ${replay.scoreA} - ${replay.scoreB}
            </div>
          </div>
        </div>

        <div style="margin-top: 20px; padding: 15px; background: rgba(168, 85, 247, 0.1); border-radius: 8px; border: 1px solid #a855f7; text-align: center;">
          <p style="color: #a855f7; font-size: 0.9em; margin: 0;">
            ${original.scoreA === replay.scoreA && original.scoreB === replay.scoreB ? '✓ Identical scores - perfect deterministic replay' : '⚠️ Scores differ - check RNG implementation'}
          </p>
        </div>

        <div style="margin-top: 20px; padding: 15px; background: rgba(0, 0, 0, 0.2); border-radius: 8px;">
          <h4 style="color: #94a3b8; margin: 0 0 10px 0;">🎲 What-If Scenario</h4>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div>
              <label style="color: #94a3b8; font-size: 0.85em; display: block; margin-bottom: 5px;">${original.teamA} Strength</label>
              <input type="range" id="whatIfStrengthA" min="70" max="100" value="${original.teamAObj?.strength || 80}" style="width: 100%;">
              <span id="strengthAValue" style="color: #e5e7eb;">${original.teamAObj?.strength || 80}</span>
            </div>
            <div>
              <label style="color: #94a3b8; font-size: 0.85em; display: block; margin-bottom: 5px;">${original.teamB} Strength</label>
              <input type="range" id="whatIfStrengthB" min="70" max="100" value="${original.teamBObj?.strength || 80}" style="width: 100%;">
              <span id="strengthBValue" style="color: #e5e7eb;">${original.teamBObj?.strength || 80}</span>
            </div>
          </div>
          <button onclick="runWhatIfScenario('${original.matchId}')" style="width: 100%; padding: 12px; background: #a855f7; border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer;">
            🔮 Run What-If
          </button>
        </div>
      </div>

      <div style="padding: 15px 20px; border-top: 1px solid rgba(71, 85, 105, 0.3); display: flex; gap: 10px; justify-content: flex-end;">
        <button onclick="this.closest('.modal-backdrop').remove()" style="padding: 10px 20px; background: rgba(71, 85, 105, 0.3); border: none; border-radius: 8px; color: #e5e7eb; cursor: pointer;">Close</button>
        <button onclick="shareReplay('${original.matchId}')" style="padding: 10px 20px; background: #3b82f6; border: none; border-radius: 8px; color: white; cursor: pointer;">📤 Share</button>
      </div>
    </div>
  `;

  document.body.appendChild(modal);

  setTimeout(() => {
    const sliderA = document.getElementById('whatIfStrengthA');
    const sliderB = document.getElementById('whatIfStrengthB');
    if (sliderA) sliderA.oninput = (e) => document.getElementById('strengthAValue').textContent = e.target.value;
    if (sliderB) sliderB.oninput = (e) => document.getElementById('strengthBValue').textContent = e.target.value;
  }, 100);

  modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
}

function runWhatIfScenario(matchId) {
  const strengthA = parseInt(document.getElementById('whatIfStrengthA').value);
  const strengthB = parseInt(document.getElementById('whatIfStrengthB').value);

  const result = compareMatches(matchId, { teamAStrength: strengthA, teamBStrength: strengthB });
  if (!result) return showUtilityMessage('❌ What-If failed', 'error');

  const modal = document.querySelector('.replay-comparison-modal');
  const existing = modal?.querySelector('.whatif-result');
  if (existing) existing.remove();

  const section = document.createElement('div');
  section.className = 'whatif-result';
  section.style.cssText = 'margin-top: 20px; padding: 20px; background: rgba(168, 85, 247, 0.15); border-radius: 12px; border: 2px solid #a855f7; text-align: center;';
  section.innerHTML = `
    <h3 style="color: #a855f7; margin: 0 0 15px 0;">🔮 What-If Result</h3>
    <div style="font-size: 2em; font-weight: bold; color: #e5e7eb; margin-bottom: 10px;">
      ${result.whatIf.scoreA} - ${result.whatIf.scoreB}
    </div>
    <p style="color: #d1d5db; font-size: 0.9em; margin: 0;">
      ${result.whatIf.teamA} (${strengthA}) vs ${result.whatIf.teamB} (${strengthB})
    </p>
  `;

  modal?.querySelector('[style*="padding: 20px"]').appendChild(section);
  section.scrollIntoView({ behavior: 'smooth' });
}

function shareReplay(matchId) {
  const match = MATCH_DETAILS_DB[matchId];
  if (!match) return;

  const text = `⚽ Match Replay\n${match.teamA} vs ${match.teamB}\nScore: ${match.scoreA}-${match.scoreB}\nSeed: ${match.seed}`;

  navigator.clipboard.writeText(text).then(
    () => showUtilityMessage('✅ Copied to clipboard!', 'success'),
    () => showUtilityMessage('❌ Copy failed', 'error')
  );
}

/************* PLAYER FORM SYSTEM *************/

/**
 * Update player form based on match rating
 * @param {string} playerKey - Player identifier in PLAYER_DB
 * @param {number} matchRating - Rating from the match (5.0-10.0)
 */
function updatePlayerForm(playerKey, matchRating) {
  const player = PLAYER_DB[playerKey];
  if (!player || !player.form) return;

  // Add rating to recent matches (keep last 3)
  player.form.recentMatches.push(matchRating);
  if (player.form.recentMatches.length > 3) {
    player.form.recentMatches.shift();
  }

  // Calculate form based on recent performance
  if (player.form.recentMatches.length >= 2) {
    const avgRecent = player.form.recentMatches.reduce((a, b) => a + b, 0) / player.form.recentMatches.length;

    // Form scale: -2 (cold) to +2 (hot)
    if (avgRecent >= 8.5) {
      player.form.current = 2;
      player.form.indicator = '🔥';
    } else if (avgRecent >= 7.5) {
      player.form.current = 1;
      player.form.indicator = '🔥';
    } else if (avgRecent >= 6.5) {
      player.form.current = 0;
      player.form.indicator = '➡️';
    } else if (avgRecent >= 5.5) {
      player.form.current = -1;
      player.form.indicator = '❄️';
    } else {
      player.form.current = -2;
      player.form.indicator = '❄️';
    }
  }
}

/**
 * Get form modifier for rating calculation
 * @param {string} playerKey - Player identifier in PLAYER_DB
 * @returns {number} - Modifier value (-0.6 to +0.6)
 */
function getPlayerFormModifier(playerKey) {
  const player = PLAYER_DB[playerKey];
  if (!player || !player.form) return 0;

  // Each form level adds ±0.3 rating points
  return player.form.current * 0.3;
}

/************* INJURY & SUSPENSION SYSTEM *************/

/**
 * Initialize player medical status
 * @param {string} playerKey - Player identifier in PLAYER_DB
 */
function initializePlayerMedicalStatus(playerKey) {
  const player = PLAYER_DB[playerKey];
  if (!player) return;

  if (!player.medical) {
    player.medical = {
      isInjured: false,
      injuryType: null,
      matchesOut: 0,
      isSuspended: false,
      yellowCards: 0,
      redCard: false,
      suspensionMatches: 0,
      injuryHistory: []
    };
  }
}

/**
 * Check for injury during match
 * @param {string} playerKey - Player identifier
 * @param {number} intensity - Match intensity (0-1)
 * @returns {object|null} - Injury details if occurred
 */
function checkForInjury(playerKey, intensity = 0.7) {
  const player = PLAYER_DB[playerKey];
  if (!player) return null;

  if (!player.medical) {
    initializePlayerMedicalStatus(playerKey);
  }

  const difficulty = getCurrentDifficulty();
  const injuryRate = difficulty.injuryRate || 0;

  if (injuryRate === 0 || !player.medical || player.medical.isInjured) return null;

  // Injury probability factors
  const baseChance = injuryRate * intensity;
  const roll = Math.random();

  if (roll < baseChance) {
    const injuryTypes = [
      { type: 'Hamstring Strain', matches: 2, icon: '🦵' },
      { type: 'Ankle Sprain', matches: 1, icon: '🦶' },
      { type: 'Muscle Fatigue', matches: 1, icon: '💪' },
      { type: 'Knee Injury', matches: 3, icon: '🦵' },
      { type: 'Groin Strain', matches: 2, icon: '💪' },
      { type: 'Shoulder Injury', matches: 2, icon: '💪' },
      { type: 'Concussion', matches: 2, icon: '🤕' }
    ];

    const injury = injuryTypes[Math.floor(Math.random() * injuryTypes.length)];

    player.medical.isInjured = true;
    player.medical.injuryType = injury.type;
    player.medical.matchesOut = injury.matches;
    player.medical.injuryIcon = injury.icon;

    player.medical.injuryHistory.push({
      type: injury.type,
      date: new Date().toISOString(),
      matchesOut: injury.matches
    });

    return {
      playerName: player.name,
      injuryType: injury.type,
      matchesOut: injury.matches,
      icon: injury.icon
    };
  }

  return null;
}

/**
 * Check for yellow/red cards during match
 * @param {string} playerKey - Player identifier
 * @param {string} position - Player position
 * @returns {object|null} - Card details if issued
 */
function checkForCards(playerKey, position) {
  const player = PLAYER_DB[playerKey];
  if (!player) return null;

  if (!player.medical) {
    initializePlayerMedicalStatus(playerKey);
  }

  if (!player.medical || player.medical.isSuspended) return null;

  // Defenders and midfielders more likely to get cards
  const positionMultiplier = {
    'GK': 0.3,
    'DF': 1.5,
    'MF': 1.2,
    'FW': 0.8
  };

  const multiplier = positionMultiplier[position] || 1.0;
  const yellowChance = 0.08 * multiplier; // 8% base chance
  const redChance = 0.01 * multiplier;    // 1% base chance

  const roll = Math.random();

  // Red card (direct)
  if (roll < redChance) {
    player.medical.redCard = true;
    player.medical.isSuspended = true;
    player.medical.suspensionMatches = 3; // 3 match ban for red card

    return {
      playerName: player.name,
      cardType: 'red',
      icon: '🟥',
      suspensionMatches: 3
    };
  }

  // Yellow card
  if (roll < yellowChance) {
    player.medical.yellowCards += 1;

    // 2 yellows = suspension
    if (player.medical.yellowCards >= 2) {
      player.medical.isSuspended = true;
      player.medical.suspensionMatches = 1;
      player.medical.yellowCards = 0; // Reset after suspension

      return {
        playerName: player.name,
        cardType: 'double-yellow',
        icon: '🟨🟨',
        suspensionMatches: 1
      };
    }

    return {
      playerName: player.name,
      cardType: 'yellow',
      icon: '🟨',
      suspensionMatches: 0
    };
  }

  return null;
}

/**
 * Update player statuses after each match
 * Reduces injury/suspension timers
 */
function updatePlayerMedicalStatuses() {
  if (!window.PLAYER_DB) return;

  Object.keys(PLAYER_DB).forEach(playerKey => {
    const player = PLAYER_DB[playerKey];
    if (!player.medical) return;

    // Update injury status
    if (player.medical.isInjured && player.medical.matchesOut > 0) {
      player.medical.matchesOut -= 1;

      if (player.medical.matchesOut === 0) {
        player.medical.isInjured = false;
        player.medical.injuryType = null;
        player.medical.injuryIcon = null;
      }
    }

    // Update suspension status
    if (player.medical.isSuspended && player.medical.suspensionMatches > 0) {
      player.medical.suspensionMatches -= 1;

      if (player.medical.suspensionMatches === 0) {
        player.medical.isSuspended = false;
        player.medical.redCard = false;
      }
    }
  });
}

/**
 * Check if player is available for selection
 * @param {string} playerKey - Player identifier
 * @returns {object} - Availability status
 */
function isPlayerAvailable(playerKey) {
  const player = PLAYER_DB[playerKey];
  if (!player) return { available: false, reason: 'Player not found' };

  if (!player.medical) {
    initializePlayerMedicalStatus(playerKey);
    return { available: true, reason: null };
  }

  if (player.medical.isInjured) {
    return {
      available: false,
      reason: `Injured (${player.medical.injuryType})`,
      icon: player.medical.injuryIcon || '🤕',
      matchesOut: player.medical.matchesOut
    };
  }

  if (player.medical.isSuspended) {
    return {
      available: false,
      reason: player.medical.redCard ? 'Suspended (Red Card)' : 'Suspended (Yellow Cards)',
      icon: player.medical.redCard ? '🟥' : '🟨🟨',
      matchesOut: player.medical.suspensionMatches
    };
  }

  return { available: true, reason: null };
}

/**
 * Display Medical Room UI
 */
function showMedicalRoom() {
  const out = document.getElementById('output');

  if (!window.PLAYER_DB) {
    out.innerHTML = '<p style="color: #94a3b8; text-align: center; padding: 40px;">No player data available. Start a tournament first.</p>';
    return;
  }

  // Collect injured and suspended players
  const injured = [];
  const suspended = [];

  Object.entries(PLAYER_DB).forEach(([key, player]) => {
    if (!player.medical) return;

    if (player.medical.isInjured) {
      injured.push({
        key,
        name: player.name,
        team: player.team,
        position: player.position,
        injuryType: player.medical.injuryType,
        icon: player.medical.injuryIcon,
        matchesOut: player.medical.matchesOut
      });
    }

    if (player.medical.isSuspended) {
      suspended.push({
        key,
        name: player.name,
        team: player.team,
        position: player.position,
        reason: player.medical.redCard ? 'Red Card' : 'Yellow Cards',
        icon: player.medical.redCard ? '🟥' : '🟨🟨',
        matchesOut: player.medical.suspensionMatches
      });
    }
  });

  out.innerHTML = `
    <div class="medical-room-view" style="padding: 20px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <h2 style="margin: 0; color: #e5e7eb;">🏥 Medical Room</h2>
        <div style="color: #94a3b8; font-size: 0.9em;">
          <span style="margin-right: 20px;">🤕 Injured: <strong style="color: #ef4444;">${injured.length}</strong></span>
          <span>🟨 Suspended: <strong style="color: #fbbf24;">${suspended.length}</strong></span>
        </div>
      </div>

      <!-- Injured Players Section -->
      <div style="margin-bottom: 40px;">
        <h3 style="color: #f87171; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
          🤕 Injured Players
        </h3>

        ${injured.length === 0 ? `
          <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 8px; padding: 20px; text-align: center; color: #10b981;">
            ✅ No injured players - squad is healthy!
          </div>
        ` : `
          <div style="display: grid; gap: 12px;">
            ${injured.map(p => `
              <div style="background: rgba(30, 41, 59, 0.5); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; padding: 15px; display: flex; justify-content: space-between; align-items: center;">
                <div style="flex: 1;">
                  <div style="color: #e5e7eb; font-weight: 600; margin-bottom: 4px;">
                    ${p.icon} ${p.name}
                  </div>
                  <div style="color: #94a3b8; font-size: 0.85em;">
                    ${p.team} • ${p.position}
                  </div>
                </div>
                <div style="text-align: right;">
                  <div style="color: #f87171; font-weight: 600; margin-bottom: 2px;">
                    ${p.injuryType}
                  </div>
                  <div style="color: #94a3b8; font-size: 0.85em;">
                    ${p.matchesOut} match${p.matchesOut > 1 ? 'es' : ''} out
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        `}
      </div>

      <!-- Suspended Players Section -->
      <div>
        <h3 style="color: #fbbf24; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
          🟨 Suspended Players
        </h3>

        ${suspended.length === 0 ? `
          <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 8px; padding: 20px; text-align: center; color: #10b981;">
            ✅ No suspended players - everyone is available!
          </div>
        ` : `
          <div style="display: grid; gap: 12px;">
            ${suspended.map(p => `
              <div style="background: rgba(30, 41, 59, 0.5); border: 1px solid rgba(251, 191, 36, 0.3); border-radius: 8px; padding: 15px; display: flex; justify-content: space-between; align-items: center;">
                <div style="flex: 1;">
                  <div style="color: #e5e7eb; font-weight: 600; margin-bottom: 4px;">
                    ${p.icon} ${p.name}
                  </div>
                  <div style="color: #94a3b8; font-size: 0.85em;">
                    ${p.team} • ${p.position}
                  </div>
                </div>
                <div style="text-align: right;">
                  <div style="color: #fbbf24; font-weight: 600; margin-bottom: 2px;">
                    ${p.reason}
                  </div>
                  <div style="color: #94a3b8; font-size: 0.85em;">
                    ${p.matchesOut} match${p.matchesOut > 1 ? 'es' : ''} ban
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        `}
      </div>

      <!-- Back Button -->
      <div style="margin-top: 30px; text-align: center;">
        <button onclick="showMainMenu()" style="background: #475569; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 1em;">
          ← Back to Menu
        </button>
      </div>
    </div>
  `;
}

/**
 * Get hot players (form >= 1) for display
 * @param {number} limit - Maximum number of players to return
 * @returns {Array} - Array of hot players with their stats
 */
function getHotPlayers(limit = 5) {
  return Object.entries(PLAYER_DB)
    .filter(([key, player]) => player.form && player.form.current >= 1 && player.apps > 0)
    .sort((a, b) => {
      // Sort by form first, then avgRating
      if (b[1].form.current !== a[1].form.current) {
        return b[1].form.current - a[1].form.current;
      }
      return (b[1].avgRating || 0) - (a[1].avgRating || 0);
    })
    .slice(0, limit)
    .map(([key, player]) => ({
      name: player.name,
      team: player.team,
      pos: player.pos,
      form: player.form.current,
      indicator: player.form.indicator,
      avgRating: player.avgRating,
      apps: player.apps,
      goals: player.goals
    }));
}

/**
 * Fisher-Yates shuffle (non-mutating).
 */
function shuffleArray(arr) {
  if (!arr || !Array.isArray(arr)) {
    console.warn("⚠️ Invalid array provided to shuffleArray");
    return [];
  }

  const newArr = [...arr];
  for (let i = newArr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [newArr[i], newArr[j]] = [newArr[j], newArr[i]];
  }
  return newArr;
}

/**
 * Create four seeded pots of 16 teams each from TEAM_POOL.
 */
function createPots() {
  try {
    if (!Array.isArray(TEAM_POOL) || TEAM_POOL.length < 64) {
      console.error("❌ Not enough teams in TEAM_POOL. Found:", TEAM_POOL ? TEAM_POOL.length : 0);
      if (!Array.isArray(TEAM_POOL) || TEAM_POOL.length === 0) {
        // Hard fail if no teams at all
        return [[], [], [], []];
      }
      console.warn("⚠️ Using available teams (less than 64)");
    }

    // Randomly select 64 teams without shuffling entire array (much faster!)
    const selectedTeams = [];
    const usedIndices = new Set();

    while (selectedTeams.length < 64 && usedIndices.size < TEAM_POOL.length) {
      const randomIndex = Math.floor(Math.random() * TEAM_POOL.length);
      if (!usedIndices.has(randomIndex)) {
        usedIndices.add(randomIndex);
        const team = TEAM_POOL[randomIndex];
        if (validateTeam(team)) {
          selectedTeams.push(team);
        }
      }
    }

    const validTeams = selectedTeams;

    if (validTeams.length < 64) {
      console.warn(`⚠️ Only ${validTeams.length} valid teams available for pot creation`);
    }

    const sorted = validTeams.sort(
      (a, b) => (b.strength || 0) - (a.strength || 0)
    );

    const pot1 = sorted.slice(0, 16);
    const pot2 = sorted.slice(16, 32);
    const pot3 = sorted.slice(32, 48);
    const pot4 = sorted.slice(48, 64);

    if (window.VERBOSE_LOGGING) console.log(
      `🏆 Pots created: Pot1(${pot1.length}), Pot2(${pot2.length}), Pot3(${pot3.length}), Pot4(${pot4.length})`
    );

    return [pot1, pot2, pot3, pot4];
  } catch (error) {
    console.error("❌ Error creating pots:", error);
    return [[], [], [], []];
  }
}

/**
 * Generate 16 groups of 4 teams from pots.
 */
 function generateGroups() {
  try {
    const [pot1, pot2, pot3, pot4] = createPots();

    if (!pot1.length || !pot2.length || !pot3.length || !pot4.length) {
      throw new Error("One or more pots are empty");
    }

    // Shuffle each pot before draw
    const shuffledPot1 = shuffleArray(pot1);
    const shuffledPot2 = shuffleArray(pot2);
    const shuffledPot3 = shuffleArray(pot3);
    const shuffledPot4 = shuffleArray(pot4);

    const groups = [];
    for (let i = 0; i < 16; i++) {
      const team1 = shuffledPot1[i] || { name: `Unknown Team A${i}`, strength: 70 };
      const team2 = shuffledPot2[i] || { name: `Unknown Team B${i}`, strength: 70 };
      const team3 = shuffledPot3[i] || { name: `Unknown Team C${i}`, strength: 70 };
      const team4 = shuffledPot4[i] || { name: `Unknown Team D${i}`, strength: 70 };

      groups.push({
        name: `Group ${String.fromCharCode(65 + i)}`, // A–P
        teams: [team1, team2, team3, team4],
        matches: []
      });
    }

    console.log("✅ Groups generated successfully:", groups.length);
    
    // Store groups globally
    window.GROUPS = groups;
    
    // Also store all drawn teams for custom match feature
    window.DRAWN_TEAMS = [];
    const teamNames = new Set();
    groups.forEach(group => {
      group.teams.forEach(team => {
        if (team && team.name && !teamNames.has(team.name)) {
          teamNames.add(team.name);
          window.DRAWN_TEAMS.push(team);
        }
      });
    });
    
    // RENDER THE GROUPS IMMEDIATELY
    renderGroupDrawResults(groups);

    if (window.VERBOSE_LOGGING) console.log("🔍 [generateGroups] About to update button states...");

    // Update button states
    updateButtonStates();

    if (window.VERBOSE_LOGGING) console.log("🔍 [generateGroups] Button states updated, showing message...");

    // Show success message
    showUtilityMessage('✅ Groups generated successfully!', 'success');

    if (window.VERBOSE_LOGGING) console.log("🔍 [generateGroups] Returning groups...");

    return groups;
    
  } catch (error) {
    console.error("❌ Error generating groups:", error);
    showUtilityMessage('❌ Error generating groups: ' + error.message, 'error');
    
    // Return 16 empty placeholder groups
    return Array.from({ length: 16 }, (_, i) => ({
      name: `Group ${String.fromCharCode(65 + i)}`,
      teams: [],
      matches: []
    }));
  }
}
async function handleGenerateGroups() {
  // Prevent duplicate runs
  if (isGeneratingGroups) {
    console.warn("⚠️ Group generation already running - ignored");
    showUtilityMessage("Group generation already in progress!", "warning");
    return;
  }
  isGeneratingGroups = true;

  try {
    if (window.VERBOSE_LOGGING) console.log("🎲 Generating groups...");

    const groups = generateGroups();

  if (groups && groups.length > 0) {
    // Store globally
    window.GROUPS = groups;

    // Store all teams
    window.DRAWN_TEAMS = [];
    const teamNames = new Set();
    groups.forEach(group => {
      group.teams.forEach(team => {
        if (team && team.name && !teamNames.has(team.name)) {
          teamNames.add(team.name);
          window.DRAWN_TEAMS.push(team);
        }
      });
    });

    // Assign intelligent formations to all teams
    assignFormationsToAllTeams(window.DRAWN_TEAMS);

    // RENDER IMMEDIATELY
    renderGroupDrawResults(groups);

    if (window.VERBOSE_LOGGING) console.log("🔍 About to update button states...");

    // Yield to let the browser render
    await new Promise(resolve => setTimeout(resolve, 0));

    // Update buttons
    updateButtonStates();

    if (window.VERBOSE_LOGGING) console.log("🔍 Button states updated, showing message...");

    showUtilityMessage('✅ Groups generated successfully!', 'success');

    if (window.VERBOSE_LOGGING) console.log("🔍 handleGenerateGroups completed!");
  } else {
    showUtilityMessage('❌ Failed to generate groups', 'error');
  }
  } finally {
    isGeneratingGroups = false;
  }
}
function renderGroupDrawResults(groups) {
  if (window.VERBOSE_LOGGING) console.log("📊 Rendering group draw results:", groups);
  
  const out = document.getElementById('output');
  if (!out) {
    console.error("❌ Output element not found");
    return;
  }

  if (!groups || groups.length === 0) {
    out.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">🏆</div>
        <h2>No Groups Generated</h2>
        <p class="output-sub">Click "Generate Groups" to create the tournament draw.</p>
      </div>
    `;
    return;
  }

  let html = `
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h2>🏆 Tournament Draw</h2>
      <div style="display: flex; gap: 8px;">
        <button onclick="shuffleGroups()" class="btn-secondary" style="padding: 8px 12px;">
          🔄 Shuffle Groups
        </button>
      </div>
    </div>

    <div style="background: rgba(16, 185, 129, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #10b981;">
      <strong style="color: #10b981;">✅ Groups generated successfully!</strong>
      <span style="color: #e2e8f0; margin-left: 10px;">${groups.length} groups created. Click "Simulate Group Stage" to begin.</span>
    </div>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; margin-top: 20px;">
  `;

  groups.forEach(group => {
    html += `
      <div style="background: linear-gradient(135deg, #1e293b, #0f172a); padding: 15px; border-radius: 12px; border: 1px solid #475569;">
        <h3 style="margin: 0 0 15px 0; color: #60a5fa; font-size: 1.2em; text-align: center; padding-bottom: 10px; border-bottom: 2px solid #3b82f6;">
          ${group.name}
        </h3>
        <div style="display: flex; flex-direction: column; gap: 8px;">
    `;

    if (group.teams && group.teams.length > 0) {
      group.teams.forEach((team, index) => {
        const seedColor = index === 0 ? '#10b981' : index === 1 ? '#3b82f6' : index === 2 ? '#f59e0b' : '#64748b';
        
        html += `
          <div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(30, 41, 59, 0.5); border-radius: 6px; border-left: 3px solid ${seedColor};">
            <span style="color: #94a3b8; font-weight: 600; width: 25px; text-align: center;">${index + 1}</span>
            <div style="flex: 1;">
              <div style="color: #e2e8f0; font-weight: 500; font-size: 0.95em;">${team.name || 'Unknown'}</div>
              ${team.season ? `<div style="color: #64748b; font-size: 0.75em;">${team.season}</div>` : ''}
            </div>
            <span style="color: #60a5fa; font-size: 0.9em; font-weight: bold; background: rgba(59, 130, 246, 0.1); padding: 4px 8px; border-radius: 4px;">
              ${team.overall || team.strength || 70}
            </span>
          </div>
        `;
      });
    } else {
      html += `<div style="color: #94a3b8; text-align: center; padding: 20px;">No teams</div>`;
    }

    html += `</div></div>`;
  });

  html += `</div>`;

  // Use requestAnimationFrame to avoid blocking
  requestAnimationFrame(() => {
    out.innerHTML = html;
    console.log("✅ Groups rendered successfully");
  });
}
function renderGroupResults(groupResults) {
  const out = document.getElementById('output');
  if (!out) return;

  if (!groupResults || Object.keys(groupResults).length === 0) {
    out.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">📊</div>
        <h2>No Group Results</h2>
        <p class="output-sub">Simulate the group stage to see results.</p>
      </div>
    `;
    return;
  }

  let html = `
    <div style="max-width: 1400px; margin: 0 auto;">
      <!-- Header with Controls -->
      <div style="background: linear-gradient(135deg, var(--cardBg), rgba(15, 23, 42, 0.9));
                  border: 2px solid var(--cardBorder); border-radius: 16px; padding: 30px;
                  margin-bottom: 30px;">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
          <div>
            <h1 style="color: var(--primary); margin-bottom: 8px; font-size: 2.5em;">
              📋 Group Stage Results
            </h1>
            <p style="color: var(--textSecondary); font-size: 1.1em;">
              ${Object.keys(groupResults).length} groups completed • All matches finished
            </p>
          </div>

          <!-- Action Buttons -->
          <div style="display: flex; gap: 12px; flex-wrap: wrap;">
            <button onclick="showMatchWeeks()" class="btn-secondary"
                    style="padding: 12px 20px; font-weight: 600;">
              📅 Matchdays
            </button>
            <button onclick="showPlayerStats()" class="btn-secondary"
                    style="padding: 12px 20px; font-weight: 600;">
              📈 Statistics
            </button>
            <button onclick="confirmResimulateGroups()" class="btn-warning"
                    style="padding: 12px 20px; font-weight: 600; background: linear-gradient(135deg, #F59E0B, #D97706);">
              🔄 Re-simulate Groups
            </button>
          </div>
        </div>
      </div>

      <!-- Success Message -->
      <div style="background: rgba(16, 185, 129, 0.1); padding: 16px; border-radius: 12px;
                  margin-bottom: 30px; border-left: 4px solid #10b981; display: flex;
                  justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
        <div>
          <strong style="color: #10b981; font-size: 1.1em;">✅ Group stage completed!</strong>
          <span style="color: #e2e8f0; margin-left: 10px;">All groups have finished their matches.</span>
        </div>
        <button onclick="proceedToKnockout()" class="btn-primary"
                style="padding: 12px 24px; font-weight: 600;">
          Continue to Knockout Stage →
        </button>
      </div>

      <!-- Groups Grid -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">
  `;

  Object.entries(groupResults).forEach(([groupName, data]) => {
    if (!data || !data.standings) return;

    html += `
      <div style="background: linear-gradient(135deg, #1e293b, #0f172a); padding: 15px; border-radius: 12px; border: 1px solid #475569;">
        <h3 style="margin: 0 0 15px 0; color: #60a5fa; font-size: 1.1em; text-align: center; padding-bottom: 10px; border-bottom: 2px solid #3b82f6;">
          ${groupName}
        </h3>
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="background: rgba(59, 130, 246, 0.1); font-size: 0.85em; color: #94a3b8;">
              <th style="padding: 8px; text-align: left;">#</th>
              <th style="padding: 8px; text-align: left;">Team</th>
              <th style="padding: 8px; text-align: center;">P</th>
              <th style="padding: 8px; text-align: center;">W</th>
              <th style="padding: 8px; text-align: center;">D</th>
              <th style="padding: 8px; text-align: center;">L</th>
              <th style="padding: 8px; text-align: center;">GD</th>
              <th style="padding: 8px; text-align: center; font-weight: bold;">Pts</th>
            </tr>
          </thead>
          <tbody>
    `;

    data.standings.forEach((team, index) => {
      const isQualified = index < 2;
      const rowColor = isQualified ? 'rgba(16, 185, 129, 0.1)' : 'transparent';
      const borderColor = index === 0 ? '#10b981' : index === 1 ? '#3b82f6' : 'transparent';

      html += `
        <tr style="background: ${rowColor}; border-left: 3px solid ${borderColor};">
          <td style="padding: 10px; color: #94a3b8; font-weight: 600;">${index + 1}</td>
          <td style="padding: 10px; color: #e2e8f0; font-weight: 500;">${team.team}</td>
          <td style="padding: 10px; text-align: center; color: #94a3b8;">${team.played}</td>
          <td style="padding: 10px; text-align: center; color: #10b981;">${team.wins}</td>
          <td style="padding: 10px; text-align: center; color: #f59e0b;">${team.draws}</td>
          <td style="padding: 10px; text-align: center; color: #ef4444;">${team.losses}</td>
          <td style="padding: 10px; text-align: center; color: ${team.goalDifference >= 0 ? '#10b981' : '#ef4444'};">
            ${team.goalDifference >= 0 ? '+' : ''}${team.goalDifference}
          </td>
          <td style="padding: 10px; text-align: center; color: #60a5fa; font-weight: bold; font-size: 1.1em;">
            ${team.points}
          </td>
        </tr>
      `;
    });

    html += `
          </tbody>
        </table>
      </div>
    `;
  });

  html += `
      </div>
    </div>
  `;
  out.innerHTML = html;
}
 function renderGroups(groups) {
  const out = document.getElementById("output");
  if (!out) {
    console.error("❌ Output element not found");
    return;
  }

  const validGroups = (groups || []).filter(
    (group) => group && Array.isArray(group.teams) && group.teams.length > 0
  );

  if (validGroups.length === 0) {
    out.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">⚠️</div>
        <h2>No Groups Generated</h2>
        <p class="output-sub">
          There was an error generating the groups. Please try again.
        </p>
      </div>
    `;
    updateButtonStates();
    return;
  }
  out.innerHTML = `
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
      <h2>🏆 Tournament Draw</h2>
      <button onclick="shuffleGroups()" class="btn-secondary" style="padding: 6px 14px;">
        🔀 Shuffle Groups
      </button>
    </div>
    <p style="margin-bottom:10px;" class="output-sub">
      64 legendary club sides split into 16 groups of four. Top two in each group advance to the Round of 32.
    </p>
    <div style="background: #2d3748; padding: 10px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #3b82f6;">
      ✅ <strong>Groups generated successfully!</strong> ${validGroups.length} groups created.
      Click "Simulate Group Stage" to begin the tournament.
    </div>
    <div class="group-grid" id="groupGrid"></div>
  `};
  function shuffleGroups() {
  if (!window.GROUPS || window.GROUPS.length === 0) {
    showUtilityMessage('No groups to shuffle. Draw groups first.', 'warning');
    return;
  }

  // Check if group stage has been run
  if (window.GROUP_RESULTS && Object.keys(window.GROUP_RESULTS).length > 0) {
    showUtilityMessage('Cannot shuffle - group stage already completed. Reset tournament first.', 'warning');
    return;
  }

  // Collect all teams from current groups
  const allTeams = [];
  window.GROUPS.forEach(group => {
    group.teams.forEach(team => allTeams.push(team));
  });

  // Shuffle the teams array
  for (let i = allTeams.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [allTeams[i], allTeams[j]] = [allTeams[j], allTeams[i]];
  }

  // Redistribute into groups
  const teamsPerGroup = allTeams.length / window.GROUPS.length;
  window.GROUPS.forEach((group, idx) => {
    const start = idx * teamsPerGroup;
    group.teams = allTeams.slice(start, start + teamsPerGroup);
  });

  // Re-render the groups
  renderGroupDrawResults(window.GROUPS);
  showUtilityMessage('✅ Groups shuffled successfully!', 'success');
}
function validateTeam(team) {
  return (
    team &&
    typeof team === "object" &&
    typeof team.name === "string" &&
    typeof team.strength === "number" &&
    Array.isArray(team.startingXI)
  );
}

/**
 * Get team by name from TEAM_MAP.
 */
function getTeamByName(teamName) {
  if (!teamName || !TEAM_MAP) {
    console.warn("⚠️ Invalid team name or TEAM_MAP not initialized:", teamName);
    return null;
  }

  const team = TEAM_MAP.get(teamName);
  if (!team) {
    console.warn(`⚠️ Team not found in TEAM_MAP: ${teamName}`);
  }
  return team;
}
/************* ENHANCED MATCH SIMULATION FUNCTIONS *************/

/**
 * Weighted random player selection based on quality and position.
 * Used for picking scorers/assisters.
 */
 function selectPlayerByWeight(players, isScorer) {
  if (!players || !Array.isArray(players) || players.length === 0) {
    console.warn("⚠️ No players provided to selectPlayerByWeight");
    return { name: "Unknown Player", pos: "Unknown", quality: 70 };
  }

  const weightedPlayers = players.map((player) => {
    if (!player || !player.quality) {
      console.warn("⚠️ Invalid player in selectPlayerByWeight:", player);
      return { player: { name: "Unknown", pos: "Unknown", quality: 70 }, weight: 0.1 };
    }

    let weight = (player.quality || 70) / 100;

    if (isScorer) {
      if (["ST", "CF", "FW"].includes(player.pos)) weight *= 2.5;
      else if (["LW", "RW", "SS"].includes(player.pos)) weight *= 2.0;
      else if (["AM", "CM"].includes(player.pos)) weight *= 1.3;
      else if (["DM", "CB", "RB", "LB"].includes(player.pos)) weight *= 0.3;
      else weight *= 0.1;
    } else {
      if (["AM", "CM", "LW", "RW"].includes(player.pos)) weight *= 1.8;
      else if (["ST", "CF", "FW"].includes(player.pos)) weight *= 1.2;
      else if (["DM"].includes(player.pos)) weight *= 1.0;
      else weight *= 0.5;
    }

    return { player, weight: Math.max(0.01, weight) }; // Ensure minimum weight
  });

  const totalWeight = weightedPlayers.reduce((sum, wp) => sum + wp.weight, 0);

  if (totalWeight <= 0) {
    console.warn("⚠️ Total weight is 0 or negative, using random selection");
    return weightedPlayers[Math.floor(Math.random() * weightedPlayers.length)].player;
  }

  let random = Math.random() * totalWeight;

  for (const wp of weightedPlayers) {
    random -= wp.weight;
    if (random <= 0) {
      return wp.player;
    }
  }

  return weightedPlayers[0].player;
}

/**
 * Base rating for a player in a given match.
 * Can be extended with performance-based bonuses in trackEnhancedPlayerStats.
 */
 function calculateEnhancedPlayerRating(player, teamStrength, performance = {}, matchContext = {}) {
  if (!player || !player.quality) {
    console.warn('⚠️ Invalid player in rating calculation:', player);
    return 6.0;
  }

  const quality = player.quality || 70;
  const position = player.pos || 'MF';
  
  // Base rating from quality (5.0 to 7.5 range)
  let rating = 5.0 + ((quality / 100) * 2.5);
  
  // Team performance context
  const teamPerformance = ((teamStrength || 70) - 70) / 100;
  rating += teamPerformance * 0.3;
  
  // Match result impact
  const isWinner = matchContext.isWinner || false;
  const isDraw = matchContext.isDraw || false;
  const teamScore = matchContext.teamScore || 0;
  const oppScore = matchContext.oppScore || 0;
  
  if (isWinner) {
    rating += 0.4; // Winning bonus
  } else if (isDraw) {
    rating += 0.1; // Small draw bonus
  } else {
    rating -= 0.3; // Losing penalty
  }
  
  // Performance contributions
  if (performance.goals > 0) {
    rating += Math.min(performance.goals * 1.5, 3.0); // Goals are crucial (max +3.0)
  }
  
  if (performance.assists > 0) {
    rating += Math.min(performance.assists * 0.8, 2.0); // Assists are valuable (max +2.0)
  }
  
  // Position-specific adjustments
  const cleanSheet = performance.cleanSheet || false;
  
  if (['GK', 'CB', 'RB', 'LB', 'RWB', 'LWB'].includes(position)) {
    // Defenders and GKs
    if (cleanSheet) {
      rating += 1.2; // Significant clean sheet bonus
    } else if (oppScore >= 3) {
      rating -= 0.8; // Heavy conceding penalty
    } else if (oppScore === 2) {
      rating -= 0.4; // Moderate conceding penalty
    } else if (oppScore === 1) {
      rating -= 0.1; // Light conceding penalty
    }
    
    // GK specific
    if (position === 'GK') {
      rating = Math.max(rating, cleanSheet ? 7.0 : 6.0); // GK floor
    }
  } else if (['CDM', 'CM', 'CAM', 'RM', 'LM'].includes(position)) {
    // Midfielders - balanced
    if (performance.goals === 0 && performance.assists === 0 && !isWinner) {
      rating -= 0.3; // Penalty for no contributions in a loss
    }
  } else if (['ST', 'CF', 'FW', 'LW', 'RW'].includes(position)) {
    // Attackers - goal-dependent
    if (performance.goals === 0) {
      if (isWinner) {
        rating -= 0.2; // Minor penalty if won without scoring
      } else {
        rating -= 0.5; // Bigger penalty if didn't score in loss/draw
      }
    }
  }
  
  // High-scoring game bonus for all
  const totalGoals = teamScore + oppScore;
  if (totalGoals >= 5) {
    rating += 0.3; // Exciting match bonus
  }
  
  // Controlled randomness based on quality
  // Higher quality = more consistent, less variance
  const qualityFactor = quality / 100;
  const maxVariance = 0.7 * (1 - (qualityFactor * 0.6)); // Top players: ±0.28, Average: ±0.49
  const randomness = (Math.random() - 0.5) * 2 * maxVariance;
  rating += randomness;
  
  // Realistic bounds (very rare to see outside 5.0-9.8)
  rating = Math.max(5.0, Math.min(9.8, rating));
  
  // Round to 1 decimal
  return Math.round(rating * 10) / 10;
}

/**
 * Simulate goals for one team, update PLAYER_DB, ALL_TIME_PLAYER_DB and matchEvents.
 */
function simulateTeamGoals(team, numGoals, matchEvents) {
  if (!team || !team.startingXI || !matchEvents) {
    console.warn("⚠️ Invalid parameters in simulateTeamGoals");
    return;
  }

  const fieldPlayers = team.startingXI.filter((p) => p && p.pos !== "GK");

  if (fieldPlayers.length === 0) {
    console.warn("⚠️ No field players available for goal simulation");
    return;
  }

  for (let i = 0; i < numGoals; i++) {
    const scorer = selectPlayerByWeight(fieldPlayers, true);
    if (!scorer || !scorer.name) continue;

    const scorerKey = `${team.name}::${scorer.name}`;

    // Initialize scorer if needed
    if (!PLAYER_DB[scorerKey]) {
      PLAYER_DB[scorerKey] = {
        id: scorerKey,
        name: scorer.name,
        team: team.name,
        pos: scorer.pos || "Unknown",
        quality: scorer.quality || 70,
        apps: 0,
        goals: 0,
        assists: 0,
        playerOfTheGame: 0,
        avgRating: 0,
        totalRating: 0
      };
    }

    let assister = null;
    // 60% chance of an assist when more than one goal
    if (Math.random() > 0.4 && numGoals > 1) {
      const potentialAssisters = fieldPlayers.filter((p) => p && p.name !== scorer.name);
      if (potentialAssisters.length > 0) {
        assister = selectPlayerByWeight(potentialAssisters, false);
      }
    }

    // Update scorer stats
    PLAYER_DB[scorerKey].goals++;
    PLAYER_DB[scorerKey].apps = (PLAYER_DB[scorerKey].apps || 0) + 1;

    // All-time stats
    if (!ALL_TIME_PLAYER_DB[scorerKey]) {
      ALL_TIME_PLAYER_DB[scorerKey] = {
        ...PLAYER_DB[scorerKey],
        totalApps: 0,
        totalGoals: 0,
        totalAssists: 0,
        totalPlayerOfTheGame: 0,
        tournaments: 0
      };
    }
    ALL_TIME_PLAYER_DB[scorerKey].totalGoals++;
    ALL_TIME_PLAYER_DB[scorerKey].totalApps++;

    // Per-match performance stats
    if (matchEvents.playerPerformances[scorerKey]) {
      matchEvents.playerPerformances[scorerKey].goals++;
    }

    if (assister && assister.name) {
      const assisterKey = `${team.name}::${assister.name}`;

      if (!PLAYER_DB[assisterKey]) {
        PLAYER_DB[assisterKey] = {
          id: assisterKey,
          name: assister.name,
          team: team.name,
          pos: assister.pos || "Unknown",
          quality: assister.quality || 70,
          apps: 0,
          goals: 0,
          assists: 0,
          playerOfTheGame: 0,
          avgRating: 0,
          totalRating: 0
        };
      }

      PLAYER_DB[assisterKey].assists++;
      PLAYER_DB[assisterKey].apps = (PLAYER_DB[assisterKey].apps || 0) + 1;

      if (!ALL_TIME_PLAYER_DB[assisterKey]) {
        ALL_TIME_PLAYER_DB[assisterKey] = {
          ...PLAYER_DB[assisterKey],
          totalApps: 0,
          totalGoals: 0,
          totalAssists: 0,
          totalPlayerOfTheGame: 0,
          tournaments: 0
        };
      }
      ALL_TIME_PLAYER_DB[assisterKey].totalAssists++;
      ALL_TIME_PLAYER_DB[assisterKey].totalApps++;

      if (matchEvents.playerPerformances[assisterKey]) {
        matchEvents.playerPerformances[assisterKey].assists++;
      }

      matchEvents.assists.push({
        player: assister.name,
        team: team.name,
        assisted: scorer.name
      });
    }

    // More goals in second half
    let minute;
    if (Math.random() < 0.6) {
      minute = Math.floor(Math.random() * 45) + 46;
    } else {
      minute = Math.floor(Math.random() * 45) + 1;
    }

    matchEvents.goals.push({
      player: scorer.name,
      team: team.name,
      minute,
      assisted: assister ? assister.name : false
    });
  }
}

function trackEnhancedPlayerStats(teamA, teamB, goalsA, goalsB) {
  const matchEvents = {
    goals: [],
    assists: [],
    playerPerformances: {},
    injuries: [],
    cards: []
  };

  const initPerformance = (team) => {
    [...(team.startingXI || []), ...(team.bench || [])].forEach(player => {
      if (!player || !player.name) return;
      const key = `${team.name}::${player.name}`;

      // Initialize medical status if needed
      initializePlayerMedicalStatus(key);

      // Calculate base rating with form modifier
      let baseRating = calculateBaseRating(player, team.strength || 70);
      const formModifier = getPlayerFormModifier(key);
      baseRating += formModifier;

      matchEvents.playerPerformances[key] = {
        player: player.name,
        team: team.name,
        position: player.pos,
        goals: 0,
        assists: 0,
        baseRating: baseRating,
        formModifier: formModifier // Track for display
      };

      // Check for injuries (only for starting XI)
      if (team.startingXI && team.startingXI.includes(player)) {
        const injury = checkForInjury(key, 0.7);
        if (injury) {
          matchEvents.injuries.push(injury);
        }
      }

      // Check for cards (starting XI only)
      if (team.startingXI && team.startingXI.includes(player)) {
        const card = checkForCards(key, player.pos);
        if (card) {
          matchEvents.cards.push(card);
        }
      }
    });
  };

  initPerformance(teamA);
  initPerformance(teamB);

  if (typeof simulateTeamGoals === 'function') {
    simulateTeamGoals(teamA, goalsA, matchEvents);
    simulateTeamGoals(teamB, goalsB, matchEvents);
  }

  return matchEvents;
}
/**
 * Pick Player of the Game based on individual performance + clean sheet + winner bonus.
 */
function determinePlayerOfTheGame(matchEvents, teamA, teamB) {
  if (!matchEvents || !matchEvents.playerPerformances || !teamA || !teamB) {
    console.warn("⚠️ Invalid parameters in determinePlayerOfTheGame");
    return null;
  }

  let bestPlayer = null;
  let bestRating = 0;

  Object.values(matchEvents.playerPerformances).forEach((performance) => {
    if (!performance) return;

    let rating = performance.baseRating || 6.0;

    // Goals and assists
    rating += (performance.goals || 0) * 1.2;
    rating += (performance.assists || 0) * 0.8;

    const pos = performance.position || performance.pos || "UNK";

    const goalsByTeam = (teamName) =>
      matchEvents.goals.filter((g) => g.team === teamName).length;

    const teamConceded =
      performance.team === teamA.name
        ? goalsByTeam(teamB.name)
        : goalsByTeam(teamA.name);

    // Clean sheet bonus
    if (teamConceded === 0) {
      if (["GK", "CB", "RB", "LB"].includes(pos)) {
        rating += 0.8;
      } else if (["DM"].includes(pos)) {
        rating += 0.4;
      }
    }

    const teamGoals =
      performance.team === teamA.name ? goalsByTeam(teamA.name) : goalsByTeam(teamB.name);
    const opponentGoals =
      performance.team === teamA.name ? goalsByTeam(teamB.name) : goalsByTeam(teamA.name);

    if (teamGoals > opponentGoals) {
      rating += 0.3;
    }

    // Clamp 1–10
    rating = Math.min(10, Math.max(1, rating));
    performance.finalRating = Math.round(rating * 10) / 10;

    // Update avgRating for ALL players who played (not just POTG)
    const playerKey = `${performance.team}::${performance.player}`;
    if (PLAYER_DB[playerKey]) {
      // Ensure player has apps count
      if (!PLAYER_DB[playerKey].apps || PLAYER_DB[playerKey].apps === 0) {
        PLAYER_DB[playerKey].apps = 1;
      }

      const currentApps = PLAYER_DB[playerKey].apps;
      const currentTotal = (PLAYER_DB[playerKey].avgRating || 0) * (currentApps - 1);
      PLAYER_DB[playerKey].avgRating = (currentTotal + performance.finalRating) / currentApps;
      PLAYER_DB[playerKey].avgRating = Math.round(PLAYER_DB[playerKey].avgRating * 10) / 10;

      // Update player form based on this match performance
      updatePlayerForm(playerKey, performance.finalRating);
    }

    if (rating > bestRating) {
      bestRating = rating;
      bestPlayer = {
        player: performance.player,
        team: performance.team,
        position: pos,
        rating: performance.finalRating,
        goals: performance.goals || 0,
        assists: performance.assists || 0
      };
    }
  });

  if (bestPlayer) {
    const playerKey = `${bestPlayer.team}::${bestPlayer.player}`;
    if (PLAYER_DB[playerKey]) {
      PLAYER_DB[playerKey].playerOfTheGame =
        (PLAYER_DB[playerKey].playerOfTheGame || 0) + 1;

      // Update average rating (simple running average over apps)
      const currentApps = PLAYER_DB[playerKey].apps || 1;
      const currentTotal = (PLAYER_DB[playerKey].avgRating || 0) * (currentApps - 1);
      PLAYER_DB[playerKey].avgRating = (currentTotal + bestPlayer.rating) / currentApps;
      PLAYER_DB[playerKey].avgRating =
        Math.round(PLAYER_DB[playerKey].avgRating * 10) / 10;
    }
  }

  return bestPlayer;
}

/**
 * Enhanced match summary (overrides simpler version from earlier chunk).
 */
function generateMatchSummary(matchData, teamA, teamB) {
  if (!matchData || !teamA || !teamB) {
    return "An unexpected match occurred between two teams.";
  }

  const scoreA = matchData.scoreA || 0;
  const scoreB = matchData.scoreB || 0;
  const potg = matchData.playerOfTheGame;
  const isHome = matchData.isHome || false;

  const teamAName = typeof teamA === "string" ? teamA : teamA.name || "Unknown Team A";
  const teamBName = typeof teamB === "string" ? teamB : teamB.name || "Unknown Team B";

  const homeTeam = isHome ? teamAName : teamBName;
  const awayTeam = isHome ? teamBName : teamAName;
  const homeScore = isHome ? scoreA : scoreB;
  const awayScore = isHome ? scoreB : scoreA;

  const goalDiff = Math.abs(homeScore - awayScore);
  const totalGoals = homeScore + awayScore;

  if (homeScore === awayScore) {
    return `A tightly contested ${totalGoals}-goal draw at ${homeTeam}'s home ground. Both teams showed quality but couldn't find a winner.`;
  }

  if (goalDiff === 1) {
    if (homeScore > awayScore) {
      return `${homeTeam} edge a narrow ${homeScore}-${awayScore} victory at home. ${
        potg ? potg.player + " was instrumental" : "A solid team performance"
      } secured the crucial win.`;
    } else {
      return `${awayTeam} pull off an impressive ${awayScore}-${homeScore} away victory. ${
        potg ? potg.player + " led the charge" : "Their resilience paid off"
      } against the home side.`;
    }
  }

  if (goalDiff === 2) {
    if (homeScore > awayScore) {
      return `${homeTeam} dominate at home with a comfortable ${homeScore}-${awayScore} victory. ${
        potg ? potg.player + " was outstanding" : "Their quality shone through"
      } in a commanding performance.`;
    } else {
      return `${awayTeam} stun the home crowd with a convincing ${awayScore}-${homeScore} away win. ${
        potg ? potg.player + " masterminded" : "A tactical masterclass"
      } secures a vital result.`;
    }
  }

  if (goalDiff >= 3) {
    if (homeScore > awayScore) {
      return `${homeTeam} run riot in a spectacular ${homeScore}-${awayScore} home display. ${
        potg ? potg.player + " was unstoppable" : "Complete dominance"
      } from the home side in a one-sided affair.`;
    } else {
      return `${awayTeam} produce a stunning ${awayScore}-${homeScore} away demolition. ${
        potg ? potg.player + " was magnificent" : "A historic performance"
      } leaves the home fans in disbelief.`;
    }
  }

  return `An entertaining ${totalGoals}-goal encounter between ${homeTeam} and ${awayTeam}. ${
    potg ? potg.player + " stood out" : "Both teams gave their all"
  } in this competitive match.`;
}

/**
 * Core match simulation used for group stage (and can be reused for knockouts).
 */
 function simulateMatch(teamA, teamB, isHome, matchImportance = 1.0, weather = 'normal') {
  if (!teamA || !teamB) {
    console.error("❌ Invalid teams provided to simulateMatch");
    return {
      teamA: "Unknown Team A",
      teamB: "Unknown Team B",
      scoreA: 0,
      scoreB: 0,
      isHome,
      matchId: "invalid_match"
    };
  }

  const chaosFactor = RNG_SETTINGS.groupChaos || 1.0;
  const homeAdvantage = isHome ? 0.3 : -0.3;

  const baseScoreA =
    Math.random() * ((teamA.strength || 70) / 25) * chaosFactor;
  const baseScoreB =
    Math.random() * ((teamB.strength || 70) / 25) * chaosFactor;

  const adjustedScoreA = baseScoreA + homeAdvantage + matchImportance * 0.1;
  const adjustedScoreB = baseScoreB - homeAdvantage + matchImportance * 0.1;

  const goalsA = Math.max(0, Math.floor(adjustedScoreA + Math.random() * chaosFactor));
  const goalsB = Math.max(0, Math.floor(adjustedScoreB + Math.random() * chaosFactor));

  const finalGoalsA = Math.min(goalsA, 7);
  const finalGoalsB = Math.min(goalsB, 7);

  // trackEnhancedPlayerStats is expected later in your codebase
  const matchEvents = trackEnhancedPlayerStats(
    teamA,
    teamB,
    finalGoalsA,
    finalGoalsB
  );

  const matchId = `${teamA.name}_vs_${teamB.name}_${Date.now()}_${Math.random()
    .toString(36)
    .substr(2, 9)}`;
    MATCH_DETAILS_DB[matchId] = {
    id: matchId,
    matchId: matchId,
    teamA: teamA.name,
    teamB: teamB.name,
    teamAObj: teamA,
    teamBObj: teamB,
    scoreA: Number(finalGoalsA) || 0,
    scoreB: Number(finalGoalsB) || 0,
    goalsA: (Array.isArray(matchEvents?.goals) ? matchEvents.goals.filter(e => e.teamId === teamA.name || e.team === teamA.name) : []),
    goalsB: (Array.isArray(matchEvents?.goals) ? matchEvents.goals.filter(e => e.teamId === teamB.name || e.team === teamB.name) : []),
    isHome,
    events: matchEvents,
    playerOfTheGame: determinePlayerOfTheGame(matchEvents, teamA, teamB),
    timestamp: new Date().toISOString(),
    venue: isHome ? `${teamA.name} Home` : "Neutral",
    importance: matchImportance,
    weather: weather
  };

  if (window.VERBOSE_LOGGING) console.log(
    `⚽ Match simulated: ${teamA.name} ${finalGoalsA}-${finalGoalsB} ${teamB.name} ${
      isHome ? "(H)" : "(A)"
    }`
  );

  // Track achievements for match events
  try {
    // Check for upset (team with lower rating wins)
    const strengthDiff = Math.abs((teamA.strength || 70) - (teamB.strength || 70));
    if (strengthDiff >= 10) {
      const weaker = (teamA.strength || 70) < (teamB.strength || 70) ? teamA : teamB;
      const winner = finalGoalsA > finalGoalsB ? teamA : (finalGoalsB > finalGoalsA ? teamB : null);
      if (winner && winner.name === weaker.name) {
        updateAchievementProgress('upsets', 1);
      }
    }

    // Check for high-scoring match (5+ goals by winner)
    if (finalGoalsA >= 5 || finalGoalsB >= 5) {
      updateAchievementProgress('highScoring', 1);
    }

    // Track clean sheets
    if (finalGoalsA === 0 || finalGoalsB === 0) {
      updateAchievementProgress('cleanSheets', 1);
    }

    // Track total goals for century club
    updateAchievementProgress('totalGoals', finalGoalsA + finalGoalsB);
  } catch (e) {
    console.error('Error tracking match achievements:', e);
  }

  // Verify prediction if exists
  if (PREDICTION_STATE.predictions[matchId]) {
    verifyPrediction(matchId, {
      teamA: teamA.name,
      teamB: teamB.name,
      teamAObj: teamA,
      teamBObj: teamB,
      scoreA: finalGoalsA,
      scoreB: finalGoalsB
    });
  }

  // Track match for achievements
  if (MANAGER_STATE.active) {
    ACHIEVEMENT_PROGRESS.totalMatches++;
    MANAGER_STATE.matchesManaged++;
    MANAGER_STATE.statistics.totalMatches++;

    // Update win/loss stats
    if (finalGoalsA > finalGoalsB) {
      MANAGER_STATE.statistics.wins++;
      MANAGER_STATE.statistics.currentWinStreak++;
      if (MANAGER_STATE.statistics.currentWinStreak > MANAGER_STATE.statistics.longestWinStreak) {
        MANAGER_STATE.statistics.longestWinStreak = MANAGER_STATE.statistics.currentWinStreak;
      }
    } else if (finalGoalsA < finalGoalsB) {
      MANAGER_STATE.statistics.losses++;
      MANAGER_STATE.statistics.currentWinStreak = 0;
    } else {
      MANAGER_STATE.statistics.draws++;
      MANAGER_STATE.statistics.currentWinStreak = 0;
    }

    // Update goals
    MANAGER_STATE.statistics.goalsScored += finalGoalsA;
    MANAGER_STATE.statistics.goalsConceded += finalGoalsB;

    // Check for clean sheet
    if (finalGoalsB === 0) {
      MANAGER_STATE.statistics.cleanSheets++;
    }

    // Update win rate
    MANAGER_STATE.winRate = (MANAGER_STATE.statistics.wins / MANAGER_STATE.statistics.totalMatches * 100).toFixed(1);

    // Check achievements
    checkMatchAchievements();

    // Award base match XP
    const baseXP = 10;
    const winBonus = finalGoalsA > finalGoalsB ? 15 : 0;
    const drawBonus = finalGoalsA === finalGoalsB ? 5 : 0;
    awardManagerXP(baseXP + winBonus + drawBonus, 'Match completed');
  }

  return {
    teamA: teamA.name,
    teamB: teamB.name,
    scoreA: finalGoalsA,
    scoreB: finalGoalsB,
    isHome,
    matchId
  };
}

/************* GROUP STAGE: STANDINGS & SCHEDULE *************/

function calculateStandings(matches, teams) {
  if (!matches || !Array.isArray(matches) || !teams || !Array.isArray(teams)) {
    console.error("❌ Invalid parameters for calculateStandings");
    return [];
  }

  const standings = {};

  // Initialize
  teams.forEach((team) => {
    if (!team || !team.name) {
      console.warn("⚠️ Invalid team in calculateStandings:", team);
      return;
    }

    standings[team.name] = {
      team,
      played: 0,
      wins: 0,
      draws: 0,
      losses: 0,
      goalsFor: 0,
      goalsAgainst: 0,
      goalDifference: 0,
      points: 0
    };
  });

  // Process matches
  matches.forEach((match) => {
    if (!match || !match.teamA || !match.teamB) {
      console.warn("⚠️ Invalid match in calculateStandings:", match);
      return;
    }

    const home = standings[match.teamA];
    const away = standings[match.teamB];

    if (!home || !away) {
      console.warn(
        `⚠️ Team not found in standings: ${match.teamA} or ${match.teamB}`
      );
      return;
    }

    const scoreA = match.scoreA || 0;
    const scoreB = match.scoreB || 0;

    home.played++;
    away.played++;
    home.goalsFor += scoreA;
    home.goalsAgainst += scoreB;
    away.goalsFor += scoreB;
    away.goalsAgainst += scoreA;

    home.goalDifference = home.goalsFor - home.goalsAgainst;
    away.goalDifference = away.goalsFor - away.goalsAgainst;

    if (scoreA > scoreB) {
      home.wins++;
      home.points += 3;
      away.losses++;
    } else if (scoreA < scoreB) {
      home.losses++;
      away.wins++;
      away.points += 3;
    } else {
      home.draws++;
      away.draws++;
      home.points += 1;
      away.points += 1;
    }
  });

  // Sort with tie-breakers
  return Object.values(standings).sort((a, b) => {
    if (b.points !== a.points) return b.points - a.points;
    if (b.goalDifference !== a.goalDifference)
      return b.goalDifference - a.goalDifference;
    if (b.goalsFor !== a.goalsFor) return b.goalsFor - a.goalsFor;
    return (b.team.strength || 0) - (a.team.strength || 0);
  });
}

function simulateGroupStage(groups) {
  if (!groups || !Array.isArray(groups)) {
    console.error("❌ Invalid groups provided to simulateGroupStage");
    return {};
  }

  const results = {};
  MATCH_SCHEDULE.groupStage = [];

  if (window.VERBOSE_LOGGING) console.log(`🏁 Starting group stage simulation for ${groups.length} groups`);

  groups.forEach((group, groupIndex) => {
    if (!group || !group.name || !group.teams) {
      console.warn(`⚠️ Invalid group at index ${groupIndex}:`, group);
      return;
    }

    const groupName = group.name;
    if (window.VERBOSE_LOGGING) console.log(`📊 Simulating ${groupName}...`);

    results[groupName] = {
      name: groupName,
      teams: [],
      matches: []
    };

    const teams = group.teams.filter((t) => t && t.name);

    if (teams.length < 2) {
      console.warn(
        `⚠️ Not enough valid teams in ${groupName} (${teams.length} teams)`
      );
      results[groupName].teams = teams.map((team) => ({
        team,
        played: 0,
        wins: 0,
        draws: 0,
        losses: 0,
        goalsFor: 0,
        goalsAgainst: 0,
        points: 0
      }));
      return;
    }

    const groupMatches = [];

    // Home-and-away round-robin
    for (let i = 0; i < teams.length; i++) {
      for (let j = i + 1; j < teams.length; j++) {
        const teamA = teams[i];
        const teamB = teams[j];

        if (!teamA || !teamB) continue;

        try {
          const homeMatch = simulateMatch(teamA, teamB, true);
          const awayMatch = simulateMatch(teamA, teamB, false);

          groupMatches.push({
            type: "home",
            match: homeMatch,
            teamA,
            teamB
          });
          groupMatches.push({
            type: "away",
            match: awayMatch,
            teamA,
            teamB
          });

          results[groupName].matches.push(homeMatch, awayMatch);
        } catch (error) {
          console.error(
            `❌ Error simulating match between ${teamA.name} and ${teamB.name}:`,
            error
          );
        }
      }
    }

    // Organize into matchweeks and add matchday to all matches
    try {
      const matchweeks = organizeGroupMatchesIntoWeeks(groupMatches, groupName);
      MATCH_SCHEDULE.groupStage.push(...matchweeks);

      // Add matchday property to each match in results
      matchweeks.forEach(weekData => {
        const weekNumber = weekData.week;
        weekData.matches.forEach(weekMatch => {
          // weekMatch has the wrapper structure, get the actual match
          const actualMatch = weekMatch.match || weekMatch;
          const matchId = actualMatch.matchId;

          // Find and update the original match in results
          const originalMatch = results[groupName].matches.find(m =>
            m.matchId === matchId
          );
          if (originalMatch) {
            originalMatch.matchday = weekNumber;
          }
        });
      });
    } catch (error) {
      console.error(`❌ Error organizing matchweeks for ${groupName}:`, error);
    }

    // Standings
    try {
      results[groupName].teams = calculateStandings(
        results[groupName].matches,
        teams
      );
      if (window.VERBOSE_LOGGING) console.log(
        `✅ ${groupName} completed: ${results[groupName].matches.length} matches simulated`
      );
    } catch (error) {
      console.error(`❌ Error calculating standings for ${groupName}:`, error);
      results[groupName].teams = [];
    }
  });

  console.log("🎉 Group stage simulation completed!");
  return results;
}

// Group re-simulation confirmation and functions
function confirmResimulateGroups() {
  const modal = document.createElement('div');
  modal.className = 'modal-backdrop active';
  modal.style.zIndex = '10005';
  modal.innerHTML = `
    <div class="modal-content" style="max-width: 500px; text-align: center;">
      <div style="padding: 40px;">
        <div style="font-size: 4em; margin-bottom: 20px;">⚠️</div>
        <h2 style="color: #F59E0B; margin-bottom: 15px;">Re-simulate Groups?</h2>
        <p style="color: var(--textSecondary); margin-bottom: 25px; line-height: 1.6;">
          This will reset all group stage results and simulate new matches.
          This action cannot be undone.
        </p>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
          <button onclick="this.closest('.modal-backdrop').remove()" class="btn-secondary"
                  style="padding: 14px; font-weight: 600;">
            Cancel
          </button>
          <button onclick="resimulateGroups(); this.closest('.modal-backdrop').remove()"
                  class="btn-warning"
                  style="padding: 14px; font-weight: 600; background: linear-gradient(135deg, #F59E0B, #D97706);">
            Re-simulate
          </button>
        </div>
      </div>
    </div>
  `;

  document.body.appendChild(modal);
}

function resimulateGroups() {
  // Reset group results
  window.GROUP_RESULTS = null;

  // Reset all group stats if they exist
  if (window.GROUPS && Array.isArray(window.GROUPS)) {
    window.GROUPS.forEach(group => {
      if (group && group.teams && Array.isArray(group.teams)) {
        group.teams.forEach(team => {
          if (team) {
            team.played = 0;
            team.wins = 0;
            team.draws = 0;
            team.losses = 0;
            team.goalsFor = 0;
            team.goalsAgainst = 0;
            team.points = 0;
            team.goalDifference = 0;
          }
        });
      }
    });
  }

  // Clear match schedule for group stage
  if (window.MATCH_SCHEDULE) {
    window.MATCH_SCHEDULE.groupStage = [];
  }

  showNotification('info', 'Groups Reset', 'Ready to simulate again', 2000);

  // Re-render the groups in their initial state
  if (window.GROUPS) {
    renderGroupDrawResults(window.GROUPS);
  }
}

// Async non-blocking version of group stage simulation
async function simulateGroupStageAsync(groups, onProgress) {
  if (!groups || !Array.isArray(groups)) {
    console.error("❌ Invalid groups provided to simulateGroupStageAsync");
    return {};
  }

  const results = {};
  MATCH_SCHEDULE.groupStage = [];

  const totalMatches = groups.reduce((sum, group) => {
    const teamCount = group.teams ? group.teams.length : 0;
    return sum + (teamCount * (teamCount - 1)); // n*(n-1) for home-and-away
  }, 0);

  let matchesSimulated = 0;

  if (window.VERBOSE_LOGGING) console.log(`🏁 Starting async group stage simulation for ${groups.length} groups`);

  for (const group of groups) {
    if (!group || !group.name || !group.teams) {
      console.warn(`⚠️ Invalid group:`, group);
      continue;
    }

    const groupName = group.name;
    if (window.VERBOSE_LOGGING) console.log(`📊 Simulating ${groupName}...`);

    results[groupName] = {
      name: groupName,
      teams: [],
      matches: []
    };

    const teams = group.teams.filter((t) => t && t.name);

    if (teams.length < 2) {
      console.warn(`⚠️ Not enough valid teams in ${groupName}`);
      results[groupName].teams = teams.map((team) => ({
        team,
        played: 0,
        wins: 0,
        draws: 0,
        losses: 0,
        goalsFor: 0,
        goalsAgainst: 0,
        points: 0
      }));
      continue;
    }

    const groupMatches = [];

    // Home-and-away round-robin
    for (let i = 0; i < teams.length; i++) {
      for (let j = i + 1; j < teams.length; j++) {
        const teamA = teams[i];
        const teamB = teams[j];

        if (!teamA || !teamB) continue;

        try {
          const homeMatch = simulateMatch(teamA, teamB, true);
          const awayMatch = simulateMatch(teamA, teamB, false);

          groupMatches.push({
            type: "home",
            match: homeMatch,
            teamA,
            teamB
          });
          groupMatches.push({
            type: "away",
            match: awayMatch,
            teamA,
            teamB
          });

          results[groupName].matches.push(homeMatch, awayMatch);

          matchesSimulated += 2;
          if (onProgress) onProgress(matchesSimulated, totalMatches);

          // Update medical statuses after each match pair
          updatePlayerMedicalStatuses();

          // Yield after every pair of matches to allow UI repaint (maximum responsiveness)
          await new Promise(resolve => setTimeout(resolve, 0));
        } catch (error) {
          console.error(
            `❌ Error simulating match between ${teamA.name} and ${teamB.name}:`,
            error
          );
        }
      }
    }

    // Organize into matchweeks
    try {
      const matchweeks = organizeGroupMatchesIntoWeeks(groupMatches, groupName);
      MATCH_SCHEDULE.groupStage.push(...matchweeks);

      // Add matchday property to each match
      matchweeks.forEach(weekData => {
        const weekNumber = weekData.week;
        weekData.matches.forEach(weekMatch => {
          const actualMatch = weekMatch.match || weekMatch;
          const matchId = actualMatch.matchId;

          const originalMatch = results[groupName].matches.find(m =>
            m.matchId === matchId
          );
          if (originalMatch) {
            originalMatch.matchday = weekNumber;
          }
        });
      });
    } catch (error) {
      console.error(`❌ Error organizing matchweeks for ${groupName}:`, error);
    }

    // Calculate standings
    try {
      results[groupName].teams = calculateStandings(
        results[groupName].matches,
        teams
      );
      if (window.VERBOSE_LOGGING) console.log(
        `✅ ${groupName} completed: ${results[groupName].matches.length} matches simulated`
      );
    } catch (error) {
      console.error(`❌ Error calculating standings for ${groupName}:`, error);
      results[groupName].teams = [];
    }
  }

  console.log("🎉 Async group stage simulation completed!");
  return results;
}

function organizeGroupMatchesIntoWeeks(matches, groupName) {
  if (!matches || !Array.isArray(matches)) {
    console.warn('⚠️ Invalid matches for organizeGroupMatchesIntoWeeks');
    return [];
  }

  // Get all matches (unwrap from type wrappers)
  const allMatches = matches.map(m => m.match || m);

  // For a 4-team round-robin: 6 total matches
  // Proper matchday schedule where each team plays once per matchday:
  // In a 4-team group (A, B, C, D), the standard schedule is:
  // MD1: A-B, C-D
  // MD2: A-C, B-D
  // MD3: A-D, B-C
  // Then return fixtures in MD4-6

  const matchdays = [];
  const usedMatches = new Set();

  // Function to check if any team appears twice in a matchday
  const teamsInMatches = (matchList) => {
    const teams = new Set();
    for (const match of matchList) {
      const teamA = match.teamA?.name || match.teamA;
      const teamB = match.teamB?.name || match.teamB;
      if (teams.has(teamA) || teams.has(teamB)) {
        return false; // Team appears twice
      }
      teams.add(teamA);
      teams.add(teamB);
    }
    return true; // All teams unique
  };

  // Organize matches into 6 matchdays ensuring no team plays twice per day
  for (let day = 1; day <= 6; day++) {
    const dayMatches = [];

    // Try to assign 2 matches to this matchday where no team plays twice
    for (const match of allMatches) {
      if (usedMatches.has(match.matchId)) continue;

      const teamA = match.teamA?.name || match.teamA;
      const teamB = match.teamB?.name || match.teamB;

      // Check if adding this match would cause a team to play twice
      const tempMatches = [...dayMatches, match];
      if (teamsInMatches(tempMatches)) {
        dayMatches.push({
          ...match,
          matchday: day,
          group: groupName,
          matchweek: `Matchday ${day}`,
          timestamp: new Date().toISOString()
        });
        usedMatches.add(match.matchId);

        if (dayMatches.length >= 2) break; // 2 matches per matchday
      }
    }

    if (dayMatches.length > 0) {
      matchdays.push({
        week: day,
        name: `${groupName} - Matchday ${day}`,
        matches: dayMatches,
        group: groupName
      });
    }
  }

  if (window.VERBOSE_LOGGING) console.log(`📅 Organized ${matches.length} matches into ${matchdays.length} matchdays for ${groupName}`);
  return matchdays;
}
function calculateMatchWeek(matchData) {
  if (!matchData || !matchData.teamA || !matchData.teamB) return 1;

  const teamAName = matchData.teamA.name || "UnknownA";
  const teamBName = matchData.teamB.name || "UnknownB";

  const matchString = [teamAName, teamBName].sort().join("::");
  let hash = 0;

  for (let i = 0; i < matchString.length; i++) {
    const char = matchString.charCodeAt(i);
    hash = ((hash << 5) - hash) + char;
    hash = hash & hash;
  }

  const baseWeek = Math.abs(hash) % 6 + 1;

  if (matchData.type === "home") {
    // home legs 1–3
    return Math.min(3, baseWeek);
  } else if (matchData.type === "away") {
    // away legs 4–6
    return Math.max(4, Math.min(6, baseWeek + 3));
  }

  return Math.max(1, Math.min(6, baseWeek));
}

/************* GROUP RESULTS RENDERING *************/

function enableStatsButton() {
  const btnStats = document.getElementById("btnStats");
  if (btnStats) {
    btnStats.disabled = false;
    console.log("✅ Stats button enabled");
  }
}
/************* ENHANCED KNOCKOUT STAGE FUNCTIONS *************/

/**
 * Helper: resolve a "light" match object (from simulateMatch return)
 * into the full detailed record stored in MATCH_DETAILS_DB (with PoTG, events, etc.).
 */
 function getDetailedMatch(matchObj) {
  if (!matchObj || !matchObj.matchId) return matchObj;
  return MATCH_DETAILS_DB[matchObj.matchId] || matchObj;
}

/**
 * From group results → list of qualified team objects (top 2 from each group).
 */
function getQualifiedTeams(groupResults) {
  if (!groupResults || typeof groupResults !== "object") {
    console.error("❌ Invalid groupResults provided to getQualifiedTeams");
    return [];
  }

  const qualified = [];

  Object.values(groupResults).forEach((group, index) => {
    if (!group || !group.teams || !Array.isArray(group.teams)) {
      console.warn(`⚠️ Invalid group at index ${index}:`, group);
      return;
    }

    const topTeams = group.teams.slice(0, 2);

    topTeams.forEach((teamData, teamIndex) => {
      if (teamData && teamData.team) {
        qualified.push(teamData.team);
        if (window.VERBOSE_LOGGING) console.log(
          `✅ ${group.name}: ${teamData.team.name} qualified (Position ${teamIndex + 1})`
        );
      } else {
        console.warn(
          `⚠️ Invalid team data in ${group.name} at position ${teamIndex + 1}`
        );
      }
    });
  });

  if (window.VERBOSE_LOGGING) console.log(`🎯 Total qualified teams: ${qualified.length}`);
  return qualified;
}

/**
 * Async version: Simulate a single knockout round with yielding.
 */
async function simulateKnockoutRoundAsync(teams, roundName, matchImportance = 1.5, onProgress) {
  if (!teams || !Array.isArray(teams) || teams.length === 0) {
    console.error(`❌ No teams provided for ${roundName}`);
    return [];
  }

  if (teams.length % 2 !== 0) {
    console.warn(
      `⚠️ Odd number of teams (${teams.length}) for ${roundName}, adjusting...`
    );
    teams = teams.slice(0, teams.length - 1);
  }

  const matches = [];
  const shuffled = shuffleArray([...teams]);

  if (window.VERBOSE_LOGGING) console.log(`⚔️ Simulating ${roundName} with ${shuffled.length} teams...`);

  for (let i = 0; i < shuffled.length; i += 2) {
    if (i + 1 >= shuffled.length) break;

    const teamA = shuffled[i];
    const teamB = shuffled[i + 1];

    if (!teamA || !teamB) {
      console.warn(`⚠️ Invalid team pair in ${roundName} at index ${i}`);
      continue;
    }

    if (window.VERBOSE_LOGGING) console.log(`🎯 ${roundName} Match: ${teamA.name} vs ${teamB.name}`);

    if (roundName === "Final") {
      try {
        const finalMatchLight = simulateMatch(teamA, teamB, false, 2.0);
        let winner;
        let penaltiesUsed = false;
        let penaltyScoreA = 0;
        let penaltyScoreB = 0;

        if (finalMatchLight.scoreA > finalMatchLight.scoreB) {
          winner = teamA;
        } else if (finalMatchLight.scoreB > finalMatchLight.scoreA) {
          winner = teamB;
        } else {
          penaltiesUsed = true;
          const penaltyResult = simulatePenalties(teamA, teamB);
          winner = penaltyResult.winner;
          penaltyScoreA = penaltyResult.scoreA;
          penaltyScoreB = penaltyResult.scoreB;
          if (window.VERBOSE_LOGGING) console.log(`🎯 Final went to penalties: ${winner.name} wins ${penaltyScoreA}-${penaltyScoreB}`);
        }

        const match = {
          teamA,
          teamB,
          scoreA: finalMatchLight.scoreA,
          scoreB: finalMatchLight.scoreB,
          winner,
          round: roundName,
          matchDetails: finalMatchLight,
          isFinal: true,
          penaltiesUsed,
          penaltyScoreA,
          penaltyScoreB
        };

        if (MATCH_DETAILS_DB[finalMatchLight.matchId]) {
          MATCH_DETAILS_DB[finalMatchLight.matchId].round = roundName;
        }
        matches.push(match);
        if (window.VERBOSE_LOGGING) console.log(
          `🏆 Final: ${teamA.name} ${finalMatchLight.scoreA}-${finalMatchLight.scoreB} ${teamB.name}, Winner: ${match.winner.name}`
        );
      } catch (error) {
        console.error(`❌ Error simulating final:`, error);
      }
    } else {
      try {
        const firstLeg = simulateMatch(teamA, teamB, false, matchImportance);
        const secondLeg = simulateMatch(teamA, teamB, true, matchImportance);

        const aggScoreA = (firstLeg.scoreA || 0) + (secondLeg.scoreA || 0);
        const aggScoreB = (firstLeg.scoreB || 0) + (secondLeg.scoreB || 0);

        let winner;
        let penaltiesUsed = false;
        let penaltyScoreA = 0;
        let penaltyScoreB = 0;

        if (aggScoreA > aggScoreB) {
          winner = teamA;
        } else if (aggScoreA < aggScoreB) {
          winner = teamB;
        } else {
          const teamAAwayGoals = firstLeg.scoreA || 0;
          const teamBAwayGoals = secondLeg.scoreB || 0;

          if (teamAAwayGoals > teamBAwayGoals) {
            winner = teamA;
          } else if (teamBAwayGoals > teamAAwayGoals) {
            winner = teamB;
          } else {
            penaltiesUsed = true;
            const penaltyResult = simulatePenalties(teamA, teamB);
            winner = penaltyResult.winner;
            penaltyScoreA = penaltyResult.scoreA;
            penaltyScoreB = penaltyResult.scoreB;
            if (window.VERBOSE_LOGGING) console.log(`🎯 ${roundName} went to penalties: ${winner.name} wins ${penaltyScoreA}-${penaltyScoreB}`);
          }
        }

        const match = {
          teamA,
          teamB,
          firstLeg,
          secondLeg,
          aggScoreA,
          aggScoreB,
          winner,
          round: roundName,
          awayGoalsA: firstLeg.scoreA || 0,
          awayGoalsB: secondLeg.scoreB || 0,
          penaltiesUsed,
          penaltyScoreA,
          penaltyScoreB
        };

        if (MATCH_DETAILS_DB[firstLeg.matchId]) {
          MATCH_DETAILS_DB[firstLeg.matchId].round = roundName;
        }
        if (MATCH_DETAILS_DB[secondLeg.matchId]) {
          MATCH_DETAILS_DB[secondLeg.matchId].round = roundName;
        }
        matches.push(match);

        if (window.VERBOSE_LOGGING) console.log(
          `🔀 ${roundName}: ${teamA.name} ${aggScoreA}-${aggScoreB} ${teamB.name} (agg), Winner: ${winner.name}`
        );
      } catch (error) {
        console.error(`❌ Error simulating ${roundName} match:`, error);
      }
    }

    // Update medical statuses after each match
    updatePlayerMedicalStatuses();

    // Yield every match to allow UI updates
    if (onProgress) onProgress(roundName, i / 2 + 1, Math.floor(shuffled.length / 2));
    await new Promise(resolve => setTimeout(resolve, 0));
  }

  console.log(`✅ ${roundName} completed: ${matches.length} matches`);
  return matches;
}

/**
 * Async version: Simulate all knockout rounds with yielding.
 */
async function simulateKnockoutRoundsAsync(teams, onProgress) {
  if (!teams || !Array.isArray(teams) || teams.length === 0) {
    console.error("❌ No qualified teams for knockout stage");
    return {
      roundOf32: [],
      roundOf16: [],
      quarterFinals: [],
      semiFinals: [],
      final: null,
      champion: null,
      bracket: []
    };
  }

  if (window.VERBOSE_LOGGING) console.log("🏆 Starting async knockout tournament simulation...");
  console.log(`🎯 Teams in knockout stage: ${teams.length}`);

  MATCH_SCHEDULE.knockoutStage = [];

  const results = {
    roundOf32: [],
    roundOf16: [],
    quarterFinals: [],
    semiFinals: [],
    final: null,
    champion: null,
    bracket: []
  };

  try {
    // Round of 32
    if (onProgress) onProgress("Round of 32", 0, 0);
    results.roundOf32 = await simulateKnockoutRoundAsync(teams, "Round of 32", 1.2, onProgress);
    results.bracket.push({ round: "Round of 32", matches: results.roundOf32 });

    if (results.roundOf32.length === 0) {
      throw new Error("Round of 32 failed to produce matches");
    }

    // Round of 16
    const roundOf16Teams = results.roundOf32.map((m) => m && m.winner).filter(Boolean);
    if (onProgress) onProgress("Round of 16", 0, 0);
    results.roundOf16 = await simulateKnockoutRoundAsync(roundOf16Teams, "Round of 16", 1.4, onProgress);
    results.bracket.push({ round: "Round of 16", matches: results.roundOf16 });

    // Quarter Finals
    const quarterTeams = results.roundOf16.map((m) => m && m.winner).filter(Boolean);
    if (onProgress) onProgress("Quarter Finals", 0, 0);
    results.quarterFinals = await simulateKnockoutRoundAsync(quarterTeams, "Quarter Finals", 1.6, onProgress);
    results.bracket.push({ round: "Quarter Finals", matches: results.quarterFinals });

    // Semi Finals
    const semiTeams = results.quarterFinals.map((m) => m && m.winner).filter(Boolean);
    if (onProgress) onProgress("Semi Finals", 0, 0);
    results.semiFinals = await simulateKnockoutRoundAsync(semiTeams, "Semi Finals", 1.8, onProgress);
    results.bracket.push({ round: "Semi Finals", matches: results.semiFinals });

    // Final
    const finalTeams = results.semiFinals.map((m) => m && m.winner).filter(Boolean);
    if (finalTeams.length >= 2) {
      if (onProgress) onProgress("Final", 0, 0);
      const finalMatches = await simulateKnockoutRoundAsync(finalTeams, "Final", 2.0, onProgress);
      results.final = finalMatches[0] || null;
    } else {
      console.error("❌ Not enough teams for final:", finalTeams.length);
      results.final = null;
    }

    results.bracket.push({
      round: "Final",
      matches: results.final ? [results.final] : []
    });

    // Ensure champion is properly formatted
    const rawChampion = results.final?.winner || null;
    results.champion = rawChampion ? {
      name: rawChampion.name || rawChampion,
      season: rawChampion.season || 'Unknown Era',
      strength: rawChampion.strength || rawChampion.overall || 0
    } : null;

    if (results.champion) {
      console.log(`🎉 TOURNAMENT CHAMPION: ${results.champion.name} 🏆`);

      updateAchievementProgress('tournamentsCompleted', 1);

      const allMatches = [
        ...(results.roundOf32 || []),
        ...(results.roundOf16 || []),
        ...(results.quarterFinals || []),
        ...(results.semiFinals || []),
        results.final
      ].filter(Boolean);

      const tournamentData = {
        champion: results.champion.name,
        matches: allMatches,
        groupResults: window.GROUP_RESULTS,
        topScorer: window.PLAYER_DB ? Object.values(window.PLAYER_DB).sort((a, b) => b.goals - a.goals)[0] : null
      };

      checkAllAchievements(tournamentData);

      const totalGoals = allMatches.reduce((sum, match) => {
        const m = MATCH_DETAILS_DB[match.matchId];
        return sum + (m ? (m.scoreA + m.scoreB) : 0);
      }, 0);
      const avgGoals = allMatches.length > 0 ? (totalGoals / allMatches.length).toFixed(2) : 0;

      TOURNAMENT_HISTORY.push({
        champion: results.champion.name,
        season: results.champion.season,
        avgGoals: avgGoals,
        upsets: 0,
        timestamp: new Date().toISOString(),
        topScorer: tournamentData.topScorer?.name || 'Unknown'
      });

      // Save tournament history to localStorage
      try {
        localStorage.setItem('tournamentHistory', JSON.stringify(TOURNAMENT_HISTORY));
        if (window.VERBOSE_LOGGING) console.log(`💾 Tournament history saved to localStorage`);
      } catch (e) {
        console.error('❌ Failed to save tournament history:', e);
      }

      if (window.VERBOSE_LOGGING) console.log(`📊 Tournament added to history. Total tournaments: ${TOURNAMENT_HISTORY.length}`);

      // Track tournament win for achievements
      if (MANAGER_STATE.active) {
        ACHIEVEMENT_PROGRESS.tournamentsWon++;
        MANAGER_STATE.tournamentsWon++;

        // Award tournament completion XP
        awardManagerXP(200, 'Tournament won!');

        // Check tournament achievements
        checkTournamentAchievements();
      }

      // Store tournament data for sharing
      window.LAST_TOURNAMENT_RESULT = {
        winner: results.champion.name,
        runnerUp: results.final?.teamA === results.champion.name ? results.final?.teamB : results.final?.teamA,
        topScorer: tournamentData.topScorer ? {
          player: tournamentData.topScorer.name,
          goals: tournamentData.topScorer.goals || 0
        } : null,
        tournamentName: 'All-Time Football Tournament',
        totalMatches: allMatches.length
      };

      // Show share button after a delay
      setTimeout(() => {
        showUtilityMessage('🏆 Tournament Complete! Click to share results', 'success');
      }, 2000);

      if (typeof updateManagerStats === 'function') {
        updateManagerStats({
          champion: results.champion,
          matches: allMatches,
          topScorer: tournamentData.topScorer
        });
      }
    } else {
      console.error("❌ No champion determined");
    }

    organizeKnockoutMatches(results);
  } catch (error) {
    console.error("❌ Error in knockout stage simulation:", error);
  }

  return results;
}

/**
 * Simulate a single knockout round.
 * - For "Final": single match at neutral venue.
 * - For other rounds: two legs (away goals, then random pens).
 */
function simulateKnockoutRound(teams, roundName, matchImportance = 1.5) {
  if (!teams || !Array.isArray(teams) || teams.length === 0) {
    console.error(`❌ No teams provided for ${roundName}`);
    return [];
  }

  if (teams.length % 2 !== 0) {
    console.warn(
      `⚠️ Odd number of teams (${teams.length}) for ${roundName}, adjusting...`
    );
    teams = teams.slice(0, teams.length - 1); // drop last to make it even
  }

  const matches = [];
  const shuffled = shuffleArray([...teams]);

  if (window.VERBOSE_LOGGING) console.log(`⚔️ Simulating ${roundName} with ${shuffled.length} teams...`);

  for (let i = 0; i < shuffled.length; i += 2) {
    if (i + 1 >= shuffled.length) break;

    const teamA = shuffled[i];
    const teamB = shuffled[i + 1];

    if (!teamA || !teamB) {
      console.warn(`⚠️ Invalid team pair in ${roundName} at index ${i}`);
      continue;
    }

    if (window.VERBOSE_LOGGING) console.log(`🎯 ${roundName} Match: ${teamA.name} vs ${teamB.name}`);

    if (roundName === "Final") {
        try {
          const finalMatchLight = simulateMatch(teamA, teamB, false, 2.0);
          let winner;
          let penaltiesUsed = false;
          let penaltyScoreA = 0;
          let penaltyScoreB = 0;

          if (finalMatchLight.scoreA > finalMatchLight.scoreB) {
            winner = teamA;
          } else if (finalMatchLight.scoreB > finalMatchLight.scoreA) {
            winner = teamB;
          } else {
            // Final goes to penalties if tied
            penaltiesUsed = true;
            const penaltyResult = simulatePenalties(teamA, teamB);
            winner = penaltyResult.winner;
            penaltyScoreA = penaltyResult.scoreA;
            penaltyScoreB = penaltyResult.scoreB;
            if (window.VERBOSE_LOGGING) console.log(`🎯 Final went to penalties: ${winner.name} wins ${penaltyScoreA}-${penaltyScoreB}`);
          }

          const match = {
            teamA,
            teamB,
            scoreA: finalMatchLight.scoreA,
            scoreB: finalMatchLight.scoreB,
            winner,
            round: roundName,
            matchDetails: finalMatchLight,
            isFinal: true,
            penaltiesUsed,
            penaltyScoreA,
            penaltyScoreB
          };
        // Update the match detail with round info
        if (MATCH_DETAILS_DB[finalMatchLight.matchId]) {
          MATCH_DETAILS_DB[finalMatchLight.matchId].round = roundName;
        }
        matches.push(match);
        if (window.VERBOSE_LOGGING) console.log(
          `🏆 Final: ${teamA.name} ${finalMatchLight.scoreA}-${finalMatchLight.scoreB} ${teamB.name}, Winner: ${match.winner.name}`
        );
      } catch (error) {
        console.error(`❌ Error simulating final:`, error);
      }
    } else {
      try {
        // Two-leg tie
        const firstLeg = simulateMatch(teamA, teamB, false, matchImportance); // at B
        const secondLeg = simulateMatch(teamA, teamB, true, matchImportance); // at A

        const aggScoreA = (firstLeg.scoreA || 0) + (secondLeg.scoreA || 0);
        const aggScoreB = (firstLeg.scoreB || 0) + (secondLeg.scoreB || 0);

        let winner;
        let penaltiesUsed = false;
        let penaltyScoreA = 0;
        let penaltyScoreB = 0;

        if (aggScoreA > aggScoreB) {
          winner = teamA;
        } else if (aggScoreA < aggScoreB) {
          winner = teamB;
        } else {
          // Away goals rule
          const teamAAwayGoals = firstLeg.scoreA || 0;
          const teamBAwayGoals = secondLeg.scoreB || 0;

          if (teamAAwayGoals > teamBAwayGoals) {
            winner = teamA;
          } else if (teamBAwayGoals > teamAAwayGoals) {
            winner = teamB;
          } else {
            // Penalties
            penaltiesUsed = true;
            const penaltyResult = simulatePenalties(teamA, teamB);
            winner = penaltyResult.winner;
            penaltyScoreA = penaltyResult.scoreA;
            penaltyScoreB = penaltyResult.scoreB;
            if (window.VERBOSE_LOGGING) console.log(`🎯 ${roundName} went to penalties: ${winner.name} wins ${penaltyScoreA}-${penaltyScoreB}`);
          }
        }

        const match = {
          teamA,
          teamB,
          firstLeg,
          secondLeg,
          aggScoreA,
          aggScoreB,
          winner,
          round: roundName,
          awayGoalsA: firstLeg.scoreA || 0,
          awayGoalsB: secondLeg.scoreB || 0,
          penaltiesUsed,
          penaltyScoreA,
          penaltyScoreB
        };
        // Update both leg match details with round info
        if (MATCH_DETAILS_DB[firstLeg.matchId]) {
          MATCH_DETAILS_DB[firstLeg.matchId].round = roundName;
        }
        if (MATCH_DETAILS_DB[secondLeg.matchId]) {
          MATCH_DETAILS_DB[secondLeg.matchId].round = roundName;
        }
        matches.push(match);

        if (window.VERBOSE_LOGGING) console.log(
          `🔀 ${roundName}: ${teamA.name} ${aggScoreA}-${aggScoreB} ${teamB.name} (agg), Winner: ${winner.name}`
        );
      } catch (error) {
        console.error(`❌ Error simulating ${roundName} match:`, error);
      }
    }
  }

  console.log(`✅ ${roundName} completed: ${matches.length} matches`);
  return matches;
}

/**
 * Full knockout pipeline from R32 → R16 → QF → SF → Final.
 */
 function simulatePenalties(teamA, teamB) {
  const shooters = 5; // Standard 5 penalty shooters
  let scoreA = 0;
  let scoreB = 0;

  // Simulate 5 penalties each
  for (let i = 0; i < shooters; i++) {
    // Team A penalty (85% base success rate, modified by team strength)
    const successRateA = 0.70 + ((teamA.strength || 75) / 100) * 0.15;
    if (Math.random() < successRateA) scoreA++;

    // Team B penalty
    const successRateB = 0.70 + ((teamB.strength || 75) / 100) * 0.15;
    if (Math.random() < successRateB) scoreB++;
  }

  // Sudden death if tied after 5
  while (scoreA === scoreB) {
    const successRateA = 0.70 + ((teamA.strength || 75) / 100) * 0.15;
    const successRateB = 0.70 + ((teamB.strength || 75) / 100) * 0.15;
    
    const penA = Math.random() < successRateA ? 1 : 0;
    const penB = Math.random() < successRateB ? 1 : 0;
    
    scoreA += penA;
    scoreB += penB;
  }

  return {
    winner: scoreA > scoreB ? teamA : teamB,
    scoreA,
    scoreB
  };
}
function simulateKnockoutRounds(teams) {
  if (!teams || !Array.isArray(teams) || teams.length === 0) {
    console.error("❌ No qualified teams for knockout stage");
    return {
      roundOf32: [],
      roundOf16: [],
      quarterFinals: [],
      semiFinals: [],
      final: null,
      champion: null,
      bracket: []
    };
  }

  if (window.VERBOSE_LOGGING) console.log("🏆 Starting knockout tournament simulation...");
  console.log(`🎯 Teams in knockout stage: ${teams.length}`);

  MATCH_SCHEDULE.knockoutStage = [];

  const results = {
    roundOf32: [],
    roundOf16: [],
    quarterFinals: [],
    semiFinals: [],
    final: null,
    champion: null,
    bracket: []
  };

  try {
    // Round of 32
    results.roundOf32 = simulateKnockoutRound(teams, "Round of 32", 1.2);
    results.bracket.push({ round: "Round of 32", matches: results.roundOf32 });

    if (results.roundOf32.length === 0) {
      throw new Error("Round of 32 failed to produce matches");
    }

    // Round of 16
    const roundOf16Teams = results.roundOf32
      .map((m) => m && m.winner)
      .filter(Boolean);
    results.roundOf16 = simulateKnockoutRound(roundOf16Teams, "Round of 16", 1.4);
    results.bracket.push({ round: "Round of 16", matches: results.roundOf16 });

    // Quarter Finals
    const quarterTeams = results.roundOf16.map((m) => m && m.winner).filter(Boolean);
    results.quarterFinals = simulateKnockoutRound(
      quarterTeams,
      "Quarter Finals",
      1.6
    );
    results.bracket.push({
      round: "Quarter Finals",
      matches: results.quarterFinals
    });

    // Semi Finals
    const semiTeams = results.quarterFinals
      .map((m) => m && m.winner)
      .filter(Boolean);
    results.semiFinals = simulateKnockoutRound(semiTeams, "Semi Finals", 1.8);
    results.bracket.push({ round: "Semi Finals", matches: results.semiFinals });

    // Final
    const finalTeams = results.semiFinals
      .map((m) => m && m.winner)
      .filter(Boolean);
    if (finalTeams.length >= 2) {
      const finalMatches = simulateKnockoutRound(finalTeams, "Final", 2.0);
      results.final = finalMatches[0] || null;
    } else {
      console.error("❌ Not enough teams for final:", finalTeams.length);
      results.final = null;
    }

    results.bracket.push({
      round: "Final",
      matches: results.final ? [results.final] : []
    });

    // Ensure champion is properly formatted
    const rawChampion = results.final?.winner || null;
    results.champion = rawChampion ? {
      name: rawChampion.name || rawChampion,
      season: rawChampion.season || 'Unknown Era',
      strength: rawChampion.strength || rawChampion.overall || 0
    } : null;

    if (results.champion) {
      console.log(`🎉 TOURNAMENT CHAMPION: ${results.champion.name} 🏆`);

      // Track achievement progress
      updateAchievementProgress('tournamentsCompleted', 1);

      // Collect tournament data for achievement checking
      const allMatches = [
        ...(results.roundOf32 || []),
        ...(results.roundOf16 || []),
        ...(results.quarterFinals || []),
        ...(results.semiFinals || []),
        results.final
      ].filter(Boolean);

      const tournamentData = {
        champion: results.champion.name,
        matches: allMatches,
        groupResults: window.GROUP_RESULTS,
        topScorer: window.PLAYER_DB ? Object.values(window.PLAYER_DB).sort((a, b) => b.goals - a.goals)[0] : null
      };

      // Check all achievements
      checkAllAchievements(tournamentData);

      // NOTE: Tournament history is added in async version only (simulateKnockoutRoundsAsync)
      // to prevent duplicate entries when using async flow

      // Update manager career mode stats
      if (typeof updateManagerStats === 'function') {
        updateManagerStats({
          champion: results.champion,
          matches: allMatches,
          topScorer: tournamentData.topScorer
        });
      }
    } else {
      console.error("❌ No champion determined");
    }

    // Build knockout schedule by weeks
    organizeKnockoutMatches(results);
  } catch (error) {
    console.error("❌ Error in knockout stage simulation:", error);
  }

  return results;
}

/**
 * Build MATCH_SCHEDULE.knockoutStage as weeks 7+ (after group stage).
 */
function organizeKnockoutMatches(results) {
  if (!results || !MATCH_SCHEDULE) {
    console.error("❌ Invalid results or MATCH_SCHEDULE for organizeKnockoutMatches");
    return;
  }

  let currentWeek = 7; // group stage used 1–6

  if (window.VERBOSE_LOGGING) console.log("🗓️ Organizing knockout matches into schedule...");

  const createLegSchedule = (matches, round, legType, week) => {
    if (!matches || !Array.isArray(matches)) return [];

    return matches
      .map((match) => {
        if (!match) return null;
        const legMatchLight =
          legType === "first-leg" ? match.firstLeg : match.secondLeg;
        if (!legMatchLight) return null;

        return {
          type: legType,
          match: legMatchLight,
          teamA: match.teamA,
          teamB: match.teamB,
          round,
          week,
          aggregate:
            legType === "second-leg"
              ? `${match.aggScoreA}-${match.aggScoreB}`
              : null,
          winner: legType === "second-leg" ? match.winner?.name : null,
          timestamp: new Date().toISOString()
        };
      })
      .filter(Boolean);
  };

  // R32
  if (results.roundOf32 && results.roundOf32.length > 0) {
    MATCH_SCHEDULE.knockoutStage.push({
      week: currentWeek,
      name: "Round of 32 - First Leg",
      matches: createLegSchedule(results.roundOf32, "Round of 32", "first-leg", currentWeek),
      round: "Round of 32"
    });
    currentWeek++;

    MATCH_SCHEDULE.knockoutStage.push({
      week: currentWeek,
      name: "Round of 32 - Second Leg",
      matches: createLegSchedule(results.roundOf32, "Round of 32", "second-leg", currentWeek),
      round: "Round of 32"
    });
    currentWeek++;
  }

  // R16
  if (results.roundOf16 && results.roundOf16.length > 0) {
    MATCH_SCHEDULE.knockoutStage.push({
      week: currentWeek,
      name: "Round of 16 - First Leg",
      matches: createLegSchedule(results.roundOf16, "Round of 16", "first-leg", currentWeek),
      round: "Round of 16"
    });
    currentWeek++;

    MATCH_SCHEDULE.knockoutStage.push({
      week: currentWeek,
      name: "Round of 16 - Second Leg",
      matches: createLegSchedule(results.roundOf16, "Round of 16", "second-leg", currentWeek),
      round: "Round of 16"
    });
    currentWeek++;
  }

  // QF
  if (results.quarterFinals && results.quarterFinals.length > 0) {
    MATCH_SCHEDULE.knockoutStage.push({
      week: currentWeek,
      name: "Quarter Finals - First Leg",
      matches: createLegSchedule(
        results.quarterFinals,
        "Quarter Finals",
        "first-leg",
        currentWeek
      ),
      round: "Quarter Finals"
    });
    currentWeek++;

    MATCH_SCHEDULE.knockoutStage.push({
      week: currentWeek,
      name: "Quarter Finals - Second Leg",
      matches: createLegSchedule(
        results.quarterFinals,
        "Quarter Finals",
        "second-leg",
        currentWeek
      ),
      round: "Quarter Finals"
    });
    currentWeek++;
  }

  // SF
  if (results.semiFinals && results.semiFinals.length > 0) {
    MATCH_SCHEDULE.knockoutStage.push({
      week: currentWeek,
      name: "Semi Finals - First Leg",
      matches: createLegSchedule(results.semiFinals, "Semi Finals", "first-leg", currentWeek),
      round: "Semi Finals"
    });
    currentWeek++;

    MATCH_SCHEDULE.knockoutStage.push({
      week: currentWeek,
      name: "Semi Finals - Second Leg",
      matches: createLegSchedule(results.semiFinals, "Semi Finals", "second-leg", currentWeek),
      round: "Semi Finals"
    });
    currentWeek++;
  }

  // Final
  if (results.final) {
    const finalMatchLight =
      results.final.matchDetails || results.final; // same object
    MATCH_SCHEDULE.knockoutStage.push({
      week: currentWeek,
      name: "The Final",
      matches: [
        {
          type: "final",
          match: finalMatchLight,
          teamA: results.final.teamA,
          teamB: results.final.teamB,
          round: "Final",
          week: currentWeek,
          isFinal: true,
          timestamp: new Date().toISOString()
        }
      ],
      round: "Final"
    });
    currentWeek++;
  }

  if (window.VERBOSE_LOGGING) console.log(
    `✅ Knockout schedule organized: ${MATCH_SCHEDULE.knockoutStage.length} weeks`
  );
}

/**
 * Update CLUB_LEGACY_DB one time per knockout result object.
 */
function updateClubLegacyFromResults(results) {
  if (!results || !results.champion) return;

  // Avoid double-counting if called again on same object
  if (results._legacyUpdated) {
    if (window.VERBOSE_LOGGING) console.log("ℹ️ Club legacy already updated for this tournament object");
    return;
  }
  results._legacyUpdated = true;

  const champion = results.champion.name;

  if (!CLUB_LEGACY_DB.champions) CLUB_LEGACY_DB.champions = {};
  if (!CLUB_LEGACY_DB.finals) CLUB_LEGACY_DB.finals = {};
  if (!CLUB_LEGACY_DB.semiFinals) CLUB_LEGACY_DB.semiFinals = {};
  if (!CLUB_LEGACY_DB.quarterFinals) CLUB_LEGACY_DB.quarterFinals = {};
  if (!CLUB_LEGACY_DB.totalWins) CLUB_LEGACY_DB.totalWins = {};

  // Champion
  CLUB_LEGACY_DB.champions[champion] =
    (CLUB_LEGACY_DB.champions[champion] || 0) + 1;
  CLUB_LEGACY_DB.totalWins[champion] =
    (CLUB_LEGACY_DB.totalWins[champion] || 0) + 1;
  if (window.VERBOSE_LOGGING) console.log(`🏆 ${champion} added to champions legacy`);

  // Runner-up
  if (results.final) {
    const runnerUp =
      results.final.teamA.name === champion
        ? results.final.teamB.name
        : results.final.teamA.name;
    CLUB_LEGACY_DB.finals[runnerUp] =
      (CLUB_LEGACY_DB.finals[runnerUp] || 0) + 1;
    CLUB_LEGACY_DB.totalWins[runnerUp] =
      (CLUB_LEGACY_DB.totalWins[runnerUp] || 0) + 1;
    if (window.VERBOSE_LOGGING) console.log(`🥈 ${runnerUp} added to finals legacy`);
  }

  // Semi-finalists
  if (results.semiFinals) {
    results.semiFinals.forEach((match) => {
      if (!match) return;
      [match.teamA.name, match.teamB.name].forEach((team) => {
        if (team !== champion) {
          CLUB_LEGACY_DB.semiFinals[team] =
            (CLUB_LEGACY_DB.semiFinals[team] || 0) + 1;
          CLUB_LEGACY_DB.totalWins[team] =
            (CLUB_LEGACY_DB.totalWins[team] || 0) + 1;
        }
      });
    });
    if (window.VERBOSE_LOGGING) console.log("🥉 Semi-finalists updated");
  }

  // Quarter-finalists
  if (results.quarterFinals) {
    results.quarterFinals.forEach((match) => {
      if (!match) return;
      [match.teamA.name, match.teamB.name].forEach((team) => {
        CLUB_LEGACY_DB.quarterFinals[team] =
          (CLUB_LEGACY_DB.quarterFinals[team] || 0) + 1;
        CLUB_LEGACY_DB.totalWins[team] =
          (CLUB_LEGACY_DB.totalWins[team] || 0) + 1;
      });
    });
    if (window.VERBOSE_LOGGING) console.log("🎯 Quarter-finalists updated");
  }

  console.log("✅ Club legacy database updated");
}

/**
 * Main knockout UI renderer.
 */
 function renderKnockoutResults(data) {
  const out = document.getElementById('output');
  if (!out) return;

  if (!data || !data.champion) {
    out.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">🏆</div>
        <h2>Knockout Stage Not Completed</h2>
        <p class="output-sub">
          Knockout stage results will appear here after simulation.
        </p>
      </div>
    `;
    return;
  }

  const champ = data.champion;

  let html = `
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h2 style="margin: 0;">🏆 Knockout Stage Complete!</h2>
      <div style="display: flex; gap: 8px;">
        <button onclick="showTournamentBracket()" class="btn-secondary" style="padding: 8px 12px;">
          🏆 View Full Bracket
        </button>
        <button onclick="showTournamentOverview()" class="btn-secondary" style="padding: 8px 12px;">
          📅 All Match Results
        </button>
        <button onclick="showClubLegacy()" class="btn-secondary" style="padding: 8px 12px;">
          🏛️ Club Legacy
        </button>
      </div>
    </div>

    <div style="background: linear-gradient(135deg, #f59e0b, #d97706); padding: 25px; border-radius: 12px; text-align: center; margin-bottom: 25px; box-shadow: 0 8px 16px rgba(245, 158, 11, 0.3); border: 3px solid gold;">
      <div style="font-size: 3.5em; margin-bottom: 10px;">🏆</div>
      <h1 style="margin: 0; color: white; font-size: 2.2em; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">${champ.name}</h1>
      <p style="margin: 8px 0 0 0; color: rgba(255, 255, 255, 0.95); font-size: 1.2em;">${champ.season || "Club Era"} • OVR ${champ.strength || champ.overall || 70}</p>
      <p style="margin: 5px 0 0 0; color: gold; font-size: 1.3em; font-weight: bold;">TOURNAMENT CHAMPIONS</p>
    </div>
  `;

  // Final
  if (data.final) {
    const finalMatchLight = data.final.matchDetails || data.final;
    const finalMatch = getDetailedMatch(finalMatchLight);
    const potg = finalMatch.playerOfTheGame;
    const summary = generateMatchSummary(finalMatch, data.final.teamA, data.final.teamB);

    html += `
      <div class="group-card" style="border: 2px solid gold;">
        <div class="group-title" style="color: gold;">🏆 Final</div>
        <div style="padding: 20px; text-align: center; background: linear-gradient(135deg, #1e3a8a, #3730a3); border-radius: 8px; margin: 10px;">
          <div style="font-size: 24px; font-weight: bold; margin-bottom: 10px; color: white;">
            ${data.final.teamA.name} ${finalMatch.scoreA || 0} - ${finalMatch.scoreB || 0} ${data.final.teamB.name}
            ${data.final.penaltiesUsed ? `<div style="font-size: 16px; color: #fbbf24; margin-top: 8px;">(${data.final.penaltyScoreA}-${data.final.penaltyScoreB} on penalties)</div>` : ''}
          </div>
          <div style="color: #fbbf24; font-weight: bold; font-size: 18px; margin-bottom: 15px;">
            🏆 ${champ.name} wins the tournament${data.final.penaltiesUsed ? ' on penalties' : ''}! 🏆
          </div>
          ${potg ? `
            <div style="background: rgba(245, 158, 11, 0.3); padding: 10px; border-radius: 6px; margin: 10px 0; border: 1px solid #f59e0b;">
              <strong>⭐ Player of the Match:</strong> ${potg.player} (${potg.rating}/10)
              ${potg.goals > 0 ? ` • ${potg.goals} goal${potg.goals > 1 ? "s" : ""}` : ""}
              ${potg.assists > 0 ? ` • ${potg.assists} assist${potg.assists > 1 ? "s" : ""}` : ""}
            </div>
          ` : ""}
          <div style="color: #cbd5e1; font-style: italic; margin-top: 10px; font-size: 0.9em;">
            ${summary}
          </div>
        </div>
      </div>
    `;
  }

  // All Knockout Rounds
  const knockoutRounds = [
    { name: 'Round of 32', data: data.roundOf32 },
    { name: 'Round of 16', data: data.roundOf16 },
    { name: 'Quarter Finals', data: data.quarterFinals },
    { name: 'Semi Finals', data: data.semiFinals }
  ];

  knockoutRounds.forEach(round => {
    if (!round.data || round.data.length === 0) return;

    html += `
      <div class="group-card" style="margin-top: 15px;">
        <div class="group-title">${round.name}</div>
        <div style="padding: 10px;">
    `;

    round.data.forEach((match, idx) => {
      if (!match) return;

      const firstLeg = getDetailedMatch(match.firstLeg);
      const secondLeg = getDetailedMatch(match.secondLeg);

      html += `
        <div style="background: rgba(30, 41, 59, 0.5); border-radius: 8px; padding: 10px; margin-bottom: 8px; border: 1px solid #374151;">
          
          <div style="display: grid; grid-template-columns: 2fr auto 2fr; gap: 12px; align-items: center; margin-bottom: 8px;">
            <div style="text-align: right;">
              <div style="font-weight: bold; color: ${match.winner?.name === match.teamA?.name ? '#10b981' : '#e5e7eb'}; font-size: 0.95rem;">
                ${match.teamA?.name || 'Unknown'}
                ${match.winner?.name === match.teamA?.name ? ' ✓' : ''}
              </div>
            </div>

            <div style="text-align: center; background: #1f2937; padding: 8px 15px; border-radius: 6px; border: 2px solid ${match.winner?.name === match.teamA?.name ? '#10b981' : match.winner?.name === match.teamB?.name ? '#ef4444' : '#6b7280'};">
              <div style="font-size: 1.5rem; font-weight: bold; color: white;">
                ${match.aggScoreA || 0} - ${match.aggScoreB || 0}
              </div>
              <div style="font-size: 0.7rem; color: #9ca3af; margin-top: 2px;">Aggregate</div>
            </div>

            <div style="text-align: left;">
              <div style="font-weight: bold; color: ${match.winner?.name === match.teamB?.name ? '#10b981' : '#e5e7eb'}; font-size: 0.95rem;">
                ${match.winner?.name === match.teamB?.name ? '✓ ' : ''}
                ${match.teamB?.name || 'Unknown'}
              </div>
            </div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.8rem;">
            <div style="background: rgba(15, 23, 42, 0.8); padding: 6px; border-radius: 4px; text-align: center;">
              <div style="color: #9ca3af; font-size: 0.75rem; margin-bottom: 2px;">First Leg (Away)</div>
              <div style="font-weight: bold; color: #e5e7eb;">
                ${match.teamB?.name}: ${firstLeg?.scoreA || 0}-${firstLeg?.scoreB || 0}
              </div>
              ${firstLeg?.playerOfTheGame ? `
                <div style="color: #f59e0b; font-size: 0.75rem; margin-top: 3px;">
                  ⭐ ${firstLeg.playerOfTheGame.player}
                </div>
              ` : ''}
            </div>
            
            <div style="background: rgba(15, 23, 42, 0.8); padding: 6px; border-radius: 4px; text-align: center;">
              <div style="color: #9ca3af; font-size: 0.75rem; margin-bottom: 2px;">Second Leg (Home)</div>
              <div style="font-weight: bold; color: #e5e7eb;">
                ${match.teamA?.name}: ${secondLeg?.scoreA || 0}-${secondLeg?.scoreB || 0}
              </div>
              ${secondLeg?.playerOfTheGame ? `
                <div style="color: #f59e0b; font-size: 0.75rem; margin-top: 3px;">
                  ⭐ ${secondLeg.playerOfTheGame.player}
                </div>
              ` : ''}
            </div>
          </div>

          ${match.awayGoalsA !== match.awayGoalsB && match.aggScoreA === match.aggScoreB ? `
            <div style="margin-top: 6px; padding: 4px 8px; background: rgba(245, 158, 11, 0.2); border-radius: 4px; text-align: center; font-size: 0.75rem; color: #fbbf24;">
              ⚡ Decided on away goals
            </div>
          ` : ''}

          ${match.penaltiesUsed ? `
            <div style="margin-top: 6px; padding: 4px 8px; background: rgba(239, 68, 68, 0.2); border-radius: 4px; text-align: center; font-size: 0.75rem; color: #fca5a5;">
              🎯 Decided on penalties: ${match.penaltyScoreA}-${match.penaltyScoreB}
            </div>
          ` : ''}

          <div style="margin-top: 8px; text-align: center;">
            <span style="color: #10b981; font-weight: bold; font-size: 0.85rem;">
              → ${match.winner?.name || 'Unknown'} advances
            </span>
          </div>
        </div>
      `;
    });

    html += `
        </div>
      </div>
    `;
  });

  out.innerHTML = html;

  // Safely update club legacy
  if (typeof updateClubLegacyFromResults === 'function') {
    updateClubLegacyFromResults(data);
  }
}
/************* ENHANCED MAIN BUTTON FUNCTIONS *************/
async function startTournament() {
  if (window.VERBOSE_LOGGING) console.log("🏁 Starting tournament...");

  // Show loading overlay
  if (typeof showLoading === "function") showLoading("Initializing tournament...");

  try {
    // Clear previous tournament data
    window.GROUPS = null;
    window.GROUP_RESULTS = null;
    window.TOURNAMENT = null;

    // Clear current tournament player stats but keep all-time stats
    Object.keys(PLAYER_DB).forEach(key => {
      delete PLAYER_DB[key];
    });

    // Optionally reset schedules / current ID
    MATCH_SCHEDULE.groupStage = [];
    MATCH_SCHEDULE.knockoutStage = [];
    window.CURRENT_TOURNAMENT_ID = Date.now();

    // Reinitialize teams and players for new tournament only if not already initialized
    if (TEAM_MAP.size === 0) {
      await initTeamsAndPlayers();
    }

    const groups = generateGroups();
    if (!groups || groups.length === 0) {
      throw new Error("Failed to generate groups");
    }

    window.GROUPS = groups;

    // Update UI state
    const btnGroup = document.getElementById("btnGroupStage");
    const btnKO = document.getElementById("btnKnockouts");
    const btnStats = document.getElementById("btnStats");

    if (btnGroup) {
      btnGroup.disabled = false;
      btnGroup.innerHTML = `
        <div class="ctrl-btn-main">
          <span class="ctrl-btn-title">Simulate Group Stage</span>
          <span class="ctrl-btn-subtitle">Home-and-away round-robin</span>
        </div>
        <span class="ctrl-btn-tag">Play</span>
      `;
      btnGroup.onclick = function () {
        runGroupStage();
      };
    }

    if (btnKO) {
      btnKO.disabled = true;
      btnKO.innerHTML = `
        <div class="ctrl-btn-main">
          <span class="ctrl-btn-title">Run Knockouts</span>
          <span class="ctrl-btn-subtitle">R32 → R16 → QF → SF → Final</span>
        </div>
        <span class="ctrl-btn-tag">KO</span>
      `;
      btnKO.onclick = function () {
        runKnockouts();
      };
    }

    if (btnStats) {
      btnStats.disabled = true;
    }

    renderGroups(groups);
    console.log("✅ Tournament started successfully with", groups.length, "groups");
  } catch (error) {
    console.error("❌ Error starting tournament:", error);
    showUtilityMessage("Failed to start tournament. Please try again.", "error");

    const out = document.getElementById("output");
    if (out) {
      out.innerHTML = `
        <div class="empty-state">
          <div class="empty-icon">⚠️</div>
          <h2>Tournament Start Failed</h2>
          <p class="output-sub">
            There was an error starting the tournament. Please try again.
          </p>
        </div>
      `;
    }
  } finally {
    if (typeof hideLoading === "function") hideLoading();
  }
}

async function runGroupStage() {
  // Prevent duplicate runs
  if (isGroupStageRunning) {
    console.warn("⚠️ Group stage already running - ignored");
    showUtilityMessage("Group stage simulation already in progress!", "warning");
    return;
  }
  isGroupStageRunning = true;

  if (window.VERBOSE_LOGGING) console.log("⚽ Starting group stage simulation...");

  const btnGroup = document.getElementById("btnGroupStage");
  const btnKO = document.getElementById("btnKnockouts");

  // Validate pre-conditions
  if (!window.GROUPS) {
    isGroupStageRunning = false;
    showUtilityMessage("Please generate groups first by clicking 'Generate Groups'!", "error");
    return;
  }

  // Update button state
  if (btnGroup) {
    btnGroup.disabled = true;
    btnGroup.style.background = "linear-gradient(135deg, #1e40af, #1e3a8a)";
    btnGroup.innerHTML = `
      <div class="ctrl-btn-main">
        <span class="ctrl-btn-title">Simulating...</span>
        <span class="ctrl-btn-subtitle">Running group stage matches</span>
      </div>
      <span class="ctrl-btn-tag">⏳</span>
    `;
  }

  if (btnKO) {
    btnKO.disabled = true;
  }

  // Show loading state
  const out = document.getElementById("output");
  if (out) {
    out.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">⚽</div>
        <h2>Simulating Group Stage</h2>
        <p class="output-sub">
          Running all group stage matches... This may take a moment.
        </p>
        <div style="margin-top: 20px; color: #9ca3af;">
          <div>📊 Simulating 16 groups</div>
          <div>⚽ 192 total matches</div>
          <div>👥 Tracking player statistics</div>
        </div>
      </div>
    `;
  }

  // Show loading overlay
  showLoading("Simulating group stage...");

  // Allow UI to paint before starting simulation
  await new Promise(resolve => setTimeout(resolve, 100));

  try {
    if (window.VERBOSE_LOGGING) console.log("🎯 Simulating group stage matches...");

    const groupResults = await simulateGroupStageAsync(window.GROUPS, updateLoadingProgress);

      if (!groupResults || Object.keys(groupResults).length === 0) {
        throw new Error("Group stage simulation failed to produce results");
      }

      window.GROUP_RESULTS = groupResults;

      // Update UI state
      if (btnKO) {
        btnKO.disabled = false;
        btnKO.innerHTML = `
          <div class="ctrl-btn-main">
            <span class="ctrl-btn-title">Run Knockouts</span>
            <span class="ctrl-btn-subtitle">R32 → R16 → QF → SF → Final</span>
          </div>
          <span class="ctrl-btn-tag">KO</span>
        `;
        btnKO.onclick = function () {
          runKnockouts();
        };
      }

      if (btnGroup) {
        btnGroup.disabled = false;
        btnGroup.style.background = "";
        btnGroup.innerHTML = `
          <div class="ctrl-btn-main">
            <span class="ctrl-btn-title">View Group Stage</span>
            <span class="ctrl-btn-subtitle">Go back to group results</span>
          </div>
          <span class="ctrl-btn-tag">📊</span>
        `;
        btnGroup.onclick = function () {
          showGroupStageResults();
        };
      }

      enableStatsButton();
      showGroupStageResults();

      console.log("✅ Group stage completed successfully");
      setTimeout(() => {
  updateButtonStates();
}, 100);
    } catch (error) {
      console.error("❌ Error in group stage simulation:", error);

      // Reset button states
      if (btnGroup) {
        btnGroup.disabled = false;
        btnGroup.style.background = "";
        btnGroup.innerHTML = `
          <div class="ctrl-btn-main">
            <span class="ctrl-btn-title">Simulate Group Stage</span>
            <span class="ctrl-btn-subtitle">Home-and-away round-robin</span>
          </div>
          <span class="ctrl-btn-tag">Play</span>
        `;
        btnGroup.onclick = function () {
          runGroupStage();
        };
      }

      showUtilityMessage("Error simulating group stage. Please try again.", "error");

      const out = document.getElementById("output");
      if (out) {
        out.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">⚠️</div>
            <h2>Group Stage Simulation Failed</h2>
            <p class="output-sub">
              There was an error simulating the group stage. Please try again.
            </p>
          </div>
        `;
      }
    } finally {
      hideLoading();
      isGroupStageRunning = false;
    }
}

async function runKnockouts() {
  // Prevent duplicate runs (silent mode to avoid console spam)
  if (isKnockoutRunning) {
    if (window.VERBOSE_LOGGING) console.log("⏸️ Knockout stage already running - request ignored");
    return;
  }
  isKnockoutRunning = true;

  if (window.VERBOSE_LOGGING) console.log("🎯 Starting knockout stage...");

  const btnKO = document.getElementById("btnKnockouts");
  const btnGroup = document.getElementById("btnGroupStage");

  // Validate pre-conditions
  if (!window.GROUP_RESULTS) {
    isKnockoutRunning = false;
    showUtilityMessage("Please run the group stage first by clicking 'Simulate Group Stage'!", "error");
    return;
  }

  // If already simulated, just show it again
  if (window.TOURNAMENT && window.TOURNAMENT.champion) {
    console.log("✅ Knockout stage already exists, displaying results...");
    renderKnockoutResults(window.TOURNAMENT);
    isKnockoutRunning = false;
    return;
  }

  // Update button state
  if (btnKO) {
    btnKO.disabled = true;
    btnKO.style.background = "linear-gradient(135deg, #ea580c, #c2410c)";
    btnKO.innerHTML = `
      <div class="ctrl-btn-main">
        <span class="ctrl-btn-title">Simulating KO...</span>
        <span class="ctrl-btn-subtitle">Running knockout stages</span>
      </div>
      <span class="ctrl-btn-tag">⏳</span>
    `;
  }

  // Loading UI
  const out = document.getElementById("output");
  if (out) {
    out.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">🎯</div>
        <h2>Simulating Knockout Stage</h2>
        <p class="output-sub">
          Running knockout rounds... This may take a moment.
        </p>
        <div style="margin-top: 20px; color: #9ca3af;">
          <div>🏆 Round of 32 (16 matches)</div>
          <div>🔀 Round of 16 (8 matches)</div>
          <div>🎯 Quarter Finals (4 matches)</div>
          <div>⚔️ Semi Finals (2 matches)</div>
          <div>🥇 The Final (1 match)</div>
        </div>
      </div>
    `;
  }

  // Show loading overlay
  showLoading("Simulating knockouts...");

  // Allow UI to paint before starting simulation
  await new Promise(resolve => setTimeout(resolve, 100));

  try {
    if (window.VERBOSE_LOGGING) console.log("🎯 Getting qualified teams...");
    const qualifiedTeams = getQualifiedTeams(window.GROUP_RESULTS);

    if (!qualifiedTeams || qualifiedTeams.length === 0) {
      throw new Error("No qualified teams found for knockout stage");
    }

    if (window.VERBOSE_LOGGING) console.log(
      `🎯 Simulating knockout rounds with ${qualifiedTeams.length} teams...`
    );
    const knockoutResults = await simulateKnockoutRoundsAsync(qualifiedTeams, updateKnockoutProgress);

      if (!knockoutResults || !knockoutResults.champion) {
        throw new Error(
          "Knockout stage simulation failed to produce a champion"
        );
      }

      window.TOURNAMENT = knockoutResults;

      // Legacy is now handled by renderKnockoutResults via updateClubLegacyFromResults
      renderKnockoutResults(knockoutResults);

      // Save tournament to history
      if (!window.TOURNAMENT_HISTORY) window.TOURNAMENT_HISTORY = [];
      window.TOURNAMENT_HISTORY.push({
        date: new Date().toISOString(),
        champion: knockoutResults.champion,
        runnerUp: knockoutResults.runnerUp || null,
        results: knockoutResults
      });
      // Save to localStorage
      try {
        localStorage.setItem('tournamentHistory', JSON.stringify(window.TOURNAMENT_HISTORY));
      } catch(e) { console.error('Failed to save history:', e); }


      // Update UI state
      setTimeout(() => {
  updateButtonStates();
  
  // Force enable all view buttons after knockout completion
  const viewButtons = ['btnStats', 'btnAllMatches', 'btnMatchWeeks', 'btnBracket'];
  viewButtons.forEach(btnId => {
    const btn = document.getElementById(btnId);
    if (btn) {
      btn.disabled = false;
      btn.style.opacity = '1';
      btn.style.cursor = 'pointer';
    }
  });
}, 100);
      if (btnGroup) {
        btnGroup.disabled = false;
        btnGroup.style.background = "";
        btnGroup.innerHTML = `
          <div class="ctrl-btn-main">
            <span class="ctrl-btn-title">View Group Stage</span>
            <span class="ctrl-btn-subtitle">Go back to group results</span>
          </div>
          <span class="ctrl-btn-tag">📊</span>
        `;
        btnGroup.onclick = function () {
          showGroupStageResults();
        };
      }

      if (btnKO) {
        btnKO.disabled = false;
        btnKO.style.background = "linear-gradient(135deg, #ea580c, #c2410c)";
        btnKO.innerHTML = `
          <div class="ctrl-btn-main">
            <span class="ctrl-btn-title">View Knockouts</span>
            <span class="ctrl-btn-subtitle">See knockout results again</span>
          </div>
          <span class="ctrl-btn-tag">🏆</span>
        `;
        btnKO.onclick = function () {
          renderKnockoutResults(window.TOURNAMENT);
        };
      }

      console.log("✅ Knockout stage completed successfully");
    } catch (error) {
      console.error("❌ Error in knockout stage simulation:", error);

      if (btnKO) {
        btnKO.disabled = false;
        btnKO.style.background = "";
        btnKO.innerHTML = `
          <div class="ctrl-btn-main">
            <span class="ctrl-btn-title">Run Knockouts</span>
            <span class="ctrl-btn-subtitle">R32 → R16 → QF → SF → Final</span>
          </div>
          <span class="ctrl-btn-tag">KO</span>
        `;
        btnKO.onclick = function () {
          runKnockouts();
        };
      }

      showUtilityMessage(
        "Error simulating knockout stage. Please try running the group stage again.",
        "error"
      );

      const out = document.getElementById("output");
      if (out) {
        out.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">⚠️</div>
            <h2>Knockout Stage Simulation Failed</h2>
            <p class="output-sub">
              There was an error simulating the knockout stage. Please try running the group stage again.
            </p>
          </div>
        `;
      }
    } finally {
      hideLoading();
      isKnockoutRunning = false;
    }
}

// Enhanced global function exports with fallbacks
const globalExports = {
  // Tournament control
  startTournament,
  runGroupStage,
  runKnockouts,
  runFullTournament,

  // View functions
  showPlayerStats,
  showClubLegacy,
  showGroupStageResults,
  showTournamentOverview,
  showTournamentBracket,
  showMatchResults,
  showMatchWeeks,
  showEnhancedStatistics,
  showCustomMatchHistory,

  // Modal functions
  openCustomMatch,
  openHistory,
  openMatchDetail,
  openTeamDetail,
  openSettings,
  openStatistics,
  closeCustomMatch,
  closeHistory,
  closeMatchDetail,
  closeTeamDetail,
  closeSettings,
  closeStatistics,
  closeAllModals,

  // Utility functions
  exportTournament,
  enhancedExportTournament,
  resetTournament,
  performReset,
  handleImport,
  enhancedHandleImport,
  updateRNG,
  setRNGPreset,
  toggleTheme,
  updateClubLegacyFromResults,
  // Backwards-compat alias for any older code:
  updateClubLegacy: updateClubLegacyFromResults,

  // Custom match functions
  simulateCustomMatch,
  simulateRematch,
  saveCustomMatch,
  shareMatchResult,
  populateCustomMatchDropdowns,
  updateTeamComparison,

  // Enhanced functions
  displayMatchWeekResults,
  displayKnockoutRound,
  generateMatchSummary,
  exportTournamentCSV,
  exportTournamentSummary,
  backupToLocalStorage,
  restoreFromBackup,
  restorePreResetBackup,
  showPlayerDetails,
  toggleStatsView,
  exportPlayerStats,
  exportBracketData,
  simulateRematchFromDetail,
  shareMatchDetails,
  viewTeamPlayers,
  replaySavedMatch,
  deleteSavedMatch,
  clearCustomMatchHistory,

  // Utility / init
  showResetConfirmationModal,
  initializeTheme,
  initializeRNG,
  updateButtonStates,
  showUtilityMessage,

};
// Expose to window for console / external bindings
// Expose to window for console / external bindings
window.GlobalSim = Object.assign(window.GlobalSim || {}, globalExports);

/************* MODAL SYSTEM *************/
const ModalManager = {
  activeModal: null,
  modalStack: [],
  history: [],
  escapeHandler: null,

  open(modalId, data = null) {
    const modal = document.getElementById(modalId);
    if (!modal) {
      console.warn(`Modal ${modalId} not found`);
      return;
    }

    // Close currently active modal if different
    if (this.activeModal && this.activeModal !== modalId) {
      this.close(this.activeModal);
    }

    if (!this.modalStack.includes(modalId)) {
      this.modalStack.push(modalId);
    }
    this.activeModal = modalId;

    this.history.push({
      modalId,
      timestamp: new Date().toISOString(),
      data
    });

    modal.style.display = 'flex';

    setTimeout(() => {
      modal.classList.add('active');
      modal.setAttribute('aria-hidden', 'false');

      const focusable = modal.querySelector(
        'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
      );
      if (focusable) focusable.focus();

      modal.dispatchEvent(new CustomEvent('modalopen', { detail: data }));
    }, 10);

    const clickHandler = (e) => {
      if (e.target === modal) {
        this.close(modalId);
      }
    };

    modal._modalClickHandler = clickHandler;
    modal.addEventListener('click', clickHandler);

    this.addEscapeListener();
    if (window.VERBOSE_LOGGING) console.log(`Modal opened: ${modalId}`, data);
  },

  close(modalId = null) {
    const targetModalId = modalId || this.activeModal;
    if (!targetModalId) return;

    const modal = document.getElementById(targetModalId);
    if (!modal) return;

    this.modalStack = this.modalStack.filter(id => id !== targetModalId);
    this.activeModal = this.modalStack[this.modalStack.length - 1] || null;

    modal.classList.remove('active');
    modal.setAttribute('aria-hidden', 'true');

    if (modal._modalClickHandler) {
      modal.removeEventListener('click', modal._modalClickHandler);
      delete modal._modalClickHandler;
    }

    setTimeout(() => {
      modal.style.display = 'none';
      modal.dispatchEvent(new CustomEvent('modalclose'));
    }, 300);

    if (this.modalStack.length === 0) {
      this.removeEscapeListener();
    }

    if (window.VERBOSE_LOGGING) console.log(`Modal closed: ${targetModalId}`);
  },

  closeAll() {
    while (this.modalStack.length > 0) {
      this.close(this.modalStack[this.modalStack.length - 1]);
    }
  },

  addEscapeListener() {
    if (this.escapeHandler) return;
    this.escapeHandler = (e) => {
      if (e.key === 'Escape') {
        this.close();
      }
    };
    document.addEventListener('keydown', this.escapeHandler);
  },

  removeEscapeListener() {
    if (this.escapeHandler) {
      document.removeEventListener('keydown', this.escapeHandler);
      this.escapeHandler = null;
    }
  },

  getHistory() {
    return [...this.history];
  },

  clearHistory() {
    this.history = [];
  }
};

// Now add ModalManager to window after it's defined
window.ModalManager = ModalManager;
// Helper function to show group stage results (enhanced)
function showGroupStageResults() {
  const out = document.getElementById('output');
  if (!out) return;

  if (!window.GROUP_RESULTS || Object.keys(window.GROUP_RESULTS).length === 0) {
    out.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">📊</div>
        <h2>No Group Stage Results</h2>
        <p class="output-sub">Run the group stage simulation first.</p>
        <button onclick="runGroupStage()" class="btn-primary" style="margin-top: 15px;">
          🏃 Run Group Stage
        </button>
      </div>
    `;
    return;
  }

  const groupNames = Object.keys(window.GROUP_RESULTS).sort();
  
  let html = `
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h2>📊 Group Stage Results</h2>
      <div style="display: flex; gap: 8px;">
        <button onclick="showMatchWeeks()" class="btn-secondary" style="padding: 8px 12px;">
          📅 Matchdays
        </button>
        <button onclick="showPlayerStats()" class="btn-secondary" style="padding: 8px 12px;">
          📈 Statistics
        </button>
      </div>
    </div>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 20px;">
  `;

  groupNames.forEach(groupName => {
    const groupData = window.GROUP_RESULTS[groupName];
    if (!groupData || !groupData.teams) return;

    const standings = groupData.teams;
    const matches = groupData.matches || [];

    html += `
      <div style="background: linear-gradient(135deg, #1e293b, #0f172a); padding: 20px; border-radius: 12px; border: 1px solid #475569;">
        <!-- Group Header -->
        <div style="text-align: center; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 2px solid #3b82f6;">
          <h3 style="margin: 0; color: #60a5fa; font-size: 1.3em;">${groupName}</h3>
        </div>

        <!-- Standings Table -->
        <div style="margin-bottom: 15px;">
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="background: rgba(59, 130, 246, 0.2); color: #94a3b8; font-size: 0.85em;">
                <th style="padding: 8px; text-align: left;">#</th>
                <th style="padding: 8px; text-align: left;">Team</th>
                <th style="padding: 8px; text-align: center;">P</th>
                <th style="padding: 8px; text-align: center;">W</th>
                <th style="padding: 8px; text-align: center;">D</th>
                <th style="padding: 8px; text-align: center;">L</th>
                <th style="padding: 8px; text-align: center;">GF</th>
                <th style="padding: 8px; text-align: center;">GA</th>
                <th style="padding: 8px; text-align: center;">GD</th>
                <th style="padding: 8px; text-align: center;">Pts</th>
              </tr>
            </thead>
            <tbody>
    `;

    standings.forEach((team, index) => {
      const isQualified = index < 2;
      const bgColor = isQualified ? 'rgba(16, 185, 129, 0.1)' : 'rgba(30, 41, 59, 0.3)';
      const borderLeft = isQualified ? '3px solid #10b981' : 'none';

      html += `
        <tr style="background: ${bgColor}; border-left: ${borderLeft}; border-bottom: 1px solid #374151;">
          <td style="padding: 10px; color: #94a3b8; font-weight: bold;">${index + 1}</td>
          <td style="padding: 10px; color: #e5e7eb; font-weight: 500;">${team.team.name}</td>
          <td style="padding: 10px; text-align: center; color: #94a3b8;">${team.played}</td>
          <td style="padding: 10px; text-align: center; color: #10b981;">${team.wins}</td>
          <td style="padding: 10px; text-align: center; color: #f59e0b;">${team.draws}</td>
          <td style="padding: 10px; text-align: center; color: #ef4444;">${team.losses}</td>
          <td style="padding: 10px; text-align: center; color: #60a5fa;">${team.goalsFor}</td>
          <td style="padding: 10px; text-align: center; color: #ef4444;">${team.goalsAgainst}</td>
          <td style="padding: 10px; text-align: center; color: ${team.goalDifference >= 0 ? '#10b981' : '#ef4444'}; font-weight: bold;">
            ${team.goalDifference >= 0 ? '+' : ''}${team.goalDifference}
          </td>
          <td style="padding: 10px; text-align: center; color: #fbbf24; font-weight: bold; font-size: 1.1em;">
            ${team.points}
          </td>
        </tr>
      `;
    });

    html += `
            </tbody>
          </table>
        </div>

        <!-- All Group Matches -->
        <div>
          <div style="color: #94a3b8; font-size: 0.9em; font-weight: 600; margin-bottom: 8px; padding-left: 5px;">
            📋 All Matches
          </div>
    `;

    // Show ALL matches from this group
    matches.forEach(match => {
      if (!match) return;

      const formA = getTeamFormHTML(match.teamA);
      const formB = getTeamFormHTML(match.teamB);

      html += `
        <div onclick="viewMatchDetails('${match.matchId}')"
             style="background: rgba(30, 41, 59, 0.5); padding: 10px 12px; margin-bottom: 6px; border-radius: 6px; cursor: pointer; border: 1px solid #374151; transition: all 0.2s ease;"
             onmouseover="this.style.borderColor='#3b82f6'; this.style.background='rgba(59, 130, 246, 0.1)'"
             onmouseout="this.style.borderColor='#374151'; this.style.background='rgba(30, 41, 59, 0.5)'">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div style="flex: 1; display: flex; align-items: center; gap: 8px;">
              <span style="color: #e5e7eb; font-size: 0.9em;">${match.teamA}</span>
              <span class="form-indicator">${formA}</span>
            </div>
            <div style="display: flex; align-items: center; gap: 8px; padding: 0 15px;">
              <span style="color: white; font-weight: bold;">${match.scoreA}</span>
              <span style="color: #6b7280;">-</span>
              <span style="color: white; font-weight: bold;">${match.scoreB}</span>
            </div>
            <div style="flex: 1; display: flex; align-items: center; justify-content: flex-end; gap: 8px;">
              <span class="form-indicator">${formB}</span>
              <span style="color: #e5e7eb; font-size: 0.9em;">${match.teamB}</span>
            </div>
          </div>
          <div style="text-align: center; margin-top: 4px; font-size: 0.75em; color: #64748b;">
            Matchday ${match.matchday || ''}
          </div>
        </div>
      `;
    });

    html += `
        </div>
      </div>
    `;
  });

  html += `</div>`;
  out.innerHTML = html;
  console.log('✅ Group stage results displayed');
}
/************* ENHANCED VIEW FUNCTIONS *************/
function showPlayerStats() {
  const out = document.getElementById("output");
  if (!out) return;

  const playersWithData = Object.values(PLAYER_DB).filter(
    p => p.apps > 0 || p.goals > 0 || p.assists > 0
  );

  const viewMode = window.STATS_VIEW_MODE || 'detailed'; 

  let html = `
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h2>📊 Player Statistics</h2>
      <div style="display: flex; gap: 10px;">
        <button onclick="exportPlayerStats()" class="btn-secondary" style="padding: 8px 12px;">
          📥 Export Data
        </button>
        <button onclick="toggleStatsView()" class="btn-secondary" id="statsViewToggle" style="padding: 8px 12px;">
          ${viewMode === 'detailed' ? '📊 Compact View' : '📈 Detailed View'}
        </button>
      </div>
    </div>
  `;

  if (playersWithData.length === 0) {
    out.innerHTML = html + `
      <div class="empty-state">
        <div class="empty-icon">📊</div>
        <h2>No Player Statistics Yet</h2>
        <p class="output-sub">Player statistics will appear after you simulate matches.</p>
        <button onclick="runGroupStage()" class="btn-primary" style="margin-top: 15px;">
          Simulate Group Stage
        </button>
      </div>
    `;
    return;
  }

  const topScorers = [...playersWithData]
    .sort((a, b) => b.goals - a.goals)
    .slice(0, viewMode === 'compact' ? 10 : 15);

  const topAssists = [...playersWithData]
    .sort((a, b) => b.assists - a.assists)
    .slice(0, viewMode === 'compact' ? 10 : 15);

  const topRatings = [...playersWithData]
    .filter(p => p.apps >= 3)
    .sort((a, b) => (b.avgRating || 6.5) - (a.avgRating || 6.5))
    .slice(0, viewMode === 'compact' ? 5 : 10);

  // Enhanced Tournament Summary
  const totalGoals = playersWithData.reduce((sum, p) => sum + (p.goals || 0), 0);
  const totalAssists = playersWithData.reduce((sum, p) => sum + (p.assists || 0), 0);
  const totalApps = playersWithData.reduce((sum, p) => sum + (p.apps || 0), 0);
  const avgGoalsPerGame = totalApps > 0 ? (totalGoals / totalApps).toFixed(2) : "0.00";

  html += `
    <div style="background: linear-gradient(135deg, #2d3748, #4a5568); padding: 20px; border-radius: 12px; margin-bottom: 25px; border-left: 4px solid #3b82f6;">
      <h3 style="margin: 0 0 15px 0; color: #e5e7eb;">📈 Tournament Summary</h3>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
        <div style="text-align: center; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
          <div style="font-size: 2em; margin-bottom: 5px;">👤</div>
          <div style="font-size: 0.9em; color: #9ca3af;">Players with Data</div>
          <div style="font-size: 1.5em; font-weight: bold; color: #3b82f6;">${playersWithData.length}</div>
        </div>
        <div style="text-align: center; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
          <div style="font-size: 2em; margin-bottom: 5px;">⚽</div>
          <div style="font-size: 0.9em; color: #9ca3af;">Total Goals</div>
          <div style="font-size: 1.5em; font-weight: bold; color: #ef4444;">${totalGoals}</div>
        </div>
        <div style="text-align: center; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
          <div style="font-size: 2em; margin-bottom: 5px;">🎯</div>
          <div style="font-size: 0.9em; color: #9ca3af;">Total Assists</div>
          <div style="font-size: 1.5em; font-weight: bold; color: #10b981;">${totalAssists}</div>
        </div>
        <div style="text-align: center; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
          <div style="font-size: 2em; margin-bottom: 5px;">📊</div>
          <div style="font-size: 0.9em; color: #9ca3af;">Goals/Game</div>
          <div style="font-size: 1.5em; font-weight: bold; color: #f59e0b;">${avgGoalsPerGame}</div>
        </div>
      </div>
    </div>
  `;

  // Hot Players Section (Form System)
  const hotPlayers = getHotPlayers(5);
  if (hotPlayers.length > 0) {
    html += `
      <div style="background: linear-gradient(135deg, #dc2626, #991b1b); padding: 20px; border-radius: 12px; margin-bottom: 25px; border: 1px solid #f87171;">
        <h3 style="margin: 0 0 15px 0; color: #fef2f2; display: flex; align-items: center; gap: 8px;">
          <span>🔥</span> Hot Players (In Form)
        </h3>
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="background: rgba(254, 242, 242, 0.1); border-bottom: 2px solid #fca5a5;">
              <th style="padding: 12px; text-align: center; width: 50px;">Form</th>
              <th style="padding: 12px; text-align: left;">Player</th>
              <th style="padding: 12px; text-align: center;">⭐ Rating</th>
              <th style="padding: 12px; text-align: center;">⚽ Goals</th>
              <th style="padding: 12px; text-align: left;">Team</th>
            </tr>
          </thead>
          <tbody>
    `;

    hotPlayers.forEach(player => {
      html += `
        <tr style="border-bottom: 1px solid rgba(248, 113, 113, 0.3);">
          <td style="padding: 12px; text-align: center; font-size: 1.5em;">${player.indicator}</td>
          <td style="padding: 12px;"><strong style="color: #fef2f2;">${player.name}</strong> <span style="color: #94a3b8; font-size: 0.85em;">${player.pos}</span></td>
          <td style="padding: 12px; text-align: center; color: #fbbf24; font-weight: 600;">${player.avgRating.toFixed(1)}</td>
          <td style="padding: 12px; text-align: center; color: #fef2f2;">${player.goals}</td>
          <td style="padding: 12px; color: #e5e7eb;">${player.team}</td>
        </tr>
      `;
    });

    html += `
          </tbody>
        </table>
      </div>
    `;
  }

  // Top Scorers Section
  if (topScorers.length > 0) {
    html += `
      <div style="background: linear-gradient(135deg, #1e293b, #0f172a); padding: 20px; border-radius: 12px; margin-bottom: 25px; border: 1px solid #475569;">
        <h3 style="margin: 0 0 15px 0; color: #3b82f6; display: flex; align-items: center; gap: 8px;">
          <span>⚽</span> Top Scorers
        </h3>
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="background: rgba(59, 130, 246, 0.1); border-bottom: 2px solid #3b82f6;">
              <th style="padding: 12px; text-align: center; width: 50px;">#</th>
              <th style="padding: 12px; text-align: left;">Player</th>
              <th style="padding: 12px; text-align: center;">⚽ Goals</th>
              ${viewMode === 'detailed' ? '<th style="padding: 12px; text-align: center;">🎯 Assists</th>' : ''}
              ${viewMode === 'detailed' ? '<th style="padding: 12px; text-align: center;">📊 Apps</th>' : ''}
              <th style="padding: 12px; text-align: center;">⭐ Rating</th>
              <th style="padding: 12px; text-align: left;">Team</th>
            </tr>
          </thead>
          <tbody>
    `;

    topScorers.forEach((player, index) => {
      const formIndicator = player.form && player.form.indicator ? player.form.indicator : '';
      html += `
        <tr style="border-bottom: 1px solid rgba(71, 85, 105, 0.3);">
          <td style="padding: 12px; text-align: center; color: #94a3b8; font-weight: 600;">${index + 1}</td>
          <td style="padding: 12px;"><strong style="color: #e2e8f0;">${formIndicator} ${player.name}</strong></td>
          <td style="padding: 12px; text-align: center; color: #3b82f6; font-weight: bold;">${player.goals}</td>
          ${viewMode === 'detailed' ? `<td style="padding: 12px; text-align: center; color: #94a3b8;">${player.assists || 0}</td>` : ''}
          ${viewMode === 'detailed' ? `<td style="padding: 12px; text-align: center; color: #94a3b8;">${player.apps}</td>` : ''}
          <td style="padding: 12px; text-align: center;"><span style="color: ${getRatingColor(player.avgRating)}; font-weight: 600;">${player.avgRating}</span></td>
          <td style="padding: 12px; color: #94a3b8;">${player.team}</td>
        </tr>
      `;
    });

    html += `
          </tbody>
        </table>
      </div>
    `;
  }

  // Top Assists Section
  if (topAssists.length > 0) {
    html += `
      <div style="background: linear-gradient(135deg, #1e293b, #0f172a); padding: 20px; border-radius: 12px; margin-bottom: 25px; border: 1px solid #475569;">
        <h3 style="margin: 0 0 15px 0; color: #10b981; display: flex; align-items: center; gap: 8px;">
          <span>🎯</span> Top Assists
        </h3>
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="background: rgba(16, 185, 129, 0.1); border-bottom: 2px solid #10b981;">
              <th style="padding: 12px; text-align: center; width: 50px;">#</th>
              <th style="padding: 12px; text-align: left;">Player</th>
              <th style="padding: 12px; text-align: center;">🎯 Assists</th>
              ${viewMode === 'detailed' ? '<th style="padding: 12px; text-align: center;">⚽ Goals</th>' : ''}
              ${viewMode === 'detailed' ? '<th style="padding: 12px; text-align: center;">📊 Apps</th>' : ''}
              <th style="padding: 12px; text-align: center;">⭐ Rating</th>
              <th style="padding: 12px; text-align: left;">Team</th>
            </tr>
          </thead>
          <tbody>
    `;

    topAssists.forEach((player, index) => {
      const formIndicator = player.form && player.form.indicator ? player.form.indicator : '';
      html += `
        <tr style="border-bottom: 1px solid rgba(71, 85, 105, 0.3);">
          <td style="padding: 12px; text-align: center; color: #94a3b8; font-weight: 600;">${index + 1}</td>
          <td style="padding: 12px;"><strong style="color: #e2e8f0;">${formIndicator} ${player.name}</strong></td>
          <td style="padding: 12px; text-align: center; color: #10b981; font-weight: bold;">${player.assists}</td>
          ${viewMode === 'detailed' ? `<td style="padding: 12px; text-align: center; color: #94a3b8;">${player.goals || 0}</td>` : ''}
          ${viewMode === 'detailed' ? `<td style="padding: 12px; text-align: center; color: #94a3b8;">${player.apps}</td>` : ''}
          <td style="padding: 12px; text-align: center;"><span style="color: ${getRatingColor(player.avgRating)}; font-weight: 600;">${player.avgRating}</span></td>
          <td style="padding: 12px; color: #94a3b8;">${player.team}</td>
        </tr>
      `;
    });

    html += `
          </tbody>
        </table>
      </div>
    `;
  }

  // Top Ratings Section
  if (topRatings.length > 0) {
    html += `
      <div style="background: linear-gradient(135deg, #1e293b, #0f172a); padding: 20px; border-radius: 12px; margin-bottom: 25px; border: 1px solid #475569;">
        <h3 style="margin: 0 0 15px 0; color: #f59e0b; display: flex; align-items: center; gap: 8px;">
          <span>⭐</span> Top Rated Players <span style="font-size: 0.8em; color: #94a3b8;">(min. 3 apps)</span>
        </h3>
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="background: rgba(245, 158, 11, 0.1); border-bottom: 2px solid #f59e0b;">
              <th style="padding: 12px; text-align: center; width: 50px;">#</th>
              <th style="padding: 12px; text-align: left;">Player</th>
              <th style="padding: 12px; text-align: center;">⭐ Rating</th>
              ${viewMode === 'detailed' ? '<th style="padding: 12px; text-align: center;">⚽ Goals</th>' : ''}
              ${viewMode === 'detailed' ? '<th style="padding: 12px; text-align: center;">🎯 Assists</th>' : ''}
              ${viewMode === 'detailed' ? '<th style="padding: 12px; text-align: center;">📊 Apps</th>' : ''}
              <th style="padding: 12px; text-align: left;">Team</th>
            </tr>
          </thead>
          <tbody>
    `;

    topRatings.forEach((player, index) => {
      const formIndicator = player.form && player.form.indicator ? player.form.indicator : '';
      html += `
        <tr style="border-bottom: 1px solid rgba(71, 85, 105, 0.3);">
          <td style="padding: 12px; text-align: center; color: #94a3b8; font-weight: 600;">${index + 1}</td>
          <td style="padding: 12px;"><strong style="color: #e2e8f0;">${formIndicator} ${player.name}</strong></td>
          <td style="padding: 12px; text-align: center;"><span style="color: ${getRatingColor(player.avgRating)}; font-weight: bold; font-size: 1.1em;">${player.avgRating}</span></td>
          ${viewMode === 'detailed' ? `<td style="padding: 12px; text-align: center; color: #94a3b8;">${player.goals || 0}</td>` : ''}
          ${viewMode === 'detailed' ? `<td style="padding: 12px; text-align: center; color: #94a3b8;">${player.assists || 0}</td>` : ''}
          ${viewMode === 'detailed' ? `<td style="padding: 12px; text-align: center; color: #94a3b8;">${player.apps}</td>` : ''}
          <td style="padding: 12px; color: #94a3b8;">${player.team}</td>
        </tr>
      `;
    });

    html += `
          </tbody>
        </table>
      </div>
    `;
  }

  // Team Statistics
  const teamStats = calculateTeamStats(playersWithData);
  if (teamStats.length > 0) {
    html += `
      <div style="background: linear-gradient(135deg, #1e293b, #0f172a); padding: 20px; border-radius: 12px; margin-bottom: 25px; border: 1px solid #475569;">
        <h3 style="margin: 0 0 15px 0; color: #a78bfa; display: flex; align-items: center; gap: 8px;">
          <span>🏆</span> Team Statistics
        </h3>
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="background: rgba(167, 139, 250, 0.1); border-bottom: 2px solid #a78bfa;">
              <th style="padding: 12px; text-align: left;">Team</th>
              <th style="padding: 12px; text-align: center;">⚽ Goals</th>
              <th style="padding: 12px; text-align: center;">🎯 Assists</th>
              <th style="padding: 12px; text-align: center;">👥 Players</th>
              <th style="padding: 12px; text-align: center;">⭐ Avg Rating</th>
              <th style="padding: 12px; text-align: left;">Top Scorer</th>
            </tr>
          </thead>
          <tbody>
    `;

    teamStats.forEach((team, index) => {
      const placement = getTeamPlacement(team.name);
      const placementBadge = placement ? `<span style="background: ${getPlacementColor(placement)}; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.75em; margin-left: 6px;">${placement}</span>` : '';

      html += `
        <tr style="border-bottom: 1px solid rgba(71, 85, 105, 0.3);">
          <td style="padding: 12px;"><strong style="color: #e2e8f0;">${team.name}</strong>${placementBadge}</td>
          <td style="padding: 12px; text-align: center; color: #94a3b8;">${team.goals}</td>
          <td style="padding: 12px; text-align: center; color: #94a3b8;">${team.assists}</td>
          <td style="padding: 12px; text-align: center; color: #94a3b8;">${team.players}</td>
          <td style="padding: 12px; text-align: center;"><span style="color: ${getRatingColor(team.avgRating)}; font-weight: 600;">${team.avgRating}</span></td>
          <td style="padding: 12px; color: #94a3b8; font-size: 0.9em;">${team.topScorer}</td>
        </tr>
      `;
    });

    html += `
          </tbody>
        </table>
      </div>
    `;
  }

  out.innerHTML = html;
}

// Enhanced helper functions
function getRatingColor(rating) {
  const numRating = parseFloat(rating);
  if (isNaN(numRating)) return "#9ca3af";
  if (numRating >= 8.5) return "#10b981"; // Green
  if (numRating >= 7.5) return "#3b82f6"; // Blue
  if (numRating >= 6.5) return "#f59e0b"; // Yellow
  return "#ef4444"; // Red
}

function calculateTeamOverallStrength(team) {
  if (!team || !team.startingXI || !Array.isArray(team.startingXI) || team.startingXI.length === 0) {
    return 70;
  }
  
  const startingStrength = team.startingXI.reduce(
    (sum, player) => sum + (player?.quality || 70), 
    0
  ) / team.startingXI.length;
  
  let benchStrength = 70;
  if (team.bench && Array.isArray(team.bench) && team.bench.length > 0) {
    benchStrength = team.bench.reduce(
      (sum, player) => sum + (player?.quality || 70), 
      0
    ) / team.bench.length;
  }
  
  return Math.round((startingStrength * 0.8) + (benchStrength * 0.2));
}

function getTeamPlayingStyle(team) {
  const strength = calculateTeamOverallStrength(team);
  if (strength >= 85) return "🌟 Elite";
  if (strength >= 75) return "🔥 Strong";
  if (strength >= 65) return "💪 Competitive";
  return "🆙 Developing";
}

function calculateTeamStats(players) {
  const teams = {};
  
  players.forEach(player => {
    if (!player || !player.team) return;
    
    if (!teams[player.team]) {
      teams[player.team] = {
        name: player.team,
        goals: 0,
        assists: 0,
        players: 0,
        totalRating: 0,
        topScorer: { name: "", goals: 0 }
      };
    }
    
    teams[player.team].goals += (player.goals || 0);
    teams[player.team].assists += (player.assists || 0);
    teams[player.team].players++;
    teams[player.team].totalRating += (player.avgRating || 6.5);
    
    if ((player.goals || 0) > teams[player.team].topScorer.goals) {
      teams[player.team].topScorer = { name: player.name, goals: player.goals || 0 };
    }
  });
  
  return Object.values(teams)
    .map(team => ({
      ...team,
      avgRating: team.players > 0
        ? (team.totalRating / team.players).toFixed(1)
        : "0.0",
      topScorer: team.topScorer.name
        ? `${team.topScorer.name} (${team.topScorer.goals})`
        : "—"
    }))
    .sort((a, b) => b.goals - a.goals);
}

function showPlayerDetails(playerId) {
  const player = PLAYER_DB[playerId];
  if (!player) {
    showUtilityMessage("Player not found in current tournament.", "error");
    return;
  }
  
  const out = document.getElementById("output");
  if (!out) return;

  const hasApps = player.apps && player.apps > 0;
  const goalsPerGame = hasApps ? (player.goals / player.apps).toFixed(2) : "0.00";
  const contribPerGame = hasApps ? ((player.goals + player.assists) / player.apps).toFixed(2) : "0.00";

  let html = `
    <div style="margin-bottom: 20px;">
      <button onclick="showPlayerStats()" class="btn-secondary" style="margin-bottom: 15px;">
        ← Back to Statistics
      </button>
    </div>
    
    <div class="group-card">
      <div class="group-title">👤 Player Profile - ${player.name}</div>
      <div style="padding: 25px;">
        <div style="display: grid; grid-template-columns: auto 1fr; gap: 30px; align-items: start;">
          <div style="text-align: center;">
            <div style="font-size: 4em; margin-bottom: 10px;">👤</div>
            <div style="background: #3b82f6; color: white; padding: 5px 15px; border-radius: 20px; font-weight: bold;">
              ${player.team}
            </div>
          </div>
          
          <div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
              <div style="text-align: center; background: rgba(59, 130, 246, 0.1); padding: 15px; border-radius: 8px;">
                <div style="font-size: 0.9em; color: #6b7280;">Apps</div>
                <div style="font-size: 1.8em; font-weight: bold; color: #3b82f6;">${player.apps || 0}</div>
              </div>
              <div style="text-align: center; background: rgba(239, 68, 68, 0.1); padding: 15px; border-radius: 8px;">
                <div style="font-size: 0.9em; color: #6b7280;">Goals</div>
                <div style="font-size: 1.8em; font-weight: bold; color: #ef4444;">${player.goals || 0}</div>
              </div>
              <div style="text-align: center; background: rgba(16, 185, 129, 0.1); padding: 15px; border-radius: 8px;">
                <div style="font-size: 0.9em; color: #6b7280;">Assists</div>
                <div style="font-size: 1.8em; font-weight: bold; color: #10b981;">${player.assists || 0}</div>
              </div>
              <div style="text-align: center; background: rgba(245, 158, 11, 0.1); padding: 15px; border-radius: 8px;">
                <div style="font-size: 0.9em; color: #6b7280;">Rating</div>
                <div style="font-size: 1.8em; font-weight: bold; color: #f59e0b;">${player.avgRating ? player.avgRating.toFixed(1) : "N/A"}</div>
              </div>
            </div>
            
            ${(player.apps || 0) > 0 ? `
              <div style="background: rgba(15, 23, 42, 0.8); padding: 15px; border-radius: 8px; margin-top: 15px;">
                <div style="font-weight: bold; margin-bottom: 10px; color: #e5e7eb;">📊 Performance Metrics</div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                  <div>Goals per game: <strong>${goalsPerGame}</strong></div>
                  <div>Contributions per game: <strong>${contribPerGame}</strong></div>
                  ${player.minutes ? `<div>Minutes played: <strong>${player.minutes}</strong></div>` : ""}
                </div>
              </div>
            ` : ""}
          </div>
        </div>
      </div>
    </div>
  `;
  
  out.innerHTML = html;
}

function exportPlayerStats() {
  const playersWithData = Object.values(PLAYER_DB).filter(p => p.apps > 0);
  if (playersWithData.length === 0) {
    showUtilityMessage("No player stats to export yet.", "info");
    return;
  }

  const header = "Player,Team,Goals,Assists,Apps,Goals/Game,Rating\n";
  const rows = playersWithData.map(p => {
    const apps = p.apps || 0;
    const goals = p.goals || 0;
    const assists = p.assists || 0;
    const goalsPerGame = apps > 0 ? (goals / apps).toFixed(2) : "0.00";
    const rating = p.avgRating != null ? p.avgRating : "N/A";
    return `"${p.name}","${p.team}",${goals},${assists},${apps},${goalsPerGame},${rating}`;
  });

  const csvContent = "data:text/csv;charset=utf-8," + header + rows.join("\n");
  
  const encodedUri = encodeURI(csvContent);
  const link = document.createElement("a");
  link.setAttribute("href", encodedUri);
  link.setAttribute("download", "player_statistics.csv");
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

function exportBracketData() {
  if (!window.TOURNAMENT) {
    showUtilityMessage("No tournament bracket data to export yet.", "info");
    return;
  }
  
  let csvContent = "data:text/csv;charset=utf-8,Round,TeamA,TeamB,ScoreA,ScoreB,AggScoreA,AggScoreB,Winner\n";
  
  const rounds = [
    { name: "Round of 32", data: window.TOURNAMENT.roundOf32 },
    { name: "Round of 16", data: window.TOURNAMENT.roundOf16 },
    { name: "Quarter Finals", data: window.TOURNAMENT.quarterFinals },
    { name: "Semi Finals", data: window.TOURNAMENT.semiFinals },
    { name: "Final", data: window.TOURNAMENT.final ? [window.TOURNAMENT.final] : [] }
  ];
  
  rounds.forEach(round => {
    if (round.data) {
      round.data.forEach(match => {
        if (!match) return;

        if (round.name === "Final") {
          const finalMatch = match.matchDetails || match;
          csvContent += `"${round.name}","${match.teamA.name}","${match.teamB.name}",${finalMatch.scoreA},${finalMatch.scoreB},,,${match.winner.name}\n`;
        } else {
          csvContent += `"${round.name}","${match.teamA.name}","${match.teamB.name}",${match.firstLeg.scoreA},${match.firstLeg.scoreB},${match.aggScoreA},${match.aggScoreB},${match.winner.name}\n`;
        }
      });
    }
  });
  
  const encodedUri = encodeURI(csvContent);
  const link = document.createElement("a");
  link.setAttribute("href", encodedUri);
  link.setAttribute("download", "tournament_bracket.csv");
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}
function toggleStatsView() {
  const currentMode = window.STATS_VIEW_MODE || 'detailed';
  window.STATS_VIEW_MODE = currentMode === 'detailed' ? 'compact' : 'detailed';
  showPlayerStats();
}
/**
 * NOTE:
 * We already inject table styles via `injectAllStyles()` in another chunk.
 * Make sure any older standalone style injection for .table-container / .standings-table
 * is removed so you don't double-inject CSS.
 */
/************* ENHANCED CUSTOM MATCH FUNCTIONS *************/
function populateCustomMatchDropdowns() {
  const teamSelect1 = document.getElementById('customTeamA');
  const teamSelect2 = document.getElementById('customTeamB');

  if (!teamSelect1 || !teamSelect2) {
    console.error('❌ Custom match dropdowns not found in DOM');
    return;
  }

  // Get teams from either DRAWN_TEAMS or TEAM_POOL
  let availableTeams = [];

  if (window.DRAWN_TEAMS && window.DRAWN_TEAMS.length > 0) {
    availableTeams = window.DRAWN_TEAMS;
    console.log(`✅ Using ${availableTeams.length} drawn teams for custom match`);
  } else if (window.TEAM_POOL && window.TEAM_POOL.length > 0) {
    availableTeams = window.TEAM_POOL;
    console.log(`✅ Using ${availableTeams.length} teams from TEAM_POOL for custom match`);
  } else if (typeof TEAM_POOL !== 'undefined' && TEAM_POOL.length > 0) {
    availableTeams = TEAM_POOL;
    console.log(`✅ Using ${availableTeams.length} teams from global TEAM_POOL for custom match`);
  }

  if (availableTeams.length === 0) {
    console.error('❌ No teams available for custom match');
    showUtilityMessage('No teams available. Please generate groups first.', 'warning');
    return;
  }
  
  // Clear existing options except the placeholder
  teamSelect1.innerHTML = '<option value="">-- Select Team A --</option>';
  teamSelect2.innerHTML = '<option value="">-- Select Team B --</option>';
  
  // Sort teams alphabetically
  const sortedTeams = [...availableTeams].sort((a, b) => {
    const nameA = a.name || 'Unknown';
    const nameB = b.name || 'Unknown';
    return nameA.localeCompare(nameB);
  });
  
  // Add options with proper validation
  sortedTeams.forEach(team => {
    if (!team || !team.name) return; // Skip invalid teams
    
    const teamName = team.name;
    const teamSeason = team.season || 'Unknown Era';
    
    // Create option with clean display text
    const option1 = document.createElement('option');
    option1.value = teamName;
    option1.textContent = `${teamName} (${teamSeason})`;
    teamSelect1.appendChild(option1);
    
    const option2 = document.createElement('option');
    option2.value = teamName;
    option2.textContent = `${teamName} (${teamSeason})`;
    teamSelect2.appendChild(option2);
  });
  
  console.log(`✅ Custom match dropdowns populated with ${sortedTeams.length} teams`);
}
function updateTeamComparison() {
  const teamASelect = document.getElementById("customTeamA");
  const teamBSelect = document.getElementById("customTeamB");
  const comparisonDiv = document.getElementById("teamComparison");
  
  if (!teamASelect || !teamBSelect || !comparisonDiv) return;
  
  const teamAName = teamASelect.value;
  const teamBName = teamBSelect.value;
  
  if (!teamAName || !teamBName) {
    comparisonDiv.style.display = "none";
    return;
  }
  
  const teamA = TEAM_MAP.get(teamAName);
  const teamB = TEAM_MAP.get(teamBName);
  
  if (!teamA || !teamB) {
    comparisonDiv.style.display = "none";
    return;
  }
  
  const strengthA = calculateTeamOverallStrength(teamA);
  const strengthB = calculateTeamOverallStrength(teamB);
  const diff = Math.abs(strengthA - strengthB);
  
  let prediction = "⚔️ Evenly Matched";
  let predictionColor = "#6b7280";
  
  if (diff > 5) {
    const favorite = strengthA > strengthB ? teamA.name : teamB.name;
    prediction = `🏆 Favorite: ${favorite}`;
    predictionColor = "#f59e0b";
  }
  if (diff > 10) {
    prediction = `🎯 Strong Favorite: ${strengthA > strengthB ? teamA.name : teamB.name}`;
    predictionColor = "#ef4444";
  }
  
  comparisonDiv.innerHTML = `
    <div style="background: rgba(15, 23, 42, 0.8); padding: 15px; border-radius: 8px; margin: 10px 0;">
      <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 15px; align-items: center; text-align: center;">
        <div>
          <div style="font-weight: bold; color: #3b82f6;">${teamA.name}</div>
          <div style="font-size: 1.5em; color: #3b82f6;">⭐${strengthA}</div>
          <div style="font-size: 0.8em; color: #9ca3af;">${teamA.season}</div>
        </div>
        
        <div style="font-size: 1.2em; font-weight: bold; color: #e5e7eb;">VS</div>
        
        <div>
          <div style="font-weight: bold; color: #ef4444;">${teamB.name}</div>
          <div style="font-size: 1.5em; color: #ef4444;">⭐${strengthB}</div>
          <div style="font-size: 0.8em; color: #9ca3af;">${teamB.season}</div>
        </div>
      </div>
      
      <div style="text-align: center; margin-top: 10px; padding: 8px; background: ${predictionColor}20; border-radius: 6px; border-left: 3px solid ${predictionColor};">
        <strong style="color: ${predictionColor};">${prediction}</strong>
        <div style="font-size: 0.8em; color: #9ca3af; margin-top: 3px;">
          Strength difference: ${diff} points
        </div>
      </div>
    </div>
  `;
  comparisonDiv.style.display = "block";
}

/************* SMALL SHARED HELPERS *************/

function injectStylesOnce(id, css) {
  if (!css) return;
  if (id && document.getElementById(id)) return;
  const el = document.createElement("style");
  if (id) el.id = id;
  el.textContent = css;
  document.head.appendChild(el);
}

// Ensure global DB objects exist (safety)
window.MATCH_DETAILS_DB = window.MATCH_DETAILS_DB || {};
window.PLAYER_DB = window.PLAYER_DB || {};
window.CLUB_LEGACY_DB = window.CLUB_LEGACY_DB || {
  champions: {},
  finals: {},
  semiFinals: {},
  quarterFinals: {},
  totalWins: {}
};
window.ALL_TIME_PLAYER_DB = window.ALL_TIME_PLAYER_DB || {};
window.RNG_SETTINGS = window.RNG_SETTINGS || {
  groupChaos: 1.0,
  knockoutChaos: 1.2,
  finalChaos: 0.8
};
window.TEAM_MAP = window.TEAM_MAP || new Map();
window.TEAM_POOL = window.TEAM_POOL || [];
window.LAST_CUSTOM_MATCH_ID = window.LAST_CUSTOM_MATCH_ID || null;

/************* CUSTOM MATCH SIMULATOR *************/

function simulateCustomMatch_OLD3() {
  const teamASelect = document.getElementById("customTeamA");
  const teamBSelect = document.getElementById("customTeamB");
  const resultDiv = document.getElementById("customMatchResult");
  const venueSelect = document.getElementById("customVenue");
  const matchImportance = document.getElementById("matchImportance");
  const weatherSelect = document.getElementById("weatherCondition");

  if (!teamASelect || !teamBSelect || !resultDiv) return;

  const teamAName = teamASelect.value;
  const teamBName = teamBSelect.value;

  if (!teamAName || !teamBName) {
    showCustomMatchError("Please select both teams");
    return;
  }

  const teamA = TEAM_MAP.get(teamAName);
  const teamB = TEAM_MAP.get(teamBName);
  
  if (!teamA || !teamB) {
    showCustomMatchError("Selected teams not found in database");
    return;
  }
  
  // Determine venue and home advantage
  let isHome = true;
  let venueType = "homeA";
  
  if (venueSelect) {
    venueType = venueSelect.value;
    switch (venueType) {
      case "homeA":
        isHome = true;
        break;
      case "homeB":
        isHome = false;
        break;
      case "random":
        isHome = Math.random() > 0.5;
        venueType = isHome ? "homeA" : "homeB";
        break;
      default:
        isHome = true; // neutral (treated as A for now)
        break;
    }
  }
  
  // Get match importance
  const importance = matchImportance ? parseFloat(matchImportance.value) || 1.0 : 1.0;
  
  // Get weather condition (for now: visual only)
  const weather = weatherSelect ? weatherSelect.value : "normal";
  
  // Simulate the match (weather is currently cosmetic)
  const match = simulateMatch(teamA, teamB, isHome, importance, weather);
  const matchDetails = MATCH_DETAILS_DB[match.matchId] || {};
  const potg = matchDetails.playerOfTheGame;
  
  // Remember last custom match for saving
  window.LAST_CUSTOM_MATCH_ID = match.matchId;
  
  // Generate match analysis
  const analysis = analyzeCustomMatch(match, teamA, teamB, matchDetails);
  
  displayCustomMatchResult(match, teamA, teamB, potg, analysis, venueType, importance, weather);
  
  // Update match history log (console)
  updateCustomMatchHistory(match, teamA, teamB);
}

function displayCustomMatchResult(match, teamA, teamB, potg, analysis, venueType, importance, weather) {
  const resultDiv = document.getElementById("customMatchResult");
  if (!resultDiv) return;
  
  const venueText = getVenueText(venueType, teamA.name, teamB.name);
  const importanceText = getImportanceText(importance);
  const weatherText = getWeatherText(weather);
  
  resultDiv.innerHTML = `
    <div class="custom-match-result">
      <div class="match-header" style="background: linear-gradient(135deg, #1e3a8a, #3730a3); padding: 25px; border-radius: 12px 12px 0 0; text-align: center; color: white;">
        <h3 style="margin: 0 0 10px 0; color: white; font-size: 1.4em;">🎯 Custom Match Result</h3>
        <div style="display: flex; justify-content: center; gap: 20px; font-size: 0.9em; color: #d1d5db;">
          <span>${venueText}</span>
          <span>•</span>
          <span>${importanceText}</span>
          <span>•</span>
          <span>${weatherText}</span>
        </div>
      </div>
      
      <div style="padding: 30px; background: rgba(15, 23, 42, 0.9);">
        <!-- Team Lineup -->
        <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 25px; align-items: center; margin-bottom: 25px;">
          <div style="text-align: right;">
            <div style="font-weight: bold; font-size: 1.3em; color: #3b82f6; margin-bottom: 5px;">${teamA.name}</div>
            <div style="color: #9ca3af; font-size: 0.9em;">${teamA.season} • OVR ${calculateTeamOverallStrength(teamA)}</div>
          </div>
          
          <div style="text-align: center; background: #1f2937; padding: 15px 25px; border-radius: 10px; border: 2px solid #374151;">
            <div class="custom-match-score" style="font-size: 2.5em; font-weight: bold; color: white;">
              ${match.scoreA} - ${match.scoreB}
            </div>
            <div style="font-size: 1em; color: #d1d5db; margin-top: 5px;">
              ${getMatchResultText(teamA.name, teamB.name, match.scoreA, match.scoreB)}
            </div>
          </div>
          
          <div style="text-align: left;">
            <div style="font-weight: bold; font-size: 1.3em; color: #ef4444; margin-bottom: 5px;">${teamB.name}</div>
            <div style="color: #9ca3af; font-size: 0.9em;">${teamB.season} • OVR ${calculateTeamOverallStrength(teamB)}</div>
          </div>
        </div>
        
        <!-- Player of the Game -->
        ${potg ? `
          <div class="potg-card" style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(217, 119, 6, 0.15)); padding: 20px; border-radius: 10px; margin: 20px 0; border: 1px solid #f59e0b;">
            <div style="display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 10px;">
              <span style="font-size: 2em;">⭐</span>
              <div>
                <div style="font-weight: bold; color: #f59e0b; font-size: 1.2em;">Player of the Game</div>
                <div style="color: #e5e7eb; font-size: 1.1em;">${potg.player}</div>
              </div>
            </div>
            <div style="display: flex; justify-content: center; gap: 25px; font-size: 0.95em;">
              <div>Rating: <strong>${potg.rating}/10</strong></div>
              ${potg.goals > 0 ? `<div>${potg.goals} goal${potg.goals > 1 ? "s" : ""}</div>` : ""}
              ${potg.assists > 0 ? `<div>${potg.assists} assist${potg.assists > 1 ? "s" : ""}</div>` : ""}
              ${potg.cleanSheet ? `<div>🚫 Clean Sheet</div>` : ""}
            </div>
          </div>
        ` : ""}
        
        <!-- Match Analysis -->
        <div class="analysis-card" style="background: rgba(30, 41, 59, 0.8); padding: 20px; border-radius: 10px; margin: 20px 0; border-left: 4px solid #8b5cf6;">
          <div style="font-weight: bold; color: #e5e7eb; margin-bottom: 15px; font-size: 1.1em;">📊 Match Analysis</div>
          <div style="color: #d1d5db; line-height: 1.6;">
            ${analysis}
          </div>
        </div>
        
        <!-- Match Statistics -->
        <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-top: 20px;">
          <div style="text-align: center; background: rgba(59, 130, 246, 0.1); padding: 15px; border-radius: 8px;">
            <div style="font-size: 0.9em; color: #6b7280;">Total Goals</div>
            <div style="font-size: 1.5em; font-weight: bold; color: #3b82f6;">${match.scoreA + match.scoreB}</div>
          </div>
          <div style="text-align: center; background: rgba(16, 185, 129, 0.1); padding: 15px; border-radius: 8px;">
            <div style="font-size: 0.9em; color: #6b7280;">Match Importance</div>
            <div style="font-size: 1.5em; font-weight: bold; color: #10b981;">${importance}x</div>
          </div>
          <div style="text-align: center; background: rgba(245, 158, 11, 0.1); padding: 15px; border-radius: 8px;">
            <div style="font-size: 0.9em; color: #6b7280;">Venue</div>
            <div style="font-size: 1.1em; font-weight: bold; color: #f59e0b;">${venueText.split(" ")[0]}</div>
          </div>
          <div style="text-align: center; background: rgba(139, 92, 246, 0.1); padding: 15px; border-radius: 8px;">
            <div style="font-size: 0.9em; color: #6b7280;">Weather</div>
            <div style="font-size: 1.1em; font-weight: bold; color: #8b5cf6;">${weatherText}</div>
          </div>
        </div>
        
        <!-- Action Buttons -->
        <div style="display: flex; gap: 10px; margin-top: 25px; justify-content: center;">
          <button onclick="simulateRematch()" class="btn-secondary" style="padding: 10px 20px;">
            🔄 Simulate Rematch
          </button>
          <button onclick="saveCustomMatch()" class="btn-secondary" style="padding: 10px 20px;">
            💾 Save Match
          </button>
          <button onclick="shareMatchResult()" class="btn-secondary" style="padding: 10px 20px;">
            📤 Share Result
          </button>
        </div>
      </div>
    </div>
  `;
}

function analyzeCustomMatch(match, teamA, teamB, matchDetails) {
  const scoreA = match.scoreA;
  const scoreB = match.scoreB;
  const totalGoals = scoreA + scoreB;
  const goalDifference = Math.abs(scoreA - scoreB);
  
  let analysis = "";
  
  // Match type analysis
  if (totalGoals === 0) {
    analysis = "A defensive stalemate where both teams canceled each other out. Neither side could break through the opposition's defense in a tightly contested match.";
  } else if (totalGoals >= 5) {
    analysis = "An offensive spectacle with plenty of goalmouth action. Both teams showed attacking intent in an entertaining, end-to-end encounter.";
  } else if (goalDifference >= 3) {
    analysis = "A dominant performance from the winning side who controlled the game from start to finish. The losing team struggled to cope with the quality and intensity.";
  } else if (goalDifference === 1) {
    analysis = "A closely fought contest that could have gone either way. Small margins made the difference in this competitive encounter.";
  } else {
    analysis = "A balanced match where both teams had their moments. The result reflects an even contest between two well-matched sides.";
  }
  
  // Add team-specific analysis
  const strengthA = calculateTeamOverallStrength(teamA);
  const strengthB = calculateTeamOverallStrength(teamB);
  
  if (Math.abs(strengthA - strengthB) > 10) {
    if ((strengthA > strengthB && scoreA > scoreB) || (strengthB > strengthA && scoreB > scoreA)) {
      analysis += " The stronger team justified their favorite status with a professional performance.";
    } else if (scoreA !== scoreB) {
      analysis += " In a surprising turn of events, the underdog defied the odds to secure a memorable victory.";
    }
  }
  
  // Add dramatic elements for close matches
  if (goalDifference === 1 && totalGoals >= 3) {
    analysis += " The match featured dramatic momentum shifts and could have easily ended differently.";
  }
  
  return analysis;
}

function simulateRematch_LEGACY() {
  const teamASelect = document.getElementById("customTeamA");
  const teamBSelect = document.getElementById("customTeamB");
  const venueSelect = document.getElementById("customVenue");

  if (!teamASelect || !teamBSelect) return;

  const teamAName = teamASelect.value;
  const teamBName = teamBSelect.value;
  
  if (!teamAName || !teamBName) return;
  
  // Switch venues for rematch if not neutral
  if (venueSelect && venueSelect.value !== "neutral") {
    venueSelect.value = venueSelect.value === "homeA" ? "homeB" : "homeA";
  }
  
  simulateCustomMatch();
}

function saveCustomMatch() {
  if (!window.LAST_CUSTOM_MATCH_ID) {
    showCustomMatchMessage("No custom match to save yet.", "info");
    return;
  }

  const latestMatch = MATCH_DETAILS_DB[window.LAST_CUSTOM_MATCH_ID];
  if (!latestMatch) {
    showCustomMatchMessage("Could not find the last custom match in the database.", "error");
    return;
  }

  const savedMatches = JSON.parse(localStorage.getItem("savedCustomMatches") || "[]");
  savedMatches.push({
    ...latestMatch,
    savedAt: new Date().toISOString(),
    id: "custom_" + Date.now()
  });
  
  localStorage.setItem("savedCustomMatches", JSON.stringify(savedMatches));
  showCustomMatchMessage("Match saved successfully!", "success");
}

function shareMatchResult() {
  const teamASelect = document.getElementById("customTeamA");
  const teamBSelect = document.getElementById("customTeamB");
  
  if (!teamASelect || !teamBSelect) return;
  
  const teamAName = teamASelect.value;
  const teamBName = teamBSelect.value;
  
  const resultDiv = document.getElementById("customMatchResult");
  if (!resultDiv) return;
  
  const scoreElement = resultDiv.querySelector(".custom-match-score");
  
  if (scoreElement) {
    const scoreText = scoreElement.textContent.trim();
    const shareText = `⚽ Custom Match Result: ${teamAName} ${scoreText} ${teamBName}`;
    
    navigator.clipboard.writeText(shareText).then(() => {
      showCustomMatchMessage("Match result copied to clipboard!", "success");
    }).catch(() => {
      showCustomMatchMessage("Failed to copy result to clipboard.", "error");
    });
  }
}

function showCustomMatchHistory() {
  const savedMatches = JSON.parse(localStorage.getItem("savedCustomMatches") || "[]");
  const out = document.getElementById("output");
  
  if (!out) return;
  
  let html = `
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h2>📋 Saved Custom Matches</h2>
      ${savedMatches.length > 0 ? `
        <button onclick="clearCustomMatchHistory()" class="btn-secondary" style="padding: 8px 12px;">
          🗑️ Clear History
        </button>
      ` : ""}
    </div>
  `;
  
  if (savedMatches.length === 0) {
    html += `
      <div class="group-card">
        <div class="group-title">No Saved Matches</div>
        <div style="padding: 40px; text-align: center;">
          <div style="font-size: 64px; margin-bottom: 20px;">⚽</div>
          <p style="font-size: 1.2em; margin-bottom: 10px;"><strong>No custom matches saved yet</strong></p>
          <p style="color: #9ca3af; margin-bottom: 20px;">Simulate custom matches and save them to view them here.</p>
          <button onclick="showCustomMatchInterface()" class="btn-primary">Simulate Custom Match</button>
        </div>
      </div>
    `;
  } else {
    html += `<div class="group-card"><div class="group-title">Match History (${savedMatches.length} matches)</div>`;
    
    savedMatches.slice().reverse().forEach(match => {
      const date = match.savedAt ? new Date(match.savedAt).toLocaleDateString() : "";
      
      html += `
        <div style="background: rgba(15, 23, 42, 0.8); padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 4px solid #3b82f6;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <div style="font-weight: bold; font-size: 1.1em;">
              ${match.teamA} ${match.scoreA} - ${match.scoreB} ${match.teamB}
            </div>
            <div style="color: #9ca3af; font-size: 0.9em;">${date}</div>
          </div>
          
          ${match.playerOfTheGame ? `
            <div style="color: #f59e0b; font-size: 0.9em;">
              ⭐ ${match.playerOfTheGame.player} (${match.playerOfTheGame.rating}/10)
            </div>
          ` : ""}
          
          <div style="display: flex; gap: 10px; margin-top: 10px;">
            <button onclick="replaySavedMatch('${match.id}')" class="btn-secondary" style="padding: 5px 10px; font-size: 0.8em;">
              🔄 Replay
            </button>
            <button onclick="deleteSavedMatch('${match.id}')" class="btn-secondary" style="padding: 5px 10px; font-size: 0.8em; background: #ef4444;">
              🗑️ Delete
            </button>
          </div>
        </div>
      `;
    });
    
    html += `</div>`;
  }
  
  out.innerHTML = html;
}

// Helper functions
function getVenueText(venueType, teamA, teamB) {
  switch (venueType) {
    case "homeA": return `🏠 Home: ${teamA}`;
    case "homeB": return `🏠 Home: ${teamB}`;
    case "random": return "🎲 Random Venue";
    default: return "🏟️ Neutral Venue";
  }
}

function getImportanceText(importance) {
  if (importance >= 2.0) return "🔥 High Importance";
  if (importance >= 1.5) return "⚡ Medium Importance";
  return "💤 Normal Match";
}

function getWeatherText(weather) {
  const weatherMap = {
    normal: "☀️ Normal",
    rainy: "🌧️ Rainy",
    windy: "💨 Windy",
    snow: "❄️ Snow"
  };
  return weatherMap[weather] || "☀️ Normal";
}

function getMatchResultText(teamAName, teamBName, scoreA, scoreB) {
  if (scoreA > scoreB) return `${teamAName} win`;
  if (scoreA < scoreB) return `${teamBName} win`;
  return "Draw";
}

function showCustomMatchError(message) {
  const resultDiv = document.getElementById("customMatchResult");
  if (!resultDiv) return;
  resultDiv.innerHTML = `
    <div style="color: #ef4444; padding: 15px; background: #fef2f2; border-radius: 8px; border-left: 4px solid #ef4444;">
      <div style="display: flex; align-items: center; gap: 10px;">
        <span style="font-size: 1.2em;">⚠️</span>
        <strong>${message}</strong>
      </div>
    </div>
  `;
}

function showCustomMatchMessage(message, type = "info") {
  const colors = {
    success: "#10b981",
    error: "#ef4444",
    info: "#3b82f6"
  };
  
  const resultDiv = document.getElementById("customMatchResult");
  if (!resultDiv) return;
  
  const color = colors[type] || colors.info;
  
  const messageDiv = document.createElement("div");
  messageDiv.innerHTML = `
    <div style="color: ${color}; padding: 12px; background: ${color}20; border-radius: 6px; border-left: 4px solid ${color}; margin-top: 10px;">
      <strong>${message}</strong>
    </div>
  `;
  
  resultDiv.appendChild(messageDiv);
  
  setTimeout(() => {
    if (messageDiv.parentNode) {
      messageDiv.parentNode.removeChild(messageDiv);
    }
  }, 3000);
}

function updateCustomMatchHistory(match, teamA, teamB) {
  if (window.VERBOSE_LOGGING) console.log(`Custom match recorded: ${teamA.name} ${match.scoreA}-${match.scoreB} ${teamB.name}`);
}

// Initialize custom match interface
function initializeCustomMatchInterface() {
  if (typeof populateCustomMatchDropdowns === "function") {
    populateCustomMatchDropdowns();
  }

  const customMatchStyles = `
    .custom-match-result {
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
      margin-top: 20px;
    }
    
    .potg-card {
      transition: transform 0.2s;
    }
    
    .potg-card:hover {
      transform: translateY(-2px);
    }
    
    .analysis-card {
      border-left: 4px solid #8b5cf6;
    }
    
    .stats-grid > div {
      transition: all 0.3s ease;
    }
    
    .stats-grid > div:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
    
    @media (max-width: 768px) {
      .custom-match-result .match-header div {
        flex-direction: column;
        gap: 5px;
      }
      
      .stats-grid {
        grid-template-columns: 1fr 1fr;
      }
    }
  `;
  
  injectStylesOnce("custom-match-styles", customMatchStyles);
}
/************* ENHANCED EXPORT/IMPORT FUNCTIONS *************/

function showExportPreviewModal(tournamentData, exportStr) {
  const modal = document.createElement('div');
  modal.className = 'modal-overlay';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  `;
  
  const encoded = btoa(unescape(encodeURIComponent(exportStr)));
  
  modal.innerHTML = `
    <div style="background: #1f2937; border-radius: 12px; padding: 25px; max-width: 90vw; max-height: 90vh; width: 600px; overflow-y: auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="margin: 0; color: #e5e7eb;">📤 Export Tournament Data</h3>
        <button onclick="this.closest('.modal-overlay').remove()" 
                style="background: none; border: none; color: #9ca3af; font-size: 1.5em; cursor: pointer;">×</button>
      </div>
      
      <div style="background: #374151; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 15px;">
          <div style="text-align: center;">
            <div style="font-size: 0.9em; color: #9ca3af;">Tournament</div>
            <div style="font-weight: bold; color: #3b82f6;">${tournamentData.metadata.tournamentName}</div>
          </div>
          <div style="text-align: center;">
            <div style="font-size: 0.9em; color: #9ca3af;">Matches</div>
            <div style="font-weight: bold; color: #10b981;">${tournamentData.metadata.totalMatches}</div>
          </div>
          <div style="text-align: center%;">
            <div style="font-size: 0.9em; color: #9ca3af;">Players</div>
            <div style="font-weight: bold; color: #f59e0b;">${tournamentData.metadata.totalPlayers}</div>
          </div>
          <div style="text-align: center;">
            <div style="font-size: 0.9em; color: #9ca3af;">Size</div>
            <div style="font-weight: bold; color: #8b5cf6;">${formatFileSize(tournamentData.metadata.exportSize)}</div>
          </div>
        </div>
        
        <div style="background: #4b5563; padding: 10px; border-radius: 6px; font-family: monospace; font-size: 0.8em; color: #d1d5db; max-height: 150px; overflow-y: auto;">
          ${exportStr.substring(0, 500)}...
        </div>
      </div>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
        <button onclick="downloadTournamentExport('${encoded}')" 
                class="btn-primary" style="padding: 12px;">
          💾 Download JSON
        </button>
        <button onclick="copyExportToClipboard('${encoded}')" 
                class="btn-secondary" style="padding: 12px;">
          📋 Copy to Clipboard
        </button>
      </div>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
        <button onclick="exportTournamentCSV()" class="btn-secondary" style="padding: 10px; font-size: 0.9em;">
          📊 Export CSV
        </button>
        <button onclick="exportTournamentSummary()" class="btn-secondary" style="padding: 10px; font-size: 0.9em;">
          📄 Export Summary
        </button>
        <button onclick="backupToLocalStorage()" class="btn-secondary" style="padding: 10px; font-size: 0.9em;">
          💾 Auto Backup
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
}

function downloadTournamentExport(encodedData) {
  try {
    const exportStr = decodeURIComponent(escape(atob(encodedData)));
    const dataBlob = new Blob([exportStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `tournament-${getTournamentName().toLowerCase().replace(/\s+/g, '-')}-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    
    showExportMessage("Tournament data downloaded successfully!", "success");
    document.querySelector('.modal-overlay')?.remove();
  } catch (error) {
    showExportMessage("Error downloading export: " + error.message, "error");
  }
}

function copyExportToClipboard(encodedData) {
  try {
    const exportStr = decodeURIComponent(escape(atob(encodedData)));
    navigator.clipboard.writeText(exportStr).then(() => {
      showExportMessage("Tournament data copied to clipboard!", "success");
      document.querySelector('.modal-overlay')?.remove();
    }).catch(err => {
      showExportMessage("Failed to copy to clipboard: " + err.message, "error");
    });
  } catch (error) {
    showExportMessage("Error copying export: " + error.message, "error");
  }
}

function exportTournamentCSV() {
  if (!window.TOURNAMENT && !window.GROUP_RESULTS) {
    showExportMessage("No tournament data available for CSV export", "error");
    return;
  }
  
  try {
    let csvContent = "data:text/csv;charset=utf-8,";
    
    // Export match results
    csvContent += "MATCH RESULTS\n";
    csvContent += "Match ID,Team A,Team B,Score A,Score B,Venue,Importance,Date\n";
    
    Object.values(MATCH_DETAILS_DB).forEach(match => {
      const venue = match.venue || "";
      const importance = match.importance ?? 1;
      const ts = match.timestamp || "";
      csvContent += `"${match.matchId}","${match.teamA}","${match.teamB}",${match.scoreA},${match.scoreB},"${venue}",${importance},"${ts}"\n`;
    });
    
    csvContent += "\nPLAYER STATISTICS\n";
    csvContent += "Player,Team,Goals,Assists,Apps,Avg Rating\n";
    
    Object.values(PLAYER_DB).filter(p => p.apps > 0).forEach(player => {
      csvContent += `"${player.name}","${player.team}",${player.goals},${player.assists},${player.apps},${player.avgRating || 0}\n`;
    });
    
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement('a');
    link.href = encodedUri;
    link.download = `tournament-stats-${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showExportMessage("CSV data exported successfully!", "success");
  } catch (error) {
    showExportMessage("Error exporting CSV: " + error.message, "error");
  }
}

function exportTournamentSummary() {
  const summary = generateTournamentSummary();
  const dataBlob = new Blob([summary], { type: 'text/plain' });
  const url = URL.createObjectURL(dataBlob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `tournament-summary-${new Date().toISOString().split('T')[0]}.txt`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
  
  showExportMessage("Tournament summary exported!", "success");
}

function generateTournamentSummary() {
  let summary = `TOURNAMENT SUMMARY\n`;
  summary += `Generated: ${new Date().toLocaleString()}\n`;
  summary += `========================================\n\n`;
  
  if (window.TOURNAMENT?.champion) {
    summary += `🏆 CHAMPION: ${window.TOURNAMENT.champion.name}\n`;
    summary += `Season: ${window.TOURNAMENT.champion.season} | OVR: ${window.TOURNAMENT.champion.strength}\n\n`;
  }
  
  const playersWithData = Object.values(PLAYER_DB).filter(p => p.apps > 0);
  if (playersWithData.length > 0) {
   const topScorers = [...playersWithData]
  .sort((a, b) => b.goals - a.goals)
  .slice(0, viewMode === 'compact' ? 10 : 15);
    summary += `TOP SCORERS:\n`;
    topScorers.forEach((player, index) => {
      summary += `${index + 1}. ${player.name} (${player.team}) - ${player.goals} goals\n`;
    });
    summary += `\n`;
  }
  
  const matches = Object.values(MATCH_DETAILS_DB);
  if (matches.length > 0) {
    summary += `MATCH STATISTICS:\n`;
    const totalGoals = matches.reduce((sum, m) => sum + m.scoreA + m.scoreB, 0);
    summary += `Total Matches: ${matches.length}\n`;
    summary += `Total Goals: ${totalGoals}\n`;
    summary += `Average Goals per Match: ${(totalGoals / matches.length).toFixed(2)}\n`;
  }
  
  return summary;
}

function backupToLocalStorage() {
  try {
    const backupData = {
      groups: window.GROUPS,
      groupResults: window.GROUP_RESULTS,
      knockoutResults: window.TOURNAMENT,
      matchDetails: MATCH_DETAILS_DB,
      playerStats: PLAYER_DB,
      clubLegacy: CLUB_LEGACY_DB,
      allTimeStats: ALL_TIME_PLAYER_DB,
      backupDate: new Date().toISOString()
    };
    
    localStorage.setItem('tournamentBackup', JSON.stringify(backupData));
    showExportMessage("Tournament automatically backed up to browser storage!", "success");
  } catch (error) {
    showExportMessage("Backup failed: " + error.message, "error");
  }
}

function restoreFromBackup() {
  try {
    const backupData = localStorage.getItem('tournamentBackup');
    if (!backupData) {
      showExportMessage("No backup found in local storage", "error");
      return;
    }
    showImportConfirmationModal(backupData);
  } catch (error) {
    showExportMessage("Error restoring backup: " + error.message, "error");
  }
}

function showImportConfirmationModal(backupData) {
  const modal = document.createElement('div');
  modal.className = 'modal-overlay';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  `;
  
  const data = JSON.parse(backupData);
  const backupDate = new Date(data.backupDate).toLocaleString();
  const encoded = btoa(backupData);
  
  modal.innerHTML = `
    <div style="background: #1f2937; border-radius: 12px; padding: 25px; max-width: 500px; width: 90vw;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="margin: 0; color: #e5e7eb;">🔄 Restore Backup</h3>
        <button onclick="this.closest('.modal-overlay').remove()" 
                style="background: none; border: none; color: #9ca3af; font-size: 1.5em; cursor: pointer;">×</button>
      </div>
      
      <div style="background: #374151; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
        <div style="color: #e5e7eb; margin-bottom: 10px;">
          <strong>Backup Date:</strong> ${backupDate}
        </div>
        <div style="color: #d1d5db; font-size: 0.9em;">
          This will replace your current tournament data. Make sure to export your current progress if needed.
        </div>
      </div>
      
      <div style="display: flex; gap: 10px; justify-content: flex-end;">
        <button onclick="this.closest('.modal-overlay').remove()" 
                class="btn-secondary" style="padding: 10px 20px;">
          Cancel
        </button>
        <button onclick="confirmRestoreBackup('${encoded}')" 
                class="btn-primary" style="padding: 10px 20px; background: #10b981;">
          ✅ Restore
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
}

function confirmRestoreBackup(encodedData) {
  try {
    const backupData = JSON.parse(atob(encodedData));
    importTournamentData(backupData, "local backup");
    document.querySelector('.modal-overlay')?.remove();
  } catch (error) {
    showExportMessage("Error restoring backup: " + error.message, "error");
  }
}

function validateAndImportData(data, fileName) {
  if (!data.metadata || data.metadata.dataType !== "football-tournament") {
    showExportMessage("Invalid tournament file format.", "error");
    return;
  }
  showImportDetailsModal(data, fileName);
}

function showImportDetailsModal(data, fileName) {
  const modal = document.createElement('div');
  modal.className = 'modal-overlay';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  `;
  
  const exportDate = new Date(data.metadata.exportDate).toLocaleString();
  const encoded = btoa(JSON.stringify(data));
  
  modal.innerHTML = `
    <div style="background: #1f2937; border-radius: 12px; padding: 25px; max-width: 500px; width: 90vw;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="margin: 0; color: #e5e7eb;">📥 Import Tournament</h3>
        <button onclick="this.closest('.modal-overlay').remove()" 
                style="background: none; border: none; color: #9ca3af; font-size: 1.5em; cursor: pointer;">×</button>
      </div>
      
      <div style="background: #374151; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
        <div style="color: #e5e7eb; margin-bottom: 8px;">
          <strong>File:</strong> ${fileName}
        </div>
        <div style="color: #e5e7eb; margin-bottom: 8px;">
          <strong>Tournament:</strong> ${data.metadata.tournamentName}
        </div>
        <div style="color: #e5e7eb; margin-bottom: 8px;">
          <strong>Exported:</strong> ${exportDate}
        </div>
        <div style="color: #e5e7eb; margin-bottom: 8px;">
          <strong>Matches:</strong> ${data.metadata.totalMatches}
        </div>
        <div style="color: #e5e7eb;">
          <strong>Players:</strong> ${data.metadata.totalPlayers}
        </div>
      </div>
      
      <div style="background: #ef4444; padding: 12px; border-radius: 6px; margin-bottom: 20px;">
        <div style="color: white; font-weight: bold; display: flex; align-items: center; gap: 8px;">
          ⚠️ Warning
        </div>
        <div style="color: #fecaca; font-size: 0.9em; margin-top: 5px;">
          This will replace your current tournament data. Export your current progress first if needed.
        </div>
      </div>
      
      <div style="display: flex; gap: 10px; justify-content: flex-end;">
        <button onclick="this.closest('.modal-overlay').remove()" 
                class="btn-secondary" style="padding: 10px 20px;">
          Cancel
        </button>
        <button onclick="confirmImport('${encoded}')" 
                class="btn-primary" style="padding: 10px 20px; background: #10b981;">
          ✅ Import Data
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
}

function confirmImport(encodedData) {
  try {
    const data = JSON.parse(atob(encodedData));
    importTournamentData(data, "file import");
    document.querySelector('.modal-overlay')?.remove();
  } catch (error) {
    showExportMessage("Error importing data: " + error.message, "error");
  }
}

function importTournamentData(data, source) {
  try {
    clearExistingData();
    
    if (data.groups) window.GROUPS = data.groups;
    if (data.groupResults) window.GROUP_RESULTS = data.groupResults;
    if (data.knockoutResults) window.TOURNAMENT = data.knockoutResults;
    if (data.matchDetails) Object.assign(MATCH_DETAILS_DB, data.matchDetails);
    if (data.playerStats) Object.assign(PLAYER_DB, data.playerStats);
    if (data.clubLegacy) Object.assign(CLUB_LEGACY_DB, data.clubLegacy);
    if (data.allTimeStats) Object.assign(ALL_TIME_PLAYER_DB, data.allTimeStats);
    
    if (window.TOURNAMENT && typeof renderKnockoutResults === 'function') {
      renderKnockoutResults(window.TOURNAMENT);
      if (typeof showTournamentBracket === 'function') showTournamentBracket();
    } else if (window.GROUP_RESULTS && typeof renderGroupResults === 'function') {
      renderGroupResults(window.GROUP_RESULTS);
      if (typeof showGroupStageResults === 'function') showGroupStageResults();
    } else if (window.GROUPS && typeof renderGroups === 'function') {
      renderGroups(window.GROUPS);
    } else if (typeof showTournamentOverview === 'function') {
      showTournamentOverview();
    }
    
    backupToLocalStorage();
    
    showExportMessage(`✅ Tournament data imported successfully from ${source}!`, "success");
    
    console.log(`Import successful: ${Object.keys(MATCH_DETAILS_DB).length} matches, ${Object.keys(PLAYER_DB).length} players`);
    
  } catch (error) {
    console.error("Import error:", error);
    showExportMessage("Error importing tournament data: " + error.message, "error");
  }
}

function clearExistingData() {
  window.GROUPS = null;
  window.GROUP_RESULTS = null;
  window.TOURNAMENT = null;
  window.MATCH_DETAILS_DB = {};
  window.PLAYER_DB = {};
  window.CLUB_LEGACY_DB = { 
    champions: {}, 
    finals: {}, 
    semiFinals: {}, 
    quarterFinals: {}, 
    totalWins: {} 
  };
  window.ALL_TIME_PLAYER_DB = {};
}

function getTournamentName() {
  if (window.TOURNAMENT?.champion) {
    return `${window.TOURNAMENT.champion.season} Tournament`;
  }
  return "Football Tournament";
}

function formatFileSize(bytes) {
  if (!bytes) return '0 Bytes';
  const k = 1024;
  const sizes = ['Bytes', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// getCustomMatchesHistory is defined later with enhanced implementation (line 31206)
function getCustomMatchesHistory_SIMPLE() {
  try {
    return JSON.parse(localStorage.getItem('savedCustomMatches') || '[]');
  } catch {
    return [];
  }
}

function showExportMessage(message, type = "info") {
  const existingMessages = document.querySelectorAll('.export-message');
  existingMessages.forEach(msg => msg.remove());
  
  const colors = {
    success: '#10b981',
    error: '#ef4444',
    info: '#3b82f6',
    warning: '#f59e0b'
  };
  
  const messageDiv = document.createElement('div');
  messageDiv.className = 'export-message';
  messageDiv.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: ${colors[type]}20;
    color: ${colors[type]};
    padding: 12px 20px;
    border-radius: 8px;
    border-left: 4px solid ${colors[type]};
    z-index: 1001;
    max-width: 400px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    animation: slideIn 0.3s ease-out;
  `;
  
  messageDiv.innerHTML = `
    <div style="display: flex; align-items: center; gap: 10px;">
      <span style="font-size: 1.2em;">${type === 'success' ? '✅' : type === 'error' ? '❌' : 'ℹ️'}</span>
      <strong>${message}</strong>
    </div>
  `;
  
  document.body.appendChild(messageDiv);
  
  setTimeout(() => {
    if (messageDiv.parentNode) {
      messageDiv.style.animation = 'slideOut 0.3s ease-in';
      setTimeout(() => messageDiv.remove(), 300);
    }
  }, 5000);
}

const exportStyles = `
  @keyframes slideIn {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }
  
  @keyframes slideOut {
    from {
      transform: translateX(0);
      opacity: 1;
    }
    to {
      transform: translateX(100%);
      opacity: 0;
    }
  }
  
  .export-message {
    font-family: system-ui, -apple-system, sans-serif;
  }
`;

injectStylesOnce('export-message-styles', exportStyles);

// Initialize auto-backup on page load for export/import features
function initializeExportFeatures() {
  // Check for existing backup and offer to restore
  const hasBackup = localStorage.getItem('tournamentBackup');
  if (hasBackup && !window.TOURNAMENT && !window.GROUP_RESULTS) {
    setTimeout(() => {
      if (confirm('A previous tournament backup was found. Would you like to restore it?')) {
        restoreFromBackup();
      }
    }, 1000);
  }
  
  // Periodic auto-backup (every 5 minutes)
  setInterval(() => {
    if (window.TOURNAMENT || window.GROUP_RESULTS) {
      backupToLocalStorage();
    }
  }, 5 * 60 * 1000);
}

// Enhanced export / import main handlers (wrappers)
function enhancedExportTournament() {
  if (typeof exportTournament === 'function') {
    exportTournament();
  } else {
    showExportMessage("exportTournament() is not implemented", "error");
  }
}

function enhancedHandleImport() {
  if (typeof handleImport === 'function') {
    handleImport();
  } else {
    showExportMessage("handleImport() is not implemented", "error");
  }
}
/************* RESET / UTILITIES / THEME / RNG *************/
function showResetConfirmationModal() {
  const hasData =
    window.GROUPS ||
    window.GROUP_RESULTS ||
    window.TOURNAMENT ||
    Object.keys(PLAYER_DB).length > 0;

  if (!hasData) {
    showUtilityMessage('No tournament data to reset', 'info');
    return;
  }

  const modal = document.createElement('div');
  modal.className = 'modal-backdrop';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    /* backdrop-filter removed for performance */
  `;

  const matchCount = Object.keys(MATCH_DETAILS_DB).length;
  const playerCount = Object.values(PLAYER_DB).filter(p => p.apps > 0).length;

  modal.innerHTML = `
    <div style="background: linear-gradient(135deg, #1f2937, #111827); border-radius: 12px; padding: 25px; max-width: 500px; width: 90vw; border: 2px solid #ef4444; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);">
      <div style="text-align: center; margin-bottom: 20px;">
        <div style="font-size: 4em; margin-bottom: 10px;">⚠️</div>
        <h3 style="margin: 0; color: #ef4444; font-size: 1.6em;">Reset Tournament?</h3>
      </div>
      
      <div style="background: rgba(239, 68, 68, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ef4444;">
        <div style="color: #fecaca; font-size: 0.95em; line-height: 1.6;">
          <strong style="color: #ef4444;">⚠️ Warning:</strong> This will permanently delete all tournament progress including:
          <ul style="margin: 10px 0; padding-left: 20px;">
            <li>${matchCount} match results</li>
            <li>${playerCount} player statistics</li>
            <li>Group stage and knockout brackets</li>
            <li>All current tournament data</li>
          </ul>
          <div style="margin-top: 10px; padding: 10px; background: rgba(239, 68, 68, 0.2); border-radius: 4px;">
            <strong>Note:</strong> Your all-time club legacy and historical records will be preserved.
          </div>
        </div>
      </div>
      
      <div style="display: flex; gap: 10px; justify-content: space-between;">
        <button onclick="exportTournament(); this.closest('.modal-backdrop').remove()" 
                class="btn-secondary" style="padding: 12px 20px; flex: 1; background: linear-gradient(135deg, #3b82f6, #2563eb);">
          💾 Export First
        </button>
        <button onclick="this.closest('.modal-backdrop').remove()" 
                class="btn-secondary" style="padding: 12px 20px; flex: 1;">
          ❌ Cancel
        </button>
        <button onclick="performReset(); this.closest('.modal-backdrop').remove()" 
                class="btn-primary" style="padding: 12px 20px; flex: 1; background: linear-gradient(135deg, #ef4444, #dc2626);">
          🗑️ Reset Now
        </button>
      </div>
    </div>
  `;

  document.body.appendChild(modal);
}

function performReset() {
  createPreResetBackup();

  window.GROUPS = null;
  window.GROUP_RESULTS = null;
  window.TOURNAMENT = null;

  Object.keys(PLAYER_DB).forEach(key => delete PLAYER_DB[key]);
  Object.keys(MATCH_DETAILS_DB).forEach(key => delete MATCH_DETAILS_DB[key]);

  window.LAST_SIMULATION_DATE = null;
  window.TOURNAMENT_FORMAT = null;

  const out = document.getElementById('output');
  if (out) {
    out.innerHTML = `
      <div class="empty-state" style="text-align: center; padding: 60px 20px;">
        <div style="font-size: 80px; margin-bottom: 20px; opacity: 0.7;">⚽️</div>
        <h2 style="color: #e5e7eb; margin-bottom: 15px; font-size: 2em;">Tournament Reset</h2>
        <p style="color: #9ca3af; font-size: 1.1em; margin-bottom: 30px; max-width: 400px; margin-left: auto; margin-right: auto;">
          Ready to start a new all-eras tournament adventure. Your all-time records are preserved.
        </p>
        <button class="ctrl-btn" id="generateGroupsBtn" onclick="handleGenerateGroups()">
  <div class="ctrl-btn-main">
    <span class="ctrl-btn-title">Generate Groups</span>
    <span class="ctrl-btn-subtitle">Draw all 16 groups from seeded pots</span>
  </div>
  <span class="ctrl-btn-tag">Draw</span>
</button>
      </div>
    `;
  }

  updateButtonStates();
  showUtilityMessage('Tournament reset successfully. All-time records preserved.', 'success');
  if (window.VERBOSE_LOGGING) console.log('Tournament reset performed. Current season data cleared.');
}

function createPreResetBackup() {
  try {
    // Clear old backup first to prevent growth
    localStorage.removeItem('preResetBackup');

    // Store only essential data, not full match logs or player stats
    const backupData = {
      champion: window.TOURNAMENT?.champion || null,
      groupCount: window.GROUPS?.length || 0,
      matchCount: window.MATCH_SCHEDULE?.groupStage?.length || 0,
      backupDate: new Date().toISOString(),
      type: 'pre-reset-backup'
    };

    localStorage.setItem('preResetBackup', JSON.stringify(backupData));
    console.log('✅ Slim backup created successfully');
  } catch (error) {
    console.warn('Backup skipped (quota):', error.message);
    // Don't block reset if backup fails
  }
}

function restorePreResetBackup() {
  try {
    const backupData = localStorage.getItem('preResetBackup');
    if (backupData) {
      const data = JSON.parse(backupData);
      showRestoreBackupModal(data);
    } else {
      showUtilityMessage('No recent backup found to restore.', 'info');
    }
  } catch (error) {
    showUtilityMessage('Error restoring backup: ' + error.message, 'error');
  }
}

function toggleTheme() {
  const body = document.body;
  const isLight = body.classList.toggle('light');

  const themeBtn = document.getElementById('themeToggle');
  if (themeBtn) {
    themeBtn.textContent = isLight ? '🌙 Dark' : '☀️ Light';
  }

  localStorage.setItem('theme', isLight ? 'light' : 'dark');
  applyThemeToCustomElements(isLight);
}

function applyThemeToCustomElements(isLight) {
  const root = document.documentElement;
  if (isLight) {
    root.style.setProperty('--bg-primary', '#ffffff');
    root.style.setProperty('--bg-secondary', '#f8fafc');
    root.style.setProperty('--text-primary', '#1f2937');
    root.style.setProperty('--text-secondary', '#6b7280');
    root.style.setProperty('--border-color', '#e5e7eb');
  } else {
    root.style.setProperty('--bg-primary', '#1f2937');
    root.style.setProperty('--bg-secondary', '#111827');
    root.style.setProperty('--text-primary', '#f9fafb');
    root.style.setProperty('--text-secondary', '#d1d5db');
    root.style.setProperty('--border-color', '#374151');
  }
}

// initializeTheme is defined earlier in the file at line ~10011

/************* RNG SYSTEM (CLEANED / MERGED) *************/

function applyRNGLevel(rawValue) {
  const v = Math.max(0.3, Math.min(2.0, parseFloat(rawValue) || 1.0));

  RNG_SETTINGS.groupChaos = v;
  RNG_SETTINGS.knockoutChaos = v * 1.2;
  RNG_SETTINGS.finalChaos = v * 0.8;

  updateRNGVisualization(v);
  localStorage.setItem('rngLevel', v.toString());

  const previousLevel = window.lastRNGLevel || 1.0;
  if (Math.abs(v - previousLevel) > 0.2) {
    showRNGChangeMessage(v);
  }
  window.lastRNGLevel = v;
}

function updateRNGVisualization(value) {
  const label = document.getElementById('rngLabel');
  const labelMini = document.getElementById('rngLabelMini');
  const slider = document.getElementById('rngSlider');
  const indicator = document.getElementById('rngIndicator');

  let txt, description, color, emoji;

  if (value <= 0.6) {
    txt = 'Predictable';
    description = 'Favourites usually win, few surprises';
    color = '#10b981';
    emoji = '🎯';
  } else if (value <= 1.0) {
    txt = 'Balanced';
    description = 'Mix of expected results and mild upsets';
    color = '#3b82f6';
    emoji = '⚖️';
  } else if (value <= 1.3) {
    txt = 'Chaotic';
    description = 'Regular surprises and upsets';
    color = '#f59e0b';
    emoji = '🎲';
  } else if (value <= 1.7) {
    txt = 'Wild';
    description = 'Frequent major upsets and shock results';
    color = '#ef4444';
    emoji = '🌪️';
  } else {
    txt = 'Extreme';
    description = 'Complete unpredictability, anything can happen';
    color = '#8b5cf6';
    emoji = '💥';
  }

  if (label) {
    label.innerHTML = `
      <span style="color: ${color}; font-weight: bold;">${emoji} ${txt}</span>
      <div style="font-size: 0.8em; color: #9ca3af; margin-top: 4px;">${description}</div>
    `;
  }

  if (labelMini) {
    labelMini.innerHTML = `<span style="color: ${color};">${emoji} ${txt}</span>`;
  }

  if (slider) {
    slider.style.background = 'linear-gradient(90deg, #10b981 0%, #f59e0b 50%, #ef4444 100%)';
  }

  if (indicator) {
    indicator.style.width = `${((value - 0.3) / 1.7) * 100}%`;
    indicator.style.background = color;
  }

  updateRNGEffectDescriptions(value);
}

function updateRNGEffectDescriptions(value) {
  const effectsContainer = document.getElementById('rngEffects');
  if (!effectsContainer) return;

  const groupEffect = Math.round((value - 1) * 100);
  const knockoutEffect = Math.round((value * 1.2 - 1) * 100);
  const finalEffect = Math.round((value * 0.8 - 1) * 100);

  effectsContainer.innerHTML = `
    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 15px; font-size: 0.8em;">
      <div style="text-align: center; background: rgba(59, 130, 246, 0.1); padding: 8px; border-radius: 6px;">
        <div style="color: #6b7280;">Group Stage</div>
        <div style="color: #3b82f6; font-weight: bold;">${groupEffect > 0 ? '+' : ''}${groupEffect}%</div>
      </div>
      <div style="text-align: center; background: rgba(245, 158, 11, 0.1); padding: 8px; border-radius: 6px;">
        <div style="color: #6b7280;">Knockouts</div>
        <div style="color: #f59e0b; font-weight: bold;">${knockoutEffect > 0 ? '+' : ''}${knockoutEffect}%</div>
      </div>
      <div style="text-align: center; background: rgba(16, 185, 129, 0.1); padding: 8px; border-radius: 6px;">
        <div style="color: #6b7280;">Final</div>
        <div style="color: #10b981; font-weight: bold;">${finalEffect > 0 ? '+' : ''}${finalEffect}%</div>
      </div>
    </div>
  `;
}

function getRNGLevelText(value) {
  if (value <= 0.7) return 'Predictable';
  if (value <= 1.0) return 'Balanced';
  if (value <= 1.3) return 'Chaotic';
  return 'Wild';
}

// Tab switching functionality
function switchTab(tabName) {
  // Remove active class from all tabs and tab contents
  document.querySelectorAll('.sidebar-tab').forEach(tab => {
    tab.classList.remove('active');
  });
  document.querySelectorAll('.tab-content').forEach(content => {
    content.classList.remove('active');
  });

  // Add active class to selected tab and content
  const selectedTab = document.querySelector(`.sidebar-tab[data-tab="${tabName}"]`);
  const selectedContent = document.getElementById(`tab-${tabName}`);

  if (selectedTab) selectedTab.classList.add('active');
  if (selectedContent) selectedContent.classList.add('active');
}

function updateRNG(value) {
  const numericValue = parseFloat(value);
  applyRNGLevel(numericValue);
}

function showRNGChangeMessage(level) {
  const messages = {
    low: 'Predictable mode: Favourites will dominate',
    balanced: 'Balanced mode: Realistic mix of results',
    high: 'Chaotic mode: Expect surprises and upsets',
    extreme: 'Insane mode: Complete chaos - anything goes!'
  };

  let message;
  if (level <= 0.6) message = messages.low;
  else if (level <= 1.0) message = messages.balanced;
  else if (level <= 1.5) message = messages.high;
  else message = messages.extreme;

  showUtilityMessage(`🎲 RNG Level Updated: ${message}`, 'success');
}

function initializeRNG() {
  const savedLevel = localStorage.getItem('rngLevel') || '1.0';
  const slider = document.getElementById('rngSlider');

  if (slider) {
    slider.value = savedLevel;
    applyRNGLevel(savedLevel);

    slider.addEventListener('input', e => {
      updateRNG(e.target.value);
    });
    slider.addEventListener('change', e => {
      updateRNG(e.target.value);
    });
  }

  // Fix RNG preset buttons
  document.querySelectorAll('.rng-pill').forEach(btn => {
    const newBtn = btn.cloneNode(true);
    btn.parentNode.replaceChild(newBtn, btn);

    newBtn.addEventListener('click', function () {
      const value = parseFloat(this.getAttribute('data-rng-value') || '1.0');
      document.querySelectorAll('.rng-pill').forEach(p => p.classList.remove('active'));
      this.classList.add('active');

      const sliderEl = document.getElementById('rngSlider');
      if (sliderEl) {
        sliderEl.value = value;
        updateRNG(value);
      }
    });
  });
}

const utilityStyles = `
  @keyframes slideUp {
    from {
      transform: translateX(-50%) translateY(100%);
      opacity: 0;
    }
    to {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }
  }
  
  @keyframes slideDown {
    from {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }
    to {
      transform: translateX(-50%) translateY(100%);
      opacity: 0;
    }
  }
  
  .rng-pill {
    transition: all 0.2s ease;
    cursor: pointer;
  }
  
  .rng-pill.active {
    background: #3b82f6 !important;
    color: white !important;
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4);
  }
  
  .rng-pill:hover:not(.active) {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  }
  
  #rngSlider {
    background: linear-gradient(90deg, #10b981 0%, #f59e0b 50%, #ef4444 100%);
    height: 6px;
    border-radius: 3px;
    outline: none;
    transition: all 0.3s ease;
  }
  
  #rngSlider::-webkit-slider-thumb {
    appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #ffffff;
    border: 2px solid #3b82f6;
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
    transition: all 0.2s ease;
  }
  
  #rngSlider::-webkit-slider-thumb:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
  }
`;

injectStylesOnce('utility-styles', utilityStyles);
function updateButtonStates() {
  const buttons = {
    draw: document.getElementById('btnDraw'),
    group: document.getElementById('btnGroupStage'),
    ko: document.getElementById('btnKnockouts'),
    stats: document.getElementById('btnStats'),
    allMatches: document.getElementById('btnAllMatches'),
    matchWeeks: document.getElementById('btnMatchWeeks'),
    bracket: document.getElementById('btnBracket'),
    simpleBracket: document.getElementById('btnSimpleBracket'),
    overview: document.getElementById('btnOverview'),
    clubLegacy: document.getElementById('btnClubLegacy'),
    customMatch: document.getElementById('btnCustomMatch'),
    history: document.getElementById('btnHistory')
  };

  const hasGroups = window.GROUPS;
  const hasGroupResults = window.GROUP_RESULTS;
  const hasTournament = window.TOURNAMENT;
  const hasMatches = Object.keys(MATCH_DETAILS_DB).length > 0;

  // Draw button - always enabled
  if (buttons.draw) {
    buttons.draw.disabled = false;
  }

  // Group stage button - enabled after draw
  if (buttons.group) {
    buttons.group.disabled = !hasGroups;
    buttons.group.title = hasGroups ? 'Simulate group stage matches' : 'Generate groups first';
  }

  // Knockout button - enabled after group stage
  if (buttons.ko) {
    buttons.ko.disabled = !hasGroupResults;
    buttons.ko.title = hasGroupResults ? 'Simulate knockout stage' : 'Complete group stage first';
  }

  // Stats button - enabled after any matches
  if (buttons.stats) {
    buttons.stats.disabled = !hasMatches;
    buttons.stats.title = hasMatches ? 'View player statistics' : 'Simulate matches first';
  }

  // All matches button - enabled after any matches
  if (buttons.allMatches) {
    buttons.allMatches.disabled = !hasMatches;
    buttons.allMatches.title = hasMatches ? 'View all match results' : 'Simulate matches first';
  }

  // Matchdays button - enabled after group stage
  if (buttons.matchWeeks) {
    const hasSchedule = (MATCH_SCHEDULE.groupStage && MATCH_SCHEDULE.groupStage.length > 0) ||
                        (MATCH_SCHEDULE.knockoutStage && MATCH_SCHEDULE.knockoutStage.length > 0);
    buttons.matchWeeks.disabled = !hasSchedule;
    buttons.matchWeeks.title = hasSchedule ? 'View matches by week' : 'Simulate matches first';
  }

  // Bracket button - enabled after tournament complete
  if (buttons.bracket) {
    buttons.bracket.disabled = !hasTournament;
    buttons.bracket.title = hasTournament ? 'View tournament bracket' : 'Complete tournament first';
  }

  // Simple Bracket button - enabled after tournament complete
  if (buttons.simpleBracket) {
    buttons.simpleBracket.disabled = !hasTournament;
    buttons.simpleBracket.title = hasTournament ? 'View simple bracket' : 'Complete tournament first';
  }

  // Club legacy, custom match, history - always enabled
  if (buttons.clubLegacy) buttons.clubLegacy.disabled = false;
  if (buttons.customMatch) buttons.customMatch.disabled = false;
  if (buttons.history) buttons.history.disabled = false;

  // Apply visual styling
  Object.values(buttons).forEach(btn => {
    if (btn) {
      if (btn.disabled) {
        btn.style.opacity = '0.5';
        btn.style.cursor = 'not-allowed';
      } else {
        btn.style.opacity = '1';
        btn.style.cursor = 'pointer';
      }
    }
  });
}

function showUtilityMessage(message, type = 'info') {
  const existingMessages = document.querySelectorAll('.utility-message');
  existingMessages.forEach(msg => msg.remove());

  const colors = {
    success: '#10b981',
    error: '#ef4444',
    info: '#3b82f6',
    warning: '#f59e0b'
  };

  const icons = {
    success: '✅',
    error: '❌',
    info: 'ℹ️',
    warning: '⚠️'
  };

  const messageDiv = document.createElement('div');
  messageDiv.className = 'utility-message';
  messageDiv.style.cssText = `
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: ${colors[type]}20;
    color: ${colors[type]};
    padding: 12px 20px;
    border-radius: 8px;
    border: 1px solid ${colors[type]}40;
    z-index: 1001;
    max-width: 400px;
    text-align: center;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    /* backdrop-filter removed for performance */
    animation: slideUp 0.3s ease-out;
  `;

  messageDiv.innerHTML = `
    <div style="display: flex; align-items: center; gap: 10px; justify-content: center;">
      <span style="font-size: 1.2em;">${icons[type]}</span>
      <strong>${message}</strong>
    </div>
  `;

  document.body.appendChild(messageDiv);

  setTimeout(() => {
    if (messageDiv.parentNode) {
      messageDiv.style.animation = 'slideDown 0.3s ease-in';
      setTimeout(() => messageDiv.remove(), 300);
    }
  }, 4000);
}

// Loading Overlay Functions
function showLoading(text = "Working...") {
  const overlay = document.getElementById("loadingOverlay");
  if (!overlay) return;

  const textEl = document.getElementById("loadingText");
  const progressEl = document.getElementById("loadingProgress");

  if (textEl) textEl.textContent = text;
  if (progressEl) progressEl.textContent = "";

  overlay.classList.add("active");
}

function updateLoadingProgress(done, total) {
  const progressEl = document.getElementById("loadingProgress");
  if (progressEl) {
    progressEl.textContent = `${done}/${total} matches`;
  }
}

function hideLoading() {
  const overlay = document.getElementById("loadingOverlay");
  if (overlay) {
    overlay.classList.remove("active");
  }
}

function updateKnockoutProgress(roundName, done, total) {
  const progressEl = document.getElementById("loadingProgress");
  if (progressEl) {
    if (total > 0) {
      progressEl.textContent = `${roundName}: ${done}/${total} matches`;
    } else {
      progressEl.textContent = roundName;
    }
  }
}

function openCustomMatchModal(preselectA = null, preselectB = null) {
  if (window.VERBOSE_LOGGING) console.log('📋 Opening custom match modal...', { preselectA, preselectB });

  try {
    // Populate dropdowns first
    if (typeof populateCustomMatchDropdowns === 'function') {
      populateCustomMatchDropdowns();
    } else {
      console.warn('⚠️ populateCustomMatchDropdowns not available');
    }

    // Apply preselections if provided
    if (preselectA) {
      const selectA = document.getElementById('customTeamA');
      if (selectA) selectA.value = preselectA;
    }
    if (preselectB) {
      const selectB = document.getElementById('customTeamB');
      if (selectB) selectB.value = preselectB;
    }

    // Open the modal
    const modal = document.getElementById('customMatchModal');
    if (modal) {
      console.log('✅ Modal element found, opening...');

      // Make sure it's visible with high z-index - set immediately without animation
      modal.classList.add('active');
      modal.style.display = 'flex';
      modal.style.zIndex = '10000';
      modal.style.opacity = '1';
      modal.style.visibility = 'visible';

      // Ensure inner modal content is also visible
      const innerModal = modal.querySelector('.modal');
      if (innerModal) {
        innerModal.style.display = 'block';
        innerModal.style.opacity = '1';
        innerModal.style.visibility = 'visible';
      }

      console.log('✅ Custom match modal opened');
    } else {
      console.error('❌ customMatchModal element not found in DOM');
      showUtilityMessage('Custom match modal not found', 'error');
    }
  } catch (error) {
    console.error('❌ Error in openCustomMatchModal:', error);
    showUtilityMessage('Error opening custom match: ' + error.message, 'error');
  }
}

// Public wrapper for external calls
function openCustomMatch(preA = null, preB = null) {
  openCustomMatchModal(preA, preB);
}

// For Tools tab button (primary definition)
function showCustomMatchInterface() {
  openCustomMatch();
}

function simulateCustomMatchHandler_OLD() {
  const teamASelect = document.getElementById('customTeamA');
  const teamBSelect = document.getElementById('customTeamB');

  if (!teamASelect || !teamBSelect) {
    showUtilityMessage('❌ Team selection not found', 'error');
    return;
  }

  const teamAName = teamASelect.value;
  const teamBName = teamBSelect.value;

  if (!teamAName || !teamBName) {
    showUtilityMessage('⚠️ Please select both teams', 'warning');
    return;
  }

  if (teamAName === teamBName) {
    showUtilityMessage('⚠️ Please select different teams', 'warning');
    return;
  }

  // Find team objects
  const availableTeams = window.DRAWN_TEAMS || TEAM_POOL || [];
  const teamA = availableTeams.find(t => t.name === teamAName);
  const teamB = availableTeams.find(t => t.name === teamBName);

  if (!teamA || !teamB) {
    showUtilityMessage('❌ Team data not found', 'error');
    return;
  }

  // Simulate the match
  if (typeof simulateMatch === 'function') {
    if (window.VERBOSE_LOGGING) console.log(`⚽ Simulating: ${teamAName} vs ${teamBName}`);

    const result = simulateMatch(teamA, teamB, false, 1.0, 'clear');

    if (result && result.matchId) {
      // Close modal
      closeCustomMatch();

      // Show match details
      setTimeout(() => {
        viewMatchDetails(result.matchId);
      }, 300);

      showUtilityMessage(`✅ Match simulated: ${teamAName} ${result.scoreA} - ${result.scoreB} ${teamBName}`, 'success');
    }
  } else {
    showUtilityMessage('❌ Match simulation function not available', 'error');
  }
}

function runCustomMatch() {
  const teamAName = document.getElementById('customTeamA').value;
  const teamBName = document.getElementById('customTeamB').value;

  if (teamAName === teamBName) {
    showUtilityMessage('⚠️ Select different teams!', 'warning');
    return;
  }

  const teamA = window.DRAWN_TEAMS.find(t => t.name === teamAName);
  const teamB = window.DRAWN_TEAMS.find(t => t.name === teamBName);

  if (!teamA || !teamB) {
    showUtilityMessage('❌ Teams not found', 'error');
    return;
  }

  // Close modal first
  closeCustomMatch();
  
  if (window.VERBOSE_LOGGING) console.log(`🎮 Simulating: ${teamA.name} vs ${teamB.name}`);
  showUtilityMessage('⚽ Simulating match...', 'info');

  // Simulate with delay to prevent freezing
  setTimeout(() => {
    try {
      const result = simulateMatch(teamA, teamB, 1, 'Custom Match', 1);
      
      if (result && result.matchId) {
        showUtilityMessage(`✅ ${teamA.name} ${result.scoreA}-${result.scoreB} ${teamB.name}`, 'success');
        setTimeout(() => viewMatchDetails(result.matchId), 300);
      } else {
        showUtilityMessage('❌ Match simulation failed', 'error');
      }
    } catch (err) {
      console.error('❌ Custom match error:', err);
      showUtilityMessage('❌ Error: ' + err.message, 'error');
    }
  }, 100);
}

function updateComparisonPreview() {
  const teamAName = document.getElementById('customTeamA')?.value;
  const teamBName = document.getElementById('customTeamB')?.value;
  const preview = document.getElementById('comparisonPreview');
  
  if (preview && teamAName && teamBName && teamAName !== teamBName) {
    preview.innerHTML = updateTeamComparison(teamAName, teamBName) || '';
  }
}

function simulateCustomMatch_OLD2() {
  const teamAName = document.getElementById('customTeamA').value;
  const teamBName = document.getElementById('customTeamB').value;
  const matchType = document.getElementById('customMatchType').value;

  if (teamAName === teamBName) {
    showUtilityMessage('Please select different teams', 'warning');
    return;
  }

  const teamA = window.DRAWN_TEAMS.find(t => t.name === teamAName);
  const teamB = window.DRAWN_TEAMS.find(t => t.name === teamBName);

  if (!teamA || !teamB) {
    showUtilityMessage('Teams not found', 'error');
    return;
  }

  // Simulate the match
  const result = simulateMatch(teamA, teamB, 1, 'Custom Match', 1);

  // Close modal
  document.getElementById('customMatchModal').remove();

  // Show result
  viewMatchDetails(result.matchId);
  showUtilityMessage(`✅ Custom match simulated: ${teamA.name} ${result.scoreA}-${result.scoreB} ${teamB.name}`, 'success');
}

function openHistory(filter = null) {
  const modal = document.getElementById('historyModal');
  if (!modal) {
    console.error('History modal not found');
    showUtilityMessage('History feature not available', 'error');
    return;
  }

  const modalData = { filter };
  ModalManager.open('historyModal', modalData);

  if (typeof loadHistoryContent === 'function') {
    loadHistoryContent(filter);
  } else {
    // Load default history
    const body = document.getElementById('historyBody');
    if (body) {
      body.innerHTML = generateHistoryContent();
    }
  }

  if (typeof enhanceHistoryModal === 'function') {
    enhanceHistoryModal();
  }
}

function generateHistoryContent() {
  const history = TOURNAMENT_HISTORY || [];
  
  if (history.length === 0) {
    return `
      <div style="text-align: center; padding: 40px 20px;">
        <div style="font-size: 64px; margin-bottom: 20px;">📚</div>
        <p style="font-size: 1.2em; margin-bottom: 10px;"><strong>No Tournament History</strong></p>
        <p style="color: #9ca3af;">Complete tournaments to build your championship history.</p>
      </div>
    `;
  }

  let html = `
    <div style="padding: 20px;">
      <h3 style="margin: 0 0 15px 0; color: #e5e7eb;">Tournament Champions</h3>
  `;

  history.forEach((tournament, index) => {
    html += `
      <div class="history-card" style="margin-bottom: 10px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <div style="font-weight: bold; color: #fbbf24; font-size: 1.1em;">
              🏆 ${tournament.champion || 'Unknown'}
            </div>
            <div style="font-size: 0.85em; color: #9ca3af; margin-top: 2px;">
              Tournament #${index + 1} • ${new Date(tournament.date).toLocaleDateString()}
            </div>
          </div>
        </div>
      </div>
    `;
  });

  html += `</div>`;
  return html;
}

function openMatchDetail(matchId) {
  const match = MATCH_DETAILS_DB[matchId];
  if (!match) {
    showUtilityMessage('Match details not found', 'error');
    return;
  }

  const modal = document.getElementById('matchDetailModal');
  if (!modal) return;

  if (typeof populateMatchDetailModal === 'function') {
    populateMatchDetailModal(match);
  }

  ModalManager.open('matchDetailModal', { matchId });
}

function openSettings() {
  ModalManager.open('settingsModal');
  if (typeof populateSettingsModal === 'function') populateSettingsModal();
  if (typeof enhanceSettingsModal === 'function') enhanceSettingsModal();
}

function openStatistics() {
  ModalManager.open('statisticsModal');
  if (typeof populateStatisticsModal === 'function') populateStatisticsModal();
  if (typeof enhanceStatisticsModal === 'function') enhanceStatisticsModal();
}

function closeHistory() {
  ModalManager.close('historyModal');
}

function closeMatchDetail() {
  ModalManager.close('matchDetailModal');
}

function closeTeamDetail() {
  ModalManager.close('teamDetailModal');
}

function closeSettings() {
  ModalManager.close('settingsModal');
}

function closeStatistics() {
  ModalManager.close('statisticsModal');
}

// closeAllModals is defined earlier in the file - uses querySelectorAll approach

function populateMatchDetailModal(match) {
  const modal = document.getElementById('matchDetailModal');
  if (!modal) return;

  const potg = match.playerOfTheGame;
  const events = match.events || { goals: [] };

  let html = `
    <div class="modal-header">
      <h2>📊 Match Details</h2>
      <button class="modal-close" onclick="closeMatchDetail()" aria-label="Close match details">
        &times;
      </button>
    </div>
    
    <div class="modal-body">
      <div class="match-score-card">
        <div class="team-info">
          <div class="team-name">${match.teamA}</div>
          <div class="team-meta">${getTeamSeason(match.teamA)}</div>
        </div>
        
        <div class="score-display">
          <div class="score">${match.scoreA} - ${match.scoreB}</div>
          <div class="match-result">${getMatchResultType(match.scoreA, match.scoreB)}</div>
        </div>
        
        <div class="team-info">
          <div class="team-name">${match.teamB}</div>
          <div class="team-meta">${getTeamSeason(match.teamB)}</div>
        </div>
      </div>
      
      <div class="match-meta-info">
        <div class="meta-item">
          <span class="meta-label">🏟️ Venue:</span>
          <span class="meta-value">${match.venue || 'Neutral Ground'}</span>
        </div>
        <div class="meta-item">
          <span class="meta-label">📅 Date:</span>
          <span class="meta-value">${new Date(match.timestamp).toLocaleDateString()}</span>
        </div>
        <div class="meta-item">
          <span class="meta-label">🎯 Importance:</span>
          <span class="meta-value">${getImportanceBadge(match.importance || 1)}</span>
        </div>
      </div>
  `;

  // Add formation tactical display if available
  if (match.formationA && match.formationB) {
    const tacticalData = match.tacticalAdvantage || {};
    html += `
      <div class="tactical-section">
        <h3>⚔️ Tactical Setup</h3>
        <div class="formations-display">
          <div class="formation-team">
            <div class="formation-name">${match.teamA}</div>
            <div class="formation-value ${tacticalData.teamAOffensive ? 'offensive' : tacticalData.teamADefensive ? 'defensive' : 'balanced'}">
              ${FORMATIONS[match.formationA]?.name || match.formationA}
            </div>
            <div class="formation-style">
              ${tacticalData.teamAOffensive ? '⚔️ Attacking' : tacticalData.teamADefensive ? '🛡️ Defensive' : '⚖️ Balanced'}
            </div>
          </div>

          <div class="tactical-advantage">
            <div class="advantage-icon">📊</div>
            <div class="advantage-text">${tacticalData.advantage || 'Balanced'}</div>
          </div>

          <div class="formation-team">
            <div class="formation-name">${match.teamB}</div>
            <div class="formation-value ${tacticalData.teamBOffensive ? 'offensive' : tacticalData.teamBDefensive ? 'defensive' : 'balanced'}">
              ${FORMATIONS[match.formationB]?.name || match.formationB}
            </div>
            <div class="formation-style">
              ${tacticalData.teamBOffensive ? '⚔️ Attacking' : tacticalData.teamBDefensive ? '🛡️ Defensive' : '⚖️ Balanced'}
            </div>
          </div>
        </div>
      </div>
    `;
  }

  if (potg) {
    html += `
      <div class="potg-section">
        <h3>⭐ Player of the Game</h3>
        <div class="potg-card">
          <div class="potg-player">${potg.player}</div>
          <div class="potg-stats">
            <span class="rating">Rating: ${potg.rating}/10</span>
            ${potg.goals > 0 ? `<span class="goals">${potg.goals} goal${potg.goals > 1 ? 's' : ''}</span>` : ''}
            ${potg.assists > 0 ? `<span class="assists">${potg.assists} assist${potg.assists > 1 ? 's' : ''}</span>` : ''}
            ${potg.cleanSheet ? '<span class="clean-sheet">🚫 Clean Sheet</span>' : ''}
          </div>
        </div>
      </div>
    `;
  }

  if (events.goals && events.goals.length > 0) {
    html += `
      <div class="events-section">
        <h3>⏱️ Match Timeline</h3>
        <div class="events-timeline">
    `;

    events.goals.forEach(goal => {
      html += `
        <div class="timeline-event">
          <div class="event-minute">${goal.minute}'</div>
          <div class="event-icon">⚽</div>
          <div class="event-details">
            <div class="event-player">${goal.player}</div>
            <div class="event-team">${goal.team}</div>
            ${goal.assisted ? `<div class="event-assist">Assist: ${goal.assisted}</div>` : ''}
          </div>
        </div>
      `;
    });

    html += `</div></div>`;
  }

  html += `
    <div class="stats-section">
      <h3>📈 Match Statistics</h3>
      <div class="stats-grid">
        <div class="stat-item">
          <div class="stat-value">${match.scoreA + match.scoreB}</div>
          <div class="stat-label">Total Goals</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">${events.goals ? events.goals.length : 0}</div>
          <div class="stat-label">Goal Events</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">${match.importance || 1}x</div>
          <div class="stat-label">Importance</div>
        </div>
      </div>
    </div>
    
    <div class="modal-actions">
      <button class="btn-secondary" onclick="simulateRematchFromDetail('${match.teamA}', '${match.teamB}')">
        🔄 Simulate Rematch
      </button>
      <button class="btn-secondary copy-match-id" data-match-id="${match.matchId}">
        📋 Copy ID
      </button>
      <button class="btn-secondary" onclick="shareMatchDetails('${match.matchId}')">
        📤 Share Match
      </button>
    </div>
  `;

  modal.querySelector('.modal-content').innerHTML = html;
  enhanceMatchDetailModal();
}
function populateTeamDetailModal(team) {
  const modal = document.getElementById('teamDetailModal');
  if (!modal) return;

  const teamPlayers = Object.values(PLAYER_DB).filter(p => p.team === team.name);
  const topScorer = [...teamPlayers].sort((a, b) => b.goals - a.goals)[0];
  const topAssist = [...teamPlayers].sort((a, b) => b.assists - a.assists)[0];

  // Get key players from starting XI
  const keyPlayers = (team.startingXI || [])
    .sort((a, b) => (b.quality || 0) - (a.quality || 0))
    .slice(0, 2);

  // Determine country/league from team name
  const teamInfo = getTeamCountryInfo(team);

  let html = `
    <div class="modal-header">
      <h2>🏟️ Team Profile</h2>
      <button class="modal-close" onclick="closeTeamDetail()" aria-label="Close team details">
        &times;
      </button>
    </div>
    
    <div class="modal-body" style="padding: 20px;">
      <div class="team-header" style="text-align: center; margin-bottom: 20px;">
        <div style="font-size: 4em; margin-bottom: 10px;">${teamInfo.flag}</div>
        <h3 style="margin: 0; color: #e5e7eb; font-size: 1.8em;">${team.name}</h3>
        <div style="color: #9ca3af; font-size: 1em; margin-top: 5px;">
          ${teamInfo.country} • ${team.season}
        </div>
        <div style="margin-top: 8px;">
          <span style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 4px 12px; border-radius: 20px; font-weight: bold; font-size: 0.9em;">
            ⭐ Overall: ${calculateTeamOverallStrength(team)}
          </span>
        </div>
      </div>

      <div style="background: rgba(30, 41, 59, 0.5); border-radius: 10px; padding: 15px; margin-bottom: 15px; border: 1px solid #374151;">
        <h4 style="margin: 0 0 12px 0; color: #a7f3d0; font-size: 1.1em;">🌟 Key Players</h4>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
  `;

  keyPlayers.forEach(player => {
    if (!player) return;
    html += `
      <div style="background: rgba(15, 23, 42, 0.8); padding: 10px; border-radius: 8px; border-left: 3px solid #3b82f6;">
        <div style="font-weight: bold; color: #e5e7eb; font-size: 0.95em;">${player.name}</div>
        <div style="font-size: 0.8em; color: #9ca3af; margin-top: 2px;">${player.pos}</div>
        <div style="margin-top: 4px;">
          <span style="background: #3b82f6; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.75em; font-weight: bold;">
            OVR ${player.quality}
          </span>
        </div>
      </div>
    `;
  });

  html += `
        </div>
      </div>

      <div class="team-stats-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px;">
        <div style="text-align: center; background: rgba(59, 130, 246, 0.1); padding: 12px; border-radius: 8px;">
          <div style="font-size: 1.5em; font-weight: bold; color: #3b82f6;">${teamPlayers.length}</div>
          <div style="font-size: 0.75em; color: #9ca3af;">Players</div>
        </div>
        <div style="text-align: center; background: rgba(239, 68, 68, 0.1); padding: 12px; border-radius: 8px;">
          <div style="font-size: 1.5em; font-weight: bold; color: #ef4444;">${teamPlayers.reduce((sum, p) => sum + p.goals, 0)}</div>
          <div style="font-size: 0.75em; color: #9ca3af;">Goals</div>
        </div>
        <div style="text-align: center; background: rgba(16, 185, 129, 0.1); padding: 12px; border-radius: 8px;">
          <div style="font-size: 1.5em; font-weight: bold; color: #10b981;">${teamPlayers.reduce((sum, p) => sum + p.assists, 0)}</div>
          <div style="font-size: 0.75em; color: #9ca3af;">Assists</div>
        </div>
        <div style="text-align: center; background: rgba(245, 158, 11, 0.1); padding: 12px; border-radius: 8px;">
          <div style="font-size: 1.5em; font-weight: bold; color: #f59e0b;">${teamPlayers.reduce((sum, p) => sum + p.apps, 0)}</div>
          <div style="font-size: 0.75em; color: #9ca3af;">Apps</div>
        </div>
      </div>
  `;

  if (topScorer || topAssist) {
    html += `
      <div style="background: rgba(30, 41, 59, 0.5); border-radius: 10px; padding: 15px; border: 1px solid #374151;">
        <h4 style="margin: 0 0 10px 0; color: #a7f3d0; font-size: 1.1em;">🏅 Top Performers</h4>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
    `;

    if (topScorer && topScorer.goals > 0) {
      html += `
        <div style="background: rgba(239, 68, 68, 0.1); padding: 10px; border-radius: 8px; border-left: 3px solid #ef4444;">
          <div style="font-size: 0.75em; color: #ef4444; font-weight: bold; margin-bottom: 4px;">🥇 TOP SCORER</div>
          <div style="font-weight: bold; color: #e5e7eb;">${topScorer.name}</div>
          <div style="font-size: 1.3em; font-weight: bold; color: #ef4444; margin-top: 4px;">${topScorer.goals} goals</div>
        </div>
      `;
    }

    if (topAssist && topAssist.assists > 0) {
      html += `
        <div style="background: rgba(16, 185, 129, 0.1); padding: 10px; border-radius: 8px; border-left: 3px solid #10b981;">
          <div style="font-size: 0.75em; color: #10b981; font-weight: bold; margin-bottom: 4px;">🎯 TOP ASSISTER</div>
          <div style="font-weight: bold; color: #e5e7eb;">${topAssist.name}</div>
          <div style="font-size: 1.3em; font-weight: bold; color: #10b981; margin-top: 4px;">${topAssist.assists} assists</div>
        </div>
      `;
    }

    html += `</div></div>`;
  }

  html += `
      <div style="margin-top: 15px; display: flex; gap: 8px; justify-content: center;">
        <button onclick="openCustomMatch('${team.name}', '')" class="btn-secondary" style="padding: 8px 16px;">
          ⚽ Simulate Match
        </button>
        <button onclick="viewTeamPlayers('${team.name}')" class="btn-secondary" style="padding: 8px 16px;">
          👥 View Full Squad
        </button>
      </div>
    </div>
  `;

  const content = modal.querySelector('.modal-content');
  if (content) {
    content.innerHTML = html;
  }
}

function getTeamCountryInfo(team) {
  const teamName = team.name || '';
  const countryMap = {
    'Barcelona': { country: 'Spain', flag: '🇪🇸' },
    'Real Madrid': { country: 'Spain', flag: '🇪🇸' },
    'Atlético Madrid': { country: 'Spain', flag: '🇪🇸' },
    'Valencia': { country: 'Spain', flag: '🇪🇸' },
    'AC Milan': { country: 'Italy', flag: '🇮🇹' },
    'Inter Milan': { country: 'Italy', flag: '🇮🇹' },
    'Juventus': { country: 'Italy', flag: '🇮🇹' },
    'Roma': { country: 'Italy', flag: '🇮🇹' },
    'Napoli': { country: 'Italy', flag: '🇮🇹' },
    'Sampdoria': { country: 'Italy', flag: '🇮🇹' },
    'Bayern Munich': { country: 'Germany', flag: '🇩🇪' },
    'Borussia Dortmund': { country: 'Germany', flag: '🇩🇪' },
    'Bayer Leverkusen': { country: 'Germany', flag: '🇩🇪' },
    'Hamburg': { country: 'Germany', flag: '🇩🇪' },
    'Manchester United': { country: 'England', flag: '🏴󠁧󠁢󠁥󠁮󠁧󠁿' },
    'Manchester City': { country: 'England', flag: '🏴󠁧󠁢󠁥󠁮󠁧󠁿' },
    'Liverpool': { country: 'England', flag: '🏴󠁧󠁢󠁥󠁮󠁧󠁿' },
    'Chelsea': { country: 'England', flag: '🏴󠁧󠁢󠁥󠁮󠁧󠁿' },
    'Arsenal': { country: 'England', flag: '🏴󠁧󠁢󠁥󠁮󠁧󠁿' },
    'Nottingham Forest': { country: 'England', flag: '🏴󠁧󠁢󠁥󠁮󠁧󠁿' },
    'Aston Villa': { country: 'England', flag: '🏴󠁧󠁢󠁥󠁮󠁧󠁿' },
    'Ajax': { country: 'Netherlands', flag: '🇳🇱' },
    'PSV Eindhoven': { country: 'Netherlands', flag: '🇳🇱' },
    'Feyenoord': { country: 'Netherlands', flag: '🇳🇱' },
    'Porto': { country: 'Portugal', flag: '🇵🇹' },
    'Benfica': { country: 'Portugal', flag: '🇵🇹' },
    'Marseille': { country: 'France', flag: '🇫🇷' },
    'Celtic': { country: 'Scotland', flag: '🏴󠁧󠁢󠁳󠁣󠁴󠁿' },
    'Red Star Belgrade': { country: 'Serbia', flag: '🇷🇸' },
    'Steaua București': { country: 'Romania', flag: '🇷🇴' },
    'Galatasaray': { country: 'Turkey', flag: '🇹🇷' },
    'Santos': { country: 'Brazil', flag: '🇧🇷' },
    'São Paulo': { country : 'Brazil', flag: '🇧🇷' },
'Flamengo': { country: 'Brazil', flag: '🇧🇷' },
'Corinthians': { country: 'Brazil', flag: '🇧🇷' },
'Boca Juniors': { country: 'Argentina', flag: '🇦🇷' },
'River Plate': { country: 'Argentina', flag: '🇦🇷' },
'Estudiantes': { country: 'Argentina', flag: '🇦🇷' }
};
// Try to find exact match
for (const [key, value] of Object.entries(countryMap)) {
if (teamName.includes(key)) {
return value;
}
}
// Default
return { country: 'Europe', flag: '🌍' };
}
function enhanceCustomMatchModal() {
  const modal = document.getElementById('customMatchModal');
  if (!modal) return;

  const keyHandler = (e) => {
    if (e.key === 'Enter' && e.ctrlKey) {
      simulateCustomMatch();
    }
  };

  modal.addEventListener('keydown', keyHandler);

  const teamSelects = modal.querySelectorAll('select');
  teamSelects.forEach(select => {
    select.addEventListener('change', function () {
      this.style.transform = 'scale(1.02)';
      setTimeout(() => {
        this.style.transform = 'scale(1)';
      }, 150);
    });
  });
}

function enhanceHistoryModal() {
  const modal = document.getElementById('historyModal');
  if (!modal) return;

  const searchInput = modal.querySelector('.history-search');
  if (searchInput && typeof filterHistoryContent === 'function') {
    searchInput.addEventListener('input', function () {
      filterHistoryContent(this.value);
    });
  }

  const refreshBtn = modal.querySelector('.refresh-history');
  if (refreshBtn && typeof loadHistoryContent === 'function') {
    refreshBtn.addEventListener('click', function () {
      this.classList.add('refreshing');
      setTimeout(() => {
        loadHistoryContent();
        this.classList.remove('refreshing');
      }, 500);
    });
  }
}

function enhanceMatchDetailModal() {
  const modal = document.getElementById('matchDetailModal');
  if (!modal) return;

  const copyBtn = modal.querySelector('.copy-match-id');
  if (copyBtn) {
    copyBtn.addEventListener('click', function () {
      const matchId = this.getAttribute('data-match-id');
      navigator.clipboard.writeText(matchId).then(() => {
        this.textContent = '✅ Copied!';
        setTimeout(() => {
          this.textContent = '📋 Copy ID';
        }, 2000);
      });
    });
  }
}

function getTeamSeason(teamName) {
  const team = TEAM_MAP.get(teamName);
  return team ? team.season : 'Unknown Season';
}

function getMatchResultType(scoreA, scoreB) {
  if (scoreA > scoreB) return 'Team A Wins';
  if (scoreA < scoreB) return 'Team B Wins';
  return 'Draw';
}

function getImportanceBadge(importance) {
  const levels = {
    1: { text: 'Normal', color: '#6b7280' },
    1.5: { text: 'Medium', color: '#f59e0b' },
    2: { text: 'High', color: '#ef4444' }
  };

  const level = importance >= 2 ? levels[2] : importance >= 1.5 ? levels[1.5] : levels[1];

  return `<span style="background: ${level.color}20; color: ${level.color}; padding: 2px 8px; border-radius: 12px; font-size: 0.8em;">${level.text}</span>`;
}

function simulateRematchFromDetail(teamA, teamB) {
  closeMatchDetail();
  setTimeout(() => {
    openCustomMatchModal(teamA, teamB);
  }, 300);
}

function shareMatchDetails(matchId) {
  const match = MATCH_DETAILS_DB[matchId];
  if (!match) {
    showUtilityMessage('Match not found', 'error');
    return;
  }

  // Use the comprehensive sharing system
  shareMatch(match);
}

function showModalMessage(message, type = 'info') {
  const modal = ModalManager.activeModal ? document.getElementById(ModalManager.activeModal) : null;
  if (!modal) return;

  const messageDiv = document.createElement('div');
  messageDiv.className = `modal-message modal-message-${type}`;
  messageDiv.textContent = message;

  modal.querySelector('.modal-content').appendChild(messageDiv);

  setTimeout(() => {
    messageDiv.remove();
  }, 3000);
}

function initializeModalSystem() {
  injectModalStyles();
  if (window.VERBOSE_LOGGING) console.log('Modal system initialized');
}

function injectModalStyles() {
  const styles = `
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      opacity: 0;
      transition: opacity 0.3s ease;
      /* backdrop-filter removed for performance */
    }
    
    .modal.active {
      opacity: 1;
    }
    
    .modal-content {
      background: #1f2937;
      border-radius: 12px;
      max-width: 90vw;
      max-height: 90vh;
      width: 600px;
      overflow-y: auto;
      transform: scale(0.9);
      transition: transform 0.3s ease;
      border: 1px solid #374151;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }
    
    .modal.active .modal-content {
      transform: scale(1);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 25px;
      border-bottom: 1px solid #374151;
      background: rgba(30, 41, 59, 0.5);
      border-radius: 12px 12px 0 0;
    }
    
    .modal-header h2 {
      margin: 0;
      color: #e5e7eb;
      font-size: 1.4em;
    }
    
    .modal-close {
      background: none;
      border: none;
      font-size: 1.8em;
      color: #9ca3af;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s ease;
    }
    
    .modal-close:hover {
      background: #374151;
      color: #e5e7eb;
    }
    
    .modal-body {
      padding: 25px;
    }
    
    .modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #374151;
    }
    
    .modal-message {
      padding: 12px 16px;
      border-radius: 6px;
      margin: 10px 0;
      font-weight: 500;
    }
    
    .modal-message-success {
      background: #10b98120;
      color: #10b981;
      border: 1px solid #10b98140;
    }
    
    .modal-message-error {
      background: #ef444420;
      color: #ef4444;
      border: 1px solid #ef444440;
    }
    
    .match-score-card {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      gap: 20px;
      align-items: center;
      text-align: center;
      margin-bottom: 20px;
    }
    
    .team-name {
      font-weight: bold;
      font-size: 1.2em;
      color: #e5e7eb;
    }
    
    .team-meta {
      color: #9ca3af;
      font-size: 0.9em;
      margin-top: 4px;
    }
    
    .score-display {
      background: #374151;
      padding: 15px 25px;
      border-radius: 8px;
    }
    
    .score {
      font-size: 2em;
      font-weight: bold;
      color: white;
    }
    
    .match-result {
      color: #9ca3af;
      font-size: 0.9em;
      margin-top: 5px;
    }
    
    @media (max-width: 768px) {
      .modal-content {
        width: 95vw;
        margin: 10px;
      }
      
      .match-score-card {
        grid-template-columns: 1fr;
        gap: 10px;
      }
      
      .modal-actions {
        flex-direction: column;
      }
    }
  `;

  injectStylesOnce('modal-styles', styles);
}

/************* MATCH RESULTS VIEWS *************/

function showMatchResults() {
  if (window.VERBOSE_LOGGING) console.log('Showing match results...');
  const out = document.getElementById('output');
  if (!out) return;

  out.innerHTML = `
    <div class="group-card">
      <div class="group-title">📋 Match Results</div>
      <div style="padding: 40px; text-align: center;">
        <div style="font-size: 64px; margin-bottom: 20px;">⚽</div>
        <p style="font-size: 1.2em; margin-bottom: 10px;"><strong>All Match Results</strong></p>
        <p style="color: #9ca3af; margin-bottom: 20px;">Complete list of all tournament matches with detailed statistics.</p>
      </div>
    </div>
  `;
}
function showMatchWeeks() {
  const out = document.getElementById('output');
  if (!out) return;

  if (window.VERBOSE_LOGGING) console.log("📅 Loading matchdays...");

  const groupMatches = [];
  const knockoutMatches = [];

  // Collect group stage matches
  if (window.GROUP_RESULTS) {
    Object.entries(window.GROUP_RESULTS).forEach(([groupName, data]) => {
      if (data && data.matches) {
        data.matches.forEach(match => {
          if (match && match.matchday) {
            groupMatches.push({
              ...match,
              groupName: groupName
            });
          }
        });
      }
    });
  }

  // Collect knockout matches
  if (window.TOURNAMENT && window.TOURNAMENT.allKnockoutMatches) {
    window.TOURNAMENT.allKnockoutMatches.forEach(match => {
      if (match) knockoutMatches.push(match);
    });
  }

  if (groupMatches.length === 0 && knockoutMatches.length === 0) {
    out.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">📅</div>
        <h2>No Matches Available</h2>
        <p class="output-sub">Complete the group stage or knockouts to view matchdays.</p>
      </div>
    `;
    return;
  }

  let html = `
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h2>📅 Matchdays</h2>
      <div style="display: flex; gap: 8px;">
        <button onclick="showTournamentOverview()" class="btn-secondary" style="padding: 8px 12px;">
          📊 All Matches
        </button>
        <button onclick="showPlayerStats()" class="btn-secondary" style="padding: 8px 12px;">
          📈 Statistics
        </button>
      </div>
    </div>
  `;

  // GROUP STAGE by matchday - Show ALL matches from ALL groups in each matchday
  if (groupMatches.length > 0) {
    const matchdays = [...new Set(groupMatches.map(m => m.matchday))].sort((a, b) => a - b);

    matchdays.forEach(matchday => {
      const matchesInDay = groupMatches.filter(m => m.matchday === matchday);
      const totalMatches = matchesInDay.length;
      const groupsPlaying = [...new Set(matchesInDay.map(m => m.groupName))].length;

      html += `
        <div style="background: linear-gradient(135deg, #1e293b, #0f172a); padding: 25px; border-radius: 12px; margin-bottom: 25px; border-left: 4px solid #3b82f6;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #374151;">
            <h3 style="margin: 0; color: #60a5fa; font-size: 1.5em;">🗓️ Matchday ${matchday}</h3>
            <div style="display: flex; gap: 20px; color: #94a3b8; font-size: 0.9em;">
              <span>📊 ${totalMatches} Fixtures</span>
              <span>🏟️ ${groupsPlaying} Groups (2 per group)</span>
            </div>
          </div>

          <div style="display: grid; gap: 8px;">
      `;

      // Show all matches from this matchday together
      matchesInDay.forEach(match => {
        const matchDetails = MATCH_DETAILS_DB[match.matchId];
        html += `
          <div onclick="${matchDetails ? `viewMatchDetails('${match.matchId}')` : ''}"
               style="display: flex; justify-content: space-between; align-items: center; background: rgba(30, 41, 59, 0.6); padding: 12px 18px; border-radius: 8px; cursor: ${matchDetails ? 'pointer' : 'default'}; border: 1px solid #374151; transition: all 0.2s ease;"
               onmouseover="this.style.borderColor='#3b82f6'; this.style.background='rgba(59, 130, 246, 0.1)'"
               onmouseout="this.style.borderColor='#374151'; this.style.background='rgba(30, 41, 59, 0.6)'">
            <div style="display: flex; align-items: center; gap: 12px; flex: 1; min-width: 0;">
              <span style="color: #64748b; font-size: 0.85em; font-weight: 600; min-width: 80px;">${match.groupName}</span>
              <div style="display: flex; align-items: center; gap: 15px; flex: 1;">
                <span style="color: #e2e8f0; font-weight: 500; flex: 1; text-align: right;">${match.teamA}</span>
                <div style="display: flex; align-items: center; gap: 8px; background: rgba(15, 23, 42, 0.8); padding: 6px 12px; border-radius: 6px; min-width: 70px; justify-content: center;">
                  <span style="color: #fff; font-weight: bold; font-size: 1.1em;">${match.scoreA}</span>
                  <span style="color: #64748b;">-</span>
                  <span style="color: #fff; font-weight: bold; font-size: 1.1em;">${match.scoreB}</span>
                </div>
                <span style="color: #e2e8f0; font-weight: 500; flex: 1;">${match.teamB}</span>
              </div>
            </div>
            ${matchDetails ? `
              <div style="color: #3b82f6; font-size: 0.85em; margin-left: 15px;">
                View Details →
              </div>
            ` : ''}
          </div>
        `;
      });

      html += `</div></div>`;
    });
  }

  out.innerHTML = html;
  console.log("✅ Matchdays loaded");
}
function generateGlobalMatchWeekCard(week, weekIndex) {
  const weekMatches = week.matches || [];
  const weekNumber = week.week || weekIndex + 1;
  
  // Group matches by group for better organization
  const matchesByGroup = {};
  weekMatches.forEach(matchData => {
    const groupName = matchData.group || 'Unknown Group';
    if (!matchesByGroup[groupName]) {
      matchesByGroup[groupName] = [];
    }
    matchesByGroup[groupName].push(matchData);
  });

  let html = `
    <div class="match-week-card" style="background: linear-gradient(135deg, rgba(30, 41, 59, 0.95), rgba(17, 24, 39, 0.95)); 
         border-radius: 10px; padding: 12px; margin-bottom: 12px; border: 1px solid #374151;">
      
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 10px; border-bottom: 2px solid #374151;">
        <div>
          <h3 style="margin: 0; color: #e5e7eb; font-size: 1.2em;">
            📅 Matchday ${weekNumber}
          </h3>
          <div style="color: #9ca3af; font-size: 0.85em; margin-top: 3px;">
            ${weekMatches.length} matches across all groups
          </div>
        </div>
        <button onclick="toggleWeekMatches('global-week-${weekIndex}')" 
                class="btn-secondary" style="padding: 5px 10px; font-size: 0.8em;">
          <span id="global-week-${weekIndex}-toggle">▼ Expand</span>
        </button>
      </div>

      <div id="global-week-${weekIndex}" style="display: none;">
  `;

  // Display matches grouped by group
  Object.keys(matchesByGroup).sort().forEach(groupName => {
    const groupMatches = matchesByGroup[groupName];
    
    html += `
      <div style="margin-bottom: 15px;">
        <h4 style="margin: 0 0 8px 0; color: #a7f3d0; font-size: 0.95em; padding: 6px 10px; background: rgba(72, 187, 120, 0.15); border-radius: 6px; border-left: 3px solid #48bb78;">
          ${groupName}
        </h4>
    `;

    groupMatches.forEach((matchData) => {
      const match = matchData.match ? MATCH_DETAILS_DB[matchData.match.matchId] : null;
      if (!match) return;

      html += `
        <div style="background: rgba(30, 41, 59, 0.5); border-radius: 6px; padding: 10px; margin-bottom: 6px; border: 1px solid #4b5563;">
          <div style="display: grid; grid-template-columns: 2fr auto 2fr; gap: 10px; align-items: center;">
            
            <div style="text-align: right;">
              <div style="font-size: 0.95em; font-weight: bold; color: #e5e7eb;">
                ${match.teamA}
              </div>
            </div>

            <div style="text-align: center; background: #1f2937; padding: 6px 14px; border-radius: 5px;">
              <div style="font-size: 1.4em; font-weight: bold; color: white;">
                ${match.scoreA} - ${match.scoreB}
              </div>
            </div>

            <div style="text-align: left;">
              <div style="font-size: 0.95em; font-weight: bold; color: #e5e7eb;">
                ${match.teamB}
              </div>
            </div>
          </div>

          ${match.playerOfTheGame ? `
            <div style="margin-top: 6px; padding-top: 6px; border-top: 1px solid #4b5563; text-align: center;">
              <span style="color: #f59e0b; font-size: 0.8em;">
                ⭐ ${match.playerOfTheGame.player} (${match.playerOfTheGame.rating}/10)
              </span>
            </div>
          ` : ''}
        </div>
      `;
    });

    html += `</div>`;
  });

  html += `
      </div>
    </div>
  `;

  return html;
}

function toggleWeekMatches(weekId) {
  const weekDiv = document.getElementById(weekId);
  const toggleSpan = document.getElementById(weekId + '-toggle');
  
  if (!weekDiv || !toggleSpan) return;
  
  if (weekDiv.style.display === 'none') {
    weekDiv.style.display = 'block';
    toggleSpan.textContent = '▲ Collapse';
  } else {
    weekDiv.style.display = 'none';
    toggleSpan.textContent = '▼ Expand';
  }
}

/************* PLAYER RATING SYSTEM *************/

function calculateBaseRating(player, teamStrength, performance = {}) {
  if (!player || !player.quality) {
    console.warn('⚠️ Invalid player in calculateBaseRating:', player);
    return 6.0;
  }

  // Base rating starts from player quality (scaled to 5-8 range)
  let rating = 5.0 + ((player.quality || 70) / 100) * 3.0;
  
  // Team performance influence (slight boost/penalty)
  const teamFactor = ((teamStrength || 70) - 70) / 100;
  rating += teamFactor * 0.5;

  // Performance bonuses
  if (performance.goals > 0) {
    rating += performance.goals * 1.2; // Goals are very valuable
  }
  if (performance.assists > 0) {
    rating += performance.assists * 0.7; // Assists are valuable
  }
  if (performance.cleanSheet && ['GK', 'CB', 'RB', 'LB'].includes(player.pos)) {
    rating += 0.8; // Clean sheet bonus for defenders
  }

  // Position-specific adjustments
  if (['GK'].includes(player.pos)) {
    // Goalkeepers: high floor, moderate ceiling
    rating = Math.max(rating, 6.0);
    if (performance.cleanSheet) rating += 0.5;
  } else if (['ST', 'CF', 'FW'].includes(player.pos)) {
    // Strikers: rating depends heavily on goals
    if (performance.goals === 0 && Math.random() < 0.3) {
      rating -= 0.5; // Penalty for not scoring
    }
  } else if (['CB', 'RB', 'LB'].includes(player.pos)) {
    // Defenders: high floor if clean sheet
    if (performance.cleanSheet) {
      rating = Math.max(rating, 7.0);
    }
  }

  // Add controlled randomness (better players have less variance)
  const qualityFactor = (player.quality || 70) / 100;
  const variance = 0.8 * (1 - qualityFactor * 0.5); // High quality = less variance
  const randomness = (Math.random() - 0.5) * variance;
  rating += randomness;

  // Realistic bounds: very rare to see below 5.5 or above 9.5
  rating = Math.max(5.5, Math.min(9.5, rating));

  // Round to 1 decimal
  return Math.round(rating * 10) / 10;
}

/************* CLUB LEGACY (DEDUPED) *************/

function updateTournamentLegacy(tournamentResults) {
  if (!tournamentResults || !tournamentResults.champion) {
    console.warn('⚠️ No tournament results to update club legacy');
    return;
  }

  const champion = tournamentResults.champion.name;

  if (!CLUB_LEGACY_DB.champions) CLUB_LEGACY_DB.champions = {};
  if (!CLUB_LEGACY_DB.finals) CLUB_LEGACY_DB.finals = {};
  if (!CLUB_LEGACY_DB.semiFinals) CLUB_LEGACY_DB.semiFinals = {};
  if (!CLUB_LEGACY_DB.quarterFinals) CLUB_LEGACY_DB.quarterFinals = {};
  if (!CLUB_LEGACY_DB.totalWins) CLUB_LEGACY_DB.totalWins = {};

  const currentChampionCount = CLUB_LEGACY_DB.champions[champion] || 0;

  if (currentChampionCount === 0) {
    CLUB_LEGACY_DB.champions[champion] = 1;
    CLUB_LEGACY_DB.totalWins[champion] = (CLUB_LEGACY_DB.totalWins[champion] || 0) + 1;

    if (window.VERBOSE_LOGGING) console.log(`🏆 ${champion} added to champions legacy`);

    if (tournamentResults.final) {
      const runnerUp =
        tournamentResults.final.teamA.name === champion
          ? tournamentResults.final.teamB.name
          : tournamentResults.final.teamA.name;

      CLUB_LEGACY_DB.finals[runnerUp] = (CLUB_LEGACY_DB.finals[runnerUp] || 0) + 1;
      CLUB_LEGACY_DB.totalWins[runnerUp] = (CLUB_LEGACY_DB.totalWins[runnerUp] || 0) + 1;
      if (window.VERBOSE_LOGGING) console.log(`🥈 ${runnerUp} added to finals legacy`);
    }

    if (tournamentResults.semiFinals) {
      tournamentResults.semiFinals.forEach(match => {
        if (!match) return;
        const semiFinalists = [match.teamA.name, match.teamB.name];
        semiFinalists.forEach(team => {
          if (
            team !== champion &&
            team !== tournamentResults.final?.teamA?.name &&
            team !== tournamentResults.final?.teamB?.name
          ) {
            CLUB_LEGACY_DB.semiFinals[team] = (CLUB_LEGACY_DB.semiFinals[team] || 0) + 1;
            CLUB_LEGACY_DB.totalWins[team] = (CLUB_LEGACY_DB.totalWins[team] || 0) + 1;
          }
        });
      });
      if (window.VERBOSE_LOGGING) console.log('🥉 Semi-finalists updated');
    }

    console.log('✅ Club legacy database updated (no duplicates)');
  } else {
    if (window.VERBOSE_LOGGING) console.log('ℹ️ Legacy already updated for this tournament, skipping duplicate');
  }
}

/************* CORE INITIALIZATION *************/

function initializeCoreSystems() {
  const hasBackup = localStorage.getItem('tournamentBackup');
  const hasData = window.GROUP_RESULTS || window.TOURNAMENT;

  if (!hasData && hasBackup) {
    if (window.VERBOSE_LOGGING) console.log('📦 Found existing backup, offering restore...');
    setTimeout(() => {
      if (confirm('A previous tournament backup was found. Would you like to restore it?')) {
        restoreFromBackup();
      }
    }, 2000);
  }

  setInterval(() => {
    if (window.TOURNAMENT || window.GROUP_RESULTS) {
      backupToLocalStorage();
    }
  }, 2 * 60 * 1000);

  if (window.VERBOSE_LOGGING) console.log('🔧 Core systems initialized');
}

/************* GLOBAL ERROR HANDLERS *************/

window.addEventListener('error', function (e) {
  console.error('Global error:', e.error);
  showUtilityMessage('An error occurred. Check console for details.', 'error');
});

window.addEventListener('unhandledrejection', function (e) {
  console.error('Unhandled promise rejection:', e.reason);
  showUtilityMessage('A network error occurred. Please try again.', 'error');
});

/************* OPTIONAL STUBS FOR MISSING FUNCTIONS *************/

(function ensureStubs() {
  const stub = name => {
    if (typeof window[name] !== 'function') {
      window[name] = function () {
        console.warn(name + '() not implemented');
      };
    }
  };

  stub('showClubLegacy');
  stub('showTournamentOverview');
  stub('showTournamentBracket');
  stub('showGroupStageResults');
  stub('showEnhancedStatistics');
  stub('viewTeamPlayers');
  stub('loadHistoryContent');
  stub('filterHistoryContent');
  stub('populateSettingsModal');
  stub('enhanceSettingsModal');
  stub('populateStatisticsModal');
  stub('enhanceStatisticsModal');
  stub('generateGroups');
  stub('runFullTournament');
  stub('injectAllStyles');
  stub('renderKnockoutResults');
  stub('renderGroupResults');
  stub('showPlayerStats');
  stub('saveCustomMatch');
  stub('shareMatchResult');
  stub('generateMatchSummary');
  stub('startTournament');
  stub('runGroupStage');
  stub('runKnockouts');
  stub('exportTournament');
  stub('resetTournament');
  stub('handleImport');
})();

/************* EXTRA UI HELPERS / DEFINITIONS *************/
function showClubLegacy() {
  const out = document.getElementById('output');
  if (!out) return;

  // Collect all clubs with achievements
  const clubs = new Set();
  
  if (CLUB_LEGACY_DB.champions) {
    Object.keys(CLUB_LEGACY_DB.champions).forEach(club => clubs.add(club));
  }
  if (CLUB_LEGACY_DB.finals) {
    Object.keys(CLUB_LEGACY_DB.finals).forEach(club => clubs.add(club));
  }
  if (CLUB_LEGACY_DB.semiFinals) {
    Object.keys(CLUB_LEGACY_DB.semiFinals).forEach(club => clubs.add(club));
  }
  if (CLUB_LEGACY_DB.quarterFinals) {
    Object.keys(CLUB_LEGACY_DB.quarterFinals).forEach(club => clubs.add(club));
  }

  if (clubs.size === 0) {
    out.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">🏛️</div>
        <h2>No Legacy Data</h2>
        <p class="output-sub">Complete tournaments to build club legacy records.</p>
        <button onclick="showTournamentOverview()" class="btn-primary" style="margin-top: 15px;">
          View Current Tournament
        </button>
      </div>
    `;
    return;
  }

  // Build legacy data array
  const legacyData = Array.from(clubs).map(club => {
    return {
      club: club,
      titles: CLUB_LEGACY_DB.champions?.[club] || 0,
      finals: CLUB_LEGACY_DB.finals?.[club] || 0,
      semis: CLUB_LEGACY_DB.semiFinals?.[club] || 0,
      quarters: CLUB_LEGACY_DB.quarterFinals?.[club] || 0,
      totalWins: CLUB_LEGACY_DB.totalWins?.[club] || 0
    };
  });

  // Sort by titles (desc), then finals, then semis
  legacyData.sort((a, b) => {
    if (b.titles !== a.titles) return b.titles - a.titles;
    if (b.finals !== a.finals) return b.finals - a.finals;
    if (b.semis !== a.semis) return b.semis - a.semis;
    return b.quarters - a.quarters;
  });

  let html = `
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h2>🏛️ Club Legacy - All-Time Records</h2>
      <div style="display: flex; gap: 8px;">
        <button onclick="showTournamentOverview()" class="btn-secondary" style="padding: 8px 12px;">
          📊 Current Tournament
        </button>
        <button onclick="showPlayerStats()" class="btn-secondary" style="padding: 8px 12px;">
          📈 Player Stats
        </button>
      </div>
    </div>

    <div style="background: linear-gradient(135deg, #1e293b, #0f172a); padding: 20px; border-radius: 12px; border: 1px solid #475569; margin-bottom: 20px;">
      <div style="text-align: center; margin-bottom: 15px;">
        <h3 style="color: #fbbf24; margin: 0;">🏆 Hall of Champions</h3>
        <p style="color: #94a3b8; font-size: 0.9em; margin-top: 5px;">
          Tracking ${legacyData.length} clubs across all tournaments
        </p>
      </div>

      <div class="legacy-table-container" style="overflow-x: auto;">
        <table class="legacy-table" style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="background: rgba(59, 130, 246, 0.2); border-bottom: 2px solid #3b82f6;">
              <th style="padding: 12px; text-align: left; color: #e5e7eb; font-weight: 600;">Rank</th>
              <th style="padding: 12px; text-align: left; color: #e5e7eb; font-weight: 600;">Club</th>
              <th style="padding: 12px; text-align: center; color: #fbbf24; font-weight: 600;">🏆 Titles</th>
              <th style="padding: 12px; text-align: center; color: #9ca3af; font-weight: 600;">🥈 Finals</th>
              <th style="padding: 12px; text-align: center; color: #cd7f32; font-weight: 600;">🥉 Semis</th>
              <th style="padding: 12px; text-align: center; color: #6b7280; font-weight: 600;">📊 Quarters</th>
              <th style="padding: 12px; text-align: center; color: #10b981; font-weight: 600;">💪 Total</th>
            </tr>
          </thead>
          <tbody>
  `;

  legacyData.forEach((data, index) => {
    const rank = index + 1;
    const isTopThree = rank <= 3;
    const rowBg = isTopThree 
      ? 'background: rgba(245, 158, 11, 0.1); border-left: 3px solid #f59e0b;' 
      : 'background: rgba(30, 41, 59, 0.3);';
    
    const rankDisplay = rank === 1 ? '🥇' : rank === 2 ? '🥈' : rank === 3 ? '🥉' : rank;

    html += `
      <tr style="${rowBg} border-bottom: 1px solid #374151; transition: all 0.2s ease;"
          onmouseover="this.style.background='rgba(59, 130, 246, 0.15)'"
          onmouseout="this.style.background='${isTopThree ? 'rgba(245, 158, 11, 0.1)' : 'rgba(30, 41, 59, 0.3)'}'">
        <td style="padding: 12px; color: #94a3b8; font-weight: bold; font-size: 1.1em;">
          ${rankDisplay}
        </td>
        <td style="padding: 12px; color: #e5e7eb; font-weight: 600; font-size: 1em;">
          ${data.club}
        </td>
        <td style="padding: 12px; text-align: center; color: ${data.titles > 0 ? '#fbbf24' : '#6b7280'}; font-weight: bold; font-size: 1.2em;">
          ${data.titles || '-'}
        </td>
        <td style="padding: 12px; text-align: center; color: ${data.finals > 0 ? '#9ca3af' : '#6b7280'}; font-weight: 600;">
          ${data.finals || '-'}
        </td>
        <td style="padding: 12px; text-align: center; color: ${data.semis > 0 ? '#cd7f32' : '#6b7280'}; font-weight: 600;">
          ${data.semis || '-'}
        </td>
        <td style="padding: 12px; text-align: center; color: ${data.quarters > 0 ? '#6b7280' : '#4b5563'};">
          ${data.quarters || '-'}
        </td>
        <td style="padding: 12px; text-align: center; color: #10b981; font-weight: bold; font-size: 1.1em;">
          ${data.totalWins}
        </td>
      </tr>
    `;
  });

  html += `
          </tbody>
        </table>
      </div>
    </div>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px;">
      <div style="background: rgba(245, 158, 11, 0.1); padding: 15px; border-radius: 8px; border: 1px solid #f59e0b; text-align: center;">
        <div style="font-size: 2em; color: #fbbf24;">🏆</div>
        <div style="font-size: 1.5em; font-weight: bold; color: #fbbf24; margin-top: 5px;">
          ${legacyData.reduce((sum, d) => sum + d.titles, 0)}
        </div>
        <div style="color: #94a3b8; font-size: 0.9em; margin-top: 3px;">Total Titles</div>
      </div>
      
      <div style="background: rgba(59, 130, 246, 0.1); padding: 15px; border-radius: 8px; border: 1px solid #3b82f6; text-align: center;">
        <div style="font-size: 2em; color: #60a5fa;">🎯</div>
        <div style="font-size: 1.5em; font-weight: bold; color: #60a5fa; margin-top: 5px;">
          ${legacyData.length}
        </div>
        <div style="color: #94a3b8; font-size: 0.9em; margin-top: 3px;">Clubs Tracked</div>
      </div>
      
      <div style="background: rgba(16, 185, 129, 0.1); padding: 15px; border-radius: 8px; border: 1px solid #10b981; text-align: center;">
        <div style="font-size: 2em; color: #10b981;">📊</div>
        <div style="font-size: 1.5em; font-weight: bold; color: #10b981; margin-top: 5px;">
          ${legacyData.reduce((sum, d) => sum + d.totalWins, 0)}
        </div>
        <div style="color: #94a3b8; font-size: 0.9em; margin-top: 3px;">Total Achievements</div>
      </div>
    </div>
  `;

  out.innerHTML = html;
  console.log('✅ Club legacy table rendered with', legacyData.length, 'clubs');
}
function showTournamentOverview() {
  const out = document.getElementById('output');
  if (!out) return;

  try {
    const allMatches = [];

    // Collect group stage matches
    if (window.GROUP_RESULTS) {
      Object.entries(window.GROUP_RESULTS).forEach(([groupName, data]) => {
        if (data && data.matches) {
          data.matches.forEach(match => {
            if (match) {
              allMatches.push({
                ...match,
                stage: 'Group Stage',
                groupName: groupName
              });
            }
          });
        }
      });
    }

    // Collect knockout matches
    if (window.TOURNAMENT && window.TOURNAMENT.allKnockoutMatches) {
      window.TOURNAMENT.allKnockoutMatches.forEach(match => {
        if (match) {
          allMatches.push({
            ...match,
            stage: match.round || 'Knockout',
            groupName: null
          });
        }
      });
    }

    if (allMatches.length === 0) {
      out.innerHTML = `
        <div class="empty-state">
          <div class="empty-icon">📊</div>
          <h2>No Matches Available</h2>
          <p class="output-sub">Run the tournament to view match results.</p>
        </div>
      `;
      return;
    }

    let html = `
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2>📊 All Match Results</h2>
        <div style="display: flex; gap: 8px;">
          <button onclick="showMatchWeeks()" class="btn-secondary" style="padding: 8px 12px;">
            📅 Matchdays
          </button>
          <button onclick="showPlayerStats()" class="btn-secondary" style="padding: 8px 12px;">
            📈 Statistics
          </button>
        </div>
      </div>

      <div style="display: grid; gap: 12px;">
    `;

    allMatches.forEach(match => {
      const matchDetails = MATCH_DETAILS_DB[match.matchId || match.firstLegId];
      const isFinal = match.stage === 'Final' || match.round === 'Final';
      const isKnockout = match.stage !== 'Group Stage';

      html += `
        <div style="background: linear-gradient(135deg, ${isKnockout ? '#1e293b' : '#0f172a'}, #020617); padding: 15px; border-radius: 8px; border-left: 4px solid ${isKnockout ? '#f59e0b' : '#3b82f6'};">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <span style="color: #94a3b8; font-size: 0.9em; font-weight: 600;">
              ${match.groupName || match.round || match.stage}
              ${match.matchday ? ` - Matchday ${match.matchday}` : ''}
            </span>
            ${matchDetails ? `
              <button onclick="viewMatchDetails('${match.matchId || match.firstLegId}')" class="btn-secondary" style="padding: 6px 12px;">
                📋 Details
              </button>
            ` : ''}
          </div>
          
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; align-items: center; gap: 15px; flex: 1;">
              <span style="color: ${isKnockout && match.winner?.name === (match.teamA?.name || match.teamA) ? '#10b981' : '#e2e8f0'}; font-weight: ${isKnockout && match.winner?.name === (match.teamA?.name || match.teamA) ? 'bold' : '500'}; width: 160px;">
                ${match.teamA?.name || match.teamA || 'TBD'}
              </span>
              <div style="display: flex; align-items: center; gap: 10px; min-width: 80px; justify-content: center;">
                <span style="color: #fff; font-weight: bold; font-size: 1.2em;">
                  ${isFinal ? (match.matchDetails?.scoreA || match.scoreA || 0) : (isKnockout ? (match.aggScoreA || 0) : (match.scoreA || 0))}
                </span>
                <span style="color: #64748b; font-weight: bold;">-</span>
                <span style="color: #fff; font-weight: bold; font-size: 1.2em;">
                  ${isFinal ? (match.matchDetails?.scoreB || match.scoreB || 0) : (isKnockout ? (match.aggScoreB || 0) : (match.scoreB || 0))}
                </span>
              </div>
              <span style="color: ${isKnockout && match.winner?.name === (match.teamB?.name || match.teamB) ? '#10b981' : '#e2e8f0'}; font-weight: ${isKnockout && match.winner?.name === (match.teamB?.name || match.teamB) ? 'bold' : '500'}; width: 160px; text-align: right;">
                ${match.teamB?.name || match.teamB || 'TBD'}
              </span>
            </div>
            ${isKnockout && !isFinal ? `<span style="color: #94a3b8; font-size: 0.85em; margin-left: 15px;">(agg.)</span>` : ''}
            ${match.penaltiesUsed ? `<span style="color: #f59e0b; font-size: 0.9em; margin-left: 10px;">🎯 ${match.penaltyScoreA}-${match.penaltyScoreB} Pens</span>` : ''}
          </div>
        </div>
      `;
    });

    html += `</div>`;
    out.innerHTML = html;

  } catch (error) {
    console.error('Error in showTournamentOverview:', error);
    out.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">⚠️</div>
        <h2>Error Loading Matches</h2>
        <p class="output-sub">${error.message}</p>
      </div>
    `;
  }
}
// Add this entire function after showTournamentOverview
function viewMatchDetails(matchId) {
  if (!matchId) {
    showUtilityMessage('Match ID not provided', 'warning');
    return;
  }

  const match = MATCH_DETAILS_DB[matchId];
  
  if (!match) {
    showUtilityMessage('Match details not found', 'error');
    console.error('Match not found:', matchId);
    return;
  }

  const out = document.getElementById('output');
  if (!out) return;

  // FIX: Safely get scores
  const scoreA = match.scoreA !== undefined ? match.scoreA : 0;
  const scoreB = match.scoreB !== undefined ? match.scoreB : 0;
  const teamA = match.teamA || 'Team A';
  const teamB = match.teamB || 'Team B';

  const potg = match.playerOfTheGame;
  const summary = match.summary || generateMatchSummary(match, teamA, teamB);

  let html = `
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h2>⚽ Match Details</h2>
      <button onclick="showTournamentOverview()" class="btn-secondary" style="padding: 8px 12px;">
        ← Back to Matches
      </button>
    </div>

    <div style="background: linear-gradient(135deg, #1e293b, #0f172a); padding: 25px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #475569;">
      <div style="text-align: center; margin-bottom: 20px;">
        <div style="color: #94a3b8; font-size: 0.9em; margin-bottom: 10px;">${match.stage || 'Match'}</div>
        <div style="display: flex; justify-content: center; align-items: center; gap: 20px;">
          <div style="text-align: right; flex: 1;">
            <div style="font-size: 1.8em; font-weight: bold; color: #e2e8f0;">${teamA}</div>
          </div>
          <div style="background: rgba(59, 130, 246, 0.2); padding: 15px 25px; border-radius: 8px; border: 2px solid #3b82f6;">
            <div style="font-size: 2.5em; font-weight: bold; color: white;">
              ${scoreA} - ${scoreB}
            </div>
          </div>
          <div style="text-align: left; flex: 1;">
            <div style="font-size: 1.8em; font-weight: bold; color: #e2e8f0;">${teamB}</div>
          </div>
        </div>
      </div>

      ${potg ? `
        <div style="background: rgba(245, 158, 11, 0.2); padding: 15px; border-radius: 8px; margin: 15px 0; border: 1px solid #f59e0b; text-align: center;">
          <div style="color: #fbbf24; font-weight: bold; font-size: 1.1em; margin-bottom: 5px;">⭐ Player of the Match</div>
          <div style="color: #e2e8f0; font-size: 1.2em;">${potg.player}</div>
          <div style="color: #94a3b8; margin-top: 5px;">
            Rating: ${potg.rating}/10
            ${potg.goals > 0 ? ` • ${potg.goals} goal${potg.goals > 1 ? 's' : ''}` : ''}
            ${potg.assists > 0 ? ` • ${potg.assists} assist${potg.assists > 1 ? 's' : ''}` : ''}
          </div>
        </div>
      ` : ''}

      <div style="color: #cbd5e1; font-style: italic; text-align: center; padding: 15px; background: rgba(15, 23, 42, 0.5); border-radius: 8px;">
        ${summary}
      </div>
    </div>
  `;

  // Goals section
  if (match.events && match.events.goals && match.events.goals.length > 0) {
    html += `
      <div style="background: linear-gradient(135deg, #1e293b, #0f172a); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #475569;">
        <h3 style="margin: 0 0 15px 0; color: #10b981;">⚽ Goals</h3>
        <div style="display: grid; gap: 10px;">
    `;

    // Sort goals chronologically by minute
    const sortedGoals = [...match.events.goals]
      .sort((a, b) => (a.minute ?? 0) - (b.minute ?? 0));

    sortedGoals.forEach(goal => {
      html += `
        <div style="background: rgba(16, 185, 129, 0.1); padding: 12px; border-radius: 6px; border-left: 3px solid #10b981; display: flex; justify-content: space-between; align-items: center;">
          <div>
            <span style="color: #10b981; font-weight: bold;">${goal.minute}'</span>
            <span style="color: #e2e8f0; margin-left: 10px; font-weight: 500;">${goal.player}</span>
            <span style="color: #94a3b8; margin-left: 10px;">(${goal.team})</span>
          </div>
          ${goal.assist ? `<span style="color: #60a5fa; font-size: 0.9em;">Assist: ${goal.assist}</span>` : ''}
        </div>
      `;
    });

    html += `</div></div>`;
  }

  out.innerHTML = html;
}
function getTeamPlacement(teamName) {
  if (!window.TOURNAMENT) return null;
  
  if (window.TOURNAMENT.champion?.name === teamName) {
    return '🏆 Champion';
  }
  
  if (window.TOURNAMENT.final) {
    const runnerUp = window.TOURNAMENT.final.teamA?.name === teamName || 
                     window.TOURNAMENT.final.teamB?.name === teamName;
    if (runnerUp && window.TOURNAMENT.champion?.name !== teamName) {
      return '🥈 Runner-up';
    }
  }
  
  if (window.TOURNAMENT.semiFinals) {
    const inSemis = window.TOURNAMENT.semiFinals.some(m => 
      m && (m.teamA?.name === teamName || m.teamB?.name === teamName)
    );
    if (inSemis && window.TOURNAMENT.champion?.name !== teamName) {
      return '🥉 Semi-finalist';
    }
  }
  
  if (window.TOURNAMENT.quarterFinals) {
    const inQuarters = window.TOURNAMENT.quarterFinals.some(m => 
      m && (m.teamA?.name === teamName || m.teamB?.name === teamName)
    );
    if (inQuarters) {
      return 'Quarter-finalist';
    }
  }
  
  return null;
}

function getPlacementColor(placement) {
  if (!placement) return '#6b7280';
  if (placement.includes('Champion')) return '#f59e0b';
  if (placement.includes('Runner-up')) return '#9ca3af';
  if (placement.includes('Semi')) return '#cd7f32';
  return '#6b7280';
}
function generateMatchCard(match, matchNumber) {
  const potg = match.playerOfTheGame;
  const summary = generateDetailedMatchSummary(match);
  const winner = match.scoreA > match.scoreB ? match.teamA : 
                 match.scoreB > match.scoreA ? match.teamB : null;
  
  const teamARecord = getTeamRecordAtMatch(match.teamA, match.timestamp);
  const teamBRecord = getTeamRecordAtMatch(match.teamB, match.timestamp);
  return `
    <div class="match-card" style="background: linear-gradient(135deg, rgba(30, 41, 59, 0.95), rgba(17, 24, 39, 0.95)); 
         border-radius: 10px; padding: 12px; margin-bottom: 10px; border: 1px solid #374151;
         box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); transition: all 0.3s ease;"
         onmouseover="this.style.borderColor='#3b82f6'; this.style.transform='translateY(-2px)'"
         onmouseout="this.style.borderColor='#374151'; this.style.transform='translateY(0)'">
      <!-- Match Header -->
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid #374151;">
        <div style="display: flex; align-items: center; gap: 10px;">
          <span style="background: #3b82f6; color: white; padding: 4px 12px; border-radius: 20px; font-weight: bold; font-size: 0.85em;">
            Match #${matchNumber}
          </span>
          <span style="color: #9ca3af; font-size: 0.9em;">
            ${new Date(match.timestamp).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
          </span>
        </div>
        <div style="display: flex; gap: 8px;">
          <span style="background: rgba(59, 130, 246, 0.2); color: #60a5fa; padding: 3px 10px; border-radius: 12px; font-size: 0.8em;">
            ${match.venue || 'Neutral'}
          </span>
          ${match.importance > 1 ? `
            <span style="background: rgba(245, 158, 11, 0.2); color: #fbbf24; padding: 3px 10px; border-radius: 12px; font-size: 0.8em;">
              🔥 ${match.importance}x
            </span>
     ` : ''}
        </div>
      </div>

      <!-- View Details Button -->
      <div style="margin-top: 10px; text-align: center; padding-top: 10px; border-top: 1px solid #374151;">
        <button onclick="openMatchDetail('${match.matchId || match.id}')" class="btn-secondary" style="padding: 6px 20px; font-size: 0.85em;">
          📊 View Full Details
        </button>
      </div>

    <!-- Score Display -->
      <div style="display: grid; grid-template-columns: 2fr auto 2fr; gap: 12px; align-items: center; margin-bottom: 10px;">
        
        <!-- Team A -->
        <div style="text-align: right;">
          <div style="font-size: 1.1em; font-weight: bold; color: #e5e7eb; margin-bottom: 3px;">
            ${match.teamA}
            ${winner === match.teamA ? '<span style="color: #10b981; margin-left: 8px;">✓</span>' : ''}
          </div>
          <div style="font-size: 0.85em; color: #9ca3af;">
            ${teamARecord}
          </div>
        </div>

       <!-- Score -->
        <div style="text-align: center; background: #1f2937; padding: 10px 18px; border-radius: 8px; border: 2px solid ${winner === match.teamA ? '#10b981' : winner === match.teamB ? '#ef4444' : '#6b7280'};">
          <div style="font-size: 2em; font-weight: bold; color: white; line-height: 1;">
            ${match.scoreA} - ${match.scoreB}
          </div>
          ${!winner ? '<div style="color: #9ca3af; font-size: 0.8em; margin-top: 4px;">Draw</div>' : ''}
        </div>

   <!-- Team B -->
        <div style="text-align: left;">
          <div style="font-size: 1.1em; font-weight: bold; color: #e5e7eb; margin-bottom: 3px;">
            ${winner === match.teamB ? '<span style="color: #10b981; margin-right: 8px;">✓</span>' : ''}
            ${match.teamB}
          </div>
          <div style="font-size: 0.85em; color: #9ca3af;">
            ${teamBRecord}
          </div>
        </div>
      </div>

      ${potg ? `
        <!-- Player of the Game -->
        <div style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(217, 119, 6, 0.15)); 
             padding: 12px 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid rgba(245, 158, 11, 0.3);">
          <div style="display: flex; align-items: center; justify-content: space-between;">
            <div style="display: flex; align-items: center; gap: 12px;">
              <span style="font-size: 1.5em;">⭐</span>
              <div>
                <div style="font-size: 0.75em; color: #f59e0b; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
                  Player of the Game
                </div>
                <div style="font-size: 1.1em; font-weight: bold; color: #fbbf24; margin-top: 2px;">
                  ${potg.player}
                </div>
              </div>
            </div>
            <div style="display: flex; gap: 15px; align-items: center;">
              <div style="text-align: center;">
                <div style="font-size: 1.4em; font-weight: bold; color: #fbbf24;">
                  ${potg.rating}<span style="font-size: 0.7em; color: #d97706;">/10</span>
                </div>
                <div style="font-size: 0.75em; color: #9ca3af;">Rating</div>
              </div>
              ${potg.goals > 0 || potg.assists > 0 ? `
                <div style="text-align: center; border-left: 1px solid rgba(245, 158, 11, 0.3); padding-left: 15px;">
                  <div style="font-size: 1.2em; font-weight: bold; color: #e5e7eb;">
                    ${potg.goals}G ${potg.assists}A
                  </div>
                  <div style="font-size: 0.75em; color: #9ca3af;">Contributions</div>
                </div>
              ` : ''}
            </div>
          </div>
        </div>
      ` : ''}

      <!-- Match Summary -->
      <div style="background: rgba(30, 41, 59, 0.5); padding: 12px 15px; border-radius: 8px; border-left: 3px solid #8b5cf6;">
        <div style="font-size: 0.75em; color: #8b5cf6; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">
          📝 Match Summary
        </div>
        <div style="color: #d1d5db; line-height: 1.6; font-size: 0.95em;">
          ${summary}
        </div>
      </div>

      <!-- Goals Timeline -->
      ${match.events && match.events.goals && match.events.goals.length > 0 ? `
        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #374151;">
          <div style="font-size: 0.75em; color: #9ca3af; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">
            ⚽ Goals
          </div>
          <div style="display: flex; flex-wrap: wrap; gap: 8px;">
            ${match.events.goals.map(goal => `
              <div style="background: rgba(59, 130, 246, 0.1); padding: 6px 12px; border-radius: 6px; font-size: 0.85em; border: 1px solid rgba(59, 130, 246, 0.3);">
                <span style="color: #60a5fa; font-weight: bold;">${goal.minute}'</span>
                <span style="color: #e5e7eb; margin: 0 6px;">•</span>
                <span style="color: #e5e7eb;">${goal.player}</span>
                ${goal.assisted ? `<span style="color: #9ca3af; font-size: 0.9em;"> (${goal.assisted})</span>` : ''}
              </div>
            `).join('')}
          </div>
        </div>
      ` : ''}

    </div>
  `;
}

function generateDetailedMatchSummary(match) {
  const scoreA = match.scoreA || 0;
  const scoreB = match.scoreB || 0;
  const totalGoals = scoreA + scoreB;
  const goalDiff = Math.abs(scoreA - scoreB);
  
  const teamA = match.teamAObj || { name: match.teamA, strength: 75 };
  const teamB = match.teamBObj || { name: match.teamB, strength: 75 };
  const strengthDiff = Math.abs((teamA.strength || 75) - (teamB.strength || 75));
  
  const potg = match.playerOfTheGame;
  const isHome = match.isHome;
  const venue = isHome ? teamA.name : 'neutral venue';
  
  let summary = '';
  
  // Opening statement based on result type
  if (totalGoals === 0) {
    summary = `A tactical chess match at ${venue} saw both defenses stand firm throughout. `;
    summary += strengthDiff > 10 
      ? `Despite ${teamA.strength > teamB.strength ? teamA.name : teamB.name}'s superior quality, neither side could find the breakthrough. `
      : `The evenly-matched sides cancelled each other out in a cagey encounter. `;
  } else if (goalDiff === 0) {
    summary = `An entertaining ${totalGoals}-goal thriller at ${venue} ended level after both sides traded blows. `;
    summary += totalGoals >= 4 
      ? `The high-scoring affair saw end-to-end action with momentum swinging throughout the contest. `
      : `Neither team could quite find the decisive moment in this competitive stalemate. `;
  } else if (goalDiff === 1) {
    const winner = scoreA > scoreB ? teamA.name : teamB.name;
    summary = `A tightly-contested encounter at ${venue} saw ${winner} edge past their opponents ${scoreA}-${scoreB}. `;
    summary += totalGoals >= 4
      ? `The high-tempo match featured constant attacking play from both sides before the narrow margin was settled. `
      : `Small margins proved decisive in what was otherwise an evenly-balanced contest. `;
  } else if (goalDiff === 2) {
    const winner = scoreA > scoreB ? teamA.name : teamB.name;
    const loser = scoreA > scoreB ? teamB.name : teamA.name;
    summary = `${winner} earned a convincing ${scoreA > scoreB ? scoreA + '-' + scoreB : scoreB + '-' + scoreA} victory at ${venue}. `;
    summary += strengthDiff > 10 && ((teamA.strength > teamB.strength && scoreA > scoreB) || (teamB.strength > teamA.strength && scoreB > scoreA))
      ? `The favorites demonstrated their class with a professional performance that ${loser} struggled to contain. `
      : `${loser} showed moments of quality but ultimately couldn't match their opponent's clinical finishing. `;
  } else {
    const winner = scoreA > scoreB ? teamA.name : teamB.name;
    const loser = scoreA > scoreB ? teamB.name : teamA.name;
    summary = `${winner} ran riot in a dominant ${scoreA > scoreB ? scoreA + '-' + scoreB : scoreB + '-' + scoreA} display at ${venue}. `;
    summary += `${loser} had no answer to the relentless attacking onslaught in what became a one-sided affair. `;
  }
  
  // Add player of the game context
  if (potg) {
    if (potg.goals >= 2) {
      summary += `${potg.player}'s ${potg.goals}-goal haul proved decisive, earning them a ${potg.rating}/10 match rating.`;
    } else if (potg.goals === 1 && potg.assists >= 1) {
      summary += `${potg.player} was instrumental with a goal and assist, capping an outstanding ${potg.rating}/10 performance.`;
    } else if (potg.rating >= 8.5) {
      summary += `${potg.player} dominated proceedings with a masterful ${potg.rating}/10 display.`;
    } else if (potg.cleanSheet) {
      summary += `${potg.player} marshalled the defense superbly, keeping a clean sheet in a ${potg.rating}/10 performance.`;
    } else {
      summary += `${potg.player}'s ${potg.rating}/10 rating reflected their key contribution to the result.`;
    }
  } else if (totalGoals === 0) {
    summary += `Both goalkeepers can be credited with maintaining clean sheets in difficult circumstances.`;
  }
  
  return summary;
}

function getTeamRecordAtMatch(teamName, timestamp) {
  const teamMatches = Object.values(MATCH_DETAILS_DB)
    .filter(m => (m.teamA === teamName || m.teamB === teamName) && new Date(m.timestamp) <= new Date(timestamp))
    .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
  
  let wins = 0, draws = 0, losses = 0;
  
  teamMatches.forEach(m => {
    const isTeamA = m.teamA === teamName;
    const teamScore = isTeamA ? m.scoreA : m.scoreB;
    const oppScore = isTeamA ? m.scoreB : m.scoreA;
    
    if (teamScore > oppScore) wins++;
    else if (teamScore === oppScore) draws++;
    else losses++;
  });
  
  return `${wins}W ${draws}D ${losses}L`;
}
function getCustomMatchesHistory() {
  try {
    return JSON.parse(localStorage.getItem('savedCustomMatches') || '[]');
  } catch {
    return [];
  }
}
function filterMatchesByStage(stage) {
  const out = document.getElementById('output');
  if (!out) return;
  
  let filteredMatches = [];
  
  if (stage === 'group') {
    // Group stage matches don't have a round property OR have importance <= 1.2
    filteredMatches = Object.values(MATCH_DETAILS_DB)
      .filter(m => {
        const hasKnockoutRound = m.round && ['Round of 32', 'Round of 16', 'Quarter Finals', 'Semi Finals', 'Final'].includes(m.round);
        return !hasKnockoutRound;
      })
      .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
  } else if (stage === 'knockout') {
    // Knockout matches have specific round names
    const knockoutRounds = ['Round of 32', 'Round of 16', 'Quarter Finals', 'Semi Finals', 'Final'];
    filteredMatches = Object.values(MATCH_DETAILS_DB)
      .filter(m => m.round && knockoutRounds.includes(m.round))
      .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
  }
  
  if (filteredMatches.length === 0) {
    out.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">⚽</div>
        <h2>No ${stage === 'group' ? 'Group Stage' : 'Knockout'} Matches</h2>
        <p class="output-sub">These matches haven't been simulated yet.</p>
        <button onclick="showTournamentOverview()" class="btn-primary" style="margin-top: 20px;">
          View All Matches
        </button>
      </div>
    `;
    return;
  }
  
  let html = `
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h2>📅 ${stage === 'group' ? 'Group Stage' : 'Knockout'} Matches</h2>
      <button onclick="showTournamentOverview()" class="btn-secondary" style="padding: 8px 16px;">
        ← Back to All Matches
      </button>
    </div>
    
    <div class="matches-container">
  `;
  
  filteredMatches.forEach((match, index) => {
    html += generateMatchCard(match, index + 1);
  });
  
  html += `</div>`;
  out.innerHTML = html;
}
function showTournamentBracket() {
  const out = document.getElementById('output');
  if (!out) return;

  if (!window.TOURNAMENT || !window.TOURNAMENT.bracket) {
    out.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">🏆</div>
        <h2>No Bracket Available</h2>
        <p class="output-sub">Complete the knockout stage to view the tournament bracket.</p>
        <button onclick="runKnockouts()" class="btn-primary" style="margin-top: 15px;">
          Simulate Knockouts
        </button>
      </div>
    `;
    return;
  }

  const bracket = window.TOURNAMENT.bracket;
  
  let html = `
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
      <h2>🏆 Tournament Bracket</h2>
      <div style="display: flex; gap: 8px;">
        <button onclick="showSimpleBracket()" class="btn-secondary" style="padding: 8px 12px;">
          🏀 Simple View
        </button>
        <button onclick="showTournamentOverview()" class="btn-secondary" style="padding: 8px 12px;">
          📅 All Matches
        </button>
      </div>
    </div>

    <div style="background: linear-gradient(135deg, #f59e0b, #d97706); padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; border: 2px solid #fbbf24;">
      <div style="font-size: 1.5em; color: white; font-weight: bold;">
        🏆 CHAMPION: ${window.TOURNAMENT.champion?.name || 'TBD'}
      </div>
    </div>

    <div class="bracket-container" style="display: flex; gap: 20px; overflow-x: auto; padding: 20px; background: #0f172a; border-radius: 12px;">
  `;

  bracket.forEach(roundData => {
    const roundName = roundData.round;
    const matches = roundData.matches || [];

    if (matches.length === 0) return;

    html += `
      <div class="bracket-round" style="flex: 1; min-width: 250px;">
        <h3 style="text-align: center; color: #60a5fa; margin-bottom: 15px; font-size: 1.1em; padding: 10px; background: rgba(59, 130, 246, 0.2); border-radius: 8px;">
          ${roundName}
        </h3>
        <div style="display: flex; flex-direction: column; gap: 20px;">
    `;

    matches.forEach(match => {
      if (!match) return;

      const isFinal = roundName === 'Final';
      const winner = match.winner?.name || 'TBD';

      if (isFinal) {
        const finalMatch = match.matchDetails || match;
        const matchId = finalMatch.matchId || finalMatch.id;
        
        html += `
          <div onclick="viewMatchDetails('${matchId}')" 
               style="background: linear-gradient(135deg, #1e293b, #0f172a); border-radius: 10px; overflow: hidden; border: 2px solid #f59e0b; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3); cursor: pointer; transition: all 0.3s ease;"
               onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 24px rgba(245, 158, 11, 0.5)'"
               onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(245, 158, 11, 0.3)'">
            
            <div style="background: linear-gradient(135deg, #f59e0b, #d97706); padding: 10px; text-align: center; color: white; font-weight: bold;">
              🏆 THE FINAL
            </div>
            
            <div style="padding: 15px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 10px; background: ${finalMatch.scoreA > finalMatch.scoreB ? 'rgba(16, 185, 129, 0.2)' : 'rgba(30, 41, 59, 0.5)'}; border-radius: 6px; ${finalMatch.scoreA > finalMatch.scoreB ? 'border-left: 4px solid #10b981;' : ''}">
                <span style="color: ${finalMatch.scoreA > finalMatch.scoreB ? '#10b981' : '#e5e7eb'}; font-weight: ${finalMatch.scoreA > finalMatch.scoreB ? 'bold' : '500'}; font-size: 1.05em;">
                  ${match.teamA?.name || 'Unknown'}
                </span>
                <span style="color: white; font-weight: bold; font-size: 1.5em;">
                  ${finalMatch.scoreA || 0}
                </span>
              </div>
              
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: ${finalMatch.scoreB > finalMatch.scoreA ? 'rgba(16, 185, 129, 0.2)' : 'rgba(30, 41, 59, 0.5)'}; border-radius: 6px; ${finalMatch.scoreB > finalMatch.scoreA ? 'border-left: 4px solid #10b981;' : ''}">
                <span style="color: ${finalMatch.scoreB > finalMatch.scoreA ? '#10b981' : '#e5e7eb'}; font-weight: ${finalMatch.scoreB > finalMatch.scoreA ? 'bold' : '500'}; font-size: 1.05em;">
                  ${match.teamB?.name || 'Unknown'}
                </span>
                <span style="color: white; font-weight: bold; font-size: 1.5em;">
                  ${finalMatch.scoreB || 0}
                </span>
              </div>

              ${match.penaltiesUsed ? `
                <div style="background: rgba(245, 158, 11, 0.2); padding: 8px; margin-top: 10px; text-align: center; color: #fbbf24; font-weight: bold; border-radius: 6px;">
                  🎯 Penalties: ${match.penaltyScoreA}-${match.penaltyScoreB}
                </div>
              ` : ''}
              
              <div style="margin-top: 10px; text-align: center; color: #60a5fa; font-size: 0.9em;">
                👆 Click for full match details
              </div>
            </div>
          </div>
        `;
      } else {
        // Two-leg tie - make both legs clickable
        const firstLeg = match.firstLeg;
        const secondLeg = match.secondLeg;
        const firstLegId = firstLeg?.matchId || firstLeg?.id;
        const secondLegId = secondLeg?.matchId || secondLeg?.id;
        
        html += `
          <div style="background: linear-gradient(135deg, #1e293b, #0f172a); border-radius: 10px; overflow: hidden; border: 1px solid #374151; transition: all 0.2s ease;">
            
            <div style="background: rgba(59, 130, 246, 0.2); padding: 8px; text-align: center; color: #60a5fa; font-weight: 600; font-size: 0.9em;">
              ${roundName}
            </div>
            
            <div style="padding: 12px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding: 10px; background: ${match.winner?.name === match.teamA?.name ? 'rgba(16, 185, 129, 0.15)' : 'rgba(30, 41, 59, 0.3)'}; border-radius: 6px; ${match.winner?.name === match.teamA?.name ? 'border-left: 3px solid #10b981;' : ''}">
                <span style="color: ${match.winner?.name === match.teamA?.name ? '#10b981' : '#e5e7eb'}; font-weight: ${match.winner?.name === match.teamA?.name ? 'bold' : '500'};">
                  ${match.teamA?.name || 'TBD'}
                </span>
                <span style="color: ${match.winner?.name === match.teamA?.name ? '#10b981' : 'white'}; font-weight: bold; font-size: 1.2em;">
                  ${match.aggScoreA || 0}
                </span>
              </div>
              
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 10px; background: ${match.winner?.name === match.teamB?.name ? 'rgba(16, 185, 129, 0.15)' : 'rgba(30, 41, 59, 0.3)'}; border-radius: 6px; ${match.winner?.name === match.teamB?.name ? 'border-left: 3px solid #10b981;' : ''}">
                <span style="color: ${match.winner?.name === match.teamB?.name ? '#10b981' : '#e5e7eb'}; font-weight: ${match.winner?.name === match.teamB?.name ? 'bold' : '500'};">
                  ${match.teamB?.name || 'TBD'}
                </span>
                <span style="color: ${match.winner?.name === match.teamB?.name ? '#10b981' : 'white'}; font-weight: bold; font-size: 1.2em;">
                  ${match.aggScoreB || 0}
                </span>
              </div>

              <!-- Clickable Legs -->
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
                ${firstLegId ? `
                  <button onclick="event.stopPropagation(); viewMatchDetails('${firstLegId}')" 
                          class="btn-secondary" 
                          style="padding: 6px; font-size: 0.8em; width: 100%;">
                    1st Leg: ${firstLeg?.scoreA || 0}-${firstLeg?.scoreB || 0}
                  </button>
                ` : '<div></div>'}
                
                ${secondLegId ? `
                  <button onclick="event.stopPropagation(); viewMatchDetails('${secondLegId}')" 
                          class="btn-secondary" 
                          style="padding: 6px; font-size: 0.8em; width: 100%;">
                    2nd Leg: ${secondLeg?.scoreA || 0}-${secondLeg?.scoreB || 0}
                  </button>
                ` : '<div></div>'}
              </div>

              ${match.penaltiesUsed ? `
                <div style="background: rgba(245, 158, 11, 0.15); padding: 6px; margin-top: 8px; text-align: center; color: #fbbf24; font-size: 0.85em; border-radius: 4px;">
                  🎯 ${match.penaltyScoreA}-${match.penaltyScoreB} Pens
                </div>
              ` : ''}
            </div>
          </div>
        `;
      }
    });

    html += `
        </div>
      </div>
    `;
  });

  html += `</div>`;
  out.innerHTML = html;
  console.log('✅ Tournament bracket rendered with clickable matches');

  // Enable bracket zoom functionality
  setTimeout(() => makeBracketZoomable(), 100);
}
function showSimpleBracket() {
  const out = document.getElementById('output');
  if (!out) return;

  if (!window.TOURNAMENT || !window.TOURNAMENT.bracket || window.TOURNAMENT.bracket.length === 0) {
    out.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">🏆</div>
        <h2>No Bracket Available</h2>
        <p class="output-sub">Complete the knockout stage to view the bracket.</p>
      </div>
    `;
    return;
  }

  const bracket = window.TOURNAMENT.bracket;
  const champion = window.TOURNAMENT.champion?.name || 'TBD';

  let html = `
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
      <h2>🏀 Tournament Bracket</h2>
      <button onclick="showTournamentBracket()" class="btn-secondary" style="padding: 8px 12px;">
        📋 Detailed View
      </button>
    </div>

    <div style="background: linear-gradient(135deg, #f59e0b, #d97706); padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; border: 2px solid #fbbf24;">
      <div style="font-size: 1.5em; color: white; font-weight: bold;">
        🏆 CHAMPION: ${champion}
      </div>
    </div>

    <div class="simple-bracket" style="display: flex; justify-content: space-around; gap: 20px; overflow-x: auto; padding: 20px; background: #0f172a; border-radius: 12px;">
  `;

  // Render each round as a column
  bracket.forEach((roundData, roundIndex) => {
    const roundName = roundData.round;
    const matches = roundData.matches || [];
    
    if (matches.length === 0) return;

    const isFinal = roundName === 'Final';
    
    html += `
      <div class="bracket-round-column" style="flex: 1; min-width: 200px;">
        <h3 style="text-align: center; color: #60a5fa; margin-bottom: 15px; font-size: 1em; padding: 8px; background: rgba(59, 130, 246, 0.2); border-radius: 8px;">
          ${roundName}
        </h3>
        <div style="display: flex; flex-direction: column; gap: ${isFinal ? '0' : '25px'};">
    `;

    matches.forEach((match, matchIndex) => {
      if (!match) return;

      const winner = match.winner?.name;
      
      if (isFinal) {
        // Final match - single game
        const finalMatch = match.matchDetails || match;
        const scoreA = finalMatch.scoreA || 0;
        const scoreB = finalMatch.scoreB || 0;
        const teamAWon = scoreA > scoreB;
        const teamBWon = scoreB > scoreA;
        
        html += `
          <div style="background: linear-gradient(135deg, #1e293b, #0f172a); border-radius: 10px; overflow: hidden; border: 2px solid #f59e0b; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);">
            <div style="background: linear-gradient(135deg, #f59e0b, #d97706); padding: 8px; text-align: center; color: white; font-weight: bold; font-size: 0.9em;">
              🏆 THE FINAL
            </div>
            
            <div onclick="openMatchDetail('${finalMatch.matchId || finalMatch.id}')" style="cursor: pointer;">
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; border-bottom: 1px solid #374151; background: ${teamAWon ? 'rgba(16, 185, 129, 0.2)' : 'rgba(30, 41, 59, 0.5)'}; ${teamAWon ? 'border-left: 4px solid #10b981;' : ''}">
                <span style="color: ${teamAWon ? '#10b981' : '#e5e7eb'}; font-weight: ${teamAWon ? 'bold' : '500'}; font-size: 0.95em;">
                  ${match.teamA?.name || 'Unknown'}
                </span>
                <span style="color: white; font-weight: bold; font-size: 1.2em; min-width: 25px; text-align: center;">
                  ${scoreA}
                </span>
              </div>
              
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: ${teamBWon ? 'rgba(16, 185, 129, 0.2)' : 'rgba(30, 41, 59, 0.5)'}; ${teamBWon ? 'border-left: 4px solid #10b981;' : ''}">
                <span style="color: ${teamBWon ? '#10b981' : '#e5e7eb'}; font-weight: ${teamBWon ? 'bold' : '500'}; font-size: 0.95em;">
                  ${match.teamB?.name || 'Unknown'}
                </span>
                <span style="color: white; font-weight: bold; font-size: 1.2em; min-width: 25px; text-align: center;">
                  ${scoreB}
                </span>
              </div>
            </div>

            ${match.penaltiesUsed ? `
              <div style="background: rgba(245, 158, 11, 0.2); padding: 6px; text-align: center; color: #fbbf24; font-size: 0.85em; border-top: 1px solid #f59e0b;">
                🎯 Penalties: ${match.penaltyScoreA}-${match.penaltyScoreB}
              </div>
            ` : ''}
          </div>
        `;
      } else {
        // Two-leg tie
        const aggScoreA = match.aggScoreA || 0;
        const aggScoreB = match.aggScoreB || 0;
        const teamAWon = winner === match.teamA?.name;
        const teamBWon = winner === match.teamB?.name;
        
        html += `
          <div style="background: linear-gradient(135deg, #1e293b, #0f172a); border-radius: 8px; overflow: hidden; border: 1px solid #374151; transition: all 0.2s ease;"
               onmouseover="this.style.borderColor='#3b82f6'; this.style.transform='translateY(-2px)'"
               onmouseout="this.style.borderColor='#374151'; this.style.transform='translateY(0)'">
            
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; border-bottom: 1px solid #374151; background: ${teamAWon ? 'rgba(16, 185, 129, 0.15)' : 'rgba(30, 41, 59, 0.3)'}; ${teamAWon ? 'border-left: 3px solid #10b981;' : ''}">
              <span style="color: ${teamAWon ? '#10b981' : '#e5e7eb'}; font-weight: ${teamAWon ? 'bold' : '500'}; font-size: 0.9em;">
                ${match.teamA?.name || 'TBD'}
              </span>
              <span style="color: ${teamAWon ? '#10b981' : 'white'}; font-weight: bold; font-size: 1.1em; min-width: 25px; text-align: center;">
                ${aggScoreA}
              </span>
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: ${teamBWon ? 'rgba(16, 185, 129, 0.15)' : 'rgba(30, 41, 59, 0.3)'}; ${teamBWon ? 'border-left: 3px solid #10b981;' : ''}">
              <span style="color: ${teamBWon ? '#10b981' : '#e5e7eb'}; font-weight: ${teamBWon ? 'bold' : '500'}; font-size: 0.9em;">
                ${match.teamB?.name || 'TBD'}
              </span>
              <span style="color: ${teamBWon ? '#10b981' : 'white'}; font-weight: bold; font-size: 1.1em; min-width: 25px; text-align: center;">
                ${aggScoreB}
              </span>
            </div>

            ${match.penaltiesUsed ? `
              <div style="background: rgba(245, 158, 11, 0.15); padding: 4px 8px; text-align: center; color: #fbbf24; font-size: 0.8em; border-top: 1px solid #374151;">
                🎯 ${match.penaltyScoreA}-${match.penaltyScoreB} Pens
              </div>
            ` : `
              <div style="padding: 4px 8px; text-align: center; color: #6b7280; font-size: 0.75em; border-top: 1px solid #374151;">
                Agg: ${aggScoreA}-${aggScoreB}
              </div>
            `}
          </div>
        `;
      }
    });

    html += `
        </div>
      </div>
    `;
  });

  html += `</div>`;
  
  out.innerHTML = html;
  console.log('✅ Simple bracket rendered');
}
// showCustomMatchInterface is defined earlier in the file

function filterHistoryContent(filter) {
  if (window.VERBOSE_LOGGING) console.log('Filtering history with:', filter);
}

function openTeamDetail(teamName) {
  const team = TEAM_MAP.get(teamName);
  if (!team) return;

  const modal = document.getElementById('teamDetailModal');
  if (!modal) return;

  populateTeamDetailModal(team);
  ModalManager.open('teamDetailModal');
}

/**
 * Simpler cumulative legacy updater. Use alongside updateTournamentLegacy
 * if you want raw counts without per-tournament dedupe.
 */
function updateClubLegacy(tournamentResults) {
  if (!tournamentResults || !tournamentResults.champion) return;

  const champion = tournamentResults.champion.name;

  if (!CLUB_LEGACY_DB.champions) CLUB_LEGACY_DB.champions = {};
  if (!CLUB_LEGACY_DB.totalWins) CLUB_LEGACY_DB.totalWins = {};

  CLUB_LEGACY_DB.champions[champion] = (CLUB_LEGACY_DB.champions[champion] || 0) + 1;
  CLUB_LEGACY_DB.totalWins[champion] = (CLUB_LEGACY_DB.totalWins[champion] || 0) + 1;

  if (window.VERBOSE_LOGGING) console.log(`🏆 ${champion} added to champions legacy`);
}

/************* MOBILE TOUCH GESTURES *************/

let touchStartX = 0;
let touchEndX = 0;
let touchStartY = 0;
let touchEndY = 0;

function initializeTouchGestures() {
  const sidebar = document.querySelector('.sidebar');
  if (!sidebar) {
    console.warn('⚠️ Sidebar not found for touch gestures');
    return;
  }

  sidebar.addEventListener('touchstart', handleTouchStart, { passive: true });
  sidebar.addEventListener('touchend', handleTouchEnd, { passive: true });

  console.log('✅ Touch gestures initialized');
}

function handleTouchStart(e) {
  touchStartX = e.changedTouches[0].screenX;
  touchStartY = e.changedTouches[0].screenY;
}

function handleTouchEnd(e) {
  touchEndX = e.changedTouches[0].screenX;
  touchEndY = e.changedTouches[0].screenY;
  handleSwipeGesture();
}

function handleSwipeGesture() {
  const swipeThreshold = 50; // Minimum swipe distance in pixels
  const deltaX = touchEndX - touchStartX;
  const deltaY = touchEndY - touchStartY;

  // Only trigger horizontal swipes (ignore vertical scrolling)
  if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > swipeThreshold) {
    if (deltaX > 0) {
      // Swipe right - go to previous tab
      switchToPreviousTab();
    } else {
      // Swipe left - go to next tab
      switchToNextTab();
    }
  }
}

function switchToPreviousTab() {
  const tabs = ['tab-tournament', 'tab-views', 'tab-tools', 'tab-settings', 'tab-profile'];
  const currentTab = document.querySelector('.sidebar-tab.active');
  if (!currentTab) return;

  const currentId = currentTab.getAttribute('data-tab');
  const currentIndex = tabs.indexOf(currentId);

  if (currentIndex > 0) {
    const prevTab = document.querySelector(`[data-tab="${tabs[currentIndex - 1]}"]`);
    if (prevTab) {
      prevTab.click();
      // Haptic feedback for mobile
      if (navigator.vibrate) {
        navigator.vibrate(10);
      }
    }
  }
}

function switchToNextTab() {
  const tabs = ['tab-tournament', 'tab-views', 'tab-tools', 'tab-settings', 'tab-profile'];
  const currentTab = document.querySelector('.sidebar-tab.active');
  if (!currentTab) return;

  const currentId = currentTab.getAttribute('data-tab');
  const currentIndex = tabs.indexOf(currentId);

  if (currentIndex < tabs.length - 1) {
    const nextTab = document.querySelector(`[data-tab="${tabs[currentIndex + 1]}"]`);
    if (nextTab) {
      nextTab.click();
      // Haptic feedback for mobile
      if (navigator.vibrate) {
        navigator.vibrate(10);
      }
    }
  }
}

/************* MASTER DOM INITIALIZER *************/

document.addEventListener('DOMContentLoaded', async function () {
  if (window.VERBOSE_LOGGING) console.log("🏁 Initializing All-Time Football Simulator...");

  // Load tournament history from localStorage
  try {
    const savedHistory = localStorage.getItem('tournamentHistory');
    if (savedHistory) {
      const parsedHistory = JSON.parse(savedHistory);
      if (Array.isArray(parsedHistory)) {
        TOURNAMENT_HISTORY.length = 0;
        TOURNAMENT_HISTORY.push(...parsedHistory);
        if (window.VERBOSE_LOGGING) console.log(`📊 Loaded ${TOURNAMENT_HISTORY.length} tournaments from localStorage`);
      }
    }
  } catch (e) {
    console.error('❌ Failed to load tournament history:', e);
  }

  // Show early loading indicator
  const loadingOverlay = document.getElementById("loadingOverlay");
  if (loadingOverlay) {
    const textEl = document.getElementById("loadingText");
    if (textEl) textEl.textContent = "Initializing teams...";
    loadingOverlay.classList.add("active");
  }

  // Small delay to let loading overlay show
  await new Promise(resolve => setTimeout(resolve, 50));

  // Initialize TEAM_POOL first (async to prevent freezing on page load)
  if (typeof TEAM_POOL !== 'undefined' && TEAM_POOL.length > 0) {
    await initTeamsAndPlayers();
  }

  // Hide loading overlay
  if (loadingOverlay) {
    loadingOverlay.classList.remove("active");
  }

  if (typeof injectAllStyles === 'function') injectAllStyles();
  if (typeof initializeTheme === 'function') initializeTheme();
  if (typeof initializeRNG === 'function') initializeRNG();
  if (typeof initializeSimSpeed === 'function') initializeSimSpeed();
  if (typeof initializeExportFeatures === 'function') initializeExportFeatures();
  if (typeof initializeModalSystem === 'function') initializeModalSystem();
  if (typeof initializeCustomMatchInterface === 'function') initializeCustomMatchInterface();
  if (typeof initializeCoreSystems === 'function') initializeCoreSystems();
  if (typeof updateButtonStates === 'function') updateButtonStates();

  const teamCountEl = document.getElementById('teamCount');
  if (teamCountEl && Array.isArray(TEAM_POOL)) {
    teamCountEl.textContent = Math.min(TEAM_POOL.length, 64).toString();
  }

  const connectViewButton = (buttonId, fn, name) => {
    const button = document.getElementById(buttonId);
    if (!button) {
      console.warn(`Button ${buttonId} not found`);
      return null;
    }

    // Remove any existing listeners
    const newButton = button.cloneNode(true);
    button.parentNode.replaceChild(newButton, button);

    newButton.addEventListener('click', (e) => {
      e.preventDefault();
      if (window.VERBOSE_LOGGING) console.log(`${name} button clicked`);

      if (typeof fn === 'function') {
        try {
          fn();
        } catch (error) {
          console.error(`Error in ${name}:`, error);
          if (typeof showUtilityMessage === 'function') {
            showUtilityMessage(`Error in ${name}: ${error.message}`, 'error');
          }
        }
      } else {
        console.error(`${name} function not available`);
        if (typeof showUtilityMessage === 'function') {
          showUtilityMessage(`Error: ${name} function not available`, 'error');
        }
      }
    });

    return newButton;
  };

  // Connect all main buttons
  connectViewButton('btnDraw', handleGenerateGroups, 'Generate Groups');
  connectViewButton('btnGroupStage', runGroupStage, 'Group Stage');
  connectViewButton('btnKnockouts', runKnockouts, 'Knockouts');
  connectViewButton('btnStats', showPlayerStats, 'Player Stats');
  connectViewButton('btnAllMatches', showTournamentOverview, 'All Matches');
  connectViewButton('btnMatchWeeks', showMatchWeeks, 'Matchdays');
  connectViewButton('btnClubLegacy', showClubLegacy, 'Club Legacy');
  connectViewButton('customMatchBtn', showEnhancedCustomMatch, 'Custom Match');
  connectViewButton('btnHistory', openHistory, 'History');

  // Connect utility buttons
  const exportBtn = document.getElementById('exportTournamentBtn');
  if (exportBtn && typeof exportTournament === 'function') {
    exportBtn.addEventListener('click', exportTournament);
  }

  const resetBtn = document.getElementById('resetTournamentBtn');
  if (resetBtn && typeof resetTournament === 'function') {
    resetBtn.addEventListener('click', resetTournament);
  }

  const importBtn = document.getElementById('importSaveBtn');
  if (importBtn && typeof handleImport === 'function') {
    importBtn.addEventListener('click', handleImport);
  }

  const themeToggle = document.getElementById('themeToggle');
  if (themeToggle) {
    themeToggle.addEventListener('click', toggleTheme);
  }

  // Initialize new features
  fixDuplicateButtons();
  injectTopPerformerStyles();
  injectEnhancedLayoutStyles();
  populateCustomMatchDropdowns();

  // Initialize manager profile UI
  updateManagerProfileUI();

  // Initialize difficulty UI
  if (typeof setDifficulty === 'function') {
    // Set UI to reflect saved difficulty
    const buttons = document.querySelectorAll('[data-difficulty]');
    buttons.forEach(btn => {
      if (btn.getAttribute('data-difficulty') === window.CURRENT_DIFFICULTY) {
        btn.classList.add('active');
      } else {
        btn.classList.remove('active');
      }
    });

    const difficulty = getCurrentDifficulty();
    const descEl = document.getElementById('difficultyDescription');
    if (descEl && difficulty) {
      descEl.textContent = difficulty.description;
      descEl.style.color = difficulty.color;
    }
  }

  // Initialize touch gestures for mobile devices
  setTimeout(() => {
    if (typeof initializeTouchGestures === 'function') {
      initializeTouchGestures();
    }
  }, 100);

  console.log("🎉 Simulator initialized successfully!");
});

/************* COMPLETE FIXES SCRIPT *************/

// Fix duplicate buttons
function fixDuplicateButtons() {
  const buttons = document.querySelectorAll('button');
  const seen = new Map();

  buttons.forEach(btn => {
    const text = btn.textContent.trim();
    if (text && seen.has(text)) {
      const existing = seen.get(text);
      if (existing.onclick === btn.onclick && existing.parentElement === btn.parentElement) {
        btn.remove();
        if (window.VERBOSE_LOGGING) console.log('Removed duplicate button:', text);
      }
    } else if (text) {
      seen.set(text, btn);
    }
  });
}

// Inject top performer styles
function injectTopPerformerStyles() {
  const styleId = 'top-performer-styles';
  if (document.getElementById(styleId)) return;

  const style = document.createElement('style');
  style.id = styleId;
  style.textContent = `
    .top-performers-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
      padding: 20px 0;
    }

    .performer-card {
      position: relative;
      overflow: visible;
    }

    .performer-rank-badge {
      position: absolute;
      top: -10px;
      right: -10px;
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1.1em;
      color: #000;
      box-shadow: 0 4px 12px rgba(251, 191, 36, 0.4);
      z-index: 10;
    }
  `;
  document.head.appendChild(style);
}

// Inject enhanced layout styles
function injectEnhancedLayoutStyles() {
  const styleId = 'enhanced-layout-styles';
  if (document.getElementById(styleId)) return;

  const style = document.createElement('style');
  style.id = styleId;
  style.textContent = `
    /* Enhanced match card styling */
    .match-card-enhanced {
      background: linear-gradient(135deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.9));
      border: 1px solid rgba(59, 130, 246, 0.3);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .match-card-enhanced:hover {
      border-color: rgba(16, 185, 129, 0.6);
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(16, 185, 129, 0.2);
    }

    /* Enhanced button styling */
    .btn-enhanced {
      background: linear-gradient(135deg, #10b981, #059669);
      border: none;
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    .btn-enhanced:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
    }

    .btn-enhanced:active {
      transform: translateY(0);
    }

    /* Modal improvements */
    .modal-backdrop.active {
      /* backdrop-filter removed for performance */
      background: rgba(0, 0, 0, 0.7);
    }

    .modal-content {
      max-height: 85vh;
      overflow-y: auto;
    }

    /* Scrollbar styling */
    .modal-content::-webkit-scrollbar {
      width: 8px;
    }

    .modal-content::-webkit-scrollbar-track {
      background: rgba(30, 41, 59, 0.5);
      border-radius: 4px;
    }

    .modal-content::-webkit-scrollbar-thumb {
      background: rgba(16, 185, 129, 0.5);
      border-radius: 4px;
    }

    .modal-content::-webkit-scrollbar-thumb:hover {
      background: rgba(16, 185, 129, 0.7);
    }
  `;
  document.head.appendChild(style);
}

// Enhanced statistics display
function showEnhancedStatistics() {
  const out = document.getElementById('output');
  if (!out) return;

  const stats = calculateTournamentStats();
  if (!stats) {
    showPlayerStats();
    return;
  }

  // Show both tournament stats and player stats
  let html = `
    <div style="margin-bottom: 30px;">
      <h2 style="color: #10b981; margin-bottom: 20px;">📊 Tournament Statistics</h2>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
        <div class="stat-card">
          <div class="stat-value">${stats.goalsPerGame}</div>
          <div class="stat-label">Goals Per Game</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${stats.biggestWin.diff}</div>
          <div class="stat-label">Biggest Win</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${stats.cleanSheets}</div>
          <div class="stat-label">Clean Sheets</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${stats.totalMatches}</div>
          <div class="stat-label">Total Matches</div>
        </div>
      </div>

      <button onclick="showPlayerStats()" class="btn-enhanced" style="margin-top: 20px;">
        📈 View Player Stats
      </button>
    </div>
  `;

  out.innerHTML = html;
}

// Ensure champion is properly formatted
function ensureChampionFormat(championData) {
  if (!championData) return null;

  if (typeof championData === 'string') {
    return {
      name: championData,
      season: 'Unknown Era',
      strength: 0
    };
  }

  if (typeof championData === 'object') {
    return {
      name: championData.name || 'Unknown',
      season: championData.season || 'Unknown Era',
      strength: championData.strength || championData.overall || 0
    };
  }

  return null;
}

// Fix match details to ensure numeric scores
function ensureMatchDetailsFormat(matchDetails) {
  if (!matchDetails) return null;

  return {
    ...matchDetails,
    scoreA: Number(matchDetails.scoreA) || 0,
    scoreB: Number(matchDetails.scoreB) || 0,
    goalsA: matchDetails.goalsA || [],
    goalsB: matchDetails.goalsB || [],
    teamA: matchDetails.teamA || 'Unknown',
    teamB: matchDetails.teamB || 'Unknown'
  };
}

console.log('✅ Complete fixes script loaded');

// ========================================
// MOMENTUM SYSTEM - Dynamic Match Flow
// ========================================
const MOMENTUM_SYSTEM = {
  current: 0, // -100 (Team B dominant) to +100 (Team A dominant)

  events: {
    goal: { shift: 30, decay: 0.9 },
    miss: { shift: -15, decay: 0.95 },
    save: { shift: 10, decay: 0.98 },
    injury: { shift: -20, decay: 0.92 },
    yellowCard: { shift: -8, decay: 0.97 },
    redCard: { shift: -35, decay: 0.85 }
  },

  reset() {
    this.current = 0;
  },

  applyMomentum(baseProb, team) {
    const momentumEffect = this.current / 100; // -1 to +1

    if (team === 'A') {
      return baseProb * (1 + momentumEffect * 0.4);
    } else {
      return baseProb * (1 - momentumEffect * 0.4);
    }
  },

  updateMomentum(event, team) {
    const eventData = this.events[event];
    if (!eventData) return;

    const shift = eventData.shift * (team === 'A' ? 1 : -1);
    this.current = Math.max(-100, Math.min(100, this.current + shift));

    this.decay(eventData.decay);
  },

  decay(rate) {
    this.current *= rate;
    if (Math.abs(this.current) < 1) this.current = 0;
  },

  getVisualMomentum(teamA, teamB) {
    const normalized = (this.current + 100) / 200; // 0 to 1
    const barPosition = normalized * 100;

    return `
      <div class="momentum-bar" style="position: relative; height: 40px; display: flex; border-radius: 8px; overflow: hidden; margin: 15px 0;">
        <div class="team-a-zone" style="width: 50%; background: linear-gradient(to right, #3b82f6, rgba(59, 130, 246, 0.3)); display: flex; align-items: center; padding: 0 15px; color: white; font-weight: 600; font-size: 0.85em;">
          <span>${teamA.name}</span>
        </div>
        <div class="team-b-zone" style="width: 50%; background: linear-gradient(to left, #ef4444, rgba(239, 68, 68, 0.3)); display: flex; align-items: center; justify-content: flex-end; padding: 0 15px; color: white; font-weight: 600; font-size: 0.85em;">
          <span>${teamB.name}</span>
        </div>
        <div class="momentum-indicator" style="position: absolute; top: 50%; left: ${barPosition}%; transform: translate(-50%, -50%); font-size: 1.5em; filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.8)); transition: left 0.6s cubic-bezier(0.4, 0, 0.2, 1);">
          🔥
        </div>
      </div>
      <div class="momentum-text" style="text-align: center; font-weight: 600; color: #fbbf24; margin-top: 5px; font-size: 0.85em;">
        ${this.getMomentumDescription(teamA, teamB)}
      </div>
    `;
  },

  getMomentumDescription(teamA, teamB) {
    const abs = Math.abs(this.current);
    const team = this.current > 0 ? teamA.name : teamB.name;

    if (abs > 70) return `${team} completely dominating`;
    if (abs > 50) return `${team} in control`;
    if (abs > 30) return `${team} with slight advantage`;
    if (abs > 10) return `${team} edging it`;
    return 'Evenly matched';
  }
};

// ========================================
// HALL OF FAME SYSTEM - Legends & Records
// ========================================
const HALL_OF_FAME = {
  records: {
    mostGoalsSingleTournament: { value: 0, holder: null, tournament: null, date: null },
    mostGoalsSingleMatch: { value: 0, holder: null, match: null, date: null },
    mostAssistsSingleTournament: { value: 0, holder: null, tournament: null, date: null },
    highestAvgRating: { value: 0, holder: null, tournament: null, date: null },
    longestWinStreak: { value: 0, holder: null, span: null, date: null },
    mostCleanSheets: { value: 0, holder: null, tournament: null, date: null },
    biggestComeback: { value: 0, match: null, from: null, to: null, date: null },
    longestPenaltyShootout: { value: 0, match: null, score: null, date: null },
    fastestHattrick: { value: Infinity, holder: null, match: null, date: null },
    highestScoringMatch: { value: 0, match: null, score: null, date: null }
  },

  legends: [],

  init() {
    const saved = localStorage.getItem('hallOfFame');
    if (saved) {
      try {
        const data = JSON.parse(saved);
        this.records = data.records || this.records;
        this.legends = data.legends || [];
      } catch (e) {
        console.error('Failed to load Hall of Fame:', e);
      }
    }
  },

  save() {
    localStorage.setItem('hallOfFame', JSON.stringify({
      records: this.records,
      legends: this.legends
    }));
  },

  checkRecords(tournament) {
    const newRecords = [];

    // Check player records if PLAYER_DB exists
    if (typeof PLAYER_DB !== 'undefined') {
      Object.values(PLAYER_DB).forEach(player => {
        if (player.goals > this.records.mostGoalsSingleTournament.value) {
          this.records.mostGoalsSingleTournament = {
            value: player.goals,
            holder: player.name,
            tournament: tournament?.name || 'Tournament',
            date: new Date().toISOString()
          };
          newRecords.push({
            type: 'Most Goals (Tournament)',
            holder: player.name,
            value: player.goals
          });
        }

        if (player.avgRating > this.records.highestAvgRating.value) {
          this.records.highestAvgRating = {
            value: player.avgRating,
            holder: player.name,
            tournament: tournament?.name || 'Tournament',
            date: new Date().toISOString()
          };
          newRecords.push({
            type: 'Highest Avg Rating',
            holder: player.name,
            value: player.avgRating.toFixed(2)
          });
        }
      });
    }

    this.save();

    if (newRecords.length > 0) {
      this.showNewRecordsModal(newRecords);
    }

    return newRecords;
  },

  showNewRecordsModal(newRecords) {
    const modal = `
      <div class="modal-backdrop" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); z-index: 10000; display: flex; align-items: center; justify-content: center;" onclick="this.remove()">
        <div class="modal" style="max-width: 500px; width: 90%; background: linear-gradient(135deg, #1e293b, #334155); border-radius: 16px; padding: 30px; border: 2px solid #fbbf24;" onclick="event.stopPropagation()">
          <h2 style="color: #fbbf24; margin-bottom: 20px; text-align: center; font-size: 1.8em;">🏆 New Records Set!</h2>
          <div style="display: flex; flex-direction: column; gap: 15px;">
            ${newRecords.map(record => `
              <div style="background: rgba(251, 191, 36, 0.1); border: 1px solid rgba(251, 191, 36, 0.3); border-radius: 8px; padding: 15px;">
                <div style="color: #fbbf24; font-weight: 700; margin-bottom: 5px;">${record.type}</div>
                <div style="color: #f7fafc; font-size: 1.3em; font-weight: 600;">${record.holder}</div>
                <div style="color: #10b981; font-size: 1.5em; font-weight: 700; margin-top: 5px;">${record.value}</div>
              </div>
            `).join('')}
          </div>
          <button onclick="this.closest('.modal-backdrop').remove()" style="width: 100%; margin-top: 20px; background: #fbbf24; color: #0f172a; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 1em;">
            Amazing!
          </button>
        </div>
      </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modal);
  },

  inductLegend(player, reason) {
    const legend = {
      name: player.name,
      team: player.team,
      pos: player.pos,
      inductionDate: new Date().toISOString(),
      reason: reason,
      careerStats: {
        totalGoals: player.goals || 0,
        totalAssists: player.assists || 0,
        avgRating: player.avgRating || 0,
        appearances: player.apps || 0
      }
    };

    this.legends.push(legend);
    this.save();
    this.showInductionCeremony(legend);
  },

  showInductionCeremony(legend) {
    const modal = `
      <div class="modal-backdrop" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); z-index: 10000; display: flex; align-items: center; justify-content: center;" onclick="this.remove()">
        <div class="modal" style="max-width: 600px; width: 90%; background: linear-gradient(135deg, #1e293b, #334155); border-radius: 16px; padding: 40px; border: 3px solid #fbbf24; text-align: center;" onclick="event.stopPropagation()">
          <div style="font-size: 4em; margin-bottom: 20px;">🏛️</div>
          <h2 style="color: #fbbf24; margin-bottom: 15px; font-size: 2em;">Hall of Fame Induction!</h2>
          <h3 style="color: #f7fafc; margin-bottom: 10px; font-size: 1.5em;">${legend.name}</h3>
          <div style="color: #94a3b8; margin-bottom: 20px;">${legend.team} - ${legend.pos}</div>
          <div style="background: rgba(251, 191, 36, 0.1); border-radius: 12px; padding: 20px; margin: 20px 0;">
            <div style="color: #fbbf24; font-style: italic; margin-bottom: 15px;">"${legend.reason}"</div>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 15px;">
              <div>
                <div style="color: #94a3b8; font-size: 0.85em;">Goals</div>
                <div style="color: #10b981; font-size: 1.5em; font-weight: 700;">${legend.careerStats.totalGoals}</div>
              </div>
              <div>
                <div style="color: #94a3b8; font-size: 0.85em;">Assists</div>
                <div style="color: #3b82f6; font-size: 1.5em; font-weight: 700;">${legend.careerStats.totalAssists}</div>
              </div>
              <div>
                <div style="color: #94a3b8; font-size: 0.85em;">Avg Rating</div>
                <div style="color: #fbbf24; font-size: 1.5em; font-weight: 700;">${legend.careerStats.avgRating.toFixed(1)}</div>
              </div>
              <div>
                <div style="color: #94a3b8; font-size: 0.85em;">Apps</div>
                <div style="color: #a855f7; font-size: 1.5em; font-weight: 700;">${legend.careerStats.appearances}</div>
              </div>
            </div>
          </div>
          <button onclick="this.closest('.modal-backdrop').remove()" style="width: 100%; margin-top: 20px; background: #fbbf24; color: #0f172a; border: none; padding: 15px; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 1.1em;">
            🎉 Congratulations!
          </button>
        </div>
      </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modal);
  },

  checkInductionEligibility(player) {
    if (!player) return;

    const criteria = {
      goals: (player.goals || 0) >= 15,
      avgRating: (player.avgRating || 0) >= 8.5,
      apps: (player.apps || 0) >= 10
    };

    const meetsThreshold = Object.values(criteria).filter(Boolean).length >= 2;

    if (meetsThreshold && !this.isInHallOfFame(player.name)) {
      this.inductLegend(player, 'Exceptional career performance');
    }
  },

  isInHallOfFame(playerName) {
    return this.legends.some(l => l.name === playerName);
  }
};

function showHallOfFame() {
  const formatRecordName = (key) => {
    return key.replace(/([A-Z])/g, ' $1')
      .replace(/^./, str => str.toUpperCase())
      .trim();
  };

  const out = document.getElementById('output');

  out.innerHTML = `
    <div class="hall-of-fame" style="padding: 20px;">
      <div style="text-align: center; margin-bottom: 40px;">
        <h1 style="font-size: 3em; color: #fbbf24; margin-bottom: 10px;">🏛️ Hall of Fame</h1>
        <p style="color: #94a3b8; font-size: 1.1em;">Immortalized Legends & All-Time Records</p>
      </div>

      <div class="records-section" style="margin-bottom: 50px;">
        <h2 style="color: #10b981; margin-bottom: 20px; font-size: 1.8em;">📊 All-Time Records</h2>
        <div class="records-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px;">
          ${Object.entries(HALL_OF_FAME.records).map(([key, record]) => `
            <div class="record-card" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(59, 130, 246, 0.1)); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 12px; padding: 20px;">
              <div style="color: #94a3b8; font-size: 0.85em; margin-bottom: 8px; font-weight: 600;">${formatRecordName(key)}</div>
              <div style="color: #10b981; font-size: 2em; font-weight: 700; margin: 10px 0;">${record.value !== Infinity ? record.value : '-'}</div>
              <div style="color: #f7fafc; font-weight: 600; margin-bottom: 5px;">${record.holder || 'No record set'}</div>
              ${record.date ? `<div style="color: #64748b; font-size: 0.75em;">${new Date(record.date).toLocaleDateString()}</div>` : ''}
            </div>
          `).join('')}
        </div>
      </div>

      <div class="legends-section">
        <h2 style="color: #fbbf24; margin-bottom: 20px; font-size: 1.8em;">⭐ Inducted Legends</h2>
        ${HALL_OF_FAME.legends.length === 0 ? `
          <div style="text-align: center; padding: 60px 20px; background: rgba(100, 116, 139, 0.1); border-radius: 12px; border: 1px dashed rgba(148, 163, 184, 0.3);">
            <div style="font-size: 3em; margin-bottom: 15px; opacity: 0.3;">🏆</div>
            <p style="color: #64748b; font-size: 1.1em;">
              No legends inducted yet.<br>Achieve greatness to join the Hall of Fame!
            </p>
          </div>
        ` : `
          <div class="legends-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 25px;">
            ${HALL_OF_FAME.legends.map(legend => `
              <div class="legend-card" style="background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(168, 85, 247, 0.1)); border: 2px solid rgba(251, 191, 36, 0.4); border-radius: 12px; padding: 25px;">
                <div style="margin-bottom: 15px;">
                  <h3 style="color: #fbbf24; font-size: 1.4em; margin-bottom: 5px;">${legend.name}</h3>
                  <div style="color: #94a3b8; font-size: 0.9em;">${legend.team} - ${legend.pos}</div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin: 15px 0; padding: 15px; background: rgba(0, 0, 0, 0.2); border-radius: 8px;">
                  <div>
                    <div style="color: #94a3b8; font-size: 0.75em;">Goals</div>
                    <div style="color: #10b981; font-size: 1.3em; font-weight: 700;">⚽ ${legend.careerStats.totalGoals}</div>
                  </div>
                  <div>
                    <div style="color: #94a3b8; font-size: 0.75em;">Assists</div>
                    <div style="color: #3b82f6; font-size: 1.3em; font-weight: 700;">🎯 ${legend.careerStats.totalAssists}</div>
                  </div>
                  <div>
                    <div style="color: #94a3b8; font-size: 0.75em;">Rating</div>
                    <div style="color: #fbbf24; font-size: 1.3em; font-weight: 700;">⭐ ${legend.careerStats.avgRating.toFixed(1)}</div>
                  </div>
                  <div>
                    <div style="color: #94a3b8; font-size: 0.75em;">Apps</div>
                    <div style="color: #a855f7; font-size: 1.3em; font-weight: 700;">📅 ${legend.careerStats.appearances}</div>
                  </div>
                </div>
                <div style="color: #cbd5e1; font-style: italic; font-size: 0.9em; padding: 10px; background: rgba(251, 191, 36, 0.05); border-left: 3px solid #fbbf24; border-radius: 4px;">
                  "${legend.reason}"
                </div>
                <div style="color: #64748b; font-size: 0.75em; margin-top: 12px; text-align: center;">
                  Inducted: ${new Date(legend.inductionDate).toLocaleDateString()}
                </div>
              </div>
            `).join('')}
          </div>
        `}
      </div>

      <div style="margin-top: 40px; text-align: center;">
        <button onclick="closeAllModals()" class="btn-primary" style="background: #3b82f6; color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1em;">
          ← Back to Main
        </button>
      </div>
    </div>
  `;
}

// ========================================
// KEYBOARD SHORTCUTS
// ========================================
document.addEventListener('keydown', (e) => {
  // Only if not typing in input or textarea
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

  const shortcuts = {
    'Space': () => {
      e.preventDefault();
      if (typeof simulateNextMatchday === 'function') {
        simulateNextMatchday();
      }
    },
    'KeyS': () => {
      e.preventDefault();
      if (typeof quickSaveTournament === 'function') {
        quickSaveTournament();
      }
    },
    'KeyR': () => {
      e.preventDefault();
      if (typeof showStandings === 'function') {
        showStandings();
      }
    },
    'KeyP': () => {
      e.preventDefault();
      if (typeof showPlayerStats === 'function') {
        showPlayerStats();
      }
    },
    'KeyH': () => {
      e.preventDefault();
      showHallOfFame();
    }
    // Note: Escape key handled by global escape handler below
  };

  if (e.ctrlKey || e.metaKey) {
    if (e.code === 'KeyS') {
      e.preventDefault();
      if (typeof exportTournament === 'function') {
        exportTournament();
      }
    }
  } else {
    const action = shortcuts[e.code];
    if (action) {
      action();
    }
  }
});

function showKeyboardShortcuts() {
  const modal = `
    <div class="modal-backdrop" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); z-index: 10000; display: flex; align-items: center; justify-content: center;" onclick="this.remove()">
      <div class="modal" style="max-width: 500px; width: 90%; background: #1e293b; border-radius: 16px; padding: 30px; border: 1px solid rgba(16, 185, 129, 0.3);" onclick="event.stopPropagation()">
        <h3 style="color: #10b981; margin-bottom: 20px; font-size: 1.5em;">⌨️ Keyboard Shortcuts</h3>
        <table style="width: 100%; color: #f7fafc; font-size: 0.95em;">
          <tr style="border-bottom: 1px solid rgba(71, 85, 105, 0.3);">
            <td style="padding: 12px 8px; font-weight: 600; color: #fbbf24;">Space</td>
            <td style="padding: 12px 8px; color: #cbd5e1;">Simulate next match</td>
          </tr>
          <tr style="border-bottom: 1px solid rgba(71, 85, 105, 0.3);">
            <td style="padding: 12px 8px; font-weight: 600; color: #fbbf24;">S</td>
            <td style="padding: 12px 8px; color: #cbd5e1;">Quick save</td>
          </tr>
          <tr style="border-bottom: 1px solid rgba(71, 85, 105, 0.3);">
            <td style="padding: 12px 8px; font-weight: 600; color: #fbbf24;">R</td>
            <td style="padding: 12px 8px; color: #cbd5e1;">View results/standings</td>
          </tr>
          <tr style="border-bottom: 1px solid rgba(71, 85, 105, 0.3);">
            <td style="padding: 12px 8px; font-weight: 600; color: #fbbf24;">P</td>
            <td style="padding: 12px 8px; color: #cbd5e1;">View player stats</td>
          </tr>
          <tr style="border-bottom: 1px solid rgba(71, 85, 105, 0.3);">
            <td style="padding: 12px 8px; font-weight: 600; color: #fbbf24;">H</td>
            <td style="padding: 12px 8px; color: #cbd5e1;">Hall of Fame</td>
          </tr>
          <tr style="border-bottom: 1px solid rgba(71, 85, 105, 0.3);">
            <td style="padding: 12px 8px; font-weight: 600; color: #fbbf24;">ESC</td>
            <td style="padding: 12px 8px; color: #cbd5e1;">Close modals</td>
          </tr>
          <tr>
            <td style="padding: 12px 8px; font-weight: 600; color: #fbbf24;">Ctrl+S</td>
            <td style="padding: 12px 8px; color: #cbd5e1;">Export tournament</td>
          </tr>
        </table>
        <button onclick="this.closest('.modal-backdrop').remove()" style="width: 100%; margin-top: 20px; background: #10b981; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600;">
          Got it!
        </button>
      </div>
    </div>
  `;

  document.body.insertAdjacentHTML('beforeend', modal);
}

// ========================================
// ACHIEVEMENT PROGRESS TRACKER
// ========================================
function renderAchievementProgress() {
  if (typeof ACHIEVEMENTS === 'undefined') return '';

  const achievementsList = Object.values(ACHIEVEMENTS);
  const nearCompletion = achievementsList
    .filter(a => {
      if (a.unlocked) return false;
      if (!a.requiresProgress) return false;
      const progress = a.progress || 0;
      const max = a.maxProgress || 1;
      return progress / max > 0.3;
    })
    .sort((a, b) => {
      const progressA = (a.progress || 0) / (a.maxProgress || 1);
      const progressB = (b.progress || 0) / (b.maxProgress || 1);
      return progressB - progressA;
    })
    .slice(0, 3);

  if (nearCompletion.length === 0) return '';

  return `
    <div class="achievement-progress-widget" style="background: linear-gradient(135deg, rgba(168, 85, 247, 0.1), rgba(59, 130, 246, 0.1)); border: 1px solid rgba(168, 85, 247, 0.3); border-radius: 12px; padding: 20px; margin: 20px 0;">
      <h4 style="color: #a855f7; margin-bottom: 15px; font-size: 1.1em;">🎯 Achievement Progress</h4>
      ${nearCompletion.map(ach => {
        const progress = ach.progress || 0;
        const max = ach.maxProgress || 1;
        const percentage = (progress / max * 100).toFixed(0);
        return `
          <div class="progress-item" style="margin-bottom: 15px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
              <div style="color: #f7fafc; font-weight: 600; font-size: 0.9em;">${ach.icon || '🏆'} ${ach.name}</div>
              <div style="color: #94a3b8; font-size: 0.85em;">${progress}/${max}</div>
            </div>
            <div class="progress-bar" style="background: rgba(71, 85, 105, 0.3); height: 8px; border-radius: 4px; overflow: hidden;">
              <div class="progress-fill" style="width: ${percentage}%; height: 100%; background: linear-gradient(90deg, #a855f7, #3b82f6); transition: width 0.3s ease; border-radius: 4px;"></div>
            </div>
          </div>
        `;
      }).join('')}
    </div>
  `;
}

// ========================================
// QUICK ACTIONS BAR
// ========================================
function createQuickActionsBar() {
  // Check if already exists
  if (document.getElementById('quickActionsBar')) return;

  const bar = document.createElement('div');
  bar.id = 'quickActionsBar';
  bar.setAttribute('role', 'toolbar');
  bar.setAttribute('aria-label', 'Quick Actions');
  bar.style.cssText = 'position: fixed; bottom: 30px; right: 30px; background: linear-gradient(135deg, #1e293b, #334155); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 12px; padding: 12px; display: flex; gap: 10px; z-index: 9000; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);';

  const buttons = [
    { icon: '⚡', title: 'Simulate Next (Space)', action: 'simulateNextMatchday', ariaLabel: 'Simulate next matchday' },
    { icon: '📊', title: 'Standings (R)', action: 'showStandings', ariaLabel: 'Show tournament standings' },
    { icon: '💾', title: 'Save (S)', action: 'quickSaveTournament', ariaLabel: 'Quick save tournament' },
    { icon: '🏛️', title: 'Hall of Fame (H)', action: 'showHallOfFame', ariaLabel: 'Show Hall of Fame' },
    { icon: '⌨️', title: 'Shortcuts', action: 'showKeyboardShortcuts', ariaLabel: 'Show keyboard shortcuts' }
  ];

  buttons.forEach(btn => {
    const button = document.createElement('button');
    button.textContent = btn.icon;
    button.title = btn.title;
    button.setAttribute('aria-label', btn.ariaLabel);
    button.style.cssText = 'background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); color: #10b981; width: 45px; height: 45px; border-radius: 8px; cursor: pointer; font-size: 1.3em; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center;';
    button.onmouseover = () => {
      button.style.background = 'rgba(16, 185, 129, 0.2)';
      button.style.transform = 'translateY(-2px)';
    };
    button.onmouseout = () => {
      button.style.background = 'rgba(16, 185, 129, 0.1)';
      button.style.transform = 'translateY(0)';
    };
    button.onclick = () => {
      if (typeof window[btn.action] === 'function') {
        window[btn.action]();
      }
    };
    bar.appendChild(button);
  });

  document.body.appendChild(bar);
}

function quickSaveTournament() {
  if (typeof saveToLocalStorage === 'function') {
    saveToLocalStorage();
    showNotification('success', 'Saved', 'Tournament saved successfully', 2000);
  }
}

// Initialize all systems on page load
window.addEventListener('load', () => {
  // Core features initialization
  HALL_OF_FAME.init();
  createQuickActionsBar();

  // Aesthetic features initialization
  THEME_MANAGER.init();
  createThemeSwitcher();

  // Add ripple effect to all buttons
  document.querySelectorAll('button').forEach(button => {
    button.addEventListener('click', createRipple);
  });

  // Function wrappers now self-initialize with retry mechanism (see initializeFunctionWrappersSafely IIFE)

  // Initialize accessibility enhancements
  if (typeof initializeAccessibility === 'function') {
    initializeAccessibility();
  }

  // Initialize auto-save system
  if (typeof AUTO_SAVE !== 'undefined' && AUTO_SAVE.startAutoSave) {
    AUTO_SAVE.startAutoSave();
  }

  console.log('✅ All features loaded: Momentum System, Hall of Fame, Keyboard Shortcuts, Achievement Tracker, Quick Actions, Theme System');
});

console.log('🎮 Enhanced features loaded successfully!');

// ========================================
// AESTHETIC ENHANCEMENTS - ANIMATION FUNCTIONS
// ========================================

/**
 * Goal Celebration System
 * Creates confetti particles and scorer popup when a goal is scored
 */
function celebrateGoal(button, scorer, teamName) {
  if (!button) return;

  // Add celebration animation to button
  button.classList.add('btn-goal-celebration');

  // Create confetti
  createConfetti(button);

  // Show scorer popup
  if (scorer && scorer.name) {
    showScorerPopup(scorer, button, teamName);
  }

  // Remove celebration class after animation
  setTimeout(() => {
    button.classList.remove('btn-goal-celebration');
  }, 800);
}

/**
 * Create confetti particles effect
 */
function createConfetti(origin) {
  const colors = ['#10b981', '#fbbf24', '#3b82f6', '#ef4444', '#a855f7'];
  const rect = origin.getBoundingClientRect();

  for (let i = 0; i < 30; i++) {
    const confetti = document.createElement('div');
    confetti.className = 'confetti-particle';
    confetti.style.cssText = `
      width: ${Math.random() * 8 + 4}px;
      height: ${Math.random() * 8 + 4}px;
      background: ${colors[Math.floor(Math.random() * colors.length)]};
      border-radius: ${Math.random() > 0.5 ? '50%' : '0'};
      left: ${rect.left + rect.width / 2}px;
      top: ${rect.top + rect.height / 2}px;
    `;

    document.body.appendChild(confetti);

    // Physics simulation
    const angle = Math.random() * Math.PI * 2;
    const velocity = Math.random() * 300 + 200;
    const vx = Math.cos(angle) * velocity;
    const vy = Math.sin(angle) * velocity - 300;
    const gravity = 800;
    const rotation = Math.random() * 720 - 360;

    let x = 0, y = 0, currentVy = vy, currentRotation = 0;
    const startTime = Date.now();

    const animate = () => {
      const elapsed = (Date.now() - startTime) / 1000;

      x = vx * elapsed;
      currentVy = vy + gravity * elapsed;
      y = vy * elapsed + 0.5 * gravity * elapsed * elapsed;
      currentRotation = rotation * elapsed;

      confetti.style.transform = `translate(${x}px, ${y}px) rotate(${currentRotation}deg)`;
      confetti.style.opacity = Math.max(0, 1 - elapsed / 2);

      if (y > 500 || elapsed > 2) {
        confetti.remove();
      } else {
        requestAnimationFrame(animate);
      }
    };

    requestAnimationFrame(animate);
  }
}

/**
 * Show scorer popup notification
 */
function showScorerPopup(scorer, origin, teamName) {
  const popup = document.createElement('div');
  popup.className = 'scorer-popup';

  const rect = origin.getBoundingClientRect();
  popup.style.left = rect.left + rect.width / 2 + 'px';
  popup.style.top = rect.top - 60 + 'px';
  popup.style.transform = 'translate(-50%, 0)';

  popup.innerHTML = `⚽ ${scorer.name} scores!`;

  document.body.appendChild(popup);

  // Animate in
  popup.animate([
    { transform: 'translate(-50%, 20px) scale(0)', opacity: 0 },
    { transform: 'translate(-50%, 0) scale(1)', opacity: 1 }
  ], {
    duration: 400,
    easing: 'cubic-bezier(0.34, 1.56, 0.64, 1)'
  });

  // Remove after delay
  setTimeout(() => {
    popup.animate([
      { transform: 'translate(-50%, 0) scale(1)', opacity: 1 },
      { transform: 'translate(-50%, -20px) scale(0)', opacity: 0 }
    ], {
      duration: 300,
      easing: 'ease-in'
    }).onfinish = () => popup.remove();
  }, 2000);
}

/**
 * Button Loading State Management
 */
function showLoadingState(button, loadingText = 'Loading...') {
  if (!button) return () => {};

  const originalText = button.textContent;
  const originalHTML = button.innerHTML;
  button.textContent = loadingText;
  button.classList.add('btn-loading');
  button.disabled = true;

  return () => {
    button.innerHTML = originalHTML;
    button.classList.remove('btn-loading');
    button.disabled = false;
  };
}

/**
 * Show success state on button
 */
function showButtonSuccess(button, duration = 2000) {
  if (!button) return;

  const originalText = button.textContent;
  button.textContent = '✓ Success!';
  button.classList.add('btn-success');

  setTimeout(() => {
    button.textContent = originalText;
    button.classList.remove('btn-success');
  }, duration);
}

/**
 * Show error state on button
 */
function showButtonError(button, message = 'Error!', duration = 2000) {
  if (!button) return;

  const originalText = button.textContent;
  button.textContent = '✗ ' + message;
  button.classList.add('btn-error');

  setTimeout(() => {
    button.textContent = originalText;
    button.classList.remove('btn-error');
  }, duration);
}

/**
 * Add ripple effect to element on click
 */
function createRipple(event) {
  const button = event.currentTarget;
  const ripple = document.createElement('span');
  ripple.className = 'ripple';

  const rect = button.getBoundingClientRect();
  const size = Math.max(rect.width, rect.height);
  const x = event.clientX - rect.left - size / 2;
  const y = event.clientY - rect.top - size / 2;

  ripple.style.width = ripple.style.height = size + 'px';
  ripple.style.left = x + 'px';
  ripple.style.top = y + 'px';

  button.appendChild(ripple);

  setTimeout(() => ripple.remove(), 600);
}

/**
 * Context-Aware Theme System
 */
const STAGE_THEMES = {
  'group': {
    color: '#3b82f6',
    gradient: 'linear-gradient(135deg, #3b82f6, #2563eb)',
    glow: 'rgba(59, 130, 246, 0.4)',
    icon: '📊',
    className: 'stage-group'
  },
  'knockout': {
    color: '#f59e0b',
    gradient: 'linear-gradient(135deg, #f59e0b, #d97706)',
    glow: 'rgba(245, 158, 11, 0.4)',
    icon: '⚔️',
    className: 'stage-knockout'
  },
  'r16': {
    color: '#f59e0b',
    gradient: 'linear-gradient(135deg, #f59e0b, #d97706)',
    glow: 'rgba(245, 158, 11, 0.4)',
    icon: '⚔️',
    className: 'stage-knockout'
  },
  'qf': {
    color: '#f59e0b',
    gradient: 'linear-gradient(135deg, #f59e0b, #d97706)',
    glow: 'rgba(245, 158, 11, 0.4)',
    icon: '⚔️',
    className: 'stage-knockout'
  },
  'semifinal': {
    color: '#a855f7',
    gradient: 'linear-gradient(135deg, #a855f7, #9333ea)',
    glow: 'rgba(168, 85, 247, 0.4)',
    icon: '🔥',
    className: 'stage-semifinal'
  },
  'sf': {
    color: '#a855f7',
    gradient: 'linear-gradient(135deg, #a855f7, #9333ea)',
    glow: 'rgba(168, 85, 247, 0.4)',
    icon: '🔥',
    className: 'stage-semifinal'
  },
  'final': {
    color: '#fbbf24',
    gradient: 'linear-gradient(135deg, #fbbf24, #f59e0b)',
    glow: 'rgba(251, 191, 36, 0.4)',
    icon: '🏆',
    className: 'stage-final'
  }
};

function getStageTheme(stage) {
  const stageKey = stage.toLowerCase().replace(/\s+/g, '');
  return STAGE_THEMES[stageKey] || STAGE_THEMES.group;
}

function applyStageTheme(element, stage) {
  if (!element) return;

  const theme = getStageTheme(stage);

  element.style.background = theme.gradient;
  element.style.boxShadow = `0 4px 20px ${theme.glow}`;
  element.style.borderColor = theme.color;
  element.classList.add(theme.className);

  // Add icon if element has stage-icon class
  const icon = element.querySelector('.stage-icon');
  if (icon) icon.textContent = theme.icon;
}

/**
 * Strength Theme System
 */
function getStrengthTheme(strength) {
  if (strength >= 95) return {
    color: '#fbbf24',
    label: 'LEGENDARY',
    icon: '👑',
    glow: 'rgba(251, 191, 36, 0.6)',
    className: 'strength-legendary'
  };
  else if (strength >= 90) return {
    color: '#a855f7',
    label: 'ELITE',
    icon: '⭐',
    glow: 'rgba(168, 85, 247, 0.6)',
    className: 'strength-elite'
  };
  else if (strength >= 85) return {
    color: '#3b82f6',
    label: 'STRONG',
    icon: '💪',
    glow: 'rgba(59, 130, 246, 0.6)',
    className: 'strength-strong'
  };
  else if (strength >= 80) return {
    color: '#10b981',
    label: 'GOOD',
    icon: '✓',
    glow: 'rgba(16, 185, 129, 0.6)',
    className: 'strength-good'
  };
  else return {
    color: '#6b7280',
    label: 'AVERAGE',
    icon: '➡️',
    glow: 'rgba(107, 114, 128, 0.6)',
    className: 'strength-average'
  };
}

function applyStrengthTheme(element, strength) {
  if (!element) return;

  const theme = getStrengthTheme(strength);
  element.classList.add(theme.className);
  element.style.color = theme.color;
  element.style.textShadow = `0 0 10px ${theme.glow}`;
}

/**
 * Theme Switcher System
 */
const THEME_MANAGER = {
  current: localStorage.getItem('footballTheme') || 'default',

  themes: {
    default: 'Default',
    stadium: 'Stadium Night'
  },

  switch(themeName) {
    this.current = themeName;
    document.body.setAttribute('data-theme', themeName);
    localStorage.setItem('footballTheme', themeName);

    // Notify user
    if (typeof showNotification === 'function') {
      showNotification('success', 'Theme Changed', `Switched to ${this.themes[themeName]} theme`, 2000);
    }
  },

  init() {
    const saved = localStorage.getItem('footballTheme');
    if (saved && saved !== 'default') {
      document.body.setAttribute('data-theme', saved);
    }
  }
};

function createThemeSwitcher() {
  const switcher = document.createElement('div');
  switcher.id = 'themeSwitcher';
  switcher.setAttribute('role', 'radiogroup');
  switcher.setAttribute('aria-label', 'Theme selector');
  switcher.style.cssText = `
    position: fixed;
    top: 80px;
    right: 30px;
    background: linear-gradient(135deg, #1e293b, #334155);
    border: 1px solid rgba(16, 185, 129, 0.3);
    border-radius: 8px;
    padding: 8px;
    z-index: 9000;
    display: flex;
    gap: 8px;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
  `;

  Object.entries(THEME_MANAGER.themes).forEach(([key, label]) => {
    const btn = document.createElement('button');
    btn.textContent = key === 'stadium' ? '🏟️' : '🎨';
    btn.title = label;
    btn.setAttribute('role', 'radio');
    btn.setAttribute('aria-label', `Switch to ${label} theme`);
    btn.setAttribute('aria-checked', THEME_MANAGER.current === key ? 'true' : 'false');
    btn.style.cssText = `
      background: ${THEME_MANAGER.current === key ? 'rgba(16, 185, 129, 0.2)' : 'rgba(71, 85, 105, 0.3)'};
      border: 1px solid ${THEME_MANAGER.current === key ? 'rgba(16, 185, 129, 0.5)' : 'rgba(71, 85, 105, 0.5)'};
      color: #f7fafc;
      width: 40px;
      height: 40px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1.2em;
      transition: all 0.2s ease;
    `;

    btn.onmouseover = () => {
      btn.style.background = 'rgba(16, 185, 129, 0.3)';
      btn.style.transform = 'translateY(-2px)';
    };

    btn.onmouseout = () => {
      btn.style.background = THEME_MANAGER.current === key ? 'rgba(16, 185, 129, 0.2)' : 'rgba(71, 85, 105, 0.3)';
      btn.style.transform = 'translateY(0)';
    };

    btn.onclick = () => {
      THEME_MANAGER.switch(key);
      // Recreate switcher to update active state
      switcher.remove();
      createThemeSwitcher();
    };

    switcher.appendChild(btn);
  });

  document.body.appendChild(switcher);
}

/**
 * Enhanced Modal System
 * Adds animations to modals
 */
function enhanceModal(modal) {
  if (!modal) return;

  // Add scale-in animation
  modal.classList.add('modal-scale-in');

  // Add blur backdrop if it's a backdrop
  if (modal.classList.contains('modal-backdrop')) {
    modal.classList.add('modal-backdrop-blur');
  }
}

// Aesthetic enhancements initialized with core features in main load event listener above

// Export functions for global access
window.celebrateGoal = celebrateGoal;
window.createConfetti = createConfetti;
window.showLoadingState = showLoadingState;
window.showButtonSuccess = showButtonSuccess;
window.showButtonError = showButtonError;
window.applyStageTheme = applyStageTheme;
window.applyStrengthTheme = applyStrengthTheme;
window.THEME_MANAGER = THEME_MANAGER;

if (window.VERBOSE_LOGGING) console.log('🎨 Aesthetic enhancement functions loaded!');

// ========================================
// ENSURE SEASONS IN SIDEBAR
// ========================================

function updateSidebarWithAllFeatures() {
  const sidebar = document.querySelector('.sidebar');
  if (!sidebar) return;

  // Check if Seasons button already exists
  const existingSeasonsBtn = Array.from(sidebar.querySelectorAll('.ctrl-btn')).find(btn =>
    btn.textContent.includes('Seasons') || btn.onclick && btn.onclick.toString().includes('displaySeasonMode')
  );

  if (existingSeasonsBtn) {
    if (window.VERBOSE_LOGGING) console.log('✓ Seasons button already present in sidebar');
    return;
  }

  // Find the Views tab content
  const viewsTab = document.getElementById('tab-views');
  if (!viewsTab) return;

  // Create Seasons button
  const seasonsBtn = document.createElement('button');
  seasonsBtn.className = 'ctrl-btn';
  seasonsBtn.onclick = function() { if (typeof displaySeasonMode === 'function') displaySeasonMode(); };
  seasonsBtn.style.cssText = `
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.2));
    border: 1px solid rgba(16, 185, 129, 0.4);
  `;

  seasonsBtn.innerHTML = `
    <div class="ctrl-btn-main">
      <span class="ctrl-btn-title">🏆 Seasons</span>
      <span class="ctrl-btn-subtitle">Play league season</span>
    </div>
    <span class="ctrl-btn-tag">⚽</span>
  `;

  // Add to Views tab
  const controlColumn = viewsTab.querySelector('.control-column');
  if (controlColumn) {
    controlColumn.appendChild(seasonsBtn);
    if (window.VERBOSE_LOGGING) console.log('✓ Seasons button added to sidebar');
  }
}

// Call on page load
window.addEventListener('DOMContentLoaded', () => {
  updateSidebarWithAllFeatures();
});

// Also call immediately in case DOM is already loaded
if (document.readyState === 'loading') {
  // DOM is still loading, event listener will handle it
} else {
  // DOM is already loaded
  updateSidebarWithAllFeatures();
}

// ========================================
// COMPREHENSIVE DEBUGGER & LOGIC ANALYZER
// ========================================

const SYSTEM_DEBUGGER = {
  issues: [], warnings: [], fixes: [],

  async runFullDiagnostic() {
    if (window.VERBOSE_LOGGING) console.log('🔍 Starting comprehensive system diagnostic...');
    console.log('='.repeat(70));
    this.issues = []; this.warnings = []; this.fixes = [];

    await this.checkGlobalVariables();
    await this.checkFunctionIntegrity();
    await this.checkDataStructures();
    await this.checkStorageIntegrity();
    await this.checkUIElements();
    await this.checkFeatureIntegration();
    await this.attemptAutoFixes();
    this.generateReport();

    if (window.VERBOSE_LOGGING) console.log('='.repeat(70));
    console.log('✓ Diagnostic complete');

    return { issues: this.issues, warnings: this.warnings, fixes: this.fixes, passed: this.issues.length === 0 };
  },

  async checkGlobalVariables() {
    if (window.VERBOSE_LOGGING) console.log('📋 Checking global variables...');
    const required = ['MANAGER_STATE', 'TOURNAMENT_HISTORY_ENHANCED', 'SEASON_STATE', 'PREDICTION_STATE', 'ALL_TEAMS', 'THEMES', 'STORAGE_MANAGER'];
    required.forEach(v => {
      if (typeof window[v] === 'undefined') {
        this.issues.push({severity: 'critical', category: 'Variables', message: `${v} is undefined`, fix: `Initialize ${v}`});
      } else if (window.VERBOSE_LOGGING) {
        console.log(`  ✓ ${v} exists`);
      }
    });
  },

  async checkFunctionIntegrity() {
    if (window.VERBOSE_LOGGING) console.log('🔧 Checking function integrity...');
    const required = ['displayManagerProfile', 'displaySeasonMode', 'displayHallOfFame', 'displayEnhancedTournamentStats', 'loadTournamentTemplate', 'applyTheme', 'enablePredictionsForMatch'];
    required.forEach(f => {
      if (typeof window[f] !== 'function') {
        this.issues.push({severity: 'critical', category: 'Functions', message: `${f} not defined`, fix: `Define ${f}`});
      } else if (window.VERBOSE_LOGGING) {
        console.log(`  ✓ ${f} defined`);
      }
    });
  },

  async checkDataStructures() {
    if (window.VERBOSE_LOGGING) console.log('📊 Checking data structures...');
    if (window.MANAGER_STATE) {
      ['active', 'level', 'xp', 'managerName'].forEach(f => {
        if (!(f in MANAGER_STATE)) this.warnings.push({category: 'Data', message: `MANAGER_STATE missing ${f}`});
      });
    }
    if (window.TOURNAMENT_HISTORY_ENHANCED && !Array.isArray(TOURNAMENT_HISTORY_ENHANCED.tournaments)) {
      this.issues.push({severity: 'high', category: 'Data', message: 'TOURNAMENT_HISTORY_ENHANCED.tournaments not array', fix: 'Initialize as array'});
    }
    if (window.VERBOSE_LOGGING) console.log('  ✓ Data structures checked');
  },

  async checkStorageIntegrity() {
    if (window.VERBOSE_LOGGING) console.log('💾 Checking storage...');
    try {
      localStorage.setItem('_test_', '1'); localStorage.removeItem('_test_');
      if (window.VERBOSE_LOGGING) console.log('  ✓ localStorage accessible');
      if (typeof STORAGE_MANAGER !== 'undefined') {
        if (window.VERBOSE_LOGGING) console.log(`  ✓ Storage: ${STORAGE_MANAGER.getUsageMB()} MB`);
        if (STORAGE_MANAGER.isNearLimit()) this.warnings.push({category: 'Storage', message: 'Near limit', suggestion: 'Run STORAGE_MANAGER.smartCleanup()'});
      }
    } catch (e) {
      this.issues.push({severity: 'critical', category: 'Storage', message: `localStorage error: ${e.message}`, fix: 'Enable localStorage'});
    }
  },

  async checkUIElements() {
    if (window.VERBOSE_LOGGING) console.log('🎨 Checking UI...');
    if (!document.querySelector('#output, #content')) {
      this.issues.push({severity: 'critical', category: 'UI', message: 'Main container missing', fix: 'Add #output or #content'});
    } else if (window.VERBOSE_LOGGING) {
      console.log('  ✓ Main container exists');
    }
    const modals = document.querySelectorAll('.modal-backdrop');
    if (modals.length > 3) this.warnings.push({category: 'UI', message: `${modals.length} modals open`, suggestion: 'Close unused modals'});
  },

  async checkFeatureIntegration() {
    if (window.VERBOSE_LOGGING) console.log('🔗 Checking features...');
    const features = [
      {name: 'Predictions', check: () => typeof PREDICTION_STATE !== 'undefined' && typeof enablePredictionsForMatch === 'function'},
      {name: 'Themes', check: () => typeof THEMES !== 'undefined' && typeof applyTheme === 'function'},
      {name: 'Seasons', check: () => typeof SEASON_STATE !== 'undefined' && typeof displaySeasonMode === 'function'},
      {name: 'Hall of Fame', check: () => typeof HALL_OF_FAME !== 'undefined' && typeof displayHallOfFame === 'function'}
    ];
    features.forEach(f => {
      if (window.VERBOSE_LOGGING) if (f.check()) console.log(`  ✓ ${f.name} integrated`);
      else this.warnings.push({category: 'Integration', message: `${f.name} incomplete`});
    });
  },

  async attemptAutoFixes() {
    if (window.VERBOSE_LOGGING) console.log('🔧 Auto-fixing...');
    const oldModals = document.querySelectorAll('.modal-backdrop');
    if (oldModals.length > 0) {
      oldModals.forEach(m => m.remove());
      this.fixes.push(`Removed ${oldModals.length} orphaned modals`);
    }
    if (window.VERBOSE_LOGGING) console.log(`  ✓ Applied ${this.fixes.length} fixes`);
  },

  generateReport() {
    const r = {summary: {critical: this.issues.filter(i => i.severity === 'critical').length, high: this.issues.filter(i => i.severity === 'high').length, warnings: this.warnings.length, fixes: this.fixes.length}, issues: this.issues, warnings: this.warnings, fixes: this.fixes};
    if (window.VERBOSE_LOGGING) console.log('\n📋 DIAGNOSTIC REPORT');
    console.log('='.repeat(70));
    console.log(`Critical: ${r.summary.critical} | High: ${r.summary.high} | Warnings: ${r.summary.warnings} | Fixes: ${r.summary.fixes}`);
    if (window.VERBOSE_LOGGING) console.log('='.repeat(70));
    if (this.issues.length > 0) {
      console.log('\n❌ ISSUES:');
      if (window.VERBOSE_LOGGING) this.issues.forEach((i, idx) => console.log(`${idx+1}. [${i.severity}] ${i.category}: ${i.message}${i.fix ? '\n   Fix: ' + i.fix : ''}`));
    }
    if (this.warnings.length > 0) {
      console.log('\n⚠️  WARNINGS:');
      this.warnings.forEach((w, idx) => console.log(`${idx+1}. [${w.category}] ${w.message}${w.suggestion ? '\n   Suggestion: ' + w.suggestion : ''}`));
    }
    if (this.fixes.length > 0) {
      console.log('\n✅ AUTO-FIXES:');
      if (window.VERBOSE_LOGGING) this.fixes.forEach((f, idx) => console.log(`${idx+1}. ${f}`));
    }
    if (this.issues.length === 0 && this.warnings.length === 0) console.log('\n🎉 ALL SYSTEMS OPERATIONAL!');
    return r;
  },

  showVisualReport() {
    this.runFullDiagnostic().then(report => {
      const modal = document.createElement('div');
      modal.className = 'modal-backdrop active';
      modal.style.zIndex = '10007';
      const color = report.summary.critical > 0 ? '#EF4444' : report.summary.high > 0 ? '#F59E0B' : report.summary.warnings > 0 ? '#3B82F6' : '#10B981';
      const icon = report.summary.critical > 0 ? '❌' : report.summary.high > 0 ? '⚠️' : report.summary.warnings > 0 ? 'ℹ️' : '✅';
      modal.innerHTML = `<div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;"><div class="modal-head" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(37, 99, 235, 0.2));"><h2 style="color: #60A5FA;">🔍 System Diagnostic Report</h2><button class="modal-close" onclick="this.closest('.modal-backdrop').remove()">✕</button></div><div style="padding: 30px;"><div style="text-align: center; margin-bottom: 30px; padding: 30px; background: var(--cardBg); border: 2px solid ${color}; border-radius: 16px;"><div style="font-size: 5em; margin-bottom: 15px;">${icon}</div><h3 style="color: ${color}; font-size: 2em; margin-bottom: 20px;">${report.summary.critical === 0 && report.summary.high === 0 ? 'System Healthy' : 'Issues Detected'}</h3><div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px;"><div style="padding: 16px; background: rgba(239, 68, 68, 0.1); border-radius: 10px;"><div style="color: #EF4444; font-size: 2em; font-weight: 900;">${report.summary.critical}</div><div style="color: var(--textSecondary); font-size: 0.9em;">Critical</div></div><div style="padding: 16px; background: rgba(245, 158, 11, 0.1); border-radius: 10px;"><div style="color: #F59E0B; font-size: 2em; font-weight: 900;">${report.summary.high}</div><div style="color: var(--textSecondary); font-size: 0.9em;">High</div></div><div style="padding: 16px; background: rgba(59, 130, 246, 0.1); border-radius: 10px;"><div style="color: #3B82F6; font-size: 2em; font-weight: 900;">${report.summary.warnings}</div><div style="color: var(--textSecondary); font-size: 0.9em;">Warnings</div></div><div style="padding: 16px; background: rgba(16, 185, 129, 0.1); border-radius: 10px;"><div style="color: #10B981; font-size: 2em; font-weight: 900;">${report.summary.fixes}</div><div style="color: var(--textSecondary); font-size: 0.9em;">Fixed</div></div></div></div>${report.issues.length > 0 ? `<div style="background: var(--cardBg); border: 1px solid var(--cardBorder); border-radius: 12px; padding: 24px; margin-bottom: 20px;"><h4 style="color: #EF4444; margin-bottom: 20px;">❌ Issues</h4><div style="display: grid; gap: 12px;">${report.issues.map(i => `<div style="padding: 16px; background: rgba(239, 68, 68, 0.1); border-left: 4px solid #EF4444; border-radius: 8px;"><span style="padding: 4px 8px; background: rgba(239, 68, 68, 0.2); border-radius: 4px; font-size: 0.75em; font-weight: 700; color: #EF4444; text-transform: uppercase;">${i.severity}</span> <span style="color: var(--textSecondary);">${i.category}</span><div style="color: var(--text); margin: 8px 0;">${i.message}</div>${i.fix ? `<div style="color: #10B981;"><strong>Fix:</strong> ${i.fix}</div>` : ''}</div>`).join('')}</div></div>` : ''}${report.warnings.length > 0 ? `<div style="background: var(--cardBg); border: 1px solid var(--cardBorder); border-radius: 12px; padding: 24px; margin-bottom: 20px;"><h4 style="color: #F59E0B; margin-bottom: 20px;">⚠️ Warnings</h4><div style="display: grid; gap: 12px;">${report.warnings.map(w => `<div style="padding: 16px; background: rgba(245, 158, 11, 0.1); border-left: 4px solid #F59E0B; border-radius: 8px;"><span style="color: var(--textSecondary);">${w.category}</span><div style="color: var(--text); margin: 8px 0;">${w.message}</div>${w.suggestion ? `<div style="color: #60A5FA;"><strong>Suggestion:</strong> ${w.suggestion}</div>` : ''}</div>`).join('')}</div></div>` : ''}${report.fixes.length > 0 ? `<div style="background: var(--cardBg); border: 1px solid var(--cardBorder); border-radius: 12px; padding: 24px;"><h4 style="color: #10B981; margin-bottom: 20px;">✅ Auto-Fixes</h4><div style="display: grid; gap: 8px;">${report.fixes.map((f, i) => `<div style="padding: 12px; background: rgba(16, 185, 129, 0.1); border-radius: 6px;"><span style="color: #10B981; font-weight: 700;">${i+1}.</span> ${f}</div>`).join('')}</div></div>` : ''}<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 30px;"><button onclick="console.log('Full Report:', ${JSON.stringify(report).replace(/"/g, '&quot;').replace(/'/g, '\\&apos;')})" class="btn-secondary" style="padding: 14px;">📋 Log Report</button><button onclick="this.closest('.modal-backdrop').remove()" class="btn-primary" style="padding: 14px;">Close</button></div></div></div>`;
      document.body.appendChild(modal);
    });
  }
};

window.runDiagnostic = () => SYSTEM_DEBUGGER.showVisualReport();
window.addEventListener('error', e => { console.error('💥 Error:', e.error); console.log('💡 Run runDiagnostic()'); });

// ========================================
// FINAL INTEGRATION VALIDATOR
// ========================================

function validateAllIntegrations() {
  if (window.VERBOSE_LOGGING) console.log('🎯 Running final integration validation...');
  const tests = [
    {name: 'Manager Profile', test: () => typeof displayManagerProfile === 'function' && typeof selectFavoriteClub === 'function'},
    {name: 'Theme System', test: () => typeof THEMES !== 'undefined' && typeof applyTheme === 'function' && Object.keys(THEMES).length >= 6},
    {name: 'Seasons', test: () => typeof SEASON_STATE !== 'undefined' && typeof displaySeasonMode === 'function'},
    {name: 'Hall of Fame', test: () => typeof HALL_OF_FAME !== 'undefined' && typeof displayHallOfFame === 'function'},
    {name: 'Storage Management', test: () => typeof STORAGE_MANAGER !== 'undefined' && typeof STORAGE_MANAGER.safeSet === 'function'},
    {name: 'Tournament Stats', test: () => typeof displayEnhancedTournamentStats === 'function'},
    {name: 'Predictions', test: () => typeof PREDICTION_STATE !== 'undefined' && typeof enablePredictionsForMatch === 'function'},
    {name: 'Templates', test: () => typeof loadTournamentTemplate === 'function'}
  ];

  const results = tests.map(t => {
    try { return {name: t.name, passed: t.test(), error: null}; }
    catch (e) { return {name: t.name, passed: false, error: e.message}; }
  });

  if (window.VERBOSE_LOGGING) console.log('\n📊 INTEGRATION TEST RESULTS');
  console.log('='.repeat(70));
  results.forEach((r, i) => {
    console.log(`${i+1}. ${r.passed ? '✅' : '❌'} ${r.name}`);
    if (r.error) console.log(`   Error: ${r.error}`);
  });

  const pass = results.filter(r => r.passed).length;
  const total = results.length;
  const pct = ((pass / total) * 100).toFixed(1);

  if (window.VERBOSE_LOGGING) console.log('='.repeat(70));
  console.log(`\n✨ FINAL SCORE: ${pass}/${total} (${pct}%)`);
  if (pass === total) {
    console.log('🎉 ALL INTEGRATIONS PASSED!');
    if (window.VERBOSE_LOGGING) console.log('✨ System fully operational!');
  } else {
    console.log(`⚠️  ${total - pass} integration(s) failed`);
    if (window.VERBOSE_LOGGING) console.log('💡 Run runDiagnostic() for details');
  }

  return {passed: pass, total: total, percentage: pct, allPassed: pass === total, results: results};
}

window.validateAll = validateAllIntegrations;

window.addEventListener('load', () => {
  setTimeout(() => {
    if (window.VERBOSE_LOGGING) console.log('\n🚀 Running automatic system validation...\n');
    validateAllIntegrations();
    if (window.VERBOSE_LOGGING) console.log('\n💡 Available commands:');
    console.log('  - validateAll()     : Run integration tests');
    if (window.VERBOSE_LOGGING) console.log('  - runDiagnostic()   : Full system diagnostic');
    console.log('\n');
  }, 2000);
});

</script>
<script>
// Tournament Progress Indicator Management
function updateTournamentProgress(stage) {
  const progressBar = document.getElementById('tournamentProgress');
  if (!progressBar) return;

  // Show the progress bar
  progressBar.style.display = 'flex';

  const stages = ['groups', 'r32', 'r16', 'qf', 'sf', 'final'];
  const currentIndex = stages.indexOf(stage);

  if (currentIndex === -1) return;

  const steps = progressBar.querySelectorAll('.progress-step');
  steps.forEach((step, index) => {
    step.classList.remove('completed', 'active', 'pending');

    if (index < currentIndex) {
      step.classList.add('completed');
    } else if (index === currentIndex) {
      step.classList.add('active');
    } else {
      step.classList.add('pending');
    }
  });
}

// Smart Notification System
function showNotification(type, title, message, duration = 4000) {
  const container = document.getElementById('notificationContainer');
  if (!container) return;

  const icons = {
    goal: '⚽',
    upset: '🚨',
    milestone: '🎉',
    achievement: '🏆',
    tournament: '🏁',
    info: 'ℹ️',
    success: '✅',
    warning: '⚠️',
    error: '❌'
  };

  const notification = document.createElement('div');
  notification.className = `notification notification-${type}`;
  notification.innerHTML = `
    <div class="notification-icon">${icons[type] || icons.info}</div>
    <div class="notification-content">
      <div class="notification-title">${title}</div>
      <div class="notification-message">${message}</div>
    </div>
    <button class="notification-close" onclick="closeNotification(this)">✕</button>
  `;

  container.appendChild(notification);

  // Auto-dismiss
  if (duration > 0) {
    setTimeout(() => {
      closeNotification(notification.querySelector('.notification-close'));
    }, duration);
  }

  // Click to dismiss
  notification.addEventListener('click', (e) => {
    if (!e.target.classList.contains('notification-close')) {
      closeNotification(notification.querySelector('.notification-close'));
    }
  });
}

function closeNotification(closeBtn) {
  const notification = closeBtn.closest('.notification');
  if (!notification) return;

  notification.classList.add('removing');
  setTimeout(() => {
    notification.remove();
  }, 300);
}

// Hook into existing functions to show notifications
// Function wrapping with proper timing - wrapped in load event to ensure functions exist
// Safe deferred initialization to prevent race conditions
(function initializeFunctionWrappersSafely() {
  "use strict";

  const MAX_RETRIES = 50;
  const RETRY_DELAY = 100; // ms
  let retryCount = 0;

  function attemptInitialization() {
    // Check if required functions exist
    const requiredFunctions = [
      "simulateGroupStage",
      "simulateKnockoutRounds",
      "handleGenerateGroups"
    ];

    const allExist = requiredFunctions.every(fn => typeof window[fn] === 'function');

    if (allExist) {
      wrapFunctionsSafely();
      console.log('✅ Function wrappers initialized successfully');
    } else if (retryCount < MAX_RETRIES) {
      retryCount++;
      setTimeout(attemptInitialization, RETRY_DELAY);
    } else {
      const missing = requiredFunctions.filter(fn => typeof window[fn] !== 'function');
      console.warn('⚠️ Some functions not found after max retries:', missing);
    }
  }

  function wrapFunctionsSafely() {
    // Wrap simulateGroupStage
    if (typeof window.simulateGroupStage === 'function') {
      const original = window.simulateGroupStage;
      window.simulateGroupStage = function(...args) {
        if (typeof updateTournamentProgress === 'function') {
          updateTournamentProgress('groups');
        }
        const result = original.apply(this, args);
        if (typeof showNotification === 'function') {
          showNotification('tournament', 'Group Stage Complete',
            'All groups have been simulated!', 3000);
        }
        return result;
      };
    }

    // Wrap simulateKnockoutRounds
    if (typeof window.simulateKnockoutRounds === 'function') {
      const original = window.simulateKnockoutRounds;
      window.simulateKnockoutRounds = function(...args) {
        const result = original.apply(this, args);
        if (result && result.champion) {
          if (typeof updateTournamentProgress === 'function') {
            updateTournamentProgress('final');
          }
          if (typeof showNotification === 'function') {
            showNotification('achievement', 'Tournament Complete!',
              `${result.champion.name} is the champion!`, 5000);
          }
          // Auto-induct tournament performers
          if (typeof inductTournamentPerformers === 'function') {
            setTimeout(() => inductTournamentPerformers(), 500);
          }
        }
        return result;
      };
    }

    // Wrap handleGenerateGroups
    if (typeof window.handleGenerateGroups === 'function') {
      const original = window.handleGenerateGroups;
      window.handleGenerateGroups = function(...args) {
        const result = original.apply(this, args);
        if (typeof updateTournamentProgress === 'function') {
          updateTournamentProgress('groups');
        }
        if (typeof showNotification === 'function') {
          showNotification('success', 'Groups Generated',
            'Groups have been created!', 3000);
        }
        return result;
      };
    }
  }

  // Start initialization after DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', attemptInitialization);
  } else {
    attemptInitialization();
  }
})();

// Initialize on page load
// Global escape key handler for modals
document.addEventListener('keydown', function(event) {
  if (event.key === 'Escape' || event.key === 'Esc') {
    // Find all active modals (those with display flex or active class)
    const activeModals = Array.from(document.querySelectorAll('.modal-backdrop')).filter(modal => {
      const style = window.getComputedStyle(modal);
      return style.display === 'flex' || modal.classList.contains('active');
    });

    // Close the most recently opened modal
    if (activeModals.length > 0) {
      const latestModal = activeModals[activeModals.length - 1];
      const modalId = latestModal.id;

      // Call the appropriate close function based on modal ID
      if (modalId === 'customMatchModal') closeCustomMatch();
      else if (modalId === 'historyModal') closeHistory();
      else if (modalId === 'matchDetailModal') closeMatchDetail();
      else if (modalId === 'teamDetailModal') closeTeamDetail();
      else if (modalId === 'settingsModal') closeSettings();
      else if (modalId === 'statisticsModal') closeStatistics();
      else if (modalId === 'managerEditModal') closeManagerEditModal();
      else if (modalId === 'resetConfirmModal') {
        // Reset confirm modal is dynamically created, just remove it
        latestModal.remove();
      }
      else {
        // Generic close if no specific function
        latestModal.classList.remove('active');
        setTimeout(() => {
          latestModal.style.display = 'none';
        }, 300);
      }
    }
  }
});

document.addEventListener('DOMContentLoaded', function() {
  // Check current tournament state and update progress
  if (window.TOURNAMENT && window.TOURNAMENT.champion) {
    updateTournamentProgress('final');
  } else if (window.KNOCKOUT_RESULTS && Object.keys(window.KNOCKOUT_RESULTS).length > 0) {
    updateTournamentProgress('r16');
  } else if (window.GROUP_RESULTS && Object.keys(window.GROUP_RESULTS).length > 0) {
    updateTournamentProgress('groups');
  }
});

// ========================================
// ACCESSIBILITY ENHANCEMENTS
// ========================================
function initializeAccessibility() {
  // Add aria-live region for notifications
  const notifContainer = document.getElementById('notificationContainer');
  if (notifContainer) {
    notifContainer.setAttribute('aria-live', 'polite');
    notifContainer.setAttribute('aria-atomic', 'true');
    notifContainer.setAttribute('role', 'status');
  }

  // Add skip-to-content link
  const skipLink = document.createElement('a');
  skipLink.href = '#main-content';
  skipLink.className = 'skip-link';
  skipLink.textContent = 'Skip to main content';
  skipLink.style.cssText = `
    position: absolute;
    top: -50px;
    left: 10px;
    background: #10b981;
    color: white;
    padding: 12px 20px;
    text-decoration: none;
    border-radius: 4px;
    z-index: 100000;
    font-weight: 600;
    transition: top 0.2s ease;
  `;
  skipLink.addEventListener('focus', () => {
    skipLink.style.top = '10px';
  });
  skipLink.addEventListener('blur', () => {
    skipLink.style.top = '-50px';
  });
  document.body.insertBefore(skipLink, document.body.firstChild);

  // Add main content landmark
  const mainContent = document.querySelector('#output') || document.querySelector('.control-column');
  if (mainContent && !mainContent.id) {
    mainContent.id = 'main-content';
  }
  if (mainContent) {
    mainContent.setAttribute('role', 'main');
    mainContent.setAttribute('aria-label', 'Tournament results and controls');
  }

  // Add tournament progress aria labels
  const progressBar = document.getElementById('tournamentProgress');
  if (progressBar) {
    progressBar.setAttribute('role', 'progressbar');
    progressBar.setAttribute('aria-label', 'Tournament progress');
  }
}

// ========================================
// AUTO-SAVE SYSTEM
// ========================================
const AUTO_SAVE = {
  key: 'tournament_autosave_v1',
  interval: null,
  saveIntervalMs: 30000, // 30 seconds

  save() {
    try {
      const state = {
        version: '1.0',
        timestamp: Date.now(),
        teams: window.TEAMS,
        groups: window.GROUPS,
        groupResults: window.GROUP_RESULTS,
        knockoutResults: window.KNOCKOUT_RESULTS,
        tournament: window.TOURNAMENT,
        matchHistory: window.MATCH_HISTORY || [],
        hallOfFame: typeof HALL_OF_FAME !== 'undefined' ? HALL_OF_FAME.records : {}
      };

      localStorage.setItem(this.key, JSON.stringify(state));
      if (window.VERBOSE_LOGGING) console.log('✓ Auto-saved at', new Date().toLocaleTimeString());
    } catch (e) {
      console.error('Auto-save failed:', e);

      // Handle quota exceeded
      if (e.name === 'QuotaExceededError') {
        this.cleanup();
        // Try again after cleanup
        try {
          localStorage.setItem(this.key, JSON.stringify({
            version: '1.0',
            timestamp: Date.now(),
            groups: window.GROUPS,
            tournament: window.TOURNAMENT
          }));
        } catch (e2) {
          console.error('Auto-save failed even after cleanup:', e2);
        }
      }
    }
  },

  load() {
    try {
      const saved = localStorage.getItem(this.key);
      if (!saved) return null;

      const state = JSON.parse(saved);

      // Validate version
      if (state.version !== '1.0') {
        console.warn('Incompatible save version');
        return null;
      }

      return state;
    } catch (e) {
      console.error('Auto-restore failed:', e);
      return null;
    }
  },

  restore(state) {
    if (!state) return false;

    try {
      // Restore global state
      if (state.teams) window.TEAMS = state.teams;
      if (state.groups) window.GROUPS = state.groups;
      if (state.groupResults) window.GROUP_RESULTS = state.groupResults;
      if (state.knockoutResults) window.KNOCKOUT_RESULTS = state.knockoutResults;
      if (state.tournament) window.TOURNAMENT = state.tournament;
      if (state.matchHistory) window.MATCH_HISTORY = state.matchHistory;

      // Restore Hall of Fame
      if (state.hallOfFame && typeof HALL_OF_FAME !== 'undefined') {
        HALL_OF_FAME.records = state.hallOfFame;
      }

      if (window.VERBOSE_LOGGING) console.log('✓ State restored from', new Date(state.timestamp).toLocaleString());
      return true;
    } catch (e) {
      console.error('Restore failed:', e);
      return false;
    }
  },

  startAutoSave() {
    // Check for existing save on startup
    const saved = this.load();
    if (saved && saved.timestamp) {
      const ageMinutes = Math.floor((Date.now() - saved.timestamp) / 60000);

      if (ageMinutes < 60 && confirm(`Resume tournament from ${ageMinutes} minute${ageMinutes !== 1 ? 's' : ''} ago?`)) {
        if (this.restore(saved)) {
          // Refresh UI if functions exist
          if (typeof renderGroups === 'function') renderGroups();
          if (typeof updateTournamentBracket === 'function') updateTournamentBracket();

          showNotification('success', 'Tournament Restored', 'Your progress has been restored', 3000);
        }
      }
    }

    // Start periodic auto-save
    this.interval = setInterval(() => {
      // Only save if there's actual tournament data
      if (window.GROUPS || window.TOURNAMENT) {
        this.save();
      }
    }, this.saveIntervalMs);

    if (window.VERBOSE_LOGGING) console.log('✓ Auto-save started (every 30 seconds)');
  },

  stopAutoSave() {
    if (this.interval) {
      clearInterval(this.interval);
      this.interval = null;
      if (window.VERBOSE_LOGGING) console.log('✓ Auto-save stopped');
    }
  },

  cleanup() {
    // Remove old autosaves
    const keys = Object.keys(localStorage);
    keys.forEach(key => {
      if (key.startsWith('tournament_autosave_') && key !== this.key) {
        localStorage.removeItem(key);
        if (window.VERBOSE_LOGGING) console.log('Cleaned up old save:', key);
      }
    });
  },

  clear() {
    localStorage.removeItem(this.key);
    if (window.VERBOSE_LOGGING) console.log('✓ Auto-save cleared');
  }
};

// Save before page unload
window.addEventListener('beforeunload', () => {
  if (window.GROUPS || window.TOURNAMENT) {
    AUTO_SAVE.save();
  }
});

// Export to global scope
window.AUTO_SAVE = AUTO_SAVE;

// ========================================
// MEMORY LEAK PREVENTION
// ========================================
function cleanupEventListeners() {
  // Clean up notification event listeners
  document.querySelectorAll('.notification').forEach(notification => {
    const closeBtn = notification.querySelector('.notification-close');
    if (closeBtn) {
      // Clone and replace to remove all event listeners
      const newBtn = closeBtn.cloneNode(true);
      closeBtn.parentNode.replaceChild(newBtn, closeBtn);
    }
  });
}

// Periodically clean up old notifications
setInterval(() => {
  const container = document.getElementById('notificationContainer');
  if (container && container.children.length > 5) {
    // Remove old notifications beyond 5
    Array.from(container.children)
      .slice(5)
      .forEach(el => el.remove());
  }
}, 60000); // Every minute

// ========================================
// ALL NEW FEATURES - JAVASCRIPT
// ========================================

// ========================================
// 1. LIVE MATCH SIMULATION SYSTEM
// ========================================
class LiveMatchSimulator {
  constructor(team1, team2) {
    this.team1 = team1;
    this.team2 = team2;
    this.minute = 0;
    this.score = [0, 0];
    this.events = [];
    this.paused = false;
    this.speed = 500; // ms per minute
    this.interval = null;
    this.modalId = 'liveMatchModal_' + Date.now();
  }

  start() {
    this.createModal();
    this.renderUI();
    this.interval = setInterval(() => this.tick(), this.speed);
  }

  createModal() {
    const modal = document.createElement('div');
    modal.id = this.modalId;
    modal.className = 'live-match-modal active';
    modal.innerHTML = `
      <div class="live-match-container">
        <div id="liveMatchContent_${this.modalId}"></div>
      </div>
    `;
    document.body.appendChild(modal);
  }

  tick() {
    if (this.paused) return;

    this.minute++;
    this.updateClock();

    // Calculate event probabilities based on team strength
    const strength1 = this.team1.overallRating || this.team1.strength || 80;
    const strength2 = this.team2.overallRating || this.team2.strength || 80;
    const totalStrength = strength1 + strength2;
    const goalChance1 = (strength1 / totalStrength) * 0.05;
    const goalChance2 = (strength2 / totalStrength) * 0.05;

    // Goal events
    const rand = Math.random();
    if (rand < goalChance1) {
      this.addGoal(0);
    } else if (rand < goalChance1 + goalChance2) {
      this.addGoal(1);
    }

    // Other events (15% chance)
    if (Math.random() < 0.15) {
      this.addRandomEvent();
    }

    // End match at 90 minutes
    if (this.minute >= 90) {
      this.endMatch();
    }
  }

  addGoal(teamIndex) {
    this.score[teamIndex]++;
    const team = teamIndex === 0 ? this.team1 : this.team2;
    const event = {
      minute: this.minute,
      type: 'goal',
      team: team.name,
      icon: '⚽',
      text: `GOAL! ${team.name} scores!`,
      teamIndex
    };
    this.events.unshift(event);
    this.renderEvent(event);
    this.updateScore();

    // Trigger celebration with confetti
    if (typeof createConfetti === 'function') {
      const modal = document.getElementById(this.modalId);
      if (modal) createConfetti(modal);
    }

    // Play goal sound
    if (typeof SOUND_SYSTEM !== 'undefined') {
      SOUND_SYSTEM.play('goal');
    }
  }

  addRandomEvent() {
    const eventTypes = [
      { type: 'yellow', icon: '🟨', text: 'Yellow card' },
      { type: 'sub', icon: '↔️', text: 'Substitution' },
      { type: 'save', icon: '🧤', text: 'Great save!' },
      { type: 'chance', icon: '🎯', text: 'Close chance!' },
      { type: 'offside', icon: '🚩', text: 'Offside' },
      { type: 'corner', icon: '⛳', text: 'Corner kick' },
      { type: 'foul', icon: '⚠️', text: 'Foul' }
    ];

    const event = eventTypes[Math.floor(Math.random() * eventTypes.length)];
    const team = Math.random() < 0.5 ? this.team1 : this.team2;

    const fullEvent = {
      minute: this.minute,
      ...event,
      team: team.name,
      text: `${event.text} - ${team.name}`
    };

    this.events.unshift(fullEvent);
    this.renderEvent(fullEvent);
  }

  renderUI() {
    const container = document.getElementById('liveMatchContent_' + this.modalId);
    if (!container) return;

    container.innerHTML = `
      <div class="live-scoreboard">
        <div class="live-team">
          <div class="live-team-name">${this.team1.name}</div>
          <div class="live-score" id="score1_${this.modalId}">0</div>
        </div>
        <div class="live-clock" id="clock_${this.modalId}">0'</div>
        <div class="live-team">
          <div class="live-team-name">${this.team2.name}</div>
          <div class="live-score" id="score2_${this.modalId}">0</div>
        </div>
      </div>
      <div class="live-controls">
        <button onclick="window.currentLiveMatch.togglePause()">⏸️ Pause/Resume</button>
        <button onclick="window.currentLiveMatch.setSpeed(100)">⏩ Fast (2x)</button>
        <button onclick="window.currentLiveMatch.setSpeed(500)">▶️ Normal</button>
        <button onclick="window.currentLiveMatch.setSpeed(1000)">⏪ Slow</button>
        <button onclick="window.currentLiveMatch.close()">❌ Close</button>
      </div>
      <div class="live-timeline" id="timeline_${this.modalId}"></div>
    `;
  }

  renderEvent(event) {
    const timeline = document.getElementById('timeline_' + this.modalId);
    if (!timeline) return;

    const el = document.createElement('div');
    el.className = `timeline-event event-${event.type}`;
    el.innerHTML = `
      <span class="event-minute">${event.minute}'</span>
      <span class="event-icon">${event.icon}</span>
      <span class="event-text">${event.text}</span>
    `;
    timeline.insertBefore(el, timeline.firstChild);
  }

  updateScore() {
    const score1 = document.getElementById('score1_' + this.modalId);
    const score2 = document.getElementById('score2_' + this.modalId);
    if (score1) score1.textContent = this.score[0];
    if (score2) score2.textContent = this.score[1];
  }

  updateClock() {
    const clock = document.getElementById('clock_' + this.modalId);
    if (clock) clock.textContent = `${this.minute}'`;
  }

  togglePause() {
    this.paused = !this.paused;
    if (typeof showNotification === 'function') {
      showNotification('info', this.paused ? 'Paused' : 'Resumed', '', 1000);
    }
  }

  setSpeed(ms) {
    this.speed = ms;
    if (this.interval) {
      clearInterval(this.interval);
      this.interval = setInterval(() => this.tick(), this.speed);
    }
  }

  endMatch() {
    clearInterval(this.interval);
    this.interval = null;

    setTimeout(() => {
      const winner = this.score[0] > this.score[1] ? this.team1.name :
                     this.score[1] > this.score[0] ? this.team2.name : 'Draw';

      if (typeof showNotification === 'function') {
        showNotification('tournament', 'Full Time!',
          `${this.team1.name} ${this.score[0]} - ${this.score[1]} ${this.team2.name}`, 5000);
      }

      // Play whistle sound
      if (typeof SOUND_SYSTEM !== 'undefined') {
        SOUND_SYSTEM.play('whistle');
      }

      // Save result to history
      if (typeof HISTORY_MANAGER !== 'undefined') {
        HISTORY_MANAGER.saveState();
      }

      // Close modal after 3 seconds
      setTimeout(() => this.close(), 3000);
    }, 1000);
  }

  close() {
    const modal = document.getElementById(this.modalId);
    if (modal) {
      modal.classList.remove('active');
      setTimeout(() => modal.remove(), 300);
    }
    if (this.interval) {
      clearInterval(this.interval);
    }
    window.currentLiveMatch = null;
  }
}

// Global function to start live match
function startLiveMatch(team1, team2) {
  if (!team1 || !team2) {
    if (typeof showNotification === 'function') {
      showNotification('error', 'Error', 'Invalid teams for live match', 2000);
    }
    return;
  }

  window.currentLiveMatch = new LiveMatchSimulator(team1, team2);
  window.currentLiveMatch.start();
}

// ========================================
// 2. EXPORT & SHARE SYSTEM
// ========================================
const EXPORT_SYSTEM = {
  exportAsJSON() {
    try {
      const data = {
        version: '1.0',
        timestamp: Date.now(),
        tournament: window.TOURNAMENT,
        groups: window.GROUPS,
        groupResults: window.GROUP_RESULTS,
        knockoutResults: window.KNOCKOUT_RESULTS,
        matchHistory: window.MATCH_HISTORY || [],
        hallOfFame: typeof HALL_OF_FAME !== 'undefined' ? HALL_OF_FAME.records : {}
      };

      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      this.downloadBlob(blob, `tournament-${Date.now()}.json`);
    } catch (e) {
      console.error('JSON export failed:', e);
      if (typeof showNotification === 'function') {
        showNotification('error', 'Export Failed', 'Could not export JSON', 3000);
      }
    }
  },

  exportAsCSV() {
    try {
      let csv = 'Group,Team,Played,Won,Drawn,Lost,GF,GA,GD,Points\n';

      if (window.GROUP_RESULTS) {
        Object.entries(window.GROUP_RESULTS).forEach(([groupName, group]) => {
          if (group.teams) {
            group.teams.forEach(team => {
              csv += `${groupName},${team.name},${team.played || 0},${team.won || 0},${team.drawn || 0},${team.lost || 0},`;
              csv += `${team.gf || 0},${team.ga || 0},${team.gd || 0},${team.points || 0}\n`;
            });
          }
        });
      }

      const blob = new Blob([csv], { type: 'text/csv' });
      this.downloadBlob(blob, `results-${Date.now()}.csv`);
    } catch (e) {
      console.error('CSV export failed:', e);
      if (typeof showNotification === 'function') {
        showNotification('error', 'Export Failed', 'Could not export CSV', 3000);
      }
    }
  },

  shareToClipboard() {
    try {
      let text = '🏆 All-Time Football Tournament Results\n\n';

      if (window.TOURNAMENT && window.TOURNAMENT.champion) {
        text += `🥇 Champion: ${window.TOURNAMENT.champion.name}\n`;
        if (window.TOURNAMENT.runnerUp) {
          text += `🥈 Runner-up: ${window.TOURNAMENT.runnerUp.name}\n`;
        }
        text += '\n';
      }

      if (window.GROUP_RESULTS) {
        text += 'Group Stage Results:\n';
        Object.entries(window.GROUP_RESULTS).forEach(([groupName, group]) => {
          text += `\n${groupName.toUpperCase()}:\n`;
          if (group.teams) {
            group.teams.forEach((team, i) => {
              text += `${i + 1}. ${team.name} - ${team.points || 0} pts (${team.gf || 0} GF, ${team.ga || 0} GA)\n`;
            });
          }
        });
      }

      text += '\n🎮 Generated by All-Time Football Simulator';

      navigator.clipboard.writeText(text).then(() => {
        if (typeof showNotification === 'function') {
          showNotification('success', 'Copied!', 'Results copied to clipboard', 2000);
        }
      }).catch(err => {
        console.error('Copy failed:', err);
        if (typeof showNotification === 'function') {
          showNotification('error', 'Copy Failed', 'Could not copy to clipboard', 3000);
        }
      });
    } catch (e) {
      console.error('Share to clipboard failed:', e);
    }
  },

  downloadBlob(blob, filename) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);

    if (typeof showNotification === 'function') {
      showNotification('success', 'Export Complete', `Downloaded ${filename}`, 3000);
    }
  }
};

// ========================================
// 3. UNDO/REDO SYSTEM
// ========================================
const HISTORY_MANAGER = {
  past: [],
  future: [],
  maxHistory: 50,

  saveState() {
    try {
      const state = {
        timestamp: Date.now(),
        teams: window.TEAMS ? JSON.parse(JSON.stringify(window.TEAMS)) : null,
        groups: window.GROUPS ? JSON.parse(JSON.stringify(window.GROUPS)) : null,
        groupResults: window.GROUP_RESULTS ? JSON.parse(JSON.stringify(window.GROUP_RESULTS)) : null,
        knockoutResults: window.KNOCKOUT_RESULTS ? JSON.parse(JSON.stringify(window.KNOCKOUT_RESULTS)) : null,
        tournament: window.TOURNAMENT ? JSON.parse(JSON.stringify(window.TOURNAMENT)) : null
      };

      this.past.push(state);

      // Clear future when new action taken
      this.future = [];

      // Limit history size
      if (this.past.length > this.maxHistory) {
        this.past.shift();
      }

      this.updateUI();
      if (window.VERBOSE_LOGGING) console.log('✓ State saved to history. Total states:', this.past.length);
    } catch (e) {
      console.error('Failed to save state:', e);
    }
  },

  undo() {
    if (this.past.length === 0) {
      if (typeof showNotification === 'function') {
        showNotification('info', 'Nothing to Undo', 'No previous states available', 2000);
      }
      return;
    }

    try {
      // Save current state to future
      const current = {
        timestamp: Date.now(),
        teams: window.TEAMS,
        groups: window.GROUPS,
        groupResults: window.GROUP_RESULTS,
        knockoutResults: window.KNOCKOUT_RESULTS,
        tournament: window.TOURNAMENT
      };

      this.future.push(current);

      // Restore previous state
      const previous = this.past.pop();
      this.restoreState(previous);

      this.updateUI();

      if (typeof showNotification === 'function') {
        showNotification('info', 'Undo', 'Reverted to previous state', 2000);
      }
    } catch (e) {
      console.error('Undo failed:', e);
    }
  },

  redo() {
    if (this.future.length === 0) {
      if (typeof showNotification === 'function') {
        showNotification('info', 'Nothing to Redo', 'No future states available', 2000);
      }
      return;
    }

    try {
      // Save current state to past
      const current = {
        timestamp: Date.now(),
        teams: window.TEAMS,
        groups: window.GROUPS,
        groupResults: window.GROUP_RESULTS,
        knockoutResults: window.KNOCKOUT_RESULTS,
        tournament: window.TOURNAMENT
      };

      this.past.push(current);

      // Restore next state
      const next = this.future.pop();
      this.restoreState(next);

      this.updateUI();

      if (typeof showNotification === 'function') {
        showNotification('info', 'Redo', 'Restored next state', 2000);
      }
    } catch (e) {
      console.error('Redo failed:', e);
    }
  },

  restoreState(state) {
    if (!state) return;

    if (state.teams) window.TEAMS = state.teams;
    if (state.groups) window.GROUPS = state.groups;
    if (state.groupResults) window.GROUP_RESULTS = state.groupResults;
    if (state.knockoutResults) window.KNOCKOUT_RESULTS = state.knockoutResults;
    if (state.tournament) window.TOURNAMENT = state.tournament;

    // Refresh UI
    if (typeof renderGroups === 'function') renderGroups();
    if (typeof updateTournamentBracket === 'function') updateTournamentBracket();
    if (typeof showStandings === 'function' && document.querySelector('.standings-visible')) {
      showStandings();
    }
  },

  updateUI() {
    const undoBtn = document.getElementById('undoBtn');
    const redoBtn = document.getElementById('redoBtn');

    if (undoBtn) {
      undoBtn.disabled = this.past.length === 0;
      undoBtn.title = this.past.length > 0 ?
        `Undo (${this.past.length} state${this.past.length !== 1 ? 's' : ''} available)` :
        'Nothing to undo';
    }

    if (redoBtn) {
      redoBtn.disabled = this.future.length === 0;
      redoBtn.title = this.future.length > 0 ?
        `Redo (${this.future.length} state${this.future.length !== 1 ? 's' : ''} available)` :
        'Nothing to redo';
    }
  },

  clear() {
    this.past = [];
    this.future = [];
    this.updateUI();
    if (window.VERBOSE_LOGGING) console.log('✓ History cleared');
  }
};

// Add keyboard shortcuts for undo/redo
document.addEventListener('keydown', (e) => {
  if ((e.ctrlKey || e.metaKey) && !e.shiftKey && e.key === 'z') {
    e.preventDefault();
    HISTORY_MANAGER.undo();
  } else if ((e.ctrlKey || e.metaKey) && (e.shiftKey && e.key === 'z' || e.key === 'y')) {
    e.preventDefault();
    HISTORY_MANAGER.redo();
  }
});

// ========================================
// 4. SOUND EFFECTS SYSTEM
// ========================================
const SOUND_SYSTEM = {
  enabled: localStorage.getItem('soundEnabled') !== 'false',
  volume: parseFloat(localStorage.getItem('soundVolume') || '0.5'),

  // Sound definitions using Web Audio API with simple oscillator
  sounds: {
    goal: { freq: 600, duration: 0.3, type: 'sine' },
    whistle: { freq: 800, duration: 0.2, type: 'square' },
    click: { freq: 400, duration: 0.05, type: 'sine' },
    success: { freq: 523.25, duration: 0.2, type: 'sine' },
    error: { freq: 200, duration: 0.3, type: 'triangle' }
  },

  audioContext: null,

  init() {
    try {
      this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
      if (window.VERBOSE_LOGGING) console.log('✓ Sound system initialized');
    } catch (e) {
      console.warn('Web Audio API not supported:', e);
    }
  },

  play(soundName) {
    if (!this.enabled || !this.audioContext || this.volume === 0) return;

    const sound = this.sounds[soundName];
    if (!sound) return;

    try {
      const oscillator = this.audioContext.createOscillator();
      const gainNode = this.audioContext.createGain();

      oscillator.type = sound.type;
      oscillator.frequency.value = sound.freq;

      gainNode.gain.setValueAtTime(this.volume, this.audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + sound.duration);

      oscillator.connect(gainNode);
      gainNode.connect(this.audioContext.destination);

      oscillator.start(this.audioContext.currentTime);
      oscillator.stop(this.audioContext.currentTime + sound.duration);
    } catch (e) {
      console.error('Sound playback failed:', e);
    }
  },

  toggle() {
    this.enabled = !this.enabled;
    localStorage.setItem('soundEnabled', this.enabled);
    this.updateUI();

    if (typeof showNotification === 'function') {
      showNotification('info', this.enabled ? '🔊 Sound On' : '🔇 Sound Off', '', 1500);
    }

    if (this.enabled) {
      this.play('click');
    }
  },

  setVolume(value) {
    this.volume = Math.max(0, Math.min(1, parseFloat(value)));
    localStorage.setItem('soundVolume', this.volume);
    this.updateUI();
  },

  updateUI() {
    const toggle = document.getElementById('soundToggle');
    const slider = document.getElementById('volumeSlider');

    if (toggle) {
      toggle.textContent = this.enabled ? '🔊 Sound On' : '🔇 Sound Off';
      toggle.classList.toggle('muted', !this.enabled);
    }

    if (slider) {
      slider.value = this.volume;
      slider.disabled = !this.enabled;
    }
  }
};

// Initialize sound system
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => SOUND_SYSTEM.init());
} else {
  SOUND_SYSTEM.init();
}

// ========================================
// 5. QUICK START TOURNAMENT PRESETS
// ========================================
const QUICK_START_PRESETS = {
  templates: {
    'champions-league': {
      name: 'Champions League',
      icon: '🏆',
      description: 'Top European clubs competing for glory',
      teamCount: 32,
      difficulty: 'hard',
      teamFilter: team => (team.overallRating || team.strength || 75) >= 85
    },
    'world-cup': {
      name: 'World Cup',
      icon: '🌍',
      description: 'International tournament with diverse teams',
      teamCount: 32,
      difficulty: 'medium',
      teamFilter: null
    },
    'underdogs': {
      name: 'Underdogs Only',
      icon: '🐕',
      description: 'Lower-rated teams battle for supremacy',
      teamCount: 32,
      difficulty: 'balanced',
      teamFilter: team => (team.overallRating || team.strength || 75) < 80
    },
    'super-elite': {
      name: 'Super Elite',
      icon: '👑',
      description: 'Only the absolute best teams',
      teamCount: 16,
      difficulty: 'extreme',
      teamFilter: team => (team.overallRating || team.strength || 75) >= 90
    },
    'quick-tournament': {
      name: 'Quick 16',
      icon: '⚡',
      description: 'Fast 16-team knockout tournament',
      teamCount: 16,
      difficulty: 'medium',
      teamFilter: null
    },
    'classic-32': {
      name: 'Classic 32',
      icon: '⚽',
      description: 'Traditional 32-team format',
      teamCount: 32,
      difficulty: 'medium',
      teamFilter: null
    }
  },

  apply(templateId) {
    const template = this.templates[templateId];
    if (!template) {
      console.error('Template not found:', templateId);
      return;
    }

    try {
      // Get all available teams
      let availableTeams = window.ALL_TEAMS || window.TEAMS || [];

      // Apply filter if specified
      if (template.teamFilter) {
        availableTeams = availableTeams.filter(template.teamFilter);
      }

      // Shuffle and select required number of teams
      const shuffled = [...availableTeams].sort(() => Math.random() - 0.5);
      const selectedTeams = shuffled.slice(0, template.teamCount);

      if (selectedTeams.length < template.teamCount) {
        if (typeof showNotification === 'function') {
          showNotification('warning', 'Not Enough Teams',
            `Only ${selectedTeams.length} teams match criteria (need ${template.teamCount})`, 4000);
        }
        return;
      }

      // Save state before applying template
      if (typeof HISTORY_MANAGER !== 'undefined') {
        HISTORY_MANAGER.saveState();
      }

      // Apply teams
      window.TEAMS = selectedTeams;

      // Generate groups if needed
      if (typeof generateGroups === 'function' && template.teamCount >= 16) {
        generateGroups();
      }

      // Update UI
      if (typeof renderUI === 'function') {
        renderUI();
      }

      if (typeof showNotification === 'function') {
        showNotification('success', 'Template Applied',
          `${template.name} tournament created with ${selectedTeams.length} teams`, 3000);
      }

      // Play sound
      if (typeof SOUND_SYSTEM !== 'undefined') {
        SOUND_SYSTEM.play('success');
      }

      if (window.VERBOSE_LOGGING) console.log(`✓ Applied template: ${template.name}`);
    } catch (e) {
      console.error('Failed to apply template:', e);
      if (typeof showNotification === 'function') {
        showNotification('error', 'Template Failed', 'Could not apply tournament template', 3000);
      }
    }
  },

  show() {
    const modal = document.createElement('div');
    modal.className = 'modal-backdrop active';
    modal.style.zIndex = '10002';
    modal.innerHTML = `
      <div class="modal-content" style="max-width: 900px;">
        <div class="modal-head">
          <h2>🏆 Quick Start Templates</h2>
          <button class="modal-close" onclick="this.closest('.modal-backdrop').remove()">✕</button>
        </div>
        <div class="template-grid">
          ${Object.entries(this.templates).map(([id, t]) => `
            <div class="template-card" onclick="QUICK_START_PRESETS.apply('${id}'); this.closest('.modal-backdrop').remove();">
              <div class="template-icon">${t.icon}</div>
              <div class="template-name">${t.name}</div>
              <div class="template-desc">${t.description}</div>
              <div style="text-align: center; margin-top: 12px; color: #10b981; font-weight: 600;">
                ${t.teamCount} Teams • ${t.difficulty.charAt(0).toUpperCase() + t.difficulty.slice(1)}
              </div>
            </div>
          `).join('')}
        </div>
      </div>
    `;
    document.body.appendChild(modal);
  }
};

// ========================================
// 6. PREDICTION SYSTEM
// ========================================
const PREDICTION_SYSTEM = {
  predictions: {},
  results: {},

  init() {
    const saved = localStorage.getItem('predictions');
    if (saved) {
      try {
        this.predictions = JSON.parse(saved);
      } catch (e) {
        console.error('Failed to load predictions:', e);
      }
    }
  },

  predict(matchId, winner) {
    this.predictions[matchId] = {
      winner,
      timestamp: Date.now()
    };
    localStorage.setItem('predictions', JSON.stringify(this.predictions));

    if (typeof showNotification === 'function') {
      showNotification('success', 'Prediction Saved', `You predicted: ${winner}`, 2000);
    }

    if (typeof SOUND_SYSTEM !== 'undefined') {
      SOUND_SYSTEM.play('click');
    }
  },

  checkPrediction(matchId, actualWinner) {
    const prediction = this.predictions[matchId];
    if (!prediction) return null;

    const correct = prediction.winner === actualWinner;
    this.results[matchId] = {
      predicted: prediction.winner,
      actual: actualWinner,
      correct
    };

    return correct;
  },

  getAccuracy() {
    const total = Object.keys(this.results).length;
    if (total === 0) return 0;

    const correct = Object.values(this.results).filter(r => r.correct).length;
    return Math.round((correct / total) * 100);
  },

  showStats() {
    const accuracy = this.getAccuracy();
    const total = Object.keys(this.results).length;
    const correct = Object.values(this.results).filter(r => r.correct).length;

    const modal = document.createElement('div');
    modal.className = 'modal-backdrop active';
    modal.innerHTML = `
      <div class="modal-content" style="max-width: 600px;">
        <div class="modal-head">
          <h2>🔮 Prediction Stats</h2>
          <button class="modal-close" onclick="this.closest('.modal-backdrop').remove()">✕</button>
        </div>
        <div class="prediction-score">
          <div class="prediction-accuracy">${accuracy}%</div>
          <div style="color: #94a3b8; margin-top: 8px;">Prediction Accuracy</div>
          <div style="color: #e2e8f0; margin-top: 16px; font-size: 1.1em;">
            ${correct} correct out of ${total} predictions
          </div>
        </div>
        <div style="text-align: center; margin-top: 24px;">
          <button class="btn-primary" onclick="PREDICTION_SYSTEM.clear(); this.closest('.modal-backdrop').remove();">
            Clear Predictions
          </button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
  },

  clear() {
    this.predictions = {};
    this.results = {};
    localStorage.removeItem('predictions');
    if (typeof showNotification === 'function') {
      showNotification('info', 'Predictions Cleared', '', 2000);
    }
  }
};

// Initialize prediction system
PREDICTION_SYSTEM.init();

// ========================================
// UI HELPER FUNCTIONS
// ========================================
function addNewFeatureButtons() {
  // Target the Tools tab specifically, not the active tab
  const sidebar = document.querySelector('#tab-tools');
  if (!sidebar) return;

  // Check if already added
  if (document.getElementById('newFeaturesContainer')) return;

  // Create container for new features
  const container = document.createElement('div');
  container.id = 'newFeaturesContainer';
  container.innerHTML = `
    <!-- Export Menu -->
    <div class="export-menu">
      <h3>📤 Export & Share</h3>
      <button onclick="EXPORT_SYSTEM.exportAsJSON()">📄 Export JSON</button>
      <button onclick="EXPORT_SYSTEM.exportAsCSV()">📊 Export CSV</button>
      <button onclick="EXPORT_SYSTEM.shareToClipboard()">📋 Copy Results</button>
      <button onclick="window.print()">🖨️ Print</button>
    </div>

    <!-- History Controls -->
    <div class="history-controls">
      <button id="undoBtn" onclick="HISTORY_MANAGER.undo()" disabled title="Undo">
        ↶ Undo
      </button>
      <button id="redoBtn" onclick="HISTORY_MANAGER.redo()" disabled title="Redo">
        ↷ Redo
      </button>
    </div>

    <!-- Sound Controls -->
    <div class="sound-controls">
      <button id="soundToggle" class="sound-toggle" onclick="SOUND_SYSTEM.toggle()">
        🔊 Sound On
      </button>
      <input type="range" id="volumeSlider" class="volume-slider"
             min="0" max="1" step="0.1" value="0.5"
             oninput="SOUND_SYSTEM.setVolume(this.value)">
    </div>

    <!-- Feature Buttons -->
    <button class="ctrl-btn btn-purple" onclick="QUICK_START_PRESETS.show()" style="margin-top: 12px;">
      <div class="ctrl-btn-main">
        <div class="ctrl-btn-title">🏆 Quick Start Templates</div>
        <div class="ctrl-btn-subtitle">Fast tournament setups</div>
      </div>
    </button>

    <button class="ctrl-btn btn-blue" onclick="PREDICTION_SYSTEM.showStats()" style="margin-top: 8px;">
      <div class="ctrl-btn-main">
        <div class="ctrl-btn-title">🔮 Prediction Stats</div>
        <div class="ctrl-btn-subtitle">View your accuracy</div>
      </div>
    </button>

    <!-- Feature Guides Section -->
    <div style="margin-top: 25px; padding: 15px; background: rgba(59, 130, 246, 0.05); border-radius: 12px; border: 1px solid rgba(59, 130, 246, 0.2);">
      <h3 style="color: #3b82f6; margin-bottom: 12px; font-size: 0.95em; font-weight: 600;">📖 Feature Guides</h3>
      <div style="display: grid; gap: 8px;">
        <button onclick="FEATURE_GUIDES.showGuide('quickStart')"
                style="padding: 8px 12px; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 6px; color: #f7fafc; cursor: pointer; text-align: left; font-size: 0.85em; transition: all 0.2s;">
          <span style="margin-right: 6px;">🏆</span> Quick Start Templates
        </button>
        <button onclick="FEATURE_GUIDES.showGuide('predictions')"
                style="padding: 8px 12px; background: rgba(168, 85, 247, 0.1); border: 1px solid rgba(168, 85, 247, 0.3); border-radius: 6px; color: #f7fafc; cursor: pointer; text-align: left; font-size: 0.85em; transition: all 0.2s;">
          <span style="margin-right: 6px;">🔮</span> Predictions System
        </button>
        <button onclick="FEATURE_GUIDES.showGuide('hallOfFame')"
                style="padding: 8px 12px; background: rgba(251, 191, 36, 0.1); border: 1px solid rgba(251, 191, 36, 0.3); border-radius: 6px; color: #f7fafc; cursor: pointer; text-align: left; font-size: 0.85em; transition: all 0.2s;">
          <span style="margin-right: 6px;">🏛️</span> Hall of Fame
        </button>
        <button onclick="FEATURE_GUIDES.showGuide('seasons')"
                style="padding: 8px 12px; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 6px; color: #f7fafc; cursor: pointer; text-align: left; font-size: 0.85em; transition: all 0.2s;">
          <span style="margin-right: 6px;">📅</span> Seasons Mode
        </button>
      </div>
    </div>
  `;

  sidebar.appendChild(container);

  // Update UI
  if (typeof SOUND_SYSTEM !== 'undefined') {
    SOUND_SYSTEM.updateUI();
  }
  if (typeof HISTORY_MANAGER !== 'undefined') {
    HISTORY_MANAGER.updateUI();
  }
}

// Initialize all new features on load
window.addEventListener('load', () => {
  // Add feature buttons to sidebar
  setTimeout(() => {
    addNewFeatureButtons();
    console.log('✅ All new features initialized and UI updated');
  }, 100);
});

// Export all systems to global scope
window.LiveMatchSimulator = LiveMatchSimulator;
window.startLiveMatch = startLiveMatch;
window.EXPORT_SYSTEM = EXPORT_SYSTEM;
window.HISTORY_MANAGER = HISTORY_MANAGER;
window.SOUND_SYSTEM = SOUND_SYSTEM;
window.QUICK_START_PRESETS = QUICK_START_PRESETS;
window.PREDICTION_SYSTEM = PREDICTION_SYSTEM;

// ========================================
// COMPREHENSIVE ENHANCEMENTS
// ========================================

// Enhanced Hall of Fame - Auto-induct tournament performers
function inductTournamentPerformers() {
  if (!window.TOURNAMENT || !window.MATCH_HISTORY) return;

  const tournamentMatches = window.MATCH_HISTORY.filter(m => m.tournamentId === window.TOURNAMENT.id);

  // Track player statistics across tournament
  const playerStats = {};

  tournamentMatches.forEach(match => {
    if (match.scorers) {
      match.scorers.forEach(scorer => {
        if (!playerStats[scorer.name]) {
          playerStats[scorer.name] = {
            name: scorer.name,
            team: scorer.team,
            pos: scorer.pos || 'FW',
            goals: 0,
            assists: 0,
            apps: 0,
            ratings: []
          };
        }
        playerStats[scorer.name].goals++;
        playerStats[scorer.name].apps++;
        if (scorer.rating) playerStats[scorer.name].ratings.push(scorer.rating);
      });
    }
  });

  // Induct top scorer if they scored 5+ goals
  const topScorer = Object.values(playerStats).sort((a, b) => b.goals - a.goals)[0];
  if (topScorer && topScorer.goals >= 5 && typeof HALL_OF_FAME !== 'undefined') {
    const avgRating = topScorer.ratings.length > 0
      ? topScorer.ratings.reduce((a, b) => a + b, 0) / topScorer.ratings.length
      : 7.5;

    if (!HALL_OF_FAME.isInHallOfFame(topScorer.name)) {
      HALL_OF_FAME.inductLegend({
        name: topScorer.name,
        team: topScorer.team,
        pos: topScorer.pos,
        goals: topScorer.goals,
        assists: topScorer.assists,
        apps: topScorer.apps,
        avgRating: avgRating
      }, `Tournament Top Scorer - ${topScorer.goals} goals`);
    }
  }

  // Update Hall of Fame records
  if (typeof HALL_OF_FAME !== 'undefined' && topScorer) {
    HALL_OF_FAME.updateRecord('tournamentTopScorer', topScorer.goals, topScorer.name);
  }
}

// Team datasets for Quick Start templates
const TEMPLATE_TEAMS = {
  eliteClubs: [
    { name: 'Real Madrid', strength: 92, overallRating: 92 },
    { name: 'Barcelona', strength: 90, overallRating: 90 },
    { name: 'Bayern Munich', strength: 91, overallRating: 91 },
    { name: 'Manchester City', strength: 91, overallRating: 91 },
    { name: 'Liverpool', strength: 89, overallRating: 89 },
    { name: 'Paris Saint-Germain', strength: 88, overallRating: 88 },
    { name: 'Chelsea', strength: 87, overallRating: 87 },
    { name: 'Manchester United', strength: 86, overallRating: 86 },
    { name: 'Juventus', strength: 86, overallRating: 86 },
    { name: 'Inter Milan', strength: 85, overallRating: 85 },
    { name: 'AC Milan', strength: 84, overallRating: 84 },
    { name: 'Atletico Madrid', strength: 85, overallRating: 85 },
    { name: 'Borussia Dortmund', strength: 84, overallRating: 84 },
    { name: 'Ajax', strength: 83, overallRating: 83 },
    { name: 'Benfica', strength: 82, overallRating: 82 },
    { name: 'Porto', strength: 82, overallRating: 82 },
    { name: 'Tottenham', strength: 83, overallRating: 83 },
    { name: 'Arsenal', strength: 84, overallRating: 84 },
    { name: 'Napoli', strength: 83, overallRating: 83 },
    { name: 'RB Leipzig', strength: 82, overallRating: 82 },
    { name: 'Sevilla', strength: 81, overallRating: 81 },
    { name: 'AS Roma', strength: 81, overallRating: 81 },
    { name: 'Villarreal', strength: 80, overallRating: 80 },
    { name: 'Bayer Leverkusen', strength: 81, overallRating: 81 },
    { name: 'Atalanta', strength: 80, overallRating: 80 },
    { name: 'Leicester City', strength: 79, overallRating: 79 },
    { name: 'West Ham', strength: 78, overallRating: 78 },
    { name: 'Real Sociedad', strength: 79, overallRating: 79 },
    { name: 'Lazio', strength: 80, overallRating: 80 },
    { name: 'Monaco', strength: 78, overallRating: 78 },
    { name: 'Lyon', strength: 79, overallRating: 79 },
    { name: 'Marseille', strength: 78, overallRating: 78 }
  ],

  midTierClubs: [
    { name: 'Wolves', strength: 77, overallRating: 77 },
    { name: 'Everton', strength: 76, overallRating: 76 },
    { name: 'Newcastle', strength: 78, overallRating: 78 },
    { name: 'Brighton', strength: 76, overallRating: 76 },
    { name: 'Aston Villa', strength: 77, overallRating: 77 },
    { name: 'Crystal Palace', strength: 75, overallRating: 75 },
    { name: 'Southampton', strength: 74, overallRating: 74 },
    { name: 'Fulham', strength: 75, overallRating: 75 },
    { name: 'Brentford', strength: 74, overallRating: 74 },
    { name: 'Bournemouth', strength: 73, overallRating: 73 },
    { name: 'Nottingham Forest', strength: 74, overallRating: 74 },
    { name: 'Leeds United', strength: 75, overallRating: 75 },
    { name: 'Real Betis', strength: 78, overallRating: 78 },
    { name: 'Athletic Bilbao', strength: 77, overallRating: 77 },
    { name: 'Valencia', strength: 76, overallRating: 76 },
    { name: 'Fiorentina', strength: 77, overallRating: 77 },
    { name: 'Torino', strength: 75, overallRating: 75 },
    { name: 'Bologna', strength: 74, overallRating: 74 },
    { name: 'Udinese', strength: 73, overallRating: 73 },
    { name: 'Sassuolo', strength: 74, overallRating: 74 },
    { name: 'Freiburg', strength: 76, overallRating: 76 },
    { name: 'Union Berlin', strength: 75, overallRating: 75 },
    { name: 'Eintracht Frankfurt', strength: 77, overallRating: 77 },
    { name: 'Hoffenheim', strength: 74, overallRating: 74 },
    { name: 'Mainz', strength: 73, overallRating: 73 },
    { name: 'Lille', strength: 77, overallRating: 77 },
    { name: 'Nice', strength: 76, overallRating: 76 },
    { name: 'Rennes', strength: 75, overallRating: 75 },
    { name: 'Lens', strength: 74, overallRating: 74 },
    { name: 'Strasbourg', strength: 73, overallRating: 73 },
    { name: 'Montpellier', strength: 72, overallRating: 72 },
    { name: 'Nantes', strength: 72, overallRating: 72 }
  ]
};

// Enhance Quick Start Presets with team data
if (window.QUICK_START_PRESETS) {
  QUICK_START_PRESETS.getTeamsForTemplate = function(templateId) {
    const template = this.templates[templateId];
    if (!template) return [];

    let teams = [];

    // Use template teams or fallback to ALL_TEAMS
    if (template.difficulty === 'hard' || template.difficulty === 'extreme') {
      teams = [...TEMPLATE_TEAMS.eliteClubs];
    } else {
      teams = [...TEMPLATE_TEAMS.eliteClubs, ...TEMPLATE_TEAMS.midTierClubs];
    }

    // Apply template filter if it exists
    if (template.teamFilter && window.ALL_TEAMS && window.ALL_TEAMS.length > 0) {
      teams = window.ALL_TEAMS.filter(template.teamFilter);
    }

    // If still no teams, use template teams
    if (teams.length === 0) {
      teams = template.difficulty === 'hard' ? TEMPLATE_TEAMS.eliteClubs : TEMPLATE_TEAMS.midTierClubs;
    }

    return teams.slice(0, template.teamCount);
  };

  // Override apply to use new team getter
  const originalApply = QUICK_START_PRESETS.apply;
  QUICK_START_PRESETS.apply = function(templateId) {
    const template = this.templates[templateId];
    if (!template) {
      console.error('Template not found:', templateId);
      return;
    }

    try {
      // Get teams for this template
      let selectedTeams = this.getTeamsForTemplate(templateId);

      if (selectedTeams.length < template.teamCount) {
        if (typeof showNotification === 'function') {
          showNotification('warning', 'Not Enough Teams',
            `Only ${selectedTeams.length} teams available (need ${template.teamCount})`, 4000);
        }
        // Pad with generic teams if needed
        while (selectedTeams.length < template.teamCount) {
          selectedTeams.push({
            name: `Team ${selectedTeams.length + 1}`,
            strength: 75 + Math.floor(Math.random() * 10),
            overallRating: 75 + Math.floor(Math.random() * 10)
          });
        }
      }

      // Save state before applying template
      if (typeof HISTORY_MANAGER !== 'undefined') {
        HISTORY_MANAGER.saveState();
      }

      // Apply teams
      window.TEAMS = selectedTeams;
      if (!window.ALL_TEAMS || window.ALL_TEAMS.length === 0) {
        window.ALL_TEAMS = [...TEMPLATE_TEAMS.eliteClubs, ...TEMPLATE_TEAMS.midTierClubs];
      }

      // Generate groups if needed
      if (typeof generateGroups === 'function' && template.teamCount >= 16) {
        generateGroups();
      }

      // Update UI
      if (typeof renderUI === 'function') {
        renderUI();
      }

      if (typeof showNotification === 'function') {
        showNotification('success', 'Template Applied',
          `${template.name} tournament created with ${selectedTeams.length} teams`, 3000);
      }

      if (window.VERBOSE_LOGGING) console.log(`✓ Applied template: ${template.name} with ${selectedTeams.length} teams`);
    } catch (e) {
      console.error('Failed to apply template:', e);
      if (typeof showNotification === 'function') {
        showNotification('error', 'Template Error', 'Failed to apply template', 3000);
      }
    }
  };
}

// Enhanced Prediction System Integration
if (window.PREDICTION_SYSTEM) {
  // Add prediction prompt before matches
  PREDICTION_SYSTEM.promptPrediction = function(team1, team2, matchId) {
    if (this.predictions[matchId]) return; // Already predicted

    const modal = document.createElement('div');
    modal.className = 'modal-backdrop active';
    modal.style.zIndex = '10003';
    modal.innerHTML = `
      <div class="modal-content" style="max-width: 500px;">
        <div class="modal-head">
          <h2>🔮 Make Your Prediction</h2>
          <button class="modal-close" onclick="this.closest('.modal-backdrop').remove()">✕</button>
        </div>
        <div style="padding: 20px;">
          <div style="text-align: center; margin-bottom: 20px;">
            <div style="font-size: 1.2em; color: #10b981; font-weight: 600;">${team1.name || team1}</div>
            <div style="margin: 10px 0; color: #94a3b8;">vs</div>
            <div style="font-size: 1.2em; color: #3b82f6; font-weight: 600;">${team2.name || team2}</div>
          </div>
          <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button onclick="PREDICTION_SYSTEM.predict('${matchId}', '${team1.name || team1}'); this.closest('.modal-backdrop').remove();"
                    class="btn-primary" style="flex: 1; background: #10b981; padding: 15px;">
              ${team1.name || team1} Wins
            </button>
            <button onclick="PREDICTION_SYSTEM.predict('${matchId}', 'draw'); this.closest('.modal-backdrop').remove();"
                    class="btn-primary" style="flex: 1; background: #94a3b8; padding: 15px;">
              Draw
            </button>
            <button onclick="PREDICTION_SYSTEM.predict('${matchId}', '${team2.name || team2}'); this.closest('.modal-backdrop').remove();"
                    class="btn-primary" style="flex: 1; background: #3b82f6; padding: 15px;">
              ${team2.name || team2} Wins
            </button>
          </div>
          <button onclick="this.closest('.modal-backdrop').remove();"
                  style="width: 100%; margin-top: 15px; padding: 10px; background: transparent; border: 1px solid #475569; border-radius: 8px; color: #94a3b8; cursor: pointer;">
            Skip Prediction
          </button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
  };

  // Enhanced showStats with better UI
  const originalShowStats = PREDICTION_SYSTEM.showStats;
  PREDICTION_SYSTEM.showStats = function() {
    const accuracy = this.getAccuracy();
    const total = Object.keys(this.results).length;
    const correct = Object.values(this.results).filter(r => r.correct).length;

    const modal = document.createElement('div');
    modal.className = 'modal-backdrop active';
    modal.style.zIndex = '10002';
    modal.innerHTML = `
      <div class="modal-content" style="max-width: 600px;">
        <div class="modal-head">
          <h2>🔮 Prediction Statistics</h2>
          <button class="modal-close" onclick="this.closest('.modal-backdrop').remove()">✕</button>
        </div>
        <div style="padding: 30px;">
          <div style="text-align: center; margin-bottom: 30px;">
            <div style="font-size: 4em; font-weight: 700; color: ${accuracy >= 70 ? '#10b981' : accuracy >= 50 ? '#fbbf24' : '#ef4444'};">
              ${accuracy}%
            </div>
            <div style="color: #94a3b8; font-size: 1.1em;">Prediction Accuracy</div>
          </div>

          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 30px;">
            <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 12px; padding: 20px; text-align: center;">
              <div style="font-size: 2.5em; font-weight: 700; color: #10b981;">${correct}</div>
              <div style="color: #94a3b8; font-size: 0.9em;">Correct</div>
            </div>
            <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 12px; padding: 20px; text-align: center;">
              <div style="font-size: 2.5em; font-weight: 700; color: #ef4444;">${total - correct}</div>
              <div style="color: #94a3b8; font-size: 0.9em;">Wrong</div>
            </div>
          </div>

          ${total === 0 ? `
            <div style="text-align: center; padding: 40px 20px; background: rgba(100, 116, 139, 0.1); border-radius: 12px;">
              <div style="font-size: 3em; margin-bottom: 15px; opacity: 0.3;">🎯</div>
              <p style="color: #94a3b8;">No predictions yet! Start making predictions during matches.</p>
            </div>
          ` : `
            <div style="background: rgba(59, 130, 246, 0.05); border-radius: 12px; padding: 20px;">
              <h3 style="color: #3b82f6; margin-bottom: 15px; font-size: 1.1em;">📊 Performance Rating</h3>
              <div style="color: #f7fafc; font-size: 1.2em; font-weight: 600;">
                ${accuracy >= 70 ? '🏆 Expert Predictor!' : accuracy >= 60 ? '⭐ Great Predictions!' : accuracy >= 50 ? '👍 Good Start!' : '💪 Keep Practicing!'}
              </div>
            </div>
          `}

          <button onclick="this.closest('.modal-backdrop').remove();"
                  class="btn-primary" style="width: 100%; margin-top: 20px; padding: 12px;">
            Close
          </button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
  };
}

// Feature Guide System
const FEATURE_GUIDES = {
  showGuide(featureName) {
    const guides = {
      seasons: {
        title: '📅 Seasons Feature Guide',
        content: `
          <h3 style="color: #10b981; margin-bottom: 15px;">How to Use Seasons</h3>
          <ol style="color: #cbd5e1; line-height: 1.8; padding-left: 20px;">
            <li><strong>Start a Season:</strong> Click "Start New Season" to begin</li>
            <li><strong>Manage Your Team:</strong> Track your team's progress through the league</li>
            <li><strong>Simulate Matches:</strong> Play through matchdays one by one or simulate entire season</li>
            <li><strong>View Standings:</strong> Check your position in the league table</li>
            <li><strong>Season History:</strong> Review past seasons and achievements</li>
          </ol>
          <div style="margin-top: 20px; padding: 15px; background: rgba(59, 130, 246, 0.1); border-left: 3px solid #3b82f6; border-radius: 4px;">
            <strong style="color: #3b82f6;">💡 Tip:</strong>
            <span style="color: #cbd5e1;">Winning seasons earns you Manager XP and unlocks achievements!</span>
          </div>
        `
      },
      hallOfFame: {
        title: '🏛️ Hall of Fame Guide',
        content: `
          <h3 style="color: #fbbf24; margin-bottom: 15px;">How to Induct Players</h3>
          <ul style="color: #cbd5e1; line-height: 1.8; padding-left: 20px;">
            <li><strong>Automatic Induction:</strong> Top scorers (5+ goals in tournament) are automatically inducted</li>
            <li><strong>Tournament Champions:</strong> Winning teams get recorded in history</li>
            <li><strong>Record Breakers:</strong> Players who break records are celebrated</li>
            <li><strong>View Hall:</strong> Click "Hall of Fame" button to see all legends</li>
          </ul>
          <div style="margin-top: 20px; padding: 15px; background: rgba(251, 191, 36, 0.1); border-left: 3px solid #fbbf24; border-radius: 4px;">
            <strong style="color: #fbbf24;">⭐ Legend Status:</strong>
            <span style="color: #cbd5e1;">Players need 15+ goals OR 8.5+ avg rating OR 10+ apps (2 of 3) to be inducted</span>
          </div>
        `
      },
      predictions: {
        title: '🔮 Predictions Guide',
        content: `
          <h3 style="color: #a855f7; margin-bottom: 15px;">How to Make Predictions</h3>
          <ol style="color: #cbd5e1; line-height: 1.8; padding-left: 20px;">
            <li><strong>Before Matches:</strong> You'll be prompted to predict the outcome</li>
            <li><strong>Choose Winner:</strong> Select Team A, Draw, or Team B</li>
            <li><strong>Track Accuracy:</strong> Your prediction success rate is tracked</li>
            <li><strong>View Stats:</strong> Click "Prediction Stats" to see your performance</li>
          </ol>
          <div style="margin-top: 20px; padding: 15px; background: rgba(168, 85, 247, 0.1); border-left: 3px solid #a855f7; border-radius: 4px;">
            <strong style="color: #a855f7;">🎯 Challenge:</strong>
            <span style="color: #cbd5e1;">Can you achieve 70%+ accuracy and become an Expert Predictor?</span>
          </div>
        `
      },
      quickStart: {
        title: '🏆 Quick Start Templates',
        content: `
          <h3 style="color: #3b82f6; margin-bottom: 15px;">Tournament Templates</h3>
          <ul style="color: #cbd5e1; line-height: 1.8; padding-left: 20px;">
            <li><strong>Champions League:</strong> Top 32 elite European clubs (85+ rating)</li>
            <li><strong>World Cup:</strong> 32 diverse teams from around the world</li>
            <li><strong>Underdogs:</strong> Lower-rated teams battle for glory (under 80 rating)</li>
            <li><strong>Super Elite:</strong> Only the absolute best 16 teams (90+ rating)</li>
            <li><strong>Quick 16:</strong> Fast tournament with 16 teams</li>
            <li><strong>Classic 32:</strong> Traditional 32-team format</li>
          </ul>
          <div style="margin-top: 20px; padding: 15px; background: rgba(16, 185, 129, 0.1); border-left: 3px solid #10b981; border-radius: 4px;">
            <strong style="color: #10b981;">⚡ Quick Setup:</strong>
            <span style="color: #cbd5e1;">Templates auto-select teams and generate groups instantly!</span>
          </div>
        `
      }
    };

    const guide = guides[featureName];
    if (!guide) return;

    const modal = document.createElement('div');
    modal.className = 'modal-backdrop active';
    modal.style.zIndex = '10004';
    modal.innerHTML = `
      <div class="modal-content" style="max-width: 600px;">
        <div class="modal-head">
          <h2>${guide.title}</h2>
          <button class="modal-close" onclick="this.closest('.modal-backdrop').remove()">✕</button>
        </div>
        <div style="padding: 30px;">
          ${guide.content}
          <button onclick="this.closest('.modal-backdrop').remove();"
                  class="btn-primary" style="width: 100%; margin-top: 25px; padding: 12px; font-weight: 600;">
            Got It!
          </button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
  }
};

// ========================================
// CRITICAL FIXES & IMPROVEMENTS
// ========================================

// Confetti Memory Management System
const CONFETTI_MANAGER = {
  activeParticles: new Set(),
  maxParticles: 100,

  createConfetti(element) {
    if (this.activeParticles.size >= this.maxParticles) {
      this.cleanOldest(30);
    }

    if (!element) return;

    const rect = element.getBoundingClientRect();
    const colors = ['#10b981', '#fbbf24', '#3b82f6', '#ef4444', '#a855f7'];

    for (let i = 0; i < 30; i++) {
      const confetti = document.createElement('div');
      confetti.style.cssText = `
        position: fixed;
        width: 10px;
        height: 10px;
        background: ${colors[Math.floor(Math.random() * colors.length)]};
        border-radius: 50%;
        pointer-events: none;
        z-index: 10000;
        left: ${rect.left + rect.width / 2}px;
        top: ${rect.top + rect.height / 2}px;
        will-change: transform, opacity;
      `;

      document.body.appendChild(confetti);
      this.activeParticles.add(confetti);

      const angle = (Math.PI * 2 * i) / 30;
      const velocity = 3 + Math.random() * 3;
      let vx = Math.cos(angle) * velocity;
      let vy = Math.sin(angle) * velocity - 2;
      let x = 0;
      let y = 0;
      let rotation = 0;
      const startTime = performance.now();

      const animate = (currentTime) => {
        const elapsed = (currentTime - startTime) / 1000;

        if (y > 500 || elapsed > 2) {
          confetti.remove();
          this.activeParticles.delete(confetti);
          return;
        }

        vy += 0.3;
        x += vx;
        y += vy;
        rotation += 5;

        confetti.style.transform = `translate(${x}px, ${y}px) rotate(${rotation}deg)`;
        confetti.style.opacity = Math.max(0, 1 - elapsed / 2);

        requestAnimationFrame(animate);
      };

      requestAnimationFrame(animate);
    }
  },

  cleanOldest(count) {
    const particles = Array.from(this.activeParticles);
    for (let i = 0; i < Math.min(count, particles.length); i++) {
      particles[i].remove();
      this.activeParticles.delete(particles[i]);
    }
  },

  cleanAll() {
    this.activeParticles.forEach(p => p.remove());
    this.activeParticles.clear();
  }
};

// Cleanup on page unload
window.addEventListener('beforeunload', () => {
  CONFETTI_MANAGER.cleanAll();
});

// Override createConfetti to use manager
if (typeof window.createConfetti === 'function') {
  window.createConfetti = function(element) {
    CONFETTI_MANAGER.createConfetti(element);
  };
}

// Enhanced localStorage with quota handling
if (window.AUTO_SAVE) {
  const originalSave = AUTO_SAVE.save;

  AUTO_SAVE.save = function() {
    try {
      originalSave.call(this);
    } catch (e) {
      if (e.name === 'QuotaExceededError') {
        console.warn('⚠️ Storage quota exceeded, attempting minimal save...');
        this.saveMinimal();
      } else {
        console.error('❌ Save failed:', e);
        if (typeof showNotification === 'function') {
          showNotification('error', 'Save Failed', 'Could not save tournament', 3000);
        }
      }
    }
  };

  AUTO_SAVE.saveMinimal = function() {
    try {
      const minimalState = {
        version: '1.0',
        timestamp: Date.now(),
        champion: window.TOURNAMENT?.champion?.name,
        groupCount: Object.keys(window.GROUP_RESULTS || {}).length
      };

      localStorage.setItem('tournament_minimal', JSON.stringify(minimalState));
      console.log('✅ Minimal save successful');

      if (typeof showNotification === 'function') {
        showNotification('warning', 'Limited Save',
          'Storage full - saved essential data only', 3000);
      }
    } catch (e) {
      console.error('❌ Even minimal save failed:', e);
    }
  };
}

// Chart.js Safety Wrapper
window.createChartSafely = function(canvasId, config) {
  if (typeof Chart === 'undefined') {
    console.error('❌ Chart.js not loaded');
    const canvas = document.getElementById(canvasId);
    if (canvas && canvas.parentElement) {
      canvas.parentElement.innerHTML = `
        <div style="padding: 20px; text-align: center; color: #ef4444; background: rgba(239, 68, 68, 0.1); border-radius: 8px;">
          <p style="font-size: 1.2em; margin-bottom: 8px;">📊 Chart library not loaded</p>
          <p style="font-size: 0.875rem; color: #9ca3af;">
            Check internet connection and refresh page
          </p>
        </div>
      `;
    }
    return null;
  }

  try {
    const ctx = document.getElementById(canvasId);
    if (!ctx) {
      console.error(`Canvas element ${canvasId} not found`);
      return null;
    }
    return new Chart(ctx.getContext('2d'), config);
  } catch (error) {
    console.error('❌ Chart creation failed:', error);
    return null;
  }
};

// ========================================
// HISTORIC TEAMS DATABASE
// ========================================

const HISTORIC_TEAMS = {
  // World Cup Winners - Historic Lineups
  worldCup: {
    brazil_2002: {
      name: "Brazil 2002",
      country: "Brazil",
      year: 2002,
      strength: 95,
      tournament: "World Cup",
      players: [
        { name: "Ronaldo", position: "ST", rating: 96 },
        { name: "Rivaldo", position: "CAM", rating: 94 },
        { name: "Ronaldinho", position: "LW", rating: 92 },
        { name: "Roberto Carlos", position: "LB", rating: 91 },
        { name: "Cafu", position: "RB", rating: 90 },
        { name: "Lúcio", position: "CB", rating: 88 },
        { name: "Roque Júnior", position: "CB", rating: 85 },
        { name: "Gilberto Silva", position: "CDM", rating: 87 },
        { name: "Kléberson", position: "CM", rating: 82 },
        { name: "Marcos", position: "GK", rating: 86 },
        { name: "Denílson", position: "RM", rating: 83 }
      ]
    },
    brazil_1970: {
      name: "Brazil 1970",
      country: "Brazil",
      year: 1970,
      strength: 97,
      tournament: "World Cup",
      players: [
        { name: "Pelé", position: "ST", rating: 99 },
        { name: "Jairzinho", position: "RW", rating: 93 },
        { name: "Tostão", position: "CF", rating: 91 },
        { name: "Rivelino", position: "LW", rating: 92 },
        { name: "Gérson", position: "CM", rating: 89 },
        { name: "Clodoaldo", position: "CDM", rating: 87 },
        { name: "Carlos Alberto", position: "RB", rating: 92 },
        { name: "Brito", position: "CB", rating: 86 },
        { name: "Piazza", position: "CB", rating: 85 },
        { name: "Everaldo", position: "LB", rating: 84 },
        { name: "Félix", position: "GK", rating: 87 }
      ]
    },
    germany_2014: {
      name: "Germany 2014",
      country: "Germany",
      year: 2014,
      strength: 94,
      tournament: "World Cup",
      players: [
        { name: "Manuel Neuer", position: "GK", rating: 93 },
        { name: "Philipp Lahm", position: "RB", rating: 91 },
        { name: "Mats Hummels", position: "CB", rating: 89 },
        { name: "Jérôme Boateng", position: "CB", rating: 88 },
        { name: "Benedikt Höwedes", position: "LB", rating: 85 },
        { name: "Bastian Schweinsteiger", position: "CDM", rating: 90 },
        { name: "Toni Kroos", position: "CM", rating: 91 },
        { name: "Mesut Özil", position: "CAM", rating: 90 },
        { name: "Thomas Müller", position: "RW", rating: 89 },
        { name: "Mario Götze", position: "CF", rating: 87 },
        { name: "André Schürrle", position: "LW", rating: 85 }
      ]
    },
    france_1998: {
      name: "France 1998",
      country: "France",
      year: 1998,
      strength: 93,
      tournament: "World Cup",
      players: [
        { name: "Zinedine Zidane", position: "CAM", rating: 96 },
        { name: "Thierry Henry", position: "ST", rating: 88 },
        { name: "Didier Deschamps", position: "CDM", rating: 87 },
        { name: "Emmanuel Petit", position: "CM", rating: 86 },
        { name: "Patrick Vieira", position: "CM", rating: 89 },
        { name: "Lilian Thuram", position: "RB", rating: 90 },
        { name: "Laurent Blanc", position: "CB", rating: 91 },
        { name: "Marcel Desailly", position: "CB", rating: 92 },
        { name: "Bixente Lizarazu", position: "LB", rating: 88 },
        { name: "Fabien Barthez", position: "GK", rating: 89 },
        { name: "Youri Djorkaeff", position: "CF", rating: 87 }
      ]
    },
    argentina_1986: {
      name: "Argentina 1986",
      country: "Argentina",
      year: 1986,
      strength: 95,
      tournament: "World Cup",
      players: [
        { name: "Diego Maradona", position: "CAM", rating: 99 },
        { name: "Jorge Valdano", position: "ST", rating: 88 },
        { name: "Jorge Burruchaga", position: "CF", rating: 86 },
        { name: "Sergio Batista", position: "CM", rating: 85 },
        { name: "Héctor Enrique", position: "CM", rating: 84 },
        { name: "José Luis Brown", position: "CB", rating: 86 },
        { name: "Oscar Ruggeri", position: "CB", rating: 89 },
        { name: "José Luis Cuciuffo", position: "LB", rating: 83 },
        { name: "Julio Olarticoechea", position: "RB", rating: 82 },
        { name: "Nery Pumpido", position: "GK", rating: 87 },
        { name: "Ricardo Giusti", position: "CDM", rating: 84 }
      ]
    },
    italy_2006: {
      name: "Italy 2006",
      country: "Italy",
      year: 2006,
      strength: 93,
      tournament: "World Cup",
      players: [
        { name: "Gianluigi Buffon", position: "GK", rating: 95 },
        { name: "Fabio Cannavaro", position: "CB", rating: 94 },
        { name: "Alessandro Nesta", position: "CB", rating: 92 },
        { name: "Gianluca Zambrotta", position: "RB", rating: 88 },
        { name: "Fabio Grosso", position: "LB", rating: 85 },
        { name: "Andrea Pirlo", position: "CM", rating: 93 },
        { name: "Gennaro Gattuso", position: "CDM", rating: 88 },
        { name: "Francesco Totti", position: "CAM", rating: 93 },
        { name: "Alessandro Del Piero", position: "LW", rating: 91 },
        { name: "Luca Toni", position: "ST", rating: 87 },
        { name: "Simone Perrotta", position: "CM", rating: 84 }
      ]
    },
    spain_2010: {
      name: "Spain 2010",
      country: "Spain",
      year: 2010,
      strength: 94,
      tournament: "World Cup",
      players: [
        { name: "Iker Casillas", position: "GK", rating: 92 },
        { name: "Sergio Ramos", position: "CB", rating: 90 },
        { name: "Carles Puyol", position: "CB", rating: 92 },
        { name: "Gerard Piqué", position: "CB", rating: 89 },
        { name: "Xavi Hernández", position: "CM", rating: 95 },
        { name: "Andrés Iniesta", position: "CAM", rating: 94 },
        { name: "Sergio Busquets", position: "CDM", rating: 89 },
        { name: "David Villa", position: "ST", rating: 91 },
        { name: "Pedro Rodríguez", position: "RW", rating: 87 },
        { name: "Joan Capdevila", position: "LB", rating: 84 },
        { name: "Xabi Alonso", position: "CM", rating: 90 }
      ]
    },
    england_1966: {
      name: "England 1966",
      country: "England",
      year: 1966,
      strength: 91,
      tournament: "World Cup",
      players: [
        { name: "Gordon Banks", position: "GK", rating: 91 },
        { name: "Bobby Moore", position: "CB", rating: 94 },
        { name: "Jack Charlton", position: "CB", rating: 88 },
        { name: "George Cohen", position: "RB", rating: 85 },
        { name: "Ray Wilson", position: "LB", rating: 86 },
        { name: "Bobby Charlton", position: "CAM", rating: 95 },
        { name: "Nobby Stiles", position: "CDM", rating: 86 },
        { name: "Alan Ball", position: "CM", rating: 87 },
        { name: "Martin Peters", position: "CM", rating: 86 },
        { name: "Geoff Hurst", position: "ST", rating: 89 },
        { name: "Roger Hunt", position: "ST", rating: 84 }
      ]
    },
    uruguay_1950: {
      name: "Uruguay 1950",
      country: "Uruguay",
      year: 1950,
      strength: 89,
      tournament: "World Cup",
      players: [
        { name: "Roque Máspoli", position: "GK", rating: 86 },
        { name: "Obdulio Varela", position: "CDM", rating: 90 },
        { name: "Schubert Gambetta", position: "CB", rating: 84 },
        { name: "Matías González", position: "CB", rating: 83 },
        { name: "Eusebio Tejera", position: "LB", rating: 82 },
        { name: "Juan Alberto Schiaffino", position: "CAM", rating: 92 },
        { name: "Alcides Ghiggia", position: "RW", rating: 89 },
        { name: "Omar Míguez", position: "ST", rating: 87 },
        { name: "Julio Pérez", position: "LW", rating: 85 },
        { name: "Víctor Rodríguez Andrade", position: "CM", rating: 85 },
        { name: "Óscar Míguez", position: "CF", rating: 84 }
      ]
    },
    france_2018: {
      name: "France 2018",
      country: "France",
      year: 2018,
      strength: 94,
      tournament: "World Cup",
      players: [
        { name: "Hugo Lloris", position: "GK", rating: 90 },
        { name: "Raphaël Varane", position: "CB", rating: 91 },
        { name: "Samuel Umtiti", position: "CB", rating: 88 },
        { name: "Benjamin Pavard", position: "RB", rating: 86 },
        { name: "Lucas Hernández", position: "LB", rating: 87 },
        { name: "N'Golo Kanté", position: "CDM", rating: 92 },
        { name: "Paul Pogba", position: "CM", rating: 90 },
        { name: "Blaise Matuidi", position: "CM", rating: 87 },
        { name: "Kylian Mbappé", position: "ST", rating: 93 },
        { name: "Antoine Griezmann", position: "CAM", rating: 92 },
        { name: "Olivier Giroud", position: "ST", rating: 86 }
      ]
    },
    argentina_2022: {
      name: "Argentina 2022",
      country: "Argentina",
      year: 2022,
      strength: 93,
      tournament: "World Cup",
      players: [
        { name: "Emiliano Martínez", position: "GK", rating: 91 },
        { name: "Cristian Romero", position: "CB", rating: 88 },
        { name: "Nicolás Otamendi", position: "CB", rating: 86 },
        { name: "Nahuel Molina", position: "RB", rating: 85 },
        { name: "Nicolás Tagliafico", position: "LB", rating: 85 },
        { name: "Rodrigo De Paul", position: "CM", rating: 87 },
        { name: "Enzo Fernández", position: "CM", rating: 88 },
        { name: "Alexis Mac Allister", position: "CM", rating: 86 },
        { name: "Lionel Messi", position: "RW", rating: 96 },
        { name: "Julián Álvarez", position: "ST", rating: 87 },
        { name: "Ángel Di María", position: "LW", rating: 89 }
      ]
    }
  },

  // Champions League Legends
  championsLeague: {
    milan_2007: {
      name: "AC Milan 2007",
      country: "Italy",
      year: 2007,
      strength: 93,
      tournament: "Champions League",
      players: [
        { name: "Dida", position: "GK", rating: 88 },
        { name: "Paolo Maldini", position: "CB", rating: 94 },
        { name: "Alessandro Nesta", position: "CB", rating: 92 },
        { name: "Marek Jankulovski", position: "LB", rating: 83 },
        { name: "Massimo Oddo", position: "RB", rating: 82 },
        { name: "Gennaro Gattuso", position: "CDM", rating: 88 },
        { name: "Andrea Pirlo", position: "CM", rating: 93 },
        { name: "Clarence Seedorf", position: "CM", rating: 90 },
        { name: "Kaká", position: "CAM", rating: 96 },
        { name: "Filippo Inzaghi", position: "ST", rating: 89 },
        { name: "Alberto Gilardino", position: "ST", rating: 84 }
      ]
    },
    barcelona_2011: {
      name: "Barcelona 2011",
      country: "Spain",
      year: 2011,
      strength: 96,
      tournament: "Champions League",
      players: [
        { name: "Víctor Valdés", position: "GK", rating: 87 },
        { name: "Dani Alves", position: "RB", rating: 91 },
        { name: "Gerard Piqué", position: "CB", rating: 89 },
        { name: "Carles Puyol", position: "CB", rating: 91 },
        { name: "Eric Abidal", position: "LB", rating: 86 },
        { name: "Sergio Busquets", position: "CDM", rating: 89 },
        { name: "Xavi Hernández", position: "CM", rating: 95 },
        { name: "Andrés Iniesta", position: "CM", rating: 94 },
        { name: "Lionel Messi", position: "RW", rating: 99 },
        { name: "David Villa", position: "ST", rating: 91 },
        { name: "Pedro Rodríguez", position: "LW", rating: 87 }
      ]
    },
    real_madrid_2017: {
      name: "Real Madrid 2017",
      country: "Spain",
      year: 2017,
      strength: 95,
      tournament: "Champions League",
      players: [
        { name: "Keylor Navas", position: "GK", rating: 88 },
        { name: "Sergio Ramos", position: "CB", rating: 92 },
        { name: "Raphaël Varane", position: "CB", rating: 89 },
        { name: "Marcelo", position: "LB", rating: 91 },
        { name: "Dani Carvajal", position: "RB", rating: 88 },
        { name: "Casemiro", position: "CDM", rating: 89 },
        { name: "Luka Modrić", position: "CM", rating: 93 },
        { name: "Toni Kroos", position: "CM", rating: 92 },
        { name: "Cristiano Ronaldo", position: "LW", rating: 98 },
        { name: "Karim Benzema", position: "ST", rating: 90 },
        { name: "Gareth Bale", position: "RW", rating: 90 }
      ]
    },
    liverpool_2005: {
      name: "Liverpool 2005",
      country: "England",
      year: 2005,
      strength: 89,
      tournament: "Champions League",
      players: [
        { name: "Jerzy Dudek", position: "GK", rating: 84 },
        { name: "Jamie Carragher", position: "CB", rating: 87 },
        { name: "Sami Hyypiä", position: "CB", rating: 88 },
        { name: "Steve Finnan", position: "RB", rating: 82 },
        { name: "Djimi Traoré", position: "LB", rating: 78 },
        { name: "Steven Gerrard", position: "CM", rating: 93 },
        { name: "Xabi Alonso", position: "CM", rating: 88 },
        { name: "Dietmar Hamann", position: "CDM", rating: 84 },
        { name: "Luis García", position: "CAM", rating: 85 },
        { name: "Harry Kewell", position: "LW", rating: 84 },
        { name: "Milan Baroš", position: "ST", rating: 82 }
      ]
    },
    bayern_2013: {
      name: "Bayern Munich 2013",
      country: "Germany",
      year: 2013,
      strength: 94,
      tournament: "Champions League",
      players: [
        { name: "Manuel Neuer", position: "GK", rating: 92 },
        { name: "Philipp Lahm", position: "RB", rating: 91 },
        { name: "Jérôme Boateng", position: "CB", rating: 87 },
        { name: "Dante", position: "CB", rating: 86 },
        { name: "David Alaba", position: "LB", rating: 87 },
        { name: "Bastian Schweinsteiger", position: "CM", rating: 90 },
        { name: "Javi Martínez", position: "CDM", rating: 88 },
        { name: "Thomas Müller", position: "RW", rating: 88 },
        { name: "Arjen Robben", position: "RW", rating: 92 },
        { name: "Franck Ribéry", position: "LW", rating: 91 },
        { name: "Mario Mandžukić", position: "ST", rating: 87 }
      ]
    },
    manchester_united_1999: {
      name: "Manchester United 1999",
      country: "England",
      year: 1999,
      strength: 92,
      tournament: "Champions League",
      players: [
        { name: "Peter Schmeichel", position: "GK", rating: 93 },
        { name: "Gary Neville", position: "RB", rating: 85 },
        { name: "Jaap Stam", position: "CB", rating: 90 },
        { name: "Ronny Johnsen", position: "CB", rating: 84 },
        { name: "Denis Irwin", position: "LB", rating: 86 },
        { name: "David Beckham", position: "RM", rating: 90 },
        { name: "Roy Keane", position: "CM", rating: 91 },
        { name: "Paul Scholes", position: "CM", rating: 92 },
        { name: "Ryan Giggs", position: "LW", rating: 91 },
        { name: "Dwight Yorke", position: "ST", rating: 88 },
        { name: "Andy Cole", position: "ST", rating: 87 }
      ]
    }
  }
};

// ========================================
// ENHANCED CUSTOM MATCH SYSTEM
// ========================================

function clearTeamSelection(team) {
  if (team === 'A') {
    window.CUSTOM_MATCH_STATE.teamA = null;
  } else {
    window.CUSTOM_MATCH_STATE.teamB = null;
  }
  showEnhancedCustomMatch();
}

function updateMatchSetting(setting, value) {
  window.CUSTOM_MATCH_STATE[setting] = value;
  if (window.VERBOSE_LOGGING) console.log(`Updated ${setting} to:`, value);
}

function updateMatchType(type) {
  window.CUSTOM_MATCH_STATE.matchType = type;

  // Auto-adjust importance based on match type
  if (type === 'friendly') {
    window.CUSTOM_MATCH_STATE.importance = 0.8;
  } else if (type === 'important') {
    window.CUSTOM_MATCH_STATE.importance = 1.3;
  } else if (type === 'final') {
    window.CUSTOM_MATCH_STATE.importance = 2.0;
  }

  document.getElementById('importanceSlider').value = window.CUSTOM_MATCH_STATE.importance;
  document.getElementById('importanceValue').textContent = window.CUSTOM_MATCH_STATE.importance.toFixed(1) + 'x';
}

function updateImportance(value) {
  window.CUSTOM_MATCH_STATE.importance = parseFloat(value);
  document.getElementById('importanceValue').textContent = value + 'x';
}

function calculateWinProbability(teamA, teamB) {
  const diff = teamA.strength - teamB.strength;
  const baseProb = 50;
  const adjustment = diff * 2; // 2% per rating point

  let probA = Math.max(10, Math.min(90, baseProb + adjustment));
  let probB = Math.max(10, Math.min(90, baseProb - adjustment));
  let probDraw = 100 - probA - probB;

  // Adjust for venue
  if (window.CUSTOM_MATCH_STATE.venue === 'home') {
    probA += 5;
    probB -= 3;
    probDraw -= 2;
  } else if (window.CUSTOM_MATCH_STATE.venue === 'away') {
    probA -= 3;
    probB += 5;
    probDraw -= 2;
  }

  // Normalize
  const total = probA + probB + probDraw;
  probA = (probA / total * 100).toFixed(1);
  probB = (probB / total * 100).toFixed(1);
  probDraw = (probDraw / total * 100).toFixed(1);

  return `
    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
      <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3);
                  border-radius: 8px; padding: 12px; text-align: center;">
        <div style="color: #10b981; font-weight: 700; font-size: 1.5em;">${probA}%</div>
        <div style="color: #94a3b8; font-size: 0.85em; margin-top: 5px;">Team A Win</div>
      </div>
      <div style="background: rgba(251, 191, 36, 0.1); border: 1px solid rgba(251, 191, 36, 0.3);
                  border-radius: 8px; padding: 12px; text-align: center;">
        <div style="color: #fbbf24; font-weight: 700; font-size: 1.5em;">${probDraw}%</div>
        <div style="color: #94a3b8; font-size: 0.85em; margin-top: 5px;">Draw</div>
      </div>
      <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3);
                  border-radius: 8px; padding: 12px; text-align: center;">
        <div style="color: #3b82f6; font-weight: 700; font-size: 1.5em;">${probB}%</div>
        <div style="color: #94a3b8; font-size: 0.85em; margin-top: 5px;">Team B Win</div>
      </div>
    </div>
  `;
}

function quickRandomMatch() {
  // Select two random teams
  const allTeams = [...(window.ALL_TEAMS || window.TEAMS || [])];
  if (allTeams.length < 2) {
    showNotification('error', 'Not Enough Teams', 'Need at least 2 teams', 2000);
    return;
  }

  const randomA = allTeams[Math.floor(Math.random() * allTeams.length)];
  let randomB;

  do {
    randomB = allTeams[Math.floor(Math.random() * allTeams.length)];
  } while (randomB.name === randomA.name);

  window.CUSTOM_MATCH_STATE.teamA = randomA;
  window.CUSTOM_MATCH_STATE.teamB = randomB;

  showEnhancedCustomMatch();
  showNotification('success', 'Random Teams Selected!',
    `${randomA.name} vs ${randomB.name}`, 2000);
}

function showClassicRivalries() {
  const rivalries = [
    { teamA: 'Real Madrid', teamB: 'Barcelona', name: 'El Clásico' },
    { teamA: 'Manchester United', teamB: 'Liverpool', name: 'North West Derby' },
    { teamA: 'AC Milan', teamB: 'Inter Milan', name: 'Derby della Madonnina' },
    { teamA: 'Bayern Munich', teamB: 'Borussia Dortmund', name: 'Der Klassiker' },
    { teamA: 'Boca Juniors', teamB: 'River Plate', name: 'Superclásico' },
    { teamA: 'Celtic', teamB: 'Rangers', name: 'Old Firm Derby' }
  ];

  const modal = document.createElement('div');
  modal.className = 'modal-backdrop active';
  modal.style.zIndex = '10005';
  modal.innerHTML = `
    <div class="modal-content" style="max-width: 800px;">
      <div class="modal-head">
        <h2 style="color: #ef4444;">⚔️ Classic Rivalries</h2>
        <button class="modal-close" onclick="this.closest('.modal-backdrop').remove()">✕</button>
      </div>

      <div style="padding: 30px;">
        <div style="display: grid; gap: 16px;">
          ${rivalries.map(rivalry => {
            const allTeams = window.ALL_TEAMS || window.TEAMS || [];
            const teamA = allTeams.find(t => t.name === rivalry.teamA);
            const teamB = allTeams.find(t => t.name === rivalry.teamB);

            if (!teamA || !teamB) return '';

            return `
              <div style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(220, 38, 38, 0.1));
                          border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 12px; padding: 20px;
                          cursor: pointer; transition: all 0.2s;"
                   onclick="loadRivalryMatch('${rivalry.teamA}', '${rivalry.teamB}'); this.closest('.modal-backdrop').remove();"
                   onmouseover="this.style.borderColor='#ef4444'; this.style.transform='translateY(-2px)'"
                   onmouseout="this.style.borderColor='rgba(239, 68, 68, 0.3)'; this.style.transform='translateY(0)'">
                <div style="text-align: center; margin-bottom: 12px;">
                  <div style="color: #ef4444; font-weight: 700; font-size: 1.2em;">${rivalry.name}</div>
                </div>
                <div style="display: flex; justify-content: space-around; align-items: center;">
                  <div style="text-align: center;">
                    <div style="font-weight: 700; color: #f1f5f9; font-size: 1.1em;">${rivalry.teamA}</div>
                    <div style="color: #94a3b8; font-size: 0.85em; margin-top: 5px;">${teamA.strength}</div>
                  </div>
                  <div style="color: #ef4444; font-size: 1.5em; font-weight: 600;">VS</div>
                  <div style="text-align: center;">
                    <div style="font-weight: 700; color: #f1f5f9; font-size: 1.1em;">${rivalry.teamB}</div>
                    <div style="color: #94a3b8; font-size: 0.85em; margin-top: 5px;">${teamB.strength}</div>
                  </div>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      </div>
    </div>
  `;

  document.body.appendChild(modal);
}

function loadRivalryMatch(teamAName, teamBName) {
  const allTeams = window.ALL_TEAMS || window.TEAMS || [];
  const teamA = allTeams.find(t => t.name === teamAName);
  const teamB = allTeams.find(t => t.name === teamBName);

  if (teamA && teamB) {
    window.CUSTOM_MATCH_STATE.teamA = teamA;
    window.CUSTOM_MATCH_STATE.teamB = teamB;
    window.CUSTOM_MATCH_STATE.matchType = 'important';
    window.CUSTOM_MATCH_STATE.importance = 1.5;

    showEnhancedCustomMatch();
    showNotification('success', 'Rivalry Loaded!',
      `${teamAName} vs ${teamBName}`, 2000);
  }
}

// ======================
// MAIN ENHANCED CUSTOM MATCH UI
// ======================

function showEnhancedCustomMatch() {
  const content = document.getElementById('content') || document.getElementById('output') || document.getElementById('output');
  if (!content) return;

  // Initialize CUSTOM_MATCH_STATE if needed
  if (!window.CUSTOM_MATCH_STATE) {
    window.CUSTOM_MATCH_STATE = {
      teamA: null,
      teamB: null,
      settings: {
        venue: 'neutral',
        weather: 'clear',
        matchType: 'friendly',
        importance: 5,
        enablePredictions: true,
        enableLiveSim: false
      }
    };
  }

  content.innerHTML = `
    <div style="max-width: 1200px; margin: 0 auto; padding: 20px;">
      <!-- Header -->
      <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                  padding: 30px; border-radius: 15px; text-align: center; margin-bottom: 30px;
                  box-shadow: 0 10px 40px rgba(102,126,234,0.3);">
        <h1 style="margin: 0 0 10px 0; color: white; font-size: 2.5em; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">
          ⚽ Enhanced Custom Match
        </h1>
        <p style="margin: 0; color: rgba(255,255,255,0.9); font-size: 1.1em;">
          Select teams, configure settings, and simulate exciting matches
        </p>
      </div>

      <!-- Team Selection -->
      <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 20px; margin-bottom: 30px; align-items: center;">

        <!-- Team A Panel -->
        <div id="teamAPanel" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
                                     padding: 25px; border-radius: 15px; text-align: center;
                                     box-shadow: 0 5px 20px rgba(245,87,108,0.3); cursor: pointer;
                                     transition: transform 0.3s;"
             onclick="openTeamPicker('A')"
             onmouseover="this.style.transform='scale(1.05)'"
             onmouseout="this.style.transform='scale(1)'">
          <div style="font-size: 3em; margin-bottom: 10px;">🏃</div>
          <h3 style="margin: 10px 0; color: white; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">
            ${window.CUSTOM_MATCH_STATE.teamA ? window.CUSTOM_MATCH_STATE.teamA.name : 'Select Team A'}
          </h3>
          ${window.CUSTOM_MATCH_STATE.teamA ?
            `<div style="color: rgba(255,255,255,0.9); font-size: 0.9em;">
              Strength: ${window.CUSTOM_MATCH_STATE.teamA.strength}
            </div>` :
            '<div style="color: rgba(255,255,255,0.8);">Click to select</div>'
          }
        </div>

        <!-- VS Divider -->
        <div style="font-size: 2.5em; font-weight: bold; color: #667eea;">VS</div>

        <!-- Team B Panel -->
        <div id="teamBPanel" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
                                     padding: 25px; border-radius: 15px; text-align: center;
                                     box-shadow: 0 5px 20px rgba(0,242,254,0.3); cursor: pointer;
                                     transition: transform 0.3s;"
             onclick="openTeamPicker('B')"
             onmouseover="this.style.transform='scale(1.05)'"
             onmouseout="this.style.transform='scale(1)'">
          <div style="font-size: 3em; margin-bottom: 10px;">🏃</div>
          <h3 style="margin: 10px 0; color: white; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">
            ${window.CUSTOM_MATCH_STATE.teamB ? window.CUSTOM_MATCH_STATE.teamB.name : 'Select Team B'}
          </h3>
          ${window.CUSTOM_MATCH_STATE.teamB ?
            `<div style="color: rgba(255,255,255,0.9); font-size: 0.9em;">
              Strength: ${window.CUSTOM_MATCH_STATE.teamB.strength}
            </div>` :
            '<div style="color: rgba(255,255,255,0.8);">Click to select</div>'
          }
        </div>
      </div>

      <!-- Match Settings -->
      <div style="background: white; padding: 25px; border-radius: 15px; margin-bottom: 25px;
                  box-shadow: 0 5px 20px rgba(0,0,0,0.1);">
        <h3 style="margin-top: 0; color: #667eea; border-bottom: 2px solid #667eea; padding-bottom: 10px;">
          ⚙️ Match Settings
        </h3>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
          <!-- Venue -->
          <div>
            <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #555;">
              🏟️ Venue
            </label>
            <select onchange="updateMatchSetting('venue', this.value)"
                    style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid #ddd;
                           font-size: 1em; cursor: pointer;">
              <option value="neutral" selected>Neutral Ground</option>
              <option value="teamA">Team A Home</option>
              <option value="teamB">Team B Home</option>
            </select>
          </div>

          <!-- Weather -->
          <div>
            <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #555;">
              🌤️ Weather
            </label>
            <select onchange="updateMatchSetting('weather', this.value)"
                    style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid #ddd;
                           font-size: 1em; cursor: pointer;">
              <option value="clear" selected>Clear ☀️</option>
              <option value="rainy">Rainy 🌧️</option>
              <option value="snowy">Snowy ❄️</option>
              <option value="windy">Windy 💨</option>
            </select>
          </div>

          <!-- Match Type -->
          <div>
            <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #555;">
              🏆 Match Type
            </label>
            <select onchange="updateMatchType(this.value)"
                    style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid #ddd;
                           font-size: 1em; cursor: pointer;">
              <option value="friendly" selected>Friendly</option>
              <option value="competitive">Competitive</option>
              <option value="final">Final</option>
            </select>
          </div>

          <!-- Importance Slider -->
          <div>
            <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #555;">
              ⭐ Match Importance: <span id="importanceValue">5</span>/10
            </label>
            <input type="range" min="1" max="10" value="5"
                   oninput="updateImportance(this.value)"
                   style="width: 100%; cursor: pointer;">
          </div>
        </div>

        <!-- Additional Options -->
        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
          <label style="display: inline-flex; align-items: center; margin-right: 25px; cursor: pointer;">
            <input type="checkbox" checked onchange="updateMatchSetting('enablePredictions', this.checked)"
                   style="width: 18px; height: 18px; margin-right: 8px; cursor: pointer;">
            <span style="font-weight: bold;">🔮 Enable Predictions</span>
          </label>
          <label style="display: inline-flex; align-items: center; cursor: pointer;">
            <input type="checkbox" onchange="updateMatchSetting('enableLiveSim', this.checked)"
                   style="width: 18px; height: 18px; margin-right: 8px; cursor: pointer;">
            <span style="font-weight: bold;">⚡ Live Simulation</span>
          </label>
        </div>
      </div>

      <!-- Action Buttons -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
        <button onclick="simulateCustomMatchEnhanced()"
                style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                       color: white; border: none; padding: 15px 25px; border-radius: 10px;
                       font-size: 1.1em; font-weight: bold; cursor: pointer;
                       box-shadow: 0 5px 15px rgba(102,126,234,0.4);
                       transition: all 0.3s;"
                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 7px 20px rgba(102,126,234,0.5)'"
                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 5px 15px rgba(102,126,234,0.4)'">
          ⚽ Simulate Match
        </button>

        <button onclick="quickRandomMatch()"
                style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
                       color: white; border: none; padding: 15px 25px; border-radius: 10px;
                       font-size: 1.1em; font-weight: bold; cursor: pointer;
                       box-shadow: 0 5px 15px rgba(245,87,108,0.4);
                       transition: all 0.3s;"
                onmouseover="this.style.transform='translateY(-2px)'"
                onmouseout="this.style.transform='translateY(0)'">
          🎲 Random Match
        </button>

        <button onclick="showClassicRivalries()"
                style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
                       color: white; border: none; padding: 15px 25px; border-radius: 10px;
                       font-size: 1.1em; font-weight: bold; cursor: pointer;
                       box-shadow: 0 5px 15px rgba(250,112,154,0.4);
                       transition: all 0.3s;"
                onmouseover="this.style.transform='translateY(-2px)'"
                onmouseout="this.style.transform='translateY(0)'">
          🔥 Classic Rivalries
        </button>

        <button onclick="clearTeamSelection('both')"
                style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
                       color: #333; border: none; padding: 15px 25px; border-radius: 10px;
                       font-size: 1.1em; font-weight: bold; cursor: pointer;
                       box-shadow: 0 5px 15px rgba(252,182,159,0.4);
                       transition: all 0.3s;"
                onmouseover="this.style.transform='translateY(-2px)'"
                onmouseout="this.style.transform='translateY(0)'">
          🔄 Reset Teams
        </button>
      </div>

      <!-- Stats Preview -->
      <div id="statsPreview" style="background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);
                                     padding: 20px; border-radius: 15px; text-align: center;
                                     box-shadow: 0 5px 20px rgba(142,197,252,0.3);">
        ${calculateWinProbability(window.CUSTOM_MATCH_STATE.teamA, window.CUSTOM_MATCH_STATE.teamB)}
      </div>
    </div>
  `;
}

// ======================
// TEAM PICKER MODAL
// ======================

function openTeamPicker(team) {
  // Create modal backdrop
  const modal = document.createElement('div');
  modal.id = 'teamPickerModal';
  modal.style.cssText = `
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.7); z-index: 10000;
    display: flex; align-items: center; justify-content: center;
    animation: fadeIn 0.3s;
  `;

  // Get all available teams
  const allTeams = [...window.ALL_TEAMS];

  // Add historic teams if available
  if (window.HISTORIC_TEAMS) {
    Object.values(window.HISTORIC_TEAMS.worldCup).forEach(team => {
      allTeams.push({
        name: team.name,
        strength: team.strength,
        country: team.country || 'Historic',
        isHistoric: true
      });
    });
    Object.values(window.HISTORIC_TEAMS.championsLeague).forEach(team => {
      allTeams.push({
        name: team.name,
        strength: team.strength,
        country: team.country || 'Historic',
        isHistoric: true
      });
    });
  }

  modal.innerHTML = `
    <div style="background: white; border-radius: 20px; padding: 0; max-width: 800px; width: 90%;
                max-height: 80vh; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                display: flex; flex-direction: column;">

      <!-- Header -->
      <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                  padding: 25px; color: white; border-radius: 20px 20px 0 0;">
        <h2 style="margin: 0 0 10px 0; font-size: 1.8em;">
          Select Team ${team}
        </h2>
        <div style="position: relative;">
          <input type="text" id="teamSearch" placeholder="🔍 Search teams..."
                 oninput="filterTeamPicker(this.value)"
                 style="width: 100%; padding: 12px 15px; border: none; border-radius: 10px;
                        font-size: 1em; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
        </div>
      </div>

      <!-- Filters -->
      <div style="padding: 15px; background: #f8f9fa; border-bottom: 1px solid #dee2e6;">
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
          <button onclick="filterTeamPicker('', 'all')"
                  style="padding: 8px 16px; border-radius: 20px; border: 2px solid #667eea;
                         background: white; cursor: pointer; font-weight: bold;">
            All Teams
          </button>
          <button onclick="filterTeamPicker('', 'strong')"
                  style="padding: 8px 16px; border-radius: 20px; border: 2px solid #f5576c;
                         background: white; cursor: pointer; font-weight: bold;">
            ⭐ Top Teams (85+)
          </button>
          <button onclick="filterTeamPicker('', 'historic')"
                  style="padding: 8px 16px; border-radius: 20px; border: 2px solid #ffd700;
                         background: white; cursor: pointer; font-weight: bold;">
            🏆 Historic Teams
          </button>
        </div>
      </div>

      <!-- Team List -->
      <div id="teamPickerList" style="flex: 1; overflow-y: auto; padding: 20px;">
        <!-- Teams will be loaded here -->
      </div>

      <!-- Footer -->
      <div style="padding: 20px; background: #f8f9fa; border-top: 1px solid #dee2e6; text-align: center;">
        <button onclick="document.getElementById('teamPickerModal').remove()"
                style="background: #6c757d; color: white; border: none; padding: 12px 30px;
                       border-radius: 10px; font-size: 1em; font-weight: bold; cursor: pointer;">
          ✕ Cancel
        </button>
      </div>
    </div>
  `;

  document.body.appendChild(modal);

  // Store which team we're selecting
  modal.dataset.selectingTeam = team;

  // Load initial team list
  loadTeamPickerList(allTeams);

  // Focus search
  setTimeout(() => document.getElementById('teamSearch').focus(), 100);
}

function loadTeamPickerList(teams) {
  const listContainer = document.getElementById('teamPickerList');
  if (!listContainer) return;

  if (teams.length === 0) {
    listContainer.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #6c757d;">
        <div style="font-size: 3em; margin-bottom: 10px;">🔍</div>
        <p>No teams found matching your search.</p>
      </div>
    `;
    return;
  }

  listContainer.innerHTML = `
    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px;">
      ${teams.map(team => `
        <div onclick='selectTeamFromPicker(${JSON.stringify(team).replace(/'/g, "&apos;")})'
             style="background: ${team.isHistoric ? 'linear-gradient(135deg, #ffd89b 0%, #19547b 100%)' : 'linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%)'};
                    padding: 20px; border-radius: 12px; cursor: pointer;
                    box-shadow: 0 3px 10px rgba(0,0,0,0.1);
                    transition: all 0.3s; position: relative;"
             onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 5px 20px rgba(0,0,0,0.2)'"
             onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 3px 10px rgba(0,0,0,0.1)'">
          ${team.isHistoric ? '<div style="position: absolute; top: 10px; right: 10px; font-size: 1.5em;">🏆</div>' : ''}
          <h4 style="margin: 0 0 8px 0; color: white; font-size: 1.1em; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">
            ${team.name}
          </h4>
          <div style="color: rgba(255,255,255,0.9); font-size: 0.9em;">
            <div>⭐ Strength: ${team.strength}</div>
            <div>🌍 ${team.country || 'International'}</div>
          </div>
        </div>
      `).join('')}
    </div>
  `;
}

function filterTeamPicker(searchTerm, filterType = 'search') {
  const modal = document.getElementById('teamPickerModal');
  if (!modal) return;

  // Get all available teams
  const allTeams = [...window.ALL_TEAMS];

  if (window.HISTORIC_TEAMS) {
    Object.values(window.HISTORIC_TEAMS.worldCup).forEach(team => {
      allTeams.push({
        name: team.name,
        strength: team.strength,
        country: team.country || 'Historic',
        isHistoric: true
      });
    });
    Object.values(window.HISTORIC_TEAMS.championsLeague).forEach(team => {
      allTeams.push({
        name: team.name,
        strength: team.strength,
        country: team.country || 'Historic',
        isHistoric: true
      });
    });
  }

  let filteredTeams = allTeams;

  // Apply filter type
  if (filterType === 'strong') {
    filteredTeams = allTeams.filter(t => t.strength >= 85);
  } else if (filterType === 'historic') {
    filteredTeams = allTeams.filter(t => t.isHistoric);
  } else if (filterType === 'search' && searchTerm) {
    const search = searchTerm.toLowerCase();
    filteredTeams = allTeams.filter(t =>
      t.name.toLowerCase().includes(search) ||
      (t.country && t.country.toLowerCase().includes(search))
    );
  }

  loadTeamPickerList(filteredTeams);
}

function selectTeamFromPicker(teamData) {
  const modal = document.getElementById('teamPickerModal');
  if (!modal) return;

  const selectingTeam = modal.dataset.selectingTeam;

  // Update CUSTOM_MATCH_STATE
  if (selectingTeam === 'A') {
    window.CUSTOM_MATCH_STATE.teamA = teamData;
  } else {
    window.CUSTOM_MATCH_STATE.teamB = teamData;
  }

  // Close modal
  modal.remove();

  // Refresh the main UI
  showEnhancedCustomMatch();

  // Show notification
  showNotification('success', 'Team Selected!',
    `${teamData.name} selected for Team ${selectingTeam}`, 2000);
}

// ======================
// SIMULATION FUNCTIONS
// ======================

function simulateCustomMatchEnhanced() {
  const state = window.CUSTOM_MATCH_STATE;

  // Validation
  if (!state.teamA || !state.teamB) {
    showNotification('error', 'Cannot Simulate',
      'Please select both teams first!', 3000);
    return;
  }

  if (state.teamA.name === state.teamB.name) {
    showNotification('error', 'Invalid Match',
      'Teams must be different!', 3000);
    return;
  }

  // Show prediction prompt if enabled
  if (state.settings.enablePredictions && window.PREDICTION_STATE && window.PREDICTION_STATE.active) {
    const matchId = `custom_${Date.now()}`;
    if (window.promptPrediction) {
      window.promptPrediction(matchId, state.teamA.name, state.teamB.name, 'Custom Match');
    }
  }

  // Apply venue advantage
  let teamAStrength = state.teamA.strength;
  let teamBStrength = state.teamB.strength;

  if (state.settings.venue === 'teamA') {
    teamAStrength += 3;
    teamBStrength -= 2;
  } else if (state.settings.venue === 'teamB') {
    teamBStrength += 3;
    teamAStrength -= 2;
  }

  // Apply weather effects
  if (state.settings.weather === 'rainy') {
    teamAStrength -= 2;
    teamBStrength -= 2;
  } else if (state.settings.weather === 'snowy') {
    teamAStrength -= 3;
    teamBStrength -= 3;
  }

  // Simulate match using existing simulateMatch function
  const teamAObj = { ...state.teamA, strength: teamAStrength };
  const teamBObj = { ...state.teamB, strength: teamBStrength };

  // If live simulation is enabled, use that
  if (state.settings.enableLiveSim && window.showLiveSimulation) {
    window.showLiveSimulation(teamAObj, teamBObj, 'Custom Match', () => {
      showNotification('success', 'Match Complete!', '', 2000);
    });
  } else {
    // Standard simulation
    const result = window.simulateMatch(teamAObj, teamBObj, 'Custom Match');
    displayCustomMatchResult(result, state.teamA, state.teamB);
  }
}

// displayCustomMatchResult is defined earlier in the file with full functionality (line 27381)
// This duplicate has been removed to avoid conflicts

function displayCustomMatchResult_EnhancedVersion(result, teamA, teamB) {
  const content = document.getElementById('content') || document.getElementById('output') || document.getElementById('output');
  if (!content) return;

  // Trigger confetti for exciting results
  const goalDiff = Math.abs(result.scoreA - result.scoreB);
  if (goalDiff >= 3 && window.CONFETTI_MANAGER) {
    window.CONFETTI_MANAGER.celebrate('goal');
  } else if (result.scoreA === result.scoreB && window.CONFETTI_MANAGER) {
    window.CONFETTI_MANAGER.celebrate('draw');
  }

  const winner = result.scoreA > result.scoreB ? teamA :
                 result.scoreB > result.scoreA ? teamB : null;

  content.innerHTML = `
    <div style="max-width: 900px; margin: 0 auto; padding: 20px;">
      <!-- Header -->
      <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                  padding: 30px; border-radius: 15px; text-align: center; margin-bottom: 30px;
                  box-shadow: 0 10px 40px rgba(102,126,234,0.3);">
        <h1 style="margin: 0 0 10px 0; color: white; font-size: 2.5em;">
          🏆 Match Result
        </h1>
        <p style="margin: 0; color: rgba(255,255,255,0.9);">
          Custom Match - ${new Date().toLocaleDateString()}
        </p>
      </div>

      <!-- Score Display -->
      <div style="background: white; padding: 40px; border-radius: 15px; margin-bottom: 30px;
                  box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center;">
        <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 30px; align-items: center;">

          <!-- Team A -->
          <div>
            <h2 style="margin: 0 0 15px 0; color: #f5576c; font-size: 2em;">
              ${teamA.name}
            </h2>
            <div style="font-size: 4em; font-weight: bold; color: ${result.scoreA > result.scoreB ? '#667eea' : '#999'};">
              ${result.scoreA}
            </div>
          </div>

          <!-- VS -->
          <div style="font-size: 2em; color: #ccc; font-weight: bold;">-</div>

          <!-- Team B -->
          <div>
            <h2 style="margin: 0 0 15px 0; color: #4facfe; font-size: 2em;">
              ${teamB.name}
            </h2>
            <div style="font-size: 4em; font-weight: bold; color: ${result.scoreB > result.scoreA ? '#667eea' : '#999'};">
              ${result.scoreB}
            </div>
          </div>
        </div>

        ${winner ? `
          <div style="margin-top: 30px; padding: 20px; background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);
                      border-radius: 10px;">
            <h3 style="margin: 0; color: white; font-size: 1.5em; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">
              🏆 Winner: ${winner.name}
            </h3>
          </div>
        ` : `
          <div style="margin-top: 30px; padding: 20px; background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);
                      border-radius: 10px;">
            <h3 style="margin: 0; color: white; font-size: 1.5em;">
              🤝 Match Ended in a Draw
            </h3>
          </div>
        `}
      </div>

      <!-- Match Events -->
      ${result.events && result.events.length > 0 ? `
        <div style="background: white; padding: 25px; border-radius: 15px; margin-bottom: 25px;
                    box-shadow: 0 5px 20px rgba(0,0,0,0.1);">
          <h3 style="margin-top: 0; color: #667eea; border-bottom: 2px solid #667eea; padding-bottom: 10px;">
            ⚽ Match Events
          </h3>
          <div style="max-height: 300px; overflow-y: auto;">
            ${result.events.map(event => `
              <div style="padding: 10px; margin: 8px 0; background: #f8f9fa; border-radius: 8px;
                          border-left: 4px solid ${event.type === 'goal' ? '#28a745' : event.type === 'card' ? '#ffc107' : '#6c757d'};">
                <strong style="color: #667eea;">${event.minute}'</strong> - ${event.description}
              </div>
            `).join('')}
          </div>
        </div>
      ` : ''}

      <!-- Action Buttons -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
        <button onclick="showEnhancedCustomMatch()"
                style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                       color: white; border: none; padding: 15px 25px; border-radius: 10px;
                       font-size: 1.1em; font-weight: bold; cursor: pointer;
                       box-shadow: 0 5px 15px rgba(102,126,234,0.4);">
          🔄 New Match
        </button>

        <button onclick="simulateCustomMatchEnhanced()"
                style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
                       color: white; border: none; padding: 15px 25px; border-radius: 10px;
                       font-size: 1.1em; font-weight: bold; cursor: pointer;
                       box-shadow: 0 5px 15px rgba(245,87,108,0.4);">
          ⚡ Rematch
        </button>

        <button onclick="showMainMenu()"
                style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
                       color: #333; border: none; padding: 15px 25px; border-radius: 10px;
                       font-size: 1.1em; font-weight: bold; cursor: pointer;
                       box-shadow: 0 5px 15px rgba(252,182,159,0.4);">
          🏠 Main Menu
        </button>
      </div>
    </div>
  `;
}

// Export enhanced global functions
window.FEATURE_GUIDES = FEATURE_GUIDES;
window.inductTournamentPerformers = inductTournamentPerformers;
window.TEMPLATE_TEAMS = TEMPLATE_TEAMS;
window.CONFETTI_MANAGER = CONFETTI_MANAGER;

console.log('🚀 ALL NEW FEATURES LOADED SUCCESSFULLY!');
if (window.VERBOSE_LOGGING) console.log('   ✓ Live Match Simulation');
console.log('   ✓ Export & Share System');
if (window.VERBOSE_LOGGING) console.log('   ✓ Undo/Redo System');
console.log('   ✓ Sound Effects');
if (window.VERBOSE_LOGGING) console.log('   ✓ Quick Start Templates (with 64 teams)');
console.log('   ✓ Enhanced Prediction System');
if (window.VERBOSE_LOGGING) console.log('   ✓ Hall of Fame Auto-Induction');
console.log('   ✓ Feature Guides');
if (window.VERBOSE_LOGGING) console.log('   ✓ Print Support');
console.log('');
if (window.VERBOSE_LOGGING) console.log('🔧 CRITICAL FIXES APPLIED:');
console.log('   ✅ Function wrapping race condition fixed');
console.log('   ✅ Confetti memory management added');
console.log('   ✅ localStorage quota handling improved');
console.log('   ✅ Chart.js safety wrapper added');
console.log('   ✅ showOutput error fixed');

// ========================================
// PART 10: OPTIMIZATION & FINAL DEBUG
// ========================================

// ========================================
// VALIDATION & ERROR CHECKING SYSTEM
// ========================================

const VALIDATORS = {
  // Team validation
  isValidTeam(team) {
    if (!team) return { valid: false, error: 'Team is null or undefined' };
    if (!team.name) return { valid: false, error: 'Team has no name' };
    if (typeof team.strength !== 'number') return { valid: false, error: 'Team strength is not a number' };
    if (team.strength < 0 || team.strength > 100) return { valid: false, error: 'Team strength out of range (0-100)' };
    return { valid: true };
  },

  // Match validation
  isValidMatch(match) {
    if (!match) return { valid: false, error: 'Match is null or undefined' };

    const teamACheck = this.isValidTeam(match.teamA);
    if (!teamACheck.valid) return { valid: false, error: `Team A invalid: ${teamACheck.error}` };

    const teamBCheck = this.isValidTeam(match.teamB);
    if (!teamBCheck.valid) return { valid: false, error: `Team B invalid: ${teamBCheck.error}` };

    if (match.teamA.name === match.teamB.name) {
      return { valid: false, error: 'Team cannot play against itself' };
    }

    return { valid: true };
  },

  // Score validation
  isValidScore(score) {
    if (typeof score !== 'number') return { valid: false, error: 'Score is not a number' };
    if (score < 0) return { valid: false, error: 'Score cannot be negative' };
    if (score > 20) return { valid: false, error: 'Score unrealistically high (>20)' };
    if (!Number.isInteger(score)) return { valid: false, error: 'Score must be an integer' };
    return { valid: true };
  },

  // Tournament state validation
  isValidTournamentState() {
    const errors = [];

    // Check if groups exist when needed
    if (typeof TOURNAMENT_UI_STATE !== 'undefined' &&
        TOURNAMENT_UI_STATE.currentStage === 'groups' &&
        (!window.GROUPS || window.GROUPS.length === 0)) {
      errors.push('Groups stage active but no groups defined');
    }

    // Check knockout matches
    if (typeof TOURNAMENT_UI_STATE !== 'undefined' &&
        TOURNAMENT_UI_STATE.currentStage !== 'groups' &&
        TOURNAMENT_UI_STATE.currentStage !== null) {
      if (typeof KNOCKOUT_STATE !== 'undefined' &&
          (!KNOCKOUT_STATE.currentMatches || KNOCKOUT_STATE.currentMatches.length === 0)) {
        errors.push('Knockout stage active but no matches defined');
      }
    }

    return {
      valid: errors.length === 0,
      errors: errors
    };
  },

  // Manager state validation
  isValidManagerState() {
    const errors = [];

    if (typeof MANAGER_STATE !== 'undefined' && MANAGER_STATE.active) {
      if (!MANAGER_STATE.managerName) errors.push('Manager has no name');
      if (MANAGER_STATE.level < 1) errors.push('Manager level below 1');
      if (MANAGER_STATE.xp < 0) errors.push('Manager XP is negative');
      if (MANAGER_STATE.xp > MANAGER_STATE.xpToNextLevel) {
        errors.push('Manager XP exceeds next level requirement');
      }
    }

    return {
      valid: errors.length === 0,
      errors: errors
    };
  }
};

// Global error handler
window.addEventListener('error', function(event) {
  console.error('🔴 Global Error:', event.error);
  console.error('Stack:', event.error?.stack);

  if (typeof showNotification === 'function') {
    showNotification('error', 'An Error Occurred',
      'Something went wrong. Check console for details.', 4000);
  }
});

// Unhandled promise rejection handler
window.addEventListener('unhandledrejection', function(event) {
  console.error('🔴 Unhandled Promise Rejection:', event.reason);

  if (typeof showNotification === 'function') {
    showNotification('error', 'Promise Error',
      'An async operation failed. Check console.', 4000);
  }
});

// ========================================
// PERFORMANCE MONITORING
// ========================================

const PERFORMANCE_MONITOR = {
  enabled: true,
  metrics: {
    matchSimulations: [],
    renderTimes: [],
    apiCalls: []
  },

  // Start timing an operation
  startTimer(operationName) {
    if (!this.enabled) return null;
    return {
      name: operationName,
      start: performance.now()
    };
  },

  // End timing and record
  endTimer(timer) {
    if (!this.enabled || !timer) return;

    const duration = performance.now() - timer.start;

    if (window.VERBOSE_LOGGING) console.log(`⏱️ ${timer.name}: ${duration.toFixed(2)}ms`);

    // Record for analysis
    if (timer.name.includes('match')) {
      this.metrics.matchSimulations.push(duration);
    } else if (timer.name.includes('render')) {
      this.metrics.renderTimes.push(duration);
    }

    // Warn if operation took too long
    if (duration > 1000) {
      console.warn(`⚠️ Slow operation: ${timer.name} took ${duration.toFixed(2)}ms`);
    }
  },

  // Get average performance
  getAverages() {
    return {
      matchSimulation: this.average(this.metrics.matchSimulations),
      rendering: this.average(this.metrics.renderTimes)
    };
  },

  average(arr) {
    if (arr.length === 0) return 0;
    return (arr.reduce((a, b) => a + b, 0) / arr.length).toFixed(2);
  },

  // Clear metrics
  clear() {
    this.metrics.matchSimulations = [];
    this.metrics.renderTimes = [];
    this.metrics.apiCalls = [];
  },

  // Generate performance report
  generateReport() {
    const averages = this.getAverages();
    return `
      📊 Performance Report:
      - Match Simulation Avg: ${averages.matchSimulation}ms
      - Rendering Avg: ${averages.rendering}ms
      - Total Match Simulations: ${this.metrics.matchSimulations.length}
      - Total Renders: ${this.metrics.renderTimes.length}
    `;
  }
};

// ========================================
// MEMORY MANAGEMENT
// ========================================

const MEMORY_MANAGER = {
  // Track large data structures
  trackedObjects: new WeakMap(),

  // Clean up old match data
  cleanupOldMatches() {
    // Keep only last 100 matches in detail
    if (window.MATCH_DETAILS_DB && Object.keys(window.MATCH_DETAILS_DB).length > 100) {
      const entries = Object.entries(window.MATCH_DETAILS_DB);
      const toKeep = entries.slice(-100);
      window.MATCH_DETAILS_DB = Object.fromEntries(toKeep);
      if (window.VERBOSE_LOGGING) console.log('✓ Cleaned up old match data');
    }
  },

  // Clean up old tournament history
  cleanupOldHistory() {
    // Keep only last 50 tournaments
    if (typeof TOURNAMENT_HISTORY_ENHANCED !== 'undefined' &&
        TOURNAMENT_HISTORY_ENHANCED.completed &&
        TOURNAMENT_HISTORY_ENHANCED.completed.length > 50) {
      TOURNAMENT_HISTORY_ENHANCED.completed = TOURNAMENT_HISTORY_ENHANCED.completed.slice(-50);
      if (window.VERBOSE_LOGGING) console.log('✓ Cleaned up old tournament history');
    }
  },

  // Clean up prediction history
  cleanupPredictions() {
    // Keep only last 200 predictions
    if (typeof PREDICTION_STATE !== 'undefined' &&
        PREDICTION_STATE.predictionHistory &&
        PREDICTION_STATE.predictionHistory.length > 200) {
      PREDICTION_STATE.predictionHistory = PREDICTION_STATE.predictionHistory.slice(-200);
      if (window.VERBOSE_LOGGING) console.log('✓ Cleaned up old predictions');
    }
  },

  // Run all cleanup
  cleanupAll() {
    if (window.VERBOSE_LOGGING) console.log('🧹 Running memory cleanup...');
    this.cleanupOldMatches();
    this.cleanupOldHistory();
    this.cleanupPredictions();

    // Clear performance metrics
    PERFORMANCE_MONITOR.clear();

    if (window.VERBOSE_LOGGING) console.log('✓ Memory cleanup complete');
  },

  // Auto cleanup every 5 minutes
  startAutoCleanup() {
    setInterval(() => {
      this.cleanupAll();
    }, 5 * 60 * 1000);
    if (window.VERBOSE_LOGGING) console.log('✓ Auto cleanup scheduled (every 5 minutes)');
  }
};

// ========================================
// BUG FIXES & PATCHES
// ========================================

const BUG_FIXES = {
  // Fix: simulateMatch null reference
  patchSimulateMatch() {
    const originalSimulate = window.simulateMatchWithSeed;
    if (typeof originalSimulate === 'function') {
      window.simulateMatchWithSeed = function(teamA, teamB, ...args) {
        try {
          if (!teamA || !teamB) {
            console.error('simulateMatchWithSeed called with null team');
            return { scoreA: 0, scoreB: 0, error: 'Invalid teams' };
          }
          return originalSimulate.call(this, teamA, teamB, ...args);
        } catch (error) {
          console.error('Error in simulateMatchWithSeed:', error);
          return { scoreA: 0, scoreB: 0, error: error.message };
        }
      };
      if (window.VERBOSE_LOGGING) console.log('✓ Patched simulateMatchWithSeed');
    }
  },

  // Fix: Division by zero in stats
  patchStatsCalculation() {
    // Safe average calculation
    window.safeAverage = function(total, count) {
      if (!count || count === 0) return 0;
      return (total / count).toFixed(2);
    };
    if (window.VERBOSE_LOGGING) console.log('✓ Added safeAverage helper');
  },

  // Fix: Event handler memory leaks
  patchEventHandlers() {
    // Store handlers for cleanup
    window._eventHandlers = window._eventHandlers || [];

    // Override addEventListener to track
    const originalAddEventListener = EventTarget.prototype.addEventListener;
    EventTarget.prototype.addEventListener = function(type, listener, options) {
      window._eventHandlers.push({ element: this, type, listener, options });
      return originalAddEventListener.call(this, type, listener, options);
    };
    if (window.VERBOSE_LOGGING) console.log('✓ Event handler tracking enabled');
  },

  // Fix: localStorage quota exceeded
  patchLocalStorage() {
    const originalSetItem = localStorage.setItem;
    localStorage.setItem = function(key, value) {
      try {
        originalSetItem.call(this, key, value);
      } catch (e) {
        if (e.name === 'QuotaExceededError') {
          console.warn('⚠️ localStorage quota exceeded, clearing old data...');
          // Clear some old data
          const keys = Object.keys(localStorage);
          if (keys.length > 0) {
            localStorage.removeItem(keys[0]);
            // Try again
            try {
              originalSetItem.call(this, key, value);
            } catch (e2) {
              console.error('Failed to save even after cleanup:', e2);
              if (typeof showNotification === 'function') {
                showNotification('error', 'Storage Full',
                  'Unable to save data. Please clear browser storage.', 5000);
              }
            }
          }
        } else {
          throw e;
        }
      }
    };
    if (window.VERBOSE_LOGGING) console.log('✓ localStorage quota handling patched');
  },

  // Apply all patches
  applyAll() {
    if (window.VERBOSE_LOGGING) console.log('🔧 Applying bug fixes...');
    this.patchSimulateMatch();
    this.patchStatsCalculation();
    this.patchEventHandlers();
    this.patchLocalStorage();
    if (window.VERBOSE_LOGGING) console.log('✓ All bug fixes applied');
  }
};

// ========================================
// DEBUG & DIAGNOSTIC TOOLS
// ========================================

const DEBUG_TOOLS = {
  enabled: false,
  debugInterval: null,

  // Enable debug mode
  enable() {
    this.enabled = true;
    if (window.VERBOSE_LOGGING) console.log('🐛 Debug mode enabled');
    this.addDebugPanel();
  },

  // Disable debug mode
  disable() {
    this.enabled = false;
    if (window.VERBOSE_LOGGING) console.log('Debug mode disabled');
    const panel = document.getElementById('debugPanel');
    if (panel) panel.remove();
    if (this.debugInterval) {
      clearInterval(this.debugInterval);
      this.debugInterval = null;
    }
  },

  // Add debug panel to UI
  addDebugPanel() {
    const panel = document.createElement('div');
    panel.id = 'debugPanel';
    panel.style.cssText = `
      position: fixed;
      bottom: 10px;
      left: 10px;
      background: rgba(17, 24, 39, 0.95);
      border: 2px solid #10B981;
      border-radius: 8px;
      padding: 15px;
      z-index: 10010;
      max-width: 350px;
      font-family: monospace;
      font-size: 0.85em;
      color: #10B981;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
    `;

    panel.innerHTML = `
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <strong style="font-size: 1.1em;">🐛 Debug Panel</strong>
        <button onclick="DEBUG_TOOLS.disable()"
                style="background: #EF4444; color: #FFF; border: none; padding: 4px 8px;
                       border-radius: 4px; cursor: pointer; font-size: 0.9em;">✕</button>
      </div>
      <div id="debugContent" style="font-size: 0.9em; line-height: 1.6;"></div>
      <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(16, 185, 129, 0.3);">
        <button onclick="DEBUG_TOOLS.runFullCheck()"
                style="width: 100%; padding: 8px; background: #10B981; color: #000;
                       border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">
          Run Full Check
        </button>
      </div>
    `;

    document.body.appendChild(panel);
    this.updateDebugInfo();

    // Update every 2 seconds
    this.debugInterval = setInterval(() => {
      this.updateDebugInfo();
    }, 2000);
  },

  // Update debug information
  updateDebugInfo() {
    const content = document.getElementById('debugContent');
    if (!content) return;

    const info = [
      `Stage: ${(typeof TOURNAMENT_UI_STATE !== 'undefined' ? TOURNAMENT_UI_STATE.currentStage : null) || 'None'}`,
      `Manager: ${(typeof MANAGER_STATE !== 'undefined' && MANAGER_STATE.active) ? `Lvl ${MANAGER_STATE.level}` : 'Inactive'}`,
      `Matches: ${(typeof ACHIEVEMENT_PROGRESS !== 'undefined' ? ACHIEVEMENT_PROGRESS.totalMatches : 0) || 0}`,
      `Tournaments: ${(typeof TOURNAMENT_HISTORY_ENHANCED !== 'undefined' ? TOURNAMENT_HISTORY_ENHANCED.totalTournamentsPlayed : 0) || 0}`,
      `Memory: ${this.getMemoryUsage()}`,
      `Performance: ${PERFORMANCE_MONITOR.average(PERFORMANCE_MONITOR.metrics.matchSimulations)}ms`,
      `Predictions: ${(typeof PREDICTION_STATE !== 'undefined' ? PREDICTION_STATE.totalPredictions : 0) || 0}`
    ];

    content.innerHTML = info.map(line => `<div>${line}</div>`).join('');
  },

  // Get memory usage estimate
  getMemoryUsage() {
    if (performance.memory) {
      const used = (performance.memory.usedJSHeapSize / 1048576).toFixed(2);
      const total = (performance.memory.totalJSHeapSize / 1048576).toFixed(2);
      return `${used}MB / ${total}MB`;
    }
    return 'N/A';
  },

  // Run comprehensive check
  runFullCheck() {
    if (window.VERBOSE_LOGGING) console.log('🔍 Running full diagnostic check...');

    const results = {
      validators: {},
      state: {},
      performance: {},
      errors: []
    };

    // Check validators
    results.validators.tournamentState = VALIDATORS.isValidTournamentState();
    results.validators.managerState = VALIDATORS.isValidManagerState();

    // Check state consistency
    results.state.hasActiveManager = typeof MANAGER_STATE !== 'undefined' && MANAGER_STATE.active;
    results.state.hasActiveTournament = typeof TOURNAMENT_UI_STATE !== 'undefined' && TOURNAMENT_UI_STATE.currentStage !== null;
    results.state.groupStageSimulated = typeof GROUP_STAGE_SIMULATED !== 'undefined' && GROUP_STAGE_SIMULATED;

    // Check performance
    results.performance = PERFORMANCE_MONITOR.getAverages();

    // Check for errors
    if (!results.validators.tournamentState.valid) {
      results.errors.push(...results.validators.tournamentState.errors);
    }
    if (!results.validators.managerState.valid) {
      results.errors.push(...results.validators.managerState.errors);
    }

    // Display results
    if (window.VERBOSE_LOGGING) console.log('✓ Check complete:', results);

    if (results.errors.length === 0) {
      if (typeof showNotification === 'function') {
        showNotification('success', 'All Systems OK',
          'No errors detected', 3000);
      }
    } else {
      if (typeof showNotification === 'function') {
        showNotification('warning', 'Issues Found',
          `${results.errors.length} issues detected. Check console.`, 4000);
      }
      console.warn('Issues found:', results.errors);
    }

    return results;
  },

  // Export state for debugging
  exportState() {
    const state = {
      manager: typeof MANAGER_STATE !== 'undefined' ? MANAGER_STATE : null,
      tournament: typeof TOURNAMENT_UI_STATE !== 'undefined' ? TOURNAMENT_UI_STATE : null,
      history: typeof TOURNAMENT_HISTORY_ENHANCED !== 'undefined' ? TOURNAMENT_HISTORY_ENHANCED : null,
      predictions: typeof PREDICTION_STATE !== 'undefined' ? PREDICTION_STATE : null,
      achievements: typeof ACHIEVEMENT_PROGRESS !== 'undefined' ? ACHIEVEMENT_PROGRESS : null,
      knockout: typeof KNOCKOUT_STATE !== 'undefined' ? KNOCKOUT_STATE : null,
      timestamp: Date.now()
    };

    const json = JSON.stringify(state, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `app-state-${Date.now()}.json`;
    a.click();

    if (window.VERBOSE_LOGGING) console.log('✓ State exported');
  }
};

// ========================================
// SYSTEM HEALTH MONITOR
// ========================================

const HEALTH_MONITOR = {
  checks: [],
  lastCheck: null,

  // Register a health check
  registerCheck(name, checkFunction) {
    this.checks.push({ name, check: checkFunction });
  },

  // Run all health checks
  async runAllChecks() {
    if (window.VERBOSE_LOGGING) console.log('🏥 Running system health checks...');
    const results = [];

    for (const { name, check } of this.checks) {
      try {
        const result = await check();
        results.push({
          name,
          passed: result.passed,
          message: result.message || 'OK'
        });
      } catch (error) {
        results.push({
          name,
          passed: false,
          message: error.message
        });
      }
    }

    this.lastCheck = {
      timestamp: Date.now(),
      results
    };

    const passed = results.filter(r => r.passed).length;
    const total = results.length;

    if (window.VERBOSE_LOGGING) console.log(`✓ Health check complete: ${passed}/${total} checks passed`);

    if (passed < total) {
      console.warn('⚠️ Some health checks failed:',
        results.filter(r => !r.passed));
    }

    return this.lastCheck;
  },

  // Get health status
  getStatus() {
    if (!this.lastCheck) return 'unknown';

    const total = this.lastCheck.results.length;
    const passed = this.lastCheck.results.filter(r => r.passed).length;
    const percentage = (passed / total) * 100;

    if (percentage === 100) return 'healthy';
    if (percentage >= 80) return 'warning';
    return 'critical';
  }
};

// Register default health checks
HEALTH_MONITOR.registerCheck('Manager State', () => {
  const result = VALIDATORS.isValidManagerState();
  return {
    passed: result.valid,
    message: result.errors.join(', ') || 'Manager state is valid'
  };
});

HEALTH_MONITOR.registerCheck('Tournament State', () => {
  const result = VALIDATORS.isValidTournamentState();
  return {
    passed: result.valid,
    message: result.errors.join(', ') || 'Tournament state is valid'
  };
});

HEALTH_MONITOR.registerCheck('Storage', () => {
  try {
    localStorage.setItem('_healthcheck', '1');
    localStorage.removeItem('_healthcheck');
    return { passed: true, message: 'Storage accessible' };
  } catch (e) {
    return { passed: false, message: 'Storage not accessible: ' + e.message };
  }
});

HEALTH_MONITOR.registerCheck('Performance', () => {
  const avg = parseFloat(PERFORMANCE_MONITOR.getAverages().matchSimulation);
  return {
    passed: avg < 500 || isNaN(avg),
    message: `Average match simulation: ${avg}ms`
  };
});

// ========================================
// APPLICATION INITIALIZATION
// ========================================

const APP_INIT = {
  initialized: false,

  async initialize() {
    if (this.initialized) {
      if (window.VERBOSE_LOGGING) console.log('ℹ️ App already initialized');
      return;
    }

    if (window.VERBOSE_LOGGING) console.log('🚀 Initializing optimization systems...');

    try {
      // Step 1: Apply bug fixes
      BUG_FIXES.applyAll();

      // Step 2: Start background tasks
      MEMORY_MANAGER.startAutoCleanup();

      // Step 3: Run health check
      await HEALTH_MONITOR.runAllChecks();

      this.initialized = true;
      console.log('✓ Optimization systems initialized successfully');

    } catch (error) {
      console.error('❌ Initialization failed:', error);
      if (typeof showNotification === 'function') {
        showNotification('error', 'Initialization Error',
          'Failed to initialize optimization. Check console.', 5000);
      }
    }
  }
};

// ========================================
// FINAL VERIFICATION CHECKLIST
// ========================================

const FINAL_CHECKLIST = {
  items: [
    {
      id: 'seasons',
      name: 'Season Mode',
      check: () => typeof SEASON_STATE !== 'undefined' &&
                   typeof displaySeasonMode === 'function'
    },
    {
      id: 'predictions',
      name: 'Prediction System',
      check: () => typeof PREDICTION_STATE !== 'undefined' &&
                   typeof promptPrediction === 'function'
    },
    {
      id: 'templates',
      name: 'Quick Start Templates',
      check: () => typeof HISTORIC_TEAMS !== 'undefined' &&
                   typeof TOURNAMENT_TEMPLATES !== 'undefined'
    },
    {
      id: 'customMatch',
      name: 'Custom Match Enhanced',
      check: () => typeof showEnhancedCustomMatch === 'function'
    },
    {
      id: 'achievements',
      name: 'Achievements & XP',
      check: () => typeof ACHIEVEMENTS_CONFIG !== 'undefined' &&
                   typeof awardManagerXP === 'function'
    },
    {
      id: 'history',
      name: 'Tournament History',
      check: () => typeof TOURNAMENT_HISTORY_ENHANCED !== 'undefined' &&
                   typeof displayTournamentHistory === 'function'
    },
    {
      id: 'stageSync',
      name: 'Stage UI Sync',
      check: () => typeof TOURNAMENT_UI_STATE !== 'undefined' &&
                   typeof updateTournamentStage === 'function'
    },
    {
      id: 'knockout',
      name: 'Knockout Improvements',
      check: () => typeof KNOCKOUT_STATE !== 'undefined' &&
                   typeof simulateLeg1 === 'function'
    },
    {
      id: 'customization',
      name: 'Manager Customization',
      check: () => typeof CUSTOMIZATION_CATALOG !== 'undefined' &&
                   typeof showManagerCustomization === 'function'
    },
    {
      id: 'optimization',
      name: 'Optimization & Debug',
      check: () => typeof VALIDATORS !== 'undefined' &&
                   typeof PERFORMANCE_MONITOR !== 'undefined'
    }
  ],

  runFullCheck() {
    if (window.VERBOSE_LOGGING) console.log('📋 Running final verification checklist...');
    console.log('='.repeat(50));

    const results = this.items.map(item => {
      const passed = item.check();
      const status = passed ? '✅' : '❌';
      if (window.VERBOSE_LOGGING) console.log(`${status} ${item.name}`);
      return { ...item, passed };
    });

    if (window.VERBOSE_LOGGING) console.log('='.repeat(50));

    const passedCount = results.filter(r => r.passed).length;
    const totalCount = results.length;
    const percentage = ((passedCount / totalCount) * 100).toFixed(1);

    if (window.VERBOSE_LOGGING) console.log(`\n📊 Final Score: ${passedCount}/${totalCount} (${percentage}%)`);

    if (passedCount === totalCount) {
      console.log('🎉 ALL FEATURES VERIFIED AND FUNCTIONAL!');
      if (window.VERBOSE_LOGGING) console.log('✨ App is ready for use!');
    } else {
      console.warn('⚠️ Some features are missing or not working properly');
      console.warn('Failed checks:', results.filter(r => !r.passed).map(r => r.name));
    }

    return {
      passed: passedCount,
      total: totalCount,
      percentage,
      allPassed: passedCount === totalCount,
      results
    };
  },

  displayReport() {
    const checkResult = this.runFullCheck();

    const modal = document.createElement('div');
    modal.className = 'modal-backdrop active';
    modal.style.zIndex = '10005';
    modal.innerHTML = `
      <div class="modal-content" style="max-width: 700px;">
        <div class="modal-head" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.2));
                                       border-bottom: 2px solid rgba(16, 185, 129, 0.4);">
          <h2 style="color: #10B981;">📋 System Verification Report</h2>
          <button class="modal-close" onclick="this.closest('.modal-backdrop').remove()">✕</button>
        </div>

        <div style="padding: 30px;">
          <!-- Overall Score -->
          <div style="text-align: center; margin-bottom: 30px; padding: 25px;
                      background: ${checkResult.allPassed ? 'rgba(16, 185, 129, 0.2)' : 'rgba(251, 191, 36, 0.2)'};
                      border: 2px solid ${checkResult.allPassed ? '#10B981' : '#FBBF24'};
                      border-radius: 12px;">
            <div style="font-size: 3em; margin-bottom: 15px;">
              ${checkResult.allPassed ? '🎉' : '⚠️'}
            </div>
            <div style="font-size: 2.5em; font-weight: 900;
                        color: ${checkResult.allPassed ? '#10B981' : '#FBBF24'};
                        margin-bottom: 10px;">
              ${checkResult.percentage}%
            </div>
            <div style="color: #94A3B8; font-size: 1.1em;">
              ${checkResult.passed} / ${checkResult.total} features verified
            </div>
          </div>

          <!-- Feature List -->
          <div style="display: grid; gap: 10px; margin-bottom: 25px;">
            ${checkResult.results.map(item => `
              <div style="display: flex; align-items: center; padding: 12px;
                          background: rgba(15, 23, 42, 0.6); border-radius: 8px;
                          border-left: 3px solid ${item.passed ? '#10B981' : '#EF4444'};">
                <span style="font-size: 1.5em; margin-right: 12px;">
                  ${item.passed ? '✅' : '❌'}
                </span>
                <span style="color: ${item.passed ? '#10B981' : '#EF4444'}; font-weight: 600;">
                  ${item.name}
                </span>
              </div>
            `).join('')}
          </div>

          ${checkResult.allPassed ? `
            <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3);
                        border-radius: 10px; padding: 20px; text-align: center; margin-bottom: 20px;">
              <div style="color: #10B981; font-weight: 700; font-size: 1.2em; margin-bottom: 10px;">
                ✨ All Systems Operational!
              </div>
              <div style="color: #94A3B8; font-size: 0.95em;">
                The app is fully optimized and ready for use
              </div>
            </div>
          ` : `
            <div style="background: rgba(251, 191, 36, 0.1); border: 1px solid rgba(251, 191, 36, 0.3);
                        border-radius: 10px; padding: 20px; margin-bottom: 20px;">
              <div style="color: #FBBF24; font-weight: 700; font-size: 1.1em; margin-bottom: 10px;">
                ⚠️ Some Features Need Attention
              </div>
              <div style="color: #94A3B8; font-size: 0.9em;">
                Check the console for details on failed checks
              </div>
            </div>
          `}

          <button onclick="this.closest('.modal-backdrop').remove()"
                  class="btn-primary" style="width: 100%; padding: 14px; font-weight: 600;">
            Close Report
          </button>
        </div>
      </div>
    `;

    document.body.appendChild(modal);
  }
};

// ========================================
// CONSOLE COMMANDS HELP
// ========================================

window.help = function() {
  if (window.VERBOSE_LOGGING) console.log(`
╔══════════════════════════════════════════════════════════╗
║          TOURNAMENT SIMULATOR - CONSOLE COMMANDS         ║
╚══════════════════════════════════════════════════════════╝

🐛 DEBUG COMMANDS:
  debug.enable()     - Enable debug panel
  debug.disable()    - Disable debug panel
  debug.check()      - Run full diagnostic check
  debug.export()     - Export current app state
  debug.perf()       - Show performance report
  debug.clear()      - Clear old data (memory cleanup)

✅ VERIFICATION:
  verify()           - Run full verification checklist
  FINAL_CHECKLIST.runFullCheck() - Console verification

📊 MONITORING:
  HEALTH_MONITOR.runAllChecks() - Run health checks
  PERFORMANCE_MONITOR.generateReport() - Performance stats

🧹 MAINTENANCE:
  MEMORY_MANAGER.cleanupAll() - Manual memory cleanup
  BUG_FIXES.applyAll() - Re-apply all bug fixes

💾 DATA MANAGEMENT:
  localStorage.clear() - Clear all saved data

═══════════════════════════════════════════════════════════

Type any command to execute. Example: debug.enable()
  `);
};

// Global debug commands
window.debug = {
  enable: () => DEBUG_TOOLS.enable(),
  disable: () => DEBUG_TOOLS.disable(),
  check: () => DEBUG_TOOLS.runFullCheck(),
  export: () => DEBUG_TOOLS.exportState(),
  perf: () => { if (window.VERBOSE_LOGGING) console.log(PERFORMANCE_MONITOR.generateReport()); },
  clear: () => MEMORY_MANAGER.cleanupAll()
};

// Add global command for verification
window.verify = () => FINAL_CHECKLIST.displayReport();

// Export global objects
window.VALIDATORS = VALIDATORS;
window.PERFORMANCE_MONITOR = PERFORMANCE_MONITOR;
window.MEMORY_MANAGER = MEMORY_MANAGER;
window.BUG_FIXES = BUG_FIXES;
window.DEBUG_TOOLS = DEBUG_TOOLS;
window.HEALTH_MONITOR = HEALTH_MONITOR;
window.APP_INIT = APP_INIT;
window.FINAL_CHECKLIST = FINAL_CHECKLIST;

// Initialize on page load
if (typeof window !== 'undefined') {
  window.addEventListener('DOMContentLoaded', () => {
    APP_INIT.initialize();
  });
}

// Show help on first load
if (window.VERBOSE_LOGGING) console.log('');
console.log('═══════════════════════════════════════════════════════════');
console.log('🎉 PART 10: OPTIMIZATION & FINAL DEBUG - LOADED! 🎉');
if (window.VERBOSE_LOGGING) console.log('═══════════════════════════════════════════════════════════');
console.log('');
console.log('✅ SYSTEMS ACTIVE:');
console.log('   • Validation & Error Checking');
if (window.VERBOSE_LOGGING) console.log('   • Performance Monitoring');
console.log('   • Memory Management');
if (window.VERBOSE_LOGGING) console.log('   • Bug Fixes & Patches');
console.log('   • Debug & Diagnostic Tools');
if (window.VERBOSE_LOGGING) console.log('   • System Health Monitor');
console.log('   • Verification Checklist');
if (window.VERBOSE_LOGGING) console.log('');
console.log('💡 Type help() for available console commands');
if (window.VERBOSE_LOGGING) console.log('💡 Type verify() to run full system verification');
console.log('💡 Type debug.enable() to open debug panel');
if (window.VERBOSE_LOGGING) console.log('');


function viewSeasonResults() {
  if (!SEASON_STATE.active && SEASON_STATE.currentMatchday === 0) {
    showUtilityMessage('No season results available', 'error');
    return;
  }

  const output = document.getElementById('output');
  if (!output) return;

  let html = '<div class="results-container" style="padding: 20px;">';
  html += '<h2 style="margin-bottom: 20px;">🏆 Season Final Results</h2>';

  const sortedTable = [...SEASON_STATE.table].sort((a, b) => {
    if (b.points !== a.points) return b.points - a.points;
    if (b.goalDifference !== a.goalDifference) return b.goalDifference - a.goalDifference;
    return b.goalsFor - a.goalsFor;
  });

  html += '<table class="league-table" style="width: 100%; border-collapse: collapse;"><thead><tr>';
  html += '<th style="padding: 10px;">Pos</th><th style="padding: 10px; text-align: left;">Team</th>';
  html += '<th style="padding: 10px;">P</th><th style="padding: 10px;">W</th><th style="padding: 10px;">D</th><th style="padding: 10px;">L</th>';
  html += '<th style="padding: 10px;">GF</th><th style="padding: 10px;">GA</th><th style="padding: 10px;">GD</th>';
  html += '<th style="padding: 10px;">Pts</th></tr></thead><tbody>';

  sortedTable.forEach((entry, idx) => {
    const rowColor = idx === 0 ? 'rgba(16, 185, 129, 0.2)' : idx < 4 ? 'rgba(59, 130, 246, 0.1)' : '';
    html += `<tr style="background: ${rowColor}; border-bottom: 1px solid #374151;">`;
    html += `<td style="padding: 10px; text-align: center;">${idx+1}</td>`;
    html += `<td style="padding: 10px; font-weight: 500;">${entry.team.name}</td>`;
    html += `<td style="padding: 10px; text-align: center;">${entry.played}</td>`;
    html += `<td style="padding: 10px; text-align: center; color: #10b981;">${entry.wins}</td>`;
    html += `<td style="padding: 10px; text-align: center; color: #f59e0b;">${entry.draws}</td>`;
    html += `<td style="padding: 10px; text-align: center; color: #ef4444;">${entry.losses}</td>`;
    html += `<td style="padding: 10px; text-align: center;">${entry.goalsFor}</td>`;
    html += `<td style="padding: 10px; text-align: center;">${entry.goalsAgainst}</td>`;
    html += `<td style="padding: 10px; text-align: center; color: ${entry.goalDifference >= 0 ? '#10b981' : '#ef4444'};">${entry.goalDifference >= 0 ? '+' : ''}${entry.goalDifference}</td>`;
    html += `<td style="padding: 10px; text-align: center; font-weight: bold; color: #fbbf24;">${entry.points}</td>`;
    html += '</tr>';
  });

  html += '</tbody></table></div>';
  output.innerHTML = html;
}


function resetSeason() {
  if (!confirm('Start a new season? Current season will be saved to history.')) {
    return;
  }

  if (SEASON_STATE.active) {
    if (!SEASON_STATE.seasonHistory) SEASON_STATE.seasonHistory = [];
    SEASON_STATE.seasonHistory.push({
      seasonNumber: SEASON_STATE.seasonNumber,
      standings: [...SEASON_STATE.table],
      champion: SEASON_STATE.table[0],
      endDate: new Date().toISOString()
    });
  }

  const teams = SEASON_STATE.teams;
  SEASON_STATE.currentMatchday = 0;
  SEASON_STATE.seasonNumber++;
  SEASON_STATE.active = false;

  if (teams && teams.length >= 4) {
    initializeSeasonMode(teams);
    displaySeasonMode();
    showUtilityMessage(`🎉 Season ${SEASON_STATE.seasonNumber} started!`, 'success');
  } else {
    showUtilityMessage('Cannot reset season - no teams available', 'error');
  }
}


// Stats view mode toggle
let STATS_VIEW_MODE = 'detailed';

function setStatsView(mode) {
  STATS_VIEW_MODE = mode;
  // Re-render current view
  if (typeof showEnhancedStatistics === 'function') {
    showEnhancedStatistics();
  }
  showUtilityMessage(`View mode: ${mode}`, 'success');
}

</script>
</body>
</html>